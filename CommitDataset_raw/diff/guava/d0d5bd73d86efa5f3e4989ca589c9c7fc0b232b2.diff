[+++ b/android/guava-tests/test/com/google/common/io/ByteStreamsTest.java, +  private static final byte[] PRE_FILLED_100 = newPreFilledByteArray(100);, +, +  public void testToByteArray() throws IOException {, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    byte[] b = ByteStreams.toByteArray(in);, +    assertEquals(PRE_FILLED_100, b);, +  }, +, +  public void testToByteArray_emptyStream() throws IOException {, +    InputStream in = newTestStream(0);, +    byte[] b = ByteStreams.toByteArray(in);, +    assertEquals(new byte[0], b);, +  }, +, +  public void testToByteArray_largeStream() throws IOException {, +    // well, large enough to require multiple buffers, +    byte[] expected = newPreFilledByteArray(10000000);, +    InputStream in = new ByteArrayInputStream(expected);, +    byte[] b = ByteStreams.toByteArray(in);, +    assertEquals(expected, b);, +  }, +, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +  }, +, +  public void testToByteArray_withSize_givenSizeOneSmallerThanActual() throws IOException {, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    // this results in toByteArrayInternal being called when the stream is actually exhausted, +    byte[] b = ByteStreams.toByteArray(in, 99);, +    assertEquals(PRE_FILLED_100, b);, +  }, +, +  public void testToByteArray_withSize_givenSizeTwoSmallerThanActual() throws IOException {, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    byte[] b = ByteStreams.toByteArray(in, 98);, +    assertEquals(PRE_FILLED_100, b);, +++ b/android/guava-tests/test/com/google/common/io/ByteStreamsTest.java, +  private static final byte[] PRE_FILLED_100 = newPreFilledByteArray(100);, +, +  public void testToByteArray() throws IOException {, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    byte[] b = ByteStreams.toByteArray(in);, +    assertEquals(PRE_FILLED_100, b);, +  }, +, +  public void testToByteArray_emptyStream() throws IOException {, +    InputStream in = newTestStream(0);, +    byte[] b = ByteStreams.toByteArray(in);, +    assertEquals(new byte[0], b);, +  }, +, +  public void testToByteArray_largeStream() throws IOException {, +    // well, large enough to require multiple buffers, +    byte[] expected = newPreFilledByteArray(10000000);, +    InputStream in = new ByteArrayInputStream(expected);, +    byte[] b = ByteStreams.toByteArray(in);, +    assertEquals(expected, b);, +  }, +, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    assertEquals(PRE_FILLED_100, b);, +  }, +, +  public void testToByteArray_withSize_givenSizeOneSmallerThanActual() throws IOException {, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    // this results in toByteArrayInternal being called when the stream is actually exhausted, +    byte[] b = ByteStreams.toByteArray(in, 99);, +    assertEquals(PRE_FILLED_100, b);, +  }, +, +  public void testToByteArray_withSize_givenSizeTwoSmallerThanActual() throws IOException {, +    InputStream in = new ByteArrayInputStream(PRE_FILLED_100);, +    byte[] b = ByteStreams.toByteArray(in, 98);, +    assertEquals(PRE_FILLED_100, b);, +++ b/android/guava/src/com/google/common/io/ByteStreams.java, +import com.google.common.math.IntMath;, +import java.util.ArrayDeque;, +import java.util.Deque;, +  /** Max array length on JVM. */, +  private static final int MAX_ARRAY_LEN = Integer.MAX_VALUE - 8;, +, +  /** Large enough to never need to expand, given the geometric progression of buffer sizes. */, +  private static final int TO_BYTE_ARRAY_DEQUE_SIZE = 20;, +, +  /**, +   * Returns a byte array containing the bytes from the buffers already in {@code bufs} (which have]