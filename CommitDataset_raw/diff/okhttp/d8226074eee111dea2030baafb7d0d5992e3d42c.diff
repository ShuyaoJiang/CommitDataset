[+++ b/okhttp-tests/src/test/java/okhttp3/internal/ws/RealWebSocketTest.java, +  @Test public void serverCloseThenClientClose() throws IOException {, +  @Test public void emptyCloseInitiatesShutdown() throws IOException {, +    server2clientSink.write(ByteString.decodeHex("8800")).emit(); // Close without code., +    client.processNextFrame();, +    clientListener.assertClosing(1005, "");, +, +    assertTrue(client.close(1000, "Bye!"));, +    server.processNextFrame();, +    serverListener.assertClosing(1000, "Bye!");, +, +    clientListener.assertClosed(1005, "");, +  }, +, +    client.processNextFrame();// Detects error, disconnects immediately since close already sent., +    clientListener.assertFailure(, +        ProtocolException.class, "Server-sent frames must not be masked.");, +    client.processNextFrame(); // Detects error, disconnects immediately since close already sent., +++ b/okhttp-tests/src/test/java/okhttp3/internal/ws/RealWebSocketTest.java, +  @Test public void serverCloseThenClientClose() throws IOException {, +  @Test public void emptyCloseInitiatesShutdown() throws IOException {, +    server2clientSink.write(ByteString.decodeHex("8800")).emit(); // Close without code., +    client.processNextFrame();, +    clientListener.assertClosing(1005, "");, +, +    assertTrue(client.close(1000, "Bye!"));, +    server.processNextFrame();, +    serverListener.assertClosing(1000, "Bye!");, +, +    clientListener.assertClosed(1005, "");, +  }, +, +    client.processNextFrame();// Detects error, disconnects immediately since close already sent., +    clientListener.assertFailure(, +        ProtocolException.class, "Server-sent frames must not be masked.");, +    client.processNextFrame(); // Detects error, disconnects immediately since close already sent., +++ b/okhttp/src/main/java/okhttp3/internal/ws/RealWebSocket.java, +  /** Receive frames until there are no more. Invoked only by the reader thread. */, +  /**, +   * For testing: receive a single frame and return true if there are more frames to read. Invoked, +   * only by the reader thread., +   */]