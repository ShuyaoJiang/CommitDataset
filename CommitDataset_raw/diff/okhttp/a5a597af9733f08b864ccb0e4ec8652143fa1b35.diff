[+++ b/okhttp/src/main/java/okhttp3/internal/platform/AndroidPlatform.java, +import java.security.cert.TrustAnchor;, +import okhttp3.internal.tls.BasicTrustRootIndex;, +import okhttp3.internal.tls.TrustRootIndex;, +  @Override, +  public TrustRootIndex buildTrustRootIndex(X509TrustManager trustManager) {, +, +    try {, +      // From org.conscrypt.TrustManagerImpl, we want the method with this signature:, +      // private TrustAnchor findTrustAnchorByIssuerAndSignature(X509Certificate lastCert);, +      Method method = trustManager.getClass().getDeclaredMethod(, +              "findTrustAnchorByIssuerAndSignature", X509Certificate.class);, +      method.setAccessible(true);, +      return new AndroidTrustRootIndex(trustManager, method);, +    } catch (NoSuchMethodException e) {, +      return super.buildTrustRootIndex(trustManager);, +    }, +  }, +, +, +  /**, +   * An index of trusted root certificates that exploits knowledge of Android implementation, +   * details. This class is potentially much faster to initialize than {@link BasicTrustRootIndex}, +   * because it doesn't need to load and index trusted CA certificates., +   *, +   * <p>This class uses APIs added to Android in API 14 (Android 4.0, released October 2011). This, +   * class shouldn't be used in Android API 17 or better because those releases are better served by, +   * {@link AndroidPlatform.AndroidCertificateChainCleaner}., +   */, +  static final class AndroidTrustRootIndex implements TrustRootIndex {, +    private final X509TrustManager trustManager;, +    private final Method findByIssuerAndSignatureMethod;, +, +    AndroidTrustRootIndex(X509TrustManager trustManager, Method findByIssuerAndSignatureMethod) {, +      this.findByIssuerAndSignatureMethod = findByIssuerAndSignatureMethod;, +      this.trustManager = trustManager;, +    }, +, +    @Override public X509Certificate findByIssuerAndSignature(X509Certificate cert) {, +      try {, +        TrustAnchor trustAnchor = (TrustAnchor) findByIssuerAndSignatureMethod.invoke(, +                trustManager, cert);, +        return trustAnchor != null, +                ? trustAnchor.getTrustedCert(), +                : null;, +      } catch (IllegalAccessException e) {, +        throw new AssertionError();, +      } catch (InvocationTargetException e) {, +        return null;, +      }, +    }, +, +    @Override, +    public boolean equals(Object obj) {, +      if (obj == this) {, +        return true;, +      }, +      if (!(obj instanceof AndroidTrustRootIndex)) {, +        return false;, +      }, +      AndroidTrustRootIndex that = (AndroidTrustRootIndex) obj;, +      return trustManager.equals(that.trustManager), +              && findByIssuerAndSignatureMethod.equals(that.findByIssuerAndSignatureMethod);, +    }, +, +    @Override, +    public int hashCode() {, +      return trustManager.hashCode() + 31 * findByIssuerAndSignatureMethod.hashCode();, +    }, +  }, +++ b/okhttp/src/main/java/okhttp3/internal/platform/AndroidPlatform.java, +import java.security.cert.TrustAnchor;, +import okhttp3.internal.tls.BasicTrustRootIndex;, +import okhttp3.internal.tls.TrustRootIndex;, +  @Override, +  public TrustRootIndex buildTrustRootIndex(X509TrustManager trustManager) {, +, +    try {, +      // From org.conscrypt.TrustManagerImpl, we want the method with this signature:, +      // private TrustAnchor findTrustAnchorByIssuerAndSignature(X509Certificate lastCert);, +      Method method = trustManager.getClass().getDeclaredMethod(, +              "findTrustAnchorByIssuerAndSignature", X509Certificate.class);, +      method.setAccessible(true);, +      return new AndroidTrustRootIndex(trustManager, method);, +    } catch (NoSuchMethodException e) {, +      return super.buildTrustRootIndex(trustManager);, +    }, +  }, +, +, +  /**, +   * An index of trusted root certificates that exploits knowledge of Android implementation, +   * details. This class is potentially much faster to initialize than {@link BasicTrustRootIndex}, +   * because it doesn't need to load and index trusted CA certificates., +   *, +   * <p>This class uses APIs added to Android in API 14 (Android 4.0, released October 2011). This, +   * class shouldn't be used in Android API 17 or better because those releases are better served by, +   * {@link AndroidPlatform.AndroidCertificateChainCleaner}., +   */, +  static final class AndroidTrustRootIndex implements TrustRootIndex {]