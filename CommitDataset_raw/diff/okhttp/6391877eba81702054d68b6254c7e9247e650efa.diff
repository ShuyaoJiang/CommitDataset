[+++ b/okhttp/src/main/java/okhttp3/internal/ws/WebSocketWriter.java, +import okio.BufferedSource;, +      random.nextBytes(maskKey);, +      writeMaskedSynchronized(buffer, byteCount);, +  private void writeMaskedSynchronized(BufferedSource source, long byteCount) throws IOException {, +    assert Thread.holdsLock(this);, +, +    long written = 0;, +    while (written < byteCount) {, +      int toRead = (int) Math.min(byteCount, maskBuffer.length);, +      int read = source.read(maskBuffer, 0, toRead);, +      if (read == -1) throw new AssertionError();, +      toggleMask(maskBuffer, read, maskKey, written);, +      sink.write(maskBuffer, 0, read);, +      written += read;, +    }, +  }, +]