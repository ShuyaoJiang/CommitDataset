[+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/internal/http/DisconnectTest.java, +import com.squareup.okhttp.DelegatingServerSocketFactory;, +import com.squareup.okhttp.DelegatingSocketFactory;, +import java.net.ServerSocket;, +import java.net.Socket;, +, +import org.junit.Before;, +import javax.net.ServerSocketFactory;, +import javax.net.SocketFactory;, +, +, +  // The size of the socket buffers in bytes., +  private static final int SOCKET_BUFFER_SIZE = 256 * 1024;, +, +  private MockWebServer server;, +  private OkHttpClient client;, +, +  @Before public void setUp() throws Exception {, +    server = new MockWebServer();, +    client = new OkHttpClient();, +, +    // Sockets on some platforms can have large buffers that mean writes do not block when, +    // required. These socket factories explicitly set the buffer sizes on sockets created., +    server.setServerSocketFactory(, +        new DelegatingServerSocketFactory(ServerSocketFactory.getDefault()) {, +          @Override, +          protected void configureServerSocket(ServerSocket serverSocket) throws IOException {, +            serverSocket.setReceiveBufferSize(SOCKET_BUFFER_SIZE);, +          }, +        });, +    client.setSocketFactory(new DelegatingSocketFactory(SocketFactory.getDefault()) {, +      @Override, +      protected void configureSocket(Socket socket) throws IOException {, +        socket.setSendBufferSize(SOCKET_BUFFER_SIZE);, +        socket.setReceiveBufferSize(SOCKET_BUFFER_SIZE);, +      }, +    });, +  }]