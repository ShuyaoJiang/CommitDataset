[+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/HttpUrlTest.java, +  @Test public void toUriSpecialPathCharacters() throws Exception {, +    HttpUrl url = new HttpUrl.Builder(), +        .scheme("http"), +        .host("example.com"), +        .addPathSegment("data=[out:json];node[\"name\"~\"Karlsruhe\"]" +, +            "[\"place\"~\"city|village|town\"];out body;"), +        .build();, +    URI uri = url.uri();, +    assertEquals("http://example.com/data=%5Bout:json%5D;node%5B%22name%22~%22Karlsruhe%22%5D" +, +            "%5B%22place%22~%22city%7Cvillage%7Ctown%22%5D;out%20body;",, +        uri.toString());, +++ b/okhttp-tests/src/test/java/com/squareup/okhttp/HttpUrlTest.java, +  @Test public void toUriSpecialPathCharacters() throws Exception {, +    HttpUrl url = new HttpUrl.Builder(), +        .scheme("http"), +        .host("example.com"), +        .addPathSegment("data=[out:json];node[\"name\"~\"Karlsruhe\"]" +, +            "[\"place\"~\"city|village|town\"];out body;"), +        .build();, +    URI uri = url.uri();, +    assertEquals("http://example.com/data=%5Bout:json%5D;node%5B%22name%22~%22Karlsruhe%22%5D" +, +            "%5B%22place%22~%22city%7Cvillage%7Ctown%22%5D;out%20body;",, +        uri.toString());, +++ b/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java, +    } catch (IllegalStateException expected) {, +++ b/okhttp-tests/src/test/java/com/squareup/okhttp/HttpUrlTest.java, +  @Test public void toUriSpecialPathCharacters() throws Exception {, +    HttpUrl url = new HttpUrl.Builder(), +        .scheme("http"), +        .host("example.com"), +        .addPathSegment("data=[out:json];node[\"name\"~\"Karlsruhe\"]" +, +            "[\"place\"~\"city|village|town\"];out body;"), +        .build();, +    URI uri = url.uri();, +    assertEquals("http://example.com/data=%5Bout:json%5D;node%5B%22name%22~%22Karlsruhe%22%5D" +, +            "%5B%22place%22~%22city%7Cvillage%7Ctown%22%5D;out%20body;",, +        uri.toString());, +++ b/okhttp-tests/src/test/java/com/squareup/okhttp/URLConnectionTest.java, +    } catch (IllegalStateException expected) {, +++ b/okhttp/src/main/java/com/squareup/okhttp/HttpUrl.java, +      String uriUserInfo = username + ":" + password;, +      if (uriUserInfo.equals(":")) uriUserInfo = null;, +      final int uriPort = port == defaultPort(scheme) ? -1 : port; // Don't include default port, +      StringBuilder path = new StringBuilder();, +      pathSegmentsToString(path, pathSegments);, +      return new URI(scheme, uriUserInfo, host, uriPort, path.toString(), query(), fragment);]