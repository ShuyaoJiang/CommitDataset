[+++ b/okhttp-tests/src/test/java/com/squareup/okhttp/CacheTest.java, +  /** https://github.com/square/okhttp/issues/947 */, +  @Test public void gzipAndVaryOnAcceptEncoding() throws Exception {, +    server.enqueue(new MockResponse(), +        .setBody(gzip("ABCABCABC")), +        .addHeader("Content-Encoding: gzip"), +        .addHeader("Vary: Accept-Encoding"), +        .addHeader("Cache-Control: max-age=60"));, +    server.enqueue(new MockResponse().setBody("FAIL"));, +, +    assertEquals("ABCABCABC", readAscii(client.open(server.getUrl("/"))));, +    assertEquals("ABCABCABC", readAscii(client.open(server.getUrl("/"))));, +  }, +, +++ b/okhttp-tests/src/test/java/com/squareup/okhttp/CacheTest.java, +  /** https://github.com/square/okhttp/issues/947 */, +  @Test public void gzipAndVaryOnAcceptEncoding() throws Exception {, +    server.enqueue(new MockResponse(), +        .setBody(gzip("ABCABCABC")), +        .addHeader("Content-Encoding: gzip"), +        .addHeader("Vary: Accept-Encoding"), +        .addHeader("Cache-Control: max-age=60"));, +    server.enqueue(new MockResponse().setBody("FAIL"));, +, +    assertEquals("ABCABCABC", readAscii(client.open(server.getUrl("/"))));, +    assertEquals("ABCABCABC", readAscii(client.open(server.getUrl("/"))));, +  }, +, +++ b/okhttp/src/main/java/com/squareup/okhttp/internal/http/OkHeaders.java, +    // Use the request headers sent over the network, since that's what the, +    // response varies on. Otherwise OkHttp-supplied headers like, +    // "Accept-Encoding: gzip" may be lost., +    Headers requestHeaders = response.networkResponse().request().headers();, +]