[+++ b/okhttp/src/main/java/com/squareup/okhttp/internal/http/DelegatingHttpsURLConnection.java, +/*, + *  Licensed to the Apache Software Foundation (ASF) under one or more, + *  contributor license agreements.  See the NOTICE file distributed with, + *  this work for additional information regarding copyright ownership., + *  The ASF licenses this file to You under the Apache License, Version 2.0, + *  (the "License"); you may not use this file except in compliance with, + *  the License.  You may obtain a copy of the License at, + *, + *     http://www.apache.org/licenses/LICENSE-2.0, + *, + *  Unless required by applicable law or agreed to in writing, software, + *  distributed under the License is distributed on an "AS IS" BASIS,, + *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied., + *  See the License for the specific language governing permissions and, + *  limitations under the License., + */, +package com.squareup.okhttp.internal.http;, +, +import com.squareup.okhttp.Handshake;, +import java.io.IOException;, +import java.io.InputStream;, +import java.io.OutputStream;, +import java.net.HttpURLConnection;, +import java.net.ProtocolException;, +import java.net.URL;, +import java.security.Permission;, +import java.security.Principal;, +import java.security.cert.Certificate;, +import java.util.List;, +import java.util.Map;, +import javax.net.ssl.HostnameVerifier;, +import javax.net.ssl.HttpsURLConnection;, +import javax.net.ssl.SSLPeerUnverifiedException;, +import javax.net.ssl.SSLSocketFactory;, +, +/**, + * Implement an HTTPS connection by delegating to an HTTP connection for, + * everything but the HTTPS-specific stuff., + */, +abstract class DelegatingHttpsURLConnection extends HttpsURLConnection {, +  private final HttpURLConnection delegate;, +, +  public DelegatingHttpsURLConnection(HttpURLConnection delegate) {, +    super(delegate.getURL());, +    this.delegate = delegate;, +  }, +, +  protected abstract Handshake handshake();, +, +  @Override public abstract void setHostnameVerifier(HostnameVerifier hostnameVerifier);, +, +  @Override public abstract HostnameVerifier getHostnameVerifier();, +, +  @Override public abstract void setSSLSocketFactory(SSLSocketFactory sslSocketFactory);, +, +  @Override public abstract SSLSocketFactory getSSLSocketFactory();, +, +  @Override public String getCipherSuite() {, +    Handshake handshake = handshake();, +    return handshake != null ? handshake.cipherSuite() : null;, +  }, +, +  @Override public Certificate[] getLocalCertificates() {, +    Handshake handshake = handshake();, +    if (handshake == null) return null;, +    List<Certificate> result = handshake.localCertificates();, +    return !result.isEmpty() ? result.toArray(new Certificate[result.size()]) : null;, +  }, +, +  @Override public Certificate[] getServerCertificates() throws SSLPeerUnverifiedException {, +    Handshake handshake = handshake();, +    if (handshake == null) return null;, +    List<Certificate> result = handshake.peerCertificates();, +    return !result.isEmpty() ? result.toArray(new Certificate[result.size()]) : null;, +  }, +, +  @Override public Principal getPeerPrincipal() throws SSLPeerUnverifiedException {, +    Handshake handshake = handshake();, +    return handshake != null ? handshake.peerPrincipal() : null;, +  }, +, +  @Override public Principal getLocalPrincipal() {, +    Handshake handshake = handshake();, +    return handshake != null ? handshake.localPrincipal() : null;, +  }, +, +  @Override public void connect() throws IOException {, +    connected = true;, +    delegate.connect();, +  }, +, +  @Override public void disconnect() {, +    delegate.disconnect();, +  }, +, +  @Override public InputStream getErrorStream() {, +    return delegate.getErrorStream();, +  }, +]