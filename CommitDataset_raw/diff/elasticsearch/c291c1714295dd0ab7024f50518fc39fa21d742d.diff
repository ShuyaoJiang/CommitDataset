[+++ b/core/src/test/java/org/elasticsearch/action/support/replication/TransportReplicationActionTests.java, +import java.util.HashMap;, +import static org.hamcrest.CoreMatchers.not;, +import static org.hamcrest.Matchers.empty;, +import static org.hamcrest.Matchers.is;, +        HashMap<String, Request> nodesSentTo = new HashMap<>();, +            assertNull(nodesSentTo.put(capturedRequest.node.getId(), replicationRequest));, +            // the request is hitting the correct shard, +        // no request was sent to the local node, +        assertThat(nodesSentTo.keySet(), not(hasItem(clusterService.state().getNodes().localNodeId())));, +, +        for (ShardRouting shard : clusterService.state().getRoutingTable().shardRoutingTable(shardId.getIndex(), shardId.id())) {, +            if (shard.primary() == false && executeOnReplica == false) {, +            if (shard.primary() == false) {, +                nodesSentTo.remove(shard.currentNodeId());, +                nodesSentTo.remove(shard.relocatingNodeId());, +        assertThat(nodesSentTo.entrySet(), is(empty()));, +, +                    assertEquals(shardRoutingEntry.getShardRouting(), routing);]