[+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java, +            boolean hadAbortedInitializations;, +, +                                assert entry.shards().isEmpty();, +                                hadAbortedInitializations = true;, +, +                        if (hadAbortedInitializations) {, +                            final SnapshotsInProgress snapshotsInProgress = newState.custom(SnapshotsInProgress.TYPE);, +                            assert snapshotsInProgress != null;, +                            final SnapshotsInProgress.Entry entry = snapshotsInProgress.snapshot(snapshot.snapshot());, +                            assert entry != null;, +                            endSnapshot(entry);, +                        }, +                            || initializingSnapshots.contains(entry.snapshot()) == false, +                               && (entry.state() == State.INIT || completed(entry.shards().values())), +++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java, +            boolean hadAbortedInitializations;, +, +                                assert entry.shards().isEmpty();, +                                hadAbortedInitializations = true;, +, +                        if (hadAbortedInitializations) {, +                            final SnapshotsInProgress snapshotsInProgress = newState.custom(SnapshotsInProgress.TYPE);, +                            assert snapshotsInProgress != null;, +                            final SnapshotsInProgress.Entry entry = snapshotsInProgress.snapshot(snapshot.snapshot());, +                            assert entry != null;, +                            endSnapshot(entry);, +                        }, +                            || initializingSnapshots.contains(entry.snapshot()) == false, +                               && (entry.state() == State.INIT || completed(entry.shards().values())), +++ b/server/src/test/java/org/elasticsearch/snapshots/DedicatedClusterSnapshotRestoreIT.java]