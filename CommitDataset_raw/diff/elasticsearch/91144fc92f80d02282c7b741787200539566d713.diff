[+++ b/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +import org.elasticsearch.index.query.QueryParseContext;, +    /**, +     * Wraps a query in a filter., +     *, +     * If a filter has an anti per segment execution / caching nature then @{@link CustomQueryWrappingFilter} is returned, +     * otherwise the standard {@link org.apache.lucene.search.QueryWrapperFilter} is returned., +     */, +    public static Filter wrap(Query query, QueryParseContext context) {, +        return FACTORY.wrap(query, context);, +        public Filter wrap(Query query, QueryParseContext context) {, +            if (context.requireCustomQueryWrappingFilter() || CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +++ b/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +import org.elasticsearch.index.query.QueryParseContext;, +    /**, +     * Wraps a query in a filter., +     *, +     * If a filter has an anti per segment execution / caching nature then @{@link CustomQueryWrappingFilter} is returned, +     * otherwise the standard {@link org.apache.lucene.search.QueryWrapperFilter} is returned., +     */, +    public static Filter wrap(Query query, QueryParseContext context) {, +        return FACTORY.wrap(query, context);, +        public Filter wrap(Query query, QueryParseContext context) {, +            if (context.requireCustomQueryWrappingFilter() || CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +++ b/src/main/java/org/elasticsearch/index/query/FQueryFilterParser.java, +        Filter filter = Queries.wrap(query, parseContext);, +++ b/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +import org.elasticsearch.index.query.QueryParseContext;, +    /**, +     * Wraps a query in a filter., +     *, +     * If a filter has an anti per segment execution / caching nature then @{@link CustomQueryWrappingFilter} is returned, +     * otherwise the standard {@link org.apache.lucene.search.QueryWrapperFilter} is returned., +     */, +    public static Filter wrap(Query query, QueryParseContext context) {, +        return FACTORY.wrap(query, context);, +        public Filter wrap(Query query, QueryParseContext context) {, +            if (context.requireCustomQueryWrappingFilter() || CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +++ b/src/main/java/org/elasticsearch/index/query/FQueryFilterParser.java, +        Filter filter = Queries.wrap(query, parseContext);, +++ b/src/main/java/org/elasticsearch/index/query/NestedFilterParser.java, +            Filter nestedFilter = Queries.wrap(new ToParentBlockJoinQuery(query, parentFilter, ScoreMode.None), parseContext);, +++ b/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +import org.elasticsearch.index.query.QueryParseContext;, +    /**, +     * Wraps a query in a filter., +     *, +     * If a filter has an anti per segment execution / caching nature then @{@link CustomQueryWrappingFilter} is returned, +     * otherwise the standard {@link org.apache.lucene.search.QueryWrapperFilter} is returned., +     */, +    public static Filter wrap(Query query, QueryParseContext context) {, +        return FACTORY.wrap(query, context);, +        public Filter wrap(Query query, QueryParseContext context) {, +            if (context.requireCustomQueryWrappingFilter() || CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +++ b/src/main/java/org/elasticsearch/index/query/FQueryFilterParser.java, +        Filter filter = Queries.wrap(query, parseContext);, +++ b/src/main/java/org/elasticsearch/index/query/NestedFilterParser.java, +            Filter nestedFilter = Queries.wrap(new ToParentBlockJoinQuery(query, parentFilter, ScoreMode.None), parseContext);, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +        return Queries.wrap(query, parseContext);, +++ b/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +import org.elasticsearch.index.query.QueryParseContext;, +    /**, +     * Wraps a query in a filter., +     *, +     * If a filter has an anti per segment execution / caching nature then @{@link CustomQueryWrappingFilter} is returned, +     * otherwise the standard {@link org.apache.lucene.search.QueryWrapperFilter} is returned., +     */, +    public static Filter wrap(Query query, QueryParseContext context) {, +        return FACTORY.wrap(query, context);, +        public Filter wrap(Query query, QueryParseContext context) {, +            if (context.requireCustomQueryWrappingFilter() || CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +++ b/src/main/java/org/elasticsearch/index/query/FQueryFilterParser.java, +        Filter filter = Queries.wrap(query, parseContext);, +++ b/src/main/java/org/elasticsearch/index/query/NestedFilterParser.java, +            Filter nestedFilter = Queries.wrap(new ToParentBlockJoinQuery(query, parentFilter, ScoreMode.None), parseContext);, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +        return Queries.wrap(query, parseContext);, +++ b/src/main/java/org/elasticsearch/index/query/QueryParseContext.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +    private boolean requireCustomQueryWrappingFilter = false;, +, +        this.requireCustomQueryWrappingFilter = false;, +        this.propagateNoCache = false;, +        namedFilters.put(name, Queries.wrap(query, this));, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(result)) {, +            requireCustomQueryWrappingFilter = true;, +            // If later on, either directly or indirectly this query gets wrapped in a query filter it must never, +            // get cached even if a filter higher up the chain is configured to do this. This will happen, because, +            // the result filter will be instance of NoCacheFilter (CustomQueryWrappingFilter) which will in, +            // #executeFilterParser() set propagateNoCache to true., +        }, +, +    public boolean requireCustomQueryWrappingFilter() {, +        return requireCustomQueryWrappingFilter;, +    }, +++ b/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +import org.elasticsearch.index.query.QueryParseContext;, +    /**, +     * Wraps a query in a filter.]