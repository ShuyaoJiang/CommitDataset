[+++ b/src/test/java/org/elasticsearch/test/integration/ElasticsearchTestCase.java, +import com.carrotsearch.randomizedtesting.annotations.*;, +import com.google.common.base.Predicate;, +import org.apache.lucene.util.TimeUnits;, +import java.util.concurrent.TimeUnit;, +, +@TimeoutSuite(millis = TimeUnits.HOUR) // timeout the suite after 1h and fail the test., +    public void awaitBusy(Predicate<?> breakPredicate) throws InterruptedException {, +        awaitBusy(breakPredicate, 10, TimeUnit.SECONDS);, +    }, +, +    , +    public void awaitBusy(Predicate<?> breakPredicate, long maxWaitTime, TimeUnit unit) throws InterruptedException {, +        long maxTimeInMillis = TimeUnit.MILLISECONDS.convert(maxWaitTime, unit);, +        long iterations = Math.max(Math.round(Math.log10(maxTimeInMillis) / Math.log10(2)), 1);, +        long timeInMillis = 1;, +        long sum = 0;, +        for (int i = 0; i < iterations; i++) {, +            if (breakPredicate.apply(null)) {, +                return;, +            }, +            sum += timeInMillis;, +            Thread.sleep(timeInMillis);, +            timeInMillis *= 2;, +        }, +        timeInMillis = maxTimeInMillis - sum;, +        Thread.sleep(Math.max(timeInMillis, 0));, +        , +    }, +]