[+++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidator.java, +, +        if (bucketSpanMillis % histogramIntervalMillis != 0) {, +            throw ExceptionsHelper.badRequestException(Messages.getMessage(, +                    Messages.DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN,, +                    TimeValue.timeValueMillis(histogramIntervalMillis).getStringRep(),, +                    TimeValue.timeValueMillis(bucketSpanMillis).getStringRep()));, +        }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidator.java, +, +        if (bucketSpanMillis % histogramIntervalMillis != 0) {, +            throw ExceptionsHelper.badRequestException(Messages.getMessage(, +                    Messages.DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN,, +                    TimeValue.timeValueMillis(histogramIntervalMillis).getStringRep(),, +                    TimeValue.timeValueMillis(bucketSpanMillis).getStringRep()));, +        }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/extractor/aggregation/AggregationDataExtractor.java, +        long histogramSearchStartTime = Math.max(0, context.start - getHistogramInterval());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidator.java, +, +        if (bucketSpanMillis % histogramIntervalMillis != 0) {, +            throw ExceptionsHelper.badRequestException(Messages.getMessage(, +                    Messages.DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN,, +                    TimeValue.timeValueMillis(histogramIntervalMillis).getStringRep(),, +                    TimeValue.timeValueMillis(bucketSpanMillis).getStringRep()));, +        }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/extractor/aggregation/AggregationDataExtractor.java, +        long histogramSearchStartTime = Math.max(0, context.start - getHistogramInterval());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/job/messages/Messages.java, +    public static final String DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN =, +            "Aggregation interval [{0}] must be a divisor of the bucket_span [{1}]";, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidator.java, +, +        if (bucketSpanMillis % histogramIntervalMillis != 0) {, +            throw ExceptionsHelper.badRequestException(Messages.getMessage(, +                    Messages.DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN,, +                    TimeValue.timeValueMillis(histogramIntervalMillis).getStringRep(),, +                    TimeValue.timeValueMillis(bucketSpanMillis).getStringRep()));, +        }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/extractor/aggregation/AggregationDataExtractor.java, +        long histogramSearchStartTime = Math.max(0, context.start - getHistogramInterval());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/job/messages/Messages.java, +    public static final String DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN =, +            "Aggregation interval [{0}] must be a divisor of the bucket_span [{1}]";, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidatorTests.java, +    public void testVerify_HistogramIntervalIsDivisorOfBucketSpan() throws IOException {, +        Job.Builder builder = buildJobBuilder("foo");, +        AnalysisConfig.Builder ac = createAnalysisConfig();, +        ac.setSummaryCountFieldName("some_count");, +        ac.setBucketSpan(TimeValue.timeValueMinutes(5));, +        builder.setAnalysisConfig(ac);, +        Job job = builder.build(new Date());, +        DatafeedConfig datafeedConfig = createValidDatafeedConfigWithAggs(37 * 1000).build();, +, +        ElasticsearchStatusException e = ESTestCase.expectThrows(ElasticsearchStatusException.class,, +                () -> DatafeedJobValidator.validate(datafeedConfig, job));, +        assertEquals("Aggregation interval [37000ms] must be a divisor of the bucket_span [300000ms]", e.getMessage());, +, +        DatafeedConfig goodDatafeedConfig = createValidDatafeedConfigWithAggs(60 * 1000).build();, +        DatafeedJobValidator.validate(goodDatafeedConfig, job);, +    }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidator.java, +, +        if (bucketSpanMillis % histogramIntervalMillis != 0) {, +            throw ExceptionsHelper.badRequestException(Messages.getMessage(, +                    Messages.DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN,, +                    TimeValue.timeValueMillis(histogramIntervalMillis).getStringRep(),, +                    TimeValue.timeValueMillis(bucketSpanMillis).getStringRep()));, +        }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/datafeed/extractor/aggregation/AggregationDataExtractor.java, +        long histogramSearchStartTime = Math.max(0, context.start - getHistogramInterval());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/ml/job/messages/Messages.java, +    public static final String DATAFEED_AGGREGATIONS_INTERVAL_MUST_BE_DIVISOR_OF_BUCKET_SPAN =, +            "Aggregation interval [{0}] must be a divisor of the bucket_span [{1}]";, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/datafeed/DatafeedJobValidatorTests.java, +    public void testVerify_HistogramIntervalIsDivisorOfBucketSpan() throws IOException {, +        Job.Builder builder = buildJobBuilder("foo");, +        AnalysisConfig.Builder ac = createAnalysisConfig();, +        ac.setSummaryCountFieldName("some_count");, +        ac.setBucketSpan(TimeValue.timeValueMinutes(5));, +        builder.setAnalysisConfig(ac);, +        Job job = builder.build(new Date());, +        DatafeedConfig datafeedConfig = createValidDatafeedConfigWithAggs(37 * 1000).build();, +, +        ElasticsearchStatusException e = ESTestCase.expectThrows(ElasticsearchStatusException.class,, +                () -> DatafeedJobValidator.validate(datafeedConfig, job));, +        assertEquals("Aggregation interval [37000ms] must be a divisor of the bucket_span [300000ms]", e.getMessage());, +, +        DatafeedConfig goodDatafeedConfig = createValidDatafeedConfigWithAggs(60 * 1000).build();, +        DatafeedJobValidator.validate(goodDatafeedConfig, job);, +    }, +, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java, +        new DatafeedBuilder(datafeedId, jobId, "network-data", "doc")]