[+++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/ShardFieldDocSortedHitQueue.java, +, +    @Override public void setFields(SortField[] fields) {, +        super.setFields(fields);, +    }, +++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/ShardFieldDocSortedHitQueue.java, +, +    @Override public void setFields(SortField[] fields) {, +        super.setFields(fields);, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/Lucene.java, +                        cFields[j] = null;, +                        cFields[j] = in.readUTF();, +                        cFields[j] = in.readInt();, +                        cFields[j] = in.readLong();, +                        cFields[j] = in.readFloat();, +                        cFields[j] = in.readDouble();, +                    } else if (type == 6) {, +                    if (field == null) {, +                        out.writeByte((byte) 0);, +                    } else {, +                            out.writeByte((byte) 1);, +                            out.writeByte((byte) 2);, +                            out.writeByte((byte) 3);, +                            out.writeByte((byte) 4);, +                            out.writeByte((byte) 5);, +                            out.writeByte((byte) 6);, +                }, +++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/ShardFieldDocSortedHitQueue.java, +, +    @Override public void setFields(SortField[] fields) {, +        super.setFields(fields);, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/Lucene.java, +                        cFields[j] = null;, +                        cFields[j] = in.readUTF();, +                        cFields[j] = in.readInt();, +                        cFields[j] = in.readLong();, +                        cFields[j] = in.readFloat();, +                        cFields[j] = in.readDouble();, +                    } else if (type == 6) {, +                    if (field == null) {, +                        out.writeByte((byte) 0);, +                    } else {, +                            out.writeByte((byte) 1);, +                            out.writeByte((byte) 2);, +                            out.writeByte((byte) 3);, +                            out.writeByte((byte) 4);, +                            out.writeByte((byte) 5);, +                            out.writeByte((byte) 6);, +                }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java, +import org.apache.lucene.search.*;, +            // sorting, first if the type is a String, chance CUSTOM to STRING so we handle nulls properly, +            TopFieldDocs fieldDocs = (TopFieldDocs) queryResultProvider.queryResult().topDocs();, +            for (int i = 0; i < fieldDocs.fields.length; i++) {, +                boolean resolvedField = false;, +                for (QuerySearchResultProvider resultProvider : results) {, +                    for (ScoreDoc doc : resultProvider.queryResult().topDocs().scoreDocs) {, +                        FieldDoc fDoc = (FieldDoc) doc;, +                        if (fDoc.fields[i] != null) {, +                            if (fDoc.fields[i] instanceof String) {, +                                fieldDocs.fields[i] = new SortField(fieldDocs.fields[i].getField(), SortField.STRING, fieldDocs.fields[i].getReverse());, +                            }, +                            resolvedField = true;, +                            break;, +                        }, +                    }, +                    if (resolvedField) {, +                        break;, +                    }, +                }, +            }, +            queue = new ShardFieldDocSortedHitQueue(fieldDocs.fields, queueSize);, +, +            // we need to accumulate for all and then filter the from, +++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/ShardFieldDocSortedHitQueue.java, +, +    @Override public void setFields(SortField[] fields) {, +        super.setFields(fields);, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/Lucene.java, +                        cFields[j] = null;, +                        cFields[j] = in.readUTF();, +                        cFields[j] = in.readInt();, +                        cFields[j] = in.readLong();, +                        cFields[j] = in.readFloat();, +                        cFields[j] = in.readDouble();, +                    } else if (type == 6) {, +                    if (field == null) {, +                        out.writeByte((byte) 0);, +                    } else {, +                            out.writeByte((byte) 1);, +                            out.writeByte((byte) 2);, +                            out.writeByte((byte) 3);, +                            out.writeByte((byte) 4);, +                            out.writeByte((byte) 5);, +                            out.writeByte((byte) 6);, +                }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java]