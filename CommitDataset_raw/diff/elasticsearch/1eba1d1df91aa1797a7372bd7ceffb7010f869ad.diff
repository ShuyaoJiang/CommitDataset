[+++ b/server/src/test/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java, +        assertAllSnapshotsCompleted();, +        assertAllSnapshotsCompleted();, +, +    private void assertAllSnapshotsCompleted() throws Exception {, +        logger.info("--> wait until the snapshot is done");, +        assertBusy(() -> {, +            ClusterState state = dataNodeClient().admin().cluster().prepareState().get().getState();, +            SnapshotsInProgress snapshots = state.custom(SnapshotsInProgress.TYPE);, +            SnapshotDeletionsInProgress snapshotDeletionsInProgress = state.custom(SnapshotDeletionsInProgress.TYPE);, +            if (snapshots != null && snapshots.entries().isEmpty() == false) {, +                logger.info("Current snapshot state [{}]", snapshots.entries().get(0).state());, +                fail("Snapshot is still running");, +            } else if (snapshotDeletionsInProgress != null && snapshotDeletionsInProgress.hasDeletionsInProgress()) {, +                logger.info("Current snapshot deletion state [{}]", snapshotDeletionsInProgress);, +                fail("Snapshot deletion is still running");, +            } else {, +                logger.info("Snapshot is no longer in the cluster state");, +            }, +        }, 1L, TimeUnit.MINUTES);]