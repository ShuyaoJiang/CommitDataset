[+++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/LeafSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/LeafSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/NativeScriptFactory.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/LeafSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/NativeScriptFactory.java, +++ b/core/src/test/java/org/elasticsearch/common/lucene/search/function/ScriptScoreFunctionTests.java, +import org.elasticsearch.script.AbstractDoubleSearchScript;, +        // script that always returns NaN, +        ScoreFunction scoreFunction = new ScriptScoreFunction(new Script("Double.NaN"), new SearchScript() {, +                return new AbstractDoubleSearchScript() {, +                    public double runAsDouble() {, +                        return Double.NaN;, +                        // do nothing: we are a fake with no lookup, +        });, +        LeafScoreFunction leafScoreFunction = scoreFunction.getLeafScoreFunction(null);, +        ScriptException expected = expectThrows(ScriptException.class, () -> {, +            leafScoreFunction.score(randomInt(), randomFloat());, +        });, +        assertTrue(expected.getMessage().contains("returned NaN"));, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/LeafSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/NativeScriptFactory.java, +++ b/core/src/test/java/org/elasticsearch/common/lucene/search/function/ScriptScoreFunctionTests.java, +import org.elasticsearch.script.AbstractDoubleSearchScript;, +        // script that always returns NaN, +        ScoreFunction scoreFunction = new ScriptScoreFunction(new Script("Double.NaN"), new SearchScript() {, +                return new AbstractDoubleSearchScript() {, +                    public double runAsDouble() {, +                        return Double.NaN;, +                        // do nothing: we are a fake with no lookup, +        });, +        LeafScoreFunction leafScoreFunction = scoreFunction.getLeafScoreFunction(null);, +        ScriptException expected = expectThrows(ScriptException.class, () -> {, +            leafScoreFunction.score(randomInt(), randomFloat());, +        });, +        assertTrue(expected.getMessage().contains("returned NaN"));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AvgIT.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/LeafSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/NativeScriptFactory.java, +++ b/core/src/test/java/org/elasticsearch/common/lucene/search/function/ScriptScoreFunctionTests.java, +import org.elasticsearch.script.AbstractDoubleSearchScript;, +        // script that always returns NaN, +        ScoreFunction scoreFunction = new ScriptScoreFunction(new Script("Double.NaN"), new SearchScript() {, +                return new AbstractDoubleSearchScript() {, +                    public double runAsDouble() {, +                        return Double.NaN;, +                        // do nothing: we are a fake with no lookup, +        });, +        LeafScoreFunction leafScoreFunction = scoreFunction.getLeafScoreFunction(null);, +        ScriptException expected = expectThrows(ScriptException.class, () -> {, +            leafScoreFunction.score(randomInt(), randomFloat());, +        });, +        assertTrue(expected.getMessage().contains("returned NaN"));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AvgIT.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/SumIT.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractDoubleSearchScript.java, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/script/AbstractLongSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/AbstractSearchScript.java, + * such as {@link AbstractDoubleSearchScript} and {@link AbstractLongSearchScript}, +++ b/core/src/main/java/org/elasticsearch/script/LeafSearchScript.java, +++ b/core/src/main/java/org/elasticsearch/script/NativeScriptFactory.java, +++ b/core/src/test/java/org/elasticsearch/common/lucene/search/function/ScriptScoreFunctionTests.java, +import org.elasticsearch.script.AbstractDoubleSearchScript;, +        // script that always returns NaN]