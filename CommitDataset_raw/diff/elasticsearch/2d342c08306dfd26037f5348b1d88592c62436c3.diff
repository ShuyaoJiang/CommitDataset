[+++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import static org.elasticsearch.search.sort.SortBuilder.parseNestedFilter;, +, +public class NestedSortBuilder implements Writeable, ToXContentObject {, +    private final String path;, +        path = in.readOptionalString();, +        filter = in.readOptionalNamedWriteable(QueryBuilder.class);, +        nestedSort = in.readOptionalWriteable(NestedSortBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import static org.elasticsearch.search.sort.SortBuilder.parseNestedFilter;, +, +public class NestedSortBuilder implements Writeable, ToXContentObject {, +    private final String path;, +        path = in.readOptionalString();, +        filter = in.readOptionalNamedWriteable(QueryBuilder.class);, +        nestedSort = in.readOptionalWriteable(NestedSortBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilder.java, +    private static Nested resolveNested(QueryShardContext context, NestedSortBuilder nestedSort, Nested nested) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import static org.elasticsearch.search.sort.SortBuilder.parseNestedFilter;, +, +public class NestedSortBuilder implements Writeable, ToXContentObject {, +    private final String path;, +        path = in.readOptionalString();, +        filter = in.readOptionalNamedWriteable(QueryBuilder.class);, +        nestedSort = in.readOptionalWriteable(NestedSortBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilder.java, +    private static Nested resolveNested(QueryShardContext context, NestedSortBuilder nestedSort, Nested nested) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilders.java, +++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import static org.elasticsearch.search.sort.SortBuilder.parseNestedFilter;, +, +public class NestedSortBuilder implements Writeable, ToXContentObject {, +    private final String path;, +        path = in.readOptionalString();, +        filter = in.readOptionalNamedWriteable(QueryBuilder.class);, +        nestedSort = in.readOptionalWriteable(NestedSortBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilder.java, +    private static Nested resolveNested(QueryShardContext context, NestedSortBuilder nestedSort, Nested nested) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilders.java, +++ b/core/src/test/java/org/elasticsearch/search/nested/SimpleNestedIT.java, +import org.elasticsearch.search.sort.NestedSortBuilder;, +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user")))), +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user")))), +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user"), +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user"), +                                .setNestedSort(new NestedSortBuilder("parent"), +                                    .setNestedSort(new NestedSortBuilder("parent.child"))), +++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import static org.elasticsearch.search.sort.SortBuilder.parseNestedFilter;, +, +public class NestedSortBuilder implements Writeable, ToXContentObject {, +    private final String path;, +        path = in.readOptionalString();, +        filter = in.readOptionalNamedWriteable(QueryBuilder.class);, +        nestedSort = in.readOptionalWriteable(NestedSortBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilder.java, +    private static Nested resolveNested(QueryShardContext context, NestedSortBuilder nestedSort, Nested nested) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilders.java, +++ b/core/src/test/java/org/elasticsearch/search/nested/SimpleNestedIT.java, +import org.elasticsearch.search.sort.NestedSortBuilder;, +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user")))), +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user")))), +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user"), +                    .setNestedSort(new NestedSortBuilder("acl"), +                        .setNestedSort(new NestedSortBuilder("acl.operation"), +                            .setNestedSort(new NestedSortBuilder("acl.operation.user"), +                                .setNestedSort(new NestedSortBuilder("parent"), +                                    .setNestedSort(new NestedSortBuilder("parent.child"))), +++ b/core/src/test/java/org/elasticsearch/search/sort/FieldSortBuilderTests.java, +import static org.elasticsearch.search.sort.NestedSortBuilderTests.createRandomNestedSort;, +            builder.setNestedSort(createRandomNestedSort(3));, +        int parameter = randomIntBetween(0, 4);, +        case 0:, +            mutated.setNestedSort(randomValueOtherThan(original.getNestedSort(), () -> NestedSortBuilderTests.createRandomNestedSort(3)));, +        case 1:, +        case 2:, +        case 3:, +        case 4:, +++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import static org.elasticsearch.search.sort.SortBuilder.parseNestedFilter;, +, +public class NestedSortBuilder implements Writeable, ToXContentObject {, +    private final String path;, +        path = in.readOptionalString();, +        filter = in.readOptionalNamedWriteable(QueryBuilder.class);]