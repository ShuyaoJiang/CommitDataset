[+++ b/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +        return new InternalAggregations(reducedAggregations);, +++ b/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +        return new InternalAggregations(reducedAggregations);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/InternalSingleBucketAggregation.java, +    private long docCount;, +    private InternalAggregations aggregations;, +    /**, +     * Create a <b>new</b> empty sub aggregation. This must be a new instance on each call., +     */, +    protected abstract InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations);, +, +        long docCount = 0L;, +            assert aggregation.getName().equals(getName());, +            docCount += ((InternalSingleBucketAggregation) aggregation).docCount;, +        final InternalAggregations aggs = InternalAggregations.reduce(subAggregationsList, reduceContext.bigArrays());, +        return newAggregation(getName(), docCount, aggs);, +++ b/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +        return new InternalAggregations(reducedAggregations);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/InternalSingleBucketAggregation.java, +    private long docCount;, +    private InternalAggregations aggregations;, +    /**, +     * Create a <b>new</b> empty sub aggregation. This must be a new instance on each call., +     */, +    protected abstract InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations);, +, +        long docCount = 0L;, +            assert aggregation.getName().equals(getName());, +            docCount += ((InternalSingleBucketAggregation) aggregation).docCount;, +        final InternalAggregations aggs = InternalAggregations.reduce(subAggregationsList, reduceContext.bigArrays());, +        return newAggregation(getName(), docCount, aggs);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/InternalFilter.java, +    @Override, +    protected InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations) {, +        return new InternalFilter(name, docCount, subAggregations);, +    }, +++ b/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +        return new InternalAggregations(reducedAggregations);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/InternalSingleBucketAggregation.java, +    private long docCount;, +    private InternalAggregations aggregations;, +    /**, +     * Create a <b>new</b> empty sub aggregation. This must be a new instance on each call., +     */, +    protected abstract InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations);, +, +        long docCount = 0L;, +            assert aggregation.getName().equals(getName());, +            docCount += ((InternalSingleBucketAggregation) aggregation).docCount;, +        final InternalAggregations aggs = InternalAggregations.reduce(subAggregationsList, reduceContext.bigArrays());, +        return newAggregation(getName(), docCount, aggs);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/InternalFilter.java, +    @Override, +    protected InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations) {, +        return new InternalFilter(name, docCount, subAggregations);, +    }, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/InternalGeoHashGrid.java, +            long docCount = 0;, +                docCount += bucket.docCount;, +            final InternalAggregations aggs = InternalAggregations.reduce(aggregationsList, bigArrays);, +            return new Bucket(geohashAsLong, docCount, aggs);, +        return new InternalGeoHashGrid(getName(), requiredSize, Arrays.asList(list));, +++ b/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +        return new InternalAggregations(reducedAggregations);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/InternalSingleBucketAggregation.java, +    private long docCount;, +    private InternalAggregations aggregations;, +    /**, +     * Create a <b>new</b> empty sub aggregation. This must be a new instance on each call., +     */, +    protected abstract InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations);, +, +        long docCount = 0L;, +            assert aggregation.getName().equals(getName());, +            docCount += ((InternalSingleBucketAggregation) aggregation).docCount;, +        final InternalAggregations aggs = InternalAggregations.reduce(subAggregationsList, reduceContext.bigArrays());, +        return newAggregation(getName(), docCount, aggs);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/InternalFilter.java, +    @Override, +    protected InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations) {, +        return new InternalFilter(name, docCount, subAggregations);, +    }, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/InternalGeoHashGrid.java, +            long docCount = 0;, +                docCount += bucket.docCount;, +            final InternalAggregations aggs = InternalAggregations.reduce(aggregationsList, bigArrays);, +            return new Bucket(geohashAsLong, docCount, aggs);, +        return new InternalGeoHashGrid(getName(), requiredSize, Arrays.asList(list));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/global/InternalGlobal.java, +, +    @Override, +    protected InternalSingleBucketAggregation newAggregation(String name, long docCount, InternalAggregations subAggregations) {, +        return new InternalGlobal(name, docCount, subAggregations);, +    }, +++ b/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +        return new InternalAggregations(reducedAggregations);, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/InternalSingleBucketAggregation.java, +    private long docCount;, +    private InternalAggregations aggregations;]