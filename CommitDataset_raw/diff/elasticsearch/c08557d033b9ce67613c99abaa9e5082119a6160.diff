[+++ b/client/transport/build.gradle, +  testCompile "org.hamcrest:hamcrest-all:${versions.hamcrest}", +++ b/client/transport/build.gradle, +  testCompile "org.hamcrest:hamcrest-all:${versions.hamcrest}", +++ b/client/transport/src/main/java/org/elasticsearch/transport/client/PreBuiltTransportClient.java, +import io.netty.util.ThreadDeathWatcher;, +import io.netty.util.concurrent.GlobalEventExecutor;, +import org.elasticsearch.common.network.NetworkModule;, +import java.util.concurrent.TimeUnit;, +    @Override, +    public void close() {, +        super.close();, +        if (!NetworkModule.TRANSPORT_TYPE_SETTING.exists(settings), +            || NetworkModule.TRANSPORT_TYPE_SETTING.get(settings).equals(Netty4Plugin.NETTY_TRANSPORT_NAME)) {, +            try {, +                GlobalEventExecutor.INSTANCE.awaitInactivity(5, TimeUnit.SECONDS);, +                ThreadDeathWatcher.awaitInactivity(5, TimeUnit.SECONDS);, +            } catch (InterruptedException e) {, +                throw new RuntimeException(e);, +            }, +        }, +    }, +]