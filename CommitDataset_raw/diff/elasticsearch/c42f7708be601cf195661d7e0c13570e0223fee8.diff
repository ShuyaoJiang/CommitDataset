[+++ b/src/main/java/org/elasticsearch/common/lucene/all/AllEntries.java, +        if (!entries.isEmpty()) {, +        return 1.0f;, +    }, +++ b/src/main/java/org/elasticsearch/common/lucene/all/AllEntries.java, +        if (!entries.isEmpty()) {, +        return 1.0f;, +    }, +++ b/src/test/java/org/elasticsearch/common/lucene/all/SimpleAllTests.java, +, +    @Test, +    public void testNoTokensWithKeywordAnalyzer() throws Exception {, +        Directory dir = new RAMDirectory();, +        IndexWriter indexWriter = new IndexWriter(dir, new IndexWriterConfig(Lucene.VERSION, Lucene.KEYWORD_ANALYZER));, +, +        Document doc = new Document();, +        doc.add(new Field("_id", "1", StoredField.TYPE));, +        AllEntries allEntries = new AllEntries();, +        allEntries.reset();, +        doc.add(new TextField("_all", AllTokenStream.allTokenStream("_all", allEntries, Lucene.KEYWORD_ANALYZER)));, +, +        indexWriter.addDocument(doc);, +, +        IndexReader reader = DirectoryReader.open(indexWriter, true);, +        IndexSearcher searcher = new IndexSearcher(reader);, +, +        TopDocs docs = searcher.search(new MatchAllDocsQuery(), 10);, +        assertThat(docs.totalHits, equalTo(1));, +        assertThat(docs.scoreDocs[0].doc, equalTo(0));, +    }, +++ b/src/main/java/org/elasticsearch/common/lucene/all/AllEntries.java, +        if (!entries.isEmpty()) {, +        return 1.0f;, +    }, +++ b/src/test/java/org/elasticsearch/common/lucene/all/SimpleAllTests.java, +, +    @Test, +    public void testNoTokensWithKeywordAnalyzer() throws Exception {, +        Directory dir = new RAMDirectory();, +        IndexWriter indexWriter = new IndexWriter(dir, new IndexWriterConfig(Lucene.VERSION, Lucene.KEYWORD_ANALYZER));, +, +        Document doc = new Document();, +        doc.add(new Field("_id", "1", StoredField.TYPE));, +        AllEntries allEntries = new AllEntries();, +        allEntries.reset();, +        doc.add(new TextField("_all", AllTokenStream.allTokenStream("_all", allEntries, Lucene.KEYWORD_ANALYZER)));, +, +        indexWriter.addDocument(doc);, +, +        IndexReader reader = DirectoryReader.open(indexWriter, true);, +        IndexSearcher searcher = new IndexSearcher(reader);, +, +        TopDocs docs = searcher.search(new MatchAllDocsQuery(), 10);, +        assertThat(docs.totalHits, equalTo(1));, +        assertThat(docs.scoreDocs[0].doc, equalTo(0));, +    }, +++ b/src/test/java/org/elasticsearch/search/query/SimpleQueryTests.java, +, +    @Test, +    public void testSearchEmptyDoc() {, +        prepareCreate("test").setSettings("{\"index.analysis.analyzer.default.type\":\"keyword\"}").get();, +        client().prepareIndex("test", "type1", "1").setSource("{}").get();, +        refresh();, +        assertHitCount(client().prepareSearch().setQuery(matchAllQuery()).get(), 1l);, +    }, +]