[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildFilterParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildFilterParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildFilterParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/QueryParseContext.java, +    private static ThreadLocal<String[]> typesContext = new ThreadLocal<String[]>();, +, +    public static void setTypes(String[] types) {, +        typesContext.set(types);, +    }, +, +    public static String[] getTypes() {, +        return typesContext.get();, +    }, +, +    public static String[] setTypesWithPrevious(String[] types) {, +        String[] old = typesContext.get();, +        setTypes(types);, +        return old;, +    }, +, +    public static void removeTypes() {, +        typesContext.remove();, +    }, +, +        FieldMappers fieldMappers = indexQueryParser.mapperService.smartNameFieldMappers(name, getTypes());, +        return indexQueryParser.mapperService.smartName(name, getTypes());, +        return indexQueryParser.mapperService.smartNameObjectMapper(name, getTypes());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildFilterParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +                // since we switch types, make sure we change the context, +                String[] origTypes = QueryParseContext.setTypesWithPrevious(childType == null ? null : new String[]{childType});, +                QueryParseContext.setTypes(origTypes);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/QueryParseContext.java, +    private static ThreadLocal<String[]> typesContext = new ThreadLocal<String[]>();, +, +    public static void setTypes(String[] types) {, +        typesContext.set(types);, +    }, +, +    public static String[] getTypes() {, +        return typesContext.get();, +    }, +, +    public static String[] setTypesWithPrevious(String[] types) {, +        String[] old = typesContext.get();, +        setTypes(types);, +        return old;, +    }, +, +    public static void removeTypes() {, +        typesContext.remove();, +    }, +, +        FieldMappers fieldMappers = indexQueryParser.mapperService.smartNameFieldMappers(name, getTypes());, +        return indexQueryParser.mapperService.smartName(name, getTypes());, +        return indexQueryParser.mapperService.smartNameObjectMapper(name, getTypes());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/internal/SearchContext.java, +import org.elasticsearch.index.query.QueryParseContext;, +        QueryParseContext.setTypes(value.types());, +        QueryParseContext.removeTypes();]