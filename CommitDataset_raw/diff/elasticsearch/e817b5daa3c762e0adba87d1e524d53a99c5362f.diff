[+++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/get/TransportGetTaskAction.java, +import org.elasticsearch.tasks.TaskInfo;, +            // Task isn't running, go look in the task index, +                        waitedForCompletion(thisTask, request, runningTask.taskInfo(clusterService.localNode(), true), listener);, +                TaskInfo info = runningTask.taskInfo(clusterService.localNode(), true);, +                listener.onResponse(new GetTaskResponse(new PersistedTaskInfo(false, info)));, +     * Called after waiting for the task to complete. Attempts to load the results of the task from the tasks index. If it isn't in the, +     * index then returns a snapshot of the task taken shortly after completion., +     */, +    void waitedForCompletion(Task thisTask, GetTaskRequest request, TaskInfo snapshotOfRunningTask,, +            ActionListener<GetTaskResponse> listener) {, +        getFinishedTaskFromIndex(thisTask, request, new ActionListener<GetTaskResponse>() {, +            @Override, +            public void onResponse(GetTaskResponse response) {, +                // We were able to load the task from the task index. Let's send that back., +                listener.onResponse(response);, +            }, +, +            @Override, +            public void onFailure(Throwable e) {, +                /*, +                 * We couldn't load the task from the task index. Instead of 404 we should use the snapshot we took after it finished. If, +                 * the error isn't a 404 then we'll just throw it back to the user., +                 */, +                if (ExceptionsHelper.unwrap(e, ResourceNotFoundException.class) != null) {, +                    listener.onResponse(new GetTaskResponse(new PersistedTaskInfo(true, snapshotOfRunningTask)));, +                } else {, +                    listener.onFailure(e);, +                }, +            }, +        });, +    }, +, +    /**, +     * Send a {@link GetRequest} to the tasks index looking for a persisted copy of the task completed task. It'll only be found only if the, +     * task's result was persisted. Called on the node that once had the task if that node is still part of the cluster or on the, +     * coordinating node if the node is no longer part of the cluster., +            return;, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/get/TransportGetTaskAction.java, +import org.elasticsearch.tasks.TaskInfo;, +            // Task isn't running, go look in the task index, +                        waitedForCompletion(thisTask, request, runningTask.taskInfo(clusterService.localNode(), true), listener);, +                TaskInfo info = runningTask.taskInfo(clusterService.localNode(), true);, +                listener.onResponse(new GetTaskResponse(new PersistedTaskInfo(false, info)));, +     * Called after waiting for the task to complete. Attempts to load the results of the task from the tasks index. If it isn't in the, +     * index then returns a snapshot of the task taken shortly after completion., +     */, +    void waitedForCompletion(Task thisTask, GetTaskRequest request, TaskInfo snapshotOfRunningTask,, +            ActionListener<GetTaskResponse> listener) {, +        getFinishedTaskFromIndex(thisTask, request, new ActionListener<GetTaskResponse>() {, +            @Override, +            public void onResponse(GetTaskResponse response) {, +                // We were able to load the task from the task index. Let's send that back., +                listener.onResponse(response);, +            }, +, +            @Override, +            public void onFailure(Throwable e) {, +                /*, +                 * We couldn't load the task from the task index. Instead of 404 we should use the snapshot we took after it finished. If, +                 * the error isn't a 404 then we'll just throw it back to the user., +                 */, +                if (ExceptionsHelper.unwrap(e, ResourceNotFoundException.class) != null) {, +                    listener.onResponse(new GetTaskResponse(new PersistedTaskInfo(true, snapshotOfRunningTask)));, +                } else {, +                    listener.onFailure(e);, +                }, +            }, +        });, +    }, +, +    /**, +     * Send a {@link GetRequest} to the tasks index looking for a persisted copy of the task completed task. It'll only be found only if the, +     * task's result was persisted. Called on the node that once had the task if that node is still part of the cluster or on the, +     * coordinating node if the node is no longer part of the cluster., +            return;, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +        expectedSuccessfulOps = shardCount;, +        // we need to add 1 for non active partition, since we count it in the total!, +        expectedTotalOps = shardsIts.totalSizeWith1ForEmpty();, +, +        firstResults = new AtomicArray<>(shardsIts.size());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/get/TransportGetTaskAction.java, +import org.elasticsearch.tasks.TaskInfo;, +            // Task isn't running, go look in the task index, +                        waitedForCompletion(thisTask, request, runningTask.taskInfo(clusterService.localNode(), true), listener);, +                TaskInfo info = runningTask.taskInfo(clusterService.localNode(), true);, +                listener.onResponse(new GetTaskResponse(new PersistedTaskInfo(false, info)));, +     * Called after waiting for the task to complete. Attempts to load the results of the task from the tasks index. If it isn't in the, +     * index then returns a snapshot of the task taken shortly after completion., +     */, +    void waitedForCompletion(Task thisTask, GetTaskRequest request, TaskInfo snapshotOfRunningTask,, +            ActionListener<GetTaskResponse> listener) {, +        getFinishedTaskFromIndex(thisTask, request, new ActionListener<GetTaskResponse>() {, +            @Override, +            public void onResponse(GetTaskResponse response) {, +                // We were able to load the task from the task index. Let's send that back., +                listener.onResponse(response);, +            }, +]