[+++ /dev/null, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +    private final Object mappersMutex = new Object();, +    public void addFieldMappers(Collection<FieldMapper> fieldMappers) {, +        synchronized (mappersMutex) {, +    public void addObjectMappers(Collection<ObjectMapper> objectMappers) {, +        synchronized (mappersMutex) {, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +    private final Object mappersMutex = new Object();, +    public void addFieldMappers(Collection<FieldMapper> fieldMappers) {, +        synchronized (mappersMutex) {, +    public void addObjectMappers(Collection<ObjectMapper> objectMappers) {, +        synchronized (mappersMutex) {, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +    private final Object typeMutex = new Object();, +    private final Object mappersMutex = new Object();, +            synchronized (typeMutex) {, +        synchronized (typeMutex) {, +        synchronized (mappersMutex) {, +        synchronized (mappersMutex) {, +        synchronized (typeMutex) {, +        synchronized (mappersMutex) {, +    }, +        synchronized (typeMutex) {, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +    private final Object mappersMutex = new Object();, +    public void addFieldMappers(Collection<FieldMapper> fieldMappers) {, +        synchronized (mappersMutex) {, +    public void addObjectMappers(Collection<ObjectMapper> objectMappers) {, +        synchronized (mappersMutex) {, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +    private final Object typeMutex = new Object();, +    private final Object mappersMutex = new Object();, +            synchronized (typeMutex) {, +        synchronized (typeMutex) {, +        synchronized (mappersMutex) {, +        synchronized (mappersMutex) {, +        synchronized (typeMutex) {, +        synchronized (mappersMutex) {, +    }, +        synchronized (typeMutex) {, +++ b/src/main/java/org/elasticsearch/index/mapper/ParseContext.java, +    private boolean withinNewMapper = false;, +        this.withinNewMapper = false;, +    public void setWithinNewMapper() {, +        this.withinNewMapper = true;, +    }, +, +    public void clearWithinNewMapper() {, +        this.withinNewMapper = false;, +    }, +, +    public boolean isWithinNewMapper() {, +        return withinNewMapper;, +    }, +, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +    private final Object mappersMutex = new Object();, +    public void addFieldMappers(Collection<FieldMapper> fieldMappers) {, +        synchronized (mappersMutex) {, +    public void addObjectMappers(Collection<ObjectMapper> objectMappers) {, +        synchronized (mappersMutex) {, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +    private final Object typeMutex = new Object();, +    private final Object mappersMutex = new Object();, +            synchronized (typeMutex) {, +        synchronized (typeMutex) {, +        synchronized (mappersMutex) {, +        synchronized (mappersMutex) {, +        synchronized (typeMutex) {, +        synchronized (mappersMutex) {, +    }, +        synchronized (typeMutex) {, +++ b/src/main/java/org/elasticsearch/index/mapper/ParseContext.java, +    private boolean withinNewMapper = false;, +        this.withinNewMapper = false;, +    public void setWithinNewMapper() {, +        this.withinNewMapper = true;, +    }, +, +    public void clearWithinNewMapper() {, +        this.withinNewMapper = false;, +    }, +, +    public boolean isWithinNewMapper() {, +        return withinNewMapper;, +    }, +, +++ b/src/main/java/org/elasticsearch/index/mapper/object/ObjectMapper.java, +, +                        if (context.isWithinNewMapper()) {, +                            // within a new mapper, no need to traverse, just parse, +                            // create a context of new mapper, so we batch aggregate all the changes within, +                            // this object mapper once, and traverse all of them to add them in a single go, +                            context.setWithinNewMapper();, +                            try {]