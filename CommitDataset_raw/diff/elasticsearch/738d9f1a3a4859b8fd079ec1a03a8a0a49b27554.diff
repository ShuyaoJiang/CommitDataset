[+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/snapshots/SourceOnlySnapshotTests.java, +import org.apache.lucene.index.FilterDirectoryReader;, +import org.apache.lucene.index.LeafReader;, +import java.util.ArrayList;, +                             ? new SoftDeletesDirectoryReaderWrapper(wrappedReader, softDeletesField) :, +                             new DropFullDeletedSegmentsReader(wrappedReader);, +                         logger.warn(snapReader + " " + reader);, +, +    static class DropFullDeletedSegmentsReader extends FilterDirectoryReader {, +        public DropFullDeletedSegmentsReader(DirectoryReader in) throws IOException {, +            super(in, new SubReaderWrapper() {, +                @Override, +                protected LeafReader[] wrap(List<? extends LeafReader> readers) {, +                    List<LeafReader> wrapped = new ArrayList<>(readers.size());, +                    for (LeafReader reader : readers) {, +                        LeafReader wrap = wrap(reader);, +                        assert wrap != null;, +                        if (wrap.numDocs() != 0) {, +                            wrapped.add(wrap);, +                        }, +                    }, +                    return wrapped.toArray(new LeafReader[0]);, +                }, +, +                @Override, +                public LeafReader wrap(LeafReader reader) {, +                    return reader;, +                }, +            });, +        }, +, +        @Override, +        protected DirectoryReader doWrapDirectoryReader(DirectoryReader in) throws IOException {, +            return new DropFullDeletedSegmentsReader(in);, +        }, +, +        @Override, +        public CacheHelper getReaderCacheHelper() {, +            return in.getReaderCacheHelper();, +        }, +    }, +]