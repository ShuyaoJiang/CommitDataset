[+++ b/core/src/test/java/org/elasticsearch/index/translog/TruncateTranslogIT.java, +import org.apache.lucene.index.IndexWriter;, +import org.apache.lucene.store.Directory;, +import org.apache.lucene.store.FSDirectory;, +import org.apache.lucene.store.Lock;, +import org.apache.lucene.store.LockObtainFailedException;, +import org.apache.lucene.store.NativeFSLockFactory;, +import org.elasticsearch.ElasticsearchException;, +            final Path idxLocation = translogDir.getParent().resolve("index");, +            assertBusy(() -> {, +                logger.info("--> checking that lock has been released for {}", idxLocation);, +                try (Directory dir = FSDirectory.open(idxLocation, NativeFSLockFactory.INSTANCE);, +                        Lock writeLock = dir.obtainLock(IndexWriter.WRITE_LOCK_NAME)) {, +                    // Great, do nothing, we just wanted to obtain the lock, +                }  catch (LockObtainFailedException lofe) {, +                    throw new ElasticsearchException("Still waiting for lock release at [" + idxLocation + "]");, +                } catch (IOException ioe) {, +                    fail("Got an IOException: " + ioe);, +                }, +            });, +]