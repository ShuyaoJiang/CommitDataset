[+++ b/src/test/java/org/elasticsearch/test/integration/gateway/local/SimpleRecoveryLocalGatewayTests.java, +import org.elasticsearch.common.unit.TimeValue;, +        assertThat(waitForNodesToShutdown(TimeValue.timeValueSeconds(30), 4), equalTo(true));, +        assertThat(waitForNodesToShutdown(TimeValue.timeValueSeconds(30), 4), equalTo(true));, +, +    private boolean waitForNodesToShutdown(TimeValue timeout, int numberOfNodes) throws InterruptedException {, +        long start = System.currentTimeMillis();, +        WAIT_FOR_CLOSING:, +        while ((System.currentTimeMillis() - start) < timeout.millis()) {, +            Thread.sleep(100);, +            for (int i = 1; i < numberOfNodes + 1; i++) {, +                if (!node("node" + i).isClosed()) continue WAIT_FOR_CLOSING;, +            }, +            return true;, +        }, +        return false;, +    }]