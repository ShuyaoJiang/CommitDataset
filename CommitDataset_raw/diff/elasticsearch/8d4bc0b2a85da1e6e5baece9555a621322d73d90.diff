[+++ b/core/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java, +                    AnalysisModule.AnalysisProvider<CharFilterFactory> charFilterFactoryFactory;, +                        charFilterFactoryFactory = analysisRegistry.getCharFilterProvider(charFilter.name);, +                        charFilterFactoryFactory = analysisRegistry.getCharFilterProvider(charFilter.name, analysisService.getIndexSettings());, +                        if (charFilterFactoryFactory == null) {, +                        charFilterFactories[i] = charFilterFactoryFactory.get(analysisService.getIndexSettings(), environment, charFilter.name,, +                            AnalysisRegistry.getSettingsFromIndexSettings(analysisService.getIndexSettings(),, +                                AnalysisRegistry.INDEX_ANALYSIS_CHAR_FILTER + "." + charFilter.name));, +                    AnalysisModule.AnalysisProvider<TokenFilterFactory> tokenFilterFactoryFactory;, +                        tokenFilterFactoryFactory = analysisRegistry.getTokenFilterProvider(tokenFilter.name);, +                        tokenFilterFactoryFactory = analysisRegistry.getTokenFilterProvider(tokenFilter.name, analysisService.getIndexSettings());, +                       if (tokenFilterFactoryFactory == null) {, +                        tokenFilterFactories[i] = tokenFilterFactoryFactory.get(analysisService.getIndexSettings(), environment, tokenFilter.name,, +                            AnalysisRegistry.getSettingsFromIndexSettings(analysisService.getIndexSettings(),, +                                AnalysisRegistry.INDEX_ANALYSIS_FILTER + "." + tokenFilter.name));, +            AnalysisModule.AnalysisProvider<TokenizerFactory> tokenizerFactoryFactory;, +                tokenizerFactoryFactory = analysisRegistry.getTokenizerProvider(tokenizer.name);, +                tokenizerFactoryFactory = analysisRegistry.getTokenizerProvider(tokenizer.name, analysisService.getIndexSettings());, +                if (tokenizerFactoryFactory == null) {, +                tokenizerFactory = tokenizerFactoryFactory.get(analysisService.getIndexSettings(), environment, tokenizer.name,, +                    AnalysisRegistry.getSettingsFromIndexSettings(analysisService.getIndexSettings(),, +                        AnalysisRegistry.INDEX_ANALYSIS_TOKENIZER + "." + tokenizer.name));, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java, +                    AnalysisModule.AnalysisProvider<CharFilterFactory> charFilterFactoryFactory;, +                        charFilterFactoryFactory = analysisRegistry.getCharFilterProvider(charFilter.name);, +                        charFilterFactoryFactory = analysisRegistry.getCharFilterProvider(charFilter.name, analysisService.getIndexSettings());, +                        if (charFilterFactoryFactory == null) {, +                        charFilterFactories[i] = charFilterFactoryFactory.get(analysisService.getIndexSettings(), environment, charFilter.name,, +                            AnalysisRegistry.getSettingsFromIndexSettings(analysisService.getIndexSettings(),, +                                AnalysisRegistry.INDEX_ANALYSIS_CHAR_FILTER + "." + charFilter.name));, +                    AnalysisModule.AnalysisProvider<TokenFilterFactory> tokenFilterFactoryFactory;, +                        tokenFilterFactoryFactory = analysisRegistry.getTokenFilterProvider(tokenFilter.name);, +                        tokenFilterFactoryFactory = analysisRegistry.getTokenFilterProvider(tokenFilter.name, analysisService.getIndexSettings());, +                       if (tokenFilterFactoryFactory == null) {, +                        tokenFilterFactories[i] = tokenFilterFactoryFactory.get(analysisService.getIndexSettings(), environment, tokenFilter.name,, +                            AnalysisRegistry.getSettingsFromIndexSettings(analysisService.getIndexSettings(),, +                                AnalysisRegistry.INDEX_ANALYSIS_FILTER + "." + tokenFilter.name));, +            AnalysisModule.AnalysisProvider<TokenizerFactory> tokenizerFactoryFactory;, +                tokenizerFactoryFactory = analysisRegistry.getTokenizerProvider(tokenizer.name);, +                tokenizerFactoryFactory = analysisRegistry.getTokenizerProvider(tokenizer.name, analysisService.getIndexSettings());, +                if (tokenizerFactoryFactory == null) {, +                tokenizerFactory = tokenizerFactoryFactory.get(analysisService.getIndexSettings(), environment, tokenizer.name,, +                    AnalysisRegistry.getSettingsFromIndexSettings(analysisService.getIndexSettings(),, +                        AnalysisRegistry.INDEX_ANALYSIS_TOKENIZER + "." + tokenizer.name));, +++ b/core/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +    public static final String INDEX_ANALYSIS_CHAR_FILTER = "index.analysis.char_filter";, +    public static final String INDEX_ANALYSIS_FILTER = "index.analysis.filter";, +    public static final String INDEX_ANALYSIS_TOKENIZER = "index.analysis.tokenizer";, +     * Returns a {@link Settings} by groupName from {@link IndexSettings} or a default {@link Settings}, +     * @param indexSettings an index settings, +     * @param groupName tokenizer/token filter/char filter name, +     * @return {@link Settings}, +     */, +    public static Settings getSettingsFromIndexSettings(IndexSettings indexSettings, String groupName) {, +        Settings settings = indexSettings.getSettings().getAsSettings(groupName);, +        if (settings.isEmpty()) {, +            settings = Settings.builder().put(IndexMetaData.SETTING_VERSION_CREATED, indexSettings.getIndexVersionCreated()).build();, +        }, +        return settings;, +    }, +, +    /**, +        final Map<String, Settings> charFiltersSettings = indexSettings.getSettings().getGroups(INDEX_ANALYSIS_CHAR_FILTER);, +        final Map<String, Settings> tokenFiltersSettings = indexSettings.getSettings().getGroups(INDEX_ANALYSIS_FILTER);, +        final Map<String, Settings> tokenizersSettings = indexSettings.getSettings().getGroups(INDEX_ANALYSIS_TOKENIZER);, +        tokenFilters.put("synonym", requriesAnalysisSettings((is, env, name, settings) -> new SynonymTokenFilterFactory(is, env, this, name, settings)));, +    /**, +     * Returns a registered {@link TokenizerFactory} provider by {@link IndexSettings}, +     *  or a registered {@link TokenizerFactory} provider by predefined name, +     *  or <code>null</code> if the tokenizer was not registered, +     * @param tokenizer global or defined tokenizer name, +     * @param indexSettings an index settings, +     * @return {@link TokenizerFactory} provider or <code>null</code>, +     */, +    public AnalysisProvider<TokenizerFactory> getTokenizerProvider(String tokenizer, IndexSettings indexSettings) {, +        final Map<String, Settings> tokenizerSettings = indexSettings.getSettings().getGroups("index.analysis.tokenizer");, +        if (tokenizerSettings.containsKey(tokenizer)) {, +            Settings currentSettings = tokenizerSettings.get(tokenizer);, +            return getAnalysisProvider("tokenizer", tokenizers, tokenizer, currentSettings.get("type"));, +        } else {, +            return prebuiltAnalysis.tokenizerFactories.get(tokenizer);, +        }, +    }, +, +    /**, +     * Returns a registered {@link TokenFilterFactory} provider by {@link IndexSettings}, +     *  or a registered {@link TokenFilterFactory} provider by predefined name, +     *  or <code>null</code> if the tokenFilter was not registered, +     * @param tokenFilter global or defined tokenFilter name, +     * @param indexSettings an index settings, +     * @return {@link TokenFilterFactory} provider or <code>null</code>, +     */, +    public AnalysisProvider<TokenFilterFactory> getTokenFilterProvider(String tokenFilter, IndexSettings indexSettings) {, +        final Map<String, Settings> tokenFilterSettings = indexSettings.getSettings().getGroups("index.analysis.filter");, +        if (tokenFilterSettings.containsKey(tokenFilter)) {, +            Settings currentSettings = tokenFilterSettings.get(tokenFilter);, +            String typeName = currentSettings.get("type");, +            /*, +             * synonym is different than everything else since it needs access to the tokenizer factories for this index., +             * instead of building the infrastructure for plugins we rather make it a real exception to not pollute the general interface and]