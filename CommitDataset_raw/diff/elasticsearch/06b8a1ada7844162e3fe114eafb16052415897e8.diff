[+++ b/core/src/test/java/org/elasticsearch/action/admin/cluster/allocation/ClusterAllocationExplainIT.java, +import static org.hamcrest.Matchers.equalTo;, +        final String masterNode = internalCluster().startNode();, +        // start replica node first, so it's path will be used first when we start a node after, +        // stopping all of them at end of test., +        final String replicaNode = internalCluster().startNode();, +        final String primaryNode = internalCluster().startNode();, +            Settings.builder(), +                .put("index.routing.allocation.include._name", primaryNode), +                .put("index.routing.allocation.exclude._name", masterNode), +                .build(),, +            ActiveShardCount.ONE);, +, +        client().admin().indices().prepareUpdateSettings("idx").setSettings(, +            Settings.builder().put("index.routing.allocation.include._name", (String) null)).get();, +        ensureGreen();, +, +        assertThat(replicaNode().getName(), equalTo(replicaNode));, +        assertThat(primaryNodeName(), equalTo(primaryNode));, +        internalCluster().stopRandomNode(InternalTestCluster.nameFilter(replicaNode));, +        internalCluster().stopRandomNode(InternalTestCluster.nameFilter(primaryNode));, +        String restartedNode = internalCluster().startDataOnlyNode();, +        ensureClusterSizeConsistency(); // wait for the master to finish processing join.]