[+++ b/src/main/java/org/elasticsearch/indices/store/IndicesStore.java, +                logger.trace("not deleting shard {}, expected {} active copies, but only {} found active copies", shardId, expectedActiveCopies, activeCopies.get());, +                logger.trace("not deleting shard {}, the latest cluster state version[{}] is not equal to cluster state before shard active api call [{}]", shardId, latestClusterState.getVersion(), clusterState.getVersion());, +            clusterService.submitStateUpdateTask("indices_store", new ClusterStateUpdateTask() {, +                @Override, +                public ClusterState execute(ClusterState currentState) throws Exception {, +                    if (clusterState.getVersion() != currentState.getVersion()) {, +                        logger.trace("not deleting shard {}, the update task state version[{}] is not equal to cluster state before shard active api call [{}]", shardId, currentState.getVersion(), clusterState.getVersion());, +                        return currentState;, +                    }, +, +                                logger.debug("[{}][{}] deleting shard that is no longer used", shardId);, +                                logger.debug("{} deleting shard that is no longer used", shardId);, +                                    logger.debug("{} failed to delete unallocated shard, ignoring", e, shardId);, +                    return currentState;, +                }, +, +                @Override, +                public void onFailure(String source, Throwable t) {, +                    logger.error("{} unexpected error during deletion of unallocated shard", t, shardId);, +                }, +            });]