[+++ b/src/main/java/org/elasticsearch/gateway/local/LocalGatewayAllocator.java, +import com.carrotsearch.hppc.predicates.ObjectPredicate;, +    private ObjectLongOpenHashMap<DiscoveryNode> buildShardStates(final DiscoveryNodes nodes, MutableShardRouting shard) {, +            shardStates.keys().removeAll(new ObjectPredicate<DiscoveryNode>() {, +                @Override, +                public boolean apply(DiscoveryNode node) {, +                    return !nodes.nodeExists(node.id());, +            });]