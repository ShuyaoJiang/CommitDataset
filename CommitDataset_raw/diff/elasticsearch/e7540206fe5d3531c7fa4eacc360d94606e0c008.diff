[+++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportResumeFollowAction.java, +            throw new IllegalArgumentException("the leader index setting[" + leaderSettings + "] and follower index settings [" +, +                followerSettings + "] must be identical");, +        // Follower index may be upgraded, while the leader index hasn't been upgraded, so it is expected, +        // that these settings are different:, +        settings.remove(IndexMetaData.SETTING_VERSION_UPGRADED);, +        settings.remove(IndexMetaData.SETTING_VERSION_UPGRADED_STRING);, +, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportResumeFollowAction.java, +            throw new IllegalArgumentException("the leader index setting[" + leaderSettings + "] and follower index settings [" +, +                followerSettings + "] must be identical");, +        // Follower index may be upgraded, while the leader index hasn't been upgraded, so it is expected, +        // that these settings are different:, +        settings.remove(IndexMetaData.SETTING_VERSION_UPGRADED);, +        settings.remove(IndexMetaData.SETTING_VERSION_UPGRADED_STRING);, +, +++ b/x-pack/plugin/ccr/src/test/java/org/elasticsearch/xpack/ccr/action/TransportResumeFollowActionTests.java, +            assertThat(e.getMessage(), equalTo("the leader index setting[{\"index.analysis.analyzer.my_analyzer.tokenizer\"" +, +                ":\"whitespace\",\"index.analysis.analyzer.my_analyzer.type\":\"custom\",\"index.number_of_shards\":\"5\"}] " +, +                "and follower index settings [{\"index.analysis.analyzer.my_analyzer.tokenizer\":\"standard\"," +, +                "\"index.analysis.analyzer.my_analyzer.type\":\"custom\",\"index.number_of_shards\":\"5\"}] must be identical"));, +    public void testFilter() {, +        Settings.Builder settings = Settings.builder();, +        settings.put(CcrSettings.CCR_FOLLOWING_INDEX_SETTING.getKey(), "");, +        settings.put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), "");, +        settings.put(IndexMetaData.SETTING_INDEX_VERSION_CREATED.getKey(), "");, +        settings.put(IndexMetaData.SETTING_INDEX_UUID, "");, +        settings.put(IndexMetaData.SETTING_INDEX_PROVIDED_NAME, "");, +        settings.put(IndexMetaData.SETTING_CREATION_DATE, "");, +        settings.put(IndexMetaData.SETTING_VERSION_UPGRADED, "");, +        settings.put(IndexMetaData.SETTING_VERSION_UPGRADED_STRING, "");, +, +        Settings result = TransportResumeFollowAction.filter(settings.build());, +        assertThat(result.size(), equalTo(0));, +    }, +, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportResumeFollowAction.java, +            throw new IllegalArgumentException("the leader index setting[" + leaderSettings + "] and follower index settings [" +, +                followerSettings + "] must be identical");, +        // Follower index may be upgraded, while the leader index hasn't been upgraded, so it is expected, +        // that these settings are different:, +        settings.remove(IndexMetaData.SETTING_VERSION_UPGRADED);, +        settings.remove(IndexMetaData.SETTING_VERSION_UPGRADED_STRING);, +, +++ b/x-pack/plugin/ccr/src/test/java/org/elasticsearch/xpack/ccr/action/TransportResumeFollowActionTests.java, +            assertThat(e.getMessage(), equalTo("the leader index setting[{\"index.analysis.analyzer.my_analyzer.tokenizer\"" +, +                ":\"whitespace\",\"index.analysis.analyzer.my_analyzer.type\":\"custom\",\"index.number_of_shards\":\"5\"}] " +, +                "and follower index settings [{\"index.analysis.analyzer.my_analyzer.tokenizer\":\"standard\"," +, +                "\"index.analysis.analyzer.my_analyzer.type\":\"custom\",\"index.number_of_shards\":\"5\"}] must be identical"));, +    public void testFilter() {, +        Settings.Builder settings = Settings.builder();, +        settings.put(CcrSettings.CCR_FOLLOWING_INDEX_SETTING.getKey(), "");, +        settings.put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), "");, +        settings.put(IndexMetaData.SETTING_INDEX_VERSION_CREATED.getKey(), "");, +        settings.put(IndexMetaData.SETTING_INDEX_UUID, "");, +        settings.put(IndexMetaData.SETTING_INDEX_PROVIDED_NAME, "");, +        settings.put(IndexMetaData.SETTING_CREATION_DATE, "");, +        settings.put(IndexMetaData.SETTING_VERSION_UPGRADED, "");, +        settings.put(IndexMetaData.SETTING_VERSION_UPGRADED_STRING, "");, +, +        Settings result = TransportResumeFollowAction.filter(settings.build());, +        assertThat(result.size(), equalTo(0));, +    }, +, +++ b/x-pack/qa/rolling-upgrade-multi-cluster/src/test/java/org/elasticsearch/upgrades/CcrRollingUpgradeIT.java]