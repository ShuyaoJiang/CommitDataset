[+++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +                                shardStateAction.shardFailed(shard, indexUUID, "failed to perform " + transportReplicaAction + " on replica on node " + node, exp, shardFailedTimeout, new ReplicationFailedShardStateListener(nodeId, exp));, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +                                shardStateAction.shardFailed(shard, indexUUID, "failed to perform " + transportReplicaAction + " on replica on node " + node, exp, shardFailedTimeout, new ReplicationFailedShardStateListener(nodeId, exp));, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +, +    private final ClusterService clusterService;, +    private final AllocationService allocationService;, +    private final RoutingService routingService;, +        this.clusterService = clusterService;, +        this.allocationService = allocationService;, +        this.routingService = routingService;, +        transportService.registerRequestHandler(SHARD_STARTED_ACTION_NAME, ShardRoutingEntry::new, ThreadPool.Names.SAME, new ShardStartedTransportHandler());, +        transportService.registerRequestHandler(SHARD_FAILED_ACTION_NAME, ShardRoutingEntry::new, ThreadPool.Names.SAME, new ShardFailedTransportHandler());, +    public void shardFailed(final ShardRouting shardRouting, final String indexUUID, final String message, @Nullable final Throwable failure, Listener listener) {, +        shardFailed(shardRouting, indexUUID, message, failure, null, listener);, +    public void shardFailed(final ShardRouting shardRouting, final String indexUUID, final String message, @Nullable final Throwable failure, TimeValue timeout, Listener listener) {, +        DiscoveryNode masterNode = clusterService.state().nodes().masterNode();, +            logger.warn("can't send shard failed for {}, no master known.", shardRouting);, +        innerShardFailed(shardRouting, indexUUID, masterNode, message, failure, timeout, listener);, +    }, +, +    public void resendShardFailed(final ShardRouting shardRouting, final String indexUUID, final DiscoveryNode masterNode, final String message, @Nullable final Throwable failure, Listener listener) {, +        logger.trace("{} re-sending failed shard for {}, indexUUID [{}], reason [{}]", failure, shardRouting.shardId(), shardRouting, indexUUID, message);, +        innerShardFailed(shardRouting, indexUUID, masterNode, message, failure, null, listener);, +    }, +, +    private void innerShardFailed(final ShardRouting shardRouting, final String indexUUID, final DiscoveryNode masterNode, final String message, final Throwable failure, TimeValue timeout, Listener listener) {, +                    logger.warn("unexpected failure while sending request to [{}] to fail shard [{}]", exp, masterNode, shardRoutingEntry);, +    private class ShardFailedTransportHandler implements TransportRequestHandler<ShardRoutingEntry> {, +            handleShardFailureOnMaster(request, new ClusterStateTaskListener() {, +                        logger.error("unexpected failure while failing shard [{}]", t, request.shardRouting);, +                            logger.warn("failed to send failure [{}] while failing shard [{}]", channelThrowable, t, request.shardRouting);, +                        logger.error("no longer master while failing shard [{}]", request.shardRouting);, +                            logger.warn("failed to send no longer master while failing shard [{}]", channelThrowable, request.shardRouting);, +                            logger.warn("failed to send response while failing shard [{}]", channelThrowable, request.shardRouting);, +    class ShardFailedClusterStateHandler implements ClusterStateTaskExecutor<ShardRoutingEntry> {, +    private final ShardFailedClusterStateHandler shardFailedClusterStateHandler = new ShardFailedClusterStateHandler();, +, +    private void handleShardFailureOnMaster(final ShardRoutingEntry shardRoutingEntry, ClusterStateTaskListener listener) {, +        logger.warn("{} received shard failed for {}", shardRoutingEntry.failure, shardRoutingEntry.shardRouting.shardId(), shardRoutingEntry);, +        clusterService.submitStateUpdateTask(, +            "shard-failed (" + shardRoutingEntry.shardRouting + "), message [" + shardRoutingEntry.message + "]",, +            shardRoutingEntry,, +            ClusterStateTaskConfig.build(Priority.HIGH),, +            shardFailedClusterStateHandler,, +            listener);, +    }, +, +    public void shardStarted(final ShardRouting shardRouting, String indexUUID, final String reason) {, +        DiscoveryNode masterNode = clusterService.state().nodes().masterNode();, +            logger.warn("{} can't send shard started for {}, no master known.", shardRouting.shardId(), shardRouting);, +        shardStarted(shardRouting, indexUUID, reason, masterNode);, +    }, +, +    public void shardStarted(final ShardRouting shardRouting, String indexUUID, final String reason, final DiscoveryNode masterNode) {, +        logger.debug("{} sending shard started for {}", shardRoutingEntry.shardRouting.shardId(), shardRoutingEntry);, +                    logger.warn("failed to send shard started to [{}]", exp, masterNode);, +    class ShardStartedTransportHandler implements TransportRequestHandler<ShardRoutingEntry> {, +            handleShardStartedOnMaster(request);, +    class ShardStartedClusterStateHandler implements ClusterStateTaskExecutor<ShardRoutingEntry>, ClusterStateTaskListener {, +    private final ShardStartedClusterStateHandler shardStartedClusterStateHandler = new ShardStartedClusterStateHandler();, +, +    private void handleShardStartedOnMaster(final ShardRoutingEntry shardRoutingEntry) {, +        logger.debug("received shard started for {}", shardRoutingEntry);, +, +        clusterService.submitStateUpdateTask(, +            "shard-started (" + shardRoutingEntry.shardRouting + "), reason [" + shardRoutingEntry.message + "]",, +            shardRoutingEntry,, +            ClusterStateTaskConfig.build(Priority.URGENT),, +            shardStartedClusterStateHandler,, +            shardStartedClusterStateHandler);, +    }, +, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +                                shardStateAction.shardFailed(shard, indexUUID, "failed to perform " + transportReplicaAction + " on replica on node " + node, exp, shardFailedTimeout, new ReplicationFailedShardStateListener(nodeId, exp));, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +, +    private final ClusterService clusterService;, +    private final AllocationService allocationService;, +    private final RoutingService routingService;, +        this.clusterService = clusterService;, +        this.allocationService = allocationService;, +        this.routingService = routingService;, +        transportService.registerRequestHandler(SHARD_STARTED_ACTION_NAME, ShardRoutingEntry::new, ThreadPool.Names.SAME, new ShardStartedTransportHandler());, +        transportService.registerRequestHandler(SHARD_FAILED_ACTION_NAME, ShardRoutingEntry::new, ThreadPool.Names.SAME, new ShardFailedTransportHandler());, +    public void shardFailed(final ShardRouting shardRouting, final String indexUUID, final String message, @Nullable final Throwable failure, Listener listener) {, +        shardFailed(shardRouting, indexUUID, message, failure, null, listener);, +    public void shardFailed(final ShardRouting shardRouting, final String indexUUID, final String message, @Nullable final Throwable failure, TimeValue timeout, Listener listener) {, +        DiscoveryNode masterNode = clusterService.state().nodes().masterNode();, +            logger.warn("can't send shard failed for {}, no master known.", shardRouting);, +        innerShardFailed(shardRouting, indexUUID, masterNode, message, failure, timeout, listener);, +    }, +, +    public void resendShardFailed(final ShardRouting shardRouting, final String indexUUID, final DiscoveryNode masterNode, final String message, @Nullable final Throwable failure, Listener listener) {, +        logger.trace("{} re-sending failed shard for {}, indexUUID [{}], reason [{}]", failure, shardRouting.shardId(), shardRouting, indexUUID, message);, +        innerShardFailed(shardRouting, indexUUID, masterNode, message, failure, null, listener);, +    }, +, +    private void innerShardFailed(final ShardRouting shardRouting, final String indexUUID, final DiscoveryNode masterNode, final String message, final Throwable failure, TimeValue timeout, Listener listener) {]