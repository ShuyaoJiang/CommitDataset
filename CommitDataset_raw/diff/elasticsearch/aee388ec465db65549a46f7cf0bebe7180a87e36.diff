[+++ b/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +import org.elasticsearch.Version;, +    private final String uuid;, +    MetaData(String uuid, long version, Settings transientSettings, Settings persistentSettings, ImmutableOpenMap<String, IndexMetaData> indices, ImmutableOpenMap<String, IndexTemplateMetaData> templates, ImmutableOpenMap<String, Custom> customs) {, +        this.uuid = uuid;, +    public String uuid() {, +        return this.uuid;, +    }, +, +        private String uuid;, +            uuid = "_na_";, +            this.uuid = metaData.uuid;, +        public Builder generateUuidIfNeeded() {, +            if (uuid.equals("_na_")) {, +                uuid = Strings.randomBase64UUID();, +            }, +            return this;, +        }, +, +            return new MetaData(uuid, version, transientSettings, persistentSettings, indices.build(), templates.build(), customs.build());, +            builder.field("uuid", metaData.uuid);, +                    } else if ("uuid".equals(currentFieldName)) {, +                        builder.uuid = parser.text();, +            if (in.getVersion().after(Version.V_0_90_7)) {, +                builder.uuid = in.readString();, +            }, +            if (out.getVersion().after(Version.V_0_90_7)) {, +                out.writeString(metaData.uuid);, +            }, +++ b/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +import org.elasticsearch.Version;, +    private final String uuid;, +    MetaData(String uuid, long version, Settings transientSettings, Settings persistentSettings, ImmutableOpenMap<String, IndexMetaData> indices, ImmutableOpenMap<String, IndexTemplateMetaData> templates, ImmutableOpenMap<String, Custom> customs) {, +        this.uuid = uuid;, +    public String uuid() {, +        return this.uuid;, +    }, +, +        private String uuid;, +            uuid = "_na_";, +            this.uuid = metaData.uuid;, +        public Builder generateUuidIfNeeded() {, +            if (uuid.equals("_na_")) {, +                uuid = Strings.randomBase64UUID();, +            }, +            return this;, +        }, +, +            return new MetaData(uuid, version, transientSettings, persistentSettings, indices.build(), templates.build(), customs.build());, +            builder.field("uuid", metaData.uuid);, +                    } else if ("uuid".equals(currentFieldName)) {, +                        builder.uuid = parser.text();, +            if (in.getVersion().after(Version.V_0_90_7)) {, +                builder.uuid = in.readString();, +            }, +            if (out.getVersion().after(Version.V_0_90_7)) {, +                out.writeString(metaData.uuid);, +            }, +++ b/src/main/java/org/elasticsearch/gateway/GatewayService.java, +                    // automatically generate a UID for the metadata if we need to, +                    metaDataBuilder.generateUuidIfNeeded();, +++ b/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +import org.elasticsearch.Version;, +    private final String uuid;, +    MetaData(String uuid, long version, Settings transientSettings, Settings persistentSettings, ImmutableOpenMap<String, IndexMetaData> indices, ImmutableOpenMap<String, IndexTemplateMetaData> templates, ImmutableOpenMap<String, Custom> customs) {, +        this.uuid = uuid;, +    public String uuid() {, +        return this.uuid;, +    }, +, +        private String uuid;, +            uuid = "_na_";, +            this.uuid = metaData.uuid;, +        public Builder generateUuidIfNeeded() {, +            if (uuid.equals("_na_")) {, +                uuid = Strings.randomBase64UUID();, +            }, +            return this;, +        }, +, +            return new MetaData(uuid, version, transientSettings, persistentSettings, indices.build(), templates.build(), customs.build());, +            builder.field("uuid", metaData.uuid);, +                    } else if ("uuid".equals(currentFieldName)) {, +                        builder.uuid = parser.text();, +            if (in.getVersion().after(Version.V_0_90_7)) {, +                builder.uuid = in.readString();, +            }, +            if (out.getVersion().after(Version.V_0_90_7)) {, +                out.writeString(metaData.uuid);, +            }, +++ b/src/main/java/org/elasticsearch/gateway/GatewayService.java, +                    // automatically generate a UID for the metadata if we need to, +                    metaDataBuilder.generateUuidIfNeeded();, +++ b/src/test/java/org/elasticsearch/gateway/local/SimpleRecoveryLocalGatewayTests.java, +        String metaDataUuid = client().admin().cluster().prepareState().execute().get().getState().getMetaData().uuid();, +        assertThat(metaDataUuid, not(equalTo("_na_")));, +, +        assertThat(client().admin().cluster().prepareState().execute().get().getState().getMetaData().uuid(), equalTo(metaDataUuid));, +]