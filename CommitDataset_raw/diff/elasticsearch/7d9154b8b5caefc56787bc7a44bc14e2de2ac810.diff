[+++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java, +            if (relocatingNodeId == null) {, +            }, +        // create a copy of the failed shard, since we assume we can change possible references to it without, +++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java, +            if (relocatingNodeId == null) {, +            }, +        // create a copy of the failed shard, since we assume we can change possible references to it without, +++ b/src/main/java/org/elasticsearch/index/gateway/IndexShardGatewayService.java, +                    // start the shard if the gateway has not started it already. Note that if the gateway, +                    // moved shard to POST_RECOVERY, it may have been started as well if:, +                    // 1) master sent a new cluster state indicating shard is initializing, +                    // 2) IndicesClusterStateService#applyInitializingShard will send a shard started event, +                    // 3) Master will mark shard as started and this will be processed locally., +                    IndexShardState shardState = indexShard.state();, +                    if (shardState != IndexShardState.POST_RECOVERY && shardState != IndexShardState.STARTED) {]