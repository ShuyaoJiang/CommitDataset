[+++ b/core/src/main/java/org/elasticsearch/search/query/TopDocsCollectorContext.java, +            boolean trackScores = searchContext.sort() == null ? true : searchContext.trackScores();, +                searchContext.sort(), numDocs, trackScores);, +++ b/core/src/main/java/org/elasticsearch/search/query/TopDocsCollectorContext.java, +            boolean trackScores = searchContext.sort() == null ? true : searchContext.trackScores();, +                searchContext.sort(), numDocs, trackScores);, +++ b/core/src/test/java/org/apache/lucene/grouping/CollapsingTopDocsCollectorTests.java, +import static org.hamcrest.core.IsEqual.equalTo;, +, +        assertSearchCollapse(dvProducers, numeric, true, true);, +        assertSearchCollapse(dvProducers, numeric, true, false);, +        assertSearchCollapse(dvProducers, numeric, false, true);, +        assertSearchCollapse(dvProducers, numeric, false, false);, +                                                             boolean numeric, boolean multivalued,, +                                                             boolean trackMaxScores) throws IOException {, +                CollapsingTopDocsCollector.createNumeric(collapseField.getField(), sort, expectedNumGroups, trackMaxScores);, +                CollapsingTopDocsCollector.createKeyword(collapseField.getField(), sort, expectedNumGroups, trackMaxScores);, +            TopFieldCollector.create(sort, totalHits, true, trackMaxScores, trackMaxScores);, +        if (trackMaxScores) {, +            assertThat(collapseTopFieldDocs.getMaxScore(), equalTo(topDocs.getMaxScore()));, +        } else {, +            assertThat(collapseTopFieldDocs.getMaxScore(), equalTo(Float.NaN));, +        }, +        final Weight weight = searcher.createNormalizedWeight(new MatchAllDocsQuery(), true);, +                c = CollapsingTopDocsCollector.createNumeric(collapseField.getField(), sort, expectedNumGroups, trackMaxScores);, +                c = CollapsingTopDocsCollector.createKeyword(collapseField.getField(), sort, expectedNumGroups, trackMaxScores);]