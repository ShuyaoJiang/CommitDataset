[+++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/test/java/org/elasticsearch/script/expression/ExpressionScriptTests.java, +                .addAggregation(, +                        AggregationBuilders.stats("int_agg").field("x"), +                                .script(new Script("_value * 3", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null))), +                .addAggregation(, +                        AggregationBuilders.stats("double_agg").field("y"), +                                .script(new Script("_value - 1.1", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null)));, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/test/java/org/elasticsearch/script/expression/ExpressionScriptTests.java, +                .addAggregation(, +                        AggregationBuilders.stats("int_agg").field("x"), +                                .script(new Script("_value * 3", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null))), +                .addAggregation(, +                        AggregationBuilders.stats("double_agg").field("y"), +                                .script(new Script("_value - 1.1", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null)));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/bucket/TopHitsTests.java, +        SearchResponse response = client(), +                .prepareSearch("idx"), +                .setTypes("field-collapsing"), +                .addAggregation(, +                        terms("terms").executionHint(randomExecutionHint()).field("group"), +                                .order(Terms.Order.aggregation("max_score", false)).subAggregation(topHits("hits").setSize(1)), +                                .subAggregation(max("max_score").script(new Script("_score.doubleValue()")))).get();, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/test/java/org/elasticsearch/script/expression/ExpressionScriptTests.java, +                .addAggregation(, +                        AggregationBuilders.stats("int_agg").field("x"), +                                .script(new Script("_value * 3", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null))), +                .addAggregation(, +                        AggregationBuilders.stats("double_agg").field("y"), +                                .script(new Script("_value - 1.1", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null)));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/bucket/TopHitsTests.java, +        SearchResponse response = client(), +                .prepareSearch("idx"), +                .setTypes("field-collapsing"), +                .addAggregation(, +                        terms("terms").executionHint(randomExecutionHint()).field("group"), +                                .order(Terms.Order.aggregation("max_score", false)).subAggregation(topHits("hits").setSize(1)), +                                .subAggregation(max("max_score").script(new Script("_score.doubleValue()")))).get();, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AbstractNumericTests.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/test/java/org/elasticsearch/script/expression/ExpressionScriptTests.java, +                .addAggregation(, +                        AggregationBuilders.stats("int_agg").field("x"), +                                .script(new Script("_value * 3", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null))), +                .addAggregation(, +                        AggregationBuilders.stats("double_agg").field("y"), +                                .script(new Script("_value - 1.1", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null)));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/bucket/TopHitsTests.java, +        SearchResponse response = client(), +                .prepareSearch("idx"), +                .setTypes("field-collapsing"), +                .addAggregation(, +                        terms("terms").executionHint(randomExecutionHint()).field("group"), +                                .order(Terms.Order.aggregation("max_score", false)).subAggregation(topHits("hits").setSize(1)), +                                .subAggregation(max("max_score").script(new Script("_score.doubleValue()")))).get();, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AbstractNumericTests.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AvgTests.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/test/java/org/elasticsearch/script/expression/ExpressionScriptTests.java, +                .addAggregation(, +                        AggregationBuilders.stats("int_agg").field("x"), +                                .script(new Script("_value * 3", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null))), +                .addAggregation(, +                        AggregationBuilders.stats("double_agg").field("y"), +                                .script(new Script("_value - 1.1", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null)));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/bucket/TopHitsTests.java, +        SearchResponse response = client(), +                .prepareSearch("idx"), +                .setTypes("field-collapsing"), +                .addAggregation(, +                        terms("terms").executionHint(randomExecutionHint()).field("group"), +                                .order(Terms.Order.aggregation("max_score", false)).subAggregation(topHits("hits").setSize(1)), +                                .subAggregation(max("max_score").script(new Script("_score.doubleValue()")))).get();, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AbstractNumericTests.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AvgTests.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/CardinalityTests.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java, +++ b/core/src/test/java/org/elasticsearch/script/expression/ExpressionScriptTests.java, +                .addAggregation(, +                        AggregationBuilders.stats("int_agg").field("x"), +                                .script(new Script("_value * 3", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null))), +                .addAggregation(, +                        AggregationBuilders.stats("double_agg").field("y"), +                                .script(new Script("_value - 1.1", ScriptType.INLINE, ExpressionScriptEngineService.NAME, null)));, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/bucket/TopHitsTests.java, +        SearchResponse response = client(), +                .prepareSearch("idx"), +                .setTypes("field-collapsing"), +                .addAggregation(, +                        terms("terms").executionHint(randomExecutionHint()).field("group"), +                                .order(Terms.Order.aggregation("max_score", false)).subAggregation(topHits("hits").setSize(1)), +                                .subAggregation(max("max_score").script(new Script("_score.doubleValue()")))).get();, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AbstractNumericTests.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/AvgTests.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/CardinalityTests.java, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/ExtendedStatsTests.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/ValuesSourceMetricsAggregationBuilder.java]