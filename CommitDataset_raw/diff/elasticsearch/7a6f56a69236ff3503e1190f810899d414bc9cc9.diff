[+++ b/core/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +import org.hamcrest.CoreMatchers;, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        Engine.IndexResult indexResult = engine.index(firstIndexRequest);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        Engine.IndexResult result = engine.index(idxRequest);, +        assertThat(result.getVersion(), equalTo(2L));, +            Engine.IndexResult index = engine.index(firstIndexRequest);, +            assertThat(index.getVersion(), equalTo(1L));, +            Engine.IndexResult indexResult = engine.index(firstIndexRequest);, +            assertThat(indexResult.getVersion(), equalTo(1L));, +        Engine.IndexResult index = engine.index(firstIndexRequest);, +        assertThat(index.getVersion(), equalTo(2L));, +        Engine.IndexResult indexResult = engine.index(index);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        index = new Engine.Index(newUid("1"), doc, indexResult.getVersion(), index.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +        indexResult = replicaEngine.index(index);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        indexResult = engine.index(index);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        index = new Engine.Index(newUid("1"), doc, indexResult.getVersion(), index.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +        indexResult = replicaEngine.index(index);, +        assertThat(indexResult.hasFailure(), equalTo(false));, +        Engine.IndexResult result = engine.index(firstIndexRequest);, +        assertThat(result.getVersion(), equalTo(1L));, +        Engine.Index firstIndexRequestReplica = new Engine.Index(newUid("1"), doc, result.getVersion(), firstIndexRequest.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +        Engine.IndexResult indexReplicaResult = replicaEngine.index(firstIndexRequestReplica);, +        assertThat(indexReplicaResult.getVersion(), equalTo(1L));, +        Engine.Index secondIndexRequestReplica = new Engine.Index(newUid("1"), doc, result.getVersion(), firstIndexRequest.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +++ b/core/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +import org.hamcrest.CoreMatchers;, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        Engine.IndexResult indexResult = engine.index(firstIndexRequest);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        Engine.IndexResult result = engine.index(idxRequest);, +        assertThat(result.getVersion(), equalTo(2L));, +            Engine.IndexResult index = engine.index(firstIndexRequest);, +            assertThat(index.getVersion(), equalTo(1L));, +            Engine.IndexResult indexResult = engine.index(firstIndexRequest);, +            assertThat(indexResult.getVersion(), equalTo(1L));, +        Engine.IndexResult index = engine.index(firstIndexRequest);, +        assertThat(index.getVersion(), equalTo(2L));, +        Engine.IndexResult indexResult = engine.index(index);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        index = new Engine.Index(newUid("1"), doc, indexResult.getVersion(), index.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +        indexResult = replicaEngine.index(index);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        indexResult = engine.index(index);, +        assertThat(indexResult.getVersion(), equalTo(1L));, +        index = new Engine.Index(newUid("1"), doc, indexResult.getVersion(), index.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +        indexResult = replicaEngine.index(index);, +        assertThat(indexResult.hasFailure(), equalTo(false));, +        Engine.IndexResult result = engine.index(firstIndexRequest);, +        assertThat(result.getVersion(), equalTo(1L));, +        Engine.Index firstIndexRequestReplica = new Engine.Index(newUid("1"), doc, result.getVersion(), firstIndexRequest.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +        Engine.IndexResult indexReplicaResult = replicaEngine.index(firstIndexRequestReplica);, +        assertThat(indexReplicaResult.getVersion(), equalTo(1L));, +        Engine.Index secondIndexRequestReplica = new Engine.Index(newUid("1"), doc, result.getVersion(), firstIndexRequest.versionType().versionTypeForReplicationAndRecovery(), REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry);, +++ b/core/src/test/java/org/elasticsearch/index/engine/ShadowEngineTests.java, +            Engine.IndexResult indexResult = primaryEngine.index(firstIndexRequest);, +            assertThat(indexResult.getVersion(), equalTo(1L));]