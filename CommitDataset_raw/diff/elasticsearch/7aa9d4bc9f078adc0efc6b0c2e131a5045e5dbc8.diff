[+++ b/src/main/java/org/elasticsearch/action/admin/indices/stats/IndicesStatsResponse.java, +import com.google.common.collect.ImmutableMap;, +    private ImmutableMap<String, CommonStats> shardStatsMap;, +, +        this.shardStatsMap = buildShardsStatsMap();, +    }, +, +    private ImmutableMap<String, CommonStats> buildShardsStatsMap() {, +        ImmutableMap.Builder<String, CommonStats> mb = ImmutableMap.builder();, +, +        for (ShardStats ss : shards) {, +             mb.put(ss.getShardRouting().globalId(), ss.getStats());, +        }, +, +        return mb.build();, +    }, +, +    public ImmutableMap<String, CommonStats> asMap() {, +        return this.shardStatsMap;, +++ b/src/main/java/org/elasticsearch/action/admin/indices/stats/IndicesStatsResponse.java, +import com.google.common.collect.ImmutableMap;, +    private ImmutableMap<String, CommonStats> shardStatsMap;, +, +        this.shardStatsMap = buildShardsStatsMap();, +    }, +, +    private ImmutableMap<String, CommonStats> buildShardsStatsMap() {, +        ImmutableMap.Builder<String, CommonStats> mb = ImmutableMap.builder();, +, +        for (ShardStats ss : shards) {, +             mb.put(ss.getShardRouting().globalId(), ss.getStats());, +        }, +, +        return mb.build();, +    }, +, +    public ImmutableMap<String, CommonStats> asMap() {, +        return this.shardStatsMap;, +++ b/src/main/java/org/elasticsearch/cluster/routing/ImmutableShardRouting.java, +    public String globalId() {, +        String pri = "r";, +        if (this.primary()) {, +            pri = "p";, +        }, +, +        String node = "unassigned";, +        if (null != this.currentNodeId()) {, +            node = this.currentNodeId();, +        }, +, +        StringBuilder sb = new StringBuilder();, +        sb.append(getIndex());, +        sb.append("/");, +        sb.append(this.shardId().id());, +        sb.append("/");, +        sb.append(pri);, +        sb.append("/");, +        sb.append(node);, +        return sb.toString();, +    }, +, +    @Override, +++ b/src/main/java/org/elasticsearch/action/admin/indices/stats/IndicesStatsResponse.java, +import com.google.common.collect.ImmutableMap;, +    private ImmutableMap<String, CommonStats> shardStatsMap;, +, +        this.shardStatsMap = buildShardsStatsMap();, +    }, +, +    private ImmutableMap<String, CommonStats> buildShardsStatsMap() {, +        ImmutableMap.Builder<String, CommonStats> mb = ImmutableMap.builder();, +, +        for (ShardStats ss : shards) {, +             mb.put(ss.getShardRouting().globalId(), ss.getStats());, +        }, +, +        return mb.build();, +    }, +, +    public ImmutableMap<String, CommonStats> asMap() {, +        return this.shardStatsMap;, +++ b/src/main/java/org/elasticsearch/cluster/routing/ImmutableShardRouting.java, +    public String globalId() {, +        String pri = "r";, +        if (this.primary()) {, +            pri = "p";, +        }, +, +        String node = "unassigned";, +        if (null != this.currentNodeId()) {, +            node = this.currentNodeId();, +        }, +, +        StringBuilder sb = new StringBuilder();, +        sb.append(getIndex());, +        sb.append("/");, +        sb.append(this.shardId().id());, +        sb.append("/");, +        sb.append(pri);, +        sb.append("/");]