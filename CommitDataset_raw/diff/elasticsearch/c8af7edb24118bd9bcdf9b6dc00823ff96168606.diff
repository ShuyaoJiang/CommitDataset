[+++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        factoriesBuilder = new AggregatorFactories.Builder(in);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        factoriesBuilder = new AggregatorFactories.Builder(in);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java, +        /**, +         * Create an empty builder., +         */, +        public Builder() {, +        }, +, +        /**, +         * Read from a stream., +         */, +        public Builder(StreamInput in) throws IOException {, +            int factoriesSize = in.readVInt();, +            for (int i = 0; i < factoriesSize; i++) {, +                addAggregator(in.readNamedWriteable(AggregatorBuilder.class));, +            }, +            int pipelineFactoriesSize = in.readVInt();, +            for (int i = 0; i < pipelineFactoriesSize; i++) {, +                addPipelineAggregator(in.readNamedWriteable(PipelineAggregatorBuilder.class));, +            }, +        }, +, +        @Override, +        public void writeTo(StreamOutput out) throws IOException {, +            out.writeVInt(this.aggregatorBuilders.size());, +            for (AggregatorBuilder<?> factory : aggregatorBuilders) {, +                out.writeNamedWriteable(factory);, +            }, +            out.writeVInt(this.pipelineAggregatorBuilders.size());, +            for (PipelineAggregatorBuilder<?> factory : pipelineAggregatorBuilders) {, +                out.writeNamedWriteable(factory);, +            }, +        }, +, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        factoriesBuilder = new AggregatorFactories.Builder(in);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java, +        /**, +         * Create an empty builder., +         */, +        public Builder() {, +        }, +, +        /**, +         * Read from a stream., +         */, +        public Builder(StreamInput in) throws IOException {, +            int factoriesSize = in.readVInt();, +            for (int i = 0; i < factoriesSize; i++) {, +                addAggregator(in.readNamedWriteable(AggregatorBuilder.class));, +            }, +            int pipelineFactoriesSize = in.readVInt();, +            for (int i = 0; i < pipelineFactoriesSize; i++) {, +                addPipelineAggregator(in.readNamedWriteable(PipelineAggregatorBuilder.class));, +            }, +        }, +, +        @Override, +        public void writeTo(StreamOutput out) throws IOException {, +            out.writeVInt(this.aggregatorBuilders.size());, +            for (AggregatorBuilder<?> factory : aggregatorBuilders) {, +                out.writeNamedWriteable(factory);, +            }, +            out.writeVInt(this.pipelineAggregatorBuilders.size());, +            for (PipelineAggregatorBuilder<?> factory : pipelineAggregatorBuilders) {, +                out.writeNamedWriteable(factory);, +            }, +        }, +, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +            aggregations = new AggregatorFactories.Builder(in);]