[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/query/QueryFacetCollector.java, +import org.apache.lucene.search.*;, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +        Filter possibleFilter = extractFilterIfApplicable(query);, +        if (possibleFilter != null) {, +            this.filter = filterCache.cache(possibleFilter);, +        } else {, +    }, +, +    /**, +     * If its a filtered query with a match all, then we just need the inner filter., +     */, +    private Filter extractFilterIfApplicable(Query query) {, +        if (query instanceof FilteredQuery) {, +            FilteredQuery fQuery = (FilteredQuery) query;, +            if (fQuery.getQuery() instanceof MatchAllDocsQuery) {, +                return fQuery.getFilter();, +            }, +            if (fQuery.getQuery() instanceof DeletionAwareConstantScoreQuery) {, +                DeletionAwareConstantScoreQuery scoreQuery = (DeletionAwareConstantScoreQuery) fQuery.getQuery();, +                if (scoreQuery.getFilter() instanceof MatchAllDocsFilter) {, +                    return fQuery.getFilter();, +                }, +            }, +        }, +        return null;, +    }]