[+++ b/x-pack/plugin/sql/qa/src/main/resources/agg-ordering.sql-spec, +, +multipleGroupingsAndOrderingByGroups_1, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_2, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender DESC, first_name DESC, last_name ASC;, +, +multipleGroupingsAndOrderingByGroups_3, +SELECT gender AS g, first_name AS f, last_name AS l FROM test_emp GROUP BY f, g, l ORDER BY l, g, f;, +, +multipleGroupingsAndOrderingByGroups_4, +SELECT gender AS g, first_name, last_name FROM test_emp GROUP BY g, last_name, first_name ORDER BY gender, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_5, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender DESC, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_6, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender, first_name DESC, last_name;, +, +multipleGroupingsAndOrderingByGroups_7, +SELECT gender AS g, first_name AS f, last_name AS l FROM test_emp GROUP BY f, gender, l ORDER BY l, g DESC, f DESC;, +, +multipleGroupingsAndOrderingByGroups_8, +SELECT gender AS g, first_name, last_name FROM test_emp GROUP BY g, last_name, first_name ORDER BY gender ASC, first_name DESC, last_name ASC;, +, +multipleGroupingsAndOrderingByGroupsWithFunctions_1, +SELECT first_name f, last_name l, gender g, CONCAT(UCASE(first_name), LCASE(last_name)) c FROM test_emp GROUP BY gender, l, f, c ORDER BY c DESC, first_name, l ASC, g;, +, +multipleGroupingsAndOrderingByGroupsWithFunctions_2, +SELECT first_name f, last_name l, gender g, CONCAT(first_name, last_name) c FROM test_emp GROUP BY gender, l, f, c ORDER BY gender, c DESC, first_name, last_name ASC;, +, +multipleGroupingsAndOrderingByGroupsWithFunctions_3, +SELECT first_name f, last_name l, LCASE(gender) g, CONCAT(UCASE(first_name), LCASE(last_name)) c FROM test_emp GROUP BY f, LCASE(gender), l, c ORDER BY c DESC, first_name, l ASC, g;, +++ b/x-pack/plugin/sql/qa/src/main/resources/agg-ordering.sql-spec, +, +multipleGroupingsAndOrderingByGroups_1, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_2, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender DESC, first_name DESC, last_name ASC;, +, +multipleGroupingsAndOrderingByGroups_3, +SELECT gender AS g, first_name AS f, last_name AS l FROM test_emp GROUP BY f, g, l ORDER BY l, g, f;, +, +multipleGroupingsAndOrderingByGroups_4, +SELECT gender AS g, first_name, last_name FROM test_emp GROUP BY g, last_name, first_name ORDER BY gender, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_5, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender DESC, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_6, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender, first_name DESC, last_name;, +, +multipleGroupingsAndOrderingByGroups_7, +SELECT gender AS g, first_name AS f, last_name AS l FROM test_emp GROUP BY f, gender, l ORDER BY l, g DESC, f DESC;, +, +multipleGroupingsAndOrderingByGroups_8, +SELECT gender AS g, first_name, last_name FROM test_emp GROUP BY g, last_name, first_name ORDER BY gender ASC, first_name DESC, last_name ASC;, +, +multipleGroupingsAndOrderingByGroupsWithFunctions_1, +SELECT first_name f, last_name l, gender g, CONCAT(UCASE(first_name), LCASE(last_name)) c FROM test_emp GROUP BY gender, l, f, c ORDER BY c DESC, first_name, l ASC, g;, +, +multipleGroupingsAndOrderingByGroupsWithFunctions_2, +SELECT first_name f, last_name l, gender g, CONCAT(first_name, last_name) c FROM test_emp GROUP BY gender, l, f, c ORDER BY gender, c DESC, first_name, last_name ASC;, +, +multipleGroupingsAndOrderingByGroupsWithFunctions_3, +SELECT first_name f, last_name l, LCASE(gender) g, CONCAT(UCASE(first_name), LCASE(last_name)) c FROM test_emp GROUP BY f, LCASE(gender), l, c ORDER BY c DESC, first_name, l ASC, g;, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/optimizer/Optimizer.java, +import static org.elasticsearch.xpack.sql.expression.Expressions.equalsAsAttribute;, +                        Holder<Boolean> isMatching = new Holder<>(Boolean.FALSE);, +                        if (equalsAsAttribute(fieldToOrder, group)) {, +                            isMatching.set(Boolean.TRUE);, +                        } else {, +                            a.aggregates().forEach(alias -> {, +                                if (alias instanceof Alias) {, +                                    Expression child = ((Alias) alias).child();, +                                    // Check if the groupings (a, y) match the orderings (b, x) through the aggregates' aliases (x, y), +                                    // e.g. SELECT a AS x, b AS y ... GROUP BY a, y ORDER BY b, x, +                                    if ((equalsAsAttribute(child, group), +                                            && (equalsAsAttribute(alias, fieldToOrder) || equalsAsAttribute(child, fieldToOrder))) , +                                        || (equalsAsAttribute(alias, group), +                                                && (equalsAsAttribute(alias, fieldToOrder) || equalsAsAttribute(child, fieldToOrder)))) {, +                                        isMatching.set(Boolean.TRUE);, +                                    }, +                                }, +                            });, +                        }, +                        , +                        if (isMatching.get() == true) {, +++ b/x-pack/plugin/sql/qa/src/main/resources/agg-ordering.sql-spec, +, +multipleGroupingsAndOrderingByGroups_1, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender, first_name, last_name;, +, +multipleGroupingsAndOrderingByGroups_2, +SELECT gender AS g, first_name, last_name AS l FROM test_emp GROUP BY first_name, g, last_name ORDER BY gender DESC, first_name DESC, last_name ASC;, +, +multipleGroupingsAndOrderingByGroups_3, +SELECT gender AS g, first_name AS f, last_name AS l FROM test_emp GROUP BY f, g, l ORDER BY l, g, f;]