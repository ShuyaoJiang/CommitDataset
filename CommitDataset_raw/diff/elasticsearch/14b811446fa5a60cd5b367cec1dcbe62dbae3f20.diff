[+++ b/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java, +import org.elasticsearch.common.joda.Joda;, +                config.format(resolveFormat(null, valueType, timeZone));, +            config.format(resolveFormat(format, valueType, timeZone));, +            config.format(resolveFormat(format, valueType, timeZone));, +    private static DocValueFormat resolveFormat(@Nullable String format, @Nullable ValueType valueType, @Nullable DateTimeZone tz) {, +        if (valueFormat instanceof DocValueFormat.DateTime && format != null) {, +            valueFormat = new DocValueFormat.DateTime(Joda.forPattern(format), tz != null ? tz : DateTimeZone.UTC);, +        }, +++ b/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java, +import org.elasticsearch.common.joda.Joda;, +                config.format(resolveFormat(null, valueType, timeZone));, +            config.format(resolveFormat(format, valueType, timeZone));, +            config.format(resolveFormat(format, valueType, timeZone));, +    private static DocValueFormat resolveFormat(@Nullable String format, @Nullable ValueType valueType, @Nullable DateTimeZone tz) {, +        if (valueFormat instanceof DocValueFormat.DateTime && format != null) {, +            valueFormat = new DocValueFormat.DateTime(Joda.forPattern(format), tz != null ? tz : DateTimeZone.UTC);, +        }, +++ b/server/src/test/java/org/elasticsearch/search/aggregations/bucket/DateHistogramIT.java, +     * https://github.com/elastic/elasticsearch/issues/31760 shows an edge case where an unmapped "date" field in two indices, +     * that are queried simultaneously can lead to the "format" parameter in the aggregation not being preserved correctly., +     *, +     * The error happens when the bucket from the "unmapped" index is received first in the reduce phase, however the case can, +     * be recreated when aggregating about a single index with an unmapped date field and also getting "empty" buckets., +     */, +    public void testFormatIndexUnmapped() throws InterruptedException, ExecutionException {, +        String indexDateUnmapped = "test31760";, +        indexRandom(true, client().prepareIndex(indexDateUnmapped, "_doc").setSource("foo", "bar"));, +        ensureSearchable(indexDateUnmapped);, +, +        SearchResponse response = client().prepareSearch(indexDateUnmapped), +                .addAggregation(, +                        dateHistogram("histo").field("dateField").dateHistogramInterval(DateHistogramInterval.MONTH).format("YYYY-MM"), +                                .minDocCount(0).extendedBounds(new ExtendedBounds("2018-01", "2018-01"))), +                .execute().actionGet();, +        assertSearchResponse(response);, +        Histogram histo = response.getAggregations().get("histo");, +        assertThat(histo.getBuckets().size(), equalTo(1));, +        assertThat(histo.getBuckets().get(0).getKeyAsString(), equalTo("2018-01"));, +        assertThat(histo.getBuckets().get(0).getDocCount(), equalTo(0L));, +        internalCluster().wipeIndices(indexDateUnmapped);, +    }, +, +    /**]