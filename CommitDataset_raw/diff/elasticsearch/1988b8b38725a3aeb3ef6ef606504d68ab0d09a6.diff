[+++ b/plugins/analysis-kuromoji/src/test/java/org/elasticsearch/index/analysis/KuromojiAnalysisTests.java, +    private static AnalysisService createAnalysisService() throws IOException {, +        InputStream empty_dict = KuromojiAnalysisTests.class.getResourceAsStream("empty_user_dict.txt");, +        InputStream dict = KuromojiAnalysisTests.class.getResourceAsStream("user_dict.txt");, +, +            .loadFromStream(json, KuromojiAnalysisTests.class.getResourceAsStream(json)), +        Settings nodeSettings = Settings.builder().put(Environment.PATH_HOME_SETTING.getKey(), home).build();, +        return createAnalysisService(new Index("test", "_na_"), nodeSettings, settings, new AnalysisKuromojiPlugin()::onModule);, +++ b/plugins/analysis-kuromoji/src/test/java/org/elasticsearch/index/analysis/KuromojiAnalysisTests.java, +    private static AnalysisService createAnalysisService() throws IOException {, +        InputStream empty_dict = KuromojiAnalysisTests.class.getResourceAsStream("empty_user_dict.txt");, +        InputStream dict = KuromojiAnalysisTests.class.getResourceAsStream("user_dict.txt");, +, +            .loadFromStream(json, KuromojiAnalysisTests.class.getResourceAsStream(json)), +        Settings nodeSettings = Settings.builder().put(Environment.PATH_HOME_SETTING.getKey(), home).build();, +        return createAnalysisService(new Index("test", "_na_"), nodeSettings, settings, new AnalysisKuromojiPlugin()::onModule);, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESTestCase.java, +        Settings nodeSettings = Settings.builder().put(Environment.PATH_HOME_SETTING.getKey(), createTempDir()).build();, +        return createAnalysisService(index, nodeSettings, settings, moduleConsumers);, +    }, +, +    /**, +     * Creates an AnalysisService to test analysis factories and analyzers., +     */, +    @SafeVarargs, +    public static AnalysisService createAnalysisService(Index index, Settings nodeSettings, Settings settings, Consumer<AnalysisModule>... moduleConsumers) throws IOException {]