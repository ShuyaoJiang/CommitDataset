[+++ b/server/src/main/java/org/elasticsearch/action/fieldcaps/TransportFieldCapabilitiesAction.java, +        if (localIndices == null) {, +            // in the case we have one or more remote indices but no local we don't expand to all local indices and just do remote indices, +++ b/server/src/main/java/org/elasticsearch/action/fieldcaps/TransportFieldCapabilitiesAction.java, +        if (localIndices == null) {, +            // in the case we have one or more remote indices but no local we don't expand to all local indices and just do remote indices, +++ b/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java, +import org.elasticsearch.action.support.IndicesOptions;, +                executeSearch((SearchTask)task, timeProvider, searchRequest, localIndices, Collections.emptyList(),, +                        executeSearch((SearchTask) task, timeProvider, searchRequest, localIndices,, +        int localClusters = localIndices == null ? 0 : 1;, +    private Index[] resolveLocalIndices(OriginalIndices localIndices,, +                                IndicesOptions indicesOptions,, +                                ClusterState clusterState,, +                                SearchTimeProvider timeProvider) {, +        if (localIndices == null) {, +            return Index.EMPTY_ARRAY; //don't search on any local index (happens when only remote indices were specified), +        }, +        return indexNameExpressionResolver.concreteIndices(clusterState, indicesOptions,, +            timeProvider.getAbsoluteStartMillis(), localIndices.indices());, +    }, +, +    private void executeSearch(SearchTask task, SearchTimeProvider timeProvider, SearchRequest searchRequest,, +                               OriginalIndices localIndices, List<SearchShardIterator> remoteShardIterators,, +        final Index[] indices = resolveLocalIndices(localIndices, searchRequest.indicesOptions(), clusterState, timeProvider);, +++ b/server/src/main/java/org/elasticsearch/action/fieldcaps/TransportFieldCapabilitiesAction.java, +        if (localIndices == null) {, +            // in the case we have one or more remote indices but no local we don't expand to all local indices and just do remote indices, +++ b/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java, +import org.elasticsearch.action.support.IndicesOptions;, +                executeSearch((SearchTask)task, timeProvider, searchRequest, localIndices, Collections.emptyList(),, +                        executeSearch((SearchTask) task, timeProvider, searchRequest, localIndices,, +        int localClusters = localIndices == null ? 0 : 1;, +    private Index[] resolveLocalIndices(OriginalIndices localIndices,, +                                IndicesOptions indicesOptions,, +                                ClusterState clusterState,, +                                SearchTimeProvider timeProvider) {, +        if (localIndices == null) {, +            return Index.EMPTY_ARRAY; //don't search on any local index (happens when only remote indices were specified), +        }, +        return indexNameExpressionResolver.concreteIndices(clusterState, indicesOptions,, +            timeProvider.getAbsoluteStartMillis(), localIndices.indices());, +    }, +, +    private void executeSearch(SearchTask task, SearchTimeProvider timeProvider, SearchRequest searchRequest,, +                               OriginalIndices localIndices, List<SearchShardIterator> remoteShardIterators,, +        final Index[] indices = resolveLocalIndices(localIndices, searchRequest.indicesOptions(), clusterState, timeProvider);, +++ b/server/src/main/java/org/elasticsearch/transport/RemoteClusterService.java, +            if (groupedIndices.isEmpty()) {, +                //search on _all in the local cluster if neither local indices nor remote indices were specified, +                originalIndicesMap.put(LOCAL_CLUSTER_GROUP_KEY, new OriginalIndices(Strings.EMPTY_ARRAY, indicesOptions));, +            } else {, +++ b/server/src/main/java/org/elasticsearch/action/fieldcaps/TransportFieldCapabilitiesAction.java, +        if (localIndices == null) {, +            // in the case we have one or more remote indices but no local we don't expand to all local indices and just do remote indices, +++ b/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java, +import org.elasticsearch.action.support.IndicesOptions;, +                executeSearch((SearchTask)task, timeProvider, searchRequest, localIndices, Collections.emptyList(),, +                        executeSearch((SearchTask) task, timeProvider, searchRequest, localIndices,, +        int localClusters = localIndices == null ? 0 : 1;, +    private Index[] resolveLocalIndices(OriginalIndices localIndices,, +                                IndicesOptions indicesOptions,, +                                ClusterState clusterState,, +                                SearchTimeProvider timeProvider) {, +        if (localIndices == null) {, +            return Index.EMPTY_ARRAY; //don't search on any local index (happens when only remote indices were specified), +        }, +        return indexNameExpressionResolver.concreteIndices(clusterState, indicesOptions,, +            timeProvider.getAbsoluteStartMillis(), localIndices.indices());, +    }, +, +    private void executeSearch(SearchTask task, SearchTimeProvider timeProvider, SearchRequest searchRequest,, +                               OriginalIndices localIndices, List<SearchShardIterator> remoteShardIterators,, +        final Index[] indices = resolveLocalIndices(localIndices, searchRequest.indicesOptions(), clusterState, timeProvider);, +++ b/server/src/main/java/org/elasticsearch/transport/RemoteClusterService.java, +            if (groupedIndices.isEmpty()) {, +                //search on _all in the local cluster if neither local indices nor remote indices were specified, +                originalIndicesMap.put(LOCAL_CLUSTER_GROUP_KEY, new OriginalIndices(Strings.EMPTY_ARRAY, indicesOptions));, +            } else {, +++ b/server/src/test/java/org/elasticsearch/action/search/TransportSearchActionTests.java, +    public void testMergeShardsIterators() {, +    public void testProcessRemoteShards() {, +        OriginalIndices localIndices = randomBoolean() ? null : randomOriginalIndices();, +        int localClusters = localIndices == null ? 0 : 1;, +++ b/server/src/main/java/org/elasticsearch/action/fieldcaps/TransportFieldCapabilitiesAction.java, +        if (localIndices == null) {, +            // in the case we have one or more remote indices but no local we don't expand to all local indices and just do remote indices, +++ b/server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java, +import org.elasticsearch.action.support.IndicesOptions;, +                executeSearch((SearchTask)task, timeProvider, searchRequest, localIndices, Collections.emptyList(),, +                        executeSearch((SearchTask) task, timeProvider, searchRequest, localIndices,, +        int localClusters = localIndices == null ? 0 : 1;, +    private Index[] resolveLocalIndices(OriginalIndices localIndices,, +                                IndicesOptions indicesOptions,, +                                ClusterState clusterState,, +                                SearchTimeProvider timeProvider) {, +        if (localIndices == null) {, +            return Index.EMPTY_ARRAY; //don't search on any local index (happens when only remote indices were specified), +        }, +        return indexNameExpressionResolver.concreteIndices(clusterState, indicesOptions,]