[+++ b/src/test/java/org/elasticsearch/indices/stats/IndexStatsTests.java, +        // index docs until we have at least one doc on each shard, otherwise, our tests will not work, +        // since refresh will not refresh anything on a shard that has 0 docs and its search response get cached, +        int pageDocs = randomIntBetween(2, 100);, +        int numDocs = 0;, +        int counter = 0;, +        while (true) {, +            IndexRequestBuilder[] builders = new IndexRequestBuilder[pageDocs];, +            for (int i = 0; i < pageDocs; ++i) {, +                builders[i] = client().prepareIndex("idx", "type", Integer.toString(counter++)).setSource(jsonBuilder(), +            numDocs += pageDocs;, +, +            boolean allHaveDocs = true;, +            for (ShardStats stats : client().admin().indices().prepareStats("idx").setDocs(true).get().getShards()) {, +                if (stats.getStats().getDocs().getCount() == 0) {, +                    allHaveDocs = false;, +                    break;, +                }, +            }, +, +            if (allHaveDocs) {, +                break;, +            }, +        }, +        IndexRequestBuilder[] builders = new IndexRequestBuilder[numDocs];]