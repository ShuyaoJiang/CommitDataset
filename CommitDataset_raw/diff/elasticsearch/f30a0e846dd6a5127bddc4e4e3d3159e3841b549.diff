[+++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterAggregator.java, +            bits = DocIdSets.toSafeBits(reader.reader(), filter.getDocIdSet(reader, null));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterAggregator.java, +            bits = DocIdSets.toSafeBits(reader.reader(), filter.getDocIdSet(reader, null));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filters/FiltersAggregator.java, +                bits[i] = DocIdSets.toSafeBits(reader.reader(), filters[i].filter.getDocIdSet(reader, null));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterAggregator.java, +            bits = DocIdSets.toSafeBits(reader.reader(), filter.getDocIdSet(reader, null));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filters/FiltersAggregator.java, +                bits[i] = DocIdSets.toSafeBits(reader.reader(), filters[i].filter.getDocIdSet(reader, null));, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/FilterTests.java, +            IndexRequestBuilder req = client().prepareIndex("idx", "type", ""+i).setSource(jsonBuilder(), +                    .endObject());, +            builders.add(req);, +            if (randomBoolean()) {, +                // randomly index the document twice so that we have deleted docs that match the filter, +                builders.add(req);, +            }, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterAggregator.java, +            bits = DocIdSets.toSafeBits(reader.reader(), filter.getDocIdSet(reader, null));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filters/FiltersAggregator.java, +                bits[i] = DocIdSets.toSafeBits(reader.reader(), filters[i].filter.getDocIdSet(reader, null));, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/FilterTests.java, +            IndexRequestBuilder req = client().prepareIndex("idx", "type", ""+i).setSource(jsonBuilder(), +                    .endObject());, +            builders.add(req);, +            if (randomBoolean()) {, +                // randomly index the document twice so that we have deleted docs that match the filter, +                builders.add(req);, +            }, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/FiltersTests.java, +            IndexRequestBuilder req = client().prepareIndex("idx", "type", ""+i).setSource(jsonBuilder(), +                    .endObject());, +            builders.add(req);, +            if (randomBoolean()) {, +                // randomly index the document twice so that we have deleted docs that match the filter, +                builders.add(req);, +            }, +            IndexRequestBuilder req = client().prepareIndex("idx", "type", ""+i).setSource(jsonBuilder(), +                    .endObject());, +            builders.add(req);, +            if (randomBoolean()) {, +                builders.add(req);, +            }]