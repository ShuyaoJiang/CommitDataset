[+++ b/core/src/main/java/org/elasticsearch/common/transport/DummyTransportAddress.java, +++ b/core/src/main/java/org/elasticsearch/common/transport/DummyTransportAddress.java, +++ b/core/src/main/java/org/elasticsearch/common/transport/InetSocketTransportAddress.java, +    public static final short TYPE_ID = 1;, +    /**, +     * Read from a stream., +     */, +    public InetSocketTransportAddress(StreamInput in) throws IOException {, +        final int len = in.readByte();, +        final byte[] a = new byte[len]; // 4 bytes (IPv4) or 16 bytes (IPv6), +        in.readFully(a);, +        InetAddress inetAddress = InetAddress.getByAddress(a);, +        int port = in.readInt();, +        this.address = new InetSocketAddress(inetAddress, port);, +    }, +, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        byte[] bytes = address().getAddress().getAddress();  // 4 bytes (IPv4) or 16 bytes (IPv6), +        out.writeByte((byte) bytes.length); // 1 byte, +        out.write(bytes, 0, bytes.length);, +        // don't serialize scope ids over the network!!!!, +        // these only make sense with respect to the local machine, and will only formulate, +        // the address incorrectly remotely., +        out.writeInt(address.getPort());, +    }, +, +        return TYPE_ID;, +++ b/core/src/main/java/org/elasticsearch/common/transport/DummyTransportAddress.java, +++ b/core/src/main/java/org/elasticsearch/common/transport/InetSocketTransportAddress.java, +    public static final short TYPE_ID = 1;, +    /**, +     * Read from a stream., +     */, +    public InetSocketTransportAddress(StreamInput in) throws IOException {, +        final int len = in.readByte();, +        final byte[] a = new byte[len]; // 4 bytes (IPv4) or 16 bytes (IPv6), +        in.readFully(a);, +        InetAddress inetAddress = InetAddress.getByAddress(a);, +        int port = in.readInt();, +        this.address = new InetSocketAddress(inetAddress, port);, +    }, +, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        byte[] bytes = address().getAddress().getAddress();  // 4 bytes (IPv4) or 16 bytes (IPv6), +        out.writeByte((byte) bytes.length); // 1 byte, +        out.write(bytes, 0, bytes.length);, +        // don't serialize scope ids over the network!!!!, +        // these only make sense with respect to the local machine, and will only formulate, +        // the address incorrectly remotely., +        out.writeInt(address.getPort());, +    }, +, +        return TYPE_ID;, +++ b/core/src/main/java/org/elasticsearch/common/transport/LocalTransportAddress.java, +    public static final short TYPE_ID = 2;, +    public LocalTransportAddress(String id) {, +        this.id = id;, +    }, +, +    /**, +     * Read from a stream., +     */, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        out.writeString(id);, +        return TYPE_ID;, +++ b/core/src/main/java/org/elasticsearch/common/transport/DummyTransportAddress.java, +++ b/core/src/main/java/org/elasticsearch/common/transport/InetSocketTransportAddress.java, +    public static final short TYPE_ID = 1;, +    /**, +     * Read from a stream., +     */, +    public InetSocketTransportAddress(StreamInput in) throws IOException {, +        final int len = in.readByte();, +        final byte[] a = new byte[len]; // 4 bytes (IPv4) or 16 bytes (IPv6), +        in.readFully(a);, +        InetAddress inetAddress = InetAddress.getByAddress(a);, +        int port = in.readInt();, +        this.address = new InetSocketAddress(inetAddress, port);, +    }, +, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        byte[] bytes = address().getAddress().getAddress();  // 4 bytes (IPv4) or 16 bytes (IPv6), +        out.writeByte((byte) bytes.length); // 1 byte, +        out.write(bytes, 0, bytes.length);, +        // don't serialize scope ids over the network!!!!, +        // these only make sense with respect to the local machine, and will only formulate, +        // the address incorrectly remotely., +        out.writeInt(address.getPort());, +    }, +, +        return TYPE_ID;, +++ b/core/src/main/java/org/elasticsearch/common/transport/LocalTransportAddress.java, +    public static final short TYPE_ID = 2;, +    public LocalTransportAddress(String id) {, +        this.id = id;, +    }]