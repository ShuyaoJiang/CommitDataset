[+++ b/core/src/main/java/org/elasticsearch/indices/memory/IndexingMemoryController.java, +import java.util.*;, +                    if (status.translogId == translog.currentFileGeneration() && translog.totalOperations() == status.translogNumberOfOperations) {, +                    status.translogNumberOfOperations = translog.totalOperations();, +        long translogNumberOfOperations = -1;, +++ b/core/src/main/java/org/elasticsearch/indices/memory/IndexingMemoryController.java, +import java.util.*;, +                    if (status.translogId == translog.currentFileGeneration() && translog.totalOperations() == status.translogNumberOfOperations) {, +                    status.translogNumberOfOperations = translog.totalOperations();, +        long translogNumberOfOperations = -1;, +++ b/core/src/test/java/org/elasticsearch/indices/memory/IndexingMemoryControllerIT.java, +import java.util.concurrent.ExecutionException;, +, +    public void testIndexBufferSizeUpdateInactiveShard() throws InterruptedException, ExecutionException {, +, +        if (randomBoolean()) {, +            logger.info("--> indexing some pending operations");, +            indexRandom(false, client().prepareIndex("test1", "type", "0").setSource("f", "0"));, +        }, +, +            fail("failed to update shard indexing buffer size due to active state. expected something larger then [" + EngineConfig.INACTIVE_SHARD_INDEXING_BUFFER + "] got [" +, +        if (randomBoolean()) {, +            logger.info("--> flushing translogs");, +        }]