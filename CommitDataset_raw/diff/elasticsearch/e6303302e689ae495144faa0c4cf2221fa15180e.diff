[+++ b/core/src/main/java/org/elasticsearch/index/similarity/SimilarityLookupService.java, +import java.util.HashMap;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +, +    private final Map<String, SimilarityProvider> similarities;, +        this(index, indexSettings, emptyMap());, +        Map<String, SimilarityProvider> providers = new HashMap<>();, +        this.similarities = unmodifiableMap(providers);, +++ b/core/src/main/java/org/elasticsearch/index/similarity/SimilarityLookupService.java, +import java.util.HashMap;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +, +    private final Map<String, SimilarityProvider> similarities;, +        this(index, indexSettings, emptyMap());, +        Map<String, SimilarityProvider> providers = new HashMap<>();, +        this.similarities = unmodifiableMap(providers);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregationStreams.java, +import org.elasticsearch.common.collect.CopyOnWriteHashMap;, +import java.util.Map;, +    private static Map<BytesReference, Stream> streams = new CopyOnWriteHashMap<>();, +            streams.put(type, stream);, +++ b/core/src/main/java/org/elasticsearch/index/similarity/SimilarityLookupService.java, +import java.util.HashMap;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +, +    private final Map<String, SimilarityProvider> similarities;, +        this(index, indexSettings, emptyMap());, +        Map<String, SimilarityProvider> providers = new HashMap<>();, +        this.similarities = unmodifiableMap(providers);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregationStreams.java, +import org.elasticsearch.common.collect.CopyOnWriteHashMap;, +import java.util.Map;, +    private static Map<BytesReference, Stream> streams = new CopyOnWriteHashMap<>();, +            streams.put(type, stream);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +    private Map<String, Aggregation> aggregationsAsMap;, +            Map<String, InternalAggregation> newAggregationsAsMap = new HashMap<>();, +                newAggregationsAsMap.put(aggregation.getName(), aggregation);, +            this.aggregationsAsMap = unmodifiableMap(newAggregationsAsMap);, +        return aggregationsAsMap;, +            aggregationsAsMap = emptyMap();, +++ b/core/src/main/java/org/elasticsearch/index/similarity/SimilarityLookupService.java, +import java.util.HashMap;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +, +    private final Map<String, SimilarityProvider> similarities;, +        this(index, indexSettings, emptyMap());, +        Map<String, SimilarityProvider> providers = new HashMap<>();, +        this.similarities = unmodifiableMap(providers);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregationStreams.java, +import org.elasticsearch.common.collect.CopyOnWriteHashMap;, +import java.util.Map;, +    private static Map<BytesReference, Stream> streams = new CopyOnWriteHashMap<>();, +            streams.put(type, stream);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +    private Map<String, Aggregation> aggregationsAsMap;, +            Map<String, InternalAggregation> newAggregationsAsMap = new HashMap<>();, +                newAggregationsAsMap.put(aggregation.getName(), aggregation);, +            this.aggregationsAsMap = unmodifiableMap(newAggregationsAsMap);, +        return aggregationsAsMap;, +            aggregationsAsMap = emptyMap();, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketStreams.java, +import org.elasticsearch.common.collect.CopyOnWriteHashMap;, +import java.util.Map;, +    private static final Map<BytesReference, Stream> streams = new CopyOnWriteHashMap<>();, +            streams.put(type, stream);, +        return streams.get(type);, +++ b/core/src/main/java/org/elasticsearch/index/similarity/SimilarityLookupService.java, +import java.util.HashMap;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +, +    private final Map<String, SimilarityProvider> similarities;, +        this(index, indexSettings, emptyMap());, +        Map<String, SimilarityProvider> providers = new HashMap<>();, +        this.similarities = unmodifiableMap(providers);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregationStreams.java, +import org.elasticsearch.common.collect.CopyOnWriteHashMap;, +import java.util.Map;, +    private static Map<BytesReference, Stream> streams = new CopyOnWriteHashMap<>();, +            streams.put(type, stream);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java, +, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.unmodifiableMap;, +    private Map<String, Aggregation> aggregationsAsMap;, +            Map<String, InternalAggregation> newAggregationsAsMap = new HashMap<>();, +                newAggregationsAsMap.put(aggregation.getName(), aggregation);, +            this.aggregationsAsMap = unmodifiableMap(newAggregationsAsMap);, +        return aggregationsAsMap;]