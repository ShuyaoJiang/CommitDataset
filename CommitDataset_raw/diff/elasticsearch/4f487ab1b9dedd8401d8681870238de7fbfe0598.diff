[+++ b/docs/src/test/java/org/elasticsearch/smoketest/DocsClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/docs/src/test/java/org/elasticsearch/smoketest/DocsClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/qa/backwards-5.0/src/test/java/org/elasticsearch/backwards/Backwards50ClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/docs/src/test/java/org/elasticsearch/smoketest/DocsClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/qa/backwards-5.0/src/test/java/org/elasticsearch/backwards/Backwards50ClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/ClientYamlTestExecutionContext.java, +import com.carrotsearch.randomizedtesting.RandomizedTest;, +import org.apache.http.entity.ByteArrayEntity;, +import org.apache.lucene.util.BytesRef;, +import org.elasticsearch.common.xcontent.XContentBuilder;, +import org.elasticsearch.common.xcontent.XContentType;, +import java.nio.charset.StandardCharsets;, +import java.util.ArrayList;, +    private static final XContentType[] STREAMING_CONTENT_TYPES = new XContentType[]{XContentType.JSON, XContentType.SMILE};, +, +    private final boolean randomizeContentType;, +, +    public ClientYamlTestExecutionContext(ClientYamlTestClient clientYamlTestClient, boolean randomizeContentType) {, +        this.randomizeContentType = randomizeContentType;, +        HttpEntity entity = createEntity(bodies, headers);, +    private HttpEntity createEntity(List<Map<String, Object>> bodies, Map<String, String> headers) throws IOException {, +            XContentType xContentType = getContentType(headers, XContentType.values());, +            BytesRef bytesRef = bodyAsBytesRef(bodies.get(0), xContentType);, +            return new ByteArrayEntity(bytesRef.bytes, bytesRef.offset, bytesRef.length,, +                    ContentType.create(xContentType.mediaTypeWithoutParameters(), StandardCharsets.UTF_8));, +        } else {, +            XContentType xContentType = getContentType(headers, STREAMING_CONTENT_TYPES);, +            List<BytesRef> bytesRefList = new ArrayList<>();, +            int totalBytesLength = 0;, +                BytesRef bytesRef = bodyAsBytesRef(body, xContentType);, +                bytesRefList.add(bytesRef);, +                totalBytesLength += bytesRef.length - bytesRef.offset + 1;, +            byte[] bytes = new byte[totalBytesLength];, +            int position = 0;, +            for (BytesRef bytesRef : bytesRefList) {, +                for (int i = bytesRef.offset; i < bytesRef.length; i++) {, +                    bytes[position++] = bytesRef.bytes[i];, +                }, +                bytes[position++] = xContentType.xContent().streamSeparator();, +            }, +            return new ByteArrayEntity(bytes, ContentType.create(xContentType.mediaTypeWithoutParameters(), StandardCharsets.UTF_8));, +        }, +    private XContentType getContentType(Map<String, String> headers, XContentType[] supportedContentTypes) {, +        XContentType xContentType = null;, +        String contentType = headers.get("Content-Type");, +        if (contentType != null) {, +            xContentType = XContentType.fromMediaType(contentType);, +        }, +        if (xContentType != null) {, +            return xContentType;, +        }, +        if (randomizeContentType) {, +            return RandomizedTest.randomFrom(supportedContentTypes);, +        }, +        return XContentType.JSON;, +    }, +, +    private BytesRef bodyAsBytesRef(Map<String, Object> bodyAsMap, XContentType xContentType) throws IOException {, +        Map<String, Object> finalBodyAsMap = stash.replaceStashedValues(bodyAsMap);, +        try (XContentBuilder builder = XContentFactory.contentBuilder(xContentType)) {, +            return builder.map(finalBodyAsMap).bytes().toBytesRef();, +        }, +++ b/docs/src/test/java/org/elasticsearch/smoketest/DocsClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/qa/backwards-5.0/src/test/java/org/elasticsearch/backwards/Backwards50ClientYamlTestSuiteIT.java, +, +    @Override, +    protected boolean randomizeContentType() {, +        return false;, +    }, +++ b/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/ClientYamlTestExecutionContext.java]