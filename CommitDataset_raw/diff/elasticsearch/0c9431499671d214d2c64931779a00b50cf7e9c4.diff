[+++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +, +        return new FilterAggregator.Factory(aggregationName, filter == null ? new MatchAllDocsFilter() : filter.filter());, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +, +        return new FilterAggregator.Factory(aggregationName, filter == null ? new MatchAllDocsFilter() : filter.filter());, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filters/FiltersParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +                            filters.add(new FiltersAggregator.KeyedFilter(key, filter == null ? new MatchAllDocsFilter() : filter.filter()));, +                        filters.add(new FiltersAggregator.KeyedFilter(String.valueOf(idx), filter == null ? new MatchAllDocsFilter(), +                                : filter.filter()));, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +, +        return new FilterAggregator.Factory(aggregationName, filter == null ? new MatchAllDocsFilter() : filter.filter());, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filters/FiltersParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +                            filters.add(new FiltersAggregator.KeyedFilter(key, filter == null ? new MatchAllDocsFilter() : filter.filter()));, +                        filters.add(new FiltersAggregator.KeyedFilter(String.valueOf(idx), filter == null ? new MatchAllDocsFilter(), +                                : filter.filter()));, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/FilterTests.java, +import org.elasticsearch.index.query.AndFilterBuilder;, +import org.elasticsearch.index.query.FilterBuilder;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.avg;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.filter;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.histogram;, +    // See NullPointer issue when filters are empty:, +    // https://github.com/elasticsearch/elasticsearch/issues/8438, +    @Test, +    public void emptyFilterDeclarations() throws Exception {, +        FilterBuilder emptyFilter = new AndFilterBuilder();, +        SearchResponse response = client().prepareSearch("idx").addAggregation(filter("tag1").filter(emptyFilter)).execute().actionGet();, +, +        assertSearchResponse(response);, +, +        Filter filter = response.getAggregations().get("tag1");, +        assertThat(filter, notNullValue());, +        assertThat(filter.getDocCount(), equalTo((long) numDocs));, +    }, +, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filter/FilterParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +, +        return new FilterAggregator.Factory(aggregationName, filter == null ? new MatchAllDocsFilter() : filter.filter());, +++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/filters/FiltersParser.java, +import org.elasticsearch.common.lucene.search.MatchAllDocsFilter;, +                            filters.add(new FiltersAggregator.KeyedFilter(key, filter == null ? new MatchAllDocsFilter() : filter.filter()));, +                        filters.add(new FiltersAggregator.KeyedFilter(String.valueOf(idx), filter == null ? new MatchAllDocsFilter(), +                                : filter.filter()));, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/FilterTests.java, +import org.elasticsearch.index.query.AndFilterBuilder;, +import org.elasticsearch.index.query.FilterBuilder;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.avg;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.filter;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.histogram;, +    // See NullPointer issue when filters are empty:, +    // https://github.com/elasticsearch/elasticsearch/issues/8438, +    @Test, +    public void emptyFilterDeclarations() throws Exception {, +        FilterBuilder emptyFilter = new AndFilterBuilder();, +        SearchResponse response = client().prepareSearch("idx").addAggregation(filter("tag1").filter(emptyFilter)).execute().actionGet();, +, +        assertSearchResponse(response);, +, +        Filter filter = response.getAggregations().get("tag1");, +        assertThat(filter, notNullValue());, +        assertThat(filter.getDocCount(), equalTo((long) numDocs));, +    }, +, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/FiltersTests.java, +import org.elasticsearch.index.query.AndFilterBuilder;, +import org.elasticsearch.index.query.FilterBuilder;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.avg;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.filters;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.histogram;, +    // See NullPointer issue when filters are empty:, +    // https://github.com/elasticsearch/elasticsearch/issues/8438, +    @Test, +    public void emptyFilterDeclarations() throws Exception {, +        FilterBuilder emptyFilter = new AndFilterBuilder();, +        SearchResponse response = client().prepareSearch("idx"), +                .addAggregation(filters("tags").filter("all", emptyFilter).filter("tag1", termFilter("tag", "tag1"))).execute(), +                .actionGet();, +, +        assertSearchResponse(response);, +, +        Filters filters = response.getAggregations().get("tags");, +        assertThat(filters, notNullValue());, +        Filters.Bucket allBucket = filters.getBucketByKey("all");, +        assertThat(allBucket.getDocCount(), equalTo((long) numDocs));, +, +        Filters.Bucket bucket = filters.getBucketByKey("tag1");, +        assertThat(bucket, Matchers.notNullValue());, +        assertThat(bucket.getDocCount(), equalTo((long) numTag1Docs));, +    }, +]