[+++ b/core/src/main/java/org/elasticsearch/common/lucene/ShardCoreKeyMap.java, +import java.util.concurrent.ConcurrentHashMap;, +        coreKeyToShard = new ConcurrentHashMap<>();, +, +        if (coreKeyToShard.containsKey(coreKey)) {, +            // Do this check before entering the synchronized block in order to, +            // avoid taking the mutex if possible (which should happen most of, +            // the time)., +            return;, +        }, +, +            if (coreKeyToShard.containsKey(coreKey) == false) {, +, +                    // Only add the core key to the map as a last operation so that, +                    // if another thread sees that the core key is already in the, +                    // map (like the check just before this synchronized block),, +                    // then it means that the closed listener has already been, +                    // registered., +                    ShardId previous = coreKeyToShard.put(coreKey, shardId);, +                    assert previous == null;]