[+++ b/server/src/main/java/org/elasticsearch/node/Node.java, +        configureNodeAndClusterIdStateListener(clusterService);, +    protected void configureNodeAndClusterIdStateListener(ClusterService clusterService) {, +        NodeAndClusterIdStateListener.getAndSetNodeIdAndClusterId(clusterService,, +            injector.getInstance(ThreadPool.class).getThreadContext());, +    }, +, +++ b/server/src/main/java/org/elasticsearch/node/Node.java, +        configureNodeAndClusterIdStateListener(clusterService);, +    protected void configureNodeAndClusterIdStateListener(ClusterService clusterService) {, +        NodeAndClusterIdStateListener.getAndSetNodeIdAndClusterId(clusterService,, +            injector.getInstance(ThreadPool.class).getThreadContext());, +    }, +, +++ b/test/framework/src/main/java/org/elasticsearch/node/MockNode.java, +, +    @Override, +    protected void configureNodeAndClusterIdStateListener(ClusterService clusterService) {, +        //do not configure this in tests as this is causing SetOnce to throw exceptions when jvm is used for multiple tests, +    }]