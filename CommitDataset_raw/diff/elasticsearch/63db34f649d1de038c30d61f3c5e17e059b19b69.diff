[+++ b/docs/reference/search/aggregations/bucket/sampler-aggregation.asciidoc, +[[search-aggregations-bucket-sampler-aggregation]], +=== Sampler Aggregation, +, +experimental[], +, +A filtering aggregation used to limit any sub aggregations' processing to a sample of the top-scoring documents., +Optionally, diversity settings can be used to limit the number of matches that share a common value such as an "author"., +, +.Example use cases:, +* Tightening the focus of analytics to high-relevance matches rather than the potentially very long tail of low-quality matches, +* Removing bias from analytics by ensuring fair representation of content from different sources, +* Reducing the running cost of aggregations that can produce useful results using only samples e.g. `significant_terms`, + , +, +Example:, +, +[source,js], +--------------------------------------------------, +{, +    "query": {, +        "match": {, +            "text": "iphone", +        }, +    },, +    "aggs": {, +        "sample": {, +            "sampler": {, +                "shard_size": 200,, +                "field" : "user.id"   , +            },, +            "aggs": {, +                "keywords": {, +                    "significant_terms": {, +                        "field": "text", +                    }, +                }, +            }, +        }, +    }, +}, +--------------------------------------------------, +, +Response:, +, +[source,js], +--------------------------------------------------, +{, +    ..., +        "aggregations": {, +        "sample": {, +            "doc_count": 1000,<1>, +            "keywords": {<2>, +                "doc_count": 1000,, +                "buckets": [, +                    ..., +                    {, +                        "key": "bend",, +                        "doc_count": 58,, +                        "score": 37.982536582524276,, +                        "bg_count": 103, +                    },, +                    ...., +}, +--------------------------------------------------, +, +<1> 1000 documents were sampled in total becase we asked for a maximum of 200 from an index with 5 shards. The cost of performing the nested significant_terms aggregation was therefore limited rather than unbounded., +<2> The results of the significant_terms aggregation are not skewed by any single over-active Twitter user because we asked for a maximum of one tweet from any one user in our sample., +, +, +==== shard_size, +, +The `shard_size` parameter limits how many top-scoring documents are collected in the sample processed on each shard., +The default value is 100., +, +=== Controlling diversity, +Optionally, you can use the `field` or `script` and `max_docs_per_value` settings to control the maximum number of documents collected on any one shard which share a common value., +The choice of value (e.g. `author`) is loaded from a regular `field` or derived dynamically by a `script`., +, +The aggregation will throw an error if the choice of field or script produces multiple values for a document., +It is currently not possible to offer this form of de-duplication using many values, primarily due to concerns over efficiency., +, +NOTE: Any good market researcher will tell you that when working with samples of data it is important, +that the sample represents a healthy variety of opinions rather than being skewed by any single voice., +The same is true with aggregations and sampling with these diversify settings can offer a way to remove the bias in your content (an over-populated geography, a large spike in a timeline or an over-active forum spammer).  , +, +==== Field, +, +Controlling diversity using a field:, +, +[source,js], +--------------------------------------------------, +{, +    "aggs" : {, +        "sample" : {, +            "sampler" : {, +                "field" : "author",, +                "max_docs_per_value" : 3, +            }, +        }]