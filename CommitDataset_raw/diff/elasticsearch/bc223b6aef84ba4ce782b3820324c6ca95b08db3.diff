[+++ b/core/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java, +                removeFinishedSnapshotFromClusterState(event);, +     * Removes a finished snapshot from the cluster state.  This can happen if the previous, +     * master node processed a cluster state update that marked the snapshot as finished,, +     * but the previous master node died before removing the snapshot in progress from the, +     * cluster state.  It is then the responsibility of the new master node to end the, +     * snapshot and remove it from the cluster state., +     */, +    private void removeFinishedSnapshotFromClusterState(ClusterChangedEvent event) {, +        if (event.localNodeMaster() && !event.previousState().nodes().isLocalNodeElectedMaster()) {, +            SnapshotsInProgress snapshotsInProgress = event.state().custom(SnapshotsInProgress.TYPE);, +            if (snapshotsInProgress != null && !snapshotsInProgress.entries().isEmpty()) {, +                for (SnapshotsInProgress.Entry entry : snapshotsInProgress.entries()) {, +                    if (entry.state().completed()) {, +                        endSnapshot(entry);, +                    }, +                }, +            }, +        }, +    }, +, +    /**]