[+++ b/server/src/main/java/org/elasticsearch/persistent/CreatePersistentTaskAction.java, +                    Objects.equals(request, request1.request);, +            return Objects.hash(action, request);, +            persistentTasksClusterService.createPersistentTask(request.action, request.request,, +++ b/server/src/main/java/org/elasticsearch/persistent/CreatePersistentTaskAction.java, +                    Objects.equals(request, request1.request);, +            return Objects.hash(action, request);, +            persistentTasksClusterService.createPersistentTask(request.action, request.request,, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksClusterService.java, +    public <Request extends PersistentTaskRequest> void createPersistentTask(String action, Request request,, +                return update(currentState, builder(currentState).addTask(action, request, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/CreatePersistentTaskAction.java, +                    Objects.equals(request, request1.request);, +            return Objects.hash(action, request);, +            persistentTasksClusterService.createPersistentTask(request.action, request.request,, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksClusterService.java, +    public <Request extends PersistentTaskRequest> void createPersistentTask(String action, Request request,, +                return update(currentState, builder(currentState).addTask(action, request, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksCustomMetaData.java, +        public PersistentTask(long id, String taskName, Request request, Assignment assignment) {, +            this(id, 0L, taskName, request, null, assignment, null);, +        public PersistentTask(PersistentTask<Request> task, Assignment assignment) {, +            this(task.id, task.allocationId + 1L, task.taskName, task.request, task.status,, +            this(task.id, task.allocationId, task.taskName, task.request, status,, +        private PersistentTask(long id, long allocationId, String taskName, Request request,, +            return Objects.hash(id, allocationId, taskName, request, status, assignment,, +            return (assignment.isAssigned() == false || nodes.nodeExists(assignment.getExecutorNode()) == false);, +            return new PersistentTask<>(id, allocationId, taskName, request, status,, +        public <Request extends PersistentTaskRequest> Builder addTask(String taskName, Request request, Assignment assignment) {, +            tasks.put(currentId, new PersistentTask<>(currentId, taskName, request, assignment));, +                tasks.put(taskId, new PersistentTask<>(taskInProgress, assignment));, +                if (assignment.isAssigned()) {, +                    tasks.put(taskId, new PersistentTask<>(taskInProgress, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/CreatePersistentTaskAction.java, +                    Objects.equals(request, request1.request);, +            return Objects.hash(action, request);, +            persistentTasksClusterService.createPersistentTask(request.action, request.request,, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksClusterService.java, +    public <Request extends PersistentTaskRequest> void createPersistentTask(String action, Request request,, +                return update(currentState, builder(currentState).addTask(action, request, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksCustomMetaData.java, +        public PersistentTask(long id, String taskName, Request request, Assignment assignment) {, +            this(id, 0L, taskName, request, null, assignment, null);, +        public PersistentTask(PersistentTask<Request> task, Assignment assignment) {, +            this(task.id, task.allocationId + 1L, task.taskName, task.request, task.status,, +            this(task.id, task.allocationId, task.taskName, task.request, status,, +        private PersistentTask(long id, long allocationId, String taskName, Request request,, +            return Objects.hash(id, allocationId, taskName, request, status, assignment,, +            return (assignment.isAssigned() == false || nodes.nodeExists(assignment.getExecutorNode()) == false);, +            return new PersistentTask<>(id, allocationId, taskName, request, status,, +        public <Request extends PersistentTaskRequest> Builder addTask(String taskName, Request request, Assignment assignment) {, +            tasks.put(currentId, new PersistentTask<>(currentId, taskName, request, assignment));, +                tasks.put(taskId, new PersistentTask<>(taskInProgress, assignment));, +                if (assignment.isAssigned()) {, +                    tasks.put(taskId, new PersistentTask<>(taskInProgress, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksService.java, +++ b/server/src/main/java/org/elasticsearch/persistent/CreatePersistentTaskAction.java, +                    Objects.equals(request, request1.request);, +            return Objects.hash(action, request);, +            persistentTasksClusterService.createPersistentTask(request.action, request.request,, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksClusterService.java, +    public <Request extends PersistentTaskRequest> void createPersistentTask(String action, Request request,, +                return update(currentState, builder(currentState).addTask(action, request, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksCustomMetaData.java, +        public PersistentTask(long id, String taskName, Request request, Assignment assignment) {, +            this(id, 0L, taskName, request, null, assignment, null);, +        public PersistentTask(PersistentTask<Request> task, Assignment assignment) {, +            this(task.id, task.allocationId + 1L, task.taskName, task.request, task.status,, +            this(task.id, task.allocationId, task.taskName, task.request, status,, +        private PersistentTask(long id, long allocationId, String taskName, Request request,, +            return Objects.hash(id, allocationId, taskName, request, status, assignment,, +            return (assignment.isAssigned() == false || nodes.nodeExists(assignment.getExecutorNode()) == false);, +            return new PersistentTask<>(id, allocationId, taskName, request, status,, +        public <Request extends PersistentTaskRequest> Builder addTask(String taskName, Request request, Assignment assignment) {, +            tasks.put(currentId, new PersistentTask<>(currentId, taskName, request, assignment));, +                tasks.put(taskId, new PersistentTask<>(taskInProgress, assignment));, +                if (assignment.isAssigned()) {, +                    tasks.put(taskId, new PersistentTask<>(taskInProgress, assignment));, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksService.java, +++ b/server/src/test/java/org/elasticsearch/persistent/PersistentTasksClusterServiceTests.java, +            addTask(tasks, "should_assign", "assign_one", randomBoolean() ? null : "no_longer_exits");, +            switch (randomInt(2)) {, +                    addTask(tasks, "should_assign", "assign_me", randomBoolean() ? null : "no_longer_exits");, +                    addTask(tasks, "should_not_assign", "dont_assign_me", randomBoolean() ? null : "no_longer_exits");, +                    addTask(tasks, "assign_one", "assign_one", randomBoolean() ? null : "no_longer_exits");, +        if (tasksInProgress.findTasks("assign_one", task -> nodes.nodeExists(task.getExecutorNode())).isEmpty()) {, +                addRandomTask(builder, MetaData.builder(clusterState.metaData()), PersistentTasksCustomMetaData.builder(tasks), null);, +                        new Assignment(null, "change me"), "never_assign");, +                    addRandomTask(builder, MetaData.builder(clusterState.metaData()), tasksBuilder, NO_NODE_FOUND, "never_assign");, +                                               String node) {, +                randomAsciiOfLength(10));, +                                               Assignment assignment, String param) {, +                tasks.addTask(randomAsciiOfLength(10), new TestRequest(param), assignment).build()));, +    private void addTask(PersistentTasksCustomMetaData.Builder tasks, String action, String param, String node) {, +        tasks.addTask(action, new TestRequest(param), new Assignment(node, "explanation: " + action));, +++ b/server/src/main/java/org/elasticsearch/persistent/CreatePersistentTaskAction.java, +                    Objects.equals(request, request1.request);, +            return Objects.hash(action, request);, +            persistentTasksClusterService.createPersistentTask(request.action, request.request,, +++ b/server/src/main/java/org/elasticsearch/persistent/PersistentTasksClusterService.java]