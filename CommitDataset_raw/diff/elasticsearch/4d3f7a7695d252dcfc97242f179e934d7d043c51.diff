[+++ b/modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/CustomReflectionObjectHandler.java, +import org.elasticsearch.common.util.CollectionUtils;, +    @Override, +    public String stringify(Object object) {, +        CollectionUtils.ensureNoSelfReferences(object);, +        return super.stringify(object);, +    }, +++ b/modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/CustomReflectionObjectHandler.java, +import org.elasticsearch.common.util.CollectionUtils;, +    @Override, +    public String stringify(Object object) {, +        CollectionUtils.ensureNoSelfReferences(object);, +        return super.stringify(object);, +    }, +++ b/modules/lang-painless/src/test/resources/rest-api-spec/test/painless/15_update.yml, +  - match: { error.reason: "Iterable object is self-referencing itself" }, +++ b/modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/CustomReflectionObjectHandler.java, +import org.elasticsearch.common.util.CollectionUtils;, +    @Override, +    public String stringify(Object object) {, +        CollectionUtils.ensureNoSelfReferences(object);, +        return super.stringify(object);, +    }, +++ b/modules/lang-painless/src/test/resources/rest-api-spec/test/painless/15_update.yml, +  - match: { error.reason: "Iterable object is self-referencing itself" }, +++ b/modules/lang-painless/src/test/resources/rest-api-spec/test/painless/30_search.yml, +, +---, +"Return self-referencing map":, +    - do:, +        indices.create:, +            index: test, +            body:, +              settings:, +                number_of_shards: "1", +, +    - do:, +        index:, +            index: test, +            type: test, +            id: 1, +            body: { "genre": 1 }, +, +    - do:, +        indices.refresh: {}, +, +    - do:, +        catch: bad_request, +        index: test, +        search:, +            body:, +                aggs:, +                    genre:, +                        terms:, +                            script:, +                                lang: painless, +                                source: "def x = [:] ; def y = [:] ; x.a = y ; y.a = x ; return x", +, +    - match: { error.root_cause.0.type: "illegal_argument_exception" }, +    - match: { error.root_cause.0.reason: "Iterable object is self-referencing itself" }, +    - match: { error.type: "search_phase_execution_exception" }, +    - match: { error.reason: "all shards failed" }, +++ b/modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/CustomReflectionObjectHandler.java, +import org.elasticsearch.common.util.CollectionUtils;, +    @Override, +    public String stringify(Object object) {, +        CollectionUtils.ensureNoSelfReferences(object);, +        return super.stringify(object);, +    }, +++ b/modules/lang-painless/src/test/resources/rest-api-spec/test/painless/15_update.yml, +  - match: { error.reason: "Iterable object is self-referencing itself" }, +++ b/modules/lang-painless/src/test/resources/rest-api-spec/test/painless/30_search.yml, +, +---, +"Return self-referencing map":, +    - do:, +        indices.create:, +            index: test, +            body:, +              settings:, +                number_of_shards: "1", +, +    - do:, +        index:, +            index: test, +            type: test, +            id: 1, +            body: { "genre": 1 }, +, +    - do:, +        indices.refresh: {}, +, +    - do:, +        catch: bad_request, +        index: test, +        search:, +            body:, +                aggs:, +                    genre:, +                        terms:]