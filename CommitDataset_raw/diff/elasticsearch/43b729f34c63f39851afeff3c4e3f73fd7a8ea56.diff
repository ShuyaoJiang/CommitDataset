[+++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryParser.java, +                            XContentBuilder builder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryParser.java, +                            XContentBuilder builder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +                            XContentBuilder xContentBuilder = XContentFactory.jsonBuilder();, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                        XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                        XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryParser.java, +                            XContentBuilder builder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +                            XContentBuilder xContentBuilder = XContentFactory.jsonBuilder();, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                        XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                        XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/test/java/org/elasticsearch/index/query/AbstractQueryTestCase.java, +import org.elasticsearch.common.bytes.BytesArray;, +import org.elasticsearch.common.xcontent.*;, +            XContentBuilder builder = toXContent(testQuery, randomFrom(XContentType.values()));, +            assertParsedQuery(builder.bytes(), testQuery);, +                String queryAsString = alternateVersion.getKey();, +                assertParsedQuery(new BytesArray(queryAsString), alternateVersion.getValue());, +    protected static XContentBuilder toXContent(QueryBuilder<?> query, XContentType contentType) throws IOException {, +        XContentBuilder builder = XContentFactory.contentBuilder(contentType);, +        if (randomBoolean()) {, +            builder.prettyPrint();, +        }, +        query.toXContent(builder, ToXContent.EMPTY_PARAMS);, +        return builder;, +    }, +, +    /**, +     * Parses the query provided as bytes argument and compares it with the expected result provided as argument as a {@link QueryBuilder}, +     */, +    protected final void assertParsedQuery(BytesReference queryAsBytes, QueryBuilder<?> expectedQuery) throws IOException {, +        assertParsedQuery(queryAsBytes, expectedQuery, ParseFieldMatcher.STRICT);, +    }, +, +    protected final void assertParsedQuery(BytesReference queryAsBytes, QueryBuilder<?> expectedQuery, ParseFieldMatcher matcher) throws IOException {, +        QueryBuilder<?> newQuery = parseQuery(queryAsBytes, matcher);, +        assertNotSame(newQuery, expectedQuery);, +        assertEquals(expectedQuery, newQuery);, +        assertEquals(expectedQuery.hashCode(), newQuery.hashCode());, +    }, +, +    protected final QueryBuilder<?> parseQuery(BytesReference queryAsBytes) throws IOException {, +        return parseQuery(queryAsBytes, ParseFieldMatcher.STRICT);, +    protected final QueryBuilder<?> parseQuery(BytesReference queryAsBytes, ParseFieldMatcher matcher) throws IOException {, +        XContentParser parser = XContentFactory.xContent(queryAsBytes).createParser(queryAsBytes);, +        return parseQuery(parser, matcher);, +    }, +, +    private QueryBuilder<?> parseQuery(XContentParser parser, ParseFieldMatcher matcher) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java, +++ b/core/src/main/java/org/elasticsearch/index/query/GeoShapeQueryParser.java, +                            XContentBuilder builder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +                            XContentBuilder xContentBuilder = XContentFactory.jsonBuilder();, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                    XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                        XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +                        XContentBuilder xContentBuilder = XContentFactory.jsonBuilder().copyCurrentStructure(parser);, +++ b/core/src/test/java/org/elasticsearch/index/query/AbstractQueryTestCase.java, +import org.elasticsearch.common.bytes.BytesArray;, +import org.elasticsearch.common.xcontent.*;, +            XContentBuilder builder = toXContent(testQuery, randomFrom(XContentType.values()));, +            assertParsedQuery(builder.bytes(), testQuery);, +                String queryAsString = alternateVersion.getKey();, +                assertParsedQuery(new BytesArray(queryAsString), alternateVersion.getValue());, +    protected static XContentBuilder toXContent(QueryBuilder<?> query, XContentType contentType) throws IOException {, +        XContentBuilder builder = XContentFactory.contentBuilder(contentType);, +        if (randomBoolean()) {, +            builder.prettyPrint();, +        }, +        query.toXContent(builder, ToXContent.EMPTY_PARAMS);, +        return builder;, +    }, +, +    /**, +     * Parses the query provided as bytes argument and compares it with the expected result provided as argument as a {@link QueryBuilder}, +     */, +    protected final void assertParsedQuery(BytesReference queryAsBytes, QueryBuilder<?> expectedQuery) throws IOException {, +        assertParsedQuery(queryAsBytes, expectedQuery, ParseFieldMatcher.STRICT);, +    }]