[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java, +import java.io.OutputStream;, +    private final OutputStream bos;, +    /**, +     * Constructs a new cached builder over a cached (thread local) {@link FastByteArrayOutputStream}., +     */, +        return new XContentBuilder(xContent, FastByteArrayOutputStream.Cached.cached());, +    /**, +     * Constructs a new builder using a fresh {@link FastByteArrayOutputStream}., +     */, +        return new XContentBuilder(xContent, new FastByteArrayOutputStream());, +    /**, +     * Constructs a new builder using the provided xcontent and an OutputStream. Make sure, +     * to call {@link #close()} when the builder is done with., +     */, +    public XContentBuilder(XContent xContent, OutputStream bos) throws IOException {, +    /**, +     * Returns the unsafe bytes (thread local bound). Make sure to use it with, +     * {@link #unsafeBytesLength()}., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return ((FastByteArrayOutputStream) bos).unsafeByteArray();, +    /**, +     * Returns the unsafe bytes length (thread local bound). Make sure to use it with, +     * {@link #unsafeBytes()}., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return ((FastByteArrayOutputStream) bos).size();, +    /**, +     * Returns the actual stream used., +     */, +        return (FastByteArrayOutputStream) bos;, +    /**, +     * Returns a copy of the bytes this builder generated., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return ((FastByteArrayOutputStream) bos).copiedByteArray();, +    /**, +     * Returns a string representation of the builder (only applicable for text based xcontent)., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return Unicode.fromBytes(unsafeBytes(), 0, unsafeBytesLength());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java, +import java.io.OutputStream;, +    private final OutputStream bos;, +    /**, +     * Constructs a new cached builder over a cached (thread local) {@link FastByteArrayOutputStream}., +     */, +        return new XContentBuilder(xContent, FastByteArrayOutputStream.Cached.cached());, +    /**, +     * Constructs a new builder using a fresh {@link FastByteArrayOutputStream}., +     */, +        return new XContentBuilder(xContent, new FastByteArrayOutputStream());, +    /**, +     * Constructs a new builder using the provided xcontent and an OutputStream. Make sure, +     * to call {@link #close()} when the builder is done with., +     */, +    public XContentBuilder(XContent xContent, OutputStream bos) throws IOException {, +    /**, +     * Returns the unsafe bytes (thread local bound). Make sure to use it with, +     * {@link #unsafeBytesLength()}., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return ((FastByteArrayOutputStream) bos).unsafeByteArray();, +    /**, +     * Returns the unsafe bytes length (thread local bound). Make sure to use it with, +     * {@link #unsafeBytes()}., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return ((FastByteArrayOutputStream) bos).size();, +    /**, +     * Returns the actual stream used., +     */, +        return (FastByteArrayOutputStream) bos;, +    /**, +     * Returns a copy of the bytes this builder generated., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return ((FastByteArrayOutputStream) bos).copiedByteArray();, +    /**, +     * Returns a string representation of the builder (only applicable for text based xcontent)., +     *, +     * <p>Only applicable when the builder is constructed with {@link FastByteArrayOutputStream}., +     */, +        return Unicode.fromBytes(unsafeBytes(), 0, unsafeBytesLength());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/xcontent/XContentGenerator.java, +import java.io.OutputStream;, +    void writeRawField(String fieldName, byte[] content, OutputStream bos) throws IOException;, +    void writeRawField(String fieldName, InputStream content, OutputStream bos) throws IOException;, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java, +import java.io.OutputStream;, +    private final OutputStream bos;, +    /**]