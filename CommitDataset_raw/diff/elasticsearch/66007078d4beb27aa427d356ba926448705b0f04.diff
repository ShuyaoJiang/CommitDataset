[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +     * Should the shared environment be cleaned on cluster startup? Defaults, +     * to {@code true} so we run with a clean cluster but some tests wish to, +     * preserve snapshots between clusters so they set this to true., +     */, +    @Input, +    boolean cleanShared = true, +, +    /**, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +     * Should the shared environment be cleaned on cluster startup? Defaults, +     * to {@code true} so we run with a clean cluster but some tests wish to, +     * preserve snapshots between clusters so they set this to true., +     */, +    @Input, +    boolean cleanShared = true, +, +    /**, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +        Object startDependencies = config.dependencies, +        /* First, if we want a clean environment, we remove everything in the, +         * shared cluster directory to ensure there are no leftovers in repos, +         * or anything in theory this should not be necessary but repositories, +         * are only deleted in the cluster-state and not on-disk such that, +         * snapshots survive failures / test runs and there is no simple way, +         * today to fix that. */, +        if (config.cleanShared) {, +          Task cleanup = project.tasks.create(, +            name: "${prefix}#prepareCluster.cleanShared",, +            type: Delete,, +            dependsOn: startDependencies) {, +          startDependencies = cleanup, +        }, +            Object dependsOn = startTasks.empty ? startDependencies : startTasks.get(0), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +     * Should the shared environment be cleaned on cluster startup? Defaults, +     * to {@code true} so we run with a clean cluster but some tests wish to, +     * preserve snapshots between clusters so they set this to true., +     */, +    @Input, +    boolean cleanShared = true, +, +    /**, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +        Object startDependencies = config.dependencies, +        /* First, if we want a clean environment, we remove everything in the, +         * shared cluster directory to ensure there are no leftovers in repos, +         * or anything in theory this should not be necessary but repositories, +         * are only deleted in the cluster-state and not on-disk such that, +         * snapshots survive failures / test runs and there is no simple way, +         * today to fix that. */, +        if (config.cleanShared) {, +          Task cleanup = project.tasks.create(, +            name: "${prefix}#prepareCluster.cleanShared",, +            type: Delete,, +            dependsOn: startDependencies) {, +          startDependencies = cleanup, +        }, +            Object dependsOn = startTasks.empty ? startDependencies : startTasks.get(0), +++ b/qa/full-cluster-restart/build.gradle, +    cleanShared = false // We want to keep snapshots made by the old cluster!]