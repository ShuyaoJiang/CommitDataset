[+++ b/core/src/main/java/org/elasticsearch/search/aggregations/support/AggregationContext.java, +                vs = (VS) ValuesSource.Bytes.WithOrdinals.EMPTY;, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/support/AggregationContext.java, +                vs = (VS) ValuesSource.Bytes.WithOrdinals.EMPTY;, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSource.java, +        @Override, +        public Bits docsWithValue(LeafReaderContext context) throws IOException {, +            final SortedBinaryDocValues bytes = bytesValues(context);, +            if (org.elasticsearch.index.fielddata.FieldData.unwrapSingleton(bytes) != null) {, +                return org.elasticsearch.index.fielddata.FieldData.unwrapSingletonBits(bytes);, +            } else {, +                return org.elasticsearch.index.fielddata.FieldData.docsWithValue(bytes, context.reader().maxDoc());, +            }, +        }, +, +        public abstract static class WithOrdinals extends Bytes {, +]