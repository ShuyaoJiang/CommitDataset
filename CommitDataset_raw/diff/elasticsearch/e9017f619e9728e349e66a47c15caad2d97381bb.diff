[+++ b/core/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java, +import java.util.ArrayList;, +import java.util.Collections;, +import java.util.HashMap;, +import java.util.stream.Collectors;, +, +        final Map<Index, Set<String>> shardsByIndex = new HashMap<>();, +        for (ShardRouting shard : routingNode) {, +            shardsByIndex.computeIfAbsent(shard.index(), k -> new HashSet<>()).add(shard.allocationId().getId());, +        }, +, +            Set<String> newShardAllocationIds = shardsByIndex.getOrDefault(index, Collections.emptySet());]