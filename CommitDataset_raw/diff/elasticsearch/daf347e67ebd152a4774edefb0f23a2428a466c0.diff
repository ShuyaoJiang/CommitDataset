[+++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotDeletionPolicy.java, +        SnapshotHolder snapshotHolder = snapshots.get(commit.getGeneration());, +            snapshots.put(commit.getGeneration(), snapshotHolder);, +++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotDeletionPolicy.java, +        SnapshotHolder snapshotHolder = snapshots.get(commit.getGeneration());, +            snapshots.put(commit.getGeneration(), snapshotHolder);, +++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotIndexCommit.java, +        return deletionPolicy.release(getGeneration());, +        if (!deletionPolicy.isHeld(getGeneration())) {, +++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotDeletionPolicy.java, +        SnapshotHolder snapshotHolder = snapshots.get(commit.getGeneration());, +            snapshots.put(commit.getGeneration(), snapshotHolder);, +++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotIndexCommit.java, +        return deletionPolicy.release(getGeneration());, +        if (!deletionPolicy.isHeld(getGeneration())) {, +++ b/src/main/java/org/elasticsearch/index/gateway/IndexShardGateway.java, +            return lastIndexVersion != indexCommit.getGeneration();, +++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotDeletionPolicy.java, +        SnapshotHolder snapshotHolder = snapshots.get(commit.getGeneration());, +            snapshots.put(commit.getGeneration(), snapshotHolder);, +++ b/src/main/java/org/elasticsearch/index/deletionpolicy/SnapshotIndexCommit.java, +        return deletionPolicy.release(getGeneration());, +        if (!deletionPolicy.isHeld(getGeneration())) {, +++ b/src/main/java/org/elasticsearch/index/gateway/IndexShardGateway.java, +            return lastIndexVersion != indexCommit.getGeneration();, +++ b/src/main/java/org/elasticsearch/index/gateway/IndexShardGatewayService.java, +                    if (lastIndexVersion != snapshotIndexCommit.getGeneration() || lastTranslogId != translogSnapshot.translogId() || lastTranslogLength < translogSnapshot.length()) {, +                        lastIndexVersion = snapshotIndexCommit.getGeneration();]