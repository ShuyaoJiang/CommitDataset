[+++ b/core/src/main/java/org/elasticsearch/ingest/IngestService.java, +import org.elasticsearch.cluster.service.ClusterService;, +    public void buildProcessorsFactoryRegistry(ScriptService scriptService, ClusterService clusterService) {, +        pipelineStore.buildProcessorFactoryRegistry(processorsRegistryBuilder, scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/IngestService.java, +import org.elasticsearch.cluster.service.ClusterService;, +    public void buildProcessorsFactoryRegistry(ScriptService scriptService, ClusterService clusterService) {, +        pipelineStore.buildProcessorFactoryRegistry(processorsRegistryBuilder, scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/PipelineStore.java, +    public void buildProcessorFactoryRegistry(ProcessorsRegistry.Builder processorsRegistryBuilder, ScriptService scriptService, ClusterService clusterService) {, +        this.processorRegistry = processorsRegistryBuilder.build(scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/IngestService.java, +import org.elasticsearch.cluster.service.ClusterService;, +    public void buildProcessorsFactoryRegistry(ScriptService scriptService, ClusterService clusterService) {, +        pipelineStore.buildProcessorFactoryRegistry(processorsRegistryBuilder, scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/PipelineStore.java, +    public void buildProcessorFactoryRegistry(ProcessorsRegistry.Builder processorsRegistryBuilder, ScriptService scriptService, ClusterService clusterService) {, +        this.processorRegistry = processorsRegistryBuilder.build(scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/ProcessorsRegistry.java, +import org.elasticsearch.cluster.service.ClusterService;, +import org.elasticsearch.script.ScriptService;, +import java.util.function.Function;, +    private final TemplateService templateService;, +    private final ScriptService scriptService;, +    private final ClusterService clusterService;, +    private ProcessorsRegistry(ScriptService scriptService, ClusterService clusterService,, +                               Map<String, Function<ProcessorsRegistry, Processor.Factory<?>>> providers) {, +        this.templateService = new InternalTemplateService(scriptService);, +        this.scriptService = scriptService;, +        this.clusterService = clusterService;, +        for (Map.Entry<String, Function<ProcessorsRegistry, Processor.Factory<?>>> entry : providers.entrySet()) {, +            processorFactories.put(entry.getKey(), entry.getValue().apply(this));, +    public TemplateService getTemplateService() {, +        return templateService;, +    }, +, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +    public ClusterService getClusterService() {, +        return clusterService;, +    }, +, +        private final Map<String, Function<ProcessorsRegistry, Processor.Factory<?>>> providers = new HashMap<>();, +        public void registerProcessor(String name, Function<ProcessorsRegistry, Processor.Factory<?>> provider) {, +            Function<ProcessorsRegistry, Processor.Factory<?>> previous = this.providers.putIfAbsent(name, provider);, +        public ProcessorsRegistry build(ScriptService scriptService, ClusterService clusterService) {, +            return new ProcessorsRegistry(scriptService, clusterService, providers);, +++ b/core/src/main/java/org/elasticsearch/ingest/IngestService.java, +import org.elasticsearch.cluster.service.ClusterService;, +    public void buildProcessorsFactoryRegistry(ScriptService scriptService, ClusterService clusterService) {, +        pipelineStore.buildProcessorFactoryRegistry(processorsRegistryBuilder, scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/PipelineStore.java, +    public void buildProcessorFactoryRegistry(ProcessorsRegistry.Builder processorsRegistryBuilder, ScriptService scriptService, ClusterService clusterService) {, +        this.processorRegistry = processorsRegistryBuilder.build(scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/ProcessorsRegistry.java, +import org.elasticsearch.cluster.service.ClusterService;, +import org.elasticsearch.script.ScriptService;, +import java.util.function.Function;, +    private final TemplateService templateService;, +    private final ScriptService scriptService;, +    private final ClusterService clusterService;, +    private ProcessorsRegistry(ScriptService scriptService, ClusterService clusterService,, +                               Map<String, Function<ProcessorsRegistry, Processor.Factory<?>>> providers) {, +        this.templateService = new InternalTemplateService(scriptService);, +        this.scriptService = scriptService;, +        this.clusterService = clusterService;, +        for (Map.Entry<String, Function<ProcessorsRegistry, Processor.Factory<?>>> entry : providers.entrySet()) {, +            processorFactories.put(entry.getKey(), entry.getValue().apply(this));, +    public TemplateService getTemplateService() {, +        return templateService;, +    }, +, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +    public ClusterService getClusterService() {, +        return clusterService;, +    }, +, +        private final Map<String, Function<ProcessorsRegistry, Processor.Factory<?>>> providers = new HashMap<>();, +        public void registerProcessor(String name, Function<ProcessorsRegistry, Processor.Factory<?>> provider) {, +            Function<ProcessorsRegistry, Processor.Factory<?>> previous = this.providers.putIfAbsent(name, provider);, +        public ProcessorsRegistry build(ScriptService scriptService, ClusterService clusterService) {, +            return new ProcessorsRegistry(scriptService, clusterService, providers);, +++ b/core/src/main/java/org/elasticsearch/node/NodeModule.java, +import java.util.function.Function;, +    public void registerProcessor(String type, Function<ProcessorsRegistry, Processor.Factory<?>> provider) {, +++ b/core/src/main/java/org/elasticsearch/ingest/IngestService.java, +import org.elasticsearch.cluster.service.ClusterService;, +    public void buildProcessorsFactoryRegistry(ScriptService scriptService, ClusterService clusterService) {, +        pipelineStore.buildProcessorFactoryRegistry(processorsRegistryBuilder, scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/PipelineStore.java, +    public void buildProcessorFactoryRegistry(ProcessorsRegistry.Builder processorsRegistryBuilder, ScriptService scriptService, ClusterService clusterService) {, +        this.processorRegistry = processorsRegistryBuilder.build(scriptService, clusterService);, +++ b/core/src/main/java/org/elasticsearch/ingest/ProcessorsRegistry.java, +import org.elasticsearch.cluster.service.ClusterService;, +import org.elasticsearch.script.ScriptService;]