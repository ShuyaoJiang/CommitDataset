[+++ b/core/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java, +import org.elasticsearch.cluster.ClusterStateTaskConfig;, +import org.elasticsearch.cluster.ClusterStateTaskExecutor;, +import org.elasticsearch.common.Priority;, +    private final SnapshotStateExecutor snapshotStateExecutor = new SnapshotStateExecutor();, +        clusterService.submitStateUpdateTask(, +            "update snapshot state",, +            request,, +            ClusterStateTaskConfig.build(Priority.NORMAL),, +            snapshotStateExecutor,, +            (source, e) -> logger.warn((Supplier<?>) () -> new ParameterizedMessage("[{}][{}] failed to update snapshot status to [{}]",, +                request.snapshot(), request.shardId(), request.status()), e));, +    }, +    class SnapshotStateExecutor implements ClusterStateTaskExecutor<UpdateIndexShardSnapshotStatusRequest> {, +        public ClusterTasksResult<UpdateIndexShardSnapshotStatusRequest> execute(ClusterState currentState, List<UpdateIndexShardSnapshotStatusRequest> tasks) throws Exception {, +                    for (UpdateIndexShardSnapshotStatusRequest updateSnapshotState : tasks) {, +                    return ClusterTasksResult.<UpdateIndexShardSnapshotStatusRequest>builder().successes(tasks).build(, +                        ClusterState.builder(currentState).putCustom(SnapshotsInProgress.TYPE, updatedSnapshots).build());, +            return ClusterTasksResult.<UpdateIndexShardSnapshotStatusRequest>builder().successes(tasks).build(currentState);]