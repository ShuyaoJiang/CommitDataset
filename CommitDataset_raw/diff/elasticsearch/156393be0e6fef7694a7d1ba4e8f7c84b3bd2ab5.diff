[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/DocsTestPlugin.groovy, +            if (RestTestsFromSnippetsTask.isConsoleCandidate(it)) {, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/DocsTestPlugin.groovy, +            if (RestTestsFromSnippetsTask.isConsoleCandidate(it)) {, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/RestTestsFromSnippetsTask.groovy, +     * A list of files that contain snippets that *probably* should be, +     * converted to `// CONSOLE` but have yet to be converted. If a file is in, +     * this list and doesn't contain unconverted snippets this task will fail., +     * If there are unconverted snippets not in this list then this task will, +     * fail. All files are paths relative to the docs dir., +     */, +    @Input, +    List<String> expectedUnconvertedCandidates = [], +, +    /**, +        doLast builder.&checkUnconverted, +    /**, +     * Is this snippet a candidate for conversion to `// CONSOLE`?, +     */, +    static isConsoleCandidate(Snippet snippet) {, +        /* Snippets that are responses or already marked as `// CONSOLE` or, +         * `// NOTCONSOLE` are not candidates. */, +        if (snippet.console != null || snippet.testResponse) {, +            return false, +        }, +        /* js snippets almost always should be marked with `// CONSOLE`. js, +         * snippets that shouldn't be marked `// CONSOLE`, like examples for, +         * js client, should always be marked with `// NOTCONSOLE`., +         *, +         * `sh` snippets that contain `curl` almost always should be marked, +         * with `// CONSOLE`. In the exceptionally rare cases where they are, +         * not communicating with Elasticsearch, like the xamples in the ec2, +         * and gce discovery plugins, the snippets should be marked, +         * `// NOTCONSOLE`. */, +        return snippet.language == 'js' || snippet.curl, +    }, +, +         * Files containing all snippets that *probably* should be converted, +         * to `// CONSOLE` but have yet to be converted. All files are paths, +         * relative to the docs dir., +         */, +        Set<String> unconvertedCandidates = new HashSet<>(), +, +        /**, +            if (RestTestsFromSnippetsTask.isConsoleCandidate(snippet)) {, +                unconvertedCandidates.add(snippet.path.toString()), +            }, +, +        void checkUnconverted() {, +            List<String> listedButNotFound = [], +            for (String listed : expectedUnconvertedCandidates) {, +                if (false == unconvertedCandidates.remove(listed)) {, +                    listedButNotFound.add(listed), +                }, +            }, +            String message = "", +            if (false == listedButNotFound.isEmpty()) {, +                Collections.sort(listedButNotFound), +                listedButNotFound = listedButNotFound.collect {'    ' + it}, +                message += "Expected unconverted snippets but none found in:\n", +                message += listedButNotFound.join("\n"), +            }, +            if (false == unconvertedCandidates.isEmpty()) {, +                List<String> foundButNotListed =, +                    new ArrayList<>(unconvertedCandidates), +                Collections.sort(foundButNotListed), +                foundButNotListed = foundButNotListed.collect {'    ' + it}, +                if (false == "".equals(message)) {, +                    message += "\n", +                }, +                message += "Unexpected unconverted snippets:\n", +                message += foundButNotListed.join("\n"), +            }, +            if (false == "".equals(message)) {, +                throw new InvalidUserDataException(message);, +            }, +        }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/DocsTestPlugin.groovy, +            if (RestTestsFromSnippetsTask.isConsoleCandidate(it)) {, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/RestTestsFromSnippetsTask.groovy, +     * A list of files that contain snippets that *probably* should be, +     * converted to `// CONSOLE` but have yet to be converted. If a file is in, +     * this list and doesn't contain unconverted snippets this task will fail., +     * If there are unconverted snippets not in this list then this task will, +     * fail. All files are paths relative to the docs dir., +     */, +    @Input, +    List<String> expectedUnconvertedCandidates = [], +, +    /**, +        doLast builder.&checkUnconverted, +    /**, +     * Is this snippet a candidate for conversion to `// CONSOLE`?, +     */, +    static isConsoleCandidate(Snippet snippet) {, +        /* Snippets that are responses or already marked as `// CONSOLE` or, +         * `// NOTCONSOLE` are not candidates. */, +        if (snippet.console != null || snippet.testResponse) {, +            return false, +        }]