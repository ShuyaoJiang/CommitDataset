[+++ b/src/test/java/org/elasticsearch/alerts/AbstractAlertingTests.java, +import org.elasticsearch.cluster.ClusterState;, +import static org.elasticsearch.index.query.QueryBuilders.matchQuery;, +                // The alerthistory index gets created in the background when the first alert fires, so we to check first is this index is created and shards are started, +                ClusterState state = client().admin().cluster().prepareState().get().getState();, +                assertThat(state.getRoutingTable().index(AlertActionManager.ALERT_HISTORY_INDEX).allPrimaryShardsActive(), is(true));, +                        .setQuery(boolQuery().must(matchQuery("alert_name", alertName)).must(matchQuery("state", AlertActionState.ACTION_PERFORMED.toString()))), +        });]