[+++ b/src/main/java/org/elasticsearch/cluster/routing/operation/plain/PlainOperationRouting.java, +        if (preference == null || preference.isEmpty()) {, +++ b/src/main/java/org/elasticsearch/cluster/routing/operation/plain/PlainOperationRouting.java, +        if (preference == null || preference.isEmpty()) {, +++ b/src/test/java/org/elasticsearch/test/integration/search/simple/SimpleSearchTests.java, +import java.util.concurrent.ExecutionException;, +, +    public void testSearchRandomPreference() throws InterruptedException, ExecutionException {, +        client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards", between(1,3))).get();, +        indexRandom("test", true, , +        client().prepareIndex("test", "type", "1").setSource("field", "value"),, +        client().prepareIndex("test", "type", "2").setSource("field", "value"),, +        client().prepareIndex("test", "type", "3").setSource("field", "value"),, +        client().prepareIndex("test", "type", "4").setSource("field", "value"),, +        client().prepareIndex("test", "type", "5").setSource("field", "value"),, +        client().prepareIndex("test", "type", "6").setSource("field", "value"));, +        int iters = atLeast(10);, +        for (int i = 0; i < iters; i++) {, +            // id is not indexed, but lets see that we automatically convert to, +            SearchResponse searchResponse = client().prepareSearch().setQuery(QueryBuilders.matchAllQuery()).setPreference(randomUnicodeOfLengthBetween(0, 4)).get();, +            assertThat(searchResponse.getHits().totalHits(), equalTo(6l));, +        }, +    }, +, +    @Test, +    public void simpleIpTests() throws Exception {]