[+++ b/x-pack/qa/evil-tests/src/test/java/org/elasticsearch/xpack/security/authc/kerberos/SimpleKdcLdapServer.java, +import java.net.DatagramSocket;, +import java.net.InetAddress;, +import java.net.ServerSocket;, +import javax.net.ServerSocketFactory;, +, +            if (kdcPort == 0) {, +                kdcPort = getServerPort(transport);, +            }, +            if (transport.trim().equalsIgnoreCase("TCP")) {, +            } else if (transport.trim().equalsIgnoreCase("UDP")) {, +    private static int getServerPort(String transport) {, +        if (transport != null && transport.trim().equalsIgnoreCase("TCP")) {, +            try (ServerSocket serverSocket = ServerSocketFactory.getDefault().createServerSocket(0, 1,, +                    InetAddress.getByName("127.0.0.1"))) {, +                return serverSocket.getLocalPort();, +            } catch (Exception ex) {, +                throw new RuntimeException("Failed to get a TCP server socket point");, +            }, +        } else if (transport != null && transport.trim().equalsIgnoreCase("UDP")) {, +            try (DatagramSocket socket = new DatagramSocket(0, InetAddress.getByName("127.0.0.1"))) {, +                return socket.getLocalPort();, +            } catch (Exception ex) {, +                throw new RuntimeException("Failed to get a UDP server socket point");, +            }, +        }, +        throw new IllegalArgumentException("Invalid transport: " + transport);, +    }]