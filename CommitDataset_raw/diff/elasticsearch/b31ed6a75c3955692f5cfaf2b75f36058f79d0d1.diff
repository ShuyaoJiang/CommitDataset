[+++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    // exit codes for install, +    /** A plugin with the same name is already installed. */, +    static final int PLUGIN_EXISTS = 1;, +    /** The plugin zip is not properly structured. */, +    static final int PLUGIN_MALFORMED = 2;, +, +, +            throw new UserException(ExitCodes.IO_ERROR,, +                "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +                // Using the entry name as a path can result in an entry outside of the plugin dir,, +                // either if the name starts with the root of the filesystem, or it is a relative, +                // entry like ../whatever. This check attempts to identify both cases by first, +                // normalizing the path (which removes foo/..) and ensuring the normalized entry, +                // is still rooted with the target plugin directory., +                    throw new UserException(PLUGIN_MALFORMED, "Zip contains entry name '" +, +                        entry.getName() + "' resolving outside of plugin directory");, +            throw new UserException(PLUGIN_MALFORMED,, +                                    "`elasticsearch` directory is missing in the plugin zip");, +                "plugin directory [%s] already exists; if you need to update the plugin, " +, +                    "uninstall it first using command 'remove %s'",, +            throw new UserException(PLUGIN_EXISTS, message);, +            throw new UserException(ExitCodes.USAGE, "plugin '" + info.getName() +, +                "' cannot be installed like this, it is a system module");, +            throw new UserException(PLUGIN_MALFORMED, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserException(PLUGIN_MALFORMED, "Directories not allowed in bin dir " +, +                        "for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserException(PLUGIN_MALFORMED,, +                "config in plugin " + info.getName() + " is not a directory");, +                    throw new UserException(PLUGIN_MALFORMED,, +                        "Directories not allowed in config dir for plugin " + info.getName());, +++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    // exit codes for install, +    /** A plugin with the same name is already installed. */, +    static final int PLUGIN_EXISTS = 1;, +    /** The plugin zip is not properly structured. */, +    static final int PLUGIN_MALFORMED = 2;, +, +, +            throw new UserException(ExitCodes.IO_ERROR,, +                "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +                // Using the entry name as a path can result in an entry outside of the plugin dir,, +                // either if the name starts with the root of the filesystem, or it is a relative, +                // entry like ../whatever. This check attempts to identify both cases by first, +                // normalizing the path (which removes foo/..) and ensuring the normalized entry, +                // is still rooted with the target plugin directory., +                    throw new UserException(PLUGIN_MALFORMED, "Zip contains entry name '" +, +                        entry.getName() + "' resolving outside of plugin directory");, +            throw new UserException(PLUGIN_MALFORMED,, +                                    "`elasticsearch` directory is missing in the plugin zip");, +                "plugin directory [%s] already exists; if you need to update the plugin, " +, +                    "uninstall it first using command 'remove %s'",, +            throw new UserException(PLUGIN_EXISTS, message);, +            throw new UserException(ExitCodes.USAGE, "plugin '" + info.getName() +, +                "' cannot be installed like this, it is a system module");, +            throw new UserException(PLUGIN_MALFORMED, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserException(PLUGIN_MALFORMED, "Directories not allowed in bin dir " +, +                        "for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserException(PLUGIN_MALFORMED,, +                "config in plugin " + info.getName() + " is not a directory");, +                    throw new UserException(PLUGIN_MALFORMED,, +                        "Directories not allowed in config dir for plugin " + info.getName());, +++ b/qa/evil-tests/src/test/java/org/elasticsearch/plugins/InstallPluginCommandTests.java, +        UserException e = expectThrows(UserException.class, () -> installPlugin(pluginZip, env.v1()));]