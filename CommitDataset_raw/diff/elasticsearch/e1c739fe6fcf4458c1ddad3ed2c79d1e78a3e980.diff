[+++ b/src/test/java/org/elasticsearch/test/integration/document/BulkTests.java, +import org.elasticsearch.common.bytes.BytesArray;, +import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoFailures;, +import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertSearchHits;, +                .addMapping("child", "{\"child\": {\"_parent\": {\"type\": \"parent\"}}}"), +        byte[] addParent = new BytesArray("{\"index\" : { \"_index\" : \"test\", \"_type\" : \"parent\", \"_id\" : \"parent1\"}}\n" +, +                "{\"field1\" : \"value1\"}\n").array();, +        byte[] addChild = new BytesArray("{ \"update\" : { \"_index\" : \"test\", \"_type\" : \"child\", \"_id\" : \"child1\", \"parent\" : \"parent1\"}}\n" +, +                "{\"doc\" : { \"field1\" : \"value1\"}, \"doc_as_upsert\" : \"true\"}\n").array();, +        assertNoFailures(searchResponse);, +        assertSearchHits(searchResponse, "child1");, +                .addMapping("child", "{\"child\": {\"_parent\": {\"type\": \"parent\"}}}"), +        byte[] addParent = new BytesArray("{\"index\" : { \"_index\" : \"test\", \"_type\" : \"parent\", \"_id\" : \"parent1\"}}\n" +, +                "{\"field1\" : \"value1\"}\n").array();, +        byte[] addChild = new BytesArray("{\"update\" : { \"_id\" : \"child1\", \"_type\" : \"child\", \"_index\" : \"test\", \"parent\" : \"parent1\"} }\n" +, +                "{ \"script\" : \"ctx._source.field2 = 'value2'\", \"upsert\" : {\"field1\" : \"value1\"}}\n").array();, +        assertNoFailures(searchResponse);, +        assertSearchHits(searchResponse, "child1");]