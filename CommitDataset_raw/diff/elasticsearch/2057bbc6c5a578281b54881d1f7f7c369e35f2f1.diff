[+++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +    /** Return the script service to allow compiling scripts within queries. */, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +    /** Return the script service to allow compiling scripts within queries. */, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        failIfFrozen();, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +    /** Return the script service to allow compiling scripts within queries. */, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        failIfFrozen();, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        SearchScript.Factory factory = context.getScriptService().compile(script, SearchScript.CONTEXT);, +        SearchScript.LeafFactory searchScript = factory.newFactory(script.getParams(), context.lookup());, +        return new ScriptQuery(script, searchScript);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +    /** Return the script service to allow compiling scripts within queries. */, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        failIfFrozen();, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        SearchScript.Factory factory = context.getScriptService().compile(script, SearchScript.CONTEXT);, +        SearchScript.LeafFactory searchScript = factory.newFactory(script.getParams(), context.lookup());, +        return new ScriptQuery(script, searchScript);, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +            SearchScript.Factory factory = context.getScriptService().compile(script, SearchScript.CONTEXT);, +            SearchScript.LeafFactory searchScript = factory.newFactory(script.getParams(), context.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +    /** Return the script service to allow compiling scripts within queries. */, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        failIfFrozen();, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        SearchScript.Factory factory = context.getScriptService().compile(script, SearchScript.CONTEXT);, +        SearchScript.LeafFactory searchScript = factory.newFactory(script.getParams(), context.lookup());, +        return new ScriptQuery(script, searchScript);, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +            SearchScript.Factory factory = context.getScriptService().compile(script, SearchScript.CONTEXT);, +            SearchScript.LeafFactory searchScript = factory.newFactory(script.getParams(), context.lookup());, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/heuristics/ScriptHeuristic.java, +import org.elasticsearch.index.query.QueryShardContext;, +        QueryShardContext shardContext = context.getQueryShardContext();, +        ExecutableScript.Factory compiledScript = shardContext.getScriptService().compile(script, ExecutableScript.AGGS_CONTEXT);, +        return new ExecutableScriptHeuristic(script, compiledScript.newInstance(script.getParams()));, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitContextBuilder.java, +                QueryShardContext innerContext = innerHitsContext.getQueryShardContext();, +                SearchScript.Factory factory = innerContext.getScriptService().compile(field.script(), SearchScript.CONTEXT);, +                SearchScript.LeafFactory searchScript = factory.newFactory(field.script().getParams(), innerHitsContext.lookup());, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +    /** Return the script service to allow compiling scripts within queries. */, +    public ScriptService getScriptService() {, +        return scriptService;, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        failIfFrozen();, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        SearchScript.Factory factory = context.getScriptService().compile(script, SearchScript.CONTEXT);, +        SearchScript.LeafFactory searchScript = factory.newFactory(script.getParams(), context.lookup());]