[+++ b/qa/mixed-cluster/build.gradle, +++ b/qa/mixed-cluster/build.gradle, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/cat.templates/10_basic.yml, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +++ b/qa/mixed-cluster/build.gradle, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/cat.templates/10_basic.yml, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +++ b/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java, +import org.elasticsearch.client.Request;, +import org.elasticsearch.common.xcontent.DeprecationHandler;, +import org.elasticsearch.common.xcontent.NamedXContentRegistry;, +    public static Map<String, Object> entityAsMap(Response response) throws IOException {, +        // EMPTY and THROW are fine here because `.map` doesn't use named x content or deprecation, +        try (XContentParser parser = xContentType.xContent().createParser(, +                NamedXContentRegistry.EMPTY, DeprecationHandler.THROW_UNSUPPORTED_OPERATION,, +                response.getEntity().getContent())) {, +    /**, +     * Does the cluster being tested have xpack installed?, +     */, +    public static boolean hasXPack() throws IOException {, +        RestClient client = adminClient();, +        if (client == null) {, +            throw new IllegalStateException("must be called inside of a rest test case test");, +        }, +        Map<?, ?> response = entityAsMap(client.performRequest(new Request("GET", "_nodes/plugins")));, +        Map<?, ?> nodes = (Map<?, ?>) response.get("nodes");, +        for (Map.Entry<?, ?> node : nodes.entrySet()) {, +            Map<?, ?> nodeInfo = (Map<?, ?>) node.getValue();, +            for (Object module: (List<?>) nodeInfo.get("modules")) {, +                Map<?, ?> moduleInfo = (Map<?, ?>) module;, +                if (moduleInfo.get("name").toString().startsWith("x-pack-")) {, +                    return true;, +                }, +            }, +        }, +        return false;, +    }, +, +++ b/qa/mixed-cluster/build.gradle, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/cat.templates/10_basic.yml, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +++ b/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java, +import org.elasticsearch.client.Request;, +import org.elasticsearch.common.xcontent.DeprecationHandler;, +import org.elasticsearch.common.xcontent.NamedXContentRegistry;, +    public static Map<String, Object> entityAsMap(Response response) throws IOException {, +        // EMPTY and THROW are fine here because `.map` doesn't use named x content or deprecation, +        try (XContentParser parser = xContentType.xContent().createParser(, +                NamedXContentRegistry.EMPTY, DeprecationHandler.THROW_UNSUPPORTED_OPERATION,, +                response.getEntity().getContent())) {, +    /**, +     * Does the cluster being tested have xpack installed?, +     */, +    public static boolean hasXPack() throws IOException {, +        RestClient client = adminClient();, +        if (client == null) {, +            throw new IllegalStateException("must be called inside of a rest test case test");, +        }, +        Map<?, ?> response = entityAsMap(client.performRequest(new Request("GET", "_nodes/plugins")));, +        Map<?, ?> nodes = (Map<?, ?>) response.get("nodes");, +        for (Map.Entry<?, ?> node : nodes.entrySet()) {, +            Map<?, ?> nodeInfo = (Map<?, ?>) node.getValue();, +            for (Object module: (List<?>) nodeInfo.get("modules")) {, +                Map<?, ?> moduleInfo = (Map<?, ?>) module;, +                if (moduleInfo.get("name").toString().startsWith("x-pack-")) {, +                    return true;, +                }, +            }, +        }, +        return false;, +    }, +, +++ b/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/Features.java, +import java.io.IOException;, +import org.elasticsearch.test.rest.ESRestTestCase;, +, +        try {, +                if (feature.equals("xpack")) {, +                    if (false == ESRestTestCase.hasXPack()) {, +                        return false;, +                    }, +                } else if (feature.equals("no_xpack")) {, +                    if (ESRestTestCase.hasXPack()) {, +                        return false;, +                    }, +                } else if (false == SUPPORTED.contains(feature)) {, +        } catch (IOException e) {, +            throw new RuntimeException("error checking if xpack is available", e);, +        }, +++ b/qa/mixed-cluster/build.gradle, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/cat.templates/10_basic.yml, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack, +        features: default_shards, no_xpack]