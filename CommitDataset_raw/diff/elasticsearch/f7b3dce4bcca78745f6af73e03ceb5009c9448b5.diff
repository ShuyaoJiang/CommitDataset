[+++ b/core/src/main/java/org/elasticsearch/index/query/MatchPhrasePrefixQueryBuilder.java, +        String fieldName = null;, +        XContentParser.Token token;, +            } else if (parseContext.isDeprecatedSetting(currentFieldName)) {, +                // skip, +            } else if (token == XContentParser.Token.START_OBJECT) {, +                if (fieldName != null) {, +                    throw new ParsingException(parser.getTokenLocation(), "[match_phrase_prefix] query doesn't support multiple " +, +                            "fields, found [" + fieldName + "] and [" + currentFieldName + "]");, +                }, +                fieldName = currentFieldName;, +                while ((token = parser.nextToken()) != XContentParser.Token.END_OBJECT) {, +                    if (token == XContentParser.Token.FIELD_NAME) {, +                        currentFieldName = parser.currentName();, +                fieldName = parser.currentName();, +++ b/core/src/main/java/org/elasticsearch/index/query/MatchPhrasePrefixQueryBuilder.java, +        String fieldName = null;, +        XContentParser.Token token;, +            } else if (parseContext.isDeprecatedSetting(currentFieldName)) {, +                // skip, +            } else if (token == XContentParser.Token.START_OBJECT) {, +                if (fieldName != null) {, +                    throw new ParsingException(parser.getTokenLocation(), "[match_phrase_prefix] query doesn't support multiple " +, +                            "fields, found [" + fieldName + "] and [" + currentFieldName + "]");, +                }, +                fieldName = currentFieldName;, +                while ((token = parser.nextToken()) != XContentParser.Token.END_OBJECT) {, +                    if (token == XContentParser.Token.FIELD_NAME) {, +                        currentFieldName = parser.currentName();, +                fieldName = parser.currentName();, +++ b/core/src/test/java/org/elasticsearch/index/query/MatchPhrasePrefixQueryBuilderTests.java, +import org.elasticsearch.common.ParsingException;, +import java.util.HashMap;, +import java.util.Map;, +, +    protected Map<String, MatchPhrasePrefixQueryBuilder> getAlternateVersions() {, +        Map<String, MatchPhrasePrefixQueryBuilder> alternateVersions = new HashMap<>();, +        MatchPhrasePrefixQueryBuilder matchPhrasePrefixQuery = new MatchPhrasePrefixQueryBuilder(randomAsciiOfLengthBetween(1, 10),, +                randomAsciiOfLengthBetween(1, 10));, +        String contentString = "{\n" +, +                "    \"match_phrase_prefix\" : {\n" +, +                "        \"" + matchPhrasePrefixQuery.fieldName() + "\" : \"" + matchPhrasePrefixQuery.value() + "\"\n" +, +                "    }\n" +, +                "}";, +        alternateVersions.put(contentString, matchPhrasePrefixQuery);, +        return alternateVersions;, +    }, +, +    @Override, +            fail("field must not be non-null");, +            assertEquals("[match_phrase_prefix] requires fieldName", ex.getMessage());, +            assertEquals("[match_phrase_prefix] requires query value", ex.getMessage());, +, +, +    public void testParseFailsWithMultipleFields() throws IOException {, +        String json = "{\n" +, +                "  \"match_phrase_prefix\" : {\n" +, +                "    \"message1\" : {\n" +, +                "      \"query\" : \"this is a test\"\n" +, +                "    },\n" +, +                "    \"message2\" : {\n" +, +                "      \"query\" : \"this is a test\"\n" +, +                "    }\n" +, +                "  }\n" +, +                "}";, +, +        try {, +            parseQuery(json);, +            fail("parseQuery should have failed");, +        } catch(ParsingException e) {, +            assertEquals("[match_phrase_prefix] query doesn't support multiple fields, found [message1] and [message2]", e.getMessage());, +        }, +    }]