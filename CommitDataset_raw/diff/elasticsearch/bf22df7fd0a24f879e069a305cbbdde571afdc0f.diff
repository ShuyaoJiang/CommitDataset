[+++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.CharsRef;, +    private final CharsRef spare = new CharsRef();, +, +        final int charCount = readVInt();, +        spare.offset = 0;, +        spare.length = 0;, +        spare.grow(charCount);, +        int c = 0;, +        while (spare.length < charCount) {, +                    spare.chars[spare.length++] = (char) c;, +                    spare.chars[spare.length++] = (char) ((c & 0x1F) << 6 | readByte() & 0x3F);, +                    spare.chars[spare.length++] = (char) ((c & 0x0F) << 12 | (readByte() & 0x3F) << 6 | (readByte() & 0x3F) << 0);, +        return spare.toString();, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.CharsRef;, +    private final CharsRef spare = new CharsRef();, +, +        final int charCount = readVInt();, +        spare.offset = 0;, +        spare.length = 0;, +        spare.grow(charCount);, +        int c = 0;, +        while (spare.length < charCount) {, +                    spare.chars[spare.length++] = (char) c;, +                    spare.chars[spare.length++] = (char) ((c & 0x1F) << 6 | readByte() & 0x3F);, +                    spare.chars[spare.length++] = (char) ((c & 0x0F) << 12 | (readByte() & 0x3F) << 6 | (readByte() & 0x3F) << 0);, +        return spare.toString();, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +import org.apache.lucene.util.UnicodeUtil;, +    private final BytesRef spare = new BytesRef();, +, +        if (!text.hasBytes()) {, +            final String string = text.string();, +            UnicodeUtil.UTF16toUTF8(string, 0, string.length(), spare);, +            writeInt(spare.length);, +            write(spare.bytes, spare.offset, spare.length);]