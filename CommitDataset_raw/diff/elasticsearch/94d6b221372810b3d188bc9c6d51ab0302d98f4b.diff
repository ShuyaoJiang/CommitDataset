[+++ b/build.gradle, +    buildTools, +    buildTools 'de.thetaphi:forbiddenapis:2.0', +    buildTools 'org.apache.rat:apache-rat:0.11', +++ b/build.gradle, +    buildTools, +    buildTools 'de.thetaphi:forbiddenapis:2.0', +    buildTools 'org.apache.rat:apache-rat:0.11', +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/LicenseHeadersTask.groovy, +/*, + * Licensed to Elasticsearch under one or more contributor, + * license agreements. See the NOTICE file distributed with, + * this work for additional information regarding copyright, + * ownership. Elasticsearch licenses this file to you under, + * the Apache License, Version 2.0 (the "License"); you may, + * not use this file except in compliance with the License., + * You may obtain a copy of the License at, + *, + *    http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing,, + * software distributed under the License is distributed on an, + * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY, + * KIND, either express or implied.  See the License for the, + * specific language governing permissions and limitations, + * under the License., + */, +package org.elasticsearch.gradle.precommit, +, +import java.nio.file.Files, +, +import org.gradle.api.DefaultTask, +import org.gradle.api.tasks.SourceSet, +import org.gradle.api.tasks.TaskAction, +, +import groovy.xml.NamespaceBuilder, +import groovy.xml.NamespaceBuilderSupport, +, +/**, + * Checks files for license headers., + * <p>, + * This is a port of the apache lucene check, + */, +public class LicenseHeadersTask extends DefaultTask {, +, +    LicenseHeadersTask() {, +        description = "Checks sources for missing, incorrect, or unacceptable license headers", +    }, +, +    @TaskAction, +    public void check() {, +        // load rat tasks, +        AntBuilder ant = new AntBuilder(), +        ant.typedef(resource:  "org/apache/rat/anttasks/antlib.xml",, +                    uri:       "antlib:org.apache.rat.anttasks",, +                    classpath: project.configurations.buildTools.asPath), +        NamespaceBuilderSupport rat = NamespaceBuilder.newInstance(ant, "antlib:org.apache.rat.anttasks"), +, +        // create a file for the log to go to under reports/, +        File reportDir = new File(project.buildDir, "reports/licenseHeaders"), +        reportDir.mkdirs(), +        File reportFile = new File(reportDir, "rat.log"), +        Files.deleteIfExists(reportFile.toPath()), +                     , +        // run rat, going to the file, +        rat.report(reportFile: reportFile.absolutePath, addDefaultLicenseMatchers: true) {, +               // checks all the java sources (allJava), +               for (SourceSet set : project.sourceSets) {, +                   for (File dir : set.allJava.srcDirs) {, +                       ant.fileset(dir: dir), +                   }, +               }, +, +               // BSD 4-clause stuff (is disallowed below), +               substringMatcher(licenseFamilyCategory: "BSD4 ",, +                                licenseFamilyName:     "Original BSD License (with advertising clause)") {, +                   pattern(substring: "All advertising materials"), +               }, +, +               // BSD-like stuff, +               substringMatcher(licenseFamilyCategory: "BSD  ",, +                                licenseFamilyName:     "Modified BSD License") {, +                   // brics automaton, +                   pattern(substring: "Copyright (c) 2001-2009 Anders Moeller"), +                   // snowball, +                   pattern(substring: "Copyright (c) 2001, Dr Martin Porter"), +                   // UMASS kstem, +                   pattern(substring: "THIS SOFTWARE IS PROVIDED BY UNIVERSITY OF MASSACHUSETTS AND OTHER CONTRIBUTORS"), +                   // Egothor, +                   pattern(substring: "Egothor Software License version 1.00"), +                   // JaSpell, +                   pattern(substring: "Copyright (c) 2005 Bruno Martins"), +                   // d3.js, +                   pattern(substring: "THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS"), +                   // highlight.js, +                   pattern(substring: "THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS"), +               }, +, +               // MIT-like, +               substringMatcher(licenseFamilyCategory: "MIT  ",]