[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +import org.elasticsearch.common.collect.ImmutableMap;, +import org.elasticsearch.common.collect.ImmutableSet;, +import org.elasticsearch.common.collect.Lists;, +import org.elasticsearch.common.collect.MapBuilder;, +import org.elasticsearch.common.collect.Sets;, +import org.elasticsearch.common.collect.UnmodifiableIterator;, +import org.elasticsearch.common.xcontent.ToXContent;, +import org.elasticsearch.common.xcontent.XContentBuilder;, +import org.elasticsearch.common.xcontent.XContentFactory;, +import org.elasticsearch.common.xcontent.XContentParser;, +import org.elasticsearch.common.xcontent.XContentType;, +import java.util.Arrays;, +import java.util.List;, +import java.util.Map;, +import java.util.Set;, +import static org.elasticsearch.common.collect.Lists.*;, +    private final long version;, +    private MetaData(long version, ImmutableMap<String, IndexMetaData> indices, ImmutableMap<String, IndexTemplateMetaData> templates) {, +        this.version = version;, +    public long version() {, +        return this.version;, +    }, +, +        private long version;, +, +            this.version = metaData.version;, +        public Builder version(long version) {, +            this.version = version;, +            return this;, +        }, +, +            return new MetaData(version, indices.immutableMap(), templates.immutableMap());, +            builder.version = in.readLong();, +            out.writeLong(metaData.version);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +import org.elasticsearch.common.collect.ImmutableMap;, +import org.elasticsearch.common.collect.ImmutableSet;, +import org.elasticsearch.common.collect.Lists;, +import org.elasticsearch.common.collect.MapBuilder;, +import org.elasticsearch.common.collect.Sets;, +import org.elasticsearch.common.collect.UnmodifiableIterator;, +import org.elasticsearch.common.xcontent.ToXContent;, +import org.elasticsearch.common.xcontent.XContentBuilder;, +import org.elasticsearch.common.xcontent.XContentFactory;, +import org.elasticsearch.common.xcontent.XContentParser;, +import org.elasticsearch.common.xcontent.XContentType;, +import java.util.Arrays;, +import java.util.List;, +import java.util.Map;, +import java.util.Set;, +import static org.elasticsearch.common.collect.Lists.*;, +    private final long version;, +    private MetaData(long version, ImmutableMap<String, IndexMetaData> indices, ImmutableMap<String, IndexTemplateMetaData> templates) {, +        this.version = version;, +    public long version() {, +        return this.version;, +    }, +, +        private long version;, +, +            this.version = metaData.version;, +        public Builder version(long version) {, +            this.version = version;, +            return this;, +        }, +, +            return new MetaData(version, indices.immutableMap(), templates.immutableMap());, +            builder.version = in.readLong();, +            out.writeLong(metaData.version);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java, +import org.elasticsearch.cluster.metadata.MetaData;, +                        if (previousClusterState.metaData() != clusterState.metaData()) {, +                            builder.metaData(MetaData.builder().metaData(clusterState.metaData()).version(clusterState.metaData().version() + 1));, +                        }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +import org.elasticsearch.common.collect.ImmutableMap;, +import org.elasticsearch.common.collect.ImmutableSet;, +import org.elasticsearch.common.collect.Lists;, +import org.elasticsearch.common.collect.MapBuilder;, +import org.elasticsearch.common.collect.Sets;, +import org.elasticsearch.common.collect.UnmodifiableIterator;, +import org.elasticsearch.common.xcontent.ToXContent;, +import org.elasticsearch.common.xcontent.XContentBuilder;, +import org.elasticsearch.common.xcontent.XContentFactory;, +import org.elasticsearch.common.xcontent.XContentParser;, +import org.elasticsearch.common.xcontent.XContentType;, +import java.util.Arrays;, +import java.util.List;, +import java.util.Map;, +import java.util.Set;, +import static org.elasticsearch.common.collect.Lists.*;, +    private final long version;, +    private MetaData(long version, ImmutableMap<String, IndexMetaData> indices, ImmutableMap<String, IndexTemplateMetaData> templates) {, +        this.version = version;, +    public long version() {, +        return this.version;, +    }, +, +        private long version;]