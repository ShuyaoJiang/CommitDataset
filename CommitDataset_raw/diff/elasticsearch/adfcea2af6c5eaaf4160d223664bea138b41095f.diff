[+++ b/distribution/packages/src/common/scripts/preinst, +# Check for these at preinst time due to failures in postinst if they do not exist, +if [ -x "$JAVA_HOME/bin/java" ]; then, +    JAVA="$JAVA_HOME/bin/java", +else, +    JAVA=`which java`, +fi, +, +if [ -z "$JAVA" ]; then, +    echo "could not find java; set JAVA_HOME or ensure java is in PATH", +    exit 1, +fi, +, +++ b/distribution/packages/src/common/scripts/preinst, +# Check for these at preinst time due to failures in postinst if they do not exist, +if [ -x "$JAVA_HOME/bin/java" ]; then, +    JAVA="$JAVA_HOME/bin/java", +else, +    JAVA=`which java`, +fi, +, +if [ -z "$JAVA" ]; then, +    echo "could not find java; set JAVA_HOME or ensure java is in PATH", +    exit 1, +fi, +, +++ b/qa/vagrant/src/test/resources/packaging/tests/30_deb_package.bats, +@test "[DEB] temporarily remove java and ensure the install fails" {, +    move_java, +    run dpkg -i elasticsearch-oss-$(cat version).deb, +    output=$status, +    unmove_java, +    [ "$output" -eq 1 ], +}, +, +++ b/distribution/packages/src/common/scripts/preinst, +# Check for these at preinst time due to failures in postinst if they do not exist, +if [ -x "$JAVA_HOME/bin/java" ]; then, +    JAVA="$JAVA_HOME/bin/java", +else, +    JAVA=`which java`, +fi, +, +if [ -z "$JAVA" ]; then, +    echo "could not find java; set JAVA_HOME or ensure java is in PATH", +    exit 1, +fi, +, +++ b/qa/vagrant/src/test/resources/packaging/tests/30_deb_package.bats, +@test "[DEB] temporarily remove java and ensure the install fails" {, +    move_java, +    run dpkg -i elasticsearch-oss-$(cat version).deb, +    output=$status, +    unmove_java, +    [ "$output" -eq 1 ], +}, +, +++ b/qa/vagrant/src/test/resources/packaging/tests/40_rpm_package.bats, +@test "[RPM] temporarily remove java and ensure the install fails" {, +    move_java, +    run rpm -i elasticsearch-oss-$(cat version).rpm, +    output=$status, +    unmove_java, +    [ "$output" -eq 1 ], +}, +, +++ b/distribution/packages/src/common/scripts/preinst, +# Check for these at preinst time due to failures in postinst if they do not exist, +if [ -x "$JAVA_HOME/bin/java" ]; then, +    JAVA="$JAVA_HOME/bin/java", +else, +    JAVA=`which java`, +fi, +, +if [ -z "$JAVA" ]; then, +    echo "could not find java; set JAVA_HOME or ensure java is in PATH", +    exit 1, +fi, +, +++ b/qa/vagrant/src/test/resources/packaging/tests/30_deb_package.bats, +@test "[DEB] temporarily remove java and ensure the install fails" {, +    move_java, +    run dpkg -i elasticsearch-oss-$(cat version).deb, +    output=$status, +    unmove_java, +    [ "$output" -eq 1 ], +}, +, +++ b/qa/vagrant/src/test/resources/packaging/tests/40_rpm_package.bats, +@test "[RPM] temporarily remove java and ensure the install fails" {, +    move_java, +    run rpm -i elasticsearch-oss-$(cat version).rpm, +    output=$status, +    unmove_java, +    [ "$output" -eq 1 ], +}, +, +++ b/qa/vagrant/src/test/resources/packaging/utils/utils.bash, +    # there are some tests that move java temporarily, +    if [ ! -x "`command -v java.bak 2>/dev/null`" ]; then]