[+++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/110_field_collapsing.yml, +"field collapsing and rescore":, +, +  - skip:, +      version: " - 5.2.99", +      reason:  this uses a new API that has been added in 5.3, +, +  - do:, +      catch:      /cannot use \`collapse\` in conjunction with \`rescore\`/, +      search:, +        index: test, +        type:  test, +        body:, +          collapse: { field: numeric_group }, +          rescore:, +            window_size: 20, +            query:, +              rescore_query:, +                match_all: {}, +              query_weight: 1, +              rescore_query_weight: 2, +, +---, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/110_field_collapsing.yml, +"field collapsing and rescore":, +, +  - skip:, +      version: " - 5.2.99", +      reason:  this uses a new API that has been added in 5.3, +, +  - do:, +      catch:      /cannot use \`collapse\` in conjunction with \`rescore\`/, +      search:, +        index: test, +        type:  test, +        body:, +          collapse: { field: numeric_group }, +          rescore:, +            window_size: 20, +            query:, +              rescore_query:, +                match_all: {}, +              query_weight: 1, +              rescore_query_weight: 2, +, +---, +++ b/server/src/main/java/org/elasticsearch/search/collapse/CollapseBuilder.java, +        if (context.rescore() != null && context.rescore().isEmpty() == false) {, +            throw new SearchContextException(context, "cannot use `collapse` in conjunction with `rescore`");, +        }, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/110_field_collapsing.yml, +"field collapsing and rescore":, +, +  - skip:, +      version: " - 5.2.99", +      reason:  this uses a new API that has been added in 5.3, +, +  - do:, +      catch:      /cannot use \`collapse\` in conjunction with \`rescore\`/, +      search:, +        index: test, +        type:  test, +        body:, +          collapse: { field: numeric_group }, +          rescore:, +            window_size: 20, +            query:, +              rescore_query:, +                match_all: {}, +              query_weight: 1, +              rescore_query_weight: 2, +, +---, +++ b/server/src/main/java/org/elasticsearch/search/collapse/CollapseBuilder.java, +        if (context.rescore() != null && context.rescore().isEmpty() == false) {, +            throw new SearchContextException(context, "cannot use `collapse` in conjunction with `rescore`");, +        }, +++ b/server/src/main/java/org/elasticsearch/search/query/TopDocsCollectorContext.java, +                                                  boolean trackMaxScore) {, +        } else if (searchContext.collapse() != null) {, +            boolean trackScores = searchContext.sort() == null ? true : searchContext.trackScores();, +            int numDocs = Math.min(searchContext.from() + searchContext.size(), totalNumDocs);, +            return new CollapsingTopDocsCollectorContext(searchContext.collapse(),, +                searchContext.sort(), numDocs, trackScores);, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/110_field_collapsing.yml, +"field collapsing and rescore":, +, +  - skip:, +      version: " - 5.2.99", +      reason:  this uses a new API that has been added in 5.3, +, +  - do:, +      catch:      /cannot use \`collapse\` in conjunction with \`rescore\`/, +      search:, +        index: test, +        type:  test, +        body:, +          collapse: { field: numeric_group }, +          rescore:, +            window_size: 20]