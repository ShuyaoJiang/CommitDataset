[+++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.BytesRef;, +    public BytesRef readBytesRef() throws IOException {, +        int length = readVInt();, +        int offset = readVInt();, +        byte[] bytes = new byte[length];, +        readBytes(bytes, offset, length);, +        return new BytesRef(bytes, offset, length);, +    }, +, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.BytesRef;, +    public BytesRef readBytesRef() throws IOException {, +        int length = readVInt();, +        int offset = readVInt();, +        byte[] bytes = new byte[length];, +        readBytes(bytes, offset, length);, +        return new BytesRef(bytes, offset, length);, +    }, +, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +import org.apache.lucene.util.BytesRef;, +    public void writeBytesRef(BytesRef bytes) throws IOException {, +        if (bytes == null) {, +            writeVInt(0);, +            return;, +        }, +        writeVInt(bytes.length);, +        writeVInt(bytes.offset);, +        write(bytes.bytes, bytes.offset, bytes.length);, +    }, +, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.BytesRef;, +    public BytesRef readBytesRef() throws IOException {, +        int length = readVInt();, +        int offset = readVInt();, +        byte[] bytes = new byte[length];, +        readBytes(bytes, offset, length);, +        return new BytesRef(bytes, offset, length);, +    }, +, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +import org.apache.lucene.util.BytesRef;, +    public void writeBytesRef(BytesRef bytes) throws IOException {, +        if (bytes == null) {, +            writeVInt(0);, +            return;, +        }, +        writeVInt(bytes.length);, +        writeVInt(bytes.offset);, +        write(bytes.bytes, bytes.offset, bytes.length);, +    }, +, +++ b/src/main/java/org/elasticsearch/search/SearchService.java, +            context.searcher().dfSource(new CachedDfSource(context.searcher().getIndexReader(), request.dfs(), context.similarityService().defaultSearchSimilarity()));, +            context.searcher().dfSource(new CachedDfSource(context.searcher().getIndexReader(), request.dfs(), context.similarityService().defaultSearchSimilarity()));, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.BytesRef;, +    public BytesRef readBytesRef() throws IOException {, +        int length = readVInt();, +        int offset = readVInt();, +        byte[] bytes = new byte[length];, +        readBytes(bytes, offset, length);, +        return new BytesRef(bytes, offset, length);, +    }, +, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +import org.apache.lucene.util.BytesRef;, +    public void writeBytesRef(BytesRef bytes) throws IOException {, +        if (bytes == null) {, +            writeVInt(0);, +            return;, +        }, +        writeVInt(bytes.length);, +        writeVInt(bytes.offset);, +        write(bytes.bytes, bytes.offset, bytes.length);, +    }, +, +++ b/src/main/java/org/elasticsearch/search/SearchService.java, +            context.searcher().dfSource(new CachedDfSource(context.searcher().getIndexReader(), request.dfs(), context.similarityService().defaultSearchSimilarity()));, +            context.searcher().dfSource(new CachedDfSource(context.searcher().getIndexReader(), request.dfs(), context.similarityService().defaultSearchSimilarity()));, +++ b/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java, +import gnu.trove.map.TMap;, +import org.elasticsearch.common.trove.ExtTHashMap;, +        TMap<Term, TermStatistics> dfMap = new ExtTHashMap<Term, TermStatistics>(Constants.DEFAULT_CAPACITY, Constants.DEFAULT_LOAD_FACTOR);, +            for (int i = 0; i < result.termStatistics().length; i++) {, +                TermStatistics existing = dfMap.get(result.terms()[i]);, +                if (existing != null) {, +                    dfMap.put(result.terms()[i], new TermStatistics(existing.term(), existing.docFreq() + result.termStatistics()[i].docFreq(), existing.totalTermFreq() + result.termStatistics()[i].totalTermFreq()));, +                } else {, +                    dfMap.put(result.terms()[i], result.termStatistics()[i]);, +                }, +, +                                fieldDocs.fields[i] = new SortField(fieldDocs.fields[i].getField(), SortField.Type.STRING, fieldDocs.fields[i].getReverse());, +                    fieldDocs.fields[i] = new SortField(fieldDocs.fields[i].getField(), SortField.Type.STRING, fieldDocs.fields[i].getReverse());, +                if (fieldDocs.fields[i].getType() == SortField.Type.SCORE) {, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +import org.apache.lucene.util.BytesRef;, +    public BytesRef readBytesRef() throws IOException {]