[+++ b/core/src/main/java/org/elasticsearch/common/util/concurrent/EsThreadPoolExecutor.java, +        assert assertDefaultContext(r);, +    }, +, +    private boolean assertDefaultContext(Runnable r) {, +        try {, +        } catch (IllegalStateException ex) {, +            // sometimes we execute on a closed context and isDefaultContext doen't bypass the ensureOpen checks, +            // this must not trigger an exception here since we only assert if the default is restored and, +            // we don't really care if we are closed, +            if (contextHolder.isClosed() == false) {, +                throw ex;, +            }, +        }, +        return true;, +++ b/core/src/main/java/org/elasticsearch/common/util/concurrent/EsThreadPoolExecutor.java, +        assert assertDefaultContext(r);, +    }, +, +    private boolean assertDefaultContext(Runnable r) {, +        try {, +        } catch (IllegalStateException ex) {, +            // sometimes we execute on a closed context and isDefaultContext doen't bypass the ensureOpen checks, +            // this must not trigger an exception here since we only assert if the default is restored and, +            // we don't really care if we are closed, +            if (contextHolder.isClosed() == false) {, +                throw ex;, +            }, +        }, +        return true;, +++ b/core/src/main/java/org/elasticsearch/common/util/concurrent/ThreadContext.java, +    /**, +     * Returns <code>true</code> if the context is closed, otherwise <code>true</code>, +     */, +    boolean isClosed() {, +        return threadLocal.closed.get();, +    }, +]