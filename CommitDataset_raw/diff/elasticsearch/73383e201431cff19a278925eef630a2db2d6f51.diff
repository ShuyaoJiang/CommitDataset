[+++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +            return new CustomQueryWrappingFilter(query);, +        } else {, +}, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +            return new CustomQueryWrappingFilter(query);, +        } else {, +}, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader()  : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +            return new CustomQueryWrappingFilter(query);, +        } else {, +}, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader()  : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +            return new CustomQueryWrappingFilter(query);, +        } else {, +}, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader()  : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/CustomQueryWrappingFilter.java, +, +    /** @return Whether {@link CustomQueryWrappingFilter} should be used. */, +    public static boolean shouldUseCustomQueryWrappingFilter(Query query) {, +        if (query instanceof TopChildrenQuery || query instanceof ChildrenConstantScoreQuery, +                || query instanceof ChildrenQuery || query instanceof ParentConstantScoreQuery, +                || query instanceof ParentQuery) {, +            return true;, +        } else {, +            return false;, +        }, +    }, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +            return new CustomQueryWrappingFilter(query);, +        } else {, +}, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader()  : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/CustomQueryWrappingFilter.java, +, +    /** @return Whether {@link CustomQueryWrappingFilter} should be used. */, +    public static boolean shouldUseCustomQueryWrappingFilter(Query query) {, +        if (query instanceof TopChildrenQuery || query instanceof ChildrenConstantScoreQuery, +                || query instanceof ChildrenQuery || query instanceof ParentConstantScoreQuery, +                || query instanceof ParentQuery) {, +            return true;, +        } else {, +            return false;, +        }, +    }, +++ b/src/main/java/org/elasticsearch/index/search/child/ParentConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/query/QueryFilterParser.java, +import org.elasticsearch.index.search.child.CustomQueryWrappingFilter;, +        if (CustomQueryWrappingFilter.shouldUseCustomQueryWrappingFilter(query)) {, +            return new CustomQueryWrappingFilter(query);, +        } else {, +}, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader()  : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/CustomQueryWrappingFilter.java, +, +    /** @return Whether {@link CustomQueryWrappingFilter} should be used. */, +    public static boolean shouldUseCustomQueryWrappingFilter(Query query) {, +        if (query instanceof TopChildrenQuery || query instanceof ChildrenConstantScoreQuery, +                || query instanceof ChildrenQuery || query instanceof ParentConstantScoreQuery, +                || query instanceof ParentQuery) {, +            return true;, +        } else {, +            return false;, +        }, +    }, +++ b/src/main/java/org/elasticsearch/index/search/child/ParentConstantScoreQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();, +++ b/src/main/java/org/elasticsearch/index/search/child/ParentQuery.java, +            assert rewriteIndexReader == searcher.getIndexReader() : "not equal, rewriteIndexReader=" + rewriteIndexReader + " searcher.getIndexReader()=" + searcher.getIndexReader();]