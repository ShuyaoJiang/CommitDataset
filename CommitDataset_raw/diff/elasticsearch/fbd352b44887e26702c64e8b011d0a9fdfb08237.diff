[+++ b/src/main/java/org/elasticsearch/common/util/concurrent/BaseFuture.java, +         * return {@code false} after waiting for the state to be set to a valid, +         * final state ({@link #COMPLETED} or {@link #CANCELLED})., +        private boolean complete(@Nullable V v, @Nullable Throwable t,, +                                 int finalState) {, +            boolean doCompletion = compareAndSetState(RUNNING, COMPLETING);, +            if (doCompletion) {, +                // If this thread successfully transitioned to COMPLETING, set the value, +                // and exception and then release to the final state., +            } else if (getState() == COMPLETING) {, +                // If some other thread is currently completing the future, block until, +                // they are done so we can guarantee completion., +                acquireShared(-1);, +            return doCompletion;]