[+++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +            translog.trimUnreferencedReaders();, +            // Here we don't have to trim translog because snapshotting an index commit, +            // does not lock translog or prevents unreferenced files from trimming., +++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +            translog.trimUnreferencedReaders();, +            // Here we don't have to trim translog because snapshotting an index commit, +            // does not lock translog or prevents unreferenced files from trimming., +++ b/server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +import org.elasticsearch.test.IndexSettingsModule;, +        final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings("test",, +            Settings.builder().put(defaultSettings.getSettings()), +                .put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), -1), +                .put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), -1).build());, +        try (Store store = createStore();, +             InternalEngine engine =, +                 createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null, null, globalCheckpoint::get))) {, +                if (rarely()) {, +            assertThat(engine.estimateTranslogOperationsFromMinSeq(0L), equalTo(0));, +++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +            translog.trimUnreferencedReaders();, +            // Here we don't have to trim translog because snapshotting an index commit, +            // does not lock translog or prevents unreferenced files from trimming., +++ b/server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +import org.elasticsearch.test.IndexSettingsModule;, +        final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings("test",, +            Settings.builder().put(defaultSettings.getSettings()), +                .put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), -1), +                .put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), -1).build());, +        try (Store store = createStore();, +             InternalEngine engine =, +                 createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null, null, globalCheckpoint::get))) {, +                if (rarely()) {, +            assertThat(engine.estimateTranslogOperationsFromMinSeq(0L), equalTo(0));, +++ b/server/src/test/java/org/elasticsearch/indices/recovery/RecoveryTests.java]