[+++ b/src/test/java/org/elasticsearch/test/integration/search/basic/SearchWhileCreatingIndexTests.java, +import org.elasticsearch.action.admin.cluster.state.ClusterStateResponse;, +import org.elasticsearch.action.admin.cluster.tasks.PendingClusterTasksResponse;, +import org.elasticsearch.cluster.service.PendingClusterTask;, +    public void searchWhileCreatingIndex() throws Throwable {, +        Thread backgroundThread;, +        final Throwable[] threadException = new Throwable[1];, +        backgroundThread = new Thread(new Runnable() {, +            @Override, +            public void run() {, +                try {, +                        logger.info("Running iteration {}", i);, +                } catch (Throwable t) {, +                    threadException[0] = t;, +                }, +            }, +        });, +        backgroundThread.setDaemon(true);, +        backgroundThread.start();, +        backgroundThread.join(30 * 60 * 1000);, +        if (threadException[0] != null) {, +            throw threadException[0];, +        }, +        if (backgroundThread.isAlive()) {, +            logger.error("Background thread hanged. Dumping cluster info");, +            ClusterStateResponse clusterStateResponse = client().admin().cluster().prepareState().get();, +            logger.info("ClusterState: {}", clusterStateResponse.getState());, +            PendingClusterTasksResponse pendingTasks = client().admin().cluster().preparePendingClusterTasks().get();, +            logger.info("Pending tasks:");, +            for (PendingClusterTask task : pendingTasks) {, +                logger.info("Task: priority: {} source: {} Time in queue (ms): {}", task.getPriority(), task.getSource(), task.timeInQueueInMillis());, +            }, +            fail("Background thread didn't finish within 30 minutes");, +        }, +        logger.info("done");, +, +]