[+++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java, +                builder.addAggregator(in.readNamedWriteable(AggregatorBuilder.class));, +                builder.addPipelineAggregator(in.readNamedWriteable(PipelineAggregatorBuilder.class));, +            for (AggregatorBuilder<?> builder : aggregatorBuilders) {, +                out.writeNamedWriteable(builder);, +            for (PipelineAggregatorBuilder<?> builder : pipelineAggregatorBuilders) {, +                out.writeNamedWriteable(builder);, +++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java, +                builder.addAggregator(in.readNamedWriteable(AggregatorBuilder.class));, +                builder.addPipelineAggregator(in.readNamedWriteable(PipelineAggregatorBuilder.class));, +            for (AggregatorBuilder<?> builder : aggregatorBuilders) {, +                out.writeNamedWriteable(builder);, +            for (PipelineAggregatorBuilder<?> builder : pipelineAggregatorBuilders) {, +                out.writeNamedWriteable(builder);, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/BaseAggregationTestCase.java, +            output.writeNamedWriteable(testAgg);, +                AggregatorBuilder<?> deserialized = in.readNamedWriteable(AggregatorBuilder.class);]