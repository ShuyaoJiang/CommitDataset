[+++ b/core/src/main/java/org/elasticsearch/common/cli/CliToolConfig.java, +++ b/core/src/main/java/org/elasticsearch/common/cli/CliToolConfig.java, +++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +                throw new UserError(ExitCodes.IO_ERROR, "Invalid checksum file at " + checksumUrl);, +            throw new UserError(ExitCodes.IO_ERROR, "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +            throw new UserError(ExitCodes.DATA_ERROR, "`elasticsearch` directory is missing in the plugin zip");, +            throw new UserError(ExitCodes.USAGE, "plugin '" + info.getName() + "' cannot be installed like this, it is a system module");, +                throw new UserError(ExitCodes.USAGE, "plugin directory " + destination.toAbsolutePath() + " already exists. To update the plugin, uninstall it first using 'remove " + info.getName() + "' command");, +            throw new UserError(ExitCodes.IO_ERROR, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in bin dir for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserError(ExitCodes.IO_ERROR, "config in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in config dir for plugin " + info.getName());, +++ b/core/src/main/java/org/elasticsearch/common/cli/CliToolConfig.java, +++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +                throw new UserError(ExitCodes.IO_ERROR, "Invalid checksum file at " + checksumUrl);, +            throw new UserError(ExitCodes.IO_ERROR, "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +            throw new UserError(ExitCodes.DATA_ERROR, "`elasticsearch` directory is missing in the plugin zip");, +            throw new UserError(ExitCodes.USAGE, "plugin '" + info.getName() + "' cannot be installed like this, it is a system module");, +                throw new UserError(ExitCodes.USAGE, "plugin directory " + destination.toAbsolutePath() + " already exists. To update the plugin, uninstall it first using 'remove " + info.getName() + "' command");, +            throw new UserError(ExitCodes.IO_ERROR, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in bin dir for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserError(ExitCodes.IO_ERROR, "config in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in config dir for plugin " + info.getName());, +++ b/core/src/main/java/org/elasticsearch/plugins/ListPluginsCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +++ b/core/src/main/java/org/elasticsearch/common/cli/CliToolConfig.java, +++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +                throw new UserError(ExitCodes.IO_ERROR, "Invalid checksum file at " + checksumUrl);, +            throw new UserError(ExitCodes.IO_ERROR, "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +            throw new UserError(ExitCodes.DATA_ERROR, "`elasticsearch` directory is missing in the plugin zip");, +            throw new UserError(ExitCodes.USAGE, "plugin '" + info.getName() + "' cannot be installed like this, it is a system module");, +                throw new UserError(ExitCodes.USAGE, "plugin directory " + destination.toAbsolutePath() + " already exists. To update the plugin, uninstall it first using 'remove " + info.getName() + "' command");, +            throw new UserError(ExitCodes.IO_ERROR, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in bin dir for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserError(ExitCodes.IO_ERROR, "config in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in config dir for plugin " + info.getName());, +++ b/core/src/main/java/org/elasticsearch/plugins/ListPluginsCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +++ b/core/src/main/java/org/elasticsearch/plugins/RemovePluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +++ b/core/src/main/java/org/elasticsearch/common/cli/CliToolConfig.java, +++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +                throw new UserError(ExitCodes.IO_ERROR, "Invalid checksum file at " + checksumUrl);, +            throw new UserError(ExitCodes.IO_ERROR, "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +            throw new UserError(ExitCodes.DATA_ERROR, "`elasticsearch` directory is missing in the plugin zip");, +            throw new UserError(ExitCodes.USAGE, "plugin '" + info.getName() + "' cannot be installed like this, it is a system module");, +                throw new UserError(ExitCodes.USAGE, "plugin directory " + destination.toAbsolutePath() + " already exists. To update the plugin, uninstall it first using 'remove " + info.getName() + "' command");, +            throw new UserError(ExitCodes.IO_ERROR, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in bin dir for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserError(ExitCodes.IO_ERROR, "config in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in config dir for plugin " + info.getName());, +++ b/core/src/main/java/org/elasticsearch/plugins/ListPluginsCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +++ b/core/src/main/java/org/elasticsearch/plugins/RemovePluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +++ b/core/src/test/java/org/elasticsearch/plugins/PluginCliTests.java, +import java.io.IOException;, +import java.nio.file.Path;, +, +import org.elasticsearch.cli.Command;, +import org.elasticsearch.cli.CommandTestCase;, +import org.elasticsearch.common.settings.Settings;, +import org.elasticsearch.env.Environment;, +import org.junit.Before;, +public class PluginCliTests extends CommandTestCase {, +, +    // the home dir for each test to use, +    Path homeDir;, +, +    // settings used to create an Environment for tools, +    Settings.Builder settingsBuilder;, +, +    @Before, +    public void setupHome() {, +        homeDir = createTempDir();, +        settingsBuilder = Settings.builder(), +            .put("path.home", homeDir);, +    }, +, +    @Override, +    protected Command newCommand() {, +        return new PluginCli(new Environment(settingsBuilder.build()));, +    }, +, +, +++ b/core/src/main/java/org/elasticsearch/common/cli/CliToolConfig.java, +++ b/core/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java, +    protected void execute(Terminal terminal, OptionSet options) throws Exception {, +                throw new UserError(ExitCodes.IO_ERROR, "Invalid checksum file at " + checksumUrl);, +            throw new UserError(ExitCodes.IO_ERROR, "SHA1 mismatch, expected " + expectedChecksum + " but got " + gotChecksum);, +            throw new UserError(ExitCodes.DATA_ERROR, "`elasticsearch` directory is missing in the plugin zip");, +            throw new UserError(ExitCodes.USAGE, "plugin '" + info.getName() + "' cannot be installed like this, it is a system module");, +                throw new UserError(ExitCodes.USAGE, "plugin directory " + destination.toAbsolutePath() + " already exists. To update the plugin, uninstall it first using 'remove " + info.getName() + "' command");, +            throw new UserError(ExitCodes.IO_ERROR, "bin in plugin " + info.getName() + " is not a directory");, +                    throw new UserError(ExitCodes.DATA_ERROR, "Directories not allowed in bin dir for plugin " + info.getName() + ", found " + srcFile.getFileName());, +            throw new UserError(ExitCodes.IO_ERROR, "config in plugin " + info.getName() + " is not a directory");]