[+++ b/elasticsearch/src/test/java/org/elasticsearch/integration/AbstractPrivilegeTestCase.java, +import static org.hamcrest.Matchers.containsString;, +, +    protected void assertBodyHasAccessIsDenied(String user, String method, String uri, String body) throws IOException {, +        assertBodyHasAccessIsDenied(user, method, uri, body, new HashMap<>());, +    }, +, +    /**, +     * Like {@code assertAcessIsDenied}, but for _bulk requests since the entire, +     * request will not be failed, just the individual ones, +     */, +    protected void assertBodyHasAccessIsDenied(String user, String method, String uri, String body,, +                                               Map<String, String> params) throws IOException {, +        Response resp = getRestClient().performRequest(method, uri, params, entityOrNull(body),, +                new BasicHeader(UsernamePasswordToken.BASIC_AUTH_HEADER,, +                        UsernamePasswordToken.basicAuthHeaderValue(user, new SecuredString("passwd".toCharArray()))));, +        StatusLine statusLine = resp.getStatusLine();, +        assertThat(statusLine.getStatusCode(), is(200));, +        HttpEntity bodyEntity = resp.getEntity();, +        String bodyStr = EntityUtils.toString(bodyEntity);, +        assertThat(bodyStr, containsString("unauthorized for user [" + user + "]"));, +    }, +, +++ b/elasticsearch/src/test/java/org/elasticsearch/integration/AbstractPrivilegeTestCase.java, +import static org.hamcrest.Matchers.containsString;, +, +    protected void assertBodyHasAccessIsDenied(String user, String method, String uri, String body) throws IOException {, +        assertBodyHasAccessIsDenied(user, method, uri, body, new HashMap<>());, +    }, +, +    /**, +     * Like {@code assertAcessIsDenied}, but for _bulk requests since the entire, +     * request will not be failed, just the individual ones, +     */, +    protected void assertBodyHasAccessIsDenied(String user, String method, String uri, String body,, +                                               Map<String, String> params) throws IOException {, +        Response resp = getRestClient().performRequest(method, uri, params, entityOrNull(body),, +                new BasicHeader(UsernamePasswordToken.BASIC_AUTH_HEADER,, +                        UsernamePasswordToken.basicAuthHeaderValue(user, new SecuredString("passwd".toCharArray()))));, +        StatusLine statusLine = resp.getStatusLine();, +        assertThat(statusLine.getStatusCode(), is(200));, +        HttpEntity bodyEntity = resp.getEntity();, +        String bodyStr = EntityUtils.toString(bodyEntity);, +        assertThat(bodyStr, containsString("unauthorized for user [" + user + "]"));, +    }, +, +++ b/elasticsearch/src/test/java/org/elasticsearch/integration/IndexPrivilegeTests.java, +        assertBodyHasAccessIsDenied("u11", "PUT",, +        assertAccessIsAllowed("u13", "PUT", "/a/foo/_bulk", "{ \"index\" : { \"_id\" : \"123\" } }\n{ \"foo\" : \"bar\" }\n");, +        assertBodyHasAccessIsDenied("u13", "PUT", "/b/foo/_bulk", "{ \"index\" : { \"_id\" : \"123\" } }\n{ \"foo\" : \"bar\" }\n");]