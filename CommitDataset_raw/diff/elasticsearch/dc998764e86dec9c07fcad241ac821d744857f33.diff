[+++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java, +        return clusterService.state().nodes().isLocalNodeElectedMaster();, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java, +        return clusterService.state().nodes().isLocalNodeElectedMaster();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/Exporters.java, +            if (exporter.masterOnly() && !clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java, +        return clusterService.state().nodes().isLocalNodeElectedMaster();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/Exporters.java, +            if (exporter.masterOnly() && !clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/local/LocalExporter.java, +        if (!clusterService.localNode().isMasterNode()) {, +        if (clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java, +        return clusterService.state().nodes().isLocalNodeElectedMaster();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/Exporters.java, +            if (exporter.masterOnly() && !clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/local/LocalExporter.java, +        if (!clusterService.localNode().isMasterNode()) {, +        if (clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/test/java/org/elasticsearch/marvel/agent/collector/node/NodeStatsCollectorTests.java, +                    equalTo(internalCluster().getInstance(ClusterService.class, node).localNode().getId()));, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java, +        return clusterService.state().nodes().isLocalNodeElectedMaster();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/Exporters.java, +            if (exporter.masterOnly() && !clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/local/LocalExporter.java, +        if (!clusterService.localNode().isMasterNode()) {, +        if (clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/test/java/org/elasticsearch/marvel/agent/collector/node/NodeStatsCollectorTests.java, +                    equalTo(internalCluster().getInstance(ClusterService.class, node).localNode().getId()));, +++ b/elasticsearch/x-pack/marvel/src/test/java/org/elasticsearch/marvel/agent/exporter/ExportersTests.java, +        when(localNode.isMasterNode()).thenReturn(true);, +        when(localNode.isMasterNode()).thenReturn(false);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java, +        return clusterService.state().nodes().isLocalNodeElectedMaster();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/Exporters.java, +            if (exporter.masterOnly() && !clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/exporter/local/LocalExporter.java, +        if (!clusterService.localNode().isMasterNode()) {, +        if (clusterService.localNode().isMasterNode()) {, +++ b/elasticsearch/x-pack/marvel/src/test/java/org/elasticsearch/marvel/agent/collector/node/NodeStatsCollectorTests.java, +                    equalTo(internalCluster().getInstance(ClusterService.class, node).localNode().getId()));, +++ b/elasticsearch/x-pack/marvel/src/test/java/org/elasticsearch/marvel/agent/exporter/ExportersTests.java, +        when(localNode.isMasterNode()).thenReturn(true);, +        when(localNode.isMasterNode()).thenReturn(false);, +++ b/elasticsearch/x-pack/marvel/src/test/java/org/elasticsearch/marvel/agent/resolver/cluster/ClusterStateTests.java, +                .setQuery(matchQuery("cluster_state.nodes." + nodes.getMasterNodeId() + ".name",, +                        nodes.getMasterNode().getName())).get(), 0L);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/NoMasterNodeIT.java, +                    assertThat("Node [" + state.nodes().getLocalNode() + "] should have a NO_MASTER_BLOCK",, +++ b/elasticsearch/x-pack/license-plugin/src/main/java/org/elasticsearch/license/plugin/core/LicensesService.java, +        if (DiscoveryNode.isMasterNode(settings)) {, +                && clusterState.nodes().getMasterNode() != null) {, +        DiscoveryNode masterNode = currentState.nodes().getMasterNode();, +++ b/elasticsearch/x-pack/marvel/src/main/java/org/elasticsearch/marvel/agent/collector/AbstractCollector.java]