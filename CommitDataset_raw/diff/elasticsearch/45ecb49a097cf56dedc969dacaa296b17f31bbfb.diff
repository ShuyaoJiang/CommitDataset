[+++ b/src/test/java/org/elasticsearch/recovery/RelocationTests.java, +        final CountDownLatch unassignedShardsAfterReplicasAssigned = new CountDownLatch(1);, +            internalCluster().getInstance(ClusterService.class, node1).addLast(new ClusterStateListener() {, +            internalCluster().getInstance(ClusterService.class, master).addLast(new ClusterStateListener() {, +                @Override, +                public void clusterChanged(ClusterChangedEvent event) {, +                    if (event.state().routingNodes().hasUnassigned() && allReplicasAssigned.getCount() == 0) {, +                        unassignedShardsAfterReplicasAssigned.countDown();, +                    }, +                }, +            });, +, +            unassignedShardsAfterReplicasAssigned.countDown();]