[+++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java, +        public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java, +        public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java, +    public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +                listener.afterIndexShardClosed(shardId, indexShard);, +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java, +        public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java, +    public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +                listener.afterIndexShardClosed(shardId, indexShard);, +++ b/src/test/java/org/apache/lucene/util/AbstractRandomizedTest.java, +    /** MockFSDirectoryService sets this: */, +    public static boolean checkIndexFailed;, +, +        checkIndexFailed = false;, +        assertFalse("at least one shard failed CheckIndex", checkIndexFailed);, +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java, +        public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java, +    public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +                listener.afterIndexShardClosed(shardId, indexShard);, +++ b/src/test/java/org/apache/lucene/util/AbstractRandomizedTest.java, +    /** MockFSDirectoryService sets this: */, +    public static boolean checkIndexFailed;, +, +        checkIndexFailed = false;, +        assertFalse("at least one shard failed CheckIndex", checkIndexFailed);, +++ b/src/test/java/org/elasticsearch/cluster/ack/AckTests.java, +import org.elasticsearch.test.store.MockFSDirectoryService;, +import com.carrotsearch.hppc.cursors.ObjectObjectCursor;, +import com.google.common.base.Predicate;, +import com.google.common.collect.ImmutableList;, +        // TODO: this test fails CheckIndex test for some reason ... seems like the index is being deleted while we run CheckIndex??, +        assertAcked(client().admin().indices().prepareCreate("test").setSettings(, +                    ImmutableSettings.settingsBuilder(), +                    // Never run CheckIndex in the end:, +                    .put(MockFSDirectoryService.CHECK_INDEX_ON_CLOSE, false).build()));, +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java, +        public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java, +    public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +                listener.afterIndexShardClosed(shardId, indexShard);, +++ b/src/test/java/org/apache/lucene/util/AbstractRandomizedTest.java, +    /** MockFSDirectoryService sets this: */, +    public static boolean checkIndexFailed;, +, +        checkIndexFailed = false;, +        assertFalse("at least one shard failed CheckIndex", checkIndexFailed);, +++ b/src/test/java/org/elasticsearch/cluster/ack/AckTests.java, +import org.elasticsearch.test.store.MockFSDirectoryService;, +import com.carrotsearch.hppc.cursors.ObjectObjectCursor;, +import com.google.common.base.Predicate;, +import com.google.common.collect.ImmutableList;, +        // TODO: this test fails CheckIndex test for some reason ... seems like the index is being deleted while we run CheckIndex??, +        assertAcked(client().admin().indices().prepareCreate("test").setSettings(, +                    ImmutableSettings.settingsBuilder(), +                    // Never run CheckIndex in the end:, +                    .put(MockFSDirectoryService.CHECK_INDEX_ON_CLOSE, false).build()));, +++ b/src/test/java/org/elasticsearch/index/store/CorruptedFileTest.java, +                // This does corrupt files on the replica, so we can't check:, +                .put(MockFSDirectoryService.CHECK_INDEX_ON_CLOSE, false), +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        indicesLifecycle.afterIndexShardClosed(sId, indexShard);, +++ b/src/main/java/org/elasticsearch/indices/IndicesLifecycle.java, +        public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +++ b/src/main/java/org/elasticsearch/indices/InternalIndicesLifecycle.java, +    public void afterIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard) {, +                listener.afterIndexShardClosed(shardId, indexShard);, +++ b/src/test/java/org/apache/lucene/util/AbstractRandomizedTest.java, +    /** MockFSDirectoryService sets this: */, +    public static boolean checkIndexFailed;, +, +        checkIndexFailed = false;, +        assertFalse("at least one shard failed CheckIndex", checkIndexFailed);, +++ b/src/test/java/org/elasticsearch/cluster/ack/AckTests.java, +import org.elasticsearch.test.store.MockFSDirectoryService;, +import com.carrotsearch.hppc.cursors.ObjectObjectCursor;, +import com.google.common.base.Predicate;, +import com.google.common.collect.ImmutableList;, +        // TODO: this test fails CheckIndex test for some reason ... seems like the index is being deleted while we run CheckIndex??, +        assertAcked(client().admin().indices().prepareCreate("test").setSettings(, +                    ImmutableSettings.settingsBuilder(), +                    // Never run CheckIndex in the end:, +                    .put(MockFSDirectoryService.CHECK_INDEX_ON_CLOSE, false).build()));, +++ b/src/test/java/org/elasticsearch/index/store/CorruptedFileTest.java, +                // This does corrupt files on the replica, so we can't check:]