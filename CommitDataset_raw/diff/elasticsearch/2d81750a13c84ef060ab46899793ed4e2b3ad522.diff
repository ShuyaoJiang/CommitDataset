[+++ b/core/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java, +import java.util.Objects;, +        Objects.requireNonNull(threadContext, "Cannot register a null ThreadContext");, +++ b/core/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java, +import java.util.Objects;, +        Objects.requireNonNull(threadContext, "Cannot register a null ThreadContext");, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESTestCase.java, +        assertNull("Thread context initialized twice", threadContext);, +        // We check threadContext != null rather than enableWarningsCheck(), +        // because after methods are still called in the event that before, +        // methods failed, in which case threadContext might not have been, +        // initialized, +        if (threadContext != null) {, +            threadContext = null;]