[+++ b/marvel/src/test/java/org/elasticsearch/marvel/agent/collector/indices/IndexStatsCollectorTests.java, +import com.google.common.collect.ImmutableSet;, +import org.elasticsearch.cluster.block.ClusterBlock;, +import org.elasticsearch.common.unit.TimeValue;, +        waitForNoBlocksOnNode();, +, +        waitForNoBlocksOnNode();, +, +        waitForNoBlocksOnNode();, +, +, +    public void waitForNoBlocksOnNode() throws InterruptedException {, +        final long start = System.currentTimeMillis();, +        final TimeValue timeout = TimeValue.timeValueSeconds(30);, +        ImmutableSet<ClusterBlock> blocks;, +        do {, +            blocks = client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState().blocks().global();, +        }, +        while (!blocks.isEmpty() && (System.currentTimeMillis() - start) < timeout.millis());, +        assertTrue(blocks.isEmpty());, +    }]