[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +public class ScriptFieldsFunction implements FieldsFunction {, +    final Object script;, +    final DocMap docMap;, +        this.docMap = new DocMap(cachedFieldData.get().get(), mapperService, fieldDataCache);, +        docMap.setNextReader(reader);, +        docMap.setNextDocId(docId);, +        vars.put("doc", docMap);, +    static class DocMap implements Map {, +, +        private final Map<String, FieldData> localCacheFieldData;, +, +        private final MapperService mapperService;, +, +        private final FieldDataCache fieldDataCache;, +, +        private IndexReader reader;, +, +        private int docId;, +, +        DocMap(Map<String, FieldData> localCacheFieldData, MapperService mapperService, FieldDataCache fieldDataCache) {, +            this.localCacheFieldData = localCacheFieldData;, +            this.mapperService = mapperService;, +            this.fieldDataCache = fieldDataCache;, +        }, +, +        public void setNextReader(IndexReader reader) {, +            this.reader = reader;, +            localCacheFieldData.clear();, +        }, +, +        public void setNextDocId(int docId) {, +            this.docId = docId;, +        }, +, +}, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +public class ScriptFieldsFunction implements FieldsFunction {, +    final Object script;, +    final DocMap docMap;, +        this.docMap = new DocMap(cachedFieldData.get().get(), mapperService, fieldDataCache);, +        docMap.setNextReader(reader);, +        docMap.setNextDocId(docId);, +        vars.put("doc", docMap);, +    static class DocMap implements Map {, +, +        private final Map<String, FieldData> localCacheFieldData;, +, +        private final MapperService mapperService;, +, +        private final FieldDataCache fieldDataCache;, +, +        private IndexReader reader;, +, +        private int docId;, +, +        DocMap(Map<String, FieldData> localCacheFieldData, MapperService mapperService, FieldDataCache fieldDataCache) {, +            this.localCacheFieldData = localCacheFieldData;, +            this.mapperService = mapperService;, +            this.fieldDataCache = fieldDataCache;, +        }, +, +        public void setNextReader(IndexReader reader) {, +            this.reader = reader;, +            localCacheFieldData.clear();, +        }, +, +        public void setNextDocId(int docId) {, +            this.docId = docId;, +        }, +, +}, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/SearchHit.java, +    /**, +     * The hit field matching the given field name., +     */]