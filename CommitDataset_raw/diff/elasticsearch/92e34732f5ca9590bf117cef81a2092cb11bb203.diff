[+++ b/x-pack/plugin/ccr/src/test/java/org/elasticsearch/xpack/CCRIntegTestCase.java, +        removeCCRRelatedMetadataFromClusterState(clusterService);, +    static void removeCCRRelatedMetadataFromClusterState(ClusterService clusterService) throws Exception {, +        CountDownLatch latch = new CountDownLatch(1);, +        clusterService.submitStateUpdateTask("remove-ccr-related-metadata", new ClusterStateUpdateTask() {, +            @Override, +            public ClusterState execute(ClusterState currentState) throws Exception {, +                ClusterState.Builder newState = ClusterState.builder(currentState);, +                newState.metaData(MetaData.builder(currentState.getMetaData()), +                    .removeCustom(AutoFollowMetadata.TYPE), +                    .removeCustom(PersistentTasksCustomMetaData.TYPE), +                    .build());, +                return newState.build();, +            }, +, +            @Override, +            public void onFailure(String source, Exception e) {, +                latch.countDown();, +            }, +, +            @Override, +            public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {, +                latch.countDown();, +            }, +        });, +        latch.await();, +    }, +, +++ b/x-pack/plugin/ccr/src/test/java/org/elasticsearch/xpack/CCRIntegTestCase.java, +        removeCCRRelatedMetadataFromClusterState(clusterService);, +    static void removeCCRRelatedMetadataFromClusterState(ClusterService clusterService) throws Exception {, +        CountDownLatch latch = new CountDownLatch(1);, +        clusterService.submitStateUpdateTask("remove-ccr-related-metadata", new ClusterStateUpdateTask() {, +            @Override, +            public ClusterState execute(ClusterState currentState) throws Exception {, +                ClusterState.Builder newState = ClusterState.builder(currentState);, +                newState.metaData(MetaData.builder(currentState.getMetaData()), +                    .removeCustom(AutoFollowMetadata.TYPE), +                    .removeCustom(PersistentTasksCustomMetaData.TYPE), +                    .build());, +                return newState.build();, +            }, +, +            @Override, +            public void onFailure(String source, Exception e) {, +                latch.countDown();, +            }, +, +            @Override, +            public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {, +                latch.countDown();, +            }, +        });, +        latch.await();, +    }, +, +++ b/x-pack/plugin/ccr/src/test/java/org/elasticsearch/xpack/CCRSingleNodeTestCase.java, +import org.elasticsearch.cluster.service.ClusterService;, +import static org.elasticsearch.xpack.CCRIntegTestCase.removeCCRRelatedMetadataFromClusterState;, +    public void remoteLocalRemote() throws Exception {, +        ClusterService clusterService = getInstanceFromNode(ClusterService.class);, +        removeCCRRelatedMetadataFromClusterState(clusterService);, +]