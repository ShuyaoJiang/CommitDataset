[+++ b/server/src/main/java/org/elasticsearch/plugins/ClusterPlugin.java, +     *, +     * TODO: Remove this whole concept of InitialClusterStateCustomSupplier, it's not used anymore, +++ b/server/src/main/java/org/elasticsearch/plugins/ClusterPlugin.java, +     *, +     * TODO: Remove this whole concept of InitialClusterStateCustomSupplier, it's not used anymore, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java, +                                XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +                    clusterState.nodes().getMasterNode() != null && XPackPlugin.isReadyForXPackCustomMetadata(clusterState)) {, +            if (XPackPlugin.isReadyForXPackCustomMetadata(currentClusterState) == false) {, +                logger.debug("cannot add license to cluster as the following nodes might not understand the license metadata: {}",, +                    () -> XPackPlugin.nodesNotReadyForXPackCustomMetadata(currentClusterState));, +                return;, +            }, +, +++ b/server/src/main/java/org/elasticsearch/plugins/ClusterPlugin.java, +     *, +     * TODO: Remove this whole concept of InitialClusterStateCustomSupplier, it's not used anymore, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java, +                                XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +                    clusterState.nodes().getMasterNode() != null && XPackPlugin.isReadyForXPackCustomMetadata(clusterState)) {, +            if (XPackPlugin.isReadyForXPackCustomMetadata(currentClusterState) == false) {, +                logger.debug("cannot add license to cluster as the following nodes might not understand the license metadata: {}",, +                    () -> XPackPlugin.nodesNotReadyForXPackCustomMetadata(currentClusterState));, +                return;, +            }, +, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartBasicClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/server/src/main/java/org/elasticsearch/plugins/ClusterPlugin.java, +     *, +     * TODO: Remove this whole concept of InitialClusterStateCustomSupplier, it's not used anymore, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java, +                                XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +                    clusterState.nodes().getMasterNode() != null && XPackPlugin.isReadyForXPackCustomMetadata(clusterState)) {, +            if (XPackPlugin.isReadyForXPackCustomMetadata(currentClusterState) == false) {, +                logger.debug("cannot add license to cluster as the following nodes might not understand the license metadata: {}",, +                    () -> XPackPlugin.nodesNotReadyForXPackCustomMetadata(currentClusterState));, +                return;, +            }, +, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartBasicClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartTrialClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/server/src/main/java/org/elasticsearch/plugins/ClusterPlugin.java, +     *, +     * TODO: Remove this whole concept of InitialClusterStateCustomSupplier, it's not used anymore, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java, +                                XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +                    clusterState.nodes().getMasterNode() != null && XPackPlugin.isReadyForXPackCustomMetadata(clusterState)) {, +            if (XPackPlugin.isReadyForXPackCustomMetadata(currentClusterState) == false) {, +                logger.debug("cannot add license to cluster as the following nodes might not understand the license metadata: {}",, +                    () -> XPackPlugin.nodesNotReadyForXPackCustomMetadata(currentClusterState));, +                return;, +            }, +, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartBasicClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartTrialClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartupSelfGeneratedLicenseTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/server/src/main/java/org/elasticsearch/plugins/ClusterPlugin.java, +     *, +     * TODO: Remove this whole concept of InitialClusterStateCustomSupplier, it's not used anymore, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java, +                                XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +                    clusterState.nodes().getMasterNode() != null && XPackPlugin.isReadyForXPackCustomMetadata(clusterState)) {, +            if (XPackPlugin.isReadyForXPackCustomMetadata(currentClusterState) == false) {, +                logger.debug("cannot add license to cluster as the following nodes might not understand the license metadata: {}",, +                    () -> XPackPlugin.nodesNotReadyForXPackCustomMetadata(currentClusterState));, +                return;, +            }, +, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartBasicClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartTrialClusterTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/license/StartupSelfGeneratedLicenseTask.java, +import org.elasticsearch.xpack.core.XPackPlugin;, +        XPackPlugin.checkReadyForXPackCustomMetadata(currentState);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/XPackPlugin.java, +import org.elasticsearch.Version;, +import org.elasticsearch.cluster.ClusterState;, +import org.elasticsearch.cluster.metadata.MetaData;, +import org.elasticsearch.cluster.node.DiscoveryNode;, +import org.elasticsearch.common.Booleans;, +import org.elasticsearch.license.LicensesMetaData;, +import org.elasticsearch.xpack.core.ml.MLMetadataField;, +import org.elasticsearch.xpack.core.security.authc.TokenMetaData;, +import org.elasticsearch.xpack.core.watcher.WatcherMetaData;]