[+++ b/x-pack/plugin/sql/build.gradle, +        group: JavaBasePlugin.VERIFICATION_GROUP,, +        dependsOn: unitTest.dependsOn) {, +    systemProperty 'es.set.netty.runtime.available.processors', 'false', +check.dependsOn internalClusterTest, +internalClusterTest.mustRunAfter test, +++ b/x-pack/plugin/sql/build.gradle, +        group: JavaBasePlugin.VERIFICATION_GROUP,, +        dependsOn: unitTest.dependsOn) {, +    systemProperty 'es.set.netty.runtime.available.processors', 'false', +check.dependsOn internalClusterTest, +internalClusterTest.mustRunAfter test, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/SqlPlugin.java, +    private final SqlLicenseChecker sqlLicenseChecker = new SqlLicenseChecker(, +            XPackLicenseState licenseState = getLicenseState();, +    );, +, +    public SqlPlugin(Settings settings) {, +        this.enabled = XPackSettings.SQL_ENABLED.get(settings);, +    // overridable by tests, +    protected XPackLicenseState getLicenseState() { return XPackPlugin.getSharedLicenseState(); }, +, +++ b/x-pack/plugin/sql/build.gradle, +        group: JavaBasePlugin.VERIFICATION_GROUP,, +        dependsOn: unitTest.dependsOn) {, +    systemProperty 'es.set.netty.runtime.available.processors', 'false', +check.dependsOn internalClusterTest, +internalClusterTest.mustRunAfter test, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/SqlPlugin.java, +    private final SqlLicenseChecker sqlLicenseChecker = new SqlLicenseChecker(, +            XPackLicenseState licenseState = getLicenseState();, +    );, +, +    public SqlPlugin(Settings settings) {, +        this.enabled = XPackSettings.SQL_ENABLED.get(settings);, +    // overridable by tests, +    protected XPackLicenseState getLicenseState() { return XPackPlugin.getSharedLicenseState(); }, +, +++ b/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/action/AbstractSqlIntegTestCase.java, +import org.elasticsearch.license.LicenseService;, +import java.util.Collections;, +import static org.elasticsearch.test.ESIntegTestCase.Scope.SUITE;, +, +@ESIntegTestCase.ClusterScope(scope = SUITE, numDataNodes = 0, numClientNodes = 0, maxNumDataNodes = 0, transportClientRatio = 0), +        settings.put(LicenseService.SELF_GENERATED_LICENSE_TYPE.getKey(), "trial");, +        return Collections.singletonList(LocalStateSQLXPackPlugin.class);, +++ b/x-pack/plugin/sql/build.gradle, +        group: JavaBasePlugin.VERIFICATION_GROUP,, +        dependsOn: unitTest.dependsOn) {, +    systemProperty 'es.set.netty.runtime.available.processors', 'false', +check.dependsOn internalClusterTest, +internalClusterTest.mustRunAfter test, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/SqlPlugin.java, +    private final SqlLicenseChecker sqlLicenseChecker = new SqlLicenseChecker(, +            XPackLicenseState licenseState = getLicenseState();, +    );, +, +    public SqlPlugin(Settings settings) {, +        this.enabled = XPackSettings.SQL_ENABLED.get(settings);, +    // overridable by tests, +    protected XPackLicenseState getLicenseState() { return XPackPlugin.getSharedLicenseState(); }, +, +++ b/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/action/AbstractSqlIntegTestCase.java, +import org.elasticsearch.license.LicenseService;, +import java.util.Collections;, +import static org.elasticsearch.test.ESIntegTestCase.Scope.SUITE;, +, +@ESIntegTestCase.ClusterScope(scope = SUITE, numDataNodes = 0, numClientNodes = 0, maxNumDataNodes = 0, transportClientRatio = 0), +        settings.put(LicenseService.SELF_GENERATED_LICENSE_TYPE.getKey(), "trial");, +        return Collections.singletonList(LocalStateSQLXPackPlugin.class);, +++ b/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/action/LocalStateSQLXPackPlugin.java, +/*, + * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one, + * or more contributor license agreements. Licensed under the Elastic License;, + * you may not use this file except in compliance with the Elastic License., + */, +package org.elasticsearch.xpack.sql.action;, +, +import org.elasticsearch.common.settings.Settings;, +import org.elasticsearch.license.XPackLicenseState;, +import org.elasticsearch.xpack.core.LocalStateCompositeXPackPlugin;, +import org.elasticsearch.xpack.sql.plugin.SqlPlugin;, +, +import java.nio.file.Path;, +, +public class LocalStateSQLXPackPlugin extends LocalStateCompositeXPackPlugin {, +, +    public LocalStateSQLXPackPlugin(final Settings settings, final Path configPath) throws Exception {, +        super(settings, configPath);, +        LocalStateSQLXPackPlugin thisVar = this;, +        plugins.add(new SqlPlugin(settings) {, +            @Override, +            protected XPackLicenseState getLicenseState() {, +                return thisVar.getLicenseState();, +            }, +        });, +    }, +}, +++ b/x-pack/plugin/sql/build.gradle, +        group: JavaBasePlugin.VERIFICATION_GROUP,]