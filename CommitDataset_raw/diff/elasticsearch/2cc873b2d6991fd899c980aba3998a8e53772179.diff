[+++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +++ b/core/src/main/java/org/elasticsearch/index/engine/EngineConfig.java, +        indexingBufferSize = DEFAULT_INDEX_BUFFER_SIZE;, +            versionMapSize = new ByteSizeValue((long) ((double) indexingBufferSize.bytes() * (percent / 100)));, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +++ b/core/src/main/java/org/elasticsearch/index/engine/EngineConfig.java, +        indexingBufferSize = DEFAULT_INDEX_BUFFER_SIZE;, +            versionMapSize = new ByteSizeValue((long) ((double) indexingBufferSize.bytes() * (percent / 100)));, +++ b/core/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +, +import org.elasticsearch.common.unit.ByteSizeUnit;, +import org.elasticsearch.common.unit.ByteSizeValue;, +            Engine engine = new InternalEngine(config(defaultSettings, store, createTempDir(), new MergeSchedulerConfig(defaultSettings), newMergePolicy()),, +            engine.config().setIndexingBufferSize(new ByteSizeValue(1, ByteSizeUnit.KB));]