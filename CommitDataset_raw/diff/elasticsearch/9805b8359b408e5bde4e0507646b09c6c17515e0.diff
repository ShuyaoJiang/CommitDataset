[+++ b/src/main/java/org/elasticsearch/search/aggregations/reducers/derivative/DerivativeReducer.java, +import org.elasticsearch.search.aggregations.AggregationExecutionException;, +import org.elasticsearch.search.aggregations.metrics.InternalNumericMetricsAggregation;, +            double thisBucketValue = resolveBucketValue(histo, bucket);, +    private double resolveBucketValue(InternalHistogram<? extends InternalHistogram.Bucket> histo, InternalHistogram.Bucket bucket) {, +        Object propertyValue = bucket.getProperty(histo.getName(), AggregationPath.parse(bucketsPath), +                .getPathElementsAsStringList());, +        if (propertyValue instanceof Number) {, +            return ((Number) propertyValue).doubleValue();, +        } else if (propertyValue instanceof InternalNumericMetricsAggregation.SingleValue) {, +            return ((InternalNumericMetricsAggregation.SingleValue) propertyValue).value();, +        } else {, +            throw new AggregationExecutionException(DerivativeParser.BUCKETS_PATH.getPreferredName(), +                    + "must reference either a number value or a single value numeric metric aggregation");, +        }, +    }, +]