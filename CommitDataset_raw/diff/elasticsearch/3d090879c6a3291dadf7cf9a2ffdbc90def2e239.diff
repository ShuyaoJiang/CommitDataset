[+++ b/server/src/main/java/org/elasticsearch/transport/TcpTransport.java, +        closeLock.writeLock().lock();, +        try {, +            if (lifecycle.initialized() == false && lifecycle.started() == false) {, +                throw new IllegalStateException("transport has been stopped");, +            }, +                    serverChannels.computeIfAbsent(name, k -> new ArrayList<>()).add(channel);, +        } finally {, +            closeLock.writeLock().unlock();, +        }, +        assert threadPool.generic().isShutdown() == false : "Must stop transport before terminating underlying threadpool";]