[+++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.type(), item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.type(), item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +import org.elasticsearch.action.ActionListener;, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().type(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.type(), item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +import org.elasticsearch.action.ActionListener;, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().type(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java, +                .indexShards(clusterState, request.concreteIndex(), request.type(), request.id(), request.routing());, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.type(), item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +import org.elasticsearch.action.ActionListener;, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().type(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java, +                .indexShards(clusterState, request.concreteIndex(), request.type(), request.id(), request.routing());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +    public ShardIterator indexShards(ClusterState clusterState, String index, String type, String id, @Nullable String routing) {, +    public ShardIterator getShards(ClusterState clusterState, String index, String type, String id, @Nullable String routing, @Nullable String preference) {, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.type(), indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.type(), deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.type(), updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().type(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.type(), item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +import org.elasticsearch.action.ActionListener;, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().type(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java, +                .indexShards(clusterState, request.concreteIndex(), request.type(), request.id(), request.routing());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +    public ShardIterator indexShards(ClusterState clusterState, String index, String type, String id, @Nullable String routing) {, +    public ShardIterator getShards(ClusterState clusterState, String index, String type, String id, @Nullable String routing, @Nullable String preference) {, +++ b/core/src/main/java/org/elasticsearch/common/rounding/TimeZoneRounding.java, +import org.joda.time.IllegalInstantException;, +            long roundedUTC;, +            if (isInDSTGap(rounded) == false) {, +                roundedUTC  = timeZone.convertLocalToUTC(rounded, true, utcMillis);, +            } else {, +                /*, +                 * Edge case where the rounded local time is illegal and landed]