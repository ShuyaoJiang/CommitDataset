[+++ b/src/main/java/org/elasticsearch/index/store/Store.java, +                    final BytesRefBuilder fileHash = new BytesRefBuilder();, +                    final long length;, +                    try (final IndexInput in = directory.openInput(segmentsFile, IOContext.READONCE)) {, +                        length = in.length();, +                        hashFile(fileHash, new InputStreamIndexInput(in, length), length);, +                    }, +                    builder.put(segmentsFile, new StoreFileMetaData(segmentsFile, length, legacyChecksum, maxVersion, fileHash.get()));, +                final long length;, +                    length = in.length();, +                    if (length < CodecUtil.footerLength()) {, +                        hashFile(fileHash, new InputStreamIndexInput(verifyingIndexInput, length), length);, +                builder.put(file, new StoreFileMetaData(file, length, checksum, version, fileHash.get()));]