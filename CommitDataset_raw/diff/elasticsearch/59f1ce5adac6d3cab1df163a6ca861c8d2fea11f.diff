[+++ b/src/test/java/org/elasticsearch/search/scroll/SearchScrollTests.java, +import org.elasticsearch.action.search.SearchRequestBuilder;, +import org.elasticsearch.index.query.QueryBuilders;, +import org.elasticsearch.test.hamcrest.ElasticsearchAssertions;, +, +    @Test, +    // https://github.com/elasticsearch/elasticsearch/issues/4156, +    public void testDeepPaginationWithOneDocIndexAndDoNotBlowUp() throws Exception {, +        client().prepareIndex("index", "type", "1"), +                .setSource("field", "value"), +                .setRefresh(true), +                .execute().get();, +, +        for (SearchType searchType : SearchType.values()) {, +            SearchRequestBuilder builder = client().prepareSearch("index"), +                    .setSearchType(searchType), +                    .setQuery(QueryBuilders.matchAllQuery()), +                    .setSize(Integer.MAX_VALUE);, +, +            if (searchType == SearchType.SCAN || searchType != SearchType.COUNT && randomBoolean()) {, +                builder.setScroll("1m");, +            }, +, +            SearchResponse response = builder.execute().actionGet();, +            try {, +                ElasticsearchAssertions.assertHitCount(response, 1l);, +            } finally {, +                String scrollId = response.getScrollId();, +                if (scrollId != null) {, +                    clearScroll(scrollId);, +                }, +            }, +        }, +, +    }, +]