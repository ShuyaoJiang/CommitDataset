[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +import org.elasticsearch.common.collect.Maps;, +import org.elasticsearch.common.collect.Sets;, +import java.util.Set;, +    private final Map<String, Set<String>> indicesAndTypesToRefresh = Maps.newHashMap();, +, +        synchronized (indicesAndTypesToRefresh) {, +            Set<String> sTypes = indicesAndTypesToRefresh.get(index);, +            if (sTypes == null) {, +                sTypes = Sets.newHashSet();, +                indicesAndTypesToRefresh.put(index, sTypes);, +            }, +            sTypes.addAll(Arrays.asList(types));, +        }, +                    Set<String> sTypes;, +                    synchronized (indicesAndTypesToRefresh) {, +                        sTypes = indicesAndTypesToRefresh.remove(index);, +                    }, +                    // we already processed those types..., +                    if (sTypes == null || sTypes.isEmpty()) {, +                        return currentState;, +                    }, +, +                        for (String type : sTypes) {, +                    for (String type : sTypes) {]