[+++ b/src/test/java/org/elasticsearch/test/integration/cluster/MinimumMasterNodesTests.java, +import org.elasticsearch.common.unit.TimeValue;, +        long time = System.currentTimeMillis();, +        while ((System.currentTimeMillis() - time) < TimeValue.timeValueSeconds(5).millis()) {, +            state = client(nonMasterNodeName).admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            if (state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK)) {, +                break;, +            }, +        }, +        time = System.currentTimeMillis();, +        while ((System.currentTimeMillis() - time) < TimeValue.timeValueSeconds(5).millis()) {, +            state = client(masterNodeName).admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            if (state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK)) {, +                break;, +            }, +        }, +        ClusterState state;, +        long time = System.currentTimeMillis();, +        while ((System.currentTimeMillis() - time) < TimeValue.timeValueSeconds(5).millis()) {, +            state = client("node1").admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            if (state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK)) {, +                break;, +            }, +        }, +        time = System.currentTimeMillis();, +        while ((System.currentTimeMillis() - time) < TimeValue.timeValueSeconds(5).millis()) {, +            state = client("node2").admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            if (state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK)) {, +                break;, +            }, +        }, +, +        state = client("node1").admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +        // spin here to wait till the state is set, +        time = System.currentTimeMillis();, +        while ((System.currentTimeMillis() - time) < TimeValue.timeValueSeconds(20).millis()) {, +            state = client(masterNode).admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            boolean firstNoMasterLock = state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK);, +            state = client(lastNonMasterNodeUp).admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            boolean secondNoMasterLock = state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK);, +            if (firstNoMasterLock && secondNoMasterLock) {, +                break;, +            }, +        }]