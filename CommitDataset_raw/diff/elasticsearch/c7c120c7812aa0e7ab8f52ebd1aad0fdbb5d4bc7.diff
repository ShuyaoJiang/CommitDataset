[+++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitBuilder.java, +        innerHitsBuilder = in.readOptionalWriteable(InnerHitsBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitBuilder.java, +        innerHitsBuilder = in.readOptionalWriteable(InnerHitsBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitsBuilder.java, +    /**, +     * Read from a stream., +     */, +    public InnerHitsBuilder(StreamInput in) throws IOException {, +        int size = in.readVInt();, +        innerHitsBuilders = new HashMap<>(size);, +        for (int i = 0; i < size; i++) {, +            innerHitsBuilders.put(in.readString(), new InnerHitBuilder(in));, +        }, +    }, +, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        out.writeVInt(innerHitsBuilders.size());, +        for (Map.Entry<String, InnerHitBuilder> entry : innerHitsBuilders.entrySet()) {, +            out.writeString(entry.getKey());, +            entry.getValue().writeTo(out);, +        }, +    }, +, +++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitBuilder.java, +        innerHitsBuilder = in.readOptionalWriteable(InnerHitsBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitsBuilder.java, +    /**, +     * Read from a stream., +     */, +    public InnerHitsBuilder(StreamInput in) throws IOException {, +        int size = in.readVInt();, +        innerHitsBuilders = new HashMap<>(size);, +        for (int i = 0; i < size; i++) {, +            innerHitsBuilders.put(in.readString(), new InnerHitBuilder(in));, +        }, +    }, +, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        out.writeVInt(innerHitsBuilders.size());, +        for (Map.Entry<String, InnerHitBuilder> entry : innerHitsBuilders.entrySet()) {, +            out.writeString(entry.getKey());, +            entry.getValue().writeTo(out);, +        }, +    }, +, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +            innerHitsBuilder = new InnerHitsBuilder(in);, +++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitBuilder.java, +        innerHitsBuilder = in.readOptionalWriteable(InnerHitsBuilder::new);, +++ b/core/src/main/java/org/elasticsearch/index/query/support/InnerHitsBuilder.java, +    /**, +     * Read from a stream., +     */, +    public InnerHitsBuilder(StreamInput in) throws IOException {, +        int size = in.readVInt();, +        innerHitsBuilders = new HashMap<>(size);, +        for (int i = 0; i < size; i++) {, +            innerHitsBuilders.put(in.readString(), new InnerHitBuilder(in));, +        }, +    }, +, +    @Override, +    public void writeTo(StreamOutput out) throws IOException {, +        out.writeVInt(innerHitsBuilders.size());, +        for (Map.Entry<String, InnerHitBuilder> entry : innerHitsBuilders.entrySet()) {, +            out.writeString(entry.getKey());, +            entry.getValue().writeTo(out);, +        }, +    }, +, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +            innerHitsBuilder = new InnerHitsBuilder(in);, +++ b/core/src/test/java/org/elasticsearch/index/query/support/InnerHitsBuilderTests.java, +                return new InnerHitsBuilder(in);]