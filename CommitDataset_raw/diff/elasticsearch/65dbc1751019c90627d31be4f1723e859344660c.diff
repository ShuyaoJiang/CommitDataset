[+++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/execution/search/CompositeAggregationCursor.java, +        client.search(search, new ActionListener<SearchResponse>() {, +            @Override, +            public void onResponse(SearchResponse r) {, +                try {, +                    // retry, +                    if (shouldRetryDueToEmptyPage(r)) {, +                        CompositeAggregationCursor.updateCompositeAfterKey(r, search.source());, +                        client.search(search, this);, +                        return;, +                    }, +, +                    CompositeAggsRowSet rowSet = new CompositeAggsRowSet(extractors, r, limit, serializeQuery(query), indices);, +                } catch (Exception ex) {, +                    listener.onFailure(ex);, +                }, +            }, +, +            @Override, +            public void onFailure(Exception ex) {, +                listener.onFailure(ex);, +            }, +        });, +    }, +, +    static boolean shouldRetryDueToEmptyPage(SearchResponse response) {, +        CompositeAggregation composite = getComposite(response);, +        // if there are no buckets but a next page, go fetch it instead of sending an empty response to the client, +        return composite != null && composite.getBuckets().isEmpty() && composite.afterKey() != null && !composite.afterKey().isEmpty();, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/execution/search/CompositeAggregationCursor.java, +        client.search(search, new ActionListener<SearchResponse>() {, +            @Override, +            public void onResponse(SearchResponse r) {, +                try {, +                    // retry, +                    if (shouldRetryDueToEmptyPage(r)) {, +                        CompositeAggregationCursor.updateCompositeAfterKey(r, search.source());, +                        client.search(search, this);, +                        return;, +                    }, +, +                    CompositeAggsRowSet rowSet = new CompositeAggsRowSet(extractors, r, limit, serializeQuery(query), indices);, +                } catch (Exception ex) {, +                    listener.onFailure(ex);, +                }, +            }, +, +            @Override, +            public void onFailure(Exception ex) {, +                listener.onFailure(ex);, +            }, +        });, +    }, +, +    static boolean shouldRetryDueToEmptyPage(SearchResponse response) {, +        CompositeAggregation composite = getComposite(response);, +        // if there are no buckets but a next page, go fetch it instead of sending an empty response to the client, +        return composite != null && composite.getBuckets().isEmpty() && composite.afterKey() != null && !composite.afterKey().isEmpty();, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/execution/search/Querier.java, +                // retry, +                if (CompositeAggregationCursor.shouldRetryDueToEmptyPage(response)) {, +                    CompositeAggregationCursor.updateCompositeAfterKey(response, request.source());, +                    client.search(request, this);, +                    return;, +                }, +, +                CompositeAggregationCursor.updateCompositeAfterKey(response, request.source());, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/execution/search/CompositeAggregationCursor.java, +        client.search(search, new ActionListener<SearchResponse>() {, +            @Override, +            public void onResponse(SearchResponse r) {, +                try {, +                    // retry, +                    if (shouldRetryDueToEmptyPage(r)) {, +                        CompositeAggregationCursor.updateCompositeAfterKey(r, search.source());, +                        client.search(search, this);, +                        return;, +                    }, +, +                    CompositeAggsRowSet rowSet = new CompositeAggsRowSet(extractors, r, limit, serializeQuery(query), indices);, +                } catch (Exception ex) {, +                    listener.onFailure(ex);, +                }, +            }, +, +            @Override, +            public void onFailure(Exception ex) {, +                listener.onFailure(ex);, +            }, +        });, +    }, +, +    static boolean shouldRetryDueToEmptyPage(SearchResponse response) {, +        CompositeAggregation composite = getComposite(response);, +        // if there are no buckets but a next page, go fetch it instead of sending an empty response to the client, +        return composite != null && composite.getBuckets().isEmpty() && composite.afterKey() != null && !composite.afterKey().isEmpty();, +++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/execution/search/Querier.java, +                // retry, +                if (CompositeAggregationCursor.shouldRetryDueToEmptyPage(response)) {, +                    CompositeAggregationCursor.updateCompositeAfterKey(response, request.source());]