[+++ b/qa/vagrant/src/main/java/org/elasticsearch/packaging/test/ArchiveTestCase.java, +            final Platforms.PlatformAction action = () -> {, +                Result result = sh.run(bin.elasticsearchCertutil + " --help");, +                // Ensure that the exit code from the java command is passed back up through the shell script, +                result = sh.runIgnoreExitCode(bin.elasticsearchCertutil + " invalid-command");, +                assertThat(result.exitCode, is(64));, +                assertThat(result.stdout, containsString("Unknown command [invalid-command]"));, +            };, +            Platforms.onLinux(action);, +            Platforms.onWindows(action);, +++ b/qa/vagrant/src/main/java/org/elasticsearch/packaging/test/ArchiveTestCase.java, +            final Platforms.PlatformAction action = () -> {, +                Result result = sh.run(bin.elasticsearchCertutil + " --help");, +                // Ensure that the exit code from the java command is passed back up through the shell script, +                result = sh.runIgnoreExitCode(bin.elasticsearchCertutil + " invalid-command");, +                assertThat(result.exitCode, is(64));, +                assertThat(result.stdout, containsString("Unknown command [invalid-command]"));, +            };, +            Platforms.onLinux(action);, +            Platforms.onWindows(action);, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java, +        exit(new CertificateGenerateTool().main(args, Terminal.DEFAULT));, +++ b/qa/vagrant/src/main/java/org/elasticsearch/packaging/test/ArchiveTestCase.java, +            final Platforms.PlatformAction action = () -> {, +                Result result = sh.run(bin.elasticsearchCertutil + " --help");, +                // Ensure that the exit code from the java command is passed back up through the shell script, +                result = sh.runIgnoreExitCode(bin.elasticsearchCertutil + " invalid-command");, +                assertThat(result.exitCode, is(64));, +                assertThat(result.stdout, containsString("Unknown command [invalid-command]"));, +            };, +            Platforms.onLinux(action);, +            Platforms.onWindows(action);, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java, +        exit(new CertificateGenerateTool().main(args, Terminal.DEFAULT));, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java, +        exit(new CertificateTool().main(args, Terminal.DEFAULT));, +++ b/qa/vagrant/src/main/java/org/elasticsearch/packaging/test/ArchiveTestCase.java, +            final Platforms.PlatformAction action = () -> {, +                Result result = sh.run(bin.elasticsearchCertutil + " --help");, +                // Ensure that the exit code from the java command is passed back up through the shell script, +                result = sh.runIgnoreExitCode(bin.elasticsearchCertutil + " invalid-command");, +                assertThat(result.exitCode, is(64));, +                assertThat(result.stdout, containsString("Unknown command [invalid-command]"));, +            };, +            Platforms.onLinux(action);, +            Platforms.onWindows(action);, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java, +        exit(new CertificateGenerateTool().main(args, Terminal.DEFAULT));, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java, +        exit(new CertificateTool().main(args, Terminal.DEFAULT));, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlMetadataCommand.java, +        exit(new SamlMetadataCommand().main(args, Terminal.DEFAULT));, +++ b/qa/vagrant/src/main/java/org/elasticsearch/packaging/test/ArchiveTestCase.java, +            final Platforms.PlatformAction action = () -> {, +                Result result = sh.run(bin.elasticsearchCertutil + " --help");, +                // Ensure that the exit code from the java command is passed back up through the shell script, +                result = sh.runIgnoreExitCode(bin.elasticsearchCertutil + " invalid-command");, +                assertThat(result.exitCode, is(64));, +                assertThat(result.stdout, containsString("Unknown command [invalid-command]"));, +            };, +            Platforms.onLinux(action);, +            Platforms.onWindows(action);, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateGenerateTool.java, +        exit(new CertificateGenerateTool().main(args, Terminal.DEFAULT));, +++ b/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java, +        exit(new CertificateTool().main(args, Terminal.DEFAULT));, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlMetadataCommand.java, +        exit(new SamlMetadataCommand().main(args, Terminal.DEFAULT));, +++ b/x-pack/qa/vagrant/src/test/resources/packaging/tests/certgen.bash, +, +@test "[$GROUP] exit code on failure" {, +    run sudo -E -u $MASTER_USER "$MASTER_HOME/bin/elasticsearch-certgen" --not-a-valid-option, +    [ "$status" -ne 0 ] || {, +        echo "Expected elasticsearch-certgen tool exit code to be non-zero", +        echo "$output", +        false, +    }, +}]