[+++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequest.java, +import org.elasticsearch.Version;, +        if (out.getVersion().before(Version.V_1_2_0)) {, +            out.writeByte((byte) 2); // bwc operation threading, +        }, +        if (in.getVersion().before(Version.V_1_2_0)) {, +            in.readByte(); // bwc operation threading, +        }, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequest.java, +import org.elasticsearch.Version;, +        if (out.getVersion().before(Version.V_1_2_0)) {, +            out.writeByte((byte) 2); // bwc operation threading, +        }, +        if (in.getVersion().before(Version.V_1_2_0)) {, +            in.readByte(); // bwc operation threading, +        }, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequestBuilder.java, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequest.java, +import org.elasticsearch.Version;, +        if (out.getVersion().before(Version.V_1_2_0)) {, +            out.writeByte((byte) 2); // bwc operation threading, +        }, +        if (in.getVersion().before(Version.V_1_2_0)) {, +            in.readByte(); // bwc operation threading, +        }, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequestBuilder.java, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequest.java, +import org.elasticsearch.Version;, +        if (out.getVersion().before(Version.V_1_2_0)) {, +            out.writeByte((byte) 2); // bwc operation threading, +        }, +        if (in.getVersion().before(Version.V_1_2_0)) {, +            in.readByte(); // bwc operation threading, +        }, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequestBuilder.java, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastOperationAction.java, +    protected final ClusterService clusterService;, +    protected final TransportService transportService;, +                final ShardRouting shard = shardIt.nextOrNull();, +                    performOperation(shardIt, shard, shardIndex);, +        void performOperation(final ShardIterator shardIt, final ShardRouting shard, final int shardIndex) {, +                            logger.trace("{}: failed to execute [{}]", t, shard != null ? shard.shortSummary() : shardIt.shardId(), request);, +                performOperation(shardIt, nextShard, shardIndex);, +                            logger.debug("{}: failed to executed [{}]", t, shard != null ? shard.shortSummary() : shardIt.shardId(), request);, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequest.java, +import org.elasticsearch.Version;, +        if (out.getVersion().before(Version.V_1_2_0)) {, +            out.writeByte((byte) 2); // bwc operation threading, +        }, +        if (in.getVersion().before(Version.V_1_2_0)) {, +            in.readByte(); // bwc operation threading, +        }, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequestBuilder.java, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastOperationAction.java, +    protected final ClusterService clusterService;, +    protected final TransportService transportService;, +                final ShardRouting shard = shardIt.nextOrNull();, +                    performOperation(shardIt, shard, shardIndex);, +        void performOperation(final ShardIterator shardIt, final ShardRouting shard, final int shardIndex) {, +                            logger.trace("{}: failed to execute [{}]", t, shard != null ? shard.shortSummary() : shardIt.shardId(), request);, +                performOperation(shardIt, nextShard, shardIndex);, +                            logger.debug("{}: failed to executed [{}]", t, shard != null ? shard.shortSummary() : shardIt.shardId(), request);, +++ b/src/main/java/org/elasticsearch/cluster/routing/PlainShardsIterator.java, +++ b/src/main/java/org/elasticsearch/action/mlt/TransportMoreLikeThisAction.java, +        ShardRouting shardRouting = shardIterator.nextOrNull();, +++ b/src/main/java/org/elasticsearch/action/percolate/PercolateRequest.java, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequest.java, +import org.elasticsearch.Version;, +        if (out.getVersion().before(Version.V_1_2_0)) {, +            out.writeByte((byte) 2); // bwc operation threading, +        }, +        if (in.getVersion().before(Version.V_1_2_0)) {, +            in.readByte(); // bwc operation threading, +        }, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/BroadcastOperationRequestBuilder.java, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastOperationAction.java]