[+++ b/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java, +        if (bulkActions != -1 && bulkRequest.numberOfActions() >= bulkActions) {, +        if (bulkSize != -1 && bulkRequest.estimatedSizeInBytes() >= bulkSize) {, +++ b/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java, +        if (bulkActions != -1 && bulkRequest.numberOfActions() >= bulkActions) {, +        if (bulkSize != -1 && bulkRequest.estimatedSizeInBytes() >= bulkSize) {, +++ b/src/test/java/org/elasticsearch/document/BulkTests.java, +import com.google.common.collect.Maps;, +import org.elasticsearch.action.bulk.BulkProcessor;, +import org.elasticsearch.action.bulk.BulkRequest;, +import org.elasticsearch.action.index.IndexRequest;, +import java.util.Map;, +import java.util.concurrent.BlockingQueue;, +import java.util.concurrent.SynchronousQueue;, +import java.util.concurrent.TimeUnit;, +    @Test, +    public void testThatBulkProcessorCountIsCorrect() throws InterruptedException {, +        final BlockingQueue<BulkResponse> responseQueue = new SynchronousQueue();, +, +        BulkProcessor.Listener listener = new BulkProcessor.Listener() {, +            @Override, +            public void beforeBulk(long executionId, BulkRequest request) {}, +, +            @Override, +            public void afterBulk(long executionId, BulkRequest request, BulkResponse response) {, +                responseQueue.add(response);, +            }, +, +            @Override, +            public void afterBulk(long executionId, BulkRequest request, Throwable failure) {}, +        };, +, +        BulkProcessor processor = null;, +        try {, +            processor = BulkProcessor.builder(client(), listener).setBulkActions(5).setConcurrentRequests(1).setName("foo").build();, +            Map<String, Object> data = Maps.newHashMap();, +            data.put("foo", "bar");, +, +            processor.add(new IndexRequest("test", "test", "1").source(data));, +            processor.add(new IndexRequest("test", "test", "2").source(data));, +            processor.add(new IndexRequest("test", "test", "3").source(data));, +            processor.add(new IndexRequest("test", "test", "4").source(data));, +            processor.add(new IndexRequest("test", "test", "5").source(data));, +, +            BulkResponse response = responseQueue.poll(5, TimeUnit.SECONDS);, +            assertThat("Could not get a bulk response in 5 seconds", response, is(notNullValue()));, +            assertThat(response.getItems().length, is(5));, +        } finally {, +            if (processor != null) {, +                processor.close();, +            }, +        }, +    }, +]