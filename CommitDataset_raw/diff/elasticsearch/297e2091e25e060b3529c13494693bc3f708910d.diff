[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java, +        List<InternalSearchHit> hits = new ArrayList<InternalSearchHit>();, +                if (index < fetchResult.hits().internalHits().length) {, +                    InternalSearchHit searchHit = fetchResult.hits().internalHits()[index];, +                    searchHit.shard(fetchResult.shardTarget());, +        InternalSearchHits searchHits = new InternalSearchHits(hits.toArray(new InternalSearchHit[hits.size()]), totalHits);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java, +        List<InternalSearchHit> hits = new ArrayList<InternalSearchHit>();, +                if (index < fetchResult.hits().internalHits().length) {, +                    InternalSearchHit searchHit = fetchResult.hits().internalHits()[index];, +                    searchHit.shard(fetchResult.shardTarget());, +        InternalSearchHits searchHits = new InternalSearchHits(hits.toArray(new InternalSearchHit[hits.size()]), totalHits);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +        InternalSearchHit[] hits = new InternalSearchHit[context.docIdsToLoad().length];, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java, +        List<InternalSearchHit> hits = new ArrayList<InternalSearchHit>();, +                if (index < fetchResult.hits().internalHits().length) {, +                    InternalSearchHit searchHit = fetchResult.hits().internalHits()[index];, +                    searchHit.shard(fetchResult.shardTarget());, +        InternalSearchHits searchHits = new InternalSearchHits(hits.toArray(new InternalSearchHit[hits.size()]), totalHits);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +        InternalSearchHit[] hits = new InternalSearchHit[context.docIdsToLoad().length];, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/internal/InternalSearchHit.java, +import org.elasticsearch.util.gnu.trove.TIntObjectHashMap;, +    public static InternalSearchHit readSearchHit(StreamInput in, @Nullable TIntObjectHashMap<SearchShardTarget> shardLookupMap) throws IOException {, +        InternalSearchHit hit = new InternalSearchHit();, +        hit.readFrom(in, shardLookupMap);, +        return hit;, +    }, +, +        readFrom(in, null);, +    }, +, +    public void readFrom(StreamInput in, @Nullable TIntObjectHashMap<SearchShardTarget> shardLookupMap) throws IOException {, +        if (shardLookupMap != null) {, +            int lookupId = in.readVInt();, +            if (lookupId > 0) {, +                shard = shardLookupMap.get(lookupId);, +            }, +        } else {, +    }, +        writeTo(out, null);, +    }, +, +    public void writeTo(StreamOutput out, @Nullable Map<SearchShardTarget, Integer> shardLookupMap) throws IOException {, +        if (shardLookupMap == null) {, +        } else {, +            if (shard == null) {, +                out.writeVInt(0);, +            } else {, +                out.writeVInt(shardLookupMap.get(shard));, +            }, +        }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/controller/SearchPhaseController.java, +        List<InternalSearchHit> hits = new ArrayList<InternalSearchHit>();, +                if (index < fetchResult.hits().internalHits().length) {, +                    InternalSearchHit searchHit = fetchResult.hits().internalHits()[index];, +                    searchHit.shard(fetchResult.shardTarget());, +        InternalSearchHits searchHits = new InternalSearchHits(hits.toArray(new InternalSearchHit[hits.size()]), totalHits);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +        InternalSearchHit[] hits = new InternalSearchHit[context.docIdsToLoad().length];, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/internal/InternalSearchHit.java, +import org.elasticsearch.util.gnu.trove.TIntObjectHashMap;, +    public static InternalSearchHit readSearchHit(StreamInput in, @Nullable TIntObjectHashMap<SearchShardTarget> shardLookupMap) throws IOException {, +        InternalSearchHit hit = new InternalSearchHit();, +        hit.readFrom(in, shardLookupMap);, +        return hit;, +    }, +, +        readFrom(in, null);, +    }, +, +    public void readFrom(StreamInput in, @Nullable TIntObjectHashMap<SearchShardTarget> shardLookupMap) throws IOException {, +        if (shardLookupMap != null) {, +            int lookupId = in.readVInt();, +            if (lookupId > 0) {, +                shard = shardLookupMap.get(lookupId);, +            }, +        } else {, +    }, +        writeTo(out, null);, +    }, +, +    public void writeTo(StreamOutput out, @Nullable Map<SearchShardTarget, Integer> shardLookupMap) throws IOException {, +        if (shardLookupMap == null) {, +        } else {, +            if (shard == null) {, +                out.writeVInt(0);, +            } else {, +                out.writeVInt(shardLookupMap.get(shard));, +            }, +        }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/internal/InternalSearchHits.java, +import org.elasticsearch.search.SearchShardTarget;, +import org.elasticsearch.util.gnu.trove.TIntObjectHashMap;, +import java.util.IdentityHashMap;, +import java.util.Map;, +import static org.elasticsearch.search.SearchShardTarget.*;, +    private static final InternalSearchHit[] EMPTY = new InternalSearchHit[0];, +    private InternalSearchHit[] hits;]