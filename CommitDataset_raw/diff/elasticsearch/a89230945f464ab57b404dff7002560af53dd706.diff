[+++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenFilterFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenFilterFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenizerFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenFilterFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenizerFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/search/highlight/vectorhighlight/FragmentBuilderHelper.java, +import org.apache.lucene.util.Version;, +            if (a.tokenizerFactory() instanceof EdgeNGramTokenizerFactory , +                    || (a.tokenizerFactory() instanceof NGramTokenizerFactory , +                            && !((NGramTokenizerFactory)a.tokenizerFactory()).version().onOrAfter(Version.LUCENE_42))) {, +                // ngram tokenizer is broken before 4.2, +                if (tokenFilterFactory instanceof NGramTokenFilterFactory , +                        && !((NGramTokenFilterFactory)tokenFilterFactory).version().onOrAfter(Version.LUCENE_42)) {, +                    // ngram token filter is broken before 4.2, +                    return true;, +                }, +++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenFilterFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/index/analysis/AbstractTokenizerFactory.java, +    , +    public final Version version() {, +        return version;, +    }, +++ b/src/main/java/org/elasticsearch/search/highlight/vectorhighlight/FragmentBuilderHelper.java, +import org.apache.lucene.util.Version;, +            if (a.tokenizerFactory() instanceof EdgeNGramTokenizerFactory , +                    || (a.tokenizerFactory() instanceof NGramTokenizerFactory , +                            && !((NGramTokenizerFactory)a.tokenizerFactory()).version().onOrAfter(Version.LUCENE_42))) {, +                // ngram tokenizer is broken before 4.2, +                if (tokenFilterFactory instanceof NGramTokenFilterFactory , +                        && !((NGramTokenFilterFactory)tokenFilterFactory).version().onOrAfter(Version.LUCENE_42)) {, +                    // ngram token filter is broken before 4.2, +                    return true;, +                }, +++ b/src/test/java/org/elasticsearch/test/integration/search/highlight/HighlighterSearchTests.java, +    @Test, +    public void testNgramHighlightingPreLucene42() throws ElasticSearchException, IOException {, +        try {, +            client.admin().indices().prepareDelete("test").execute().actionGet();, +        } catch (Exception e) {, +            // ignore, +        }, +        , +        client.admin().indices().prepareCreate("test"), +        .addMapping("test", jsonBuilder(), +                .startObject(), +                    .startObject("test"), +                        .startObject("properties"), +                            .startObject("name"), +                                .field("type", "string"), +                                .field("index_analyzer", "name_index_analyzer"), +                                .field("search_analyzer", "name_search_analyzer"), +                                .field("term_vector", "with_positions_offsets"), +                            .endObject(), +                            .startObject("name2"), +                                .field("type", "string"), +                                .field("index_analyzer", "name2_index_analyzer"), +                                .field("search_analyzer", "name_search_analyzer"), +                                .field("term_vector", "with_positions_offsets"), +                            .endObject(), +                        .endObject(), +                    .endObject(), +                .endObject()), +        .setSettings(ImmutableSettings.settingsBuilder(), +                .put("index.number_of_shards", 2), +                .put("analysis.filter.my_ngram.max_gram", 20), +                .put("analysis.filter.my_ngram.version", "4.1"), +                .put("analysis.filter.my_ngram.min_gram", 1), +                .put("analysis.filter.my_ngram.type", "ngram"), +                .put("analysis.tokenizer.my_ngramt.max_gram", 20), +                .put("analysis.tokenizer.my_ngramt.version", "4.1"), +                .put("analysis.tokenizer.my_ngramt.min_gram", 1), +                .put("analysis.tokenizer.my_ngramt.type", "ngram"), +                .put("analysis.analyzer.name_index_analyzer.tokenizer", "my_ngramt"), +                .put("analysis.analyzer.name2_index_analyzer.tokenizer", "whitespace"), +                .put("analysis.analyzer.name2_index_analyzer.filter", "my_ngram"), +                .put("analysis.analyzer.name_search_analyzer.tokenizer", "whitespace"))]