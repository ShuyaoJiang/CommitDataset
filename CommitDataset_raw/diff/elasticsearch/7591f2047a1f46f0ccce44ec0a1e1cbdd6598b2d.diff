[+++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +import org.elasticsearch.common.logging.ESLogger;, +        transportService.registerRequestHandler(SHARD_STARTED_ACTION_NAME, ShardRoutingEntry::new, ThreadPool.Names.SAME, new ShardStartedTransportHandler(clusterService, new ShardStartedClusterStateHandler(allocationService, logger), logger));, +        transportService.registerRequestHandler(SHARD_FAILED_ACTION_NAME, ShardRoutingEntry::new, ThreadPool.Names.SAME, new ShardFailedTransportHandler(clusterService, new ShardFailedClusterStateHandler(allocationService, routingService, logger), logger));, +    private static class ShardFailedTransportHandler implements TransportRequestHandler<ShardRoutingEntry> {, +        private final ShardFailedClusterStateHandler shardFailedClusterStateHandler;, +        private final ESLogger logger;, +        public ShardFailedTransportHandler(ClusterService clusterService, ShardFailedClusterStateHandler shardFailedClusterStateHandler, ESLogger logger) {, +            this.shardFailedClusterStateHandler = shardFailedClusterStateHandler;, +            this.logger = logger;, +    private static class ShardFailedClusterStateHandler implements ClusterStateTaskExecutor<ShardRoutingEntry> {, +        private final AllocationService allocationService;, +        private final RoutingService routingService;, +        private final ESLogger logger;, +, +        public ShardFailedClusterStateHandler(AllocationService allocationService, RoutingService routingService, ESLogger logger) {, +            this.allocationService = allocationService;, +            this.routingService = routingService;, +            this.logger = logger;, +        }, +, +    private static class ShardStartedTransportHandler implements TransportRequestHandler<ShardRoutingEntry> {, +        private final ShardStartedClusterStateHandler shardStartedClusterStateHandler;, +        private final ESLogger logger;, +        public ShardStartedTransportHandler(ClusterService clusterService, ShardStartedClusterStateHandler shardStartedClusterStateHandler, ESLogger logger) {, +            this.shardStartedClusterStateHandler = shardStartedClusterStateHandler;, +            this.logger = logger;, +    private static class ShardStartedClusterStateHandler implements ClusterStateTaskExecutor<ShardRoutingEntry>, ClusterStateTaskListener {, +        private final AllocationService allocationService;, +        private final ESLogger logger;, +, +        public ShardStartedClusterStateHandler(AllocationService allocationService, ESLogger logger) {, +            this.allocationService = allocationService;, +            this.logger = logger;, +        }, +]