[+++ b/core/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java, +import org.elasticsearch.cluster.routing.AllocationId;, +                final IndexShardRoutingTable indexShardRoutingTable = routingTable.shardRoutingTable(shardRouting.shardId());, +                /*, +                 * Filter to shards that track sequence numbers and should be taken into consideration for checkpoint tracking. Shards on, +                 * old nodes will go through a file-based recovery which will also transfer sequence number information., +                 */, +                final Set<String> activeIds =, +                        allocationIdsForShardsOnNodesThatUnderstandSeqNos(indexShardRoutingTable.activeShards(), nodes);, +                final Set<String> initializingIds =, +                        allocationIdsForShardsOnNodesThatUnderstandSeqNos(indexShardRoutingTable.getAllInitializingShards(), nodes);, +    private Set<String> allocationIdsForShardsOnNodesThatUnderstandSeqNos(, +            final List<ShardRouting> shardRoutings,, +            final DiscoveryNodes nodes) {, +        return shardRoutings, +                .stream(), +                .filter(sr -> nodes.get(sr.currentNodeId()).getVersion().onOrAfter(Version.V_6_0_0_alpha1_UNRELEASED)), +                .map(ShardRouting::allocationId), +                .map(AllocationId::getId), +                .collect(Collectors.toSet());, +    }, +]