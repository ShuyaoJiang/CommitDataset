[+++ b/core/src/test/java/org/elasticsearch/action/support/replication/TransportReplicationActionTests.java, +import java.util.Set;, +import static org.hamcrest.Matchers.hasItem;, +, +        Set<String> nodesSentTo = new HashSet<>();, +        boolean executeOnReplica =, +            action.shouldExecuteReplication(clusterService.state().getMetaData().index(shardId.getIndex()).getSettings());, +        for (CapturingTransport.CapturedRequest capturedRequest : capturedRequests) {, +            // no duplicate requests, +            assertTrue(nodesSentTo.add(capturedRequest.node.getId()));, +            // the request is hitting the correct shard, +            Request replicationRequest = (Request)capturedRequest.request;, +            assertEquals(request.shardId, replicationRequest.shardId);, +        }, +, +        // requests were sent to the correct shard copies, +        List<ShardRouting> shards =, +            clusterService.state().getRoutingTable().index(shardId.getIndex()).shard(shardId.id()).shards();, +        for (ShardRouting shard : shards) {, +            if (!shard.primary() && !executeOnReplica) {, +                continue;, +            }, +            if (shard.unassigned()) {, +                continue;, +            }, +            if (!clusterService.state().getNodes().localNodeId().equals(shard.currentNodeId())) {, +                assertThat(nodesSentTo, hasItem(shard.currentNodeId()));, +            }, +            if (shard.relocating()) {, +                assertThat(nodesSentTo, hasItem(shard.relocatingNodeId()));, +            }, +        }, +]