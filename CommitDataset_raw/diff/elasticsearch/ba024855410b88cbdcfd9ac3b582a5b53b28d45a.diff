[+++ b/core/src/main/java/org/elasticsearch/index/query/QueryBuilder.java, +    @Override, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryBuilder.java, +    @Override, +++ b/core/src/main/java/org/elasticsearch/search/sort/FieldSortBuilder.java, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {, +                return this;, +            }, +            return new FieldSortBuilder(this).setNestedSort(rewrite);, +        }, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryBuilder.java, +    @Override, +++ b/core/src/main/java/org/elasticsearch/search/sort/FieldSortBuilder.java, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {, +                return this;, +            }, +            return new FieldSortBuilder(this).setNestedSort(rewrite);, +        }, +++ b/core/src/main/java/org/elasticsearch/search/sort/GeoDistanceSortBuilder.java, +    public GeoDistanceSortBuilder rewrite(QueryRewriteContext ctx) throws IOException {, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {, +                return this;, +            }, +            return new GeoDistanceSortBuilder(this).setNestedSort(rewrite);, +        }, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryBuilder.java, +    @Override, +++ b/core/src/main/java/org/elasticsearch/search/sort/FieldSortBuilder.java, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {, +                return this;, +            }, +            return new FieldSortBuilder(this).setNestedSort(rewrite);, +        }, +++ b/core/src/main/java/org/elasticsearch/search/sort/GeoDistanceSortBuilder.java, +    public GeoDistanceSortBuilder rewrite(QueryRewriteContext ctx) throws IOException {, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {, +                return this;, +            }, +            return new GeoDistanceSortBuilder(this).setNestedSort(rewrite);, +        }, +++ b/core/src/main/java/org/elasticsearch/search/sort/NestedSortBuilder.java, +import org.elasticsearch.index.query.QueryRewriteContext;, +, +    public NestedSortBuilder rewrite(QueryRewriteContext ctx) throws IOException {, +        if (filter == null && nestedSort == null) {, +            return this;, +        }, +        QueryBuilder rewriteFilter = this.filter;, +        NestedSortBuilder rewriteNested = this.nestedSort;, +        if (filter != null) {, +            rewriteFilter = filter.rewrite(ctx);, +        }, +        if (nestedSort != null) {, +            rewriteNested = nestedSort.rewrite(ctx);, +        }, +        if (rewriteFilter != this.filter || rewriteNested != this.nestedSort) {, +            return new NestedSortBuilder(this.path).setFilter(rewriteFilter).setNestedSort(rewriteNested);, +        } else {, +            return this;, +        }, +    }, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryBuilder.java, +    @Override, +++ b/core/src/main/java/org/elasticsearch/search/sort/FieldSortBuilder.java, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {, +                return this;, +            }, +            return new FieldSortBuilder(this).setNestedSort(rewrite);, +        }, +++ b/core/src/main/java/org/elasticsearch/search/sort/GeoDistanceSortBuilder.java, +    public GeoDistanceSortBuilder rewrite(QueryRewriteContext ctx) throws IOException {, +        if (nestedFilter == null && nestedSort == null) {, +        if (nestedFilter != null) {, +        } else {, +            NestedSortBuilder rewrite = nestedSort.rewrite(ctx);, +            if (nestedSort == rewrite) {]