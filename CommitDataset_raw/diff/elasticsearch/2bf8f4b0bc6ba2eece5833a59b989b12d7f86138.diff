[+++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/FileUserPasswdStore.java, +import java.io.Writer;, +        try (Writer writer = openAtomicMoveWriter(path)) {, +                final String message =, +                        String.format(Locale.ROOT, "%s:%s%s", entry.getKey(), new String(entry.getValue()), System.lineSeparator());, +                writer.write(message);, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/FileUserPasswdStore.java, +import java.io.Writer;, +        try (Writer writer = openAtomicMoveWriter(path)) {, +                final String message =, +                        String.format(Locale.ROOT, "%s:%s%s", entry.getKey(), new String(entry.getValue()), System.lineSeparator());, +                writer.write(message);, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/FileUserRolesStore.java, +import java.io.Writer;, +        try (Writer writer = openAtomicMoveWriter(path)) {, +                final String message = String.format(, +                        Locale.ROOT,, +                        "%s:%s%s",, +                        entry.getKey(),, +                        Strings.collectionToCommaDelimitedString(entry.getValue()), System.lineSeparator());, +                writer.write(message);, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/FileUserPasswdStore.java, +import java.io.Writer;, +        try (Writer writer = openAtomicMoveWriter(path)) {, +                final String message =, +                        String.format(Locale.ROOT, "%s:%s%s", entry.getKey(), new String(entry.getValue()), System.lineSeparator());, +                writer.write(message);, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/FileUserRolesStore.java, +import java.io.Writer;, +        try (Writer writer = openAtomicMoveWriter(path)) {, +                final String message = String.format(, +                        Locale.ROOT,, +                        "%s:%s%s",, +                        entry.getKey(),, +                        Strings.collectionToCommaDelimitedString(entry.getValue()), System.lineSeparator());, +                writer.write(message);, +++ b/plugin/src/test/java/org/elasticsearch/xpack/security/support/SecurityFilesTests.java, +import java.io.Writer;, +        try (Writer writer = openAtomicMoveWriter(path)) {, +            writer.write("This is a test");]