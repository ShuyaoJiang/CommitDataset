[+++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/common/joda/DateMathParser.java, +import java.util.function.LongSupplier;, +    public long parse(String text, LongSupplier now) {, +    public long parse(String text, LongSupplier now, boolean roundUp, DateTimeZone timeZone) {, +                time = now.getAsLong();, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/common/joda/DateMathParser.java, +import java.util.function.LongSupplier;, +    public long parse(String text, LongSupplier now) {, +    public long parse(String text, LongSupplier now, boolean roundUp, DateTimeZone timeZone) {, +                time = now.getAsLong();, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, roundUp, zone);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/common/joda/DateMathParser.java, +import java.util.function.LongSupplier;, +    public long parse(String text, LongSupplier now) {, +    public long parse(String text, LongSupplier now, boolean roundUp, DateTimeZone timeZone) {, +                time = now.getAsLong();, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, roundUp, zone);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, inclusive, zone);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/common/joda/DateMathParser.java, +import java.util.function.LongSupplier;, +    public long parse(String text, LongSupplier now) {, +    public long parse(String text, LongSupplier now, boolean roundUp, DateTimeZone timeZone) {, +                time = now.getAsLong();, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, roundUp, zone);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, inclusive, zone);, +++ b/core/src/main/java/org/elasticsearch/search/DocValueFormat.java, +import java.util.function.LongSupplier;, +    long parseLong(String value, boolean roundUp, LongSupplier now);, +    double parseDouble(String value, boolean roundUp, LongSupplier now);, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/common/joda/DateMathParser.java, +import java.util.function.LongSupplier;, +    public long parse(String text, LongSupplier now) {, +    public long parse(String text, LongSupplier now, boolean roundUp, DateTimeZone timeZone) {, +                time = now.getAsLong();, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, roundUp, zone);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +            return dateParser.parse(strValue, context::nowInMillis, inclusive, zone);, +++ b/core/src/main/java/org/elasticsearch/search/DocValueFormat.java, +import java.util.function.LongSupplier;, +    long parseLong(String value, boolean roundUp, LongSupplier now);, +    double parseDouble(String value, boolean roundUp, LongSupplier now);, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +        public long parseLong(String value, boolean roundUp, LongSupplier now) {, +        public double parseDouble(String value, boolean roundUp, LongSupplier now) {, +++ b/core/src/test/java/org/elasticsearch/common/joda/DateMathParserTests.java, +import java.util.function.LongSupplier;, +        long gotMillis = parser.parse(toTest, () -> now, roundUp, timeZone);, +        long expectedMillis = parser.parse(expected, () -> 0);, +        final long now = parser.parse("2014-11-18T14:27:32", () -> 0, false, null);, +        long datetime = parser.parse("1418248078", () -> 0);, +            parser.parse(date, () -> 0);, +        final LongSupplier now = () -> {, +            parser.parse("1234567890123", () -> 42, false, DateTimeZone.forTimeZone(TimeZone.getTimeZone("CET")));, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java, +                            long millis = dateMathParser.parse(mathExpression, context::getStartTime, false, timeZone);, +++ b/core/src/main/java/org/elasticsearch/common/joda/DateMathParser.java, +import java.util.function.LongSupplier;, +    public long parse(String text, LongSupplier now) {, +    public long parse(String text, LongSupplier now, boolean roundUp, DateTimeZone timeZone) {, +                time = now.getAsLong();, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java]