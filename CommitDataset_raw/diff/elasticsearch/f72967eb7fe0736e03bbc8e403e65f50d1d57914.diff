[+++ b/plugin/src/main/java/org/elasticsearch/xpack/persistent/PersistentTasksCustomMetaData.java, +        private Builder() {, +        private Builder(PersistentTasksCustomMetaData tasksInProgress) {, +        public long getLastAllocationId() {, +            return lastAllocationId;, +        }, +, +++ b/plugin/src/main/java/org/elasticsearch/xpack/persistent/PersistentTasksCustomMetaData.java, +        private Builder() {, +        private Builder(PersistentTasksCustomMetaData tasksInProgress) {, +        public long getLastAllocationId() {, +            return lastAllocationId;, +        }, +, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/MlAssignmentNotifierTests.java, +import static org.elasticsearch.xpack.ml.action.OpenJobActionTests.addJobTask;, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", "node_id", null, tasksBuilder);, +        MetaData metaData = MetaData.builder().putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build()).build();, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", null, null, tasksBuilder);, +        MetaData metaData = MetaData.builder().putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build()).build();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/persistent/PersistentTasksCustomMetaData.java, +        private Builder() {, +        private Builder(PersistentTasksCustomMetaData tasksInProgress) {, +        public long getLastAllocationId() {, +            return lastAllocationId;, +        }, +, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/MlAssignmentNotifierTests.java, +import static org.elasticsearch.xpack.ml.action.OpenJobActionTests.addJobTask;, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", "node_id", null, tasksBuilder);, +        MetaData metaData = MetaData.builder().putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build()).build();, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", null, null, tasksBuilder);, +        MetaData metaData = MetaData.builder().putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build()).build();, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/MlMetadataTests.java, +import static org.elasticsearch.xpack.ml.action.OpenJobActionTests.addJobTask;, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("1", null, JobState.CLOSED, tasksBuilder);, +                () -> builder2.deleteJob("1", tasksBuilder.build()));, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        tasksBuilder.addTask(MlMetadata.datafeedTaskId("datafeed1"), StartDatafeedAction.NAME, request, INITIAL_ASSIGNMENT);, +        PersistentTasksCustomMetaData tasksInProgress = tasksBuilder.build();, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        tasksBuilder.addTask(MlMetadata.datafeedTaskId("datafeed1"), StartDatafeedAction.NAME, request, INITIAL_ASSIGNMENT);, +        PersistentTasksCustomMetaData tasksInProgress = tasksBuilder.build();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/persistent/PersistentTasksCustomMetaData.java, +        private Builder() {, +        private Builder(PersistentTasksCustomMetaData tasksInProgress) {, +        public long getLastAllocationId() {, +            return lastAllocationId;, +        }, +, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/MlAssignmentNotifierTests.java, +import static org.elasticsearch.xpack.ml.action.OpenJobActionTests.addJobTask;, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", "node_id", null, tasksBuilder);, +        MetaData metaData = MetaData.builder().putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build()).build();, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", null, null, tasksBuilder);, +        MetaData metaData = MetaData.builder().putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build()).build();, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/MlMetadataTests.java, +import static org.elasticsearch.xpack.ml.action.OpenJobActionTests.addJobTask;, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("1", null, JobState.CLOSED, tasksBuilder);, +                () -> builder2.deleteJob("1", tasksBuilder.build()));, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        tasksBuilder.addTask(MlMetadata.datafeedTaskId("datafeed1"), StartDatafeedAction.NAME, request, INITIAL_ASSIGNMENT);, +        PersistentTasksCustomMetaData tasksInProgress = tasksBuilder.build();, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        tasksBuilder.addTask(MlMetadata.datafeedTaskId("datafeed1"), StartDatafeedAction.NAME, request, INITIAL_ASSIGNMENT);, +        PersistentTasksCustomMetaData tasksInProgress = tasksBuilder.build();, +++ b/plugin/src/test/java/org/elasticsearch/xpack/ml/action/CloseJobActionRequestTests.java, +import org.elasticsearch.xpack.persistent.PersistentTasksCustomMetaData.Assignment;, +import static org.elasticsearch.xpack.ml.action.OpenJobActionTests.addJobTask;, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", null, JobState.OPENED, tasksBuilder);, +        addTask("datafeed_id", 0L, null, DatafeedState.STARTED, tasksBuilder);, +                        .putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build())).build();, +        tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id", null, JobState.OPENED, tasksBuilder);, +            addTask("datafeed_id", 0L, null, DatafeedState.STOPPED, tasksBuilder);, +                        .putCustom(PersistentTasksCustomMetaData.TYPE, tasksBuilder.build())).build();, +        PersistentTasksCustomMetaData.Builder tasksBuilder =  PersistentTasksCustomMetaData.builder();, +        addJobTask("job_id_1", null, JobState.OPENED, tasksBuilder);, +        addJobTask("job_id_2", null, JobState.CLOSED, tasksBuilder);, +        addJobTask("job_id_3", null, JobState.FAILED, tasksBuilder);, +                        .putCustom(PersistentTasksCustomMetaData.TYPE,  tasksBuilder.build())), +    public static void addTask(String datafeedId, long startTime, String nodeId, DatafeedState state,, +                               PersistentTasksCustomMetaData.Builder tasks) {, +        tasks.addTask(MlMetadata.datafeedTaskId(datafeedId), StartDatafeedAction.NAME,, +                new StartDatafeedAction.Request(datafeedId, startTime), new Assignment(nodeId, "test assignment"));, +        tasks.updateTaskStatus(MlMetadata.datafeedTaskId(datafeedId), state);, +++ b/plugin/src/main/java/org/elasticsearch/xpack/persistent/PersistentTasksCustomMetaData.java, +        private Builder() {, +        private Builder(PersistentTasksCustomMetaData tasksInProgress) {, +        public long getLastAllocationId() {, +            return lastAllocationId;]