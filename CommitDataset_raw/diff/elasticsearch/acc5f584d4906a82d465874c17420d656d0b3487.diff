[+++ b/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java, +                if (updateTask instanceof ProcessedClusterStateUpdateTask) {, +                    ((ProcessedClusterStateUpdateTask) updateTask).clusterStateProcessed(source, previousClusterState, newClusterState);, +                }, +++ b/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java, +                if (updateTask instanceof ProcessedClusterStateUpdateTask) {, +                    ((ProcessedClusterStateUpdateTask) updateTask).clusterStateProcessed(source, previousClusterState, newClusterState);, +                }, +++ b/src/test/java/org/elasticsearch/cluster/ClusterServiceTests.java, +                .put("discovery.type", "local"), +                .put("discovery.type", "local"), +        final CountDownLatch processedLatch = new CountDownLatch(1);, +                latch.countDown();, +                latch.countDown();, +                processedLatch.countDown();, +                logger.error("failed to execute callback in test {}", t, source);, +, +        assertThat(processedLatch.await(1, TimeUnit.SECONDS), equalTo(true));, +                .put("discovery.type", "local"), +        final CountDownLatch processedLatch = new CountDownLatch(1);, +                latch.countDown();, +                latch.countDown();, +                processedLatch.countDown();, +                logger.error("failed to execute callback in test {}", t, source);, +, +        assertThat(processedLatch.await(1, TimeUnit.SECONDS), equalTo(true));, +                .put("discovery.type", "local"), +                logger.error("failed to execute callback in test {}", t, source);, +                .put("discovery.type", "local"), +        final CountDownLatch processedLatch = new CountDownLatch(1);, +                processedLatch.countDown();, +                logger.error("failed to execute callback in test {}", t, source);, +, +        assertThat(processedLatch.await(1, TimeUnit.SECONDS), equalTo(true));]