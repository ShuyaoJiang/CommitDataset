[+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java, +                throw makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());, +                    OpenJobAction.JobParams params = (OpenJobAction.JobParams) persistentTask.getParams();, +                    exception = makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());, +, +    static ElasticsearchException makeNoSuitableNodesException(Logger logger, String jobId, String explanation) {, +        String msg = "Could not open job because no suitable nodes were found, allocation explanation [" + explanation + "]";, +        logger.warn("[{}] {}", jobId, msg);, +        Exception detail = new IllegalStateException(msg);, +        return new ElasticsearchStatusException("Could not open job because no ML nodes with sufficient capacity were found",, +            RestStatus.TOO_MANY_REQUESTS, detail);, +    }, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java, +                throw makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());, +                    OpenJobAction.JobParams params = (OpenJobAction.JobParams) persistentTask.getParams();, +                    exception = makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());, +, +    static ElasticsearchException makeNoSuitableNodesException(Logger logger, String jobId, String explanation) {, +        String msg = "Could not open job because no suitable nodes were found, allocation explanation [" + explanation + "]";, +        logger.warn("[{}] {}", jobId, msg);, +        Exception detail = new IllegalStateException(msg);, +        return new ElasticsearchStatusException("Could not open job because no ML nodes with sufficient capacity were found",, +            RestStatus.TOO_MANY_REQUESTS, detail);, +    }, +++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java, +        assertEquals("Could not open job because no ML nodes with sufficient capacity were found", e.getMessage());, +        IllegalStateException detail = (IllegalStateException) e.getCause();, +        assertNotNull(detail);, +        String detailedMessage = detail.getMessage();, +        assertTrue(detailedMessage,, +            detailedMessage.startsWith("Could not open job because no suitable nodes were found, allocation explanation"));, +        assertTrue(detailedMessage, detailedMessage.endsWith("because not all primary shards are active for the following indices " +, +            "[.ml-state,.ml-anomalies-shared]]"));, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java, +                throw makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());, +                    OpenJobAction.JobParams params = (OpenJobAction.JobParams) persistentTask.getParams();, +                    exception = makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());, +, +    static ElasticsearchException makeNoSuitableNodesException(Logger logger, String jobId, String explanation) {, +        String msg = "Could not open job because no suitable nodes were found, allocation explanation [" + explanation + "]";, +        logger.warn("[{}] {}", jobId, msg);, +        Exception detail = new IllegalStateException(msg);, +        return new ElasticsearchStatusException("Could not open job because no ML nodes with sufficient capacity were found",, +            RestStatus.TOO_MANY_REQUESTS, detail);, +    }, +++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java, +        assertEquals("Could not open job because no ML nodes with sufficient capacity were found", e.getMessage());, +        IllegalStateException detail = (IllegalStateException) e.getCause();, +        assertNotNull(detail);, +        String detailedMessage = detail.getMessage();, +        assertTrue(detailedMessage,, +            detailedMessage.startsWith("Could not open job because no suitable nodes were found, allocation explanation"));, +        assertTrue(detailedMessage, detailedMessage.endsWith("because not all primary shards are active for the following indices " +, +            "[.ml-state,.ml-anomalies-shared]]"));, +++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/TooManyJobsIT.java, +                assertEquals("Could not open job because no ML nodes with sufficient capacity were found", e.getMessage());, +                IllegalStateException detail = (IllegalStateException) e.getCause();, +                assertNotNull(detail);, +                String detailedMessage = detail.getMessage();, +                assertTrue(detailedMessage,, +                    detailedMessage.startsWith("Could not open job because no suitable nodes were found, allocation explanation"));, +                    assertTrue(detailedMessage,, +                        detailedMessage.endsWith("because this node has insufficient available memory. Available memory for ML [" +, +                            (expectedJobsAlreadyOpenOnNode * memoryFootprintPerJob) + "], estimated memory required for this job [" +, +                            memoryFootprintPerJob + "]]"));, +                    assertTrue(detailedMessage, detailedMessage.endsWith("because this node is full. Number of opened jobs [" +]