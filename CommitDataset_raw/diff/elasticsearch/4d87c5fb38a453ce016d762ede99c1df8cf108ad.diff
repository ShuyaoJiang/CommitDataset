[+++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +import org.elasticsearch.index.similarity.SimilarityService;, +    private final SimilarityService similarityService;, +                                SimilarityService similarityService, ScriptService scriptService) {, +        this.similarityService = similarityService;, +        return new Mapper.TypeParser.ParserContext(type, analysisService, similarityService::getSimilarity, mapperService, typeParsers::get, indexVersionCreated, parseFieldMatcher);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +import org.elasticsearch.index.similarity.SimilarityService;, +    private final SimilarityService similarityService;, +                                SimilarityService similarityService, ScriptService scriptService) {, +        this.similarityService = similarityService;, +        return new Mapper.TypeParser.ParserContext(type, analysisService, similarityService::getSimilarity, mapperService, typeParsers::get, indexVersionCreated, parseFieldMatcher);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            builder.field("similarity", SimilarityService.DEFAULT_SIMILARITY);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +import org.elasticsearch.index.similarity.SimilarityService;, +    private final SimilarityService similarityService;, +                                SimilarityService similarityService, ScriptService scriptService) {, +        this.similarityService = similarityService;, +        return new Mapper.TypeParser.ParserContext(type, analysisService, similarityService::getSimilarity, mapperService, typeParsers::get, indexVersionCreated, parseFieldMatcher);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            builder.field("similarity", SimilarityService.DEFAULT_SIMILARITY);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/Mapper.java, +import org.elasticsearch.index.similarity.SimilarityProvider;, +import java.util.function.Function;, +            private final Function<String, SimilarityProvider> similarityLookupService;, +            private final Function<String, TypeParser> typeParsers;, +            public ParserContext(String type, AnalysisService analysisService,  Function<String, SimilarityProvider> similarityLookupService,, +                                 MapperService mapperService, Function<String, TypeParser> typeParsers,, +            public SimilarityProvider getSimilarity(String name) {, +                return similarityLookupService.apply(name);, +                return typeParsers.apply(Strings.toUnderscoreCase(type));, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +import org.elasticsearch.index.similarity.SimilarityService;, +    private final SimilarityService similarityService;, +                                SimilarityService similarityService, ScriptService scriptService) {, +        this.similarityService = similarityService;, +        return new Mapper.TypeParser.ParserContext(type, analysisService, similarityService::getSimilarity, mapperService, typeParsers::get, indexVersionCreated, parseFieldMatcher);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            builder.field("similarity", SimilarityService.DEFAULT_SIMILARITY);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/Mapper.java, +import org.elasticsearch.index.similarity.SimilarityProvider;, +import java.util.function.Function;, +            private final Function<String, SimilarityProvider> similarityLookupService;, +            private final Function<String, TypeParser> typeParsers;, +            public ParserContext(String type, AnalysisService analysisService,  Function<String, SimilarityProvider> similarityLookupService,, +                                 MapperService mapperService, Function<String, TypeParser> typeParsers,, +            public SimilarityProvider getSimilarity(String name) {, +                return similarityLookupService.apply(name);, +                return typeParsers.apply(Strings.toUnderscoreCase(type));, +++ b/core/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +                         SimilarityService similarityService,, +        this.documentParser = new DocumentMapperParser(indexSettings, this, analysisService, similarityService, scriptService);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java, +import org.elasticsearch.index.similarity.SimilarityService;, +            SimilarityService similarityService = new SimilarityService(index, settings);, +                try (MapperService mapperService = new MapperService(index, settings, analysisService, similarityService, scriptService)) {]