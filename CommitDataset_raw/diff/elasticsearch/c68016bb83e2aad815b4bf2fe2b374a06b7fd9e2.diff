[+++ b/src/main/java/org/elasticsearch/action/support/replication/TransportShardReplicationOperationAction.java, +        protected final long startTime = System.currentTimeMillis();, +            if (fromClusterEvent) {, +                logger.trace("retry scheduling ignored as it as we already have a listener in place");, +                return;, +            }, +, +, +            TimeValue timeout = new TimeValue(request.timeout().millis() - (System.currentTimeMillis() - startTime));, +            if (timeout.millis() <= 0) {, +                raiseTimeoutFailure(timeout, failure);, +                return;, +            }, +, +            clusterService.add(timeout, new TimeoutClusterStateListener() {, +                    raiseTimeoutFailure(timeValue, failure);, +, +        void raiseTimeoutFailure(TimeValue timeout, @Nullable Throwable failure) {, +            if (failure == null) {, +                if (shardIt == null) {, +                    failure = new UnavailableShardsException(null, "no available shards: Timeout waiting for [" + timeout + "], request: " + request.toString());, +                } else {, +                    failure = new UnavailableShardsException(shardIt.shardId(), "[" + shardIt.size() + "] shardIt, [" + shardIt.sizeActive() + "] active : Timeout waiting for [" + timeout + "], request: " + request.toString());, +                }, +            }, +            listener.onFailure(failure);]