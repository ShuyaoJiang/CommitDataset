[+++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/MissingTests.java, +        assertThat("Not all shards are initialized", response.getSuccessfulShards(), equalTo(response.getTotalShards()));, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/MissingTests.java, +        assertThat("Not all shards are initialized", response.getSuccessfulShards(), equalTo(response.getTotalShards()));, +++ b/src/test/java/org/elasticsearch/search/aggregations/metrics/ExtendedStatsTests.java, +import org.elasticsearch.action.search.ShardSearchFailure;, +        assertShardExecutionState(searchResponse, 0);, +, +    private void assertShardExecutionState(SearchResponse response, int expectedFailures) throws Exception {, +        ShardSearchFailure[] failures = response.getShardFailures();, +        if (failures.length != expectedFailures) {, +            for (ShardSearchFailure failure : failures) {, +                logger.error("Shard Failure: {}", failure.failure(), failure.toString());, +            }, +            fail("Unexpected shard failures!");, +        }, +        assertThat("Not all shards are initialized", response.getSuccessfulShards(), equalTo(response.getTotalShards()));, +    }, +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/MissingTests.java, +        assertThat("Not all shards are initialized", response.getSuccessfulShards(), equalTo(response.getTotalShards()));, +++ b/src/test/java/org/elasticsearch/search/aggregations/metrics/ExtendedStatsTests.java, +import org.elasticsearch.action.search.ShardSearchFailure;, +        assertShardExecutionState(searchResponse, 0);, +, +    private void assertShardExecutionState(SearchResponse response, int expectedFailures) throws Exception {, +        ShardSearchFailure[] failures = response.getShardFailures();, +        if (failures.length != expectedFailures) {, +            for (ShardSearchFailure failure : failures) {, +                logger.error("Shard Failure: {}", failure.failure(), failure.toString());, +            }, +            fail("Unexpected shard failures!");, +        }, +        assertThat("Not all shards are initialized", response.getSuccessfulShards(), equalTo(response.getTotalShards()));, +    }, +++ b/src/test/java/org/elasticsearch/search/aggregations/metrics/StatsTests.java, +        assertThat("Not all shards are initialized", response.getSuccessfulShards(), equalTo(response.getTotalShards()));]