[+++ b/plugins/discovery-gce/pom.xml, +++ b/plugins/discovery-gce/pom.xml, +++ b/plugins/discovery-gce/src/main/java/org/elasticsearch/plugin/discovery/gce/GceDiscoveryPlugin.java, +import com.google.api.client.http.HttpHeaders;, +import com.google.api.client.util.ClassInfo;, +, +import org.elasticsearch.SpecialPermission;, +import java.security.AccessController;, +import java.security.PrivilegedAction;, +    static {, +        /*, +         * GCE's http client changes access levels because its silly and we, +         * can't allow that on any old stack stack so we pull it here, up front,, +         * so we can cleanly check the permissions for it. Without this changing, +         * the permission can fail if any part of core is on the stack because, +         * our plugin permissions don't allow core to "reach through" plugins to, +         * change the permission. Because that'd be silly., +         */, +        SecurityManager sm = System.getSecurityManager();, +        if (sm != null) {, +            sm.checkPermission(new SpecialPermission());, +        }, +        AccessController.doPrivileged(new PrivilegedAction<Void>() {, +            @Override, +            public Void run() {, +                ClassInfo.of(HttpHeaders.class, true);, +                return null;, +            }, +        });, +    }, +++ b/plugins/discovery-gce/pom.xml, +++ b/plugins/discovery-gce/src/main/java/org/elasticsearch/plugin/discovery/gce/GceDiscoveryPlugin.java, +import com.google.api.client.http.HttpHeaders;, +import com.google.api.client.util.ClassInfo;, +, +import org.elasticsearch.SpecialPermission;, +import java.security.AccessController;, +import java.security.PrivilegedAction;, +    static {, +        /*, +         * GCE's http client changes access levels because its silly and we, +         * can't allow that on any old stack stack so we pull it here, up front,, +         * so we can cleanly check the permissions for it. Without this changing, +         * the permission can fail if any part of core is on the stack because, +         * our plugin permissions don't allow core to "reach through" plugins to, +         * change the permission. Because that'd be silly., +         */, +        SecurityManager sm = System.getSecurityManager();, +        if (sm != null) {, +            sm.checkPermission(new SpecialPermission());, +        }, +        AccessController.doPrivileged(new PrivilegedAction<Void>() {, +            @Override, +            public Void run() {, +                ClassInfo.of(HttpHeaders.class, true);, +                return null;, +            }, +        });, +    }, +++ b/plugins/discovery-gce/src/test/java/org/elasticsearch/discovery/gce/RetryHttpInitializerWrapperTests.java, +import com.google.api.client.http.GenericUrl;, +import com.google.api.client.http.HttpRequest;, +import com.google.api.client.http.HttpResponse;, +import com.google.api.client.http.HttpResponseException;, +import com.google.api.client.http.HttpStatusCodes;, +import com.google.api.client.http.LowLevelHttpRequest;, +import com.google.api.client.http.LowLevelHttpResponse;, +, +import org.elasticsearch.test.ESTestCase;, +public class RetryHttpInitializerWrapperTests extends ESTestCase {]