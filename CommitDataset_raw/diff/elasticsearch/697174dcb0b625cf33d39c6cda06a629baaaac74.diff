[+++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        this.nestedScope = new NestedScope();, +    @Override, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        this.nestedScope = new NestedScope();, +    @Override, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilder.java, +                context.nestedScope().nextLevel(nestedObjectMapper);, +                innerDocumentsQuery = QueryBuilder.rewriteQuery(nestedFilter, context).toFilter(context);, +                context.nestedScope().previousLevel();, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +        this.nestedScope = new NestedScope();, +    @Override, +++ b/core/src/main/java/org/elasticsearch/search/sort/SortBuilder.java, +                context.nestedScope().nextLevel(nestedObjectMapper);, +                innerDocumentsQuery = QueryBuilder.rewriteQuery(nestedFilter, context).toFilter(context);, +                context.nestedScope().previousLevel();, +++ b/core/src/test/java/org/elasticsearch/search/sort/AbstractSortTestCase.java, +                indicesQueriesRegistry, null) {]