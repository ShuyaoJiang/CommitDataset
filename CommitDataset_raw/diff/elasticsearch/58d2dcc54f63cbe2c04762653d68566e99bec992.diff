[+++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/channel/TcpWriteContext.java, +        try {, +        } catch (IOException e) {, +            headOp.getListener().onFailure(e);, +            throw e;, +        }, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/channel/TcpWriteContext.java, +        try {, +        } catch (IOException e) {, +            headOp.getListener().onFailure(e);, +            throw e;, +        }, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/channel/TcpWriteContextTests.java, +    public void testWhenIOExceptionThrownListenerIsCalled() throws IOException {, +        assertFalse(writeContext.hasQueuedWriteOps());, +, +        WriteOperation writeOperation = mock(WriteOperation.class);, +        writeContext.queueWriteOperations(writeOperation);, +, +        assertTrue(writeContext.hasQueuedWriteOps());, +, +        IOException exception = new IOException();, +        when(writeOperation.flush()).thenThrow(exception);, +        when(writeOperation.getListener()).thenReturn(listener);, +        expectThrows(IOException.class, () -> writeContext.flushChannel());, +, +        verify(listener).onFailure(exception);, +        assertFalse(writeContext.hasQueuedWriteOps());, +    }, +]