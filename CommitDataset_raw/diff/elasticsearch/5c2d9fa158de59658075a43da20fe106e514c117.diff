[+++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadIT.java, +import java.util.Set;, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numShards, 10, indexer.getIds());, +    private void iterateAssertCount(final int numberOfShards, final int iterations, final Set<String> ids) throws Exception {, +        final long numberOfDocs = ids.size();, +                for (String id : ids) {, +                    ShardId docShard = clusterService.operationRouting().shardId(state, "test", id, null);, +                            GetResponse response = client().prepareGet("test", "type", id), +            assertEquals(numberOfDocs, ids.size());, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadIT.java, +import java.util.Set;, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numShards, 10, indexer.getIds());, +    private void iterateAssertCount(final int numberOfShards, final int iterations, final Set<String> ids) throws Exception {, +        final long numberOfDocs = ids.size();, +                for (String id : ids) {, +                    ShardId docShard = clusterService.operationRouting().shardId(state, "test", id, null);, +                            GetResponse response = client().prepareGet("test", "type", id), +            assertEquals(numberOfDocs, ids.size());, +++ b/core/src/test/java/org/elasticsearch/recovery/RelocationIT.java, +                        set.forEach((IntProcedure) value -> {, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadIT.java, +import java.util.Set;, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numShards, 10, indexer.getIds());, +    private void iterateAssertCount(final int numberOfShards, final int iterations, final Set<String> ids) throws Exception {, +        final long numberOfDocs = ids.size();, +                for (String id : ids) {, +                    ShardId docShard = clusterService.operationRouting().shardId(state, "test", id, null);, +                            GetResponse response = client().prepareGet("test", "type", id), +            assertEquals(numberOfDocs, ids.size());, +++ b/core/src/test/java/org/elasticsearch/recovery/RelocationIT.java, +                        set.forEach((IntProcedure) value -> {, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadIT.java, +import java.util.Set;, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numShards, 10, indexer.getIds());, +    private void iterateAssertCount(final int numberOfShards, final int iterations, final Set<String> ids) throws Exception {, +        final long numberOfDocs = ids.size();, +                for (String id : ids) {, +                    ShardId docShard = clusterService.operationRouting().shardId(state, "test", id, null);, +                            GetResponse response = client().prepareGet("test", "type", id), +            assertEquals(numberOfDocs, ids.size());, +++ b/core/src/test/java/org/elasticsearch/recovery/RelocationIT.java, +                        set.forEach((IntProcedure) value -> {, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadIT.java, +import java.util.Set;, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numShards, 10, indexer.getIds());, +    private void iterateAssertCount(final int numberOfShards, final int iterations, final Set<String> ids) throws Exception {, +        final long numberOfDocs = ids.size();, +                for (String id : ids) {, +                    ShardId docShard = clusterService.operationRouting().shardId(state, "test", id, null);, +                            GetResponse response = client().prepareGet("test", "type", id), +            assertEquals(numberOfDocs, ids.size());, +++ b/core/src/test/java/org/elasticsearch/recovery/RelocationIT.java, +                        set.forEach((IntProcedure) value -> {, +++ /dev/null, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java, +++ b/core/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadIT.java, +import java.util.Set;, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numberOfShards, 10, indexer.getIds());, +            iterateAssertCount(numShards, 10, indexer.getIds());, +    private void iterateAssertCount(final int numberOfShards, final int iterations, final Set<String> ids) throws Exception {, +        final long numberOfDocs = ids.size();, +                for (String id : ids) {, +                    ShardId docShard = clusterService.operationRouting().shardId(state, "test", id, null);, +                            GetResponse response = client().prepareGet("test", "type", id), +            assertEquals(numberOfDocs, ids.size());, +++ b/core/src/test/java/org/elasticsearch/recovery/RelocationIT.java, +                        set.forEach((IntProcedure) value -> {, +++ /dev/null, +++ /dev/null, +++ /dev/null, +++ /dev/null, +++ b/core/src/main/java/org/elasticsearch/client/transport/support/TransportProxyClient.java]