[+++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());, +            clusterStateToSend = commandsResult.getClusterState();, +            explanations = commandsResult.explanations();, +            return commandsResult.getClusterState();, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());, +            clusterStateToSend = commandsResult.getClusterState();, +            explanations = commandsResult.explanations();, +            return commandsResult.getClusterState();, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java, +                        return allocationService.reroute(currentState, "reroute after cluster update settings");, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());, +            clusterStateToSend = commandsResult.getClusterState();, +            explanations = commandsResult.explanations();, +            return commandsResult.getClusterState();, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java, +                        return allocationService.reroute(currentState, "reroute after cluster update settings");, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());, +            clusterStateToSend = commandsResult.getClusterState();, +            explanations = commandsResult.explanations();, +            return commandsResult.getClusterState();, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java, +                        return allocationService.reroute(currentState, "reroute after cluster update settings");, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +                maybeUpdatedState = applyFailedShards(currentState, shardRoutingsToBeApplied, staleShardsToBeApplied);, +        ClusterState applyFailedShards(ClusterState currentState, List<FailedRerouteAllocation.FailedShard> failedShards,, +                maybeUpdatedState = allocationService.applyStartedShards(currentState, shardRoutingsToBeApplied, true);, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());, +            clusterStateToSend = commandsResult.getClusterState();, +            explanations = commandsResult.explanations();, +            return commandsResult.getClusterState();, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java, +                        return allocationService.reroute(currentState, "reroute after cluster update settings");, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +                maybeUpdatedState = applyFailedShards(currentState, shardRoutingsToBeApplied, staleShardsToBeApplied);, +        ClusterState applyFailedShards(ClusterState currentState, List<FailedRerouteAllocation.FailedShard> failedShards,, +                maybeUpdatedState = allocationService.applyStartedShards(currentState, shardRoutingsToBeApplied, true);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +                                updatedState = allocationService.reroute(, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());, +            clusterStateToSend = commandsResult.getClusterState();, +            explanations = commandsResult.explanations();, +            return commandsResult.getClusterState();, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java, +                        return allocationService.reroute(currentState, "reroute after cluster update settings");, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +                maybeUpdatedState = applyFailedShards(currentState, shardRoutingsToBeApplied, staleShardsToBeApplied);, +        ClusterState applyFailedShards(ClusterState currentState, List<FailedRerouteAllocation.FailedShard> failedShards,, +                maybeUpdatedState = allocationService.applyStartedShards(currentState, shardRoutingsToBeApplied, true);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +                                updatedState = allocationService.reroute(, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataDeleteIndexService.java, +        return allocationService.reroute(, +                ClusterState.builder(currentState), +                    .routingTable(routingTableBuilder.build()), +                    .metaData(newMetaData), +                    .blocks(blocks), +                    .build(),, +++ b/benchmarks/src/main/java/org/elasticsearch/benchmark/routing/allocation/AllocationBenchmark.java, +            clusterState = strategy.applyStartedShards(clusterState, clusterState.getRoutingNodes(), +            clusterState = strategy.reroute(clusterState, "reroute");, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/reroute/TransportClusterRerouteAction.java, +            AllocationService.CommandsResult commandsResult =, +                allocationService.reroute(currentState, request.getCommands(), request.explain(), request.isRetryFailed());]