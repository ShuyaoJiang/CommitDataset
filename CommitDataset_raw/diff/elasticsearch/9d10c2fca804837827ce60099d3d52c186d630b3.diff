[+++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/DoubleTermsTests.java, +    private static final String SINGLE_VALUED_FIELD_NAME = "d_value";, +    private static final String MULTI_VALUED_FIELD_NAME = "d_values";, +                    .field(SINGLE_VALUED_FIELD_NAME, (double) i), +                    .startArray(MULTI_VALUED_FIELD_NAME).value((double)i).value(i + 1d).endArray(), +                    .field(SINGLE_VALUED_FIELD_NAME, (double) i), +                    .startArray(MULTI_VALUED_FIELD_NAME).value((double)i).value(i + 1d).endArray(), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(sum("sum").field(MULTI_VALUED_FIELD_NAME))), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(MULTI_VALUED_FIELD_NAME)), +                        .field(MULTI_VALUED_FIELD_NAME), +                        .field(MULTI_VALUED_FIELD_NAME), +                        .field(MULTI_VALUED_FIELD_NAME), +                        .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].value")), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].values")), +                            .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].values"), +                        .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].values"), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME)), +        prepareCreate("empty_bucket_idx").addMapping("type", SINGLE_VALUED_FIELD_NAME, "type=integer").execute().actionGet();, +                    .field(SINGLE_VALUED_FIELD_NAME, i*2), +                .addAggregation(histogram("histo").field(SINGLE_VALUED_FIELD_NAME).interval(1l).minDocCount(0), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(avg("avg_i").field(SINGLE_VALUED_FIELD_NAME)), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(avg("avg_i").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(extendedStats("stats").field(SINGLE_VALUED_FIELD_NAME)), +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/DoubleTermsTests.java, +    private static final String SINGLE_VALUED_FIELD_NAME = "d_value";, +    private static final String MULTI_VALUED_FIELD_NAME = "d_values";, +                    .field(SINGLE_VALUED_FIELD_NAME, (double) i), +                    .startArray(MULTI_VALUED_FIELD_NAME).value((double)i).value(i + 1d).endArray(), +                    .field(SINGLE_VALUED_FIELD_NAME, (double) i), +                    .startArray(MULTI_VALUED_FIELD_NAME).value((double)i).value(i + 1d).endArray(), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(sum("sum").field(MULTI_VALUED_FIELD_NAME))), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(MULTI_VALUED_FIELD_NAME)), +                        .field(MULTI_VALUED_FIELD_NAME), +                        .field(MULTI_VALUED_FIELD_NAME), +                        .field(MULTI_VALUED_FIELD_NAME), +                        .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].value")), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].values")), +                            .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].values"), +                        .script("doc['" + MULTI_VALUED_FIELD_NAME + "'].values"), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .field(SINGLE_VALUED_FIELD_NAME)), +        prepareCreate("empty_bucket_idx").addMapping("type", SINGLE_VALUED_FIELD_NAME, "type=integer").execute().actionGet();, +                    .field(SINGLE_VALUED_FIELD_NAME, i*2), +                .addAggregation(histogram("histo").field(SINGLE_VALUED_FIELD_NAME).interval(1l).minDocCount(0), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(avg("avg_i").field(SINGLE_VALUED_FIELD_NAME)), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                            .field(SINGLE_VALUED_FIELD_NAME), +                            .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(avg("avg_i").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(stats("stats").field(SINGLE_VALUED_FIELD_NAME)), +                        .field(SINGLE_VALUED_FIELD_NAME), +                        .subAggregation(extendedStats("stats").field(SINGLE_VALUED_FIELD_NAME)), +++ b/src/test/java/org/elasticsearch/search/aggregations/bucket/HistogramTests.java, +    private static final String SINGLE_VALUED_FIELD_NAME = "l_value";, +    private static final String MULTI_VALUED_FIELD_NAME = "l_values";, +, +                    .field(SINGLE_VALUED_FIELD_NAME, i + 1), +                    .startArray(MULTI_VALUED_FIELD_NAME).value(i + 1).value(i + 2).endArray(), +                .addAggregation(histogram("histo").field(SINGLE_VALUED_FIELD_NAME).interval(interval)), +                .addAggregation(histogram("histo").field(SINGLE_VALUED_FIELD_NAME).interval(interval).order(Histogram.Order.KEY_ASC))]