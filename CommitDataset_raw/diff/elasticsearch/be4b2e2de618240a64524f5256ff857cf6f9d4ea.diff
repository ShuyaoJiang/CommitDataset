[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ /dev/null, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ /dev/null, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/search/SearchScript.java, +import org.elasticsearch.search.lookup.SearchLookup;, +    private final SearchLookup searchLookup;, +    public SearchScript(SearchLookup searchLookup, ExecutableScript script) {, +    public SearchScript(SearchLookup searchLookup, String lang, String script, @Nullable Map<String, Object> params, ScriptService scriptService) {, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +        this.searchLookup = new SearchLookup(mapperService, fieldDataCache);, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ /dev/null, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/search/SearchScript.java, +import org.elasticsearch.search.lookup.SearchLookup;, +    private final SearchLookup searchLookup;, +    public SearchScript(SearchLookup searchLookup, ExecutableScript script) {, +    public SearchScript(SearchLookup searchLookup, String lang, String script, @Nullable Map<String, Object> params, ScriptService scriptService) {, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +        this.searchLookup = new SearchLookup(mapperService, fieldDataCache);, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/geodistance/ScriptGeoDistanceFacetCollector.java, +        this.script = new SearchScript(context.lookup(), scriptLang, script, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ /dev/null, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/search/SearchScript.java, +import org.elasticsearch.search.lookup.SearchLookup;, +    private final SearchLookup searchLookup;, +    public SearchScript(SearchLookup searchLookup, ExecutableScript script) {, +    public SearchScript(SearchLookup searchLookup, String lang, String script, @Nullable Map<String, Object> params, ScriptService scriptService) {, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +        this.searchLookup = new SearchLookup(mapperService, fieldDataCache);, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/geodistance/ScriptGeoDistanceFacetCollector.java, +        this.script = new SearchScript(context.lookup(), scriptLang, script, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/histogram/KeyValueScriptHistogramFacetCollector.java, +        this.valueScript = new SearchScript(context.lookup(), scriptLang, valueScript, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ /dev/null, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/search/SearchScript.java, +import org.elasticsearch.search.lookup.SearchLookup;, +    private final SearchLookup searchLookup;, +    public SearchScript(SearchLookup searchLookup, ExecutableScript script) {, +    public SearchScript(SearchLookup searchLookup, String lang, String script, @Nullable Map<String, Object> params, ScriptService scriptService) {, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +        this.searchLookup = new SearchLookup(mapperService, fieldDataCache);, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/geodistance/ScriptGeoDistanceFacetCollector.java, +        this.script = new SearchScript(context.lookup(), scriptLang, script, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/histogram/KeyValueScriptHistogramFacetCollector.java, +        this.valueScript = new SearchScript(context.lookup(), scriptLang, valueScript, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/histogram/ScriptHistogramFacetCollector.java, +        this.keyScript = new SearchScript(context.lookup(), scriptLang, keyScript, params, context.scriptService());, +        this.valueScript = new SearchScript(context.lookup(), scriptLang, valueScript, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        SearchScript searchScript = new SearchScript(context.lookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +            this.searchScript = new SearchScript(context.lookup(), scriptLang, script, params, scriptService);, +++ /dev/null, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/search/SearchScript.java, +import org.elasticsearch.search.lookup.SearchLookup;, +    private final SearchLookup searchLookup;, +    public SearchScript(SearchLookup searchLookup, ExecutableScript script) {, +    public SearchScript(SearchLookup searchLookup, String lang, String script, @Nullable Map<String, Object> params, ScriptService scriptService) {, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +        this.searchLookup = new SearchLookup(mapperService, fieldDataCache);, +        this.script = scriptService.executable(lang, script, searchLookup.processAsMap(params));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/geodistance/ScriptGeoDistanceFacetCollector.java, +        this.script = new SearchScript(context.lookup(), scriptLang, script, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/histogram/KeyValueScriptHistogramFacetCollector.java, +        this.valueScript = new SearchScript(context.lookup(), scriptLang, valueScript, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/histogram/ScriptHistogramFacetCollector.java, +        this.keyScript = new SearchScript(context.lookup(), scriptLang, keyScript, params, context.scriptService());, +        this.valueScript = new SearchScript(context.lookup(), scriptLang, valueScript, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/range/ScriptRangeFacetCollector.java, +        this.keyScript = new SearchScript(context.lookup(), scriptLang, keyScript, params, context.scriptService());, +        this.valueScript = new SearchScript(context.lookup(), scriptLang, valueScript, params, context.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java]