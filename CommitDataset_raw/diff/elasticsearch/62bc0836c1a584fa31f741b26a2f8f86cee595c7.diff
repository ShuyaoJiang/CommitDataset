[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/search/XBooleanFilter.java, +import org.elasticsearch.common.lucene.docset.DocSet;, +    private DocIdSet getDISI(ArrayList<Filter> filters, int index, IndexReader reader), +        if (docIdSet == DocIdSet.EMPTY_DOCIDSET || docIdSet == DocSet.EMPTY_DOC_SET) {, +            return null;, +        return docIdSet;, +                final DocIdSet disi = getDISI(shouldFilters, i, reader);, +                if (disi == null) continue;, +                    res = new FixedBitSet(reader.maxDoc());, +                DocSets.or(res, disi);, +                    res = new FixedBitSet(reader.maxDoc());, +                    res.set(0, reader.maxDoc()); // NOTE: may set bits on deleted docs, +                }, +                final DocIdSet disi = getDISI(notFilters, i, reader);, +                if (disi != null) {, +                    DocSets.andNot(res, disi);, +                final DocIdSet disi = getDISI(mustFilters, i, reader);, +                if (disi == null) {, +                    return null;, +                }, +                    res = new FixedBitSet(reader.maxDoc());, +                    DocSets.or(res, disi);, +                    DocSets.and(res, disi);]