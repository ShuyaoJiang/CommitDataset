[+++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup(), context.getClusterState());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup, ClusterState state) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup(), context.getClusterState());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup, ClusterState state) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap(), queryRewriteContext.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup(), context.getClusterState());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup, ClusterState state) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap(), queryRewriteContext.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup(), context.getClusterState());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup, ClusterState state) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap(), queryRewriteContext.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/ingest/InternalTemplateService.java, +                Collections.emptyMap(),, +                null); // null == OK, because ingest templates are only inline templates., +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup(), context.getClusterState());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup, ClusterState state) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap(), queryRewriteContext.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/ingest/InternalTemplateService.java, +                Collections.emptyMap(),, +                null); // null == OK, because ingest templates are only inline templates., +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ClusterState state = clusterService.state();, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup(), context.getClusterState());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup, ClusterState state) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap(), state);, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap(), queryRewriteContext.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap(), context.getClusterState());, +++ b/core/src/main/java/org/elasticsearch/ingest/InternalTemplateService.java, +                Collections.emptyMap(),, +                null); // null == OK, because ingest templates are only inline templates., +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +++ b/core/src/main/java/org/elasticsearch/script/ScriptService.java, +public class ScriptService extends AbstractComponent implements Closeable {, +    public CompiledScript compile(Script script, ScriptContext scriptContext, Map<String, String> params, ClusterState state) {, +        return compileInternal(script, params, state);, +    CompiledScript compileInternal(Script script, Map<String, String> params, ClusterState state) {, +            code = getScriptFromClusterState(state, indexedScript.lang, indexedScript.id);, +    String getScriptFromClusterState(ClusterState state, String scriptLang, String id) {, +        ScriptMetaData scriptMetadata = state.metaData().custom(ScriptMetaData.TYPE);, +    public ExecutableScript executable(Script script, ScriptContext scriptContext, Map<String, String> params, ClusterState state) {]