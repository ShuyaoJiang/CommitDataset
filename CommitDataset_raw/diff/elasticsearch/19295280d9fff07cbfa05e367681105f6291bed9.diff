[+++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +    private final Query originalChildQuery;, +    private Query rewrittenChildQuery;, +        this.originalChildQuery = childQuery;, +        this.originalChildQuery = unProcessedQuery.originalChildQuery;, +        this.rewrittenChildQuery = rewrittenChildQuery;, +        sb.append("ChildrenQuery[").append(childType).append("/").append(parentType).append("](").append(originalChildQuery, +        Query rewritten;, +        if (rewrittenChildQuery == null) {, +            rewritten = originalChildQuery.rewrite(reader);, +        } else {, +            rewritten = rewrittenChildQuery;, +        }, +        if (rewritten == rewrittenChildQuery) {, +        // See TopChildrenQuery#rewrite, +        ChildrenQuery rewrite = new ChildrenQuery(this, rewritten);, +        rewrittenChildQuery.extractTerms(terms);, +        Query childQuery;, +        if (rewrittenChildQuery == null) {, +            childQuery = rewrittenChildQuery = searchContext.searcher().rewrite(originalChildQuery);, +        } else {, +            childQuery = rewrittenChildQuery;, +        }, +        return new ParentWeight(rewrittenChildQuery.createWeight(searcher));, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +    private final Query originalChildQuery;, +    private Query rewrittenChildQuery;, +        this.originalChildQuery = childQuery;, +        this.originalChildQuery = unProcessedQuery.originalChildQuery;, +        this.rewrittenChildQuery = rewrittenChildQuery;, +        sb.append("ChildrenQuery[").append(childType).append("/").append(parentType).append("](").append(originalChildQuery, +        Query rewritten;, +        if (rewrittenChildQuery == null) {, +            rewritten = originalChildQuery.rewrite(reader);, +        } else {, +            rewritten = rewrittenChildQuery;, +        }, +        if (rewritten == rewrittenChildQuery) {, +        // See TopChildrenQuery#rewrite, +        ChildrenQuery rewrite = new ChildrenQuery(this, rewritten);, +        rewrittenChildQuery.extractTerms(terms);, +        Query childQuery;, +        if (rewrittenChildQuery == null) {, +            childQuery = rewrittenChildQuery = searchContext.searcher().rewrite(originalChildQuery);, +        } else {, +            childQuery = rewrittenChildQuery;, +        }, +        return new ParentWeight(rewrittenChildQuery.createWeight(searcher));, +++ b/src/main/java/org/elasticsearch/index/search/child/ParentQuery.java, +    private final Query originalParentQuery;, +    private Query rewrittenParentQuery;, +        this.originalParentQuery = parentQuery;, +        this.originalParentQuery = unwritten.originalParentQuery;, +        this.rewrittenParentQuery = rewrittenParentQuery;, +        Query parentQuery;, +        if (rewrittenParentQuery == null) {, +            parentQuery = rewrittenParentQuery = searchContext.searcher().rewrite(originalParentQuery);, +        } else {, +            parentQuery = rewrittenParentQuery;, +        }, +                .append("](").append(originalParentQuery.toString(field)).append(')'), +        Query rewritten;, +        if (rewrittenParentQuery == null) {, +            rewritten = originalParentQuery.rewrite(reader);, +        } else {, +            rewritten = rewrittenParentQuery;, +        }, +        if (rewritten == rewrittenParentQuery) {, +, +        // See TopChildrenQuery#rewrite, +        ParentQuery rewrite = new ParentQuery(this, rewritten);, +        rewrittenParentQuery.extractTerms(terms);, +        return new ChildWeight(rewrittenParentQuery.createWeight(searcher));, +++ b/src/main/java/org/elasticsearch/index/search/child/ChildrenQuery.java, +    private final Query originalChildQuery;, +    private Query rewrittenChildQuery;, +        this.originalChildQuery = childQuery;, +        this.originalChildQuery = unProcessedQuery.originalChildQuery;, +        this.rewrittenChildQuery = rewrittenChildQuery;, +        sb.append("ChildrenQuery[").append(childType).append("/").append(parentType).append("](").append(originalChildQuery, +        Query rewritten;, +        if (rewrittenChildQuery == null) {, +            rewritten = originalChildQuery.rewrite(reader);, +        } else {, +            rewritten = rewrittenChildQuery;, +        }, +        if (rewritten == rewrittenChildQuery) {, +        // See TopChildrenQuery#rewrite, +        ChildrenQuery rewrite = new ChildrenQuery(this, rewritten);, +        rewrittenChildQuery.extractTerms(terms);, +        Query childQuery;, +        if (rewrittenChildQuery == null) {, +            childQuery = rewrittenChildQuery = searchContext.searcher().rewrite(originalChildQuery);, +        } else {, +            childQuery = rewrittenChildQuery;, +        }, +        return new ParentWeight(rewrittenChildQuery.createWeight(searcher));, +++ b/src/main/java/org/elasticsearch/index/search/child/ParentQuery.java, +    private final Query originalParentQuery;, +    private Query rewrittenParentQuery;]