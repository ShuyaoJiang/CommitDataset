[+++ b/server/src/test/java/org/elasticsearch/search/aggregations/bucket/FiltersTests.java, +import org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;, +import org.elasticsearch.search.aggregations.support.ValueType;, +import static org.hamcrest.Matchers.equalTo;, +, +        // test sub-agg filter that does rewrite, +        original = new TermsAggregationBuilder("terms", ValueType.BOOLEAN), +            .subAggregation(, +                new FiltersAggregationBuilder("my-agg", new KeyedFilter("my-filter",  new BoolQueryBuilder())), +            );, +        rewritten = original.rewrite(new QueryRewriteContext(xContentRegistry(), null, null, () -> 0L));, +        assertNotSame(original, rewritten);, +        assertNotEquals(original, rewritten);, +        assertThat(rewritten, instanceOf(TermsAggregationBuilder.class));, +        assertThat(rewritten.getSubAggregations().size(), equalTo(1));, +        AggregationBuilder subAgg = rewritten.getSubAggregations().get(0);, +        assertThat(subAgg, instanceOf(FiltersAggregationBuilder.class));, +        assertNotSame(original.getSubAggregations().get(0), subAgg);, +        assertEquals("my-agg", subAgg.getName());, +        assertSame(rewritten,, +            rewritten.rewrite(new QueryRewriteContext(xContentRegistry(), null, null, () -> 0L)));]