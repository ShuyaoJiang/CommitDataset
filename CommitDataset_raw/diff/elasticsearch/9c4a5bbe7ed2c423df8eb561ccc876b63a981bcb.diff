[+++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/stats/ClusterStatsNodes.java, +import java.util.HashMap;, +import java.util.Map;, +        static final String COORDINATING_ONLY = "coordinating_only";, +, +        private int total;, +        private Map<String, Integer> roles;, +, +        Counts() {, +            roles = new HashMap<>();, +            for (DiscoveryNode.Role role : DiscoveryNode.Role.values()) {, +                roles.put(role.getRoleName(), 0);, +            }, +            roles.put(COORDINATING_ONLY, 0);, +        }, +            if (nodeInfo.getNode().getRoles().size() == 0) {, +                Integer count = roles.get(COORDINATING_ONLY);, +                roles.put(COORDINATING_ONLY, ++count);, +                for (DiscoveryNode.Role role : nodeInfo.getNode().getRoles()) {, +                    Integer count = roles.get(role.getRoleName());, +                    roles.put(role.getRoleName(), ++count);, +        public Map<String, Integer> getRoles() {, +            return roles;, +        @SuppressWarnings("unchecked"), +            roles = (Map<String, Integer>)in.readGenericValue();, +            out.writeGenericValue(roles);, +            for (Map.Entry<String, Integer> entry : roles.entrySet()) {, +                builder.field(entry.getKey(), entry.getValue());, +            }, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/stats/ClusterStatsNodes.java, +import java.util.HashMap;, +import java.util.Map;, +        static final String COORDINATING_ONLY = "coordinating_only";, +, +        private int total;, +        private Map<String, Integer> roles;, +, +        Counts() {, +            roles = new HashMap<>();, +            for (DiscoveryNode.Role role : DiscoveryNode.Role.values()) {, +                roles.put(role.getRoleName(), 0);, +            }, +            roles.put(COORDINATING_ONLY, 0);, +        }, +            if (nodeInfo.getNode().getRoles().size() == 0) {, +                Integer count = roles.get(COORDINATING_ONLY);, +                roles.put(COORDINATING_ONLY, ++count);, +                for (DiscoveryNode.Role role : nodeInfo.getNode().getRoles()) {, +                    Integer count = roles.get(role.getRoleName());, +                    roles.put(role.getRoleName(), ++count);, +        public Map<String, Integer> getRoles() {, +            return roles;, +        @SuppressWarnings("unchecked"), +            roles = (Map<String, Integer>)in.readGenericValue();, +            out.writeGenericValue(roles);, +            for (Map.Entry<String, Integer> entry : roles.entrySet()) {, +                builder.field(entry.getKey(), entry.getValue());, +            }, +++ b/core/src/main/java/org/elasticsearch/rest/action/admin/cluster/stats/RestClusterStatsAction.java, +        client.admin().cluster().clusterStats(clusterStatsRequest, new RestToXContentListener<>(channel));, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/stats/ClusterStatsNodes.java, +import java.util.HashMap;, +import java.util.Map;, +        static final String COORDINATING_ONLY = "coordinating_only";, +, +        private int total;, +        private Map<String, Integer> roles;, +, +        Counts() {, +            roles = new HashMap<>();, +            for (DiscoveryNode.Role role : DiscoveryNode.Role.values()) {, +                roles.put(role.getRoleName(), 0);, +            }, +            roles.put(COORDINATING_ONLY, 0);, +        }, +            if (nodeInfo.getNode().getRoles().size() == 0) {, +                Integer count = roles.get(COORDINATING_ONLY);, +                roles.put(COORDINATING_ONLY, ++count);, +                for (DiscoveryNode.Role role : nodeInfo.getNode().getRoles()) {, +                    Integer count = roles.get(role.getRoleName());, +                    roles.put(role.getRoleName(), ++count);, +        public Map<String, Integer> getRoles() {, +            return roles;, +        @SuppressWarnings("unchecked"), +            roles = (Map<String, Integer>)in.readGenericValue();, +            out.writeGenericValue(roles);, +            for (Map.Entry<String, Integer> entry : roles.entrySet()) {, +                builder.field(entry.getKey(), entry.getValue());, +            }, +++ b/core/src/main/java/org/elasticsearch/rest/action/admin/cluster/stats/RestClusterStatsAction.java, +        client.admin().cluster().clusterStats(clusterStatsRequest, new RestToXContentListener<>(channel));, +++ b/core/src/test/java/org/elasticsearch/action/admin/cluster/stats/ClusterStatsIT.java, +import org.elasticsearch.cluster.node.DiscoveryNode;, +import java.util.HashMap;, +import java.util.Map;, +    private void assertCounts(ClusterStatsNodes.Counts counts, int total, Map<String, Integer> roles) {, +        assertThat(counts.getTotal(), equalTo(total));, +        assertThat(counts.getRoles(), equalTo(roles));, +        int total = 1;, +        Map<String, Integer> expectedCounts = new HashMap<>();]