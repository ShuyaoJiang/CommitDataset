[+++ b/server/src/test/java/org/elasticsearch/recovery/RelocationIT.java, +import org.elasticsearch.action.index.IndexResponse;, +    public void testRelocateWhileContinuouslyIndexingAndWaitingForRefresh() throws Exception {, +        final List<ActionFuture<IndexResponse>> pendingIndexResponses = new ArrayList<>();, +            pendingIndexResponses.add(client().prepareIndex("test", "type", Integer.toString(i)), +                .setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL), +                .setSource("field", "value" + i).execute());, +            pendingIndexResponses.add(client().prepareIndex("test", "type", Integer.toString(i)), +                .setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL), +                .setSource("field", "value" + i).execute());, +        assertBusy(() -> {, +            assertTrue(pendingIndexResponses.stream().allMatch(ActionFuture::isDone));, +        }, 1, TimeUnit.MINUTES);, +]