[+++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationActionTests.java, +        assertBusy(() -> assertThat(transport.capturedRequests().length, equalTo(1)));, +++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationActionTests.java, +        assertBusy(() -> assertThat(transport.capturedRequests().length, equalTo(1)));, +++ b/core/src/test/java/org/elasticsearch/cluster/MinimumMasterNodesIT.java, +        assertBusy(() -> {, +            ClusterState state1 = client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            assertThat(state1.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID), equalTo(true));, +        assertBusy(() -> assertThat(masterClusterService.state().nodes().getMasterNode(), nullValue()));, +++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationActionTests.java, +        assertBusy(() -> assertThat(transport.capturedRequests().length, equalTo(1)));, +++ b/core/src/test/java/org/elasticsearch/cluster/MinimumMasterNodesIT.java, +        assertBusy(() -> {, +            ClusterState state1 = client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            assertThat(state1.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID), equalTo(true));, +        assertBusy(() -> assertThat(masterClusterService.state().nodes().getMasterNode(), nullValue()));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/DelayedAllocationIT.java, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationActionTests.java, +        assertBusy(() -> assertThat(transport.capturedRequests().length, equalTo(1)));, +++ b/core/src/test/java/org/elasticsearch/cluster/MinimumMasterNodesIT.java, +        assertBusy(() -> {, +            ClusterState state1 = client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            assertThat(state1.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID), equalTo(true));, +        assertBusy(() -> assertThat(masterClusterService.state().nodes().getMasterNode(), nullValue()));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/DelayedAllocationIT.java, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/MockDiskUsagesIT.java, +        assertBusy(() -> {, +        assertBusy(() -> {, +        assertBusy(() -> {, +            ClusterStateResponse resp12 = client().admin().cluster().prepareState().get();, +            Iterator<RoutingNode> iter12 = resp12.getState().getRoutingNodes().iterator();, +            while (iter12.hasNext()) {, +                RoutingNode node = iter12.next();, +                        node.nodeId(), resp12.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +                nodesToShardCount.put(node.nodeId(), resp12.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +        assertBusy(() -> {, +            ClusterStateResponse resp1 = client().admin().cluster().prepareState().get();, +            Iterator<RoutingNode> iter1 = resp1.getState().getRoutingNodes().iterator();, +            while (iter1.hasNext()) {, +                RoutingNode node = iter1.next();, +                        node.nodeId(), resp1.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +                nodesToShardCount.put(node.nodeId(), resp1.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationActionTests.java, +        assertBusy(() -> assertThat(transport.capturedRequests().length, equalTo(1)));, +++ b/core/src/test/java/org/elasticsearch/cluster/MinimumMasterNodesIT.java, +        assertBusy(() -> {, +            ClusterState state1 = client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            assertThat(state1.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID), equalTo(true));, +        assertBusy(() -> assertThat(masterClusterService.state().nodes().getMasterNode(), nullValue()));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/DelayedAllocationIT.java, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/MockDiskUsagesIT.java, +        assertBusy(() -> {, +        assertBusy(() -> {, +        assertBusy(() -> {, +            ClusterStateResponse resp12 = client().admin().cluster().prepareState().get();, +            Iterator<RoutingNode> iter12 = resp12.getState().getRoutingNodes().iterator();, +            while (iter12.hasNext()) {, +                RoutingNode node = iter12.next();, +                        node.nodeId(), resp12.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +                nodesToShardCount.put(node.nodeId(), resp12.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +        assertBusy(() -> {, +            ClusterStateResponse resp1 = client().admin().cluster().prepareState().get();, +            Iterator<RoutingNode> iter1 = resp1.getState().getRoutingNodes().iterator();, +            while (iter1.hasNext()) {, +                RoutingNode node = iter1.next();, +                        node.nodeId(), resp1.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +                nodesToShardCount.put(node.nodeId(), resp1.getState().getRoutingNodes().node(node.nodeId()).numberOfOwningShards());, +++ b/core/src/test/java/org/elasticsearch/common/util/concurrent/EsExecutorsTests.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java, +        assertBusy(() -> {, +++ b/core/src/test/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationActionTests.java, +        assertBusy(() -> assertThat(transport.capturedRequests().length, equalTo(1)));, +++ b/core/src/test/java/org/elasticsearch/cluster/MinimumMasterNodesIT.java, +        assertBusy(() -> {, +            ClusterState state1 = client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();, +            assertThat(state1.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID), equalTo(true));, +        assertBusy(() -> assertThat(masterClusterService.state().nodes().getMasterNode(), nullValue()));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/DelayedAllocationIT.java, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +        assertBusy(() -> assertThat(client().admin().cluster().prepareState().all().get().getState().getRoutingNodes().unassigned().size() > 0, equalTo(true)));, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/MockDiskUsagesIT.java]