[+++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +                                      Set<IndexTemplateFilter> indexTemplateFilters, Environment env, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                    indicesService.createIndex(nodeServicesProvider, tmpImd, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +                                      Set<IndexTemplateFilter> indexTemplateFilters, Environment env, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                    indicesService.createIndex(nodeServicesProvider, tmpImd, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexAliasesService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +    public MetaDataIndexAliasesService(Settings settings, ClusterService clusterService, IndicesService indicesService, AliasValidator aliasValidator, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                                            indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +                                      Set<IndexTemplateFilter> indexTemplateFilters, Environment env, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                    indicesService.createIndex(nodeServicesProvider, tmpImd, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexAliasesService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +    public MetaDataIndexAliasesService(Settings settings, ClusterService clusterService, IndicesService indicesService, AliasValidator aliasValidator, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                                            indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +    public MetaDataMappingService(Settings settings, ClusterService clusterService, IndicesService indicesService, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +                        IndexService indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +                                      Set<IndexTemplateFilter> indexTemplateFilters, Environment env, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                    indicesService.createIndex(nodeServicesProvider, tmpImd, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexAliasesService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +    public MetaDataIndexAliasesService(Settings settings, ClusterService clusterService, IndicesService indicesService, AliasValidator aliasValidator, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                                            indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +    public MetaDataMappingService(Settings settings, ClusterService clusterService, IndicesService indicesService, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;, +                indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +                        IndexService indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +++ b/core/src/main/java/org/elasticsearch/index/IndexModule.java, +import org.elasticsearch.env.NodeEnvironment;, +import org.elasticsearch.indices.IndicesService;, +public final class IndexModule {, +    final SetOnce<EngineFactory> engineFactory = new SetOnce<>();, +    public IndexModule(IndexSettings indexSettings, IndexStoreConfig indexStoreConfig, AnalysisRegistry analysisRegistry) {, +, +    public IndexService newIndexService(NodeEnvironment environment, IndexService.ShardStoreDeleter shardStoreDeleter, NodeServicesProvider servicesProvider) throws IOException {, +        final IndexSettings settings = indexSettings.newWithListener(settingsConsumers);, +        IndexSearcherWrapperFactory searcherWrapperFactory = indexSearcherWrapper.get() == null ? (shard) -> null : indexSearcherWrapper.get();, +        IndexEventListener eventListener = freeze();, +        final String storeType = settings.getSettings().get(STORE_TYPE);, +        final IndexStore store;, +        if (storeType == null || isBuiltinType(storeType)) {, +            store = new IndexStore(settings, indexStoreConfig);, +        } else {, +            BiFunction<IndexSettings, IndexStoreConfig, IndexStore> factory = storeTypes.get(storeType);, +            if (factory == null) {, +                throw new IllegalArgumentException("Unknown store type [" + storeType + "]");, +            }, +            store = factory.apply(settings, indexStoreConfig);, +            if (store == null) {, +                throw new IllegalStateException("store must not be null");, +            }, +        }, +        final String queryCacheType = settings.getSettings().get(IndexModule.QUERY_CACHE_TYPE, IndexModule.INDEX_QUERY_CACHE);, +        final BiFunction<IndexSettings, IndicesQueryCache, QueryCache> queryCacheProvider = queryCaches.get(queryCacheType);, +        final QueryCache queryCache = queryCacheProvider.apply(settings, servicesProvider.getIndicesQueryCache());, +        return new IndexService(settings, environment, new SimilarityService(settings, similarities), shardStoreDeleter, analysisRegistry, engineFactory.get(),, +                servicesProvider, queryCache, store, eventListener, searcherWrapperFactory);, +    }, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +import org.elasticsearch.index.NodeServicesProvider;, +    private final NodeServicesProvider nodeServicesProvider;, +, +                                      Set<IndexTemplateFilter> indexTemplateFilters, Environment env, NodeServicesProvider nodeServicesProvider) {, +        this.nodeServicesProvider = nodeServicesProvider;]