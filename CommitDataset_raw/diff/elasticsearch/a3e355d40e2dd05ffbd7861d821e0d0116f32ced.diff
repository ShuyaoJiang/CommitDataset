[+++ b/src/main/java/org/elasticsearch/search/highlight/PostingsHighlighter.java, +                Snippet[] fieldSnippets = highlighter.highlightDoc(highlighterContext.fieldName, mapperHighlighterEntry.filteredQueryTerms, context.searcher(), hitContext.topLevelDocId(), numberOfFragments);, +++ b/src/main/java/org/elasticsearch/search/highlight/PostingsHighlighter.java, +                Snippet[] fieldSnippets = highlighter.highlightDoc(highlighterContext.fieldName, mapperHighlighterEntry.filteredQueryTerms, context.searcher(), hitContext.topLevelDocId(), numberOfFragments);, +++ b/src/test/java/org/elasticsearch/search/highlight/HighlighterSearchTests.java, +import java.util.HashMap;, +        Map<String, String> prefixes = new HashMap<String, String>(COUNT);, +, +            //generating text with word to highlight in a different position, +            //(https://github.com/elasticsearch/elasticsearch/issues/4103), +            String prefix = randomAsciiOfLengthBetween(5, 30);, +            prefixes.put(String.valueOf(i), prefix);, +            client().prepareIndex("test", "type1", Integer.toString(i)).setSource("field1", "Sentence " + prefix, +                    + " test. Sentence two.").get();, +            if (frequently()) {, +                refresh();, +            }, +            String prefix = prefixes.get(hit.id());, +            assertThat(hit.highlightFields().get("field1").fragments()[0].string(), equalTo("Sentence " + prefix + " <em>test</em>."));, +            String prefix = prefixes.get(hit.id());, +            assertThat(hit.highlightFields().get("field1").fragments()[0].string(), equalTo("Sentence " + prefix + " <em>test</em>."));]