[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/DoubleFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public DoubleFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final double v2 = script.runAsDouble();, +        script.setNextDocId(doc);, +        values[slot] = script.runAsDouble();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/DoubleFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public DoubleFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final double v2 = script.runAsDouble();, +        script.setNextDocId(doc);, +        values[slot] = script.runAsDouble();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/StringFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public StringFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final String val2 = script.run().toString();, +        script.setNextDocId(doc);, +        values[slot] = script.run().toString();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/DoubleFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public DoubleFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final double v2 = script.runAsDouble();, +        script.setNextDocId(doc);, +        values[slot] = script.runAsDouble();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/StringFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public StringFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final String val2 = script.run().toString();, +        script.setNextDocId(doc);, +        values[slot] = script.run().toString();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +import org.elasticsearch.script.SearchScript;, +        SearchScript searchScript = context.scriptService().search(context.lookup(), scriptLang, script, vars);, +        private final SearchScript script;, +        private ScriptScoreFunction(SearchScript script) {, +            script.setNextDocId(docId);, +            script.setNextScore(subQueryScore);, +            return script.runAsFloat();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/DoubleFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public DoubleFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final double v2 = script.runAsDouble();, +        script.setNextDocId(doc);, +        values[slot] = script.runAsDouble();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/sort/StringFieldsFunctionDataComparator.java, +import org.elasticsearch.script.SearchScript;, +    public static FieldComparatorSource comparatorSource(SearchScript script) {, +        private final SearchScript script;, +        private InnerSource(SearchScript script) {, +    private final SearchScript script;, +    public StringFieldsFunctionDataComparator(int numHits, SearchScript script) {, +        script.setNextDocId(doc);, +        final String val2 = script.run().toString();, +        script.setNextDocId(doc);, +        values[slot] = script.run().toString();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +import org.elasticsearch.script.SearchScript;, +        SearchScript searchScript = context.scriptService().search(context.lookup(), scriptLang, script, vars);, +        private final SearchScript script;, +        private ScriptScoreFunction(SearchScript script) {, +            script.setNextDocId(docId);, +            script.setNextScore(subQueryScore);, +            return script.runAsFloat();, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +import org.elasticsearch.script.SearchScript;, +        private final SearchScript searchScript;, +            this.searchScript = context.scriptService().search(context.lookup(), scriptLang, script, params);, +            private final SearchScript searchScript;, +            public ScriptDocSet(IndexReader reader, SearchScript searchScript) {, +                searchScript.setNextDocId(doc);]