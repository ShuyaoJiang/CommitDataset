[+++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +    public Function<Map<String, Object>, SearchScript> getLazySearchScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +    public Function<Map<String, Object>, ExecutableScript> getLazyExecutableScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +    public Function<Map<String, Object>, SearchScript> getLazySearchScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +    public Function<Map<String, Object>, ExecutableScript> getLazyExecutableScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregationBuilder.java, +        return new ScriptedMetricAggregatorFactory(name, type, searchMapScript, executableInitScript, executableCombineScript, reduceScript,, +                params, context, parent, subfactoriesBuilder, metaData);, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +    public Function<Map<String, Object>, SearchScript> getLazySearchScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +    public Function<Map<String, Object>, ExecutableScript> getLazyExecutableScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregationBuilder.java, +        return new ScriptedMetricAggregatorFactory(name, type, searchMapScript, executableInitScript, executableCombineScript, reduceScript,, +                params, context, parent, subfactoriesBuilder, metaData);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregatorFactory.java, +    public ScriptedMetricAggregatorFactory(String name, Type type, Function<Map<String, Object>, SearchScript> mapScript,, +            Function<Map<String, Object>, ExecutableScript> initScript, Function<Map<String, Object>, ExecutableScript> combineScript,, +            List<Object> clonedList = new ArrayList<>();, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +    public Function<Map<String, Object>, SearchScript> getLazySearchScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +    public Function<Map<String, Object>, ExecutableScript> getLazyExecutableScript(Script script, ScriptContext context,, +            Map<String, String> params) {, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregationBuilder.java, +        return new ScriptedMetricAggregatorFactory(name, type, searchMapScript, executableInitScript, executableCombineScript, reduceScript,, +                params, context, parent, subfactoriesBuilder, metaData);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregatorFactory.java, +    public ScriptedMetricAggregatorFactory(String name, Type type, Function<Map<String, Object>, SearchScript> mapScript,, +            Function<Map<String, Object>, ExecutableScript> initScript, Function<Map<String, Object>, ExecutableScript> combineScript,, +            List<Object> clonedList = new ArrayList<>();, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/tophits/TopHitsAggregatorFactory.java, +            AggregationContext context, AggregatorFactory<?> parent, AggregatorFactories.Builder subFactories, Map<String, Object> metaData), +            throws IOException {]