[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +, +    public static boolean isMatchAllQuery(Query query) {, +        if (query instanceof MatchAllDocsQuery) {, +            return true;, +        }, +        if (query instanceof DeletionAwareConstantScoreQuery) {, +            DeletionAwareConstantScoreQuery scoreQuery = (DeletionAwareConstantScoreQuery) query;, +            if (scoreQuery.getFilter() instanceof MatchAllDocsFilter) {, +                return true;, +            }, +        }, +        return false;, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +, +    public static boolean isMatchAllQuery(Query query) {, +        if (query instanceof MatchAllDocsQuery) {, +            return true;, +        }, +        if (query instanceof DeletionAwareConstantScoreQuery) {, +            DeletionAwareConstantScoreQuery scoreQuery = (DeletionAwareConstantScoreQuery) query;, +            if (scoreQuery.getFilter() instanceof MatchAllDocsFilter) {, +                return true;, +            }, +        }, +        return false;, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/FilteredQueryParser.java, +import org.apache.lucene.search.DeletionAwareConstantScoreQuery;, +import org.elasticsearch.common.lucene.search.Queries;, +        // if its a match_all query, use constant_score, +        if (Queries.isMatchAllQuery(query)) {, +            Query q = new DeletionAwareConstantScoreQuery(filter);, +            q.setBoost(boost);, +            return q;, +        }, +, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +, +    public static boolean isMatchAllQuery(Query query) {, +        if (query instanceof MatchAllDocsQuery) {, +            return true;, +        }, +        if (query instanceof DeletionAwareConstantScoreQuery) {, +            DeletionAwareConstantScoreQuery scoreQuery = (DeletionAwareConstantScoreQuery) query;, +            if (scoreQuery.getFilter() instanceof MatchAllDocsFilter) {, +                return true;, +            }, +        }, +        return false;, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/FilteredQueryParser.java, +import org.apache.lucene.search.DeletionAwareConstantScoreQuery;, +import org.elasticsearch.common.lucene.search.Queries;, +        // if its a match_all query, use constant_score, +        if (Queries.isMatchAllQuery(query)) {, +            Query q = new DeletionAwareConstantScoreQuery(filter);, +            q.setBoost(boost);, +            return q;, +        }, +, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/query/QueryFacetCollector.java, +import org.apache.lucene.search.Filter;, +import org.apache.lucene.search.FilteredQuery;, +import org.apache.lucene.search.Query;, +import org.apache.lucene.search.QueryWrapperFilter;, +import org.elasticsearch.common.lucene.search.Queries;, +            if (Queries.isMatchAllQuery(fQuery.getQuery())) {, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/search/Queries.java, +, +    public static boolean isMatchAllQuery(Query query) {, +        if (query instanceof MatchAllDocsQuery) {, +            return true;, +        }, +        if (query instanceof DeletionAwareConstantScoreQuery) {, +            DeletionAwareConstantScoreQuery scoreQuery = (DeletionAwareConstantScoreQuery) query;, +            if (scoreQuery.getFilter() instanceof MatchAllDocsFilter) {, +                return true;, +            }, +        }, +        return false;, +    }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/FilteredQueryParser.java, +import org.apache.lucene.search.DeletionAwareConstantScoreQuery;, +import org.elasticsearch.common.lucene.search.Queries;, +        // if its a match_all query, use constant_score, +        if (Queries.isMatchAllQuery(query)) {, +            Query q = new DeletionAwareConstantScoreQuery(filter);, +            q.setBoost(boost);, +            return q;, +        }, +, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/query/QueryFacetCollector.java, +import org.apache.lucene.search.Filter;, +import org.apache.lucene.search.FilteredQuery;, +import org.apache.lucene.search.Query;]