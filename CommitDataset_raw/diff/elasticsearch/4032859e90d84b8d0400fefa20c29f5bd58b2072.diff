[+++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.masterNodes;, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.masterNodes;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +            int masterNodes = clusterState.nodes().getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.masterNodes;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +            int masterNodes = clusterState.nodes().getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/publish/PublishClusterStateAction.java, +            final int totalMasterNodes = nodes.getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.masterNodes;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +            int masterNodes = clusterState.nodes().getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/publish/PublishClusterStateAction.java, +            final int totalMasterNodes = nodes.getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/gateway/Gateway.java, +        String[] nodesIds = clusterService.state().nodes().getMasterNodes().keys().toArray(String.class);, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.masterNodes;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +            int masterNodes = clusterState.nodes().getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/publish/PublishClusterStateAction.java, +            final int totalMasterNodes = nodes.getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/gateway/Gateway.java, +        String[] nodesIds = clusterService.state().nodes().getMasterNodes().keys().toArray(String.class);, +++ b/core/src/main/java/org/elasticsearch/gateway/GatewayService.java, +        } else if (recoverAfterMasterNodes != -1 && nodes.getMasterNodes().size() < recoverAfterMasterNodes) {, +                nodes.getMasterNodes().size(), recoverAfterMasterNodes);, +                } else if (expectedMasterNodes != -1 && (nodes.getMasterNodes().size() < expectedMasterNodes)) { // does not meet the expected..., +                    reason = "expecting [" + expectedMasterNodes + "] master nodes, but only have [" + nodes.getMasterNodes().size() + "]";, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.masterNodes;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +            int masterNodes = clusterState.nodes().getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/publish/PublishClusterStateAction.java, +            final int totalMasterNodes = nodes.getMasterNodes().size();, +++ b/core/src/main/java/org/elasticsearch/gateway/Gateway.java, +        String[] nodesIds = clusterService.state().nodes().getMasterNodes().keys().toArray(String.class);, +++ b/core/src/main/java/org/elasticsearch/gateway/GatewayService.java, +        } else if (recoverAfterMasterNodes != -1 && nodes.getMasterNodes().size() < recoverAfterMasterNodes) {, +                nodes.getMasterNodes().size(), recoverAfterMasterNodes);, +                } else if (expectedMasterNodes != -1 && (nodes.getMasterNodes().size() < expectedMasterNodes)) { // does not meet the expected..., +                    reason = "expecting [" + expectedMasterNodes + "] master nodes, but only have [" + nodes.getMasterNodes().size() + "]";, +++ b/core/src/test/java/org/elasticsearch/cluster/action/shard/ShardStateActionTests.java, +            masterBuilder.masterNodeId(clusterService.state().nodes().getMasterNodes().iterator().next().value.getId());]