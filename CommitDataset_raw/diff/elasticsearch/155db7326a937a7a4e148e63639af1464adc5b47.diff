[+++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/allocation/TransportClusterAllocationExplainAction.java, +                clusterInfo, System.nanoTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/allocation/TransportClusterAllocationExplainAction.java, +                clusterInfo, System.nanoTime());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/UnassignedInfo.java, +import org.elasticsearch.Version;, +        FORCED_EMPTY_PRIMARY,, +        /**, +         * Forced manually to allocate, +         */, +        MANUAL_ALLOCATION, +        if (out.getVersion().before(Version.V_6_0_0_beta2) && reason == Reason.MANUAL_ALLOCATION) {, +            out.writeByte((byte) Reason.ALLOCATION_FAILED.ordinal());, +        } else {, +        }, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/allocation/TransportClusterAllocationExplainAction.java, +                clusterInfo, System.nanoTime());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/UnassignedInfo.java, +import org.elasticsearch.Version;, +        FORCED_EMPTY_PRIMARY,, +        /**, +         * Forced manually to allocate, +         */, +        MANUAL_ALLOCATION, +        if (out.getVersion().before(Version.V_6_0_0_beta2) && reason == Reason.MANUAL_ALLOCATION) {, +            out.writeByte((byte) Reason.ALLOCATION_FAILED.ordinal());, +        } else {, +        }, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +            clusterInfoService.getClusterInfo(), currentNanoTime);, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +     * Reset failed allocation counter for unassigned shards, +     */, +    private void resetFailedAllocationCounter(RoutingAllocation allocation) {, +        final RoutingNodes.UnassignedShards.UnassignedIterator unassignedIterator = allocation.routingNodes().unassigned().iterator();, +        while (unassignedIterator.hasNext()) {, +            ShardRouting shardRouting = unassignedIterator.next();, +            UnassignedInfo unassignedInfo = shardRouting.unassignedInfo();, +            unassignedIterator.updateUnassigned(new UnassignedInfo(unassignedInfo.getNumFailedAllocations() > 0 ?, +                UnassignedInfo.Reason.MANUAL_ALLOCATION : unassignedInfo.getReason(), unassignedInfo.getMessage(),, +                unassignedInfo.getFailure(), 0, unassignedInfo.getUnassignedTimeInNanos(),, +                unassignedInfo.getUnassignedTimeInMillis(), unassignedInfo.isDelayed(),, +                unassignedInfo.getLastAllocationStatus()), shardRouting.recoverySource(), allocation.changes());, +        }, +    }, +, +    /**, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +, +        if (retryFailed) {, +            resetFailedAllocationCounter(allocation);, +        }, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/allocation/TransportClusterAllocationExplainAction.java, +                clusterInfo, System.nanoTime());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/UnassignedInfo.java, +import org.elasticsearch.Version;, +        FORCED_EMPTY_PRIMARY,, +        /**, +         * Forced manually to allocate, +         */, +        MANUAL_ALLOCATION, +        if (out.getVersion().before(Version.V_6_0_0_beta2) && reason == Reason.MANUAL_ALLOCATION) {, +            out.writeByte((byte) Reason.ALLOCATION_FAILED.ordinal());, +        } else {, +        }, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +            clusterInfoService.getClusterInfo(), currentNanoTime);, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +     * Reset failed allocation counter for unassigned shards, +     */, +    private void resetFailedAllocationCounter(RoutingAllocation allocation) {, +        final RoutingNodes.UnassignedShards.UnassignedIterator unassignedIterator = allocation.routingNodes().unassigned().iterator();, +        while (unassignedIterator.hasNext()) {, +            ShardRouting shardRouting = unassignedIterator.next();, +            UnassignedInfo unassignedInfo = shardRouting.unassignedInfo();, +            unassignedIterator.updateUnassigned(new UnassignedInfo(unassignedInfo.getNumFailedAllocations() > 0 ?, +                UnassignedInfo.Reason.MANUAL_ALLOCATION : unassignedInfo.getReason(), unassignedInfo.getMessage(),, +                unassignedInfo.getFailure(), 0, unassignedInfo.getUnassignedTimeInNanos(),, +                unassignedInfo.getUnassignedTimeInMillis(), unassignedInfo.isDelayed(),, +                unassignedInfo.getLastAllocationStatus()), shardRouting.recoverySource(), allocation.changes());, +        }, +    }, +, +    /**, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +, +        if (retryFailed) {, +            resetFailedAllocationCounter(allocation);, +        }, +            clusterInfoService.getClusterInfo(), currentNanoTime());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/RoutingAllocation.java, +                             long currentNanoTime) {, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/allocation/TransportClusterAllocationExplainAction.java, +                clusterInfo, System.nanoTime());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/UnassignedInfo.java, +import org.elasticsearch.Version;, +        FORCED_EMPTY_PRIMARY,]