[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/cache/filter/support/AbstractConcurrentMapFilterCache.java, +                ConcurrentMap<Filter, DocSet> prev = cache.cache.putIfAbsent(reader.getFieldCacheKey(), cachedFilters);, +                if (prev != null) {, +                    cachedFilters = prev;, +                }, +            DocSet prev = cachedFilters.putIfAbsent(filter, docSet);, +            if (prev != null) {, +                docSet = prev;, +            }, +            return docSet;, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/cache/filter/support/AbstractConcurrentMapFilterCache.java, +                ConcurrentMap<Filter, DocSet> prev = cache.cache.putIfAbsent(reader.getFieldCacheKey(), cachedFilters);, +                if (prev != null) {, +                    cachedFilters = prev;, +                }, +            DocSet prev = cachedFilters.putIfAbsent(filter, docSet);, +            if (prev != null) {, +                docSet = prev;, +            }, +            return docSet;, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/cache/filter/support/AbstractDoubleConcurrentMapFilterCache.java, +                ConcurrentMap<Filter, DocSet> prev = cache.cache.putIfAbsent(reader.getFieldCacheKey(), cachedFilters);, +                if (prev != null) {, +                    cachedFilters = prev;, +                }, +            DocSet prev = cachedFilters.putIfAbsent(filter, docSet);, +            if (prev != null) {, +                docSet = prev;, +            }, +            return docSet;, +                ConcurrentMap<Filter, DocSet> prev = cache.weakCache.putIfAbsent(reader.getFieldCacheKey(), weakCacheFilters);, +                if (prev != null) {, +                    weakCacheFilters = prev;, +                }, +            DocSet prev = weakCacheFilters.putIfAbsent(filter, docSet);, +            if (prev != null) {, +                docSet = prev;, +            }, +            return docSet;]