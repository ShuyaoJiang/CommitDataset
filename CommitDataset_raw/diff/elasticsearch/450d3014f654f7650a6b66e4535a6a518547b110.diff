[+++ b/server/src/test/java/org/elasticsearch/action/search/SearchAsyncActionTests.java, +        boolean doReplicas = randomBoolean();, +        int numShards = randomIntBetween(5, 10);, +        int numShardAttempts = numShards;, +        Boolean[] shardFailures = new Boolean[numShards];, +        // at least one response otherwise the entire request fails, +        shardFailures[randomIntBetween(0, shardFailures.length - 1)] = false;, +        for (int i = 0; i < shardFailures.length; i++) {, +            if (shardFailures[i] == null) {, +                boolean failure = randomBoolean();, +                shardFailures[i] = failure;, +                if (failure && doReplicas) {, +                    numShardAttempts++;, +                }, +            }, +        }, +        CountDownLatch latch = new CountDownLatch(numShardAttempts);, +            numShards, doReplicas, primaryNode, replicaNode);, +                        numRequests.incrementAndGet(); // only count this once per shard copy, +                        if (shardFailures[shard.shardId().id()]) {, +        assertEquals(numShards, numRequests.get());]