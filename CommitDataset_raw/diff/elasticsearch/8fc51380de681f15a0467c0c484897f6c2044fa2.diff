[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/LoggedExec.groovy, +, +    protected ByteArrayOutputStream output = new ByteArrayOutputStream(), +, +            standardOutput = output, +            errorOutput = output, +                    output.toString('UTF-8').eachLine { line -> logger.error(line) }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/LoggedExec.groovy, +, +    protected ByteArrayOutputStream output = new ByteArrayOutputStream(), +, +            standardOutput = output, +            errorOutput = output, +                    output.toString('UTF-8').eachLine { line -> logger.error(line) }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/BatsOverVagrantTask.groovy, +import org.gradle.api.tasks.Input, +public class BatsOverVagrantTask extends VagrantCommandTask {, +, +    @Input, +        project.afterEvaluate {, +            args 'ssh', boxName, '--command', command, +        }, +    @Override, +    protected OutputStream createLoggerOutputStream() {, +        return new TapLoggerOutputStream(, +                command: commandLine.join(' '),, +                logger: logger), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/LoggedExec.groovy, +, +    protected ByteArrayOutputStream output = new ByteArrayOutputStream(), +, +            standardOutput = output, +            errorOutput = output, +                    output.toString('UTF-8').eachLine { line -> logger.error(line) }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/BatsOverVagrantTask.groovy, +import org.gradle.api.tasks.Input, +public class BatsOverVagrantTask extends VagrantCommandTask {, +, +    @Input, +        project.afterEvaluate {, +            args 'ssh', boxName, '--command', command, +        }, +    @Override, +    protected OutputStream createLoggerOutputStream() {, +        return new TapLoggerOutputStream(, +                command: commandLine.join(' '),, +                logger: logger), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/TapLoggerOutputStream.groovy, +    progressLogger.setDescription("TAP output for `$args.command`"), +    progressLogger.progress("Starting `$args.command`..."), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/LoggedExec.groovy, +, +    protected ByteArrayOutputStream output = new ByteArrayOutputStream(), +, +            standardOutput = output, +            errorOutput = output, +                    output.toString('UTF-8').eachLine { line -> logger.error(line) }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/BatsOverVagrantTask.groovy, +import org.gradle.api.tasks.Input, +public class BatsOverVagrantTask extends VagrantCommandTask {, +, +    @Input, +        project.afterEvaluate {, +            args 'ssh', boxName, '--command', command, +        }, +    @Override, +    protected OutputStream createLoggerOutputStream() {, +        return new TapLoggerOutputStream(, +                command: commandLine.join(' '),, +                logger: logger), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/TapLoggerOutputStream.groovy, +    progressLogger.setDescription("TAP output for `$args.command`"), +    progressLogger.progress("Starting `$args.command`..."), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/VagrantCommandTask.groovy, +import org.apache.commons.io.output.TeeOutputStream, +import org.elasticsearch.gradle.LoggedExec, +import org.gradle.api.tasks.Input, +public class VagrantCommandTask extends LoggedExec {, +    @Input, +    String boxName, +, +    public VagrantCommandTask() {, +        executable = 'vagrant', +        project.afterEvaluate {, +            // It'd be nice if --machine-readable were, well, nice, +            standardOutput = new TeeOutputStream(standardOutput, createLoggerOutputStream()), +        }, +    }, +, +    protected OutputStream createLoggerOutputStream() {, +        return new VagrantLoggerOutputStream(, +            command: commandLine.join(' '),, +            factory: getProgressLoggerFactory(),, +            /* Vagrant tends to output a lot of stuff, but most of the important, +              stuff starts with ==> $box */, +            squashedPrefix: "==> $boxName: "), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/LoggedExec.groovy, +, +    protected ByteArrayOutputStream output = new ByteArrayOutputStream(), +]