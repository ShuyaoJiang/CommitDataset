[+++ b/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java, +import java.util.Collections;, +import java.util.HashSet;, +    private final Set<Tuple<DiscoveryNode, JoinRequest>> pendingOutgoingJoins = Collections.synchronizedSet(new HashSet<>());, +        this.joinTaskExecutor = new JoinTaskExecutor(allocationService, logger) {, +        return pendingOutgoingJoins.isEmpty() == false;, +    void sendStartJoinRequest(final StartJoinRequest startJoinRequest, final DiscoveryNode destination) {, +    void sendValidateJoinRequest(DiscoveryNode node, ClusterState state, ActionListener<TransportResponse.Empty> listener) {, +++ b/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java, +import java.util.Collections;, +import java.util.HashSet;, +    private final Set<Tuple<DiscoveryNode, JoinRequest>> pendingOutgoingJoins = Collections.synchronizedSet(new HashSet<>());, +        this.joinTaskExecutor = new JoinTaskExecutor(allocationService, logger) {, +        return pendingOutgoingJoins.isEmpty() == false;, +    void sendStartJoinRequest(final StartJoinRequest startJoinRequest, final DiscoveryNode destination) {, +    void sendValidateJoinRequest(DiscoveryNode node, ClusterState state, ActionListener<TransportResponse.Empty> listener) {, +++ b/server/src/main/java/org/elasticsearch/cluster/coordination/JoinTaskExecutor.java, +    public JoinTaskExecutor(AllocationService allocationService, Logger logger) {, +++ b/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java, +import java.util.Collections;, +import java.util.HashSet;, +    private final Set<Tuple<DiscoveryNode, JoinRequest>> pendingOutgoingJoins = Collections.synchronizedSet(new HashSet<>());, +        this.joinTaskExecutor = new JoinTaskExecutor(allocationService, logger) {, +        return pendingOutgoingJoins.isEmpty() == false;, +    void sendStartJoinRequest(final StartJoinRequest startJoinRequest, final DiscoveryNode destination) {, +    void sendValidateJoinRequest(DiscoveryNode node, ClusterState state, ActionListener<TransportResponse.Empty> listener) {, +++ b/server/src/main/java/org/elasticsearch/cluster/coordination/JoinTaskExecutor.java, +    public JoinTaskExecutor(AllocationService allocationService, Logger logger) {, +++ b/server/src/test/java/org/elasticsearch/indices/cluster/ClusterStateChanges.java, +        joinTaskExecutor = new JoinTaskExecutor(allocationService, logger);]