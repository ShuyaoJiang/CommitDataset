[+++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyManualExecutionIT.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 100; return true")).build())), +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 10000; return true")).build())), +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyManualExecutionIT.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 100; return true")).build())), +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 10000; return true")).build())), +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyScriptConditionIT.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +import static org.elasticsearch.messy.tests.MessyTestUtils.createScriptService;, +    private ScriptService scriptService;, +        scriptService = createScriptService(THREAD_POOL);, +                new ExecutableScriptCondition(new ScriptCondition(WatcherScript.inline(, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyManualExecutionIT.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 100; return true")).build())), +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 10000; return true")).build())), +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyScriptConditionIT.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +import static org.elasticsearch.messy.tests.MessyTestUtils.createScriptService;, +    private ScriptService scriptService;, +        scriptService = createScriptService(THREAD_POOL);, +                new ExecutableScriptCondition(new ScriptCondition(WatcherScript.inline(, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +    public static ScriptService createScriptService(ThreadPool tp) throws Exception {, +        ScriptContextRegistry scriptContextRegistry = new ScriptContextRegistry(Arrays.asList(WatcherScript.CTX_PLUGIN));, +        return new ScriptService(settings, new Environment(settings), new ResourceWatcherService(settings, tp),, +                                 scriptEngineRegistry, scriptContextRegistry, scriptSettings);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyManualExecutionIT.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 100; return true")).build())), +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 10000; return true")).build())), +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyScriptConditionIT.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +import static org.elasticsearch.messy.tests.MessyTestUtils.createScriptService;, +    private ScriptService scriptService;, +        scriptService = createScriptService(THREAD_POOL);, +                new ExecutableScriptCondition(new ScriptCondition(WatcherScript.inline(, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +    public static ScriptService createScriptService(ThreadPool tp) throws Exception {, +        ScriptContextRegistry scriptContextRegistry = new ScriptContextRegistry(Arrays.asList(WatcherScript.CTX_PLUGIN));, +        return new ScriptService(settings, new Environment(settings), new ResourceWatcherService(settings, tp),, +                                 scriptEngineRegistry, scriptContextRegistry, scriptSettings);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/ScriptConditionSearchIT.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +    private ScriptService scriptService;, +        scriptService = MessyTestUtils.createScriptService(tp);, +                new ScriptCondition(WatcherScript.inline("ctx.payload.aggregations.rate.buckets[0]?.doc_count >= 5").build()),, +                WatcherScript.inline("ctx.payload.hits?.hits[0]?._score == 1.0").build()), logger, scriptService);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyManualExecutionIT.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 100; return true")).build())), +                .condition(new ScriptCondition((new WatcherScript.Builder.Inline("sleep 10000; return true")).build())), +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyScriptConditionIT.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +import static org.elasticsearch.messy.tests.MessyTestUtils.createScriptService;, +    private ScriptService scriptService;, +        scriptService = createScriptService(THREAD_POOL);, +                new ExecutableScriptCondition(new ScriptCondition(WatcherScript.inline(, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +    public static ScriptService createScriptService(ThreadPool tp) throws Exception {, +        ScriptContextRegistry scriptContextRegistry = new ScriptContextRegistry(Arrays.asList(WatcherScript.CTX_PLUGIN));, +        return new ScriptService(settings, new Environment(settings), new ResourceWatcherService(settings, tp),, +                                 scriptEngineRegistry, scriptContextRegistry, scriptSettings);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/ScriptConditionSearchIT.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +    private ScriptService scriptService;, +        scriptService = MessyTestUtils.createScriptService(tp);, +                new ScriptCondition(WatcherScript.inline("ctx.payload.aggregations.rate.buckets[0]?.doc_count >= 5").build()),, +                WatcherScript.inline("ctx.payload.hits?.hits[0]?._score == 1.0").build()), logger, scriptService);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/ScriptConditionTests.java, +import org.elasticsearch.script.ScriptService;, +import org.elasticsearch.xpack.watcher.support.WatcherScript;, +import static org.elasticsearch.messy.tests.MessyTestUtils.createScriptService;, +        ScriptService scriptService = createScriptService(tp);, +                new ScriptCondition(WatcherScript.inline("ctx.payload.hits.total > 1").build()), logger, scriptService);, +        ScriptService scriptService = createScriptService(tp);, +        WatcherScript script = WatcherScript.inline("ctx.payload.hits.total > threshold"), +                .lang(WatcherScript.DEFAULT_LANG).params(singletonMap("threshold", 1)).build();, +        ScriptConditionFactory factory = new ScriptConditionFactory(Settings.builder().build(), createScriptService(tp));, +        ScriptConditionFactory factory = new ScriptConditionFactory(Settings.builder().build(), createScriptService(tp));, +        ScriptConditionFactory conditionParser = new ScriptConditionFactory(Settings.builder().build(), createScriptService(tp));, +        ScriptConditionFactory conditionParser = new ScriptConditionFactory(Settings.builder().build(), createScriptService(tp));, +        ScriptService scriptService = createScriptService(tp);, +                new ScriptCondition(WatcherScript.inline("null.foo").build()), logger, scriptService);, +        ScriptService scriptService = createScriptService(tp);, +                new ScriptCondition(WatcherScript.inline("return new Object()").build()), logger, scriptService);, +        ScriptService scriptService = createScriptService(tp);, +                new ScriptCondition(WatcherScript.inline("ctx.trigger.scheduled_time.getMillis() < new Date().time ").build()),, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/GroovyManualExecutionIT.java]