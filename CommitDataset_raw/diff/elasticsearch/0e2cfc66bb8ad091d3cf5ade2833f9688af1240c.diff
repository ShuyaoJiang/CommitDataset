[+++ b/core/src/test/java/org/elasticsearch/common/xcontent/XContentParserTests.java, +import java.util.Collections;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.singletonMap;, +, +    public void testEmptyList() throws IOException {, +        XContentBuilder builder = XContentFactory.jsonBuilder().startObject(), +                .startArray("some_array"), +                .endArray().endObject();, +, +        try (XContentParser parser = createParser(JsonXContent.jsonXContent, builder.string())) {, +            assertEquals(XContentParser.Token.START_OBJECT, parser.nextToken());, +            assertEquals(XContentParser.Token.FIELD_NAME, parser.nextToken());, +            assertEquals("some_array", parser.currentName());, +            if (random().nextBoolean()) {, +                // sometimes read the start array token, sometimes not, +                assertEquals(XContentParser.Token.START_ARRAY, parser.nextToken());, +            }, +            assertEquals(Collections.emptyList(), parser.list());, +        }, +    }, +, +    public void testSimpleList() throws IOException {, +        XContentBuilder builder = XContentFactory.jsonBuilder().startObject(), +                .startArray("some_array"), +                .value(1), +                .value(3), +                .value(0), +                .endArray().endObject();, +, +        try (XContentParser parser = createParser(JsonXContent.jsonXContent, builder.string())) {, +            assertEquals(XContentParser.Token.START_OBJECT, parser.nextToken());, +            assertEquals(XContentParser.Token.FIELD_NAME, parser.nextToken());, +            assertEquals("some_array", parser.currentName());, +            if (random().nextBoolean()) {, +                // sometimes read the start array token, sometimes not, +                assertEquals(XContentParser.Token.START_ARRAY, parser.nextToken());, +            }, +            assertEquals(Arrays.asList(1, 3, 0), parser.list());, +        }, +    }, +, +    public void testNestedList() throws IOException {, +        XContentBuilder builder = XContentFactory.jsonBuilder().startObject(), +                .startArray("some_array"), +                .startArray().endArray(), +                .startArray().value(1).value(3).endArray(), +                .startArray().value(2).endArray(), +                .endArray().endObject();, +, +        try (XContentParser parser = createParser(JsonXContent.jsonXContent, builder.string())) {, +            assertEquals(XContentParser.Token.START_OBJECT, parser.nextToken());, +            assertEquals(XContentParser.Token.FIELD_NAME, parser.nextToken());, +            assertEquals("some_array", parser.currentName());, +            if (random().nextBoolean()) {, +                // sometimes read the start array token, sometimes not, +                assertEquals(XContentParser.Token.START_ARRAY, parser.nextToken());, +            }, +            assertEquals(, +                    Arrays.asList(Collections.<Integer>emptyList(), Arrays.asList(1, 3), Arrays.asList(2)),, +                    parser.list());, +        }, +    }, +, +    public void testNestedMapInList() throws IOException {, +        XContentBuilder builder = XContentFactory.jsonBuilder().startObject(), +                .startArray("some_array"), +                .startObject().field("foo", "bar").endObject(), +                .startObject().endObject(), +                .endArray().endObject();, +, +        try (XContentParser parser = createParser(JsonXContent.jsonXContent, builder.string())) {, +            assertEquals(XContentParser.Token.START_OBJECT, parser.nextToken());, +            assertEquals(XContentParser.Token.FIELD_NAME, parser.nextToken());, +            assertEquals("some_array", parser.currentName());, +            if (random().nextBoolean()) {, +                // sometimes read the start array token, sometimes not, +                assertEquals(XContentParser.Token.START_ARRAY, parser.nextToken());, +            }, +            assertEquals(, +                    Arrays.asList(singletonMap("foo", "bar"), emptyMap()),, +                    parser.list());, +        }, +    }, +++ b/core/src/test/java/org/elasticsearch/common/xcontent/XContentParserTests.java, +import java.util.Collections;, +import static java.util.Collections.emptyMap;, +import static java.util.Collections.singletonMap;, +, +    public void testEmptyList() throws IOException {, +        XContentBuilder builder = XContentFactory.jsonBuilder().startObject(), +                .startArray("some_array"), +                .endArray().endObject();, +, +        try (XContentParser parser = createParser(JsonXContent.jsonXContent, builder.string())) {, +            assertEquals(XContentParser.Token.START_OBJECT, parser.nextToken());, +            assertEquals(XContentParser.Token.FIELD_NAME, parser.nextToken());, +            assertEquals("some_array", parser.currentName());, +            if (random().nextBoolean()) {, +                // sometimes read the start array token, sometimes not]