[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/query/QueryFacetCollector.java, +import org.apache.lucene.search.*;, +            this.filter = filterCache.weakCache(new QueryWrapperFilter(query));, +        } else if (query instanceof DeletionAwareConstantScoreQuery) {, +            return ((DeletionAwareConstantScoreQuery) query).getFilter();, +        } else if (query instanceof ConstantScoreQuery) {, +            return ((ConstantScoreQuery) query).getFilter();]