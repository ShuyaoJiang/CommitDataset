[+++ b/src/main/java/org/elasticsearch/search/suggest/completion/AnalyzingCompletionLookupProvider.java, +                        assert build != null || docCount == 0 : "the FST is null but docCount is != 0 actual value: [" + docCount + "]";, +                        /*, +                         * it's possible that the FST is null if we have 2 segments that get merged, +                         * and all docs that have a value in this field are deleted. This will cause, +                         * a consumer to be created but it doesn't consume any values causing the FSTBuilder, +                         * to return null., +                         */, +                        if (build != null) {, +                    }, +                    if (fields == null || fields.length == 0) {, +                        continue;, +                    }, +++ b/src/main/java/org/elasticsearch/search/suggest/completion/AnalyzingCompletionLookupProvider.java, +                        assert build != null || docCount == 0 : "the FST is null but docCount is != 0 actual value: [" + docCount + "]";, +                        /*, +                         * it's possible that the FST is null if we have 2 segments that get merged, +                         * and all docs that have a value in this field are deleted. This will cause, +                         * a consumer to be created but it doesn't consume any values causing the FSTBuilder, +                         * to return null., +                         */, +                        if (build != null) {, +                    }, +                    if (fields == null || fields.length == 0) {, +                        continue;, +                    }, +++ b/src/main/java/org/elasticsearch/search/suggest/completion/CompletionSuggester.java, +import org.elasticsearch.search.suggest.Suggest;, +import org.elasticsearch.search.suggest.SuggestContextParser;, +import org.elasticsearch.search.suggest.Suggester;, +                final Completion090PostingsFormat.CompletionTerms lookupTerms = (Completion090PostingsFormat.CompletionTerms) terms;, +                final Lookup lookup = lookupTerms.getLookup(suggestionContext.mapper(), suggestionContext);, +                if (lookup == null) {, +                    // we don't have a lookup for this segment.. this might be possible if a merge dropped all, +                    // docs from the segment that had a value in this segment., +                    continue;, +                }, +++ b/src/main/java/org/elasticsearch/search/suggest/completion/AnalyzingCompletionLookupProvider.java, +                        assert build != null || docCount == 0 : "the FST is null but docCount is != 0 actual value: [" + docCount + "]";, +                        /*, +                         * it's possible that the FST is null if we have 2 segments that get merged, +                         * and all docs that have a value in this field are deleted. This will cause, +                         * a consumer to be created but it doesn't consume any values causing the FSTBuilder, +                         * to return null., +                         */, +                        if (build != null) {, +                    }, +                    if (fields == null || fields.length == 0) {, +                        continue;, +                    }, +++ b/src/main/java/org/elasticsearch/search/suggest/completion/CompletionSuggester.java, +import org.elasticsearch.search.suggest.Suggest;, +import org.elasticsearch.search.suggest.SuggestContextParser;, +import org.elasticsearch.search.suggest.Suggester;, +                final Completion090PostingsFormat.CompletionTerms lookupTerms = (Completion090PostingsFormat.CompletionTerms) terms;, +                final Lookup lookup = lookupTerms.getLookup(suggestionContext.mapper(), suggestionContext);, +                if (lookup == null) {, +                    // we don't have a lookup for this segment.. this might be possible if a merge dropped all, +                    // docs from the segment that had a value in this segment., +                    continue;, +                }, +++ b/src/test/java/org/elasticsearch/test/integration/search/suggest/CompletionPostingsFormatTest.java, +    , +    @Test, +    public void testNoDocs() throws IOException {, +        AnalyzingCompletionLookupProvider provider = new AnalyzingCompletionLookupProvider(true, false, true, true);, +        RAMDirectory dir = new RAMDirectory();, +        IndexOutput output = dir.createOutput("foo.txt", IOContext.DEFAULT);, +        FieldsConsumer consumer = provider.consumer(output);, +        FieldInfo fieldInfo = new FieldInfo("foo", true, 1, false, true, true, IndexOptions.DOCS_AND_FREQS_AND_POSITIONS,, +                DocValuesType.SORTED, DocValuesType.BINARY, new HashMap<String, String>());, +        TermsConsumer addField = consumer.addField(fieldInfo);, +        addField.finish(0, 0, 0);, +        consumer.close();, +        output.close();, +, +        IndexInput input = dir.openInput("foo.txt", IOContext.DEFAULT);, +        LookupFactory load = provider.load(input);, +        PostingsFormatProvider format = new PreBuiltPostingsFormatProvider(new ElasticSearch090PostingsFormat());, +        NamedAnalyzer analyzer = new NamedAnalyzer("foo", new StandardAnalyzer(TEST_VERSION_CURRENT));, +        assertNull(load.getLookup(new CompletionFieldMapper(new Names("foo"), analyzer, analyzer, format, null, true, true, true), new CompletionSuggestionContext(null)));, +        dir.close();, +    }, +++ b/src/main/java/org/elasticsearch/search/suggest/completion/AnalyzingCompletionLookupProvider.java, +                        assert build != null || docCount == 0 : "the FST is null but docCount is != 0 actual value: [" + docCount + "]";, +                        /*, +                         * it's possible that the FST is null if we have 2 segments that get merged, +                         * and all docs that have a value in this field are deleted. This will cause, +                         * a consumer to be created but it doesn't consume any values causing the FSTBuilder, +                         * to return null., +                         */, +                        if (build != null) {, +                    }, +                    if (fields == null || fields.length == 0) {, +                        continue;, +                    }, +++ b/src/main/java/org/elasticsearch/search/suggest/completion/CompletionSuggester.java, +import org.elasticsearch.search.suggest.Suggest;, +import org.elasticsearch.search.suggest.SuggestContextParser;, +import org.elasticsearch.search.suggest.Suggester;]