[+++ b/core/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java, +        if (fieldNamesFieldType == null) {, +            return new MatchNoDocsQuery("No mappings yet");, +        }, +++ b/core/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java, +        if (fieldNamesFieldType == null) {, +            return new MatchNoDocsQuery("No mappings yet");, +        }, +++ b/core/src/test/java/org/elasticsearch/index/query/QueryStringQueryBuilderTests.java, +        Query expected;, +        if (getCurrentTypes().length > 0) {, +            expected = new ConstantScoreQuery(new TermQuery(new Term("_field_names", "foo")));, +        } else {, +            expected = new MatchNoDocsQuery();, +        }, +        assumeTrue("No types", getCurrentTypes().length > 0);, +        try {, +        } finally {, +            // restore mappings as they were before, +    }, +++ b/core/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java, +        if (fieldNamesFieldType == null) {, +            return new MatchNoDocsQuery("No mappings yet");, +        }, +++ b/core/src/test/java/org/elasticsearch/index/query/QueryStringQueryBuilderTests.java, +        Query expected;, +        if (getCurrentTypes().length > 0) {, +            expected = new ConstantScoreQuery(new TermQuery(new Term("_field_names", "foo")));, +        } else {, +            expected = new MatchNoDocsQuery();, +        }, +        assumeTrue("No types", getCurrentTypes().length > 0);, +        try {, +        } finally {, +            // restore mappings as they were before, +    }, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +        return currentTypes;, +        switch (random().nextInt(3)) {, +        case 0:, +            currentTypes = new String[0]; // no types, +            break;, +        default:, +            break;, +        }]