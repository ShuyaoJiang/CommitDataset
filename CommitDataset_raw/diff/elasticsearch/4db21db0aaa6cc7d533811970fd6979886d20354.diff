[+++ b/modules/reindex/src/test/java/org/elasticsearch/index/reindex/RethrottleTests.java, +import static org.hamcrest.Matchers.allOf;, +import static org.hamcrest.Matchers.greaterThan;, +import static org.hamcrest.Matchers.lessThan;, +        TaskGroup taskGroupToRethrottle = findTaskToRethrottle(actionName, request.request().getSlices());, +        TaskId taskToRethrottle = taskGroupToRethrottle.getTaskInfo().getTaskId();, +, +        if (request.request().getSlices() == 1) {, +            assertThat(taskGroupToRethrottle.getChildTasks(), empty());, +        } else {, +            // There should be a sane number of child tasks running, +            assertThat(taskGroupToRethrottle.getChildTasks(),, +                    hasSize(allOf(greaterThanOrEqualTo(1), lessThanOrEqualTo(request.request().getSlices()))));, +            // Wait for all of the sub tasks to start (or finish, some might finish early, all that matters is that not all do), +            assertBusy(() -> {, +                BulkByScrollTask.Status parent = (BulkByScrollTask.Status) client().admin().cluster().prepareGetTask(taskToRethrottle).get(), +                        .getTask().getTask().getStatus();, +                long finishedSubTasks = parent.getSliceStatuses().stream().filter(s -> s != null).count();, +                ListTasksResponse list = client().admin().cluster().prepareListTasks().setParentTaskId(taskToRethrottle).get();, +                list.rethrowFailures("subtasks");, +                assertThat(finishedSubTasks + list.getTasks().size(), greaterThanOrEqualTo((long) request.request().getSlices()));, +                assertThat(list.getTasks().size(), greaterThan(0));, +            });, +        }, +    private TaskGroup findTaskToRethrottle(String actionName, int sliceCount) {, +            ListTasksResponse tasks = client().admin().cluster().prepareListTasks().setActions(actionName).setDetailed(true).get();, +            assertThat(tasks.getTaskGroups(), hasSize(lessThan(2)));, +            if (0 == tasks.getTaskGroups().size()) {, +            TaskGroup taskGroup = tasks.getTaskGroups().get(0);, +            if (sliceCount != 1 && taskGroup.getChildTasks().size() == 0) {, +                // If there are child tasks wait for at least one to start, +                continue;, +            return taskGroup;, +        throw new AssertionError("Couldn't find tasks to rethrottle. Here are the running tasks " +, +                client().admin().cluster().prepareListTasks().get());]