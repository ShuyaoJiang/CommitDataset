[+++ b/docs/reference/search/aggregations/bucket.asciidoc, +, +include::bucket/tophits-aggregation.asciidoc[], +++ b/docs/reference/search/aggregations/bucket.asciidoc, +, +include::bucket/tophits-aggregation.asciidoc[], +++ b/docs/reference/search/aggregations/bucket/tophits-aggregation.asciidoc, +[[search-aggregations-bucket-top-hits-aggregation]], +=== Top hits Aggregation, +, +coming[1.3.0], +, +The `top_hits` aggregator keeps track of the most relevant document being aggregated. This aggregator is intended to be, +used as a sub aggregator, so that the top matching documents can be aggregated per bucket., +, +The `top_hits` aggregator can effectively be used to group result sets by certain fields via a bucket aggregator., +One or more bucket aggregators determines by which properties a result set get sliced into., +, +This aggregator can't hold any sub-aggregators and therefor can only be used as a leaf aggregator., +, +==== Options, +, +* `size` - The maximum number of top matching hits to return per bucket. By default the top three matching hits are returned., +* `sort` - How the top matching hits should be sorted. By default the hits are sorted by the score of the main query., +, +==== Supported per hit features, +, +The top_hits aggregation returns regular search hits, because of this many per hit features can be supported:, +, +* <<search-request-highlighting,Highlighting>>, +* <<search-request-explain,Explain>>, +* <<search-request-named-queries-and-filters,Named filters and queries>>, +* <<search-request-source-filtering,Source filtering>>, +* <<search-request-script-fields,Script fields>>, +* <<search-request-fielddata-fields,Fielddata fields>>, +* <<search-request-version,Include versions>>, +, +==== Example, +, +In the following example we group the questions by tag and per tag we show the last active question. For each question, +only the title field is being included in the source., +, +[source,js], +--------------------------------------------------, +{, +    "aggs": {, +        "terms": {, +            "top-tags": {, +                "field": "tags",, +                "size": 3, +            },, +            "aggs": {, +                "top_tag_hits": {, +                    "top_hits": {, +                        "sort": [, +                            {, +                                "last_activity_date": {, +                                    "order": "desc", +                                }, +                            }, +                        ],, +                        "_source": {, +                            "include": [, +                                "title", +                            ], +                        },, +                        "size" : 1, +                    }, +                }, +            }, +        }, +    }, +}, +--------------------------------------------------, +, +Possible response snippet:, +, +[source,js], +--------------------------------------------------, +"aggregations": {, +  "top-tags": {, +     "buckets": [, +        {, +           "key": "windows-7",, +           "doc_count": 25365,, +           "top_tags_hits": {, +              "hits": {, +                 "total": 25365,, +                 "max_score": 1,, +                 "hits": [, +                    {, +                       "_index": "stack",, +                       "_type": "question",, +                       "_id": "602679",, +                       "_score": 1,, +                       "_source": {, +                          "title": "Windows port opening", +                       },, +                       "sort": [, +                          1370143231177]