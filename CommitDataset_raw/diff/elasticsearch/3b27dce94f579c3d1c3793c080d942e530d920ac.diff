[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +     * Returns a NodeInfo object for the first node in the cluster., +    static NodeInfo setup(Project project, Task task, ClusterConfiguration config) {, +        return nodes[0], +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +     * Returns a NodeInfo object for the first node in the cluster., +    static NodeInfo setup(Project project, Task task, ClusterConfiguration config) {, +        return nodes[0], +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/RestIntegTestTask.groovy, +            NodeInfo node = ClusterFormationTasks.setup(project, this, clusterConfig), +            systemProperty('tests.rest.cluster', "${-> node.httpUri()}"), +            // TODO: our "client" qa tests currently use the rest-test plugin. instead they should have their own plugin, +            // that sets up the test cluster and passes this transport uri instead of http uri. Until then, we pass, +            // both as separate sysprops, +            systemProperty('tests.cluster', "${-> node.transportUri()}"), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +     * Returns a NodeInfo object for the first node in the cluster., +    static NodeInfo setup(Project project, Task task, ClusterConfiguration config) {, +        return nodes[0], +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/RestIntegTestTask.groovy, +            NodeInfo node = ClusterFormationTasks.setup(project, this, clusterConfig), +            systemProperty('tests.rest.cluster', "${-> node.httpUri()}"), +            // TODO: our "client" qa tests currently use the rest-test plugin. instead they should have their own plugin, +            // that sets up the test cluster and passes this transport uri instead of http uri. Until then, we pass, +            // both as separate sysprops, +            systemProperty('tests.cluster', "${-> node.transportUri()}"), +++ b/core/src/main/java/org/elasticsearch/action/ActionModule.java, +    static class ActionEntry<Request extends ActionRequest<Request>, Response extends ActionResponse> {, +    public <Request extends ActionRequest<Request>, Response extends ActionResponse> void registerAction(GenericAction<Request, Response> action, Class<? extends TransportAction<Request, Response>> transportAction, Class... supportTransportActions) {, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +     * Returns a NodeInfo object for the first node in the cluster., +    static NodeInfo setup(Project project, Task task, ClusterConfiguration config) {, +        return nodes[0], +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/RestIntegTestTask.groovy, +            NodeInfo node = ClusterFormationTasks.setup(project, this, clusterConfig), +            systemProperty('tests.rest.cluster', "${-> node.httpUri()}"), +            // TODO: our "client" qa tests currently use the rest-test plugin. instead they should have their own plugin, +            // that sets up the test cluster and passes this transport uri instead of http uri. Until then, we pass, +            // both as separate sysprops, +            systemProperty('tests.cluster', "${-> node.transportUri()}"), +++ b/core/src/main/java/org/elasticsearch/action/ActionModule.java, +    static class ActionEntry<Request extends ActionRequest<Request>, Response extends ActionResponse> {, +    public <Request extends ActionRequest<Request>, Response extends ActionResponse> void registerAction(GenericAction<Request, Response> action, Class<? extends TransportAction<Request, Response>> transportAction, Class... supportTransportActions) {, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/settings/SettingsUpdater.java, +import org.elasticsearch.common.regex.Regex;, +import java.util.HashSet;, +import java.util.Map;, +import java.util.Set;, +, +        changed |= apply(transientToApply, transientSettings, transientUpdates, "transient");, +        changed |= apply(persistentToApply, persistentSettings, persistentUpdates, "persistent");, +    private boolean apply(Settings toApply, Settings.Builder target, Settings.Builder updates, String type) {, +        boolean changed = false;, +        final Set<String> toRemove = new HashSet<>();, +        Settings.Builder settingsBuilder = Settings.settingsBuilder();, +        for (Map.Entry<String, String> entry : toApply.getAsMap().entrySet()) {, +            if (entry.getValue() == null) {, +                toRemove.add(entry.getKey());, +            } else if (clusterSettings.isLoggerSetting(entry.getKey()) || clusterSettings.hasDynamicSetting(entry.getKey())) {, +                settingsBuilder.put(entry.getKey(), entry.getValue());, +                updates.put(entry.getKey(), entry.getValue());, +                changed = true;, +            } else {, +                throw new IllegalArgumentException(type + " setting [" + entry.getKey() + "], not dynamically updateable");, +            }, +        changed |= applyDeletes(toRemove, target);, +        target.put(settingsBuilder.build());, +        return changed;, +    }, +, +    private final boolean applyDeletes(Set<String> deletes, Settings.Builder builder) {, +        boolean changed = false;, +        for (String entry : deletes) {, +            Set<String> keysToRemove = new HashSet<>();, +            Set<String> keySet = builder.internalMap().keySet();, +            for (String key : keySet) {, +                if (Regex.simpleMatch(entry, key)) {, +                    keysToRemove.add(key);, +                }, +            }, +            for (String key : keysToRemove) {, +                builder.remove(key);, +                changed = true;, +            }, +        }, +        return changed;, +    }, +}, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterFormationTasks.groovy, +     * Returns a NodeInfo object for the first node in the cluster., +    static NodeInfo setup(Project project, Task task, ClusterConfiguration config) {, +        return nodes[0], +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/RestIntegTestTask.groovy, +            NodeInfo node = ClusterFormationTasks.setup(project, this, clusterConfig), +            systemProperty('tests.rest.cluster', "${-> node.httpUri()}"), +            // TODO: our "client" qa tests currently use the rest-test plugin. instead they should have their own plugin, +            // that sets up the test cluster and passes this transport uri instead of http uri. Until then, we pass, +            // both as separate sysprops, +            systemProperty('tests.cluster', "${-> node.transportUri()}"), +++ b/core/src/main/java/org/elasticsearch/action/ActionModule.java]