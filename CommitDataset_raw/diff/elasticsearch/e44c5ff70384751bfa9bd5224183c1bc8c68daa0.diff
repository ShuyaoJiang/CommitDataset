[+++ b/core/src/main/java/org/elasticsearch/gateway/GatewayMetaState.java, +import org.elasticsearch.cluster.routing.RoutingNode;, +import org.elasticsearch.cluster.routing.ShardRouting;, +, +            relevantIndices = getRelevantIndices(event.state(), event.previousState(), previouslyWrittenIndices);, +    public static Set<String> getRelevantIndices(ClusterState state, ClusterState previousState,ImmutableSet<String> previouslyWrittenIndices) {, +            relevantIndices = getRelevantIndicesOnDataOnlyNode(state, previousState, previouslyWrittenIndices);, +    public static Set<String> getRelevantIndicesOnDataOnlyNode(ClusterState state, ClusterState previousState, ImmutableSet<String> previouslyWrittenIndices) {, +            boolean isOrWasClosed = indexMetaData.state().equals(IndexMetaData.State.CLOSE);, +            // if the index is open we might still have to write the state if it just transitioned from closed to open, +            // so we have to check for that as well., +            IndexMetaData previousMetaData = previousState.metaData().getIndices().get(indexMetaData.getIndex());, +            if (previousMetaData != null) {, +                isOrWasClosed = isOrWasClosed || previousMetaData.state().equals(IndexMetaData.State.CLOSE);, +            }, +            if (previouslyWrittenIndices.contains(indexMetaData.getIndex()) && isOrWasClosed) {, +++ b/core/src/main/java/org/elasticsearch/gateway/GatewayMetaState.java, +import org.elasticsearch.cluster.routing.RoutingNode;, +import org.elasticsearch.cluster.routing.ShardRouting;, +, +            relevantIndices = getRelevantIndices(event.state(), event.previousState(), previouslyWrittenIndices);, +    public static Set<String> getRelevantIndices(ClusterState state, ClusterState previousState,ImmutableSet<String> previouslyWrittenIndices) {, +            relevantIndices = getRelevantIndicesOnDataOnlyNode(state, previousState, previouslyWrittenIndices);, +    public static Set<String> getRelevantIndicesOnDataOnlyNode(ClusterState state, ClusterState previousState, ImmutableSet<String> previouslyWrittenIndices) {, +            boolean isOrWasClosed = indexMetaData.state().equals(IndexMetaData.State.CLOSE);, +            // if the index is open we might still have to write the state if it just transitioned from closed to open, +            // so we have to check for that as well., +            IndexMetaData previousMetaData = previousState.metaData().getIndices().get(indexMetaData.getIndex());, +            if (previousMetaData != null) {, +                isOrWasClosed = isOrWasClosed || previousMetaData.state().equals(IndexMetaData.State.CLOSE);, +            }, +            if (previouslyWrittenIndices.contains(indexMetaData.getIndex()) && isOrWasClosed) {, +++ b/core/src/test/java/org/elasticsearch/gateway/GatewayMetaStateTests.java, +            oldIndicesList = relevantIndices.addAll(GatewayMetaState.getRelevantIndices(event.previousState(), event.previousState(), oldIndicesList)).build();, +        Set<String> newIndicesList = GatewayMetaState.getRelevantIndices(event.state(),event.previousState(), oldIndicesList);, +++ b/core/src/main/java/org/elasticsearch/gateway/GatewayMetaState.java, +import org.elasticsearch.cluster.routing.RoutingNode;, +import org.elasticsearch.cluster.routing.ShardRouting;, +, +            relevantIndices = getRelevantIndices(event.state(), event.previousState(), previouslyWrittenIndices);, +    public static Set<String> getRelevantIndices(ClusterState state, ClusterState previousState,ImmutableSet<String> previouslyWrittenIndices) {, +            relevantIndices = getRelevantIndicesOnDataOnlyNode(state, previousState, previouslyWrittenIndices);, +    public static Set<String> getRelevantIndicesOnDataOnlyNode(ClusterState state, ClusterState previousState, ImmutableSet<String> previouslyWrittenIndices) {, +            boolean isOrWasClosed = indexMetaData.state().equals(IndexMetaData.State.CLOSE);, +            // if the index is open we might still have to write the state if it just transitioned from closed to open, +            // so we have to check for that as well., +            IndexMetaData previousMetaData = previousState.metaData().getIndices().get(indexMetaData.getIndex());, +            if (previousMetaData != null) {, +                isOrWasClosed = isOrWasClosed || previousMetaData.state().equals(IndexMetaData.State.CLOSE);, +            }, +            if (previouslyWrittenIndices.contains(indexMetaData.getIndex()) && isOrWasClosed) {, +++ b/core/src/test/java/org/elasticsearch/gateway/GatewayMetaStateTests.java, +            oldIndicesList = relevantIndices.addAll(GatewayMetaState.getRelevantIndices(event.previousState(), event.previousState(), oldIndicesList)).build();, +        Set<String> newIndicesList = GatewayMetaState.getRelevantIndices(event.state(),event.previousState(), oldIndicesList);, +++ b/core/src/test/java/org/elasticsearch/gateway/MetaDataWriteDataNodesTests.java, +        /* Try the same and see if this also works if node was just restarted., +         * what we write. This is why we explicitly test for it., +        assertAcked(client().admin().indices().prepareOpen(index).get());, +        indicesMetaData = getIndicesMetaDataOnNode(dataNode);]