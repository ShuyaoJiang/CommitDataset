[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/vagrant/VagrantTestPlugin.groovy, +import org.gradle.api.*, +    private static void createCheckVagrantVersionTask(Project project) {, +                if ((version ==~ /Vagrant 1\.(8\.[6-9]|9\.[0-9])+/) == false) {, +                    throw new InvalidUserDataException("Illegal version of vagrant [${version}]. Need [Vagrant 1.8.6+]"), +                }, +            }, +        }, +    }, +, +    private static void createCheckVirtualBoxVersionTask(Project project) {, +        project.tasks.create('virtualboxCheckVersion', Exec) {, +            description 'Check the Virtualbox version', +            group 'Verification', +            commandLine 'vboxmanage', '--version', +            standardOutput = new ByteArrayOutputStream(), +            doLast {, +                String version = standardOutput.toString().trim(), +                try {, +                    String[] versions = version.split('\\.'), +                    int major = Integer.parseInt(versions[0]), +                    int minor = Integer.parseInt(versions[1]), +                    if ((major < 5) || (major == 5 && minor < 1)) {, +                        throw new InvalidUserDataException("Illegal version of virtualbox [${version}]. Need [5.1+]"), +                    }, +                } catch (NumberFormatException | ArrayIndexOutOfBoundsException e) {, +                    throw new InvalidUserDataException("Unable to parse version of virtualbox [${version}]. Required [5.1+]", e), +        createCheckVagrantVersionTask(project), +        createCheckVirtualBoxVersionTask(project), +        assert project.tasks.virtualboxCheckVersion != null, +        Task virtualboxCheckVersion = project.tasks.virtualboxCheckVersion, +, +                dependsOn vagrantCheckVersion, virtualboxCheckVersion, vagrantSetUp]