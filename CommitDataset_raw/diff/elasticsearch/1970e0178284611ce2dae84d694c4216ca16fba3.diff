[+++ b/server/src/main/java/org/elasticsearch/index/IndexSettings.java, +        Setting.byteSizeSetting("index.translog.flush_threshold_size", new ByteSizeValue(512, ByteSizeUnit.MB),, +            /*, +             * An empty translog occupies 43 bytes on disk. If the flush threshold is below this, the flush thread, +             * can get stuck in an infinite loop as the shouldPeriodicallyFlush can still be true after flushing., +             * However, small thresholds are useful for testing so we do not add a large lower bound here., +             */, +            new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +            new ByteSizeValue(Long.MAX_VALUE, ByteSizeUnit.BYTES),, +            Property.Dynamic, Property.IndexScope);, +                    new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +                    Property.Dynamic, Property.IndexScope);, +++ b/server/src/main/java/org/elasticsearch/index/IndexSettings.java, +        Setting.byteSizeSetting("index.translog.flush_threshold_size", new ByteSizeValue(512, ByteSizeUnit.MB),, +            /*, +             * An empty translog occupies 43 bytes on disk. If the flush threshold is below this, the flush thread, +             * can get stuck in an infinite loop as the shouldPeriodicallyFlush can still be true after flushing., +             * However, small thresholds are useful for testing so we do not add a large lower bound here., +             */, +            new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +            new ByteSizeValue(Long.MAX_VALUE, ByteSizeUnit.BYTES),, +            Property.Dynamic, Property.IndexScope);, +                    new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +                    Property.Dynamic, Property.IndexScope);, +++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +        assert translog.uncommittedOperations() > 0 : "translog required to flush periodically but not contain any uncommitted operation; ", +            + "uncommitted translog size [" + uncommittedSizeOfCurrentCommit + "], flush threshold [" + flushThreshold + "]";, +        return uncommittedSizeOfNewCommit < uncommittedSizeOfCurrentCommit;, +++ b/server/src/main/java/org/elasticsearch/index/IndexSettings.java, +        Setting.byteSizeSetting("index.translog.flush_threshold_size", new ByteSizeValue(512, ByteSizeUnit.MB),, +            /*, +             * An empty translog occupies 43 bytes on disk. If the flush threshold is below this, the flush thread, +             * can get stuck in an infinite loop as the shouldPeriodicallyFlush can still be true after flushing., +             * However, small thresholds are useful for testing so we do not add a large lower bound here., +             */, +            new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +            new ByteSizeValue(Long.MAX_VALUE, ByteSizeUnit.BYTES),, +            Property.Dynamic, Property.IndexScope);, +                    new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +                    Property.Dynamic, Property.IndexScope);, +++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +        assert translog.uncommittedOperations() > 0 : "translog required to flush periodically but not contain any uncommitted operation; ", +            + "uncommitted translog size [" + uncommittedSizeOfCurrentCommit + "], flush threshold [" + flushThreshold + "]";, +        return uncommittedSizeOfNewCommit < uncommittedSizeOfCurrentCommit;, +++ b/server/src/main/java/org/elasticsearch/index/translog/Translog.java, +    public static final int DEFAULT_HEADER_SIZE_IN_BYTES = TranslogWriter.getHeaderLength(UUIDs.randomBase64UUID());, +        final TranslogWriter writer = createWriter(fileGeneration, getMinFileGeneration(), globalCheckpointSupplier.getAsLong());, +        assert writer.sizeInBytes() == DEFAULT_HEADER_SIZE_IN_BYTES : "Mismatch translog header size; " +, +            "empty translog size [" + writer.sizeInBytes() + ", header size [" + DEFAULT_HEADER_SIZE_IN_BYTES + "]";, +        return writer;, +++ b/server/src/main/java/org/elasticsearch/index/IndexSettings.java, +        Setting.byteSizeSetting("index.translog.flush_threshold_size", new ByteSizeValue(512, ByteSizeUnit.MB),, +            /*, +             * An empty translog occupies 43 bytes on disk. If the flush threshold is below this, the flush thread, +             * can get stuck in an infinite loop as the shouldPeriodicallyFlush can still be true after flushing., +             * However, small thresholds are useful for testing so we do not add a large lower bound here., +             */, +            new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +            new ByteSizeValue(Long.MAX_VALUE, ByteSizeUnit.BYTES),, +            Property.Dynamic, Property.IndexScope);, +                    new ByteSizeValue(Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1, ByteSizeUnit.BYTES),, +                    Property.Dynamic, Property.IndexScope);, +++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +        assert translog.uncommittedOperations() > 0 : "translog required to flush periodically but not contain any uncommitted operation; ", +            + "uncommitted translog size [" + uncommittedSizeOfCurrentCommit + "], flush threshold [" + flushThreshold + "]";, +        return uncommittedSizeOfNewCommit < uncommittedSizeOfCurrentCommit;, +++ b/server/src/main/java/org/elasticsearch/index/translog/Translog.java, +    public static final int DEFAULT_HEADER_SIZE_IN_BYTES = TranslogWriter.getHeaderLength(UUIDs.randomBase64UUID());, +        final TranslogWriter writer = createWriter(fileGeneration, getMinFileGeneration(), globalCheckpointSupplier.getAsLong());, +        assert writer.sizeInBytes() == DEFAULT_HEADER_SIZE_IN_BYTES : "Mismatch translog header size; " +, +            "empty translog size [" + writer.sizeInBytes() + ", header size [" + DEFAULT_HEADER_SIZE_IN_BYTES + "]";, +        return writer;, +++ b/server/src/test/java/org/elasticsearch/index/shard/IndexShardIT.java, +        long size = Math.max(translog.uncommittedSizeInBytes(), Translog.DEFAULT_HEADER_SIZE_IN_BYTES + 1);]