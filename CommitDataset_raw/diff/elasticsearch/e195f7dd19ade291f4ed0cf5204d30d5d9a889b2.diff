[+++ b/core/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +import org.elasticsearch.index.engine.Engine.Operation;, +     * Handle failures executing write operations, distinguish persistent engine (environment) failures, +     * from document (request) specific failures., +     * Write failures that fail the engine as a side-effect, are thrown wrapped in {@link OperationFailedEngineException}, +     * and document specific failures are captured through {@link Operation#setFailure(Exception)} to be handled, +     * at the transport level., +    private void handleOperationFailure(final Operation operation, final Exception failure) {, +        boolean isEnvironmentFailure;, +            // When indexing a document into Lucene, Lucene distinguishes between environment related errors, +            // (like out of disk space) and document specific errors (like analysis chain problems) by setting, +            // the IndexWriter.getTragicEvent() value for the former. maybeFailEngine checks for these kind of, +            // errors and returns true if that is the case. We use that to indicate a document level failure, +            // and set the error in operation.setFailure. In case of environment related errors, the failure, +            // is bubbled up, +            isEnvironmentFailure = (failure instanceof IllegalStateException || failure instanceof IOException), +                    && maybeFailEngine(operation.operationType().getLowercase(), failure);, +            // we failed checking whether the failure can fail the engine, treat it as a persistent engine failure, +            isEnvironmentFailure = true;, +            failure.addSuppressed(inner);, +        }, +        if (isEnvironmentFailure) {, +            throw new OperationFailedEngineException(shardId, operation.operationType().getLowercase(),, +                    operation.type(), operation.id(), failure);, +        } else {, +            operation.setFailure(failure);, +    private long updateVersion(Operation op, long currentVersion, long expectedVersion) {]