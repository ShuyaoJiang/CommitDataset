[+++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +import java.util.function.LongSupplier;, +    public QueryShardContext newQueryShardContext(IndexReader indexReader, LongSupplier nowInMillis) {, +                nodeServicesProvider.getClusterService().state(),, +            nowInMillis);, +        return newQueryShardContext(null, threadPool::estimatedTimeInMillis);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +import java.util.function.LongSupplier;, +    public QueryShardContext newQueryShardContext(IndexReader indexReader, LongSupplier nowInMillis) {, +                nodeServicesProvider.getClusterService().state(),, +            nowInMillis);, +        return newQueryShardContext(null, threadPool::estimatedTimeInMillis);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +import java.util.function.LongSupplier;, +    public QueryShardContext newQueryShardContext(IndexReader indexReader, LongSupplier nowInMillis) {, +                nodeServicesProvider.getClusterService().state(),, +            nowInMillis);, +        return newQueryShardContext(null, threadPool::estimatedTimeInMillis);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +import java.util.function.LongSupplier;, +    public QueryShardContext newQueryShardContext(IndexReader indexReader, LongSupplier nowInMillis) {, +                nodeServicesProvider.getClusterService().state(),, +            nowInMillis);, +        return newQueryShardContext(null, threadPool::estimatedTimeInMillis);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.getQueryShardContext().nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +import java.util.function.LongSupplier;, +    public QueryShardContext newQueryShardContext(IndexReader indexReader, LongSupplier nowInMillis) {, +                nodeServicesProvider.getClusterService().state(),, +            nowInMillis);, +        return newQueryShardContext(null, threadPool::estimatedTimeInMillis);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.getQueryShardContext().nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                SearchScript searchScript = innerHitsContext.getQueryShardContext().getSearchScript(field.script(),, +++ b/core/src/main/java/org/elasticsearch/action/bulk/BulkShardRequest.java, +    BulkItemRequest[] items() {, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +import java.util.function.LongSupplier;, +    public QueryShardContext newQueryShardContext(IndexReader indexReader, LongSupplier nowInMillis) {, +                nodeServicesProvider.getClusterService().state(),, +            nowInMillis);, +        return newQueryShardContext(null, threadPool::estimatedTimeInMillis);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.getQueryShardContext().nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.getQueryShardContext().nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                SearchScript searchScript = innerHitsContext.getQueryShardContext().getSearchScript(field.script(),, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +import org.apache.lucene.util.SetOnce;, +import org.elasticsearch.common.bytes.BytesReference;, +import org.elasticsearch.script.ExecutableScript;, +import org.elasticsearch.script.Script;, +import org.elasticsearch.script.ScriptContext;, +import java.util.Collections;, +, +    protected boolean cachable;, +    private final SetOnce<Boolean> executionMode = new SetOnce<>();, +, +    protected final void markAsNotCachable() {, +        this.cachable = false;, +    }, +, +    public boolean isCachable() {, +        return cachable;, +    }, +, +    public void setCachabe(boolean cachabe) { this.cachable = cachabe; }, +, +    public BytesReference getTemplateBytes(Script template) {]