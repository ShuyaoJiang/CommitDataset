[+++ b/dev-tools/github_relabel.pl, +#!/usr/bin/env perl, +, +use strict;, +use warnings;, +, +use HTTP::Tiny;, +use IO::Socket::SSL 1.52;, +use utf8;, +use Getopt::Long;, +, +my $Base_URL  = "https://api.github.com/repos/";, +my $User_Repo = 'elastic/elasticsearch/';, +my $Issue_URL = "https://github.com/${User_Repo}issues";, +use JSON();, +use URI();, +use URI::Escape qw(uri_escape_utf8);, +, +our $json = JSON->new->utf8(1);, +our $http = HTTP::Tiny->new(, +    default_headers => {, +        Accept        => "application/vnd.github.v3+json",, +        Authorization => load_github_key(), +    }, +);, +, +my %Opts = ( state => 'open' );, +, +GetOptions(, +    \%Opts,    #, +    'state=s', 'labels=s', 'add=s', 'remove=s', +) || exit usage();, +, +die usage('--state must be one of open|all|closed'), +    unless $Opts{state} =~ /^(open|all|closed)$/;, +, +die usage('--labels is required') unless $Opts{labels};, +die usage('Either --add or --remove is required'), +    unless $Opts{add} || $Opts{remove};, +, +relabel();, +, +#===================================, +sub relabel {, +#===================================, +    my @remove = split /,/, ( $Opts{remove} || '' );, +    my @add    = split /,/, ( $Opts{add}    || '' );, +    my $add_json = $json->encode( \@add );, +    my $url      = URI->new( $Base_URL . $User_Repo . 'issues' );, +    $url->query_form(, +        state    => $Opts{state},, +        labels   => $Opts{labels},, +        per_page => 100, +    );, +, +    my $spool = Spool->new($url);, +    while ( my $issue = $spool->next ) {, +        my $id = $issue->{number};, +        print "$Issue_URL/$id\n";, +        if (@add) {, +            add_label( $id, $add_json );, +        }, +        for (@remove) {, +            remove_label( $id, $_ );, +        }, +    }, +    print "Done\n";, +}, +, +#===================================, +sub add_label {, +#===================================, +    my ( $id, $json ) = @_;, +    my $response = $http->post(, +        $Base_URL . $User_Repo . "issues/$id/labels",, +        {   content => $json,, +            headers => { "Content-Type" => "application/json; charset=utf-8" }, +        }, +    );, +, +    die "$response->{status} $response->{reason}\n", +        unless $response->{success};, +, +}, +, +#===================================, +sub remove_label {, +#===================================, +    my ( $id, $name ) = @_;, +    my $url, +        = $Base_URL, +        . $User_Repo, +        . "issues/$id/labels/", +        . uri_escape_utf8($name);, +    my $response = $http->delete($url);, +, +    die "$response->{status} $response->{reason}\n", +        unless $response->{success};, +, +}]