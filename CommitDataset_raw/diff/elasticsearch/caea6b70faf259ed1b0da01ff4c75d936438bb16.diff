[+++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                org.elasticsearch.common.xcontent.NamedXContentRegistry.UnknownNamedObjectException::new, 148, Version.V_5_2_0),, +        TOO_MANY_BUCKETS_EXCEPTION(MultiBucketConsumerService.TooManyBucketsException.class,, +                                   MultiBucketConsumerService.TooManyBucketsException::new, 149,, +            Version.V_7_0_0_alpha1);, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                org.elasticsearch.common.xcontent.NamedXContentRegistry.UnknownNamedObjectException::new, 148, Version.V_5_2_0),, +        TOO_MANY_BUCKETS_EXCEPTION(MultiBucketConsumerService.TooManyBucketsException.class,, +                                   MultiBucketConsumerService.TooManyBucketsException::new, 149,, +            Version.V_7_0_0_alpha1);, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +import java.util.function.Function;, +    private final Function<Boolean, ReduceContext> reduceContextFunction;, +    /**, +     * Constructor., +     * @param settings Node settings, +     * @param reduceContextFunction A function that builds a context for the reduce of an {@link InternalAggregation}, +     */, +    public SearchPhaseController(Settings settings, Function<Boolean, ReduceContext> reduceContextFunction) {, +        this.reduceContextFunction = reduceContextFunction;, +        ReduceContext reduceContext = reduceContextFunction.apply(true);, +        ReduceContext reduceContext = reduceContextFunction.apply(false);, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                org.elasticsearch.common.xcontent.NamedXContentRegistry.UnknownNamedObjectException::new, 148, Version.V_5_2_0),, +        TOO_MANY_BUCKETS_EXCEPTION(MultiBucketConsumerService.TooManyBucketsException.class,, +                                   MultiBucketConsumerService.TooManyBucketsException::new, 149,, +            Version.V_7_0_0_alpha1);, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +import java.util.function.Function;, +    private final Function<Boolean, ReduceContext> reduceContextFunction;, +    /**, +     * Constructor., +     * @param settings Node settings, +     * @param reduceContextFunction A function that builds a context for the reduce of an {@link InternalAggregation}, +     */, +    public SearchPhaseController(Settings settings, Function<Boolean, ReduceContext> reduceContextFunction) {, +        this.reduceContextFunction = reduceContextFunction;, +        ReduceContext reduceContext = reduceContextFunction.apply(true);, +        ReduceContext reduceContext = reduceContextFunction.apply(false);, +++ b/core/src/main/java/org/elasticsearch/common/settings/ClusterSettings.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                    MultiBucketConsumerService.MAX_BUCKET_SETTING,, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                org.elasticsearch.common.xcontent.NamedXContentRegistry.UnknownNamedObjectException::new, 148, Version.V_5_2_0),, +        TOO_MANY_BUCKETS_EXCEPTION(MultiBucketConsumerService.TooManyBucketsException.class,, +                                   MultiBucketConsumerService.TooManyBucketsException::new, 149,, +            Version.V_7_0_0_alpha1);, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +import java.util.function.Function;, +    private final Function<Boolean, ReduceContext> reduceContextFunction;, +    /**, +     * Constructor., +     * @param settings Node settings, +     * @param reduceContextFunction A function that builds a context for the reduce of an {@link InternalAggregation}, +     */, +    public SearchPhaseController(Settings settings, Function<Boolean, ReduceContext> reduceContextFunction) {, +        this.reduceContextFunction = reduceContextFunction;, +        ReduceContext reduceContext = reduceContextFunction.apply(true);, +        ReduceContext reduceContext = reduceContextFunction.apply(false);, +++ b/core/src/main/java/org/elasticsearch/common/settings/ClusterSettings.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                    MultiBucketConsumerService.MAX_BUCKET_SETTING,, +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +, +            final SearchService searchService = newSearchService(clusterService, indicesService,, +                threadPool, scriptModule.getScriptService(), bigArrays, searchModule.getFetchPhase(),, +                responseCollectorService);, +, +                    b.bind(SearchService.class).toInstance(searchService);, +                    b.bind(SearchPhaseController.class).toInstance(new SearchPhaseController(settings,, +                        searchService::createReduceContext));, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                org.elasticsearch.common.xcontent.NamedXContentRegistry.UnknownNamedObjectException::new, 148, Version.V_5_2_0),, +        TOO_MANY_BUCKETS_EXCEPTION(MultiBucketConsumerService.TooManyBucketsException.class,, +                                   MultiBucketConsumerService.TooManyBucketsException::new, 149,, +            Version.V_7_0_0_alpha1);, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +import java.util.function.Function;, +    private final Function<Boolean, ReduceContext> reduceContextFunction;, +    /**, +     * Constructor., +     * @param settings Node settings, +     * @param reduceContextFunction A function that builds a context for the reduce of an {@link InternalAggregation}, +     */, +    public SearchPhaseController(Settings settings, Function<Boolean, ReduceContext> reduceContextFunction) {, +        this.reduceContextFunction = reduceContextFunction;, +        ReduceContext reduceContext = reduceContextFunction.apply(true);, +        ReduceContext reduceContext = reduceContextFunction.apply(false);, +++ b/core/src/main/java/org/elasticsearch/common/settings/ClusterSettings.java, +import org.elasticsearch.search.aggregations.MultiBucketConsumerService;, +                    MultiBucketConsumerService.MAX_BUCKET_SETTING,, +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +, +            final SearchService searchService = newSearchService(clusterService, indicesService,, +                threadPool, scriptModule.getScriptService(), bigArrays, searchModule.getFetchPhase(),]