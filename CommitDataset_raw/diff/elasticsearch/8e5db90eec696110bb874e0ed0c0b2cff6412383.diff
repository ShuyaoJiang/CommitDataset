[+++ b/server/src/test/java/org/elasticsearch/index/store/CorruptedFileIT.java, +import org.apache.lucene.index.SegmentCommitInfo;, +import org.apache.lucene.index.SegmentInfos;, +import org.apache.lucene.store.Directory;, +import org.apache.lucene.store.FSDirectory;, +                try (Directory dir = FSDirectory.open(file)) {, +                    SegmentInfos segmentCommitInfos = Lucene.readSegmentInfos(dir);, +                    if (includePerCommitFiles) {, +                        files.add(file.resolve(segmentCommitInfos.getSegmentsFileName()));, +                    }, +                    for (SegmentCommitInfo commitInfo : segmentCommitInfos) {, +                        if (commitInfo.getDelCount() + commitInfo.getSoftDelCount() == commitInfo.info.maxDoc()) {, +                            // don't corrupt fully deleted segments - they might be removed on snapshot, +                            continue;, +                        }, +                        for (String commitFile : commitInfo.files()) {, +                            if (includePerCommitFiles || isPerSegmentFile(commitFile)) {, +                                files.add(file.resolve(commitFile));, +]