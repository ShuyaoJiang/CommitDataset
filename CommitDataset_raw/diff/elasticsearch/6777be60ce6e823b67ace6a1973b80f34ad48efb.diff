[+++ b/docs/reference/search/aggregations/metrics/valuecount-aggregation.asciidoc, +These values can be extracted either from specific fields in the documents, or be generated by a provided script. Typically,, +==== Script, +, +Counting the values generated by a script:, +, +[source,js], +--------------------------------------------------, +{, +    ...,, +, +    "aggs" : {, +        "grades_count" : { "value_count" : { "script" : "doc['grade'].value" } }, +    }, +}, +--------------------------------------------------, +++ b/docs/reference/search/aggregations/metrics/valuecount-aggregation.asciidoc, +These values can be extracted either from specific fields in the documents, or be generated by a provided script. Typically,, +==== Script, +, +Counting the values generated by a script:, +, +[source,js], +--------------------------------------------------, +{, +    ...,, +, +    "aggs" : {, +        "grades_count" : { "value_count" : { "script" : "doc['grade'].value" } }, +    }, +}, +--------------------------------------------------, +++ b/src/main/java/org/elasticsearch/search/aggregations/metrics/valuecount/ValueCountBuilder.java, +import org.elasticsearch.search.aggregations.metrics.ValuesSourceMetricsAggregationBuilder;, +public class ValueCountBuilder extends ValuesSourceMetricsAggregationBuilder<ValueCountBuilder> {, +++ b/docs/reference/search/aggregations/metrics/valuecount-aggregation.asciidoc, +These values can be extracted either from specific fields in the documents, or be generated by a provided script. Typically,, +==== Script, +, +Counting the values generated by a script:, +, +[source,js], +--------------------------------------------------, +{, +    ...,, +, +    "aggs" : {, +        "grades_count" : { "value_count" : { "script" : "doc['grade'].value" } }, +    }, +}, +--------------------------------------------------, +++ b/src/main/java/org/elasticsearch/search/aggregations/metrics/valuecount/ValueCountBuilder.java, +import org.elasticsearch.search.aggregations.metrics.ValuesSourceMetricsAggregationBuilder;, +public class ValueCountBuilder extends ValuesSourceMetricsAggregationBuilder<ValueCountBuilder> {, +++ b/src/main/java/org/elasticsearch/search/aggregations/metrics/valuecount/ValueCountParser.java, +import java.util.Map;, +        String script = null;, +        String scriptLang = null;, +        Map<String, Object> scriptParams = null;, +        boolean assumeUnique = false;, +                } else if ("script".equals(currentFieldName)) {, +                    script = parser.text();, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +            } else if (token == XContentParser.Token.VALUE_BOOLEAN) {, +                if ("script_values_unique".equals(currentFieldName)) {, +                    assumeUnique = parser.booleanValue();, +                } else {, +                    throw new SearchParseException(context, "Unknown key for a " + token + " in [" + aggregationName + "]: [" + currentFieldName + "].");, +                }, +            } else if (token == XContentParser.Token.START_OBJECT) {, +                if ("params".equals(currentFieldName)) {, +                    scriptParams = parser.map();, +                }, +        if (script != null) {, +            config.script(context.scriptService().search(context.lookup(), scriptLang, script, scriptParams));, +        }, +, +        if (!assumeUnique) {, +            config.ensureUnique(true);, +        }, +, +++ b/docs/reference/search/aggregations/metrics/valuecount-aggregation.asciidoc, +These values can be extracted either from specific fields in the documents, or be generated by a provided script. Typically,, +==== Script, +, +Counting the values generated by a script:, +, +[source,js], +--------------------------------------------------, +{, +    ...,, +, +    "aggs" : {, +        "grades_count" : { "value_count" : { "script" : "doc['grade'].value" } }, +    }, +}, +--------------------------------------------------, +++ b/src/main/java/org/elasticsearch/search/aggregations/metrics/valuecount/ValueCountBuilder.java, +import org.elasticsearch.search.aggregations.metrics.ValuesSourceMetricsAggregationBuilder;]