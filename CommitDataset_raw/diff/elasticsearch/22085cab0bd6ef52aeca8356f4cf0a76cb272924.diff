[+++ b/src/test/java/org/elasticsearch/test/unit/transport/AbstractSimpleTransportTests.java, +    public void setUp() throws Exception {, +        // wait till all nodes are properly connected and the event has been sent, so tests in this class, +        // will not get this callback called on the connections done in this setup, +        final CountDownLatch latch = new CountDownLatch(4);, +        TransportConnectionListener waitForConnection = new TransportConnectionListener() {, +            @Override, +            public void onNodeConnected(DiscoveryNode node) {, +                latch.countDown();, +            }, +, +            @Override, +            public void onNodeDisconnected(DiscoveryNode node) {, +                assert false : "disconnect should not be called " + node;, +            }, +        };, +        serviceA.addConnectionListener(waitForConnection);, +        serviceB.addConnectionListener(waitForConnection);, +, +, +        assertThat("failed to wait for all nodes to connect", latch.await(5, TimeUnit.SECONDS), equalTo(true));, +        serviceA.removeConnectionListener(waitForConnection);, +        serviceB.removeConnectionListener(waitForConnection);]