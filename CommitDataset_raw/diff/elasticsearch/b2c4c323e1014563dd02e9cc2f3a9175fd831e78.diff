[+++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequest.java, +    public CreateIndexRequest getShrinkIndexRequest() {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequest.java, +    public CreateIndexRequest getShrinkIndexRequest() {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequestBuilder.java, +        this.request.getShrinkIndexRequest().settings(settings);, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequest.java, +    public CreateIndexRequest getShrinkIndexRequest() {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequestBuilder.java, +        this.request.getShrinkIndexRequest().settings(settings);, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportShrinkAction.java, +import org.elasticsearch.action.admin.indices.stats.IndexShardStats;, +import org.elasticsearch.index.shard.ShardId;, +import java.util.function.IntFunction;, +        return state.blocks().indexBlockedException(ClusterBlockLevel.METADATA_WRITE, request.getShrinkIndexRequest().index());, +                    (i) -> {, +                        IndexShardStats shard = indicesStatsResponse.getIndex(sourceIndex).getIndexShards().get(i);, +                        return shard == null ? null : shard.getPrimary().getDocs();, +                    }, indexNameExpressionResolver);, +        , final IntFunction<DocsStats> perShardDocStats, IndexNameExpressionResolver indexNameExpressionResolver) {, +        final CreateIndexRequest targetIndex = shrinkReqeust.getShrinkIndexRequest();, +        int numShards = 1;, +        if (IndexMetaData.INDEX_NUMBER_OF_SHARDS_SETTING.exists(targetIndexSettings)) {, +            numShards = IndexMetaData.INDEX_NUMBER_OF_SHARDS_SETTING.get(targetIndexSettings);, +        }, +        for (int i = 0; i < numShards; i++) {, +            Set<ShardId> shardIds = IndexMetaData.selectShrinkShards(i, metaData, numShards);, +            long count = 0;, +            for (ShardId id : shardIds) {, +                DocsStats docsStats = perShardDocStats.apply(id.id());, +                if (docsStats != null) {, +                    count += docsStats.getCount();, +                }, +                if (count > IndexWriter.MAX_DOCS) {, +                        + "] docs - too many documents in shards " + shardIds);, +                }, +            }, +, +        Settings.Builder settingsBuilder = Settings.builder().put(targetIndexSettings);, +        settingsBuilder.put("index.number_of_shards", numShards);, +        targetIndex.settings(settingsBuilder);, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequest.java, +    public CreateIndexRequest getShrinkIndexRequest() {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/ShrinkRequestBuilder.java, +        this.request.getShrinkIndexRequest().settings(settings);, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportShrinkAction.java, +import org.elasticsearch.action.admin.indices.stats.IndexShardStats;, +import org.elasticsearch.index.shard.ShardId;, +import java.util.function.IntFunction;, +        return state.blocks().indexBlockedException(ClusterBlockLevel.METADATA_WRITE, request.getShrinkIndexRequest().index());, +                    (i) -> {, +                        IndexShardStats shard = indicesStatsResponse.getIndex(sourceIndex).getIndexShards().get(i);, +                        return shard == null ? null : shard.getPrimary().getDocs();, +                    }, indexNameExpressionResolver);, +        , final IntFunction<DocsStats> perShardDocStats, IndexNameExpressionResolver indexNameExpressionResolver) {, +        final CreateIndexRequest targetIndex = shrinkReqeust.getShrinkIndexRequest();, +        int numShards = 1;, +        if (IndexMetaData.INDEX_NUMBER_OF_SHARDS_SETTING.exists(targetIndexSettings)) {, +            numShards = IndexMetaData.INDEX_NUMBER_OF_SHARDS_SETTING.get(targetIndexSettings);, +        }, +        for (int i = 0; i < numShards; i++) {, +            Set<ShardId> shardIds = IndexMetaData.selectShrinkShards(i, metaData, numShards);, +            long count = 0;, +            for (ShardId id : shardIds) {, +                DocsStats docsStats = perShardDocStats.apply(id.id());, +                if (docsStats != null) {, +                    count += docsStats.getCount();, +                }, +                if (count > IndexWriter.MAX_DOCS) {, +                        + "] docs - too many documents in shards " + shardIds);, +                }, +            }, +, +        Settings.Builder settingsBuilder = Settings.builder().put(targetIndexSettings);, +        settingsBuilder.put("index.number_of_shards", numShards);, +        targetIndex.settings(settingsBuilder);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/IndexMetaData.java, +import org.elasticsearch.index.shard.ShardId;, +    static final String KEY_ROUTING_NUM_SHARDS = "routing_num_shards";, +    private final int routingNumShards;, +    private final int routingFactor;, +                          Version indexCreatedVersion, Version indexUpgradedVersion, org.apache.lucene.util.Version minimumCompatibleLuceneVersion,, +                          int routingNumShards) {, +        this.routingNumShards = routingNumShards;, +        this.routingFactor = routingNumShards / numberOfShards;, +        assert numberOfShards * routingFactor == routingNumShards :  routingNumShards + " must be a multiple of " + numberOfShards;, +        if (routingNumShards != that.routingNumShards) {, +            return false;, +        }, +        if (routingFactor != that.routingFactor) {, +            return false;, +        }, +        result = 31 * result + Long.hashCode(routingFactor);, +        result = 31 * result + Long.hashCode(routingNumShards);, +        private final int routingNumShards;, +            routingNumShards = after.routingNumShards;, +            routingNumShards = in.readInt();, +            out.writeInt(routingNumShards);, +            builder.setRoutingNumShards(routingNumShards);, +        builder.setRoutingNumShards(in.readInt());]