[+++ b/server/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java, +        return field(name).values(values, true);, +    private XContentBuilder values(Object[] values, boolean ensureNoSelfReferences) throws IOException {, +        return value(Arrays.asList(values), ensureNoSelfReferences);, +        unknownValue(value, true);, +    private void unknownValue(Object value, boolean ensureNoSelfReferences) throws IOException {, +            map((Map<String,?>) value, ensureNoSelfReferences);, +            value((Iterable<?>) value, ensureNoSelfReferences);, +            values((Object[]) value, ensureNoSelfReferences);, +        return map(values, true);, +    }, +, +    private XContentBuilder map(Map<String, ?> values, boolean ensureNoSelfReferences) throws IOException {, +        if (ensureNoSelfReferences) {, +        }, +            // pass ensureNoSelfReferences=false as we already performed the check at a higher level, +            unknownValue(value.getValue(), false);, +    private XContentBuilder value(Iterable<?> values, boolean ensureNoSelfReferences) throws IOException {, +            if (ensureNoSelfReferences) {, +            }, +                // pass ensureNoSelfReferences=false as we already performed the check at a higher level, +                unknownValue(value, false);, +                it = ((Map<?,?>) value).values();, +                it = (Iterable<?>) value;, +++ b/server/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java, +        return field(name).values(values, true);, +    private XContentBuilder values(Object[] values, boolean ensureNoSelfReferences) throws IOException {, +        return value(Arrays.asList(values), ensureNoSelfReferences);, +        unknownValue(value, true);, +    private void unknownValue(Object value, boolean ensureNoSelfReferences) throws IOException {, +            map((Map<String,?>) value, ensureNoSelfReferences);, +            value((Iterable<?>) value, ensureNoSelfReferences);, +            values((Object[]) value, ensureNoSelfReferences);, +        return map(values, true);, +    }, +, +    private XContentBuilder map(Map<String, ?> values, boolean ensureNoSelfReferences) throws IOException {, +        if (ensureNoSelfReferences) {, +        }, +            // pass ensureNoSelfReferences=false as we already performed the check at a higher level, +            unknownValue(value.getValue(), false);, +    private XContentBuilder value(Iterable<?> values, boolean ensureNoSelfReferences) throws IOException {, +            if (ensureNoSelfReferences) {, +            }, +                // pass ensureNoSelfReferences=false as we already performed the check at a higher level, +                unknownValue(value, false);, +                it = ((Map<?,?>) value).values();, +                it = (Iterable<?>) value;, +++ b/server/src/test/java/org/elasticsearch/common/xcontent/BaseXContentTestCase.java]