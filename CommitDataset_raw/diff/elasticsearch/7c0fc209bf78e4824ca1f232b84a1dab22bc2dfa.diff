[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +    Map<String, Object> environmentVariables = new HashMap<>(), +, +    void environment(String variable, Object value) {, +        environmentVariables.put(variable, value), +    }, +, +    @Input, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +    Map<String, Object> environmentVariables = new HashMap<>(), +, +    void environment(String variable, Object value) {, +        environmentVariables.put(variable, value), +    }, +, +    @Input, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/NodeInfo.groovy, +        env.putAll(config.environmentVariables), +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +    Map<String, Object> environmentVariables = new HashMap<>(), +, +    void environment(String variable, Object value) {, +        environmentVariables.put(variable, value), +    }, +, +    @Input, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/NodeInfo.groovy, +        env.putAll(config.environmentVariables), +++ b/docs/plugins/repository-s3.asciidoc, +The repository defaults to using https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html[ECS IAM Role] or, +http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html[EC2 IAM Role], +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +    Map<String, Object> environmentVariables = new HashMap<>(), +, +    void environment(String variable, Object value) {, +        environmentVariables.put(variable, value), +    }, +, +    @Input, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/NodeInfo.groovy, +        env.putAll(config.environmentVariables), +++ b/docs/plugins/repository-s3.asciidoc, +The repository defaults to using https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html[ECS IAM Role] or, +http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html[EC2 IAM Role], +++ b/plugins/repository-s3/build.gradle, +String s3ECSBucket = System.getenv("amazon_s3_bucket_ecs"), +String s3ECSBasePath = System.getenv("amazon_s3_base_path_ecs"), +, +        && !s3EC2Bucket && !s3EC2BasePath, +        && !s3ECSBucket && !s3ECSBasePath) {, +  s3ECSBucket = 'ecs-bucket-test', +  s3ECSBasePath = 'integration_test', +, +        || !s3EC2Bucket || !s3EC2BasePath, +        || !s3ECSBucket || !s3ECSBasePath) {, +          'repository_s3/40_repository_ec2_credentials/*',, +          'repository_s3/50_repository_ecs_credentials/*', +      "s3Fixture.ec2_bucket_name"        : s3EC2Bucket,, +      "s3Fixture.ecs_bucket_name"        : s3ECSBucket, +  'ec2_base_path': s3EC2BasePath,, +  'ecs_bucket': s3ECSBucket,, +  'ecs_base_path': s3ECSBasePath, +integTestRunner.systemProperty 'tests.rest.blacklist', 'repository_s3/50_repository_ecs_credentials/*', +, +///, +RestIntegTestTask integTestECS = project.tasks.create('integTestECS', RestIntegTestTask.class) {, +  description = "Runs tests using the ECS repository.", +}, +, +// The following closure must execute before the afterEvaluate block in the constructor of the following integrationTest tasks:, +project.afterEvaluate {, +  ClusterConfiguration cluster = project.extensions.getByName('integTestECSCluster') as ClusterConfiguration, +  cluster.dependsOn(project.s3Fixture), +, +  cluster.setting 's3.client.integration_test_ecs.endpoint', "http://${-> s3Fixture.addressAndPort}", +, +  Task integTestECSTask = project.tasks.getByName('integTestECS'), +  integTestECSTask.clusterConfig.plugin(project.path), +  integTestECSTask.clusterConfig.environment 'AWS_CONTAINER_CREDENTIALS_FULL_URI',, +          "http://${-> s3Fixture.addressAndPort}/ecs_credentials_endpoint", +  integTestECSRunner.systemProperty 'tests.rest.blacklist', [, +          'repository_s3/10_basic/*',, +          'repository_s3/20_repository_permanent_credentials/*',, +          'repository_s3/30_repository_temporary_credentials/*',, +          'repository_s3/40_repository_ec2_credentials/*', +  ].join(","), +}, +project.check.dependsOn(integTestECS), +///, +, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/ClusterConfiguration.groovy, +    Map<String, Object> environmentVariables = new HashMap<>(), +, +    void environment(String variable, Object value) {, +        environmentVariables.put(variable, value), +    }, +, +    @Input, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/test/NodeInfo.groovy, +        env.putAll(config.environmentVariables)]