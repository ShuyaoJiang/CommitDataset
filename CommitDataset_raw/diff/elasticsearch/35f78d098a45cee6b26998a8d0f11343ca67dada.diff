[+++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/health/TransportClusterHealthAction.java, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/health/TransportClusterHealthAction.java, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/tasks/TransportPendingClusterTasksAction.java, +        final List<PendingClusterTask> pendingTasks = clusterService.getMasterService().pendingTasks();, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/health/TransportClusterHealthAction.java, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/tasks/TransportPendingClusterTasksAction.java, +        final List<PendingClusterTask> pendingTasks = clusterService.getMasterService().pendingTasks();, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/health/TransportClusterHealthAction.java, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/tasks/TransportPendingClusterTasksAction.java, +        final List<PendingClusterTask> pendingTasks = clusterService.getMasterService().pendingTasks();, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterStateObserver.java, +import org.elasticsearch.cluster.service.ClusterApplierService;, +    private final ClusterApplierService clusterApplierService;, +        this(initialState, clusterService.getClusterApplierService(), timeout, logger, contextHolder);, +    }, +, +    public ClusterStateObserver(ClusterState initialState, ClusterApplierService clusterApplierService, @Nullable TimeValue timeout,, +                                Logger logger, ThreadContext contextHolder) {, +        this.clusterApplierService = clusterApplierService;, +        ClusterState clusterState = clusterApplierService.state();, +                    lastObservedState.set(new StoredState(clusterApplierService.state()));, +        ClusterState newState = clusterApplierService.state();, +            clusterApplierService.addTimeoutListener(timeoutTimeLeftMS == null ? null : new TimeValue(timeoutTimeLeftMS), clusterStateListener);, +                    clusterApplierService.removeTimeoutListener(this);, +            ClusterState newState = clusterApplierService.state();, +                    clusterApplierService.removeTimeoutListener(this);, +                clusterApplierService.removeTimeoutListener(this);, +                clusterApplierService.removeTimeoutListener(this);, +                lastObservedState.set(new StoredState(clusterApplierService.state()));, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/health/TransportClusterHealthAction.java, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/tasks/TransportPendingClusterTasksAction.java, +        final List<PendingClusterTask> pendingTasks = clusterService.getMasterService().pendingTasks();, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterStateObserver.java, +import org.elasticsearch.cluster.service.ClusterApplierService;, +    private final ClusterApplierService clusterApplierService;, +        this(initialState, clusterService.getClusterApplierService(), timeout, logger, contextHolder);, +    }, +, +    public ClusterStateObserver(ClusterState initialState, ClusterApplierService clusterApplierService, @Nullable TimeValue timeout,, +                                Logger logger, ThreadContext contextHolder) {, +        this.clusterApplierService = clusterApplierService;, +        ClusterState clusterState = clusterApplierService.state();, +                    lastObservedState.set(new StoredState(clusterApplierService.state()));, +        ClusterState newState = clusterApplierService.state();, +            clusterApplierService.addTimeoutListener(timeoutTimeLeftMS == null ? null : new TimeValue(timeoutTimeLeftMS), clusterStateListener);, +                    clusterApplierService.removeTimeoutListener(this);, +            ClusterState newState = clusterApplierService.state();, +                    clusterApplierService.removeTimeoutListener(this);, +                clusterApplierService.removeTimeoutListener(this);, +                clusterApplierService.removeTimeoutListener(this);, +                lastObservedState.set(new StoredState(clusterApplierService.state()));, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterStateTaskExecutor.java, +        ClusterTasksResult(ClusterState resultingState, Map<T, TaskResult> executionResults) {, +                return new ClusterTasksResult<>(resultingState, executionResults);, +                return new ClusterTasksResult<>(result.resultingState == null ? previousState : result.resultingState,, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +  <suppress files="core[/\\]src[/\\]main[/\\]java[/\\]org[/\\]elasticsearch[/\\]discovery[/\\]TribeDiscovery.java" checks="LineLength" />, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/health/TransportClusterHealthAction.java, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +        ClusterHealthResponse response = clusterHealth(request, clusterState, clusterService.getMasterService().numberOfPendingTasks(),, +                gatewayAllocator.getNumberOfInFlightFetch(), clusterService.getMasterService().getMaxTaskWaitTime());, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/tasks/TransportPendingClusterTasksAction.java, +        final List<PendingClusterTask> pendingTasks = clusterService.getMasterService().pendingTasks();, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterState.java]