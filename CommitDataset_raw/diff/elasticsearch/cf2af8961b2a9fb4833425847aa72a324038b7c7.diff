[+++ b/core/src/main/java/org/elasticsearch/common/Strings.java, +++ b/core/src/main/java/org/elasticsearch/common/Strings.java, +++ b/core/src/main/java/org/elasticsearch/common/util/iterable/Iterables.java, +            this.inputs = inputs;, +++ b/core/src/main/java/org/elasticsearch/common/Strings.java, +++ b/core/src/main/java/org/elasticsearch/common/util/iterable/Iterables.java, +            this.inputs = inputs;, +++ b/core/src/main/java/org/elasticsearch/indices/IndexingMemoryController.java, +++ b/core/src/main/java/org/elasticsearch/common/Strings.java, +++ b/core/src/main/java/org/elasticsearch/common/util/iterable/Iterables.java, +            this.inputs = inputs;, +++ b/core/src/main/java/org/elasticsearch/indices/IndexingMemoryController.java, +++ b/core/src/test/java/org/elasticsearch/common/util/iterable/IterablesTests.java, +import java.util.ArrayList;, +import java.util.List;, +import org.elasticsearch.test.ESTestCase;, +, +    public void testFlatten() {, +        List<List<Integer>> list = new ArrayList<>();, +, +        Iterable<Integer> allInts = Iterables.flatten(list);, +        int count = 0;, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(0, count);, +, +        list.add(new ArrayList<>());, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(0, count);, +, +        list.get(0).add(0);, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(1, count);, +    }, +, +++ b/core/src/main/java/org/elasticsearch/common/Strings.java, +++ b/core/src/main/java/org/elasticsearch/common/util/iterable/Iterables.java, +            this.inputs = inputs;, +++ b/core/src/main/java/org/elasticsearch/indices/IndexingMemoryController.java, +++ b/core/src/test/java/org/elasticsearch/common/util/iterable/IterablesTests.java, +import java.util.ArrayList;, +import java.util.List;, +import org.elasticsearch.test.ESTestCase;, +, +    public void testFlatten() {, +        List<List<Integer>> list = new ArrayList<>();, +, +        Iterable<Integer> allInts = Iterables.flatten(list);, +        int count = 0;, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(0, count);, +, +        list.add(new ArrayList<>());, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(0, count);, +, +        list.get(0).add(0);, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(1, count);, +    }, +, +++ b/distribution/build.gradle, +    'heap.min': "256m",, +    'heap.max': "2g",, +++ b/core/src/main/java/org/elasticsearch/common/Strings.java, +++ b/core/src/main/java/org/elasticsearch/common/util/iterable/Iterables.java, +            this.inputs = inputs;, +++ b/core/src/main/java/org/elasticsearch/indices/IndexingMemoryController.java, +++ b/core/src/test/java/org/elasticsearch/common/util/iterable/IterablesTests.java, +import java.util.ArrayList;, +import java.util.List;, +import org.elasticsearch.test.ESTestCase;, +, +    public void testFlatten() {, +        List<List<Integer>> list = new ArrayList<>();, +, +        Iterable<Integer> allInts = Iterables.flatten(list);, +        int count = 0;, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(0, count);, +, +        list.add(new ArrayList<>());, +        for(int x : allInts) {, +            count++;, +        }, +        assertEquals(0, count);, +]