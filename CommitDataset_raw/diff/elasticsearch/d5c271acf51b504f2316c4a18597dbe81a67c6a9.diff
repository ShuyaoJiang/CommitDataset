[+++ b/src/main/java/org/elasticsearch/index/fielddata/DoubleValues.java, +import org.elasticsearch.index.fielddata.LongValues.Iter;, +            if (values.hasValue(docId)) {, +                final LongValues.Iter longIter = values.getIter(docId);, +                while(longIter.hasNext()) {, +                    proc.onValue(docId, longIter.next());, +                }, +            } else {, +                proc.onMissing(docId);, +            }, +++ b/src/main/java/org/elasticsearch/index/fielddata/DoubleValues.java, +import org.elasticsearch.index.fielddata.LongValues.Iter;, +            if (values.hasValue(docId)) {, +                final LongValues.Iter longIter = values.getIter(docId);, +                while(longIter.hasNext()) {, +                    proc.onValue(docId, longIter.next());, +                }, +            } else {, +                proc.onMissing(docId);, +            }, +++ b/src/main/java/org/elasticsearch/index/fielddata/LongValues.java, +import org.elasticsearch.index.fielddata.ordinals.Ordinals;, +import org.elasticsearch.index.fielddata.ordinals.Ordinals.Docs;, +public abstract class LongValues {, +    public static final LongValues EMPTY = new Empty();, +    private final boolean multiValued;, +    protected final Iter.Single iter = new Iter.Single();, +, +    , +    protected LongValues(boolean multiValued) {, +        this.multiValued = multiValued;, +    }, +    public final boolean isMultiValued() {, +        return multiValued;, +    }, +    public abstract boolean hasValue(int docId);, +    public abstract long getValue(int docId);, +    public long getValueMissing(int docId, long missingValue) {, +        if (hasValue(docId)) {, +            return getValue(docId);, +        }, +        return missingValue;, +    public Iter getIter(int docId) {, +        assert !isMultiValued();, +        if (hasValue(docId)) {, +            return iter.reset(getValue(docId));, +        } else {, +            return Iter.Empty.INSTANCE;, +        }, +    }, +, +    , +    public static abstract class DenseLongValues extends LongValues {, +        , +        , +        protected DenseLongValues(boolean multiValued) {, +            super(multiValued);, +        }, +        , +        @Override, +        public final boolean hasValue(int docId) {, +            return true;, +        }, +, +        public final long getValueMissing(int docId, long missingValue) {, +            assert hasValue(docId);, +            assert !isMultiValued();, +            return getValue(docId);, +        }, +        , +        public final Iter getIter(int docId) {, +            assert hasValue(docId);, +            assert !isMultiValued();, +            return iter.reset(getValue(docId));, +        }, +, +    }, +    , +    public static abstract class OrdBasedLongValues extends LongValues {, +, +        protected final Docs ordinals;, +        private final Iter.Multi iter;, +, +        protected OrdBasedLongValues(Ordinals.Docs ordinals) {, +            super(ordinals.isMultiValued());, +            this.ordinals = ordinals;, +            iter = new Iter.Multi(this);, +        }, +        , +        @Override, +        public final  boolean hasValue(int docId) {, +            return ordinals.getOrd(docId) != 0;, +        }, +, +        @Override, +        public final long getValue(int docId) {, +            return getByOrd(ordinals.getOrd(docId));, +        }, +        , +        protected abstract long getByOrd(int ord);]