[+++ b/src/main/java/org/elasticsearch/index/engine/internal/InternalEngine.java, +import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;, +import java.util.concurrent.RejectedExecutionException;, +        final IndexWriter writer;, +            writer = this.indexWriter;, +        checkVersionMapRefresh(writer);, +        final IndexWriter writer;, +            writer = this.indexWriter;, +        checkVersionMapRefresh(writer);, +    /** Forces a refresh if the versionMap is using too much RAM (currently > 25% of IndexWriter's RAM buffer)., +     * */, +    private void checkVersionMapRefresh(final IndexWriter indexWriter) {, +        if (versionMap.ramBytesUsedForRefresh()/1024/1024. > 0.25 * indexWriter.getConfig().getRAMBufferSizeMB() && versionMapRefreshPending.getAndSet(true) == false) {, +            if (!closed) {, +                try {, +                                try {, +                                } catch (EngineClosedException ex) {, +                                    // ignore, +                                }, +                } catch (EsRejectedExecutionException ex) {, +                    // that is fine too.. we might be shutting down, +                }, +            }]