[+++ b/x-pack/plugin/ccr/src/test/java/org/elasticsearch/xpack/ccr/action/ShardFollowTaskReplicationTests.java, +    public void testAddRemoveShardOnLeader() throws Exception {, +            int batches = between(0, 10);, +            int docCount = 0;, +            for (int i = 0; i < batches; i++) {, +                docCount += leaderGroup.indexDocs(between(1, 5));, +                if (leaderGroup.getReplicas().isEmpty() == false && randomInt(100) < 5) {, +                    IndexShard closingReplica = randomFrom(leaderGroup.getReplicas());, +                    leaderGroup.removeReplica(closingReplica);, +                    closingReplica.close("test", false);, +                    closingReplica.store().close();, +                } else if (leaderGroup.getReplicas().isEmpty() == false && rarely()) {, +                    IndexShard newPrimary = randomFrom(leaderGroup.getReplicas());, +                    leaderGroup.promoteReplicaToPrimary(newPrimary).get();, +                } else if (randomInt(100) < 5) {, +                }, +                leaderGroup.syncGlobalCheckpoint();, +            }, +            int expectedDoc = docCount;, +            assertBusy(() -> followerGroup.assertAllEqual(expectedDoc));]