[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/deletebyquery/DeleteByQueryRequest.java, +import org.apache.lucene.util.UnicodeUtil;, +import org.elasticsearch.util.xcontent.builder.XContentBuilder;, +    private int querySourceOffset;, +    private int querySourceLength;, +    private boolean querySourceUnsafe;, +, +        if (querySource == null) {, +        if (querySourceUnsafe) {, +            querySource = Arrays.copyOfRange(querySource, querySourceOffset, querySourceLength);, +            querySourceOffset = 0;, +            querySourceUnsafe = false;, +        FastByteArrayOutputStream bos = queryBuilder.buildAsUnsafeBytes();, +        this.querySource = bos.unsafeByteArray();, +        this.querySourceOffset = 0;, +        this.querySourceLength = bos.size();, +        this.querySourceUnsafe = true;, +        UnicodeUtil.UTF8Result result = Unicode.fromStringAsUtf8(querySource);, +        this.querySource = result.result;, +        this.querySourceOffset = 0;, +        this.querySourceLength = result.length;, +        this.querySourceUnsafe = true;, +        return this;, +            return query(builder);, +    }, +, +    @Required public DeleteByQueryRequest query(XContentBuilder builder) {, +        try {, +            this.querySource = builder.unsafeBytes();, +            this.querySourceOffset = 0;, +            this.querySourceLength = builder.unsafeBytesLength();, +            this.querySourceUnsafe = true;, +        } catch (IOException e) {, +            throw new ElasticSearchGenerationException("Failed to generate [" + builder + "]", e);, +        }, +, +        querySourceUnsafe = false;, +        querySourceOffset = 0;, +        querySourceLength = in.readVInt();, +        querySource = new byte[querySourceLength];, +, +, +        out.writeVInt(querySourceLength);, +        out.writeBytes(querySource, querySourceOffset, querySourceLength);, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/deletebyquery/DeleteByQueryRequest.java, +import org.apache.lucene.util.UnicodeUtil;, +import org.elasticsearch.util.xcontent.builder.XContentBuilder;, +    private int querySourceOffset;, +    private int querySourceLength;, +    private boolean querySourceUnsafe;, +, +        if (querySource == null) {, +        if (querySourceUnsafe) {, +            querySource = Arrays.copyOfRange(querySource, querySourceOffset, querySourceLength);, +            querySourceOffset = 0;, +            querySourceUnsafe = false;, +        FastByteArrayOutputStream bos = queryBuilder.buildAsUnsafeBytes();, +        this.querySource = bos.unsafeByteArray();, +        this.querySourceOffset = 0;, +        this.querySourceLength = bos.size();, +        this.querySourceUnsafe = true;, +        UnicodeUtil.UTF8Result result = Unicode.fromStringAsUtf8(querySource);, +        this.querySource = result.result;, +        this.querySourceOffset = 0;, +        this.querySourceLength = result.length;, +        this.querySourceUnsafe = true;, +        return this;, +            return query(builder);, +    }, +, +    @Required public DeleteByQueryRequest query(XContentBuilder builder) {, +        try {, +            this.querySource = builder.unsafeBytes();, +            this.querySourceOffset = 0;, +            this.querySourceLength = builder.unsafeBytesLength();, +            this.querySourceUnsafe = true;, +        } catch (IOException e) {, +            throw new ElasticSearchGenerationException("Failed to generate [" + builder + "]", e);, +        }, +, +        querySourceUnsafe = false;, +        querySourceOffset = 0;, +        querySourceLength = in.readVInt();, +        querySource = new byte[querySourceLength];, +, +, +        out.writeVInt(querySourceLength);, +        out.writeBytes(querySource, querySourceOffset, querySourceLength);, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/index/IndexRequest.java, +            sourceOffset = 0;, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/deletebyquery/DeleteByQueryRequest.java, +import org.apache.lucene.util.UnicodeUtil;, +import org.elasticsearch.util.xcontent.builder.XContentBuilder;, +    private int querySourceOffset;, +    private int querySourceLength;, +    private boolean querySourceUnsafe;, +, +        if (querySource == null) {]