[+++ b/core/src/main/java/org/elasticsearch/action/search/ExpandSearchPhase.java, +        groupSource.version(options.isVersion());, +++ b/core/src/main/java/org/elasticsearch/action/search/ExpandSearchPhase.java, +        groupSource.version(options.isVersion());, +++ b/core/src/test/java/org/elasticsearch/action/search/ExpandSearchPhaseTests.java, +        boolean version = randomBoolean();, +, +                assertTrue(request.requests().stream().allMatch((r) -> version == r.source().version()));, +                    .setInnerHits(new InnerHitBuilder().setName("foobarbaz").setVersion(version)), +++ b/core/src/main/java/org/elasticsearch/action/search/ExpandSearchPhase.java, +        groupSource.version(options.isVersion());, +++ b/core/src/test/java/org/elasticsearch/action/search/ExpandSearchPhaseTests.java, +        boolean version = randomBoolean();, +, +                assertTrue(request.requests().stream().allMatch((r) -> version == r.source().version()));, +                    .setInnerHits(new InnerHitBuilder().setName("foobarbaz").setVersion(version)), +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/110_field_collapsing.yml, +          version_type: external, +          version: 11, +          version_type: external, +          version: 22, +          version_type: external, +          version: 33, +          version_type: external, +          version: 44, +          version_type: external, +          version: 55, +          version_type: external, +          version: 66, +, +---, +"field collapsing, inner_hits and version":, +, +  - skip:, +      version: " - 6.99.99", +      reason:  "bug fixed in 7.0.0", +, +  - do:, +      search:, +        index: test, +        type:  test, +        body:, +          collapse: { field: numeric_group, inner_hits: { name: sub_hits, version: true, size: 2, sort: [{ sort: asc }] } }, +          sort: [{ sort: desc }], +          version: true, +, +  - match: { hits.total: 6 }, +  - length: { hits.hits: 3 }, +  - match: { hits.hits.0._index: test }, +  - match: { hits.hits.0._type: test }, +  - match: { hits.hits.0.fields.numeric_group: [3] }, +  - match: { hits.hits.0.sort: [36] }, +  - match: { hits.hits.0._id: "6" }, +  - match: { hits.hits.0._version: 66 }, +  - match: { hits.hits.0.inner_hits.sub_hits.hits.total: 1 }, +  - length: { hits.hits.0.inner_hits.sub_hits.hits.hits: 1 }, +  - match: { hits.hits.0.inner_hits.sub_hits.hits.hits.0._id: "6" }, +  - match: { hits.hits.0.inner_hits.sub_hits.hits.hits.0._version: 66 }, +  - match: { hits.hits.1._index: test }, +  - match: { hits.hits.1._type: test }, +  - match: { hits.hits.1.fields.numeric_group: [1] }, +  - match: { hits.hits.1.sort: [24] }, +  - match: { hits.hits.1._id: "3" }, +  - match: { hits.hits.1._version: 33 }, +  - match: { hits.hits.1.inner_hits.sub_hits.hits.total: 3 }, +  - length: { hits.hits.1.inner_hits.sub_hits.hits.hits: 2 }, +  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.0._id: "2" }, +  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.0._version: 22 }, +  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.1._id: "1" }, +  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.1._version: 11 }, +  - match: { hits.hits.2._index: test }, +  - match: { hits.hits.2._type: test }, +  - match: { hits.hits.2.fields.numeric_group: [25] }, +  - match: { hits.hits.2.sort: [10] }, +  - match: { hits.hits.2._id: "4" }, +  - match: { hits.hits.2._version: 44 }, +  - match: { hits.hits.2.inner_hits.sub_hits.hits.total: 2 }, +  - length: { hits.hits.2.inner_hits.sub_hits.hits.hits: 2 }, +  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.0._id: "5" }, +  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.0._version: 55 }, +  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.1._id: "4" }, +  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.1._version: 44 }]