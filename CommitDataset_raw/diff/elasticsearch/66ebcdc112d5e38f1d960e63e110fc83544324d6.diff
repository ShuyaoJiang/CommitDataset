[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/RestTestsFromSnippetsTask.groovy, +                testSetup(snippet), +                setup(test), +        private void setup(final Snippet snippet) {, +            // insert a setup defined outside of the docs, +            for (final String setupName : snippet.setup.split(',')) {, +                final String setup = setups[setupName], +                if (setup == null) {, +                    throw new InvalidUserDataException("Couldn't find setup for $snippet"), +                }, +                current.println(setup), +            }, +        }, +, +        private void testSetup(Snippet snippet) {, +            if (lastDocsPath == snippet.path) {, +                throw new InvalidUserDataException("$snippet: wasn't first"), +            setupCurrent(snippet), +            if (snippet.setup != null) {, +                setup(snippet), +            }, +            body(snippet, true)]