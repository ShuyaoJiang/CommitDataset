[+++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/AutoFollowCoordinator.java, +            followRequest.setMaxWriteBufferCount(pattern.getMaxWriteBufferCount());, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/AutoFollowCoordinator.java, +            followRequest.setMaxWriteBufferCount(pattern.getMaxWriteBufferCount());, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowNodeTask.java, +    private long bufferSizeInBytes = 0;, +        if (bufferSizeInBytes >= params.getMaxWriteBufferSize().getBytes()) {, +            LOGGER.trace("{} no new reads, buffer size limit has been reached [{}]", params.getFollowShardId(), bufferSizeInBytes);, +            return false;, +        }, +        if (buffer.size() > params.getMaxWriteBufferCount()) {, +            LOGGER.trace("{} no new reads, buffer count limit has been reached [{}]", params.getFollowShardId(), buffer.size());, +            bufferSizeInBytes -= sumEstimatedSize;, +            List<Translog.Operation> operations = Arrays.asList(response.getOperations());, +            long operationsSize = operations.stream(), +                .mapToLong(Translog.Operation::estimateSize), +                .sum();, +            buffer.addAll(operations);, +            bufferSizeInBytes += operationsSize;, +                bufferSizeInBytes,, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/AutoFollowCoordinator.java, +            followRequest.setMaxWriteBufferCount(pattern.getMaxWriteBufferCount());, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowNodeTask.java, +    private long bufferSizeInBytes = 0;, +        if (bufferSizeInBytes >= params.getMaxWriteBufferSize().getBytes()) {, +            LOGGER.trace("{} no new reads, buffer size limit has been reached [{}]", params.getFollowShardId(), bufferSizeInBytes);, +            return false;, +        }, +        if (buffer.size() > params.getMaxWriteBufferCount()) {, +            LOGGER.trace("{} no new reads, buffer count limit has been reached [{}]", params.getFollowShardId(), buffer.size());, +            bufferSizeInBytes -= sumEstimatedSize;, +            List<Translog.Operation> operations = Arrays.asList(response.getOperations());, +            long operationsSize = operations.stream(), +                .mapToLong(Translog.Operation::estimateSize), +                .sum();, +            buffer.addAll(operations);, +            bufferSizeInBytes += operationsSize;, +                bufferSizeInBytes,, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTask.java, +    public static final ParseField MAX_WRITE_BUFFER_COUNT = new ParseField("max_write_buffer_count");, +                (int) a[10], (int) a[11], (ByteSizeValue) a[12], (TimeValue) a[13], (TimeValue) a[14], (Map<String, String>) a[15]));, +        PARSER.declareInt(ConstructingObjectParser.constructorArg(), MAX_WRITE_BUFFER_COUNT);, +        PARSER.declareField(, +            ConstructingObjectParser.constructorArg(),, +            (p, c) -> ByteSizeValue.parseBytesSizeValue(p.text(), MAX_WRITE_BUFFER_SIZE.getPreferredName()),, +            MAX_WRITE_BUFFER_SIZE,, +            ObjectParser.ValueType.STRING);, +    private final int maxWriteBufferCount;, +    private final ByteSizeValue maxWriteBufferSize;, +            final int maxWriteBufferCount,, +            final ByteSizeValue maxWriteBufferSize,, +        this.maxWriteBufferCount = maxWriteBufferCount;, +        this.maxWriteBufferCount = in.readVInt();, +        this.maxWriteBufferSize = new ByteSizeValue(in);, +    public int getMaxWriteBufferCount() {, +        return maxWriteBufferCount;, +    }, +, +    public ByteSizeValue getMaxWriteBufferSize() {, +        out.writeVInt(maxWriteBufferCount);, +        maxWriteBufferSize.writeTo(out);, +        builder.field(MAX_WRITE_BUFFER_COUNT.getPreferredName(), maxWriteBufferCount);, +        builder.field(MAX_WRITE_BUFFER_SIZE.getPreferredName(), maxWriteBufferSize.getStringRep());, +                maxWriteBufferCount == that.maxWriteBufferCount &&, +                maxWriteBufferSize.equals(that.maxWriteBufferSize) &&, +                maxWriteBufferCount,, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/AutoFollowCoordinator.java, +            followRequest.setMaxWriteBufferCount(pattern.getMaxWriteBufferCount());, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowNodeTask.java, +    private long bufferSizeInBytes = 0;, +        if (bufferSizeInBytes >= params.getMaxWriteBufferSize().getBytes()) {, +            LOGGER.trace("{} no new reads, buffer size limit has been reached [{}]", params.getFollowShardId(), bufferSizeInBytes);, +            return false;, +        }, +        if (buffer.size() > params.getMaxWriteBufferCount()) {, +            LOGGER.trace("{} no new reads, buffer count limit has been reached [{}]", params.getFollowShardId(), buffer.size());, +            bufferSizeInBytes -= sumEstimatedSize;, +            List<Translog.Operation> operations = Arrays.asList(response.getOperations());, +            long operationsSize = operations.stream(), +                .mapToLong(Translog.Operation::estimateSize), +                .sum();, +            buffer.addAll(operations);, +            bufferSizeInBytes += operationsSize;, +                bufferSizeInBytes,, +++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTask.java, +    public static final ParseField MAX_WRITE_BUFFER_COUNT = new ParseField("max_write_buffer_count");, +                (int) a[10], (int) a[11], (ByteSizeValue) a[12], (TimeValue) a[13], (TimeValue) a[14], (Map<String, String>) a[15]));, +        PARSER.declareInt(ConstructingObjectParser.constructorArg(), MAX_WRITE_BUFFER_COUNT);, +        PARSER.declareField(, +            ConstructingObjectParser.constructorArg(),, +            (p, c) -> ByteSizeValue.parseBytesSizeValue(p.text(), MAX_WRITE_BUFFER_SIZE.getPreferredName()),, +            MAX_WRITE_BUFFER_SIZE,, +            ObjectParser.ValueType.STRING);, +    private final int maxWriteBufferCount;, +    private final ByteSizeValue maxWriteBufferSize;, +            final int maxWriteBufferCount,, +            final ByteSizeValue maxWriteBufferSize,, +        this.maxWriteBufferCount = maxWriteBufferCount;, +        this.maxWriteBufferCount = in.readVInt();, +        this.maxWriteBufferSize = new ByteSizeValue(in);]