[+++ b/core/src/test/java/org/elasticsearch/cluster/routing/RoutingTableTests.java, +    public static IndexMetaData updateActiveAllocations(IndexRoutingTable indexRoutingTable, IndexMetaData indexMetaData) {, +                Set<String> activeAllocations = shardTable.activeShards().stream().map(, +                    shr -> shr.allocationId().getId()).collect(Collectors.toSet());, +++ b/core/src/test/java/org/elasticsearch/cluster/routing/RoutingTableTests.java, +    public static IndexMetaData updateActiveAllocations(IndexRoutingTable indexRoutingTable, IndexMetaData indexMetaData) {, +                Set<String> activeAllocations = shardTable.activeShards().stream().map(, +                    shr -> shr.allocationId().getId()).collect(Collectors.toSet());, +++ b/core/src/test/java/org/elasticsearch/discovery/zen/NodeJoinControllerTests.java, +import static org.elasticsearch.cluster.routing.RoutingTableTests.updateActiveAllocations;, +            IndexRoutingTable indexRoutingTable = indexRoutingTableBuilder.build();, +            IndexMetaData updatedIndexMetaData = updateActiveAllocations(indexRoutingTable, indexMetaData);, +            stateBuilder.metaData(MetaData.builder().put(updatedIndexMetaData, false).generateClusterUuidIfNeeded()), +                        .routingTable(RoutingTable.builder().add(indexRoutingTable).build());]