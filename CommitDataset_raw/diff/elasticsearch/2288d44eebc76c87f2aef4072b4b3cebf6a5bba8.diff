[+++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/support/TransportActions.java, +import org.apache.lucene.store.AlreadyClosedException;, +                actual instanceof UnavailableShardsException ||, +                actual instanceof AlreadyClosedException) {, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/support/TransportActions.java, +import org.apache.lucene.store.AlreadyClosedException;, +                actual instanceof UnavailableShardsException ||, +                actual instanceof AlreadyClosedException) {, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/node/TransportBroadcastByNodeAction.java, +    protected abstract ShardOperationResult shardOperation(Request request, ShardRouting shardRouting) throws IOException;, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/support/TransportActions.java, +import org.apache.lucene.store.AlreadyClosedException;, +                actual instanceof UnavailableShardsException ||, +                actual instanceof AlreadyClosedException) {, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/node/TransportBroadcastByNodeAction.java, +    protected abstract ShardOperationResult shardOperation(Request request, ShardRouting shardRouting) throws IOException;, +++ b/core/src/main/java/org/elasticsearch/action/support/single/shard/TransportSingleShardAction.java, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/support/TransportActions.java, +import org.apache.lucene.store.AlreadyClosedException;, +                actual instanceof UnavailableShardsException ||, +                actual instanceof AlreadyClosedException) {, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/node/TransportBroadcastByNodeAction.java, +    protected abstract ShardOperationResult shardOperation(Request request, ShardRouting shardRouting) throws IOException;, +++ b/core/src/main/java/org/elasticsearch/action/support/single/shard/TransportSingleShardAction.java, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java, +                    return indexCmp;, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/support/TransportActions.java, +import org.apache.lucene.store.AlreadyClosedException;, +                actual instanceof UnavailableShardsException ||, +                actual instanceof AlreadyClosedException) {, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/node/TransportBroadcastByNodeAction.java, +    protected abstract ShardOperationResult shardOperation(Request request, ShardRouting shardRouting) throws IOException;, +++ b/core/src/main/java/org/elasticsearch/action/support/single/shard/TransportSingleShardAction.java, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java, +                    return indexCmp;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +    private ClusterState rejoin(ClusterState clusterState, String reason) {, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java, +    protected ShardUpgradeResult shardOperation(UpgradeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/support/TransportActions.java, +import org.apache.lucene.store.AlreadyClosedException;, +                actual instanceof UnavailableShardsException ||, +                actual instanceof AlreadyClosedException) {, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/node/TransportBroadcastByNodeAction.java, +    protected abstract ShardOperationResult shardOperation(Request request, ShardRouting shardRouting) throws IOException;, +++ b/core/src/main/java/org/elasticsearch/action/support/single/shard/TransportSingleShardAction.java, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java, +                    return indexCmp;, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +    private ClusterState rejoin(ClusterState clusterState, String reason) {, +++ b/core/src/main/java/org/elasticsearch/gateway/GatewayAllocator.java, +        unassigned.sort(new PriorityComparator() {, +, +            @Override, +            protected Settings getIndexSettings(String index) {, +                IndexMetaData indexMetaData = allocation.metaData().index(index);, +                return indexMetaData.getSettings();, +            }, +        }); // sort for priority ordering, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/optimize/TransportOptimizeAction.java, +    protected EmptyResult shardOperation(OptimizeRequest request, ShardRouting shardRouting) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/upgrade/post/TransportUpgradeAction.java]