[+++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/hdr/AbstractInternalHDRPercentiles.java, +import java.util.Arrays;, +import java.util.Objects;, +, +    @Override, +    protected boolean doEquals(Object obj) {, +        AbstractInternalHDRPercentiles that = (AbstractInternalHDRPercentiles) obj;, +        return keyed == that.keyed, +                && Arrays.equals(keys, that.keys), +                && Objects.equals(state, that.state);, +    }, +, +    @Override, +    protected int doHashCode() {, +        // we cannot use state.hashCode at the moment because of:, +        // https://github.com/HdrHistogram/HdrHistogram/issues/81, +        // TODO: upgrade the HDRHistogram library, +        return Objects.hash(keyed, Arrays.hashCode(keys), state.getIntegerToDoubleValueConversionRatio(), state.getTotalCount());, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/hdr/AbstractInternalHDRPercentiles.java, +import java.util.Arrays;, +import java.util.Objects;, +, +    @Override, +    protected boolean doEquals(Object obj) {, +        AbstractInternalHDRPercentiles that = (AbstractInternalHDRPercentiles) obj;, +        return keyed == that.keyed, +                && Arrays.equals(keys, that.keys), +                && Objects.equals(state, that.state);, +    }, +, +    @Override, +    protected int doHashCode() {, +        // we cannot use state.hashCode at the moment because of:, +        // https://github.com/HdrHistogram/HdrHistogram/issues/81, +        // TODO: upgrade the HDRHistogram library, +        return Objects.hash(keyed, Arrays.hashCode(keys), state.getIntegerToDoubleValueConversionRatio(), state.getTotalCount());, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/tdigest/AbstractInternalTDigestPercentiles.java, +import java.util.Arrays;, +import java.util.Objects;, +, +    @Override, +    protected boolean doEquals(Object obj) {, +        AbstractInternalTDigestPercentiles that = (AbstractInternalTDigestPercentiles) obj;, +        return keyed == that.keyed, +                && Arrays.equals(keys, that.keys), +                && Objects.equals(state, that.state);, +    }, +, +    @Override, +    protected int doHashCode() {, +        return Objects.hash(keyed, Arrays.hashCode(keys), state);, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/hdr/AbstractInternalHDRPercentiles.java, +import java.util.Arrays;, +import java.util.Objects;, +, +    @Override, +    protected boolean doEquals(Object obj) {, +        AbstractInternalHDRPercentiles that = (AbstractInternalHDRPercentiles) obj;, +        return keyed == that.keyed, +                && Arrays.equals(keys, that.keys), +                && Objects.equals(state, that.state);, +    }, +, +    @Override, +    protected int doHashCode() {, +        // we cannot use state.hashCode at the moment because of:, +        // https://github.com/HdrHistogram/HdrHistogram/issues/81, +        // TODO: upgrade the HDRHistogram library, +        return Objects.hash(keyed, Arrays.hashCode(keys), state.getIntegerToDoubleValueConversionRatio(), state.getTotalCount());, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/tdigest/AbstractInternalTDigestPercentiles.java, +import java.util.Arrays;, +import java.util.Objects;, +, +    @Override, +    protected boolean doEquals(Object obj) {, +        AbstractInternalTDigestPercentiles that = (AbstractInternalTDigestPercentiles) obj;, +        return keyed == that.keyed, +                && Arrays.equals(keys, that.keys), +                && Objects.equals(state, that.state);, +    }, +, +    @Override, +    protected int doHashCode() {, +        return Objects.hash(keyed, Arrays.hashCode(keys), state);, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/tdigest/InternalTDigestPercentileRanks.java, +, +    @Override, +    protected boolean doEquals(Object obj) {, +        return super.doEquals(obj);, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/percentiles/hdr/AbstractInternalHDRPercentiles.java, +import java.util.Arrays;, +import java.util.Objects;, +, +    @Override]