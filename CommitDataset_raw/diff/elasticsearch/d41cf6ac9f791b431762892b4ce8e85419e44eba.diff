[+++ b/server/src/main/java/org/elasticsearch/common/lucene/Lucene.java, +                    final SegmentReader segmentReader = segmentReader(leaf);, +                    final Bits hardLiveDocs = segmentReader.getHardLiveDocs();, +                    // Once soft-deletes is enabled, we no longer hard-update or hard-delete documents directly., +                    // Two scenarios that we have hard-deletes: (1) from old segments where soft-deletes was disabled,, +                    // (2) when IndexWriter hits non-aborted exceptions. These two cases, IW flushes SegmentInfos, +                    // before exposing the hard-deletes, thus we can use the hard-delete count of SegmentInfos., +                    final int numDocs = segmentReader.maxDoc() - segmentReader.getSegmentInfo().getDelCount();, +                    assert numDocs == popCount(hardLiveDocs) : numDocs + " != " + popCount(hardLiveDocs);, +    private static int popCount(Bits bits) {, +        assert bits != null;, +        int onBits = 0;, +        for (int i = 0; i < bits.length(); i++) {, +            if (bits.get(i)) {, +                onBits++;, +            }, +        }, +        return onBits;, +    }, +, +++ b/server/src/main/java/org/elasticsearch/common/lucene/Lucene.java, +                    final SegmentReader segmentReader = segmentReader(leaf);, +                    final Bits hardLiveDocs = segmentReader.getHardLiveDocs();, +                    // Once soft-deletes is enabled, we no longer hard-update or hard-delete documents directly., +                    // Two scenarios that we have hard-deletes: (1) from old segments where soft-deletes was disabled,, +                    // (2) when IndexWriter hits non-aborted exceptions. These two cases, IW flushes SegmentInfos, +                    // before exposing the hard-deletes, thus we can use the hard-delete count of SegmentInfos., +                    final int numDocs = segmentReader.maxDoc() - segmentReader.getSegmentInfo().getDelCount();, +                    assert numDocs == popCount(hardLiveDocs) : numDocs + " != " + popCount(hardLiveDocs);, +    private static int popCount(Bits bits) {, +        assert bits != null;, +        int onBits = 0;, +        for (int i = 0; i < bits.length(); i++) {, +            if (bits.get(i)) {, +                onBits++;, +            }, +        }, +        return onBits;, +    }, +, +++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java, +        @Override, +        public long tryDeleteDocument(IndexReader readerIn, int docID) {, +            assert false : "#tryDeleteDocument is not supported. See Lucene#DirectoryReaderWithAllLiveDocs";, +            throw new UnsupportedOperationException();, +        }]