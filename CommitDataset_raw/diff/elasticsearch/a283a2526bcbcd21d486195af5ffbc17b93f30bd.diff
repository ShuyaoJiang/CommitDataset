[+++ b/core/src/main/java/org/elasticsearch/node/Node.java, +                final CountDownLatch latch = new CountDownLatch(1);, +                    public void onNewClusterState(ClusterState state) { latch.countDown(); }, +                        logger.warn("timed out while waiting for initial discovery state - timeout: {}",, +                            DiscoverySettings.INITIAL_STATE_TIMEOUT_SETTING.get(settings));, +                        latch.countDown();, +                }, MasterNodeChangePredicate.INSTANCE, DiscoverySettings.INITIAL_STATE_TIMEOUT_SETTING.get(settings));, +                    latch.await();, +        }, +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +                final CountDownLatch latch = new CountDownLatch(1);, +                    public void onNewClusterState(ClusterState state) { latch.countDown(); }, +                        logger.warn("timed out while waiting for initial discovery state - timeout: {}",, +                            DiscoverySettings.INITIAL_STATE_TIMEOUT_SETTING.get(settings));, +                        latch.countDown();, +                }, MasterNodeChangePredicate.INSTANCE, DiscoverySettings.INITIAL_STATE_TIMEOUT_SETTING.get(settings));, +                    latch.await();, +        }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/stats/extended/ExtendedStatsAggregator.java, +    public InternalAggregation buildAggregation(long owningBucketOrdinal) {, +        if (valuesSource == null) {, +            return new InternalExtendedStats(name, 0, 0d, Double.POSITIVE_INFINITY, Double.NEGATIVE_INFINITY, 0d, 0d, formatter,, +                    pipelineAggregators(), metaData());, +        assert owningBucketOrdinal < counts.size();, +        return new InternalExtendedStats(name, counts.get(owningBucketOrdinal), sums.get(owningBucketOrdinal),, +                mins.get(owningBucketOrdinal), maxes.get(owningBucketOrdinal), sumOfSqrs.get(owningBucketOrdinal), sigma, formatter,, +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +                final CountDownLatch latch = new CountDownLatch(1);, +                    public void onNewClusterState(ClusterState state) { latch.countDown(); }, +                        logger.warn("timed out while waiting for initial discovery state - timeout: {}",, +                            DiscoverySettings.INITIAL_STATE_TIMEOUT_SETTING.get(settings));, +                        latch.countDown();, +                }, MasterNodeChangePredicate.INSTANCE, DiscoverySettings.INITIAL_STATE_TIMEOUT_SETTING.get(settings));, +                    latch.await();, +        }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/stats/extended/ExtendedStatsAggregator.java, +    public InternalAggregation buildAggregation(long owningBucketOrdinal) {, +        if (valuesSource == null) {, +            return new InternalExtendedStats(name, 0, 0d, Double.POSITIVE_INFINITY, Double.NEGATIVE_INFINITY, 0d, 0d, formatter,, +                    pipelineAggregators(), metaData());, +        assert owningBucketOrdinal < counts.size();, +        return new InternalExtendedStats(name, counts.get(owningBucketOrdinal), sums.get(owningBucketOrdinal),, +                mins.get(owningBucketOrdinal), maxes.get(owningBucketOrdinal), sumOfSqrs.get(owningBucketOrdinal), sigma, formatter,, +++ b/modules/lang-groovy/src/test/java/org/elasticsearch/messy/tests/ExtendedStatsTests.java]