[+++ b/src/test/java/org/elasticsearch/test/integration/percolator/ConcurrentPercolatorTests.java, +import java.util.concurrent.Semaphore;, +        final Semaphore semaphore = new Semaphore(numIndexThreads, true);, +                            semaphore.acquire();, +                            try {, +                            } finally {, +                                semaphore.release();, +                        }, +                    } catch (InterruptedException iex) {, +                        logger.error("indexing thread was interrupted...", iex);, +                        run.set(false);, +            Thread.sleep(5);, +            semaphore.acquire(numIndexThreads);, +            try {, +                if (!run.get()) {, +                    break;, +                }, +            } finally {, +                semaphore.release(numIndexThreads);, +            }]