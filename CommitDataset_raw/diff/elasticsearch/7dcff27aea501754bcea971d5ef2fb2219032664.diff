[+++ b/docs/build.gradle, +    configFile 'scripts/my_init_script.painless', +    configFile 'scripts/my_map_script.painless', +    configFile 'scripts/my_combine_script.painless', +    configFile 'scripts/my_reduce_script.painless', +// Used by scripted metric docs, +buildRestTests.setups['ledger'] = ''', +  - do:, +    indices.create:, +      index: ledger, +      body:, +        settings:, +          number_of_shards: 2, +          number_of_replicas: 1, +        mappings:, +          sale:, +            properties:, +              type:, +                type: keyword, +              amount:, +                type: double, +  - do:, +    bulk:, +      index: ledger, +      type: item, +      refresh: true, +      body: |, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 200, "type": "sale", "description": "something"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 10, "type": "expense", "decription": "another thing"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 150, "type": "sale", "description": "blah"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 50, "type": "expense", "description": "cost of blah"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 50, "type": "expense", "description": "advertisement"}''', +, +++ b/docs/build.gradle, +    configFile 'scripts/my_init_script.painless', +    configFile 'scripts/my_map_script.painless', +    configFile 'scripts/my_combine_script.painless', +    configFile 'scripts/my_reduce_script.painless', +// Used by scripted metric docs, +buildRestTests.setups['ledger'] = ''', +  - do:, +    indices.create:, +      index: ledger, +      body:, +        settings:, +          number_of_shards: 2, +          number_of_replicas: 1, +        mappings:, +          sale:, +            properties:, +              type:, +                type: keyword, +              amount:, +                type: double, +  - do:, +    bulk:, +      index: ledger, +      type: item, +      refresh: true, +      body: |, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 200, "type": "sale", "description": "something"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 10, "type": "expense", "decription": "another thing"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 150, "type": "sale", "description": "blah"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 50, "type": "expense", "description": "cost of blah"}, +        {"index":{}}, +        {"date": "2015/01/01 00:00:00", "amount": 50, "type": "expense", "description": "advertisement"}''', +, +++ b/docs/reference/aggregations/metrics/scripted-metric-aggregation.asciidoc, +POST ledger/_search?size=0, +                "init_script" : "params._agg.transactions = []",, +                "map_script" : "params._agg.transactions.add(doc.type.value == 'sale' ? doc.amount.value : -1 * doc.amount.value)", <1>, +                "combine_script" : "double profit = 0; for (t in params._agg.transactions) { profit += t } return profit",, +                "reduce_script" : "double profit = 0; for (a in params._aggs) { profit += a } return profit", +// CONSOLE, +// TEST[setup:ledger], +    "took": 218,, +            "value": 240.0, +// TESTRESPONSE[s/"took": 218/"took": $body.took/], +// TESTRESPONSE[s/\.\.\./"_shards": $body._shards, "hits": $body.hits, "timed_out": false,/], +POST ledger/_search?size=0, +                    "field": "amount", <1>, +                    "_agg": {}        <2>, +                }, +// CONSOLE, +// TEST[setup:ledger], +<1> script parameters for `init`, `map` and `combine` scripts must be specified, +in a global `params` object so that it can be share between the scripts., +<2> if you specify script parameters then you must specify `"_agg": {}`., +, +////, +Verify this response as well but in a hidden block.]