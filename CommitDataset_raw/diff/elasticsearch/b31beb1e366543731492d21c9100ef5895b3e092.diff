[+++ b/src/main/java/org/elasticsearch/shield/ShieldModule.java, +import org.elasticsearch.shield.signature.SignatureModule;, +                new SignatureModule(settings),, +++ b/src/main/java/org/elasticsearch/shield/ShieldModule.java, +import org.elasticsearch.shield.signature.SignatureModule;, +                new SignatureModule(settings),, +++ b/src/main/java/org/elasticsearch/shield/action/ShieldActionFilter.java, +import org.elasticsearch.shield.signature.SignatureService;, +import org.elasticsearch.shield.signature.SignatureException;, +    private final SignatureService signatureService;, +    public ShieldActionFilter(AuthenticationService authcService, AuthorizationService authzService, SignatureService signatureService, AuditTrail auditTrail) {, +        this.signatureService = signatureService;, +                scrollRequest.scrollId(signatureService.unsignAndVerify(scrollId));, +                    unsignedIds.add(signatureService.unsignAndVerify(signedId));, +            if (scrollId != null && !signatureService.signed(scrollId)) {, +                searchResponse.scrollId(signatureService.sign(scrollId));, +++ b/src/main/java/org/elasticsearch/shield/ShieldModule.java, +import org.elasticsearch.shield.signature.SignatureModule;, +                new SignatureModule(settings),, +++ b/src/main/java/org/elasticsearch/shield/action/ShieldActionFilter.java, +import org.elasticsearch.shield.signature.SignatureService;, +import org.elasticsearch.shield.signature.SignatureException;, +    private final SignatureService signatureService;, +    public ShieldActionFilter(AuthenticationService authcService, AuthorizationService authzService, SignatureService signatureService, AuditTrail auditTrail) {, +        this.signatureService = signatureService;, +                scrollRequest.scrollId(signatureService.unsignAndVerify(scrollId));, +                    unsignedIds.add(signatureService.unsignAndVerify(signedId));, +            if (scrollId != null && !signatureService.signed(scrollId)) {, +                searchResponse.scrollId(signatureService.sign(scrollId));, +++ b/src/main/java/org/elasticsearch/shield/authc/InternalAuthenticationService.java, +import org.elasticsearch.shield.signature.SignatureService;, +    private final SignatureService signatureService;, +    public InternalAuthenticationService(Settings settings, Realms realms, AuditTrail auditTrail, SignatureService signatureService) {, +        this.signatureService = signatureService;, +                header = signatureService.unsignAndVerify(header);, +            header = signUserHeader ? signatureService.sign(encodeUser(user, logger)) : encodeUser(user, logger);, +            header = signUserHeader ? signatureService.sign(encodeUser(user, logger)) : encodeUser(user, logger);, +++ b/src/main/java/org/elasticsearch/shield/ShieldModule.java, +import org.elasticsearch.shield.signature.SignatureModule;, +                new SignatureModule(settings),, +++ b/src/main/java/org/elasticsearch/shield/action/ShieldActionFilter.java, +import org.elasticsearch.shield.signature.SignatureService;, +import org.elasticsearch.shield.signature.SignatureException;, +    private final SignatureService signatureService;, +    public ShieldActionFilter(AuthenticationService authcService, AuthorizationService authzService, SignatureService signatureService, AuditTrail auditTrail) {, +        this.signatureService = signatureService;, +                scrollRequest.scrollId(signatureService.unsignAndVerify(scrollId));, +                    unsignedIds.add(signatureService.unsignAndVerify(signedId));, +            if (scrollId != null && !signatureService.signed(scrollId)) {, +                searchResponse.scrollId(signatureService.sign(scrollId));, +++ b/src/main/java/org/elasticsearch/shield/authc/InternalAuthenticationService.java, +import org.elasticsearch.shield.signature.SignatureService;, +    private final SignatureService signatureService;, +    public InternalAuthenticationService(Settings settings, Realms realms, AuditTrail auditTrail, SignatureService signatureService) {, +        this.signatureService = signatureService;, +                header = signatureService.unsignAndVerify(header);, +            header = signUserHeader ? signatureService.sign(encodeUser(user, logger)) : encodeUser(user, logger);, +            header = signUserHeader ? signatureService.sign(encodeUser(user, logger)) : encodeUser(user, logger);, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/shield/ShieldModule.java, +import org.elasticsearch.shield.signature.SignatureModule;, +                new SignatureModule(settings),, +++ b/src/main/java/org/elasticsearch/shield/action/ShieldActionFilter.java, +import org.elasticsearch.shield.signature.SignatureService;, +import org.elasticsearch.shield.signature.SignatureException;, +    private final SignatureService signatureService;, +    public ShieldActionFilter(AuthenticationService authcService, AuthorizationService authzService, SignatureService signatureService, AuditTrail auditTrail) {, +        this.signatureService = signatureService;, +                scrollRequest.scrollId(signatureService.unsignAndVerify(scrollId));, +                    unsignedIds.add(signatureService.unsignAndVerify(signedId));, +            if (scrollId != null && !signatureService.signed(scrollId)) {, +                searchResponse.scrollId(signatureService.sign(scrollId));, +++ b/src/main/java/org/elasticsearch/shield/authc/InternalAuthenticationService.java, +import org.elasticsearch.shield.signature.SignatureService;, +    private final SignatureService signatureService;, +    public InternalAuthenticationService(Settings settings, Realms realms, AuditTrail auditTrail, SignatureService signatureService) {, +        this.signatureService = signatureService;, +                header = signatureService.unsignAndVerify(header);, +            header = signUserHeader ? signatureService.sign(encodeUser(user, logger)) : encodeUser(user, logger);, +            header = signUserHeader ? signatureService.sign(encodeUser(user, logger)) : encodeUser(user, logger);, +++ /dev/null, +++ /dev/null, +++ b/src/main/java/org/elasticsearch/shield/ShieldModule.java, +import org.elasticsearch.shield.signature.SignatureModule;, +                new SignatureModule(settings),, +++ b/src/main/java/org/elasticsearch/shield/action/ShieldActionFilter.java, +import org.elasticsearch.shield.signature.SignatureService;, +import org.elasticsearch.shield.signature.SignatureException;, +    private final SignatureService signatureService;, +    public ShieldActionFilter(AuthenticationService authcService, AuthorizationService authzService, SignatureService signatureService, AuditTrail auditTrail) {, +        this.signatureService = signatureService;, +                scrollRequest.scrollId(signatureService.unsignAndVerify(scrollId));, +                    unsignedIds.add(signatureService.unsignAndVerify(signedId));, +            if (scrollId != null && !signatureService.signed(scrollId)) {, +                searchResponse.scrollId(signatureService.sign(scrollId));, +++ b/src/main/java/org/elasticsearch/shield/authc/InternalAuthenticationService.java, +import org.elasticsearch.shield.signature.SignatureService;, +    private final SignatureService signatureService;, +    public InternalAuthenticationService(Settings settings, Realms realms, AuditTrail auditTrail, SignatureService signatureService) {, +        this.signatureService = signatureService;]