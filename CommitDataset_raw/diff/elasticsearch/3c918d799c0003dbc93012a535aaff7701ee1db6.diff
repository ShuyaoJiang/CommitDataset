[+++ b/modules/lang-mustache/src/test/java/org/elasticsearch/script/mustache/SearchTemplateIT.java, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +++ b/modules/lang-mustache/src/test/java/org/elasticsearch/script/mustache/SearchTemplateIT.java, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +++ b/server/src/main/java/org/elasticsearch/script/StoredScriptSource.java, +     * Standard {@link ParseField} for query on the inner field., +     */, +    public static final ParseField TEMPLATE_NO_WRAPPER_PARSE_FIELD = new ParseField("query");, +, +    /**, +    private static StoredScriptSource parseRemaining(Token token, XContentParser parser) throws IOException {, +        try (XContentBuilder builder = XContentFactory.jsonBuilder()) {, +            if (token != Token.START_OBJECT) {, +                builder.startObject();, +                builder.copyCurrentStructure(parser);, +                builder.endObject();, +            } else {, +                builder.copyCurrentStructure(parser);, +            }, +, +            String source = Strings.toString(builder);, +, +            if (source == null || source.isEmpty()) {, +                DEPRECATION_LOGGER.deprecated("empty templates should no longer be used");, +            }, +, +            return new StoredScriptSource(Script.DEFAULT_TEMPLATE_LANG, source, Collections.emptyMap());, +        }, +    }, +, +            } else if (TEMPLATE_PARSE_FIELD.getPreferredName().equals(name)) {, +                DEPRECATION_LOGGER.deprecated("the template context is now deprecated. Specify templates in a \"script\" element.");, +, +                token = parser.nextToken();, +                    return parseRemaining(token, parser);, +            } else if (TEMPLATE_NO_WRAPPER_PARSE_FIELD.getPreferredName().equals(name)) {, +                DEPRECATION_LOGGER.deprecated("the template context is now deprecated. Specify templates in a \"script\" element.");, +                return parseRemaining(token, parser);, +            } else {, +                DEPRECATION_LOGGER.deprecated("scripts should not be stored without a context. Specify them in a \"script\" element.");, +                return parseRemaining(token, parser);, +++ b/modules/lang-mustache/src/test/java/org/elasticsearch/script/mustache/SearchTemplateIT.java, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +++ b/server/src/main/java/org/elasticsearch/script/StoredScriptSource.java, +     * Standard {@link ParseField} for query on the inner field., +     */, +    public static final ParseField TEMPLATE_NO_WRAPPER_PARSE_FIELD = new ParseField("query");, +, +    /**, +    private static StoredScriptSource parseRemaining(Token token, XContentParser parser) throws IOException {, +        try (XContentBuilder builder = XContentFactory.jsonBuilder()) {, +            if (token != Token.START_OBJECT) {, +                builder.startObject();, +                builder.copyCurrentStructure(parser);, +                builder.endObject();, +            } else {, +                builder.copyCurrentStructure(parser);, +            }, +, +            String source = Strings.toString(builder);, +, +            if (source == null || source.isEmpty()) {, +                DEPRECATION_LOGGER.deprecated("empty templates should no longer be used");, +            }, +, +            return new StoredScriptSource(Script.DEFAULT_TEMPLATE_LANG, source, Collections.emptyMap());, +        }, +    }, +, +            } else if (TEMPLATE_PARSE_FIELD.getPreferredName().equals(name)) {, +                DEPRECATION_LOGGER.deprecated("the template context is now deprecated. Specify templates in a \"script\" element.");, +, +                token = parser.nextToken();, +                    return parseRemaining(token, parser);, +            } else if (TEMPLATE_NO_WRAPPER_PARSE_FIELD.getPreferredName().equals(name)) {, +                DEPRECATION_LOGGER.deprecated("the template context is now deprecated. Specify templates in a \"script\" element.");, +                return parseRemaining(token, parser);, +            } else {, +                DEPRECATION_LOGGER.deprecated("scripts should not be stored without a context. Specify them in a \"script\" element.");, +                return parseRemaining(token, parser);, +++ b/server/src/test/java/org/elasticsearch/script/ScriptMetaDataTests.java, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("scripts should not be stored without a context. Specify them in a \"script\" element.");, +        assertWarnings("scripts should not be stored without a context. Specify them in a \"script\" element.");, +        assertWarnings("scripts should not be stored without a context. Specify them in a \"script\" element.");, +        assertWarnings("scripts should not be stored without a context. Specify them in a \"script\" element.");, +        assertWarnings("scripts should not be stored without a context. Specify them in a \"script\" element.");, +++ b/modules/lang-mustache/src/test/java/org/elasticsearch/script/mustache/SearchTemplateIT.java, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");, +        assertWarnings("the template context is now deprecated. Specify templates in a \"script\" element.");]