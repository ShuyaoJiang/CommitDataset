[+++ b/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/RecoveryIT.java, +import java.util.concurrent.TimeUnit;, +import static org.hamcrest.Matchers.isIn;, +                // ensure the relocation from old node to new node has occurred; otherwise ensureGreen can, +                // return true even though shards haven't moved to the new node yet (allocation was throttled)., +                assertBusy(() -> {, +                    Map<String, ?> state = entityAsMap(client().performRequest(new Request("GET", "/_cluster/state")));, +                    String xpath = "routing_table.indices." + index + ".shards.0.node";, +                    @SuppressWarnings("unchecked") List<String> assignedNodes = (List<String>) XContentMapValues.extractValue(xpath, state);, +                    assertNotNull(state.toString(), assignedNodes);, +                    assertThat(state.toString(), newNode, isIn(assignedNodes));, +                }, 60, TimeUnit.SECONDS);]