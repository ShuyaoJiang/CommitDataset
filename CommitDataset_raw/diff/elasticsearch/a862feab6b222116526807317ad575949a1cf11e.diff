[+++ /dev/null, +++ /dev/null, +++ b/TESTING.asciidoc, +++ /dev/null, +++ b/TESTING.asciidoc, +++ b/dev-tools/create_bwc_index.py, +    '-Epath.data=%s' % data_dir,, +    '-Epath.logs=logs',, +    '-Ecluster.name=%s' % cluster_name,, +    '-Enetwork.host=localhost',, +    '-Etransport.tcp.port=%s' % tcp_port,, +    '-Ehttp.port=%s' % http_port,, +    '-Epath.repo=%s' % repo_dir, +++ /dev/null, +++ b/TESTING.asciidoc, +++ b/dev-tools/create_bwc_index.py, +    '-Epath.data=%s' % data_dir,, +    '-Epath.logs=logs',, +    '-Ecluster.name=%s' % cluster_name,, +    '-Enetwork.host=localhost',, +    '-Etransport.tcp.port=%s' % tcp_port,, +    '-Ehttp.port=%s' % http_port,, +    '-Epath.repo=%s' % repo_dir, +++ b/modules/reindex/src/main/java/org/elasticsearch/index/reindex/AbstractAsyncBulkByScrollAction.java, +                        TimeValue delay = retries.next();, +                        logger.trace("retrying rejected search after [{}]", e, delay);, +                        threadPool.schedule(delay, ThreadPool.Names.SAME, this);, +++ /dev/null, +++ b/TESTING.asciidoc, +++ b/dev-tools/create_bwc_index.py, +    '-Epath.data=%s' % data_dir,, +    '-Epath.logs=logs',, +    '-Ecluster.name=%s' % cluster_name,, +    '-Enetwork.host=localhost',, +    '-Etransport.tcp.port=%s' % tcp_port,, +    '-Ehttp.port=%s' % http_port,, +    '-Epath.repo=%s' % repo_dir, +++ b/modules/reindex/src/main/java/org/elasticsearch/index/reindex/AbstractAsyncBulkByScrollAction.java, +                        TimeValue delay = retries.next();, +                        logger.trace("retrying rejected search after [{}]", e, delay);, +                        threadPool.schedule(delay, ThreadPool.Names.SAME, this);, +++ b/modules/reindex/src/test/java/org/elasticsearch/index/reindex/ReindexTestCase.java, +    public static BulkIndexByScrollResponseMatcher matcher() {, +++ /dev/null, +++ b/TESTING.asciidoc, +++ b/dev-tools/create_bwc_index.py, +    '-Epath.data=%s' % data_dir,, +    '-Epath.logs=logs',, +    '-Ecluster.name=%s' % cluster_name,, +    '-Enetwork.host=localhost',, +    '-Etransport.tcp.port=%s' % tcp_port,, +    '-Ehttp.port=%s' % http_port,, +    '-Epath.repo=%s' % repo_dir, +++ b/modules/reindex/src/main/java/org/elasticsearch/index/reindex/AbstractAsyncBulkByScrollAction.java, +                        TimeValue delay = retries.next();, +                        logger.trace("retrying rejected search after [{}]", e, delay);, +                        threadPool.schedule(delay, ThreadPool.Names.SAME, this);, +++ b/modules/reindex/src/test/java/org/elasticsearch/index/reindex/ReindexTestCase.java, +    public static BulkIndexByScrollResponseMatcher matcher() {, +++ b/modules/reindex/src/test/java/org/elasticsearch/index/reindex/RetryTests.java, +import org.elasticsearch.action.admin.cluster.node.tasks.list.ListTasksResponse;, +import org.elasticsearch.test.ESSingleNodeTestCase;, +import org.elasticsearch.threadpool.ThreadPool;, +import org.junit.After;, +import org.junit.Before;, +import java.util.concurrent.CyclicBarrier;, +import static org.elasticsearch.index.reindex.ReindexTestCase.matcher;, +import static org.hamcrest.Matchers.hasSize;, +public class RetryTests extends ESSingleNodeTestCase {, +    private static final int DOC_COUNT = 20;, +, +    private List<CyclicBarrier> blockedExecutors = new ArrayList<>();, +, +    @Override, +    protected Collection<Class<? extends Plugin>> getPlugins() {, +        return pluginList(ReindexPlugin.class);, +    }, +    protected Settings nodeSettings() {, +        Settings.Builder settings = Settings.builder().put(super.nodeSettings());, +        // Use pools of size 1 so we can block them, +        // Use queues of size 1 because size 0 is broken and because search requests need the queue to function, +        settings.put("threadpool.bulk.queue_size", 1);, +        settings.put("threadpool.search.queue_size", 1);, +    @Before, +    public void setupSourceIndex() throws Exception {, +        createIndex("source");, +            bulk.add(client().prepareIndex("source", "test").setSource("foo", "bar " + i));, +        client().admin().indices().prepareRefresh("source").get();, +    }, +, +    @After, +    public void forceUnblockAllExecutors() {, +        for (CyclicBarrier barrier: blockedExecutors) {, +            barrier.reset();, +        }, +    }, +, +    public void testReindex() throws Exception {, +        testCase(ReindexAction.NAME, ReindexAction.INSTANCE.newRequestBuilder(client()).source("source").destination("dest"),, +                matcher().created(DOC_COUNT));]