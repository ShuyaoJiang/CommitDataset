[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/routing/RoutingNodes.java, +import org.elasticsearch.cluster.metadata.IndexMetaData;, +        int totalNumberOfShards = 0;, +        // we need to recompute to take closed shards into account, +        for (IndexMetaData indexMetaData : metaData.indices().values()) {, +            if (indexMetaData.state() == IndexMetaData.State.OPEN) {, +                totalNumberOfShards += indexMetaData.totalNumberOfShards();, +            }, +        }, +        return totalNumberOfShards / nodesToShards.size();]