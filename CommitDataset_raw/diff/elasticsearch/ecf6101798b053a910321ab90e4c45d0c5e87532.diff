[+++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/ingest/InternalTemplateService.java, +                Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/ingest/InternalTemplateService.java, +                Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +            clusterService.add(scriptModule.getScriptService());, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +                ExecutableScript executableScript = scriptService.executable(script, ScriptContext.Standard.UPDATE, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                        ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/ScriptQueryBuilder.java, +        return new ScriptQuery(script, context.getScriptService(), context.lookup());, +        public ScriptQuery(Script script, ScriptService scriptService, SearchLookup searchLookup) {, +            this.searchScript = scriptService.search(searchLookup, script, ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/TemplateQueryBuilder.java, +            ScriptContext.Standard.SEARCH, Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScriptScoreFunctionBuilder.java, +                    Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/ingest/InternalTemplateService.java, +                Collections.emptyMap());, +++ b/core/src/main/java/org/elasticsearch/node/Node.java, +            clusterService.add(scriptModule.getScriptService());, +++ b/core/src/main/java/org/elasticsearch/script/ScriptService.java, +import org.elasticsearch.cluster.ClusterChangedEvent;, +import org.elasticsearch.cluster.ClusterStateListener;, +public class ScriptService extends AbstractComponent implements Closeable, ClusterStateListener {, +    private ClusterState clusterState;, +, +    public CompiledScript compile(Script script, ScriptContext scriptContext, Map<String, String> params) {, +        return compileInternal(script, params);, +    CompiledScript compileInternal(Script script, Map<String, String> params) {, +            code = getScriptFromClusterState(indexedScript.lang, indexedScript.id);, +    String getScriptFromClusterState(String scriptLang, String id) {, +        ScriptMetaData scriptMetadata = clusterState.metaData().custom(ScriptMetaData.TYPE);, +    public ExecutableScript executable(Script script, ScriptContext scriptContext, Map<String, String> params) {, +        return executable(compile(script, scriptContext, params), script.getParams());, +    public SearchScript search(SearchLookup lookup, Script script, ScriptContext scriptContext, Map<String, String> params) {, +        CompiledScript compiledScript = compile(script, scriptContext, params);, +    @Override, +    public void clusterChanged(ClusterChangedEvent event) {]