[+++ b/core/src/main/java/org/elasticsearch/search/internal/DefaultSearchContext.java, +        }, +, +        if (typesFilter == null && aliasFilter == null && hasNestedFields == false) {, +, +        } else if (hasNestedFields) {, +            bq.add(Queries.newNonNestedFilter(), Occur.FILTER);, +++ b/core/src/main/java/org/elasticsearch/search/internal/DefaultSearchContext.java, +        }, +, +        if (typesFilter == null && aliasFilter == null && hasNestedFields == false) {, +, +        } else if (hasNestedFields) {, +            bq.add(Queries.newNonNestedFilter(), Occur.FILTER);, +++ b/core/src/test/java/org/elasticsearch/search/internal/DefaultSearchContextTests.java, +        searchFilter = DefaultSearchContext.createSearchFilter(null, new MatchAllDocsQuery(), true);, +        expectedQuery = new BooleanQuery.Builder(), +            .add(new MatchAllDocsQuery(), FILTER), +            .add(Queries.newNonNestedFilter(), FILTER), +            .build();, +        assertThat(searchFilter, equalTo(expectedQuery));, +, +        searchFilter = DefaultSearchContext.createSearchFilter(null, new MatchAllDocsQuery(), false);, +        expectedQuery = new BooleanQuery.Builder(), +            .add(new MatchAllDocsQuery(), FILTER), +            .build();]