[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/DocsTestPlugin.groovy, +import org.elasticsearch.gradle.VersionProperties, +        Map<String, String> defaultSubstitutions = [, +            /* These match up with the asciidoc syntax for substitutions but, +             * the values may differ. In particular {version} needs to resolve, +             * to the version being built for testing but needs to resolve to, +             * the last released version for docs. */, +            '\\{version\\}':, +                VersionProperties.elasticsearch.replace('-SNAPSHOT', ''),, +            '\\{lucene_version\\}' : VersionProperties.lucene,, +        ], +        listSnippets.defaultSubstitutions = defaultSubstitutions, +        listConsoleCandidates.defaultSubstitutions = defaultSubstitutions, +            if (    // js almost always should be `// CONSOLE`, +                    it.language == 'js' ||, +                    // snippets containing `curl` *probably* should, +                    // be `// CONSOLE`, +                    it.curl) {, +        }, +        Task buildRestTests = project.tasks.create(, +                'buildRestTests', RestTestsFromSnippetsTask), +        buildRestTests.defaultSubstitutions = defaultSubstitutions, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/DocsTestPlugin.groovy, +import org.elasticsearch.gradle.VersionProperties, +        Map<String, String> defaultSubstitutions = [, +            /* These match up with the asciidoc syntax for substitutions but, +             * the values may differ. In particular {version} needs to resolve, +             * to the version being built for testing but needs to resolve to, +             * the last released version for docs. */, +            '\\{version\\}':, +                VersionProperties.elasticsearch.replace('-SNAPSHOT', ''),, +            '\\{lucene_version\\}' : VersionProperties.lucene,, +        ], +        listSnippets.defaultSubstitutions = defaultSubstitutions, +        listConsoleCandidates.defaultSubstitutions = defaultSubstitutions, +            if (    // js almost always should be `// CONSOLE`, +                    it.language == 'js' ||, +                    // snippets containing `curl` *probably* should, +                    // be `// CONSOLE`, +                    it.curl) {, +        }, +        Task buildRestTests = project.tasks.create(, +                'buildRestTests', RestTestsFromSnippetsTask), +        buildRestTests.defaultSubstitutions = defaultSubstitutions, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/RestTestsFromSnippetsTask.groovy, +            if (path == null) {, +                path = '' // Catch requests to the root..., +            }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/DocsTestPlugin.groovy, +import org.elasticsearch.gradle.VersionProperties, +        Map<String, String> defaultSubstitutions = [, +            /* These match up with the asciidoc syntax for substitutions but, +             * the values may differ. In particular {version} needs to resolve, +             * to the version being built for testing but needs to resolve to, +             * the last released version for docs. */, +            '\\{version\\}':, +                VersionProperties.elasticsearch.replace('-SNAPSHOT', ''),, +            '\\{lucene_version\\}' : VersionProperties.lucene,, +        ], +        listSnippets.defaultSubstitutions = defaultSubstitutions, +        listConsoleCandidates.defaultSubstitutions = defaultSubstitutions, +            if (    // js almost always should be `// CONSOLE`, +                    it.language == 'js' ||, +                    // snippets containing `curl` *probably* should, +                    // be `// CONSOLE`, +                    it.curl) {, +        }, +        Task buildRestTests = project.tasks.create(, +                'buildRestTests', RestTestsFromSnippetsTask), +        buildRestTests.defaultSubstitutions = defaultSubstitutions, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/RestTestsFromSnippetsTask.groovy, +            if (path == null) {, +                path = '' // Catch requests to the root..., +            }, +++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/doc/SnippetsTask.groovy, +import org.gradle.api.tasks.Input, +    /**, +     * Substitutions done on every snippet's contents., +     */, +    @Input, +    Map<String, String> defaultSubstitutions = [:], +, +                Closure doSubstitution = { String pattern, String subst ->, +                defaultSubstitutions.each doSubstitution, +                if (substitutions != null) {, +                    substitutions.each doSubstitution, +                if (snippet.language == null) {, +                    throw new InvalidUserDataException("$snippet: ", +                        + "Snippet missing a language. This is required by ", +                        + "Elasticsearch's doc testing infrastructure so we ", +                        + "be sure we don't accidentally forget to test a ", +                        + "snippet."), +                }, +                // Try to detect snippets that contain `curl`, +                if (snippet.language == 'sh' || snippet.language == 'shell') {, +                    snippet.curl = snippet.contents.contains('curl'), +                    if (snippet.console == false && snippet.curl == false) {, +                        throw new InvalidUserDataException("$snippet: ", +                            + "No need for NOTCONSOLE if snippet doesn't ", +                            + "contain `curl`.")]