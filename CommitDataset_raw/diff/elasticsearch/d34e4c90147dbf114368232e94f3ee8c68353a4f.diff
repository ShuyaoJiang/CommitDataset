[+++ b/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/RecoveryIT.java, +import org.apache.http.util.EntityUtils;, +        final int actualDocs;, +        try {, +            if (preference != null) {, +            final Response response = client().performRequest(request);, +            actualDocs = Integer.parseInt(ObjectPath.createFromResponse(response).evaluate("count").toString());, +        } catch (ResponseException e) {, +            try {, +                final Response recoveryStateResponse = client().performRequest(new Request("GET", index + "/_recovery"));, +                fail("failed to get doc count for index [" + index + "] with preference [" + preference + "]" + " response [" + e + "]", +                    + " recovery [" + EntityUtils.toString(recoveryStateResponse.getEntity()) + "]");, +            } catch (Exception inner) {, +                e.addSuppressed(inner);, +            }, +            throw e;, +        }, +        assertThat("preference [" + preference + "]", actualDocs, equalTo(expectedCount));, +    }]