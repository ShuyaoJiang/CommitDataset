[+++ b/test/framework/src/main/java/org/elasticsearch/test/transport/CapturingTransport.java, +/**, + * A transport class that doesn't send anything but rather captures all requests for inspection from tests, + */, +    private final Object requestHandlerMutex = new Object();, +        CapturedRequest(DiscoveryNode node, long requestId, String action, TransportRequest request) {, +        connectionManager.setDefaultNodeConnectedBehavior((cm, discoveryNode) -> nodeConnected(discoveryNode));, +        connectionManager.setDefaultConnectBehavior((cm, discoveryNode) -> openConnection(discoveryNode, null));, +    /**, +     * returns all requests captured so far. Doesn't clear the captured request list. See {@link #clear()}, +     */, +    /**, +     * clears captured requests, +     */, +    /**, +     * simulate a response for the given requestId, +     */, +                onSendRequest(requestId, action, request, node);, +    protected void onSendRequest(long requestId, String action, TransportRequest request, DiscoveryNode node) {, +        requests.put(requestId, Tuple.tuple(node, action));, +        capturedRequests.add(new CapturedRequest(node, requestId, action, request));, +    }, +, +    protected boolean nodeConnected(DiscoveryNode discoveryNode) {, +        return true;, +    }, +, +    public TransportAddress[] addressesFromString(String address, int perAddressLimit) {, +    public void start() {, +    }, +    public void stop() {, +    }, +    public void close() {, +    }, +]