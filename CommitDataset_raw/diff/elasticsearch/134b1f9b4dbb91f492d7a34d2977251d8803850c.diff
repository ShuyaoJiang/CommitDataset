[+++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                SearchScript searchScript = innerHitsContext.scriptService().search(innerHitsContext.lookup(), field.script(),, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                SearchScript searchScript = innerHitsContext.scriptService().search(innerHitsContext.lookup(), field.script(),, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +     * Returns a script service to fetch scripts., +     */, +    public final ScriptService getScriptService() {, +        return scriptService;, +    }, +, +    /**, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java, +                        ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/LegacyDateFieldMapper.java, +                    ? context.nowInMillis(), +++ b/core/src/main/java/org/elasticsearch/index/mapper/TTLFieldMapper.java, +                now = searchContext.nowInMillis();, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +                SearchScript searchScript = innerHitsContext.scriptService().search(innerHitsContext.lookup(), field.script(),, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryRewriteContext.java, +     * Returns a script service to fetch scripts., +     */, +    public final ScriptService getScriptService() {, +        return scriptService;, +    }, +, +    /**, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryShardContext.java, +                             IndexReader reader, ClusterState clusterState) {, +                source.reader, source.clusterState);, +        SearchContext current = SearchContext.current();, +        if (current != null) {, +            return current.nowInMillis();, +        }, +        return System.currentTimeMillis();, +++ b/core/src/main/java/org/elasticsearch/index/IndexService.java, +    public QueryShardContext newQueryShardContext(IndexReader indexReader) {, +                nodeServicesProvider.getClusterService().state(), +        );, +        return newQueryShardContext(null);]