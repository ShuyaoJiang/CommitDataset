[+++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/tophits/InternalTopHits.java, +import org.apache.lucene.search.FieldDoc;, +import java.util.Arrays;, +    TopDocs getTopDocs() {, +        return topDocs;, +    }, +, +    int getSize() {, +        return size;, +    }, +, +, +    // Equals and hashcode implemented for testing round trips, +    @Override, +    protected boolean doEquals(Object obj) {, +        InternalTopHits other = (InternalTopHits) obj;, +        if (from != other.from) return false;, +        if (size != other.size) return false;, +        if (topDocs.totalHits != other.topDocs.totalHits) return false;, +        if (topDocs.scoreDocs.length != other.topDocs.scoreDocs.length) return false;, +        for (int d = 0; d < topDocs.scoreDocs.length; d++) {, +            ScoreDoc thisDoc = topDocs.scoreDocs[d];, +            ScoreDoc otherDoc = other.topDocs.scoreDocs[d];, +            if (thisDoc.doc != otherDoc.doc) return false;, +            if (thisDoc.score != otherDoc.score) return false;, +            if (thisDoc.shardIndex != otherDoc.shardIndex) return false;, +            if (thisDoc instanceof FieldDoc) {, +                if (false == (otherDoc instanceof FieldDoc)) return false;, +                FieldDoc thisFieldDoc = (FieldDoc) thisDoc;, +                FieldDoc otherFieldDoc = (FieldDoc) otherDoc;, +                if (thisFieldDoc.fields.length != otherFieldDoc.fields.length) return false;, +                for (int f = 0; f < thisFieldDoc.fields.length; f++) {, +                    if (false == thisFieldDoc.fields[f].equals(otherFieldDoc.fields[f])) return false;, +                }, +            }, +        }, +        return searchHits.equals(other.searchHits);, +    }, +, +    @Override, +    protected int doHashCode() {, +        int hashCode = from;, +        hashCode = 31 * hashCode + size;, +        hashCode = 31 * hashCode + topDocs.totalHits;, +        for (int d = 0; d < topDocs.scoreDocs.length; d++) {, +            ScoreDoc doc = topDocs.scoreDocs[d];, +            hashCode = 31 * hashCode + doc.doc;, +            hashCode = 31 * hashCode + Float.floatToIntBits(doc.score);, +            hashCode = 31 * hashCode + doc.shardIndex;, +            if (doc instanceof FieldDoc) {, +                FieldDoc fieldDoc = (FieldDoc) doc;, +                hashCode = 31 * hashCode + Arrays.hashCode(fieldDoc.fields);, +            }, +        }, +        hashCode = 31 * hashCode + searchHits.hashCode();, +        return hashCode;, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/tophits/InternalTopHits.java, +import org.apache.lucene.search.FieldDoc;, +import java.util.Arrays;, +    TopDocs getTopDocs() {, +        return topDocs;, +    }, +, +    int getSize() {, +        return size;, +    }, +, +, +    // Equals and hashcode implemented for testing round trips, +    @Override, +    protected boolean doEquals(Object obj) {, +        InternalTopHits other = (InternalTopHits) obj;, +        if (from != other.from) return false;, +        if (size != other.size) return false;, +        if (topDocs.totalHits != other.topDocs.totalHits) return false;, +        if (topDocs.scoreDocs.length != other.topDocs.scoreDocs.length) return false;, +        for (int d = 0; d < topDocs.scoreDocs.length; d++) {, +            ScoreDoc thisDoc = topDocs.scoreDocs[d];, +            ScoreDoc otherDoc = other.topDocs.scoreDocs[d];, +            if (thisDoc.doc != otherDoc.doc) return false;, +            if (thisDoc.score != otherDoc.score) return false;, +            if (thisDoc.shardIndex != otherDoc.shardIndex) return false;, +            if (thisDoc instanceof FieldDoc) {, +                if (false == (otherDoc instanceof FieldDoc)) return false;, +                FieldDoc thisFieldDoc = (FieldDoc) thisDoc;, +                FieldDoc otherFieldDoc = (FieldDoc) otherDoc;, +                if (thisFieldDoc.fields.length != otherFieldDoc.fields.length) return false;, +                for (int f = 0; f < thisFieldDoc.fields.length; f++) {, +                    if (false == thisFieldDoc.fields[f].equals(otherFieldDoc.fields[f])) return false;, +                }, +            }, +        }, +        return searchHits.equals(other.searchHits);, +    }, +, +    @Override, +    protected int doHashCode() {, +        int hashCode = from;, +        hashCode = 31 * hashCode + size;]