[+++ b/TESTING.asciidoc, +To run backwards compatibilty tests untar or unzip a release and run the tests, +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.bwc.path=/path/to/elasticsearch -Dtests.security.manager=false, +Note that backwards tests must be run with security manager disabled., +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.security.manager=false, +++ b/TESTING.asciidoc, +To run backwards compatibilty tests untar or unzip a release and run the tests, +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.bwc.path=/path/to/elasticsearch -Dtests.security.manager=false, +Note that backwards tests must be run with security manager disabled., +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.security.manager=false, +++ b/pom.xml, +        <lucene.snapshot.revision>1678978</lucene.snapshot.revision>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase$*.class</include>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +++ b/TESTING.asciidoc, +To run backwards compatibilty tests untar or unzip a release and run the tests, +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.bwc.path=/path/to/elasticsearch -Dtests.security.manager=false, +Note that backwards tests must be run with security manager disabled., +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.security.manager=false, +++ b/pom.xml, +        <lucene.snapshot.revision>1678978</lucene.snapshot.revision>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase$*.class</include>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +++ b/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java, +    private volatile Node node;, +                    if (node != null) {, +                }, +        , +        NodeBuilder nodeBuilder = NodeBuilder.nodeBuilder().settings(settings).loadConfigSettings(false);, +        node = nodeBuilder.build();, +++ b/TESTING.asciidoc, +To run backwards compatibilty tests untar or unzip a release and run the tests, +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.bwc.path=/path/to/elasticsearch -Dtests.security.manager=false, +Note that backwards tests must be run with security manager disabled., +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.security.manager=false, +++ b/pom.xml, +        <lucene.snapshot.revision>1678978</lucene.snapshot.revision>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase$*.class</include>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +++ b/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java, +    private volatile Node node;, +                    if (node != null) {, +                }, +        , +        NodeBuilder nodeBuilder = NodeBuilder.nodeBuilder().settings(settings).loadConfigSettings(false);, +        node = nodeBuilder.build();, +++ b/src/main/java/org/elasticsearch/bootstrap/Security.java, +import java.nio.file.AccessMode;, +import java.nio.file.FileAlreadyExistsException;, +import java.nio.file.NotDirectoryException;, +class Security {, +    static void addPath(Permissions policy, Path path, String permissions) throws IOException {, +        ensureDirectoryExists(path);, +, +    /**, +     * Ensures configured directory {@code path} exists., +     * @throws IOException if {@code path} exists, but is not a directory, not accessible, or broken symbolic link., +     */, +    static void ensureDirectoryExists(Path path) throws IOException {, +        // this isn't atomic, but neither is createDirectories., +        if (Files.isDirectory(path)) {, +            // verify access, following links (throws exception if something is wrong), +            // we only check READ as a sanity test, +            path.getFileSystem().provider().checkAccess(path.toRealPath(), AccessMode.READ);, +        } else {, +            // doesn't exist, or not a directory, +            try {, +                Files.createDirectories(path);, +            } catch (FileAlreadyExistsException e) {, +                // convert optional specific exception so the context is clear, +                IOException e2 = new NotDirectoryException(path.toString());, +                e2.addSuppressed(e);, +                throw e2;, +            }, +        }, +    }, +, +    static void selfTest() throws IOException {, +            Path p = Files.createTempFile(null, null);, +            try {, +                Files.delete(p);, +            }, +++ b/TESTING.asciidoc, +To run backwards compatibilty tests untar or unzip a release and run the tests, +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.bwc.path=/path/to/elasticsearch -Dtests.security.manager=false, +Note that backwards tests must be run with security manager disabled., +mvn test -Dtests.filter="@backwards" -Dtests.bwc.version=x.y.z -Dtests.security.manager=false, +++ b/pom.xml, +        <lucene.snapshot.revision>1678978</lucene.snapshot.revision>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase.class</include>, +                                <include>org/elasticsearch/common/cli/CliToolTestCase$*.class</include>, +                                <include>org/elasticsearch/bootstrap/BootstrapForTesting.class</include>, +++ b/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java]