[+++ b/plugins/mapper-attachments/src/main/java/org/elasticsearch/mapper/attachments/AttachmentMapper.java, +        builder.startObject(simpleName());, +++ b/plugins/mapper-attachments/src/main/java/org/elasticsearch/mapper/attachments/AttachmentMapper.java, +        builder.startObject(simpleName());, +++ b/plugins/mapper-attachments/src/test/java/org/elasticsearch/mapper/attachments/SimpleAttachmentMapperTests.java, +import org.elasticsearch.common.compress.CompressedXContent;, +import org.elasticsearch.common.xcontent.XContentBuilder;, +import org.elasticsearch.index.mapper.MapperService;, +import org.junit.Test;, +    /**, +     * See issue https://github.com/elastic/elasticsearch-mapper-attachments/issues/169, +     * Mapping should not contain field names with dot., +     */, +    public void testMapperErrorWithDotTwoLevels169() throws Exception {, +        XContentBuilder mappingBuilder = jsonBuilder();, +        mappingBuilder.startObject(), +                .startObject("mail"), +                .startObject("properties"), +                .startObject("attachments"), +                .startObject("properties"), +                .startObject("innerfield"), +                .field("type", "attachment"), +                .endObject(), +                .endObject(), +                .endObject(), +                .endObject(), +                .endObject();, +, +        byte[] mapping = mappingBuilder.bytes().toBytes();, +        MapperService mapperService = MapperTestUtils.newMapperService(createTempDir(), Settings.EMPTY);, +        DocumentMapper docMapper = mapperService.parse("mail", new CompressedXContent(mapping), true);, +        // this should not throw an exception, +        mapperService.parse("mail", new CompressedXContent(docMapper.mapping().toString()), true);, +        // the mapping may not contain a field name with a dot, +        assertFalse(docMapper.mapping().toString().contains("."));, +    }, +]