[+++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/IndexQueryParserService.java, +            return new ParsedQuery(filter, context.copyNamedQueries());, +            return new ParsedQuery(query, parseContext.copyNamedQueries());, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/IndexQueryParserService.java, +            return new ParsedQuery(filter, context.copyNamedQueries());, +            return new ParsedQuery(query, parseContext.copyNamedQueries());, +++ b/core/src/main/java/org/elasticsearch/index/query/NestedQueryParser.java, +                ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +                InnerHitsContext.NestedInnerHits nestedInnerHits = new InnerHitsContext.NestedInnerHits(innerHits.v2(), parsedQuery, null, getParentObjectMapper(), nestedObjectMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/IndexQueryParserService.java, +            return new ParsedQuery(filter, context.copyNamedQueries());, +            return new ParsedQuery(query, parseContext.copyNamedQueries());, +++ b/core/src/main/java/org/elasticsearch/index/query/NestedQueryParser.java, +                ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +                InnerHitsContext.NestedInnerHits nestedInnerHits = new InnerHitsContext.NestedInnerHits(innerHits.v2(), parsedQuery, null, getParentObjectMapper(), nestedObjectMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryParseContext.java, +    public ImmutableMap<String, Query> copyNamedQueries() {, +    public void combineNamedQueries(QueryParseContext context) {, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/IndexQueryParserService.java, +            return new ParsedQuery(filter, context.copyNamedQueries());, +            return new ParsedQuery(query, parseContext.copyNamedQueries());, +++ b/core/src/main/java/org/elasticsearch/index/query/NestedQueryParser.java, +                ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +                InnerHitsContext.NestedInnerHits nestedInnerHits = new InnerHitsContext.NestedInnerHits(innerHits.v2(), parsedQuery, null, getParentObjectMapper(), nestedObjectMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryParseContext.java, +    public ImmutableMap<String, Query> copyNamedQueries() {, +    public void combineNamedQueries(QueryParseContext context) {, +++ b/core/src/main/java/org/elasticsearch/index/query/WrapperQueryParser.java, +            parseContext.combineNamedQueries(context);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/IndexQueryParserService.java, +            return new ParsedQuery(filter, context.copyNamedQueries());, +            return new ParsedQuery(query, parseContext.copyNamedQueries());, +++ b/core/src/main/java/org/elasticsearch/index/query/NestedQueryParser.java, +                ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +                InnerHitsContext.NestedInnerHits nestedInnerHits = new InnerHitsContext.NestedInnerHits(innerHits.v2(), parsedQuery, null, getParentObjectMapper(), nestedObjectMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/QueryParseContext.java, +    public ImmutableMap<String, Query> copyNamedQueries() {, +    public void combineNamedQueries(QueryParseContext context) {, +++ b/core/src/main/java/org/elasticsearch/index/query/WrapperQueryParser.java, +            parseContext.combineNamedQueries(context);, +++ b/core/src/main/java/org/elasticsearch/search/fetch/innerhits/InnerHitsContext.java, +import org.apache.lucene.search.*;, +        protected final ParsedQuery query;, +        protected BaseInnerHits(SearchContext context, ParsedQuery query, Map<String, BaseInnerHits> childInnerHits) {, +            return query.query();, +            return query;, +        public NestedInnerHits(SearchContext context, ParsedQuery query, Map<String, BaseInnerHits> childInnerHits, ObjectMapper parentObjectMapper, ObjectMapper childObjectMapper) {, +            Query q = Queries.filtered(query.query(), new NestedChildrenQuery(parentFilter, childFilter, hitContext));, +        public ParentChildInnerHits(SearchContext context, ParsedQuery query, Map<String, BaseInnerHits> childInnerHits, MapperService mapperService, DocumentMapper documentMapper) {, +            q.add(query.query(), Occur.MUST);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasChildQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), childDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/HasParentQueryParser.java, +            ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());, +            InnerHitsContext.ParentChildInnerHits parentChildInnerHits = new InnerHitsContext.ParentChildInnerHits(innerHits.v2(), parsedQuery, null, parseContext.mapperService(), parentDocMapper);, +++ b/core/src/main/java/org/elasticsearch/index/query/IndexQueryParserService.java, +            return new ParsedQuery(filter, context.copyNamedQueries());, +            return new ParsedQuery(query, parseContext.copyNamedQueries());, +++ b/core/src/main/java/org/elasticsearch/index/query/NestedQueryParser.java, +                ParsedQuery parsedQuery = new ParsedQuery(innerQuery, parseContext.copyNamedQueries());]