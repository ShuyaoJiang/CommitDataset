[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +                        counter += indexRoutingTable.numberOfNodesShardsAreAllocatedOn(clusterState.nodes().masterNodeId());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +                        counter += indexRoutingTable.numberOfNodesShardsAreAllocatedOn(clusterState.nodes().masterNodeId());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/routing/IndexRoutingTable.java, +    public int numberOfNodesShardsAreAllocatedOn(String... excludedNodes) {, +                    String currentNodeId = shardRouting.currentNodeId();, +                    boolean excluded = false;, +                    if (excludedNodes != null) {, +                        for (String excludedNode : excludedNodes) {, +                            if (currentNodeId.equals(excludedNode)) {, +                                excluded = true;, +                                break;, +                            }, +                        }, +                    }, +                    if (!excluded) {, +                        nodes.add(currentNodeId);, +                    }]