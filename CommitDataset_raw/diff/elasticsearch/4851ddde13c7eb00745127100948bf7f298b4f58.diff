[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facets/FacetsPhase.java, +                    // if we already have the doc id set, then use idset since its faster, +                    if (context.searcher().docIdSet() != null || contextFacets.queryType() == SearchContextFacets.QueryExecutionType.IDSET) {, +                    } else if (contextFacets.queryType() == SearchContextFacets.QueryExecutionType.COLLECT) {, +                        count = executeQueryCollectorCount(context, queryFacet, facetFilter);]