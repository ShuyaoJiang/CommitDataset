[+++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchInputIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchInputIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchTransformIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchInputIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchTransformIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/smoke-test-watcher-with-mustache/src/test/java/org/elasticsearch/smoketest/WatcherTemplateTests.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +        engine = new DefaultTextTemplateEngine(Settings.EMPTY, ScriptServiceProxy.of(scriptService, clusterService));, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchInputIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchTransformIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/smoke-test-watcher-with-mustache/src/test/java/org/elasticsearch/smoketest/WatcherTemplateTests.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +        engine = new DefaultTextTemplateEngine(Settings.EMPTY, ScriptServiceProxy.of(scriptService, clusterService));, +++ b/elasticsearch/x-pack/src/main/java/org/elasticsearch/xpack/common/ScriptServiceProxy.java, +    private final ClusterService clusterService;, +    public ScriptServiceProxy(ScriptService service, SecurityContext securityContext, ClusterService clusterService) {, +        this.clusterService = clusterService;, +                service.compile(script, WatcherScriptContext.CTX, compileParams, clusterService.state()));, +    public static ScriptServiceProxy of(ScriptService service, ClusterService clusterService) {, +        return new ScriptServiceProxy(service, SecurityContext.Insecure.INSTANCE, clusterService);, +++ b/elasticsearch/qa/messy-test-watcher-with-groovy/src/test/java/org/elasticsearch/messy/tests/MessyTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchInputIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/messy-test-xpack-with-mustache/src/test/java/org/elasticsearch/messy/tests/SearchTransformIT.java, +                ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class, master), internalCluster().clusterService(master)),, +        return ScriptServiceProxy.of(internalCluster().getInstance(ScriptService.class), internalCluster().clusterService());, +++ b/elasticsearch/qa/smoke-test-watcher-with-mustache/src/test/java/org/elasticsearch/smoketest/WatcherTemplateTests.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +        engine = new DefaultTextTemplateEngine(Settings.EMPTY, ScriptServiceProxy.of(scriptService, clusterService));, +++ b/elasticsearch/x-pack/src/main/java/org/elasticsearch/xpack/common/ScriptServiceProxy.java, +    private final ClusterService clusterService;, +    public ScriptServiceProxy(ScriptService service, SecurityContext securityContext, ClusterService clusterService) {, +        this.clusterService = clusterService;, +                service.compile(script, WatcherScriptContext.CTX, compileParams, clusterService.state()));, +    public static ScriptServiceProxy of(ScriptService service, ClusterService clusterService) {, +        return new ScriptServiceProxy(service, SecurityContext.Insecure.INSTANCE, clusterService);, +++ b/elasticsearch/x-pack/watcher/src/test/java/org/elasticsearch/xpack/watcher/test/WatcherTestUtils.java, +        ClusterService clusterService = Mockito.mock(ClusterService.class);, +        Mockito.when(clusterService.state()).thenReturn(ClusterState.builder(new ClusterName("_name")).build());, +                new ResourceWatcherService(settings, tp), scriptEngineRegistry, scriptContextRegistry, scriptSettings),, +                clusterService);, +, +    public static boolean areJsonEquivalent(String json1, String json2) throws IOException {, +        XContentParser parser1 = XContentHelper.createParser(new BytesArray(json1.getBytes(StandardCharsets.UTF_8)));, +        XContentParser parser2 = XContentHelper.createParser(new BytesArray(json2.getBytes(StandardCharsets.UTF_8)));, +        Map<String, Object> map1 = parser1.map();, +        Map<String, Object> map2 = parser2.map();, +        return map1.equals(map2);, +    }]