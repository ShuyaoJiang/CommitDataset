[+++ b/core/src/main/java/org/elasticsearch/action/ingest/IngestProxyActionFilter.java, +import org.elasticsearch.cluster.node.DiscoveryNodes;, +        DiscoveryNodes nodes = clusterService.state().getNodes();, +        DiscoveryNode[] ingestNodes = nodes.getIngestNodes().values().toArray(DiscoveryNode.class);, +++ b/core/src/main/java/org/elasticsearch/action/ingest/IngestProxyActionFilter.java, +import org.elasticsearch.cluster.node.DiscoveryNodes;, +        DiscoveryNodes nodes = clusterService.state().getNodes();, +        DiscoveryNode[] ingestNodes = nodes.getIngestNodes().values().toArray(DiscoveryNode.class);, +++ b/core/src/test/java/org/elasticsearch/action/ingest/IngestProxyActionFilterTests.java, +import org.elasticsearch.cluster.ClusterName;, +        ClusterState.Builder clusterState = new ClusterState.Builder(new ClusterName("_name"));, +        clusterState.nodes(builder);, +        when(clusterService.state()).thenReturn(clusterState.build());]