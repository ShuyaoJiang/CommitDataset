[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +    public ScriptFieldsFunction(String scriptLang, String script, ScriptService scriptService, MapperService mapperService, FieldDataCache fieldDataCache) {, +        this.script = scriptService.compile(scriptLang, script);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +    public ScriptFieldsFunction(String scriptLang, String script, ScriptService scriptService, MapperService mapperService, FieldDataCache fieldDataCache) {, +        this.script = scriptService.compile(scriptLang, script);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +                new ScriptScoreFunction(new ScriptFieldsFunction(scriptLang, script, parseContext.scriptService(), parseContext.mapperService(), parseContext.indexCache().fieldData()), vars));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +    public ScriptFieldsFunction(String scriptLang, String script, ScriptService scriptService, MapperService mapperService, FieldDataCache fieldDataCache) {, +        this.script = scriptService.compile(scriptLang, script);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +                new ScriptScoreFunction(new ScriptFieldsFunction(scriptLang, script, parseContext.scriptService(), parseContext.mapperService(), parseContext.indexCache().fieldData()), vars));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +        Filter filter = new ScriptFilter(scriptLang, script, params, parseContext.mapperService(), parseContext.indexCache().fieldData(), parseContext.scriptService());, +        private final String scriptLang;, +, +        private ScriptFilter(String scriptLang, String script, Map<String, Object> params,, +            this.scriptLang = scriptLang;, +            final ScriptFieldsFunction function = new ScriptFieldsFunction(scriptLang, script, scriptService, mapperService, fieldDataCache);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +    public ScriptFieldsFunction(String scriptLang, String script, ScriptService scriptService, MapperService mapperService, FieldDataCache fieldDataCache) {, +        this.script = scriptService.compile(scriptLang, script);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +                new ScriptScoreFunction(new ScriptFieldsFunction(scriptLang, script, parseContext.scriptService(), parseContext.mapperService(), parseContext.indexCache().fieldData()), vars));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +        Filter filter = new ScriptFilter(scriptLang, script, params, parseContext.mapperService(), parseContext.indexCache().fieldData(), parseContext.scriptService());, +        private final String scriptLang;, +, +        private ScriptFilter(String scriptLang, String script, Map<String, Object> params,, +            this.scriptLang = scriptLang;, +            final ScriptFieldsFunction function = new ScriptFieldsFunction(scriptLang, script, scriptService, mapperService, fieldDataCache);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/ScriptService.java, +        if (type == null) {, +            type = defaultType;, +        }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +    public ScriptFieldsFunction(String scriptLang, String script, ScriptService scriptService, MapperService mapperService, FieldDataCache fieldDataCache) {, +        this.script = scriptService.compile(scriptLang, script);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +                new ScriptScoreFunction(new ScriptFieldsFunction(scriptLang, script, parseContext.scriptService(), parseContext.mapperService(), parseContext.indexCache().fieldData()), vars));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +        Filter filter = new ScriptFilter(scriptLang, script, params, parseContext.mapperService(), parseContext.indexCache().fieldData(), parseContext.scriptService());, +        private final String scriptLang;, +, +        private ScriptFilter(String scriptLang, String script, Map<String, Object> params,, +            this.scriptLang = scriptLang;, +            final ScriptFieldsFunction function = new ScriptFieldsFunction(scriptLang, script, scriptService, mapperService, fieldDataCache);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/ScriptService.java, +        if (type == null) {, +            type = defaultType;, +        }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facets/geodistance/GeoDistanceFacetCollectorParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentName)) {, +                    scriptLang = parser.text();, +                    context, scriptLang, valueScript, params);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/field/function/script/ScriptFieldsFunction.java, +    public ScriptFieldsFunction(String scriptLang, String script, ScriptService scriptService, MapperService mapperService, FieldDataCache fieldDataCache) {, +        this.script = scriptService.compile(scriptLang, script);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +                new ScriptScoreFunction(new ScriptFieldsFunction(scriptLang, script, parseContext.scriptService(), parseContext.mapperService(), parseContext.indexCache().fieldData()), vars));, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +        String scriptLang = null;, +                } else if ("lang".equals(currentFieldName)) {, +                    scriptLang = parser.text();, +        Filter filter = new ScriptFilter(scriptLang, script, params, parseContext.mapperService(), parseContext.indexCache().fieldData(), parseContext.scriptService());, +        private final String scriptLang;, +, +        private ScriptFilter(String scriptLang, String script, Map<String, Object> params,, +            this.scriptLang = scriptLang;, +            final ScriptFieldsFunction function = new ScriptFieldsFunction(scriptLang, script, scriptService, mapperService, fieldDataCache);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/ScriptService.java, +        if (type == null) {, +            type = defaultType;, +        }]