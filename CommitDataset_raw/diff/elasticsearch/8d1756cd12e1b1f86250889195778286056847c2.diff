[+++ /dev/null, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/SecurityLifecycleService.java, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/SecurityLifecycleService.java, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/InternalRealms.java, +            securityLifecycleService.securityIndex().addIndexStateListener(nativeRealm::onSecurityIndexStateChange);, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/SecurityLifecycleService.java, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/InternalRealms.java, +            securityLifecycleService.securityIndex().addIndexStateListener(nativeRealm::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/NativeRealm.java, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isIndexDeleted;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isMoveFromRedToNonRed;, +    public void onSecurityIndexStateChange(SecurityIndexManager.State previousState, SecurityIndexManager.State currentState) {, +        if (isMoveFromRedToNonRed(previousState, currentState) || isIndexDeleted(previousState, currentState)) {, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/SecurityLifecycleService.java, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/InternalRealms.java, +            securityLifecycleService.securityIndex().addIndexStateListener(nativeRealm::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/NativeRealm.java, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isIndexDeleted;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isMoveFromRedToNonRed;, +    public void onSecurityIndexStateChange(SecurityIndexManager.State previousState, SecurityIndexManager.State currentState) {, +        if (isMoveFromRedToNonRed(previousState, currentState) || isIndexDeleted(previousState, currentState)) {, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/support/mapper/NativeRoleMappingStore.java, +import org.elasticsearch.cluster.health.ClusterHealthStatus;, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isIndexDeleted;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isMoveFromRedToNonRed;, +    public void onSecurityIndexStateChange(SecurityIndexManager.State previousState, SecurityIndexManager.State currentState) {, +        if (isMoveFromRedToNonRed(previousState, currentState) || isIndexDeleted(previousState, currentState) ||, +            previousState.isIndexUpToDate != currentState.isIndexUpToDate) {, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/SecurityLifecycleService.java, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/InternalRealms.java, +            securityLifecycleService.securityIndex().addIndexStateListener(nativeRealm::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/NativeRealm.java, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isIndexDeleted;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isMoveFromRedToNonRed;, +    public void onSecurityIndexStateChange(SecurityIndexManager.State previousState, SecurityIndexManager.State currentState) {, +        if (isMoveFromRedToNonRed(previousState, currentState) || isIndexDeleted(previousState, currentState)) {, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/support/mapper/NativeRoleMappingStore.java, +import org.elasticsearch.cluster.health.ClusterHealthStatus;, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isIndexDeleted;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isMoveFromRedToNonRed;, +    public void onSecurityIndexStateChange(SecurityIndexManager.State previousState, SecurityIndexManager.State currentState) {, +        if (isMoveFromRedToNonRed(previousState, currentState) || isIndexDeleted(previousState, currentState) ||, +            previousState.isIndexUpToDate != currentState.isIndexUpToDate) {, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/CompositeRolesStore.java, +import org.elasticsearch.cluster.health.ClusterHealthStatus;, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isIndexDeleted;, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.isMoveFromRedToNonRed;, +    public void onSecurityIndexStateChange(SecurityIndexManager.State previousState, SecurityIndexManager.State currentState) {, +        if (isMoveFromRedToNonRed(previousState, currentState) || isIndexDeleted(previousState, currentState) ||, +            previousState.isIndexUpToDate != currentState.isIndexUpToDate) {, +++ /dev/null, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java, +import static org.elasticsearch.xpack.security.support.SecurityIndexManager.SECURITY_TEMPLATE_NAME;, +        securityLifecycleService.securityIndex().addIndexStateListener(nativeRoleMappingStore::onSecurityIndexStateChange);, +        securityLifecycleService.securityIndex().addIndexStateListener(allRolesStore::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/SecurityLifecycleService.java, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/InternalRealms.java, +            securityLifecycleService.securityIndex().addIndexStateListener(nativeRealm::onSecurityIndexStateChange);, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/NativeRealm.java, +import org.elasticsearch.xpack.security.support.SecurityIndexManager;, +]