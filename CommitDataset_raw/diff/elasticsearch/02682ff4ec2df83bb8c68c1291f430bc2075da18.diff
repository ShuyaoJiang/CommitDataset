[+++ b/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequestHelper.java, +/*, + * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one, + * or more contributor license agreements. Licensed under the Elastic License;, + * you may not use this file except in compliance with the Elastic License., + */, +package org.elasticsearch.action.admin.indices.create;, +, +import org.elasticsearch.action.admin.indices.alias.Alias;, +, +import java.util.Set;, +, +/*, + * Helper needed to retrieve aliases from a CreateIndexRequest, as the corresponding getter has package private visibility, + * TODO Remove this class as soon as es core 1.5.0 is out, + */, +public final class CreateIndexRequestHelper {, +, +    private CreateIndexRequestHelper() {, +    }, +, +    public static Set<Alias> aliases(CreateIndexRequest createIndexRequest) {, +        return createIndexRequest.aliases();, +    }, +}, +++ b/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequestHelper.java, +/*, + * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one, + * or more contributor license agreements. Licensed under the Elastic License;, + * you may not use this file except in compliance with the Elastic License., + */, +package org.elasticsearch.action.admin.indices.create;, +, +import org.elasticsearch.action.admin.indices.alias.Alias;, +, +import java.util.Set;, +, +/*, + * Helper needed to retrieve aliases from a CreateIndexRequest, as the corresponding getter has package private visibility, + * TODO Remove this class as soon as es core 1.5.0 is out, + */, +public final class CreateIndexRequestHelper {, +, +    private CreateIndexRequestHelper() {, +    }, +, +    public static Set<Alias> aliases(CreateIndexRequest createIndexRequest) {, +        return createIndexRequest.aliases();, +    }, +}, +++ b/src/main/java/org/elasticsearch/shield/authz/InternalAuthorizationService.java, +import org.elasticsearch.action.admin.indices.alias.Alias;, +import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;, +import org.elasticsearch.action.admin.indices.create.CreateIndexRequestHelper;, +import org.elasticsearch.common.collect.Sets;, +        if (!authorizeIndices(action, indexNames, permission.indices())) {, +            throw denial(user, action, request);, +        }, +, +        //if we are creating an index we need to authorize potential aliases created at the same time, +        if (Privilege.Index.CREATE_INDEX.predicate().apply(action)) {, +            assert request instanceof CreateIndexRequest;, +            Set<Alias> aliases = CreateIndexRequestHelper.aliases((CreateIndexRequest) request);, +            if (!aliases.isEmpty()) {, +                Set<String> aliasesAndIndices = Sets.newHashSet(indexNames);, +                for (Alias alias : aliases) {, +                    aliasesAndIndices.add(alias.name());, +                }, +                if (!authorizeIndices("indices:admin/aliases", aliasesAndIndices, permission.indices())) {, +                    throw denial(user, "indices:admin/aliases", request);, +                }, +            }, +        }, +, +        grant(user, action, request);, +    }, +, +    private boolean authorizeIndices(String action, Set<String> requestIndices, Permission.Indices permission) {, +        for (String index : requestIndices) {, +            for (Permission.Indices.Group group : permission) {, +                return false;, +        return true;, +++ b/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequestHelper.java, +/*, + * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one, + * or more contributor license agreements. Licensed under the Elastic License;, + * you may not use this file except in compliance with the Elastic License., + */, +package org.elasticsearch.action.admin.indices.create;, +, +import org.elasticsearch.action.admin.indices.alias.Alias;, +, +import java.util.Set;, +, +/*, + * Helper needed to retrieve aliases from a CreateIndexRequest, as the corresponding getter has package private visibility, + * TODO Remove this class as soon as es core 1.5.0 is out, + */, +public final class CreateIndexRequestHelper {, +]