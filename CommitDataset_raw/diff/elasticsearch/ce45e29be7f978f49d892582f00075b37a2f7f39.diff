[+++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/ESSelector.java, +import java.util.stream.Collectors;, +        channelsToClose.addAll(selector.keys().stream().map(sk -> (NioChannel) sk.attachment()).collect(Collectors.toList()));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/ESSelector.java, +import java.util.stream.Collectors;, +        channelsToClose.addAll(selector.keys().stream().map(sk -> (NioChannel) sk.attachment()).collect(Collectors.toList()));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/SocketSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/ESSelector.java, +import java.util.stream.Collectors;, +        channelsToClose.addAll(selector.keys().stream().map(sk -> (NioChannel) sk.attachment()).collect(Collectors.toList()));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/SocketSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/channel/AbstractNioChannel.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/ESSelector.java, +import java.util.stream.Collectors;, +        channelsToClose.addAll(selector.keys().stream().map(sk -> (NioChannel) sk.attachment()).collect(Collectors.toList()));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/SocketSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/channel/AbstractNioChannel.java, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/AcceptingSelectorTests.java, +import java.util.Collections;, +    private Selector rawSelector;, +        rawSelector = mock(Selector.class);, +        TestSelectionKey key = new TestSelectionKey(0);, +        key.attach(serverChannel);, +        when(rawSelector.keys()).thenReturn(new HashSet<>(Collections.singletonList(key)));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/ESSelector.java, +import java.util.stream.Collectors;, +        channelsToClose.addAll(selector.keys().stream().map(sk -> (NioChannel) sk.attachment()).collect(Collectors.toList()));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/SocketSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/channel/AbstractNioChannel.java, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/AcceptingSelectorTests.java, +import java.util.Collections;, +    private Selector rawSelector;, +        rawSelector = mock(Selector.class);, +        TestSelectionKey key = new TestSelectionKey(0);, +        key.attach(serverChannel);, +        when(rawSelector.keys()).thenReturn(new HashSet<>(Collections.singletonList(key)));, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/ESSelectorTests.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/AcceptingSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/ESSelector.java, +import java.util.stream.Collectors;, +        channelsToClose.addAll(selector.keys().stream().map(sk -> (NioChannel) sk.attachment()).collect(Collectors.toList()));, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/SocketSelector.java, +++ b/test/framework/src/main/java/org/elasticsearch/transport/nio/channel/AbstractNioChannel.java, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/AcceptingSelectorTests.java, +import java.util.Collections;, +    private Selector rawSelector;, +        rawSelector = mock(Selector.class);, +        TestSelectionKey key = new TestSelectionKey(0);, +        key.attach(serverChannel);, +        when(rawSelector.keys()).thenReturn(new HashSet<>(Collections.singletonList(key)));, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/ESSelectorTests.java, +++ b/test/framework/src/test/java/org/elasticsearch/transport/nio/SocketSelectorTests.java, +import java.util.Collections;, +import java.util.HashSet;, +    private Selector rawSelector;, +        rawSelector = mock(Selector.class);, +        TestSelectionKey testSelectionKey = new TestSelectionKey(0);, +        testSelectionKey.attach(channel);, +        when(rawSelector.keys()).thenReturn(new HashSet<>(Collections.singletonList(testSelectionKey)));, +]