[+++ b/src/main/java/org/elasticsearch/index/fielddata/FieldData.java, +import org.apache.lucene.util.*;, +     * Given a {@link SortedNumericDoubleValues}, return a {@link SortedNumericDocValues}, +     * instance that will translate double values to sortable long bits using, +     * {@link NumericUtils#doubleToSortableLong(double)}., +     */, +    public static SortedNumericDocValues toSortableLongBits(SortedNumericDoubleValues values) {, +        final NumericDoubleValues singleton = unwrapSingleton(values);, +        if (singleton != null) {, +            final NumericDocValues longBits;, +            if (singleton instanceof SortableLongBitsToNumericDoubleValues) {, +                longBits = ((SortableLongBitsToNumericDoubleValues) singleton).getLongValues();, +            } else {, +                longBits = new SortableLongBitsNumericDocValues(singleton);, +            }, +            final Bits docsWithField = unwrapSingletonBits(values);, +            return DocValues.singleton(longBits, docsWithField);, +        } else {, +            if (values instanceof SortableLongBitsToSortedNumericDoubleValues) {, +                return ((SortableLongBitsToSortedNumericDoubleValues) values).getLongValues();, +            } else {, +                return new SortableLongBitsSortedNumericDocValues(values);, +            }, +        }, +    }, +, +    /**, +     * Given a {@link SortedNumericDocValues}, return a {@link SortedNumericDoubleValues}, +     * instance that will translate long values to doubles using, +     * {@link NumericUtils#sortableLongToDouble(long)}., +     */, +    public static SortedNumericDoubleValues sortableLongBitsToDoubles(SortedNumericDocValues values) {, +        final NumericDocValues singleton = DocValues.unwrapSingleton(values);, +        if (singleton != null) {, +            final NumericDoubleValues doubles;, +            if (singleton instanceof SortableLongBitsNumericDocValues) {, +                doubles = ((SortableLongBitsNumericDocValues) singleton).getDoubleValues();, +            } else {, +                doubles = new SortableLongBitsToNumericDoubleValues(singleton);, +            }, +            final Bits docsWithField = DocValues.unwrapSingletonBits(values);, +            return singleton(doubles, docsWithField);, +        } else {, +            if (values instanceof SortableLongBitsSortedNumericDocValues) {, +                return ((SortableLongBitsSortedNumericDocValues) values).getDoubleValues();, +            } else {, +                return new SortableLongBitsToSortedNumericDoubleValues(values);, +            }, +        }, +    }, +, +    /**, +++ b/src/main/java/org/elasticsearch/index/fielddata/FieldData.java, +import org.apache.lucene.util.*;, +     * Given a {@link SortedNumericDoubleValues}, return a {@link SortedNumericDocValues}, +     * instance that will translate double values to sortable long bits using, +     * {@link NumericUtils#doubleToSortableLong(double)}., +     */, +    public static SortedNumericDocValues toSortableLongBits(SortedNumericDoubleValues values) {, +        final NumericDoubleValues singleton = unwrapSingleton(values);, +        if (singleton != null) {, +            final NumericDocValues longBits;, +            if (singleton instanceof SortableLongBitsToNumericDoubleValues) {, +                longBits = ((SortableLongBitsToNumericDoubleValues) singleton).getLongValues();, +            } else {, +                longBits = new SortableLongBitsNumericDocValues(singleton);, +            }, +            final Bits docsWithField = unwrapSingletonBits(values);, +            return DocValues.singleton(longBits, docsWithField);, +        } else {, +            if (values instanceof SortableLongBitsToSortedNumericDoubleValues) {, +                return ((SortableLongBitsToSortedNumericDoubleValues) values).getLongValues();, +            } else {, +                return new SortableLongBitsSortedNumericDocValues(values);, +            }, +        }, +    }, +, +    /**, +     * Given a {@link SortedNumericDocValues}, return a {@link SortedNumericDoubleValues}, +     * instance that will translate long values to doubles using, +     * {@link NumericUtils#sortableLongToDouble(long)}., +     */, +    public static SortedNumericDoubleValues sortableLongBitsToDoubles(SortedNumericDocValues values) {, +        final NumericDocValues singleton = DocValues.unwrapSingleton(values);, +        if (singleton != null) {, +            final NumericDoubleValues doubles;, +            if (singleton instanceof SortableLongBitsNumericDocValues) {, +                doubles = ((SortableLongBitsNumericDocValues) singleton).getDoubleValues();, +            } else {, +                doubles = new SortableLongBitsToNumericDoubleValues(singleton);, +            }, +            final Bits docsWithField = DocValues.unwrapSingletonBits(values);, +            return singleton(doubles, docsWithField);, +        } else {, +            if (values instanceof SortableLongBitsSortedNumericDocValues) {, +                return ((SortableLongBitsSortedNumericDocValues) values).getDoubleValues();, +            } else {, +                return new SortableLongBitsToSortedNumericDoubleValues(values);, +            }]