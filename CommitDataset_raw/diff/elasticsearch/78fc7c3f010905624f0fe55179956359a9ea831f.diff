[+++ b/src/test/java/org/elasticsearch/env/NodeEnvironmentTests.java, +        final CountDownLatch blockLatch = new CountDownLatch(1);, +        final CountDownLatch start = new CountDownLatch(1);, +                    blockLatch.countDown();, +                    start.await();, +                    try (ShardLock _ = env.shardLock(new ShardId("foo", 1))) {, +                        blockLatch.countDown();, +                        Thread.sleep(randomIntBetween(1, 10));, +            blockLatch.countDown();, +        start.countDown();, +        blockLatch.await();]