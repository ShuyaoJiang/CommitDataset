[+++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = innerHitsContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataFieldsContext.FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = innerHitsContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataFieldsContext.FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +        registerFetchSubPhase(new FieldDataFieldsFetchSubPhase());, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = innerHitsContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataFieldsContext.FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +        registerFetchSubPhase(new FieldDataFieldsFetchSubPhase());, +++ b/core/src/main/java/org/elasticsearch/search/SearchService.java, +import org.elasticsearch.common.util.concurrent.FutureUtils;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext.FieldDataField;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = context.getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = innerHitsContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataFieldsContext.FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +        registerFetchSubPhase(new FieldDataFieldsFetchSubPhase());, +++ b/core/src/main/java/org/elasticsearch/search/SearchService.java, +import org.elasticsearch.common.util.concurrent.FutureUtils;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext.FieldDataField;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = context.getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/tophits/TopHitsAggregatorFactory.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext.FieldDataField;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +    private final List<String> fieldDataFields;, +            List<SortBuilder<?>> sorts, HighlightBuilder highlightBuilder, List<String> fieldNames, List<String> fieldDataFields,, +        this.fieldDataFields = fieldDataFields;, +        if (fieldDataFields != null) {, +            FieldDataFieldsContext fieldDataFieldsContext = subSearchContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +            for (String field : fieldDataFields) {, +                fieldDataFieldsContext.add(new FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/buildSrc/src/main/resources/checkstyle_suppressions.xml, +++ b/core/src/main/java/org/elasticsearch/index/query/InnerHitBuilder.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = innerHitsContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataFieldsContext.FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +        registerFetchSubPhase(new FieldDataFieldsFetchSubPhase());, +++ b/core/src/main/java/org/elasticsearch/search/SearchService.java, +import org.elasticsearch.common.util.concurrent.FutureUtils;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext.FieldDataField;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +            FieldDataFieldsContext fieldDataFieldsContext = context.getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);, +                fieldDataFieldsContext.add(new FieldDataField(field));, +            fieldDataFieldsContext.setHitExecutionNeeded(true);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/tophits/TopHitsAggregatorFactory.java, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsContext.FieldDataField;, +import org.elasticsearch.search.fetch.fielddata.FieldDataFieldsFetchSubPhase;, +    private final List<String> fieldDataFields;, +            List<SortBuilder<?>> sorts, HighlightBuilder highlightBuilder, List<String> fieldNames, List<String> fieldDataFields,, +        this.fieldDataFields = fieldDataFields;, +        if (fieldDataFields != null) {, +            FieldDataFieldsContext fieldDataFieldsContext = subSearchContext, +                    .getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);]