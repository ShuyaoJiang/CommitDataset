[+++ b/core/src/test/java/org/elasticsearch/discovery/DiscoveryWithServiceDisruptionsIT.java, +import org.elasticsearch.discovery.zen.PublishClusterStateAction;, +import org.elasticsearch.discovery.zen.UnicastZenPing;, +import org.elasticsearch.discovery.zen.ZenDiscovery;, +    @Before, +    public void setUp() throws Exception {, +        super.setUp();, +        disableBeforeIndexDeletion = false;, +    }, +, +++ b/core/src/test/java/org/elasticsearch/discovery/DiscoveryWithServiceDisruptionsIT.java, +import org.elasticsearch.discovery.zen.PublishClusterStateAction;, +import org.elasticsearch.discovery.zen.UnicastZenPing;, +import org.elasticsearch.discovery.zen.ZenDiscovery;, +    @Before, +    public void setUp() throws Exception {, +        super.setUp();, +        disableBeforeIndexDeletion = false;, +    }, +, +++ b/test/framework/src/main/java/org/elasticsearch/test/transport/MockTransportService.java, +import java.util.concurrent.LinkedBlockingDeque;, +            private final Queue<Runnable> requestsToSendWhenCleared = new LinkedBlockingDeque<Runnable>();, +            private boolean cleared = false;, +                synchronized (this) {, +                    if (cleared) {, +                        runnable.run();, +                    } else {, +                }, +            }, +                synchronized (this) {, +                    assert cleared == false;, +                    cleared = true;, +            }]