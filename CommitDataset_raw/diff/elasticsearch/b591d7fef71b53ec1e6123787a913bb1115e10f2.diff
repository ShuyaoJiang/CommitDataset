[+++ b/src/test/java/org/elasticsearch/search/child/SimpleChildQuerySearchTests.java, +                .addMapping("parent"), +                .addMapping("child", "_parent", "type=parent"), +                .addMapping("grandchild", "_parent", "type=child"), +                .get();, +        ensureGreen();, +        client().prepareIndex("test", "parent", "p1").setSource("p_field", "p_value1").get();, +        client().prepareIndex("test", "child", "c1").setSource("c_field", "c_value1").setParent("p1").get();, +        client().prepareIndex("test", "grandchild", "gc1").setSource("gc_field", "gc_value1"), +                .setParent("c1").setRouting("gc1").get();, +        refresh();, +                                                hasChildFilter("grandchild", termQuery("gc_field", "gc_value1")))))).get();, +                .addMapping("parent"), +                .addMapping("test", "_parent", "type=foo"), +                .get();, +        ensureGreen();, +        client().prepareIndex("test", "foo", "1").setSource("foo", 1).get();, +        client().prepareIndex("test", "test").setSource("foo", 1).setParent("1").get();, +        client().admin().indices().prepareRefresh().get();, +                .addMapping("parent"), +                .addMapping("child", "_parent", "type=parent"), +                .get();, +        ensureGreen();, +        client().prepareIndex("test", "parent", "p1").setSource("p_field", "p_value1").get();, +        client().prepareIndex("test", "child", "c1").setSource("c_field", "red").setParent("p1").get();, +        client().prepareIndex("test", "child", "c2").setSource("c_field", "yellow").setParent("p1").get();, +        client().prepareIndex("test", "parent", "p2").setSource("p_field", "p_value2").get();, +        client().prepareIndex("test", "child", "c3").setSource("c_field", "blue").setParent("p2").get();, +        client().prepareIndex("test", "child", "c4").setSource("c_field", "red").setParent("p2").get();, +        refresh();, +        searchResponse = client().prepareSearch("test").setQuery(termQuery("_parent", "p1")).addFields("_parent").get();, +        searchResponse = client().prepareSearch("test").setQuery(queryString("_parent:p1")).addFields("_parent").get();, +                .get();, +                .get();, +        searchResponse = client().prepareSearch("test").setQuery(randomHasChild("child", "c_field", "red")).get();, +                .setQuery(randomHasParent("parent", "p_field", "p_value2")).get();, +                .setQuery(randomHasParent("parent", "p_field", "p_value1")).get();, +                .addMapping("parent"), +                ).get();, +        ensureGreen();, +        client().prepareIndex("test", "parent", "p0").setSource("p_field", "p_value0").get();, +        client().prepareIndex("test", "parent", "p1").setSource("p_field", "p_value1").get();, +        refresh();, +                .prepareStats("test").setIdCache(true).get();, +        client().admin().indices().preparePutMapping("test").setType("child"), +                .setSource("_parent", "type=parent"), +                .get();, +        client().prepareIndex("test", "child", "c1").setSource("c_field", "red").setParent("p1").get();, +        client().prepareIndex("test", "child", "c2").setSource("c_field", "yellow").setParent("p1").get();, +        client().prepareIndex("test", "parent", "p2").setSource("p_field", "p_value2").get();, +        client().prepareIndex("test", "child", "c3").setSource("c_field", "blue").setParent("p2").get();, +        client().prepareIndex("test", "child", "c4").setSource("c_field", "red").setParent("p2").get();, +        client().admin().indices().prepareRefresh().get();, +                .prepareStats("test").setIdCache(true).get();, +                .get();, +                .prepareStats("test").setIdCache(true).get();, +        client().admin().indices().prepareClearCache("test").setIdCache(true).get();, +                .prepareStats("test").setIdCache(true).get();, +                .addMapping("parent"), +                .addMapping("child", "_parent", "type=parent"), +                .get();, +        ensureGreen();, +            client().prepareIndex("test", "parent", Integer.toString(i)).setSource("p_field", i).get();, +            client().prepareIndex("test", "child", Integer.toString(i)).setSource("c_field", i).setParent("" + 0).get();, +                    .get();, +        client().admin().indices().prepareFlush().get();, +        client().admin().indices().prepareRefresh().get();, +                    .get();, +                    .get();, +                .addMapping("parent"), +                .addMapping("child", "_parent", "type=parent"), +                .get();, +        ensureGreen();, +        client().prepareIndex("test", "parent", "p0").setSource("p_field", "p0").get();, +                    .setSize(numChildDocsPerParent).get();, +                .addMapping("parent"), +                .addMapping("child", "_parent", "type=parent"), +                .get();, +        ensureGreen();, +        client().prepareIndex("test", "parent", "p1").setSource("p_field", "p_value1").get();, +        client().admin().indices().prepareFlush().get();, +        client().prepareIndex("test", "child", "c1").setSource("c_field", "red").setParent("p1").get();, +        client().admin().indices().prepareFlush().get();, +        client().prepareIndex("test", "child", "c2").setSource("c_field", "yellow").setParent("p1").get();, +        client().admin().indices().prepareFlush().get();, +        client().prepareIndex("test", "parent", "p2").setSource("p_field", "p_value2").get();, +        client().admin().indices().prepareFlush().get();, +        client().prepareIndex("test", "child", "c3").setSource("c_field", "blue").setParent("p2").get();, +        client().admin().indices().prepareFlush().get();, +        client().prepareIndex("test", "child", "c4").setSource("c_field", "red").setParent("p2").get();, +        client().admin().indices().prepareFlush().get();, +        refresh();, +                .get();, +        searchResponse = client().prepareSearch("test").setQuery(hasChildQuery("child", termQuery("c_field", "red"))).get();, +                .setQuery(constantScoreQuery(hasChildFilter("child", termQuery("c_field", "yellow")))).get();, +                .get();, +                .get();, +                .addMapping("parent"), +                .addMapping("child", "_parent", "type=parent"), +                .get();]