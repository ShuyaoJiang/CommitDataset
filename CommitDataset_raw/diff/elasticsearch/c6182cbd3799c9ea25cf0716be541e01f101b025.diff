[+++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java, +import java.util.Comparator;, +        // as failing primaries also fail associated replicas, we fail replicas first here so that their nodes are added to ignore list, +        List<FailedRerouteAllocation.FailedShard> orderedFailedShards = new ArrayList<>(failedShards);, +        orderedFailedShards.sort(Comparator.comparing(failedShard -> failedShard.shard.primary()));, +        for (FailedRerouteAllocation.FailedShard failedShard : orderedFailedShards) {]