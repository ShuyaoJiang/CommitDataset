[+++ b/core/src/test/java/org/elasticsearch/common/io/PathUtilsForTesting.java, +        installMock(LuceneTestCase.getBaseTempDirForTestClass().getFileSystem());, +    }, +    , +    /** Installs a mock filesystem for testing */, +    public static void installMock(FileSystem mock) {, +++ b/core/src/test/java/org/elasticsearch/common/io/PathUtilsForTesting.java, +        installMock(LuceneTestCase.getBaseTempDirForTestClass().getFileSystem());, +    }, +    , +    /** Installs a mock filesystem for testing */, +    public static void installMock(FileSystem mock) {, +++ b/core/src/test/java/org/elasticsearch/index/shard/NewPathForShardTests.java, +import org.elasticsearch.common.io.PathUtilsForTesting;, +import java.nio.file.spi.FileSystemProvider;, +    private static String aPathPart;, +    private static String bPathPart;, +        FileSystem current = PathUtils.getDefaultFileSystem();, +        aPathPart = current.getSeparator() + 'a' + current.getSeparator();, +        bPathPart = current.getSeparator() + 'b' + current.getSeparator();, +        FileSystemProvider mock = new MockUsableSpaceFileSystemProvider(current);, +        PathUtilsForTesting.installMock(mock.getFileSystem(null));, +        PathUtilsForTesting.teardown();, +        public MockUsableSpaceFileSystemProvider(FileSystem inner) {, +            super("mockusablespace://", inner);, +        , +        nodeEnv.close();]