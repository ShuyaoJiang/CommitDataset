[+++ b/src/main/java/org/elasticsearch/client/transport/TransportClient.java, +import org.elasticsearch.common.component.LifecycleComponent;, +import org.elasticsearch.plugins.PluginsModule;, +import org.elasticsearch.plugins.PluginsService;, +    private final PluginsService pluginsService;, +, +        Settings settings = settings = settingsBuilder().put(tuple.v1()), +        this.pluginsService = new PluginsService(tuple.v1(), tuple.v2());, +        this.settings = pluginsService.updatedSettings();, +, +        modules.add(new PluginsModule(settings, pluginsService));, +        for (Class<? extends LifecycleComponent> plugin : pluginsService.services()) {, +            injector.getInstance(plugin).close();, +        }, +]