[+++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +        int i = o1.value.shardTarget().getIndex().compareTo(o2.value.shardTarget().getIndex());, +            i = o1.value.shardTarget().getShardId().id() - o2.value.shardTarget().getShardId().id();, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +        int i = o1.value.shardTarget().getIndex().compareTo(o2.value.shardTarget().getIndex());, +            i = o1.value.shardTarget().getShardId().id() - o2.value.shardTarget().getShardId().id();, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +        int i = o1.value.shardTarget().getIndex().compareTo(o2.value.shardTarget().getIndex());, +            i = o1.value.shardTarget().getShardId().id() - o2.value.shardTarget().getShardId().id();, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchScrollQueryThenFetchAsyncAction.java, +            DiscoveryNode node = nodes.get(querySearchResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +        int i = o1.value.shardTarget().getIndex().compareTo(o2.value.shardTarget().getIndex());, +            i = o1.value.shardTarget().getShardId().id() - o2.value.shardTarget().getShardId().id();, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchScrollQueryThenFetchAsyncAction.java, +            DiscoveryNode node = nodes.get(querySearchResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/ShardSearchFailure.java, +            return shardTarget.getIndex();, +            return shardTarget.getShardId().id();, +            builder.field("node", shardTarget.getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java, +        int i = o1.value.shardTarget().getIndex().compareTo(o2.value.shardTarget().getIndex());, +            i = o1.value.shardTarget().getShardId().id() - o2.value.shardTarget().getShardId().id();, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(queryResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchScrollQueryThenFetchAsyncAction.java, +            DiscoveryNode node = nodes.get(querySearchResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/ShardSearchFailure.java, +            return shardTarget.getIndex();, +            return shardTarget.getShardId().id();, +            builder.field("node", shardTarget.getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/TransportSearchHelper.java, +                out.writeString(searchPhaseResult.shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java, +                Transport.Connection connection = nodeIdToConnection.apply(entry.value.shardTarget().getNodeId());, +                        Transport.Connection connection = nodeIdToConnection.apply(entry.value.queryResult().shardTarget().getNodeId());, +++ b/core/src/main/java/org/elasticsearch/action/search/SearchDfsQueryAndFetchAsyncAction.java, +            Transport.Connection connection = nodeIdToConnection.apply(dfsResult.shardTarget().getNodeId());]