[+++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java, +        for (FailedRerouteAllocation.FailedShard failedShardEntry : failedShards) {, +            ShardRouting shardToFail = failedShardEntry.routingEntry;, +            allocation.addIgnoreShardForNode(shardToFail.shardId(), shardToFail.currentNodeId());, +            // failing a primary also fails initializing replica shards, re-resolve ShardRouting, +            ShardRouting failedShard = routingNodes.getByAllocationId(shardToFail.shardId(), shardToFail.allocationId().getId());, +            if (failedShard != null) {, +                if (failedShard != shardToFail) {, +                    logger.trace("{} shard routing modified in an earlier iteration (previous: {}, current: {})",, +                        shardToFail.shardId(), shardToFail, failedShard);, +                }, +                int failedAllocations = failedShard.unassignedInfo() != null ? failedShard.unassignedInfo().getNumFailedAllocations() : 0;, +            } else {, +                logger.trace("{} shard routing failed in an earlier iteration (routing: {})", shardToFail.shardId(), shardToFail);, +            }]