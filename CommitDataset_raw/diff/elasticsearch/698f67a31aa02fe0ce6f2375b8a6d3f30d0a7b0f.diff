[+++ b/plugins/cloud/aws/src/main/java/org/elasticsearch/discovery/ec2/AwsEc2UnicastHostsProvider.java, +import org.elasticsearch.common.collect.ImmutableMap;, +import java.util.Map;, +    private final ImmutableMap<String, String> tags;, +, +        this.tags = componentSettings.getByPrefix("tag.").getAsMap();, +, +                // see if we need to filter by tags, +                boolean filterByTag = false;, +                if (!tags.isEmpty()) {, +                    if (instance.getTags() == null) {, +                        filterByTag = true;, +                    } else {, +                        // check that all tags listed are there on the instance, +                        for (Map.Entry<String, String> entry : tags.entrySet()) {, +                            boolean found = false;, +                            for (Tag tag : instance.getTags()) {, +                                if (entry.getKey().equals(tag.getKey()) && entry.getValue().equals(tag.getValue())) {, +                                    found = true;, +                                    break;, +                                }, +                            }, +                            if (!found) {, +                                filterByTag = true;, +                                break;, +                            }, +                        }, +                    }, +                }, +                if (filterByTag) {, +                    logger.trace("filtering out instance {} based tags {}, not part of {}", instance.getInstanceId(), tags, instance.getTags());, +                    continue;, +                }, +]