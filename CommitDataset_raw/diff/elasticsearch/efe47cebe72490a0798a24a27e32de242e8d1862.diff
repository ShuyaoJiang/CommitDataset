[+++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +        return new IndexAnalyzers(indexSettings, defaultAnalyzer, defaultSearchAnalyzer, defaultSearchQuoteAnalyzer, analyzers, normalizers,, +                whitespaceNormalizers);, +++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +        return new IndexAnalyzers(indexSettings, defaultAnalyzer, defaultSearchAnalyzer, defaultSearchQuoteAnalyzer, analyzers, normalizers,, +                whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/IndexAnalyzers.java, +import static java.util.Collections.unmodifiableMap;, +, +        this.analyzers = unmodifiableMap(analyzers);, +        this.normalizers = unmodifiableMap(normalizers);, +        this.whitespaceNormalizers = unmodifiableMap(whitespaceNormalizers);, +++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +        return new IndexAnalyzers(indexSettings, defaultAnalyzer, defaultSearchAnalyzer, defaultSearchQuoteAnalyzer, analyzers, normalizers,, +                whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/IndexAnalyzers.java, +import static java.util.Collections.unmodifiableMap;, +, +        this.analyzers = unmodifiableMap(analyzers);, +        this.normalizers = unmodifiableMap(normalizers);, +        this.whitespaceNormalizers = unmodifiableMap(whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +    public DocumentMapperParser(IndexSettings indexSettings, MapperService mapperService, NamedXContentRegistry xContentRegistry,, +            SimilarityService similarityService, MapperRegistry mapperRegistry, Supplier<QueryShardContext> queryShardContextSupplier) {, +        return new Mapper.TypeParser.ParserContext(type, similarityService::getSimilarity, mapperService,, +++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +        return new IndexAnalyzers(indexSettings, defaultAnalyzer, defaultSearchAnalyzer, defaultSearchQuoteAnalyzer, analyzers, normalizers,, +                whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/IndexAnalyzers.java, +import static java.util.Collections.unmodifiableMap;, +, +        this.analyzers = unmodifiableMap(analyzers);, +        this.normalizers = unmodifiableMap(normalizers);, +        this.whitespaceNormalizers = unmodifiableMap(whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +    public DocumentMapperParser(IndexSettings indexSettings, MapperService mapperService, NamedXContentRegistry xContentRegistry,, +            SimilarityService similarityService, MapperRegistry mapperRegistry, Supplier<QueryShardContext> queryShardContextSupplier) {, +        return new Mapper.TypeParser.ParserContext(type, similarityService::getSimilarity, mapperService,, +++ b/server/src/main/java/org/elasticsearch/index/mapper/Mapper.java, +            public ParserContext(String type, Function<String, SimilarityProvider> similarityLookupService,, +                return mapperService.getIndexAnalyzers();, +                    super(in.type(), in.similarityLookupService(), in.mapperService(), in.typeParsers(),, +++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +        return new IndexAnalyzers(indexSettings, defaultAnalyzer, defaultSearchAnalyzer, defaultSearchQuoteAnalyzer, analyzers, normalizers,, +                whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/IndexAnalyzers.java, +import static java.util.Collections.unmodifiableMap;, +, +        this.analyzers = unmodifiableMap(analyzers);, +        this.normalizers = unmodifiableMap(normalizers);, +        this.whitespaceNormalizers = unmodifiableMap(whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +    public DocumentMapperParser(IndexSettings indexSettings, MapperService mapperService, NamedXContentRegistry xContentRegistry,, +            SimilarityService similarityService, MapperRegistry mapperRegistry, Supplier<QueryShardContext> queryShardContextSupplier) {, +        return new Mapper.TypeParser.ParserContext(type, similarityService::getSimilarity, mapperService,, +++ b/server/src/main/java/org/elasticsearch/index/mapper/Mapper.java, +            public ParserContext(String type, Function<String, SimilarityProvider> similarityLookupService,, +                return mapperService.getIndexAnalyzers();, +                    super(in.type(), in.similarityLookupService(), in.mapperService(), in.typeParsers(),, +++ b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +, +        this.documentParser = new DocumentMapperParser(indexSettings, this, xContentRegistry, similarityService, mapperRegistry,, +                queryShardContextSupplier);, +++ b/plugins/mapper-murmur3/src/test/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapperTests.java, +        parser = new DocumentMapperParser(indexService.getIndexSettings(), indexService.mapperService(), indexService.xContentRegistry(),, +                indexService.similarityService(), mapperRegistry, queryShardContext);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java, +        return new IndexAnalyzers(indexSettings, defaultAnalyzer, defaultSearchAnalyzer, defaultSearchQuoteAnalyzer, analyzers, normalizers,, +                whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/analysis/IndexAnalyzers.java, +import static java.util.Collections.unmodifiableMap;, +, +        this.analyzers = unmodifiableMap(analyzers);, +        this.normalizers = unmodifiableMap(normalizers);, +        this.whitespaceNormalizers = unmodifiableMap(whitespaceNormalizers);, +++ b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapperParser.java, +    public DocumentMapperParser(IndexSettings indexSettings, MapperService mapperService, NamedXContentRegistry xContentRegistry,, +            SimilarityService similarityService, MapperRegistry mapperRegistry, Supplier<QueryShardContext> queryShardContextSupplier) {, +        return new Mapper.TypeParser.ParserContext(type, similarityService::getSimilarity, mapperService,, +++ b/server/src/main/java/org/elasticsearch/index/mapper/Mapper.java, +            public ParserContext(String type, Function<String, SimilarityProvider> similarityLookupService,, +                return mapperService.getIndexAnalyzers();]