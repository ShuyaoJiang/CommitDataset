[+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/transport/filter/IPFilterTests.java, +import org.elasticsearch.common.Numbers;, +import java.net.NetworkInterface;, +import java.net.SocketException;, +import java.net.UnknownHostException;, +import static org.hamcrest.Matchers.notNullValue;, +        // when "localhost" is used, ES considers all local addresses see PatternRule#isLocalhost(), +        assertAddressIsDenied(randomNonLocalIPv4Address());, +        // when "localhost" is used, ES considers all local addresses see PatternRule#isLocalhost(), +        assertAddressIsDenied(randomNonLocalIPv4Address());, +, +    private String randomNonLocalIPv4Address() throws SocketException, UnknownHostException {, +        String ipv4Address = null;, +        int noOfRetries = 0;, +        do {, +            noOfRetries++;, +            final InetAddress address = InetAddress.getByAddress(Numbers.intToBytes(randomInt()));, +            if (address.isAnyLocalAddress() || address.isLoopbackAddress() || NetworkInterface.getByInetAddress(address) != null) {, +                continue;, +            } else {, +                ipv4Address = NetworkAddress.format(address);, +                break;, +            }, +        } while (ipv4Address == null && noOfRetries < 25);, +        assertThat("could not generate random IPv4 address which is not local address", ipv4Address, notNullValue());, +        return ipv4Address;, +    }, +]