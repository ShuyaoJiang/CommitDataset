[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/support/replication/TransportShardReplicationOperationAction.java, +            // no shards, might be in the case between index gateway recovery and shards initialization, +            if (shards.size() == 0) {, +                retry(fromClusterEvent, shards.shardId());, +                return false;, +            }, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/support/replication/TransportShardReplicationOperationAction.java, +            // no shards, might be in the case between index gateway recovery and shards initialization, +            if (shards.size() == 0) {, +                retry(fromClusterEvent, shards.shardId());, +                return false;, +            }, +, +++ b/modules/test/integration/src/test/java/org/elasticsearch/test/stress/rollingrestart/RollingRestartStressTest.java, +, +            try {, +                ClusterHealthResponse clusterHealth = client.client().admin().cluster().prepareHealth(), +                        .setWaitForGreenStatus(), +                        .setWaitForNodes(Integer.toString(numberOfNodes + 0 /* client node*/)), +                        .setWaitForRelocatingShards(0), +                        .setTimeout("10m").execute().actionGet();, +                if (clusterHealth.timedOut()) {, +                    logger.warn("timed out waiting for green status....");, +                }, +            } catch (Exception e) {, +                logger.warn("failed to execute cluster health....");, +            }, +, +                ClusterHealthResponse clusterHealth = client.client().admin().cluster().prepareHealth(), +                        .setWaitForGreenStatus(), +                        .setWaitForNodes(Integer.toString(numberOfNodes + 1 /* client node*/)), +                        .setWaitForRelocatingShards(0), +                        .setTimeout("10m").execute().actionGet();, +        System.setProperty("es.logger.prefix", "");, +, +                .initialNumberOfDocs(1000)]