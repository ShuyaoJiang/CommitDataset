[+++ b/server/src/main/java/org/elasticsearch/transport/ConnectionManager.java, +                    // we are holding a write lock so nobody adds to the connectedNodes / openConnections map - it's safe to first close, +++ b/server/src/main/java/org/elasticsearch/transport/ConnectionManager.java, +                    // we are holding a write lock so nobody adds to the connectedNodes / openConnections map - it's safe to first close, +++ b/test/framework/src/main/java/org/elasticsearch/test/transport/MockTransportService.java, +import java.util.concurrent.TimeUnit;, +            openConnections.computeIfAbsent(node, n -> new CopyOnWriteArrayList<>()).add(connection);, +                    if (openConnections.isEmpty()) {, +                        openConnections.notifyAll();, +                    }, +        }, +        try {, +                if (openConnections.isEmpty() == false) {, +                    openConnections.wait(TimeUnit.SECONDS.toMillis(30L));, +                }, +        } catch (InterruptedException e) {, +            throw new IllegalStateException(e);, +        }]