[+++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +            Set<String> indicesToClose = new HashSet<>();, +                            if (indicesService.hasIndex(index) == false || indicesToClose.contains(index)) {, +                                IndexService indexService;, +                                if (indicesService.hasIndex(index) == false) {, +                                    indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +                                    indicesToClose.add(index);, +                                } else {, +                                    indexService = indicesService.indexService(index);, +                                }, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java, +            Set<String> indicesToClose = new HashSet<>();, +                            if (indicesService.hasIndex(index) == false || indicesToClose.contains(index)) {, +                                IndexService indexService;, +                                if (indicesService.hasIndex(index) == false) {, +                                    indexService = indicesService.createIndex(nodeServicesProvider, indexMetaData, Collections.EMPTY_LIST);, +                                    indicesToClose.add(index);, +                                } else {, +                                    indexService = indicesService.indexService(index);, +                                }, +++ b/core/src/test/java/org/elasticsearch/indices/mapping/UpdateMappingIntegrationIT.java]