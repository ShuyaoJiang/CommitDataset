[+++ b/core/src/main/java/org/elasticsearch/common/cache/Cache.java, +    public static final int NUMBER_OF_SEGMENTS = 256;, +    private final CacheSegment<K, V>[] segments = new CacheSegment[NUMBER_OF_SEGMENTS];, +, +        boolean[] haveSegmentLock = new boolean[NUMBER_OF_SEGMENTS];, +        try {, +            for (int i = 0; i < NUMBER_OF_SEGMENTS; i++) {, +                segments[i].segmentLock.writeLock().lock();, +                haveSegmentLock[i] = true;, +            }, +        } finally {, +            for (int i = 0; i < NUMBER_OF_SEGMENTS; i++) {, +                if (haveSegmentLock[i]) {, +                    segments[i].segmentLock.writeLock().unlock();, +                }, +            }, +        }]