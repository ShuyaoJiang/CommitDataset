[+++ b/core/src/test/java/org/elasticsearch/action/support/replication/TransportReplicationActionTests.java, +import org.elasticsearch.cluster.NotMasterException;, +                    if (randomBoolean()) {, +                        // simulate master left and test that the shard failure is retried, +                        int numberOfRetries = randomIntBetween(1, 4);, +                        CapturingTransport.CapturedRequest currentRequest = shardFailedRequest;, +                        for (int retryNumber = 0; retryNumber < numberOfRetries; retryNumber++) {, +                            // force a new cluster state to simulate a new master having been elected, +                            clusterService.setState(ClusterState.builder(clusterService.state()));, +                            transport.handleResponse(currentRequest.requestId, new NotMasterException("shard-failed-test"));, +                            CapturingTransport.CapturedRequest[] retryRequests = transport.capturedRequests();, +                            transport.clear();, +                            assertEquals(1, retryRequests.length);, +                            currentRequest = retryRequests[0];, +                        }, +                        // now simulate that the last retry succeeded, +                        transport.handleResponse(currentRequest.requestId, TransportResponse.Empty.INSTANCE);, +                    } else {, +                }]