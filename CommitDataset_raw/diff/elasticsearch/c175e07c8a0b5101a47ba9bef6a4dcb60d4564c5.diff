[+++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.nodes;, +            this.nodes = ImmutableOpenMap.builder(nodes.getNodes());, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.nodes;, +            this.nodes = ImmutableOpenMap.builder(nodes.getNodes());, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                DiscoveryNode[] possibleMasters = electMaster.nextPossibleMasters(nodes.getNodes().values(), 5);, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.nodes;, +            this.nodes = ImmutableOpenMap.builder(nodes.getNodes());, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                DiscoveryNode[] possibleMasters = electMaster.nextPossibleMasters(nodes.getNodes().values(), 5);, +++ b/core/src/test/java/org/elasticsearch/action/support/nodes/TransportNodesActionTests.java, +        String[] nodeIds = clusterService.state().nodes().getNodes().keys().toArray(String.class);, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.nodes;, +            this.nodes = ImmutableOpenMap.builder(nodes.getNodes());, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                DiscoveryNode[] possibleMasters = electMaster.nextPossibleMasters(nodes.getNodes().values(), 5);, +++ b/core/src/test/java/org/elasticsearch/action/support/nodes/TransportNodesActionTests.java, +        String[] nodeIds = clusterService.state().nodes().getNodes().keys().toArray(String.class);, +++ b/core/src/test/java/org/elasticsearch/cluster/ClusterStateDiffIT.java, +                assertThat(clusterStateFromDiffs.nodes().getNodes(), equalTo(clusterState.nodes().getNodes()));, +                assertThat(clusterStateFromDiffs.nodes().getNodes(), equalTo(clusterState.nodes().getNodes()));, +                for (ObjectCursor<String> node : clusterStateFromDiffs.nodes().getNodes().keys()) {, +        List<String> nodeIds = randomSubsetOf(randomInt(clusterState.nodes().getNodes().size() - 1), clusterState.nodes().getNodes().keys().toArray(String.class));, +                    builder.add(randomChangeToIndexRoutingTable(clusterState.routingTable().indicesRouting().get(index), clusterState.nodes().getNodes().keys().toArray(String.class)));, +            builder.add(randomIndexRoutingTable("index-" + randomInt(), clusterState.nodes().getNodes().keys().toArray(String.class)));, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.nodes;, +            this.nodes = ImmutableOpenMap.builder(nodes.getNodes());, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                DiscoveryNode[] possibleMasters = electMaster.nextPossibleMasters(nodes.getNodes().values(), 5);, +++ b/core/src/test/java/org/elasticsearch/action/support/nodes/TransportNodesActionTests.java, +        String[] nodeIds = clusterService.state().nodes().getNodes().keys().toArray(String.class);, +++ b/core/src/test/java/org/elasticsearch/cluster/ClusterStateDiffIT.java, +                assertThat(clusterStateFromDiffs.nodes().getNodes(), equalTo(clusterState.nodes().getNodes()));, +                assertThat(clusterStateFromDiffs.nodes().getNodes(), equalTo(clusterState.nodes().getNodes()));, +                for (ObjectCursor<String> node : clusterStateFromDiffs.nodes().getNodes().keys()) {, +        List<String> nodeIds = randomSubsetOf(randomInt(clusterState.nodes().getNodes().size() - 1), clusterState.nodes().getNodes().keys().toArray(String.class));, +                    builder.add(randomChangeToIndexRoutingTable(clusterState.routingTable().indicesRouting().get(index), clusterState.nodes().getNodes().keys().toArray(String.class)));, +            builder.add(randomIndexRoutingTable("index-" + randomInt(), clusterState.nodes().getNodes().keys().toArray(String.class)));, +++ b/core/src/test/java/org/elasticsearch/cluster/SimpleClusterStateIT.java, +        assertThat(clusterStateResponse.getState().nodes().getNodes().size(), is(cluster().size()));, +        assertThat(clusterStateResponseFiltered.getState().nodes().getNodes().size(), is(0));, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.nodes;, +            this.nodes = ImmutableOpenMap.builder(nodes.getNodes());, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                DiscoveryNode[] possibleMasters = electMaster.nextPossibleMasters(nodes.getNodes().values(), 5);, +++ b/core/src/test/java/org/elasticsearch/action/support/nodes/TransportNodesActionTests.java, +        String[] nodeIds = clusterService.state().nodes().getNodes().keys().toArray(String.class);, +++ b/core/src/test/java/org/elasticsearch/cluster/ClusterStateDiffIT.java, +                assertThat(clusterStateFromDiffs.nodes().getNodes(), equalTo(clusterState.nodes().getNodes()));, +                assertThat(clusterStateFromDiffs.nodes().getNodes(), equalTo(clusterState.nodes().getNodes()));, +                for (ObjectCursor<String> node : clusterStateFromDiffs.nodes().getNodes().keys()) {, +        List<String> nodeIds = randomSubsetOf(randomInt(clusterState.nodes().getNodes().size() - 1), clusterState.nodes().getNodes().keys().toArray(String.class));, +                    builder.add(randomChangeToIndexRoutingTable(clusterState.routingTable().indicesRouting().get(index), clusterState.nodes().getNodes().keys().toArray(String.class)));, +            builder.add(randomIndexRoutingTable("index-" + randomInt(), clusterState.nodes().getNodes().keys().toArray(String.class)));, +++ b/core/src/test/java/org/elasticsearch/cluster/SimpleClusterStateIT.java, +        assertThat(clusterStateResponse.getState().nodes().getNodes().size(), is(cluster().size()));, +        assertThat(clusterStateResponseFiltered.getState().nodes().getNodes().size(), is(0));, +++ b/core/src/test/java/org/elasticsearch/cluster/action/shard/ShardStateActionTests.java, +        String nodeId = randomFrom(clusterService.state().nodes().getNodes().keys().toArray(String.class));, +++ b/core/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/action/support/tasks/TransportTasksAction.java, +            ImmutableOpenMap<String, DiscoveryNode> nodes = clusterState.nodes().getNodes();, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java]