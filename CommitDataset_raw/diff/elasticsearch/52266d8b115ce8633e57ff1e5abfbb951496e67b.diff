[+++ b/test/framework/src/main/java/org/elasticsearch/index/replication/ESIndexLevelReplicationTestCase.java, +import java.util.ArrayList;, +            if (replicationTargets != null) {, +                replicationTargets.addReplica(replica);, +            }, +            if (replicationTargets != null) {, +                replicationTargets.addReplica(newReplica);, +            }, +            this.replicationTargets = new ReplicationTargets(this.primary, new ArrayList<>(this.replicas));, +            this.replicas = replicas;, +        }, +, +        /**, +         * This does not modify the replication targets, but only adds a replica to the list., +         * If the targets is updated to include the given replica, a replication action would, +         * be able to find this replica to execute write requests on it., +         */, +        synchronized void addReplica(IndexShard replica) {, +            replicas.add(replica);, +        }, +, +        synchronized IndexShard findReplicaShard(ShardRouting replicaRouting) {, +            for (IndexShard replica : replicas) {, +                if (replica.routingEntry().isSameAllocation(replicaRouting)) {, +                    return replica;, +                }, +            }, +            throw new AssertionError("replica [" + replicaRouting + "] is not found; replicas[" + replicas + "] primary[" + primary + "]");, +                IndexShard replica = replicationTargets.findReplicaShard(replicaRouting);]