[+++ b/modules/transport-netty4/src/test/java/org/elasticsearch/http/netty4/Netty4HttpServerPipeliningTests.java, +import java.util.HashSet;, +import java.util.Set;, +import static org.elasticsearch.test.hamcrest.RegexMatcher.matches;, +                    requests.add("/slow/" + i);, +            final Set<Integer> slowIds = new HashSet<>();, +            int numberOfSlowRequests = 0;, +            for (int i = 0; i < numberOfRequests; i++) {, +                if (rarely()) {, +                    requests.add("/slow/" + i);, +                    slowIds.add(i);, +                    numberOfSlowRequests++;, +                } else {, +                // we can not be sure about the order of the responses, but the slow ones should, +                // come last, +                for (int i = 0; i < numberOfRequests - numberOfSlowRequests; i++) {, +                    assertThat(responseBodies.get(i), matches("/\\d+"));, +                }, +, +                final Set<Integer> ids = new HashSet<>();, +                    final String response = responseBodies.get(numberOfRequests - numberOfSlowRequests + i);, +                    assertThat(response, matches("/slow/\\d+" ));, +                    assertTrue(ids.add(Integer.parseInt(response.split("/")[2])));, +                assertThat(slowIds, equalTo(ids));, +            }, +        }, +            final boolean slow = uri.matches("/slow/\\d+");, +            if (slow) {, +                    Thread.sleep(scaledRandomIntBetween(500, 1000));, +            } else {, +                assert uri.matches("/\\d+");]