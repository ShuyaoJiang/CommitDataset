[+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java, +import org.elasticsearch.index.IndexSettings;, +        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(targetIndexSettings) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {, +            throw new IllegalArgumentException("Can't disable [index.soft_deletes.enabled] setting on resize");, +        }, +++ b/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java, +import org.elasticsearch.index.IndexSettings;, +        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(targetIndexSettings) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {, +            throw new IllegalArgumentException("Can't disable [index.soft_deletes.enabled] setting on resize");, +        }, +++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +                    (s) -> (s.startsWith("index.similarity.") || s.startsWith("index.analysis.") ||, +                            s.startsWith("index.sort.") || s.equals("index.soft_deletes.enabled")), +++ b/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java, +import org.elasticsearch.index.IndexSettings;, +        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(targetIndexSettings) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {, +            throw new IllegalArgumentException("Can't disable [index.soft_deletes.enabled] setting on resize");, +        }, +++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +                    (s) -> (s.startsWith("index.similarity.") || s.startsWith("index.analysis.") ||, +                            s.startsWith("index.sort.") || s.equals("index.soft_deletes.enabled")), +++ b/server/src/test/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeActionTests.java, +import static org.hamcrest.Matchers.equalTo;, +        IllegalArgumentException softDeletesError = expectThrows(IllegalArgumentException.class, () -> {, +            ResizeRequest req = new ResizeRequest("target", "source");, +            req.getTargetIndexRequest().settings(Settings.builder().put("index.soft_deletes.enabled", false));, +            ClusterState clusterState = createClusterState("source", 8, 1,, +                Settings.builder().put("index.blocks.write", true).put("index.soft_deletes.enabled", true).build());, +            TransportResizeAction.prepareCreateIndexRequest(req, clusterState,, +                (i) -> new DocsStats(between(10, 1000), between(1, 10), between(1, 10000)), "source", "target");, +        });, +        assertThat(softDeletesError.getMessage(), equalTo("Can't disable [index.soft_deletes.enabled] setting on resize"));, +, +++ b/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java, +import org.elasticsearch.index.IndexSettings;, +        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(metaData.getSettings()) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(targetIndexSettings) &&, +            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {, +            throw new IllegalArgumentException("Can't disable [index.soft_deletes.enabled] setting on resize");, +        }, +++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java, +                    (s) -> (s.startsWith("index.similarity.") || s.startsWith("index.analysis.") ||, +                            s.startsWith("index.sort.") || s.equals("index.soft_deletes.enabled")), +++ b/server/src/test/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeActionTests.java, +import static org.hamcrest.Matchers.equalTo;, +        IllegalArgumentException softDeletesError = expectThrows(IllegalArgumentException.class, () -> {, +            ResizeRequest req = new ResizeRequest("target", "source");, +            req.getTargetIndexRequest().settings(Settings.builder().put("index.soft_deletes.enabled", false));, +            ClusterState clusterState = createClusterState("source", 8, 1,, +                Settings.builder().put("index.blocks.write", true).put("index.soft_deletes.enabled", true).build());, +            TransportResizeAction.prepareCreateIndexRequest(req, clusterState,, +                (i) -> new DocsStats(between(10, 1000), between(1, 10), between(1, 10000)), "source", "target");, +        });, +        assertThat(softDeletesError.getMessage(), equalTo("Can't disable [index.soft_deletes.enabled] setting on resize"));, +, +++ b/server/src/test/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexServiceTests.java, +                        .put("index.soft_deletes.enabled", "true"), +                    assertThat(settings.get("index.soft_deletes.enabled"), equalTo("true"));, +    public void testDoNotOverrideSoftDeletesSettingOnResize() {, +        runPrepareResizeIndexSettingsTest(, +            Settings.builder().put("index.soft_deletes.enabled", "false").build(),, +            Settings.builder().put("index.soft_deletes.enabled", "true").build(),, +            Collections.emptyList(),, +            randomBoolean(),, +            settings -> assertThat(settings.get("index.soft_deletes.enabled"), equalTo("true")));, +    }, +]