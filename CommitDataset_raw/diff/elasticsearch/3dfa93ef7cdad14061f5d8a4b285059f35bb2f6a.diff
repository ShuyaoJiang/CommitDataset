[+++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/210_rescore_explain.yml, +---, +"Score should match explanation in rescore":, +  - skip:, +      version: " - 6.99.99", +      reason: Explanation for rescoring was corrected after these versions, +  - do:, +      bulk:, +        refresh: true, +        body:, +          - '{"index": {"_index": "test_index", "_type": "_doc", "_id": "1"}}', +          - '{"f1": "1"}', +          - '{"index": {"_index": "test_index", "_type": "_doc", "_id": "2"}}', +          - '{"f1": "2"}', +          - '{"index": {"_index": "test_index", "_type": "_doc", "_id": "3"}}', +          - '{"f1": "3"}', +, +  - do:, +      search:, +        index: test_index, +        body:, +          explain: true, +          query:, +            match_all: {}, +          rescore:, +            window_size: 2, +            query:, +              rescore_query:, +                match_all: {}, +              query_weight: 5, +              rescore_query_weight: 10, +, +  - match: { hits.hits.0._score: 15 }, +  - match: { hits.hits.0._explanation.value: 15 }, +, +  - match: { hits.hits.1._score: 15 }, +  - match: { hits.hits.1._explanation.value: 15 }, +, +  - match: { hits.hits.2._score: 5 }, +  - match: { hits.hits.2._explanation.value: 5 }, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/210_rescore_explain.yml, +---, +"Score should match explanation in rescore":, +  - skip:, +      version: " - 6.99.99", +      reason: Explanation for rescoring was corrected after these versions, +  - do:, +      bulk:, +        refresh: true, +        body:, +          - '{"index": {"_index": "test_index", "_type": "_doc", "_id": "1"}}', +          - '{"f1": "1"}', +          - '{"index": {"_index": "test_index", "_type": "_doc", "_id": "2"}}', +          - '{"f1": "2"}', +          - '{"index": {"_index": "test_index", "_type": "_doc", "_id": "3"}}', +          - '{"f1": "3"}', +, +  - do:, +      search:, +        index: test_index, +        body:, +          explain: true, +          query:, +            match_all: {}, +          rescore:, +            window_size: 2, +            query:, +              rescore_query:, +                match_all: {}, +              query_weight: 5, +              rescore_query_weight: 10, +, +  - match: { hits.hits.0._score: 15 }, +  - match: { hits.hits.0._explanation.value: 15 }, +, +  - match: { hits.hits.1._score: 15 }, +  - match: { hits.hits.1._explanation.value: 15 }, +, +  - match: { hits.hits.2._score: 5 }, +  - match: { hits.hits.2._explanation.value: 5 }, +++ b/server/src/main/java/org/elasticsearch/search/rescore/QueryRescorer.java, +import java.util.Collections;, +import static java.util.stream.Collectors.toSet;, +        // Save doc IDs for which rescoring was applied to be used in score explanation, +        Set<Integer> topNDocIDs = Collections.unmodifiableSet(, +            Arrays.stream(topNFirstPass.scoreDocs).map(scoreDoc -> scoreDoc.doc).collect(toSet()));, +        rescoreContext.setRescoredDocs(topNDocIDs);, +, +        QueryRescoreContext rescore = (QueryRescoreContext) rescoreContext;, +        if (rescoreContext.isRescored(topLevelDocId)){, +            Explanation rescoreExplain = searcher.explain(rescore.query(), topLevelDocId);, +            // NOTE: we don't use Lucene's Rescorer.explain because we want to insert our own description with which ScoreMode was used., +            //  Maybe we should add QueryRescorer.explainCombine to Lucene?, +        return prim;, +    }, +++ b/rest-api-spec/src/main/resources/rest-api-spec/test/search/210_rescore_explain.yml, +---, +"Score should match explanation in rescore":, +  - skip:, +      version: " - 6.99.99"]