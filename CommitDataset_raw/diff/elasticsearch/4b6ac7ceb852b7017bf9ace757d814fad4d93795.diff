[+++ b/elasticsearch/x-pack/shield/src/main/java/org/elasticsearch/shield/action/ShieldActionFilter.java, +import org.elasticsearch.shield.authc.InternalAuthenticationService;, +        // only restore the context if it is not empty. This is needed because sometimes a response is sent to the user, +        // and then a cleanup action is executed (like for search without a scroll), +        final ThreadContext.StoredContext original = threadContext.newStoredContext();, +        final boolean restoreOriginalContext = threadContext.getHeader(InternalAuthenticationService.USER_KEY) != null ||, +                threadContext.getTransient(InternalAuthenticationService.USER_KEY) != null;, +                        // we should always restore the original here because we forcefully changed to the system user, +                chain.proceed(task, action, request, new SigningListener(this, listener, restoreOriginalContext ? original : null));]