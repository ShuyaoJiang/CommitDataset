[+++ b/server/src/test/java/org/elasticsearch/cluster/routing/PrimaryAllocationIT.java, +import org.elasticsearch.cluster.ClusterStateListener;, +import org.elasticsearch.cluster.service.ClusterService;, +import java.util.concurrent.CountDownLatch;, +        final Set<String> expectedAllocationIds = useStaleReplica, +, +        final CountDownLatch clusterStateChangeLatch = new CountDownLatch(1);, +        final ClusterStateListener clusterStateListener = event -> {, +            final Set<String> allocationIds = event.state().metaData().index(idxName).inSyncAllocationIds(0);, +            if (expectedAllocationIds.equals(allocationIds)) {, +                clusterStateChangeLatch.countDown();, +            }, +            logger.info("expected allocation ids: {} actual allocation ids: {}", expectedAllocationIds, allocationIds);, +        };, +        final ClusterService clusterService = internalCluster().getInstance(ClusterService.class, master);, +        clusterService.addListener(clusterStateListener);, +, +        rerouteBuilder.get();, +, +        assertTrue(clusterStateChangeLatch.await(30, TimeUnit.SECONDS));, +        clusterService.removeListener(clusterStateListener);, +        final ClusterState state = client().admin().cluster().prepareState().get().getState();]