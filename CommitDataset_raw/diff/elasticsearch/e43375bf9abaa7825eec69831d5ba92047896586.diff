[+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/support/Automatons.java, +import org.elasticsearch.common.settings.Setting;, +import org.elasticsearch.common.settings.Settings;, +    public static final Setting<Integer> MAX_DETERMINIZED_STATES_SETTING =, +        Setting.intSetting("xpack.security.automata.max_determinized_states", 100000, DEFAULT_MAX_DETERMINIZED_STATES,, +            Setting.Property.NodeScope);, +    // this value is not final since we allow it to be set at runtime, +    private static int maxDeterminizedStates = 100000;, +, +        List<Automaton> automata = new ArrayList<>(patterns.size());, +            final Automaton patternAutomaton = pattern(pattern);, +            automata.add(patternAutomaton);, +        return unionAndMinimize(automata);, +        return minimize(res, maxDeterminizedStates);, +        Automaton res = minus(a1, a2, maxDeterminizedStates);, +        return minimize(res, maxDeterminizedStates);, +    public static void updateMaxDeterminizedStates(Settings settings) {, +        maxDeterminizedStates = MAX_DETERMINIZED_STATES_SETTING.get(settings);, +    }, +, +    // accessor for testing, +    static int getMaxDeterminizedStates() {, +        return maxDeterminizedStates;, +    }, +, +        CharacterRunAutomaton runAutomaton = new CharacterRunAutomaton(automaton, maxDeterminizedStates);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/support/Automatons.java, +import org.elasticsearch.common.settings.Setting;, +import org.elasticsearch.common.settings.Settings;, +    public static final Setting<Integer> MAX_DETERMINIZED_STATES_SETTING =, +        Setting.intSetting("xpack.security.automata.max_determinized_states", 100000, DEFAULT_MAX_DETERMINIZED_STATES,, +            Setting.Property.NodeScope);, +    // this value is not final since we allow it to be set at runtime, +    private static int maxDeterminizedStates = 100000;, +, +        List<Automaton> automata = new ArrayList<>(patterns.size());, +            final Automaton patternAutomaton = pattern(pattern);, +            automata.add(patternAutomaton);, +        return unionAndMinimize(automata);, +        return minimize(res, maxDeterminizedStates);, +        Automaton res = minus(a1, a2, maxDeterminizedStates);, +        return minimize(res, maxDeterminizedStates);, +    public static void updateMaxDeterminizedStates(Settings settings) {, +        maxDeterminizedStates = MAX_DETERMINIZED_STATES_SETTING.get(settings);, +    }, +, +    // accessor for testing, +    static int getMaxDeterminizedStates() {, +        return maxDeterminizedStates;, +    }, +, +        CharacterRunAutomaton runAutomaton = new CharacterRunAutomaton(automaton, maxDeterminizedStates);, +++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/support/AutomatonsTests.java, +import org.apache.lucene.util.automaton.TooComplexToDeterminizeException;, +import org.elasticsearch.common.settings.Settings;, +import java.util.ArrayList;, +, +    public void testLotsOfIndices() {, +        final int numberOfIndices = scaledRandomIntBetween(512, 1024);, +        final List<String> names = new ArrayList<>(numberOfIndices);, +        for (int i = 0; i < numberOfIndices; i++) {, +            names.add(randomAlphaOfLengthBetween(6, 48));, +        }, +        final Automaton automaton = Automatons.patterns(names);, +        assertTrue(automaton.isDeterministic());, +, +        CharacterRunAutomaton runAutomaton = new CharacterRunAutomaton(automaton);, +        for (String name : names) {, +            assertTrue(runAutomaton.run(name));, +        }, +    }, +, +    public void testSettingMaxDeterminizedStates() {, +        try {, +            assertNotEquals(10000, Automatons.getMaxDeterminizedStates());, +            // set to the min value, +            Settings settings = Settings.builder().put(Automatons.MAX_DETERMINIZED_STATES_SETTING.getKey(), 10000).build();, +            Automatons.updateMaxDeterminizedStates(settings);, +            assertEquals(10000, Automatons.getMaxDeterminizedStates());, +, +            final List<String> names = new ArrayList<>(1024);, +            for (int i = 0; i < 1024; i++) {, +                names.add(randomAlphaOfLength(48));, +            }, +            TooComplexToDeterminizeException e = expectThrows(TooComplexToDeterminizeException.class, () -> Automatons.patterns(names));, +            assertThat(e.getMaxDeterminizedStates(), equalTo(10000));, +        } finally {, +            Automatons.updateMaxDeterminizedStates(Settings.EMPTY);, +            assertEquals(100000, Automatons.getMaxDeterminizedStates());, +        }, +    }, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/support/Automatons.java, +import org.elasticsearch.common.settings.Setting;, +import org.elasticsearch.common.settings.Settings;, +    public static final Setting<Integer> MAX_DETERMINIZED_STATES_SETTING =, +        Setting.intSetting("xpack.security.automata.max_determinized_states", 100000, DEFAULT_MAX_DETERMINIZED_STATES,, +            Setting.Property.NodeScope);, +    // this value is not final since we allow it to be set at runtime, +    private static int maxDeterminizedStates = 100000;, +]