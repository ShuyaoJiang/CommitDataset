[+++ b/core/src/main/java/org/elasticsearch/transport/netty/MessageChannelHandler.java, +        boolean success = false;, +            long requestId = streamIn.readLong();, +            byte status = streamIn.readByte();, +            Version version = Version.fromId(streamIn.readInt());, +, +                streamIn = compressor.streamInput(streamIn);, +            streamIn.setVersion(version);, +                String action = handleRequest(ctx.getChannel(), streamIn, requestId, version);, +, +                // Chek the entire message has been read, +                final int nextByte = streamIn.read();, +                // calling read() is useful to make sure the message is fully read, even if there some kind of EOS marker, +, +                TransportResponseHandler<?> handler = transportServiceAdapter.onResponseReceived(requestId);, +                        handlerResponseError(streamIn, handler);, +                        handleResponse(ctx.getChannel(), streamIn, handler);, +                    // Chek the entire message has been read, +                    final int nextByte = streamIn.read();, +, +                }, +            }, +            try {, +                if (success) {, +                    IOUtils.close(streamIn);, +                } else {, +                    IOUtils.closeWhileHandlingException(streamIn);, +                }, +            } finally {, +                // Set the expected position of the buffer, no matter what happened, +++ b/core/src/main/java/org/elasticsearch/transport/netty/MessageChannelHandler.java, +        boolean success = false;, +            long requestId = streamIn.readLong();, +            byte status = streamIn.readByte();, +            Version version = Version.fromId(streamIn.readInt());, +, +                streamIn = compressor.streamInput(streamIn);, +            streamIn.setVersion(version);, +                String action = handleRequest(ctx.getChannel(), streamIn, requestId, version);, +, +                // Chek the entire message has been read, +                final int nextByte = streamIn.read();, +                // calling read() is useful to make sure the message is fully read, even if there some kind of EOS marker, +, +                TransportResponseHandler<?> handler = transportServiceAdapter.onResponseReceived(requestId);, +                        handlerResponseError(streamIn, handler);, +                        handleResponse(ctx.getChannel(), streamIn, handler);, +                    // Chek the entire message has been read, +                    final int nextByte = streamIn.read();, +, +                }, +            }, +            try {, +                if (success) {, +                    IOUtils.close(streamIn);, +                } else {, +                    IOUtils.closeWhileHandlingException(streamIn);, +                }, +            } finally {, +                // Set the expected position of the buffer, no matter what happened, +++ b/core/src/test/java/org/elasticsearch/transport/AbstractSimpleTransportTests.java]