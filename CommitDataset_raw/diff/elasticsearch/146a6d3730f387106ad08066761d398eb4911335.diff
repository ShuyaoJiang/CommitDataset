[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/script/ScriptService.java, +    private final ConcurrentMap<CacheKey, CompiledScript> cache = new MapMaker().softValues().makeMap();, +        CacheKey cacheKey = new CacheKey(lang, script);, +        compiled = cache.get(cacheKey);, +        // not the end of the world if we compile it twice..., +        cache.put(cacheKey, compiled);, +    public static class CacheKey {, +        public final String lang;, +        public final String script;, +, +        public CacheKey(String lang, String script) {, +            this.lang = lang;, +            this.script = script;, +        }, +, +        @Override public boolean equals(Object o) {, +            CacheKey other = (CacheKey) o;, +            return lang.equals(other.lang) && script.equals(other.script);, +        }, +, +        @Override public int hashCode() {, +            return lang.hashCode() + 31 * script.hashCode();, +        }, +    }, +]