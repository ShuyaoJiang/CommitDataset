[+++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleService.java, +        this.policyRegistry = new PolicyStepsRegistry(xContentRegistry, client);, +                policyRegistry.update(event.state());, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleService.java, +        this.policyRegistry = new PolicyStepsRegistry(xContentRegistry, client);, +                policyRegistry.update(event.state());, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/PolicyStepsRegistry.java, +    private final Client client;, +    public PolicyStepsRegistry(NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +                        Map<Index, List<Step>> indexPhaseSteps, NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +    public void update(ClusterState clusterState) {, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleService.java, +        this.policyRegistry = new PolicyStepsRegistry(xContentRegistry, client);, +                policyRegistry.update(event.state());, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/PolicyStepsRegistry.java, +    private final Client client;, +    public PolicyStepsRegistry(NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +                        Map<Index, List<Step>> indexPhaseSteps, NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +    public void update(ClusterState clusterState) {, +++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/indexlifecycle/ExecuteStepsUpdateTaskTests.java, +        policyStepsRegistry = new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, client);, +        policyStepsRegistry.update(clusterState);, +        policyStepsRegistry.update(clusterState);, +        policyStepsRegistry.update(clusterState);, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleService.java, +        this.policyRegistry = new PolicyStepsRegistry(xContentRegistry, client);, +                policyRegistry.update(event.state());, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/PolicyStepsRegistry.java, +    private final Client client;, +    public PolicyStepsRegistry(NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +                        Map<Index, List<Step>> indexPhaseSteps, NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +    public void update(ClusterState clusterState) {, +++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/indexlifecycle/ExecuteStepsUpdateTaskTests.java, +        policyStepsRegistry = new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, client);, +        policyStepsRegistry.update(clusterState);, +        policyStepsRegistry.update(clusterState);, +        policyStepsRegistry.update(clusterState);, +++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleRunnerTests.java, +        return new PolicyStepsRegistry(lifecyclePolicyMap, firstStepMap, stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +        IndexLifecycleRunner runner = new IndexLifecycleRunner(new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, null),, +            NamedXContentRegistry.EMPTY, null);, +        registry = new PolicyStepsRegistry(lifecyclePolicyMap, firstStepMap, stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +        registry = new PolicyStepsRegistry(lifecyclePolicyMap, firstStepMap, stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +            stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleService.java, +        this.policyRegistry = new PolicyStepsRegistry(xContentRegistry, client);, +                policyRegistry.update(event.state());, +++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/indexlifecycle/PolicyStepsRegistry.java, +    private final Client client;, +    public PolicyStepsRegistry(NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +                        Map<Index, List<Step>> indexPhaseSteps, NamedXContentRegistry xContentRegistry, Client client) {, +        this.client = client;, +    public void update(ClusterState clusterState) {, +++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/indexlifecycle/ExecuteStepsUpdateTaskTests.java, +        policyStepsRegistry = new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, client);, +        policyStepsRegistry.update(clusterState);, +        policyStepsRegistry.update(clusterState);, +        policyStepsRegistry.update(clusterState);, +++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/indexlifecycle/IndexLifecycleRunnerTests.java, +        return new PolicyStepsRegistry(lifecyclePolicyMap, firstStepMap, stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +        IndexLifecycleRunner runner = new IndexLifecycleRunner(new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, null),, +            NamedXContentRegistry.EMPTY, null);, +        registry = new PolicyStepsRegistry(lifecyclePolicyMap, firstStepMap, stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +        registry = new PolicyStepsRegistry(lifecyclePolicyMap, firstStepMap, stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +            stepMap, indexSteps, NamedXContentRegistry.EMPTY, null);, +++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/indexlifecycle/PolicyStepsRegistryTests.java, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(null, firstStepMap, null, null, NamedXContentRegistry.EMPTY, null);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(null, firstStepMap, null, null, NamedXContentRegistry.EMPTY, null);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(null, null, null, indexSteps, NamedXContentRegistry.EMPTY, null);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(null, null, null, indexSteps, NamedXContentRegistry.EMPTY, null);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(null, null, null, Collections.emptyMap(), NamedXContentRegistry.EMPTY, null);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(null, null, null, indexSteps, NamedXContentRegistry.EMPTY, null);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, client);, +        registry.update(currentState);, +            registry.update(currentState);, +        registry.update(currentState);, +        registry.update(currentState);, +    public void testUpdateChangedPolicy() {, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, client);, +        registry.update(currentState);, +        registry.update(currentState);, +        PolicyStepsRegistry registry = new PolicyStepsRegistry(NamedXContentRegistry.EMPTY, client);, +        registry.update(currentState);, +        registry.update(currentState);]