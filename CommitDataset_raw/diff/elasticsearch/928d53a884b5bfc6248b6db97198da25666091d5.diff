[+++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +            List<ShardRouting> shardRoutingsToBeApplied = new ArrayList<>(tasks.size());, +                shardRoutingsToBeApplied.add(task.shardRouting);, +            }, +            ClusterState maybeUpdatedState = currentState;, +                    allocationService.applyStartedShards(currentState, shardRoutingsToBeApplied, true);, +                    maybeUpdatedState = ClusterState.builder(currentState).routingResult(result).build();, +                builder.successes(tasks);, +                builder.failures(tasks, t);, +            return builder.build(maybeUpdatedState);, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +            List<ShardRouting> shardRoutingsToBeApplied = new ArrayList<>(tasks.size());, +                shardRoutingsToBeApplied.add(task.shardRouting);, +            }, +            ClusterState maybeUpdatedState = currentState;, +                    allocationService.applyStartedShards(currentState, shardRoutingsToBeApplied, true);, +                    maybeUpdatedState = ClusterState.builder(currentState).routingResult(result).build();, +                builder.successes(tasks);, +                builder.failures(tasks, t);, +            return builder.build(maybeUpdatedState);, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/allocation/AllocationService.java]