[+++ b/plugin/src/test/java/org/elasticsearch/xpack/monitoring/exporter/local/LocalExporterTests.java, +import org.elasticsearch.search.aggregations.metrics.max.Max;, +import org.joda.time.DateTime;, +import org.joda.time.DateTimeZone;, +import static org.elasticsearch.search.aggregations.AggregationBuilders.max;, +        // We start by disabling the monitoring service, so that no more collection are started, +        // Exporters are still enabled, allowing on-going collections to be exported without errors., +        // This assertion loop waits for in flight exportings to terminate. It checks that the latest, +        // node_stats document collected for each node is at least 10 seconds old, corresponding to, +        // 2 or 3 elapsed collection intervals., +        final int elapsedInSeconds = 10;, +        assertBusy(() -> {, +            refresh(".monitoring-es-2-*");, +            SearchResponse response = client().prepareSearch(".monitoring-es-2-*").setTypes("node_stats").setSize(0), +                    .addAggregation(terms("agg_nodes_ids").field("node_stats.node_id"), +                        .subAggregation(max("agg_last_time_collected").field("timestamp"))), +                    .get();, +            StringTerms aggregation = response.getAggregations().get("agg_nodes_ids");, +            for (String nodeName : internalCluster().getNodeNames()) {, +                String nodeId = internalCluster().clusterService(nodeName).localNode().getId();, +                StringTerms.Bucket bucket = aggregation.getBucketByKey(nodeId);, +                assertTrue(bucket.getDocCount() >= 1L);, +, +                Max subAggregation = bucket.getAggregations().get("agg_last_time_collected");, +                DateTime lastCollection = new DateTime(Math.round(subAggregation.getValue()), DateTimeZone.UTC);, +                assertTrue(lastCollection.plusSeconds(elapsedInSeconds).isBefore(DateTime.now(DateTimeZone.UTC)));, +            }, +        }, 30L, TimeUnit.SECONDS);, +, +        // We can now disable the exporters and reset the settings.]