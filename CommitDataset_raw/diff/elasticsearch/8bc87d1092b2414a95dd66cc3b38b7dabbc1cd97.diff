[+++ b/server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +            IOUtils.close(commits);, +++ b/server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +            IOUtils.close(commits);, +++ b/server/src/test/java/org/elasticsearch/index/seqno/RetentionLeaseIT.java, +                    primary.commitStats().getUserData().get(Engine.RETENTION_LEASES));, +                        replica.commitStats().getUserData().get(Engine.RETENTION_LEASES));, +++ b/server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +            IOUtils.close(commits);, +++ b/server/src/test/java/org/elasticsearch/index/seqno/RetentionLeaseIT.java, +                    primary.commitStats().getUserData().get(Engine.RETENTION_LEASES));, +                        replica.commitStats().getUserData().get(Engine.RETENTION_LEASES));, +++ b/test/framework/src/main/java/org/elasticsearch/test/InternalTestCluster.java, +import org.elasticsearch.index.engine.EngineTestCase;, +        assertNoSnapshottedIndexCommit();, +    private void assertNoSnapshottedIndexCommit() throws Exception {, +        assertBusy(() -> {, +            final Collection<NodeAndClient> nodesAndClients = nodes.values();, +            for (NodeAndClient nodeAndClient : nodesAndClients) {, +                IndicesService indexServices = getInstance(IndicesService.class, nodeAndClient.name);, +                for (IndexService indexService : indexServices) {, +                    for (IndexShard indexShard : indexService) {, +                        try {, +                            Engine engine = IndexShardTestCase.getEngine(indexShard);, +                            if (engine instanceof InternalEngine) {, +                                assertFalse(indexShard.routingEntry().toString() + " has unreleased snapshotted index commits",, +                                    EngineTestCase.hasSnapshottedCommits(engine));, +                            }, +                        } catch (AlreadyClosedException ignored) {, +, +                        }, +                    }, +                }, +            }, +        });, +    }, +]