[+++ b/src/test/java/org/elasticsearch/search/suggest/CompletionSuggestSearchTests.java, +            int maxInputLen = between(3, 50);, +            String str = replaceReservedChars(randomRealisticUnicodeOfCodepointLengthBetween(maxInputLen + 1, atLeast(maxInputLen + 2)), (char) 0x01);, +                    .field("max_input_len", maxInputLen), +            // need to flush and refresh, because we keep changing the same document, +            // we have to make sure that segments without any live documents are deleted, +            flushAndRefresh();, +            int prefixLen = CompletionFieldMapper.correctSubStringLen(str, between(1, maxInputLen - 1));, +            if (maxInputLen + 1 < str.length()) {, +                int offset = Character.isHighSurrogate(str.charAt(maxInputLen - 1)) ? 2 : 1;, +                int correctSubStringLen = CompletionFieldMapper.correctSubStringLen(str, maxInputLen + offset);, +                String shortenedSuggestion = str.substring(0, correctSubStringLen);, +                assertSuggestions(shortenedSuggestion);]