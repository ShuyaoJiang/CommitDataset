[+++ b/server/src/test/java/org/elasticsearch/index/engine/LiveVersionMapTests.java, +import org.apache.lucene.util.Constants;, +        long tolerance;, +        if (Constants.JRE_IS_MINIMUM_JAVA9) {, +            // With Java 9, RamUsageTester computes the memory usage of maps as, +            // the memory usage of an array that would contain exactly all keys, +            // and values. This is an under-estimation of the actual memory, +            // usage since it ignores the impact of the load factor and of the, +            // linked list/tree that is used to resolve collisions. So we use a, +            // bigger tolerance., +            // less than 50% off, +            tolerance = actualRamBytesUsed / 2;, +        } else {, +            // Java 8 is more accurate by doing reflection into the actual JDK classes, +            // so we give it a lower error bound., +            tolerance = actualRamBytesUsed / 4;, +        }, +        assertEquals(actualRamBytesUsed, estimatedRamBytesUsed, tolerance);]