[+++ b/core/src/main/java/org/elasticsearch/search/fetch/subphase/ParentFieldSubFetchPhase.java, +import org.apache.lucene.index.LeafReaderContext;, +import org.apache.lucene.index.ReaderUtil;, +import org.elasticsearch.index.mapper.MapperService;, +import org.elasticsearch.search.SearchHit;, +import java.util.Arrays;, +import java.util.Comparator;, +import java.util.HashSet;, +import java.util.Set;, +    public void hitsExecute(SearchContext context, SearchHit[] hits) throws IOException {, +, +        hits = hits.clone(); // don't modify the incoming hits, +        Arrays.sort(hits, Comparator.comparingInt(SearchHit::docId));, +, +        MapperService mapperService = context.mapperService();, +        Set<String> parentFields = new HashSet<>();, +        for (SearchHit hit : hits) {, +            ParentFieldMapper parentFieldMapper = mapperService.documentMapper(hit.getType()).parentFieldMapper();, +            if (parentFieldMapper.active()) {, +                parentFields.add(parentFieldMapper.name());, +            }, +        }, +, +        int lastReaderId = -1;, +        Map<String, SortedDocValues> docValuesMap = new HashMap<>();, +        for (SearchHit hit : hits) {, +            ParentFieldMapper parentFieldMapper = mapperService.documentMapper(hit.getType()).parentFieldMapper();, +                continue;, +            int readerId = ReaderUtil.subIndex(hit.docId(), context.searcher().getIndexReader().leaves());, +            LeafReaderContext subReaderContext = context.searcher().getIndexReader().leaves().get(readerId);, +            if (lastReaderId != readerId) {, +                docValuesMap.clear();, +                for (String field : parentFields) {, +                    docValuesMap.put(field, subReaderContext.reader().getSortedDocValues(field));, +                }, +                lastReaderId = readerId;, +            }, +            int docId = hit.docId() - subReaderContext.docBase;, +            SortedDocValues values = docValuesMap.get(parentFieldMapper.name());, +            if (values != null && values.advanceExact(docId)) {, +                BytesRef binaryValue = values.binaryValue();, +                String value = binaryValue.length > 0 ? binaryValue.utf8ToString() : null;, +                if (value == null) {, +                    continue;, +                Map<String, DocumentField> fields = hit.fieldsOrNull();, +                    hit.fields(fields);, +                fields.put(ParentFieldMapper.NAME, new DocumentField(ParentFieldMapper.NAME, Collections.singletonList(value)));, +            }, +        }]