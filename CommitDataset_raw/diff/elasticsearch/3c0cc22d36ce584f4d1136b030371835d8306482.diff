[+++ b/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java, + * notifies all {@link #snapshotCompletionListeners} that snapshot is completed, and finally calls {@link #removeSnapshotFromClusterState(SnapshotId, SnapshotInfo, Throwable)} to remove snapshot from cluster state</li>, +                    removeSnapshotFromClusterState(snapshotId, new SnapshotInfo(snapshot), null);, +                    removeSnapshotFromClusterState(snapshotId, null, t);, +     * @param snapshot   snapshot info if snapshot was successful, +     * @param t          exception if snapshot failed, +    private void removeSnapshotFromClusterState(final SnapshotId snapshotId, final SnapshotInfo snapshot, final Throwable t) {, +        clusterService.submitStateUpdateTask("remove snapshot metadata", new ProcessedClusterStateUpdateTask() {, +, +            @Override, +            public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {, +                for (SnapshotCompletionListener listener : snapshotCompletionListeners) {, +                    try {, +                        if (snapshot != null) {, +                            listener.onSnapshotCompletion(snapshotId, snapshot);, +                        } else {, +                            listener.onSnapshotFailure(snapshotId, t);, +                        }, +                    } catch (Throwable t) {, +                        logger.warn("failed to refresh settings for [{}]", t, listener);, +                    }, +                }, +, +            }, +                    } else if (snapshot.state() == State.INIT) {, +                        // snapshot hasn't started yet - end it, +                    } else {, +                        // snapshot is being finalized - wait for it, +                        logger.trace("trying to delete completed snapshot - save to delete");, +                        return currentState;, +                    logger.trace("adding snapshot completion listener to wait for deleted snapshot to finish");, +                            logger.trace("deleted snapshot completed - deleting files");, +                            logger.trace("deleted snapshot failed - deleting files", t);, +                    logger.trace("deleted snapshot is not running - deleting files");]