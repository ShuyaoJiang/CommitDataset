[+++ b/core/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +++ b/core/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +++ b/core/src/main/java/org/elasticsearch/search/fetch/subphase/FetchSourceSubPhase.java, +import org.elasticsearch.common.bytes.BytesReference;, +import org.elasticsearch.common.xcontent.XContentType;, +import org.elasticsearch.search.SearchHit;, +import java.io.UncheckedIOException;, +import java.util.Map;, +, +import static org.elasticsearch.common.xcontent.XContentFactory.contentBuilder;, +        final boolean nestedHit = hitContext.hit().getNestedIdentity() != null;, +        if (nestedHit == false) {, +        }, +        Object value = source.filter(fetchSourceContext);, +        if (nestedHit) {, +            value = getNestedSource((Map<String, Object>) value, hitContext);, +        }, +            final int initialCapacity = nestedHit ? 1024 : Math.min(1024, source.internalSourceRef().length());, +    }, +    private Map<String, Object> getNestedSource(Map<String, Object> sourceAsMap, HitContext hitContext) {, +        for (SearchHit.NestedIdentity o = hitContext.hit().getNestedIdentity(); o != null; o = o.getChild()) {, +            sourceAsMap = (Map<String, Object>) sourceAsMap.get(o.getField().string());, +        }, +        return sourceAsMap;, +++ b/core/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +++ b/core/src/main/java/org/elasticsearch/search/fetch/subphase/FetchSourceSubPhase.java, +import org.elasticsearch.common.bytes.BytesReference;, +import org.elasticsearch.common.xcontent.XContentType;, +import org.elasticsearch.search.SearchHit;, +import java.io.UncheckedIOException;, +import java.util.Map;, +, +import static org.elasticsearch.common.xcontent.XContentFactory.contentBuilder;, +        final boolean nestedHit = hitContext.hit().getNestedIdentity() != null;, +        if (nestedHit == false) {, +        }, +        Object value = source.filter(fetchSourceContext);, +        if (nestedHit) {, +            value = getNestedSource((Map<String, Object>) value, hitContext);, +        }, +            final int initialCapacity = nestedHit ? 1024 : Math.min(1024, source.internalSourceRef().length());, +    }, +    private Map<String, Object> getNestedSource(Map<String, Object> sourceAsMap, HitContext hitContext) {, +        for (SearchHit.NestedIdentity o = hitContext.hit().getNestedIdentity(); o != null; o = o.getChild()) {, +            sourceAsMap = (Map<String, Object>) sourceAsMap.get(o.getField().string());, +        }, +        return sourceAsMap;, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/TopHitsIT.java, +        assertThat(extractValue("date", searchHits.getAt(0).getSourceAsMap()), equalTo(1));, +        assertThat(extractValue("date", searchHits.getAt(0).getSourceAsMap()), equalTo(2));, +        assertThat(extractValue("date", searchHits.getAt(1).getSourceAsMap()), equalTo(3));, +        assertThat(extractValue("date", searchHits.getAt(0).getSourceAsMap()), equalTo(4));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(0).getSourceAsMap()), equalTo("user a"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(1).getSourceAsMap()), equalTo("user b"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(2).getSourceAsMap()), equalTo("user c"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(3).getSourceAsMap()), equalTo("user c"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(4).getSourceAsMap()), equalTo("user d"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(5).getSourceAsMap()), equalTo("user e"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(6).getSourceAsMap()), equalTo("user f"));, +        assertThat(extractValue("message", searchHit.getSourceAsMap()), equalTo("some comment"));, +                assertThat(extractValue("id", searchHits.getAt(j).getSourceAsMap()), equalTo(0));, +++ b/core/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java, +++ b/core/src/main/java/org/elasticsearch/search/fetch/subphase/FetchSourceSubPhase.java, +import org.elasticsearch.common.bytes.BytesReference;, +import org.elasticsearch.common.xcontent.XContentType;, +import org.elasticsearch.search.SearchHit;, +import java.io.UncheckedIOException;, +import java.util.Map;, +, +import static org.elasticsearch.common.xcontent.XContentFactory.contentBuilder;, +        final boolean nestedHit = hitContext.hit().getNestedIdentity() != null;, +        if (nestedHit == false) {, +        }, +        Object value = source.filter(fetchSourceContext);, +        if (nestedHit) {, +            value = getNestedSource((Map<String, Object>) value, hitContext);, +        }, +            final int initialCapacity = nestedHit ? 1024 : Math.min(1024, source.internalSourceRef().length());, +    }, +    private Map<String, Object> getNestedSource(Map<String, Object> sourceAsMap, HitContext hitContext) {, +        for (SearchHit.NestedIdentity o = hitContext.hit().getNestedIdentity(); o != null; o = o.getChild()) {, +            sourceAsMap = (Map<String, Object>) sourceAsMap.get(o.getField().string());, +        }, +        return sourceAsMap;, +++ b/core/src/test/java/org/elasticsearch/search/aggregations/metrics/TopHitsIT.java, +        assertThat(extractValue("date", searchHits.getAt(0).getSourceAsMap()), equalTo(1));, +        assertThat(extractValue("date", searchHits.getAt(0).getSourceAsMap()), equalTo(2));, +        assertThat(extractValue("date", searchHits.getAt(1).getSourceAsMap()), equalTo(3));, +        assertThat(extractValue("date", searchHits.getAt(0).getSourceAsMap()), equalTo(4));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(0).getSourceAsMap()), equalTo("user a"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(1).getSourceAsMap()), equalTo("user b"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(2).getSourceAsMap()), equalTo("user c"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(3).getSourceAsMap()), equalTo("user c"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(4).getSourceAsMap()), equalTo("user d"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(5).getSourceAsMap()), equalTo("user e"));, +        assertThat(extractValue("name", topReviewers.getHits().getAt(6).getSourceAsMap()), equalTo("user f"));, +        assertThat(extractValue("message", searchHit.getSourceAsMap()), equalTo("some comment"));, +                assertThat(extractValue("id", searchHits.getAt(j).getSourceAsMap()), equalTo(0));, +++ b/core/src/test/java/org/elasticsearch/search/fetch/subphase/InnerHitsIT.java, +                .startObject().field("message", "fox eat quick").field("x", "y").endObject()]