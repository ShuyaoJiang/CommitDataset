[+++ b/core/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +import java.util.Comparator;, +import java.util.Queue;, +        class OpAndVersion {, +            final long version;, +            final String removed;, +            final String added;, +, +            OpAndVersion(long version, String removed, String added) {, +                this.version = version;, +                this.removed = removed;, +                this.added = added;, +            }, +        }, +        final Queue<OpAndVersion> history = ConcurrentCollections.newQueue();, +                            history.add(new OpAndVersion(indexResult.getVersion(), removed, added));, +        List<OpAndVersion> sortedHistory = new ArrayList<>(history);, +        sortedHistory.sort(Comparator.comparing(o -> o.version));, +        Set<String> currentValues = new HashSet<>();, +        for (int i = 0; i < sortedHistory.size(); i++) {, +            OpAndVersion op = sortedHistory.get(i);, +            if (i > 0) {, +                assertThat("duplicate version", op.version, not(equalTo(sortedHistory.get(i - 1).version)));, +            }, +            boolean exists = op.removed == null ? true : currentValues.remove(op.removed);, +            assertTrue(op.removed + " should exist", exists);, +            exists = currentValues.add(op.added);, +            assertTrue(op.added + " should not exist", exists);, +        }, +]