[+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java, +    public static final String JOB_AUDIT_DATAFEED_ISOLATED = "Datafeed isolated";, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java, +    public static final String JOB_AUDIT_DATAFEED_ISOLATED = "Datafeed isolated";, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlLifeCycleService.java, +                    datafeedManager.isolateAllDatafeedsOnThisNodeBeforeShutdown();, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java, +    public static final String JOB_AUDIT_DATAFEED_ISOLATED = "Datafeed isolated";, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlLifeCycleService.java, +                    datafeedManager.isolateAllDatafeedsOnThisNodeBeforeShutdown();, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportSetUpgradeModeAction.java, +        logger.info("Un-assigning persistent tasks : " +, +            datafeedAndJobTasks.stream().map(PersistentTask::getId).collect(Collectors.joining(", ", "[ ", " ]")));, +, +        logger.info("Isolating datafeeds: " + datafeedsToIsolate.toString());, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java, +    public static final String JOB_AUDIT_DATAFEED_ISOLATED = "Datafeed isolated";, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlLifeCycleService.java, +                    datafeedManager.isolateAllDatafeedsOnThisNodeBeforeShutdown();, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportSetUpgradeModeAction.java, +        logger.info("Un-assigning persistent tasks : " +, +            datafeedAndJobTasks.stream().map(PersistentTask::getId).collect(Collectors.joining(", ", "[ ", " ]")));, +, +        logger.info("Isolating datafeeds: " + datafeedsToIsolate.toString());, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedManager.java, +    public void isolateAllDatafeedsOnThisNodeBeforeShutdown() {, +            // TODO: it's not ideal that this "isolate" method does something a bit different to the one below, +            next.setNodeIsShuttingDown();, +        // This calls get() rather than remove() because we expect that the persistent task will, +        // be removed shortly afterwards and that operation needs to be able to find the holder, +                if (holder.isIsolated() == false) {, +        private volatile boolean isNodeShuttingDown;, +            if (isNodeShuttingDown) {, +                    auditor.info(datafeedJob.getJobId(),, +                            Messages.getMessage(isIsolated() ? Messages.JOB_AUDIT_DATAFEED_ISOLATED : Messages.JOB_AUDIT_DATAFEED_STOPPED));, +                    if (autoCloseJob && isIsolated() == false) {, +         * This stops a datafeed WITHOUT updating the corresponding persistent task.  When called it, +         * will stop the datafeed from sending data to its job as quickly as possible.  The caller, +         * must do something sensible with the corresponding persistent task.  If the node is shutting, +         * down the task will automatically get reassigned.  Otherwise the caller must take action to, +         * remove or reassign the persistent task, or the datafeed will be left in limbo., +        public void setNodeIsShuttingDown() {, +            isNodeShuttingDown = true;, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java, +    public static final String JOB_AUDIT_DATAFEED_ISOLATED = "Datafeed isolated";, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlLifeCycleService.java, +                    datafeedManager.isolateAllDatafeedsOnThisNodeBeforeShutdown();, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportSetUpgradeModeAction.java, +        logger.info("Un-assigning persistent tasks : " +, +            datafeedAndJobTasks.stream().map(PersistentTask::getId).collect(Collectors.joining(", ", "[ ", " ]")));, +, +        logger.info("Isolating datafeeds: " + datafeedsToIsolate.toString());, +++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedManager.java, +    public void isolateAllDatafeedsOnThisNodeBeforeShutdown() {, +            // TODO: it's not ideal that this "isolate" method does something a bit different to the one below, +            next.setNodeIsShuttingDown();, +        // This calls get() rather than remove() because we expect that the persistent task will, +        // be removed shortly afterwards and that operation needs to be able to find the holder, +                if (holder.isIsolated() == false) {, +        private volatile boolean isNodeShuttingDown;, +            if (isNodeShuttingDown) {, +                    auditor.info(datafeedJob.getJobId(),, +                            Messages.getMessage(isIsolated() ? Messages.JOB_AUDIT_DATAFEED_ISOLATED : Messages.JOB_AUDIT_DATAFEED_STOPPED));, +                    if (autoCloseJob && isIsolated() == false) {, +         * This stops a datafeed WITHOUT updating the corresponding persistent task.  When called it, +         * will stop the datafeed from sending data to its job as quickly as possible.  The caller, +         * must do something sensible with the corresponding persistent task.  If the node is shutting, +         * down the task will automatically get reassigned.  Otherwise the caller must take action to, +         * remove or reassign the persistent task, or the datafeed will be left in limbo., +        public void setNodeIsShuttingDown() {, +            isNodeShuttingDown = true;, +++ b/x-pack/plugin/src/test/resources/rest-api-spec/test/ml/set_upgrade_mode.yml, +          settings:, +            index:, +              number_of_replicas: 0, +              number_of_shards: 1, +      cluster.health:, +        index: airline-data, +        wait_for_status: green, +      ml.start_datafeed:, +        datafeed_id: set-upgrade-mode-job-datafeed, +, +  - do:, +      ml.start_datafeed:, +        datafeed_id: set-upgrade-mode-job-datafeed, +, +  - do:, +      cat.tasks: {}, +  - match:, +      $body: |, +        /.+job.+/, +, +  - do:, +      cat.tasks: {}, +  - match:, +      $body: |, +        /.+datafeed.+/, +, +  - do:, +      ml.start_datafeed:]