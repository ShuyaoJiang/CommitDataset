[+++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +++ b/core/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java, +++ b/core/src/main/java/org/elasticsearch/transport/TcpTransport.java, +        final Optional<Long> first = pendingHandshakes.entrySet().stream(), +            .filter((entry) -> entry.getValue().channel == channel).map((e) -> e.getKey()).findFirst();, +            final Long requestId = first.get();, +            final HandshakeResponseHandler handler = pendingHandshakes.remove(requestId);, +            if (handler != null) {, +                // there might be a race removing this or this method might be called twice concurrently depending on how, +                // the channel is closed ie. due to connection reset or broken pipes, +}]