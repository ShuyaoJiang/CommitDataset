[+++ b/core/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/TermsAggregatorFactory.java, +import org.elasticsearch.search.aggregations.InternalOrder.CompoundOrder;, +    private static boolean isAggregationSort(BucketOrder order) {, +        if (order instanceof InternalOrder.Aggregation) {, +            return true;, +        } else if (order instanceof InternalOrder.CompoundOrder) {, +            InternalOrder.CompoundOrder compoundOrder = (CompoundOrder) order;, +            return compoundOrder.orderElements().stream().anyMatch(TermsAggregatorFactory::isAggregationSort);, +        } else {, +            return false;, +        }, +    }, +, +, +, +                // Finally if we are sorting by sub aggregations, then these, +                // aggregations cannot be deferred, so global_ordinals_hash is, +                // a safer choice as we won't use memory for sub aggregations, +                // for buckets that are not collected., +                        (includeExclude != null && includeExclude.isPartitionBased()) ||, +                        isAggregationSort(order)) {]