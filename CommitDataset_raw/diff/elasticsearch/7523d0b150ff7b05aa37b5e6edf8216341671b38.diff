[+++ b/pom.xml, +        <jackson.version>2.4.3</jackson.version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +++ b/pom.xml, +        <jackson.version>2.4.3</jackson.version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +++ b/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        // CBOR is not supported because it is a binary-only format, +        for (int i = 1; i < length; i++) {, +        // Need minimum of 3 bytes for everything (except really JSON), +        int third = si.read();, +, +        // Cannot short circuit based on third (or later fourth) because "{}" is valid JSON, +        if (first == -1 || second == -1) {, +, +        if (first == SmileConstants.HEADER_BYTE_1 && second == SmileConstants.HEADER_BYTE_2 &&, +            third == SmileConstants.HEADER_BYTE_3) {, +        if (first == '-' && second == '-' && third == '-') {, +, +        // Need 4 bytes for CBOR, +        int fourth = si.read();, +, +        if (first == '{' || second == '{' || third == '{' || fourth == '{') {, +            return XContentType.JSON;, +, +        // ensure that we don't only have two or three bytes (definitely not CBOR and everything else was checked), +        if (third != -1 && fourth != -1) {, +            if (isCBORObjectHeader((byte)first, (byte)second, (byte)third, (byte)fourth)) {, +, +            for (int i = 4; i < GUESS_HEADER_LENGTH; i++) {, +        }, +, +        if (length > 2) {, +            byte second = bytes.get(1);, +            byte third = bytes.get(2);, +, +            if (first == SmileConstants.HEADER_BYTE_1 && second == SmileConstants.HEADER_BYTE_2 && third == SmileConstants.HEADER_BYTE_3) {, +            if (first == '-' && second == '-' && third == '-') {, +            if (length > 3 && isCBORObjectHeader(first, second, third, bytes.get(3))) {, +            // note: technically this only needs length >= 2, but if the string is just " {", then it's not JSON, but, +            //  " {}" is JSON (3 characters), +            for (int i = 1; i < length; i++) {, +        }, +, +    /**, +     * Determine if the specified bytes represent a CBOR encoded stream., +     * <p />, +     * This performs two checks to verify that it is indeed valid/usable CBOR data:, +     * <ol>, +     * <li>Checks the first three bytes for the, +     * {@link CBORConstants#TAG_ID_SELF_DESCRIBE self-identifying CBOR tag (header)}</li>, +     * <li>Checks that the fourth byte represents a major type that is an object, as opposed to some other type (e.g.,, +     * text)</li>, +     * </ol>, +     *, +     * @param first The first byte of the header, +     * @param second The second byte of the header, +     * @param third The third byte of the header, +     * @param fourth The fourth byte represents the <em>first</em> byte of the CBOR data, indicating the data's type, +     *, +     * @return {@code true} if a CBOR byte stream is detected. {@code false} otherwise., +     */, +    private static boolean isCBORObjectHeader(byte first, byte second, byte third, byte fourth) {, +        // Determine if it uses the ID TAG (0xd9f7), then see if it starts with an object (equivalent to, +        //  checking in JSON if it starts with '{'), +        return CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_TAG, first) &&, +               (((second << 8) & 0xff00) | (third & 0xff)) == CBORConstants.TAG_ID_SELF_DESCRIBE &&, +               CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_OBJECT, fourth);, +    }, +++ b/pom.xml, +        <jackson.version>2.4.3</jackson.version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +            <version>${jackson.version}</version>, +++ b/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        // CBOR is not supported because it is a binary-only format, +        for (int i = 1; i < length; i++) {, +        // Need minimum of 3 bytes for everything (except really JSON), +        int third = si.read();, +, +        // Cannot short circuit based on third (or later fourth) because "{}" is valid JSON, +        if (first == -1 || second == -1) {, +, +        if (first == SmileConstants.HEADER_BYTE_1 && second == SmileConstants.HEADER_BYTE_2 &&, +            third == SmileConstants.HEADER_BYTE_3) {, +        if (first == '-' && second == '-' && third == '-') {, +, +        // Need 4 bytes for CBOR, +        int fourth = si.read();, +, +        if (first == '{' || second == '{' || third == '{' || fourth == '{') {, +            return XContentType.JSON;, +]