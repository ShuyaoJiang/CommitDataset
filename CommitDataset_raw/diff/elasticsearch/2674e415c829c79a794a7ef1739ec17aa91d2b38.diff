[+++ b/core/src/main/java/org/elasticsearch/bootstrap/BootstrapCheck.java, +                "max file descriptors [%d] for elasticsearch process is too low, increase to at least [%d]",, +                "max number of threads [%d] for user [%s] is too low, increase to at least [%d]",, +                "max size virtual memory [%d] for user [%s] is too low, increase to [unlimited]",, +                    "max virtual memory areas vm.max_map_count [%d] is too low, increase to at least [%d]",, +++ b/core/src/main/java/org/elasticsearch/bootstrap/BootstrapCheck.java, +                "max file descriptors [%d] for elasticsearch process is too low, increase to at least [%d]",, +                "max number of threads [%d] for user [%s] is too low, increase to at least [%d]",, +                "max size virtual memory [%d] for user [%s] is too low, increase to [unlimited]",, +                    "max virtual memory areas vm.max_map_count [%d] is too low, increase to at least [%d]",, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +    // pkg private so tests can mock, +    Class<? extends ClusterInfoService> clusterInfoServiceImpl = InternalClusterInfoService.class;, +, +        bind(ClusterInfoService.class).to(clusterInfoServiceImpl).asEagerSingleton();, +++ b/core/src/main/java/org/elasticsearch/bootstrap/BootstrapCheck.java, +                "max file descriptors [%d] for elasticsearch process is too low, increase to at least [%d]",, +                "max number of threads [%d] for user [%s] is too low, increase to at least [%d]",, +                "max size virtual memory [%d] for user [%s] is too low, increase to [unlimited]",, +                    "max virtual memory areas vm.max_map_count [%d] is too low, increase to at least [%d]",, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +    // pkg private so tests can mock, +    Class<? extends ClusterInfoService> clusterInfoServiceImpl = InternalClusterInfoService.class;, +, +        bind(ClusterInfoService.class).to(clusterInfoServiceImpl).asEagerSingleton();, +++ b/core/src/main/java/org/elasticsearch/cluster/InternalClusterInfoService.java, +import org.elasticsearch.action.admin.cluster.node.stats.TransportNodesStatsAction;, +import org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction;, +import org.elasticsearch.common.inject.Inject;, +import java.util.List;, +import java.util.concurrent.CopyOnWriteArrayList;, +import java.util.concurrent.CountDownLatch;, +import java.util.concurrent.TimeUnit;, +, +    private final TransportNodesStatsAction transportNodesStatsAction;, +    private final TransportIndicesStatsAction transportIndicesStatsAction;, +    @Inject, +    public InternalClusterInfoService(Settings settings, ClusterSettings clusterSettings,, +                                      TransportNodesStatsAction transportNodesStatsAction,, +                                      TransportIndicesStatsAction transportIndicesStatsAction, ClusterService clusterService,, +                                      ThreadPool threadPool) {, +        this.transportNodesStatsAction = transportNodesStatsAction;, +        this.transportIndicesStatsAction = transportIndicesStatsAction;, +, +        transportNodesStatsAction.execute(nodesStatsRequest, new LatchedActionListener<>(listener, latch));, +        transportIndicesStatsAction.execute(indicesStatsRequest, new LatchedActionListener<>(listener, latch));, +++ b/core/src/main/java/org/elasticsearch/bootstrap/BootstrapCheck.java, +                "max file descriptors [%d] for elasticsearch process is too low, increase to at least [%d]",, +                "max number of threads [%d] for user [%s] is too low, increase to at least [%d]",, +                "max size virtual memory [%d] for user [%s] is too low, increase to [unlimited]",, +                    "max virtual memory areas vm.max_map_count [%d] is too low, increase to at least [%d]",, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +    // pkg private so tests can mock, +    Class<? extends ClusterInfoService> clusterInfoServiceImpl = InternalClusterInfoService.class;, +, +        bind(ClusterInfoService.class).to(clusterInfoServiceImpl).asEagerSingleton();, +++ b/core/src/main/java/org/elasticsearch/cluster/InternalClusterInfoService.java, +import org.elasticsearch.action.admin.cluster.node.stats.TransportNodesStatsAction;, +import org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction;, +import org.elasticsearch.common.inject.Inject;, +import java.util.List;, +import java.util.concurrent.CopyOnWriteArrayList;, +import java.util.concurrent.CountDownLatch;, +import java.util.concurrent.TimeUnit;, +, +    private final TransportNodesStatsAction transportNodesStatsAction;, +    private final TransportIndicesStatsAction transportIndicesStatsAction;, +    @Inject, +    public InternalClusterInfoService(Settings settings, ClusterSettings clusterSettings,, +                                      TransportNodesStatsAction transportNodesStatsAction,, +                                      TransportIndicesStatsAction transportIndicesStatsAction, ClusterService clusterService,, +                                      ThreadPool threadPool) {, +        this.transportNodesStatsAction = transportNodesStatsAction;, +        this.transportIndicesStatsAction = transportIndicesStatsAction;, +, +        transportNodesStatsAction.execute(nodesStatsRequest, new LatchedActionListener<>(listener, latch));, +        transportIndicesStatsAction.execute(indicesStatsRequest, new LatchedActionListener<>(listener, latch));, +++ b/core/src/main/java/org/elasticsearch/discovery/DiscoveryModule.java, +    private final ZenPing zenPing;, +        zenPing = createZenPing.apply(hostsProvider);, +, +    // TODO: remove this, it should be completely local to discovery, but service disruption tests want to mess with it, +    public ZenPing getZenPing() {, +        return zenPing;, +    }, +++ b/core/src/main/java/org/elasticsearch/bootstrap/BootstrapCheck.java, +                "max file descriptors [%d] for elasticsearch process is too low, increase to at least [%d]",, +                "max number of threads [%d] for user [%s] is too low, increase to at least [%d]",, +                "max size virtual memory [%d] for user [%s] is too low, increase to [unlimited]",, +                    "max virtual memory areas vm.max_map_count [%d] is too low, increase to at least [%d]",, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +    // pkg private so tests can mock, +    Class<? extends ClusterInfoService> clusterInfoServiceImpl = InternalClusterInfoService.class;, +, +        bind(ClusterInfoService.class).to(clusterInfoServiceImpl).asEagerSingleton();, +++ b/core/src/main/java/org/elasticsearch/cluster/InternalClusterInfoService.java, +import org.elasticsearch.action.admin.cluster.node.stats.TransportNodesStatsAction;, +import org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction;, +import org.elasticsearch.common.inject.Inject;, +import java.util.List;]