[+++ b/plugin/src/main/java/org/elasticsearch/xpack/common/text/TextTemplateEngine.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = service.compileTemplate(script, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(model).utf8ToString();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/common/text/TextTemplateEngine.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = service.compileTemplate(script, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(model).utf8ToString();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authz/accesscontrol/SecurityIndexSearcherWrapper.java, +import org.elasticsearch.template.CompiledTemplate;, +                CompiledTemplate compiledTemplate = scriptService.compileTemplate(script, ScriptContext.Standard.SEARCH);, +                return compiledTemplate.run(script.getParams());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/common/text/TextTemplateEngine.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = service.compileTemplate(script, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(model).utf8ToString();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authz/accesscontrol/SecurityIndexSearcherWrapper.java, +import org.elasticsearch.template.CompiledTemplate;, +                CompiledTemplate compiledTemplate = scriptService.compileTemplate(script, ScriptContext.Standard.SEARCH);, +                return compiledTemplate.run(script.getParams());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/watcher/support/search/WatcherSearchTemplateService.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = scriptService.compileTemplate(template, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(template.getParams());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/common/text/TextTemplateEngine.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = service.compileTemplate(script, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(model).utf8ToString();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authz/accesscontrol/SecurityIndexSearcherWrapper.java, +import org.elasticsearch.template.CompiledTemplate;, +                CompiledTemplate compiledTemplate = scriptService.compileTemplate(script, ScriptContext.Standard.SEARCH);, +                return compiledTemplate.run(script.getParams());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/watcher/support/search/WatcherSearchTemplateService.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = scriptService.compileTemplate(template, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(template.getParams());, +++ b/plugin/src/test/java/org/elasticsearch/xpack/common/text/TextTemplateTests.java, +import org.elasticsearch.common.bytes.BytesArray;, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = templateParams -> new BytesArray("rendered_text");, +        when(service.compileTemplate(new Script(type, lang, templateText,, +                merged), Watcher.SCRIPT_CONTEXT)).thenReturn(compiledTemplate);, +        CompiledTemplate compiledTemplate = templateParams -> new BytesArray("rendered_text");, +        when(service.compileTemplate(new Script(type, lang, templateText,, +                model), Watcher.SCRIPT_CONTEXT)).thenReturn(compiledTemplate);, +        CompiledTemplate compiledTemplate = templateParams -> new BytesArray("rendered_text");, +        when(service.compileTemplate(new Script(ScriptType.INLINE, lang, templateText,, +                .thenReturn(compiledTemplate);, +++ b/plugin/src/main/java/org/elasticsearch/xpack/common/text/TextTemplateEngine.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = service.compileTemplate(script, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(model).utf8ToString();, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authz/accesscontrol/SecurityIndexSearcherWrapper.java, +import org.elasticsearch.template.CompiledTemplate;, +                CompiledTemplate compiledTemplate = scriptService.compileTemplate(script, ScriptContext.Standard.SEARCH);, +                return compiledTemplate.run(script.getParams());, +++ b/plugin/src/main/java/org/elasticsearch/xpack/watcher/support/search/WatcherSearchTemplateService.java, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = scriptService.compileTemplate(template, Watcher.SCRIPT_CONTEXT);, +        return compiledTemplate.run(template.getParams());, +++ b/plugin/src/test/java/org/elasticsearch/xpack/common/text/TextTemplateTests.java, +import org.elasticsearch.common.bytes.BytesArray;, +import org.elasticsearch.template.CompiledTemplate;, +        CompiledTemplate compiledTemplate = templateParams -> new BytesArray("rendered_text");, +        when(service.compileTemplate(new Script(type, lang, templateText,, +                merged), Watcher.SCRIPT_CONTEXT)).thenReturn(compiledTemplate);, +        CompiledTemplate compiledTemplate = templateParams -> new BytesArray("rendered_text");, +        when(service.compileTemplate(new Script(type, lang, templateText,, +                model), Watcher.SCRIPT_CONTEXT)).thenReturn(compiledTemplate);, +        CompiledTemplate compiledTemplate = templateParams -> new BytesArray("rendered_text");, +        when(service.compileTemplate(new Script(ScriptType.INLINE, lang, templateText,, +                .thenReturn(compiledTemplate);, +++ b/plugin/src/test/java/org/elasticsearch/xpack/watcher/transform/script/ScriptTransformTests.java, +import org.elasticsearch.common.bytes.BytesArray;, +import org.elasticsearch.template.CompiledTemplate;, +        when(scriptService.compileTemplate(anyObject(), eq(Watcher.SCRIPT_CONTEXT))).thenThrow(scriptException);]