[+++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequestBuilder.java, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequestBuilder.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequestBuilder.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequestBuilder.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java, +import com.google.common.base.Predicate;, +        return allSatisfyingPredicateShardsGrouped(indices, includeEmpty, includeRelocationTargets, ACTIVE_PREDICATE);, +        return allSatisfyingPredicateShardsGrouped(indices, includeEmpty, includeRelocationTargets, ASSIGNED_PREDICATE);, +    }, +, +    private static Predicate<ShardRouting> ACTIVE_PREDICATE = new Predicate<ShardRouting>() {, +        @Override, +        public boolean apply(ShardRouting shardRouting) {, +            return shardRouting.active();, +        }, +    };, +, +    private static Predicate<ShardRouting> ASSIGNED_PREDICATE = new Predicate<ShardRouting>() {, +        @Override, +        public boolean apply(ShardRouting shardRouting) {, +            return shardRouting.assignedToNode();, +        }, +    };, +, +    // TODO: replace with JDK 8 native java.util.function.Predicate, +    private GroupShardsIterator allSatisfyingPredicateShardsGrouped(String[] indices, boolean includeEmpty, boolean includeRelocationTargets, Predicate<ShardRouting> predicate) {, +                    if (predicate.apply(shardRouting)) {, +++ b/core/src/main/java/org/apache/lucene/queryparser/classic/QueryParserSettings.java, +++ b/core/src/main/java/org/elasticsearch/action/admin/indices/validate/query/TransportValidateQueryAction.java, +            searchContext.close();, +++ b/core/src/main/java/org/elasticsearch/action/exists/TransportExistsAction.java, +                boolean exists = Lucene.exists(context, context.query(), Lucene.createExistsCollector());, +                return new ShardExistsResponse(request.shardId(), exists);, +++ b/core/src/main/java/org/elasticsearch/action/support/broadcast/TransportBroadcastAction.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequestBuilder.java, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateHelper.java]