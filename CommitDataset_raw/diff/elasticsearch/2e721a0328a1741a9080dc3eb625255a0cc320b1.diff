[+++ b/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java, +import org.elasticsearch.cluster.*;, +import org.elasticsearch.common.util.concurrent.*;, +import java.util.*;, +import java.util.concurrent.*;, +            executionResult.handle(() -> proccessedListeners.add(updateTask), ex -> updateTask.listener.onFailure(updateTask.source, ex));, +++ b/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java, +import org.elasticsearch.cluster.*;, +import org.elasticsearch.common.util.concurrent.*;, +import java.util.*;, +import java.util.concurrent.*;, +            executionResult.handle(() -> proccessedListeners.add(updateTask), ex -> updateTask.listener.onFailure(updateTask.source, ex));, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScoreFunctionParserMapper.java, +import org.elasticsearch.common.io.stream.NamedWriteable;, +    private static void addParser(ScoreFunctionParser<? extends ScoreFunctionBuilder> scoreFunctionParser, Map<String, ScoreFunctionParser<?>> map, NamedWriteableRegistry namedWriteableRegistry) {, +        @SuppressWarnings("unchecked") NamedWriteable<? extends ScoreFunctionBuilder> sfb = scoreFunctionParser.getBuilderPrototype();, +        namedWriteableRegistry.registerPrototype(ScoreFunctionBuilder.class, sfb);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java, +import org.elasticsearch.cluster.*;, +import org.elasticsearch.common.util.concurrent.*;, +import java.util.*;, +import java.util.concurrent.*;, +            executionResult.handle(() -> proccessedListeners.add(updateTask), ex -> updateTask.listener.onFailure(updateTask.source, ex));, +++ b/core/src/main/java/org/elasticsearch/index/query/functionscore/ScoreFunctionParserMapper.java, +import org.elasticsearch.common.io.stream.NamedWriteable;, +    private static void addParser(ScoreFunctionParser<? extends ScoreFunctionBuilder> scoreFunctionParser, Map<String, ScoreFunctionParser<?>> map, NamedWriteableRegistry namedWriteableRegistry) {, +        @SuppressWarnings("unchecked") NamedWriteable<? extends ScoreFunctionBuilder> sfb = scoreFunctionParser.getBuilderPrototype();, +        namedWriteableRegistry.registerPrototype(ScoreFunctionBuilder.class, sfb);, +++ b/core/src/main/java/org/elasticsearch/indices/query/IndicesQueriesRegistry.java, +import org.elasticsearch.common.io.stream.NamedWriteable;, +        for (@SuppressWarnings("unchecked") QueryParser<? extends QueryBuilder> queryParser : injectedQueryParsers) {, +            @SuppressWarnings("unchecked") NamedWriteable<? extends QueryBuilder> qb = queryParser.getBuilderPrototype();, +            namedWriteableRegistry.registerPrototype(QueryBuilder.class, qb);]