[+++ b/core/src/main/java/org/elasticsearch/bootstrap/Security.java, +import org.elasticsearch.Build;, +import org.elasticsearch.Version;, +import java.util.ArrayList;, +import java.util.List;, +            List<String> propertiesSet = new ArrayList<>();, +                    String property = "codebase." + shortName;, +                    if (shortName.startsWith("elasticsearch-rest-client")) {, +                        // The rest client is currently the only example where we have an elasticsearch built artifact, +                        // which needs special permissions in policy files when used. This temporary solution is to, +                        // pass in an extra system property that omits the -version.jar suffix the other properties have., +                        // That allows the snapshots to reference snapshot builds of the client, and release builds to, +                        // referenced release builds of the client, all with the same grant statements., +                        final String esVersion = Version.CURRENT + (Build.CURRENT.isSnapshot() ? "-SNAPSHOT" : "");, +                        final int index = property.indexOf("-" + esVersion + ".jar");, +                        assert index >= 0;, +                        String restClientAlias = property.substring(0, index);, +                        propertiesSet.add(restClientAlias);, +                        System.setProperty(restClientAlias, url.toString());, +                    }, +                    propertiesSet.add(property);, +                    String previous = System.setProperty(property, url.toString());, +                for (String property : propertiesSet) {, +                    System.clearProperty(property);, +++ b/core/src/main/java/org/elasticsearch/bootstrap/Security.java, +import org.elasticsearch.Build;, +import org.elasticsearch.Version;, +import java.util.ArrayList;, +import java.util.List;, +            List<String> propertiesSet = new ArrayList<>();, +                    String property = "codebase." + shortName;, +                    if (shortName.startsWith("elasticsearch-rest-client")) {, +                        // The rest client is currently the only example where we have an elasticsearch built artifact, +                        // which needs special permissions in policy files when used. This temporary solution is to, +                        // pass in an extra system property that omits the -version.jar suffix the other properties have., +                        // That allows the snapshots to reference snapshot builds of the client, and release builds to, +                        // referenced release builds of the client, all with the same grant statements., +                        final String esVersion = Version.CURRENT + (Build.CURRENT.isSnapshot() ? "-SNAPSHOT" : "");, +                        final int index = property.indexOf("-" + esVersion + ".jar");, +                        assert index >= 0;, +                        String restClientAlias = property.substring(0, index);, +                        propertiesSet.add(restClientAlias);, +                        System.setProperty(restClientAlias, url.toString());, +                    }, +                    propertiesSet.add(property);, +                    String previous = System.setProperty(property, url.toString());, +                for (String property : propertiesSet) {, +                    System.clearProperty(property);, +++ b/core/src/main/resources/org/elasticsearch/bootstrap/test-framework.policy, +grant codeBase "${codebase.elasticsearch-rest-client}" {, +++ b/core/src/main/java/org/elasticsearch/bootstrap/Security.java, +import org.elasticsearch.Build;, +import org.elasticsearch.Version;, +import java.util.ArrayList;, +import java.util.List;, +            List<String> propertiesSet = new ArrayList<>();, +                    String property = "codebase." + shortName;, +                    if (shortName.startsWith("elasticsearch-rest-client")) {, +                        // The rest client is currently the only example where we have an elasticsearch built artifact, +                        // which needs special permissions in policy files when used. This temporary solution is to, +                        // pass in an extra system property that omits the -version.jar suffix the other properties have., +                        // That allows the snapshots to reference snapshot builds of the client, and release builds to, +                        // referenced release builds of the client, all with the same grant statements., +                        final String esVersion = Version.CURRENT + (Build.CURRENT.isSnapshot() ? "-SNAPSHOT" : "");, +                        final int index = property.indexOf("-" + esVersion + ".jar");, +                        assert index >= 0;, +                        String restClientAlias = property.substring(0, index);, +                        propertiesSet.add(restClientAlias);, +                        System.setProperty(restClientAlias, url.toString());, +                    }, +                    propertiesSet.add(property);, +                    String previous = System.setProperty(property, url.toString());, +                for (String property : propertiesSet) {, +                    System.clearProperty(property);, +++ b/core/src/main/resources/org/elasticsearch/bootstrap/test-framework.policy, +grant codeBase "${codebase.elasticsearch-rest-client}" {, +++ b/modules/reindex/src/main/plugin-metadata/plugin-security.policy, +grant codeBase "${codebase.elasticsearch-rest-client}" {]