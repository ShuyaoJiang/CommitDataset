[+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java, +import org.apache.http.util.EntityUtils;, +import org.elasticsearch.client.Request;, +import org.elasticsearch.client.RequestOptions;, +import static org.hamcrest.Matchers.not;, +        Request request = new Request("PUT", "/_xpack/security/role/test_data_access");, +        request.setJsonEntity("{", +                + "}");, +        client().performRequest(request);, +        Request request = new Request("PUT", "/_xpack/security/user/" + user);, +        request.setJsonEntity("{", +                + "}");, +        client().performRequest(request);, +        StringBuilder bulk = new StringBuilder();, +, +        Request createEmptyAirlineDataRequest = new Request("PUT", "/airline-data-empty");, +        createEmptyAirlineDataRequest.setJsonEntity("{", +                + "}");, +        client().performRequest(createEmptyAirlineDataRequest);, +        Request createAirlineDataRequest = new Request("PUT", "/airline-data");, +        createAirlineDataRequest.setJsonEntity("{", +                + "}");, +        client().performRequest(createAirlineDataRequest);, +        bulk.append("{\"index\": {\"_index\": \"airline-data\", \"_type\": \"response\", \"_id\": 1}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:00:00Z\",\"airline\":\"AAA\",\"responsetime\":135.22}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data\", \"_type\": \"response\", \"_id\": 2}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:59:00Z\",\"airline\":\"AAA\",\"responsetime\":541.76}\n");, +        Request createAirlineDataDisabledDocValues = new Request("PUT", "/airline-data-disabled-doc-values");, +        createAirlineDataDisabledDocValues.setJsonEntity("{", +                + "}");, +        client().performRequest(createAirlineDataDisabledDocValues);, +        bulk.append("{\"index\": {\"_index\": \"airline-data-disabled-doc-values\", \"_type\": \"response\", \"_id\": 1}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:00:00Z\",\"airline\":\"AAA\",\"responsetime\":135.22}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-disabled-doc-values\", \"_type\": \"response\", \"_id\": 2}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:59:00Z\",\"airline\":\"AAA\",\"responsetime\":541.76}\n");, +        Request createAirlineDataDisabledSource = new Request("PUT", "/airline-data-disabled-source");, +        createAirlineDataDisabledSource.setJsonEntity("{", +                + "}");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-disabled-source\", \"_type\": \"response\", \"_id\": 1}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:00:00Z\",\"airline\":\"AAA\",\"responsetime\":135.22}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-disabled-source\", \"_type\": \"response\", \"_id\": 2}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:59:00Z\",\"airline\":\"AAA\",\"responsetime\":541.76}\n");, +        Request createAirlineDataNested = new Request("PUT", "/nested-data");, +        createAirlineDataNested.setJsonEntity("{", +                + "}");, +        client().performRequest(createAirlineDataNested);, +        bulk.append("{\"index\": {\"_index\": \"nested-data\", \"_type\": \"response\", \"_id\": 1}}\n");, +        bulk.append("{\"time\":\"2016-06-01T00:00:00Z\", \"responsetime\":{\"millis\":135.22}}\n");, +        bulk.append("{\"index\": {\"_index\": \"nested-data\", \"_type\": \"response\", \"_id\": 2}}\n");, +        bulk.append("{\"time\":\"2016-06-01T01:59:00Z\",\"responsetime\":{\"millis\":222.0}}\n");, +        Request createAirlineDataAggs = new Request("PUT", "/airline-data-aggs");, +        createAirlineDataAggs.setJsonEntity("{", +                + "}");, +        client().performRequest(createAirlineDataAggs);, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 1}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:00:00Z\",\"airline\":\"AAA\",\"responsetime\":100.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 2}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:01:00Z\",\"airline\":\"AAA\",\"responsetime\":200.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 3}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:00:00Z\",\"airline\":\"BBB\",\"responsetime\":1000.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 4}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T00:01:00Z\",\"airline\":\"BBB\",\"responsetime\":2000.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 5}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:00:00Z\",\"airline\":\"AAA\",\"responsetime\":300.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 6}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:01:00Z\",\"airline\":\"AAA\",\"responsetime\":400.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 7}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:00:00Z\",\"airline\":\"BBB\",\"responsetime\":3000.0}\n");, +        bulk.append("{\"index\": {\"_index\": \"airline-data-aggs\", \"_type\": \"response\", \"_id\": 8}}\n");, +        bulk.append("{\"time stamp\":\"2016-06-01T01:01:00Z\",\"airline\":\"BBB\",\"responsetime\":4000.0}\n");, +        bulkIndex(bulk.toString());, +        Request createIndexRequest = new Request("PUT", index);, +        createIndexRequest.setJsonEntity("{", +                + "}");;, +        client().performRequest(createIndexRequest);, +        StringBuilder bulk = new StringBuilder();, +            bulk.append("{\"index\": {\"_index\": \"").append(index).append("\", \"_type\": \"doc\"}}\n");, +            bulk.append(String.format(Locale.ROOT, docTemplate, date.getTime(), "hostA", byteCount)).append('\n');, +            bulk.append("{\"index\": {\"_index\": \"").append(index).append("\", \"_type\": \"doc\"}}\n");, +            bulk.append(String.format(Locale.ROOT, docTemplate, date.getTime(), "hostB", byteCount)).append('\n');, +        bulkIndex(bulk.toString());, +        Request createJobRequest = new Request("PUT", MachineLearning.BASE_PATH + "anomaly_detectors/" + jobId);, +        createJobRequest.setJsonEntity("{\n", +                + "  \"description\": \"Nested job\",\n", +                + "  \"analysis_config\": {\n", +                + "    \"bucket_span\": \"1h\",\n", +                + "    \"detectors\": [\n", +                + "      {\n", +                + "        \"function\": \"mean\",\n", +                + "        \"field_name\": \"responsetime.millis\"\n", +                + "      }\n", +                + "    ]\n", +                + "  },", +                + "  \"data_description\": {\"time_field\": \"time\"}\n", +                + "}");, +        client().performRequest(createJobRequest);, +        Response jobStatsResponse = client().performRequest(, +                new Request("GET", MachineLearning.BASE_PATH + "anomaly_detectors/" + jobId + "/_stats"));, +        String jobStatsResponseAsString = EntityUtils.toString(jobStatsResponse.getEntity());, +        Request createJobRequest = new Request("PUT", MachineLearning.BASE_PATH + "anomaly_detectors/" + jobId);]