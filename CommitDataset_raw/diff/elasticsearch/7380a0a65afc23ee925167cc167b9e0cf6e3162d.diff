[+++ b/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadTests.java, +            logger.info("--> waiting for 15000 docs to be indexed ...");, +            logger.info("--> 15000 docs indexed");, +        final long[] lastKnownCount = {-1};, +        long lastStartCount = -1;, +        Predicate<Object> testDocs = new Predicate<Object>() {, +                lastKnownCount[0] = client().prepareCount().setQuery(matchAllQuery()).execute().actionGet().getCount();, +                logger.debug("[{}] docs visible for search. waiting for [{}]", lastKnownCount[0], numDocs);, +                return lastKnownCount[0] > numDocs;, +        };, +        // 5 minutes seems like a long time but while relocating,    indexing threads can wait for up to ~1m before retrying when, +        // they first try to index into a shard which is not STARTED., +        while (!awaitBusy(testDocs, 5, TimeUnit.MINUTES)) {, +            if (lastStartCount == lastKnownCount[0]) {, +                // we didn't make any progress, +                fail("failed to reach " + numDocs + "docs");, +            }, +            lastStartCount = lastKnownCount[0];, +        }]