[+++ b/server/src/test/java/org/elasticsearch/discovery/ClusterDisruptionIT.java, +++ b/server/src/test/java/org/elasticsearch/discovery/ClusterDisruptionIT.java, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESIntegTestCase.java, +import java.util.function.BiFunction;, +        final BiFunction<ClusterState, ShardRouting, IndexShard> getInstanceShardInstance = (clusterState, shardRouting) -> {, +            if (shardRouting.assignedToNode() == false) {, +                return null;, +            }, +            final DiscoveryNode assignedNode = clusterState.nodes().get(shardRouting.currentNodeId());, +            if (assignedNode == null) {, +                return null;, +            }, +            return internalCluster().getInstance(IndicesService.class, assignedNode.getName()).getShardOrNull(shardRouting.shardId());, +        };, +                    if (primaryShardRouting == null) {, +                    final IndexShard primaryShard = getInstanceShardInstance.apply(state, primaryShardRouting);, +                    if (primaryShard == null) {, +                        continue; //just ignore - shard movement, +                    }, +                        final IndexShard replicaShard = getInstanceShardInstance.apply(state, replicaShardRouting);, +                        if (replicaShard == null) {, +                            continue; //just ignore - shard movement]