[+++ b/src/main/java/org/elasticsearch/common/io/PathUtils.java, +    /** can be changed by tests (via reflection) */, +    private static volatile FileSystem DEFAULT = ACTUAL_DEFAULT;, +++ b/src/main/java/org/elasticsearch/common/io/PathUtils.java, +    /** can be changed by tests (via reflection) */, +    private static volatile FileSystem DEFAULT = ACTUAL_DEFAULT;, +++ b/src/test/java/org/elasticsearch/test/ElasticsearchTestCase.java, +, +import java.nio.file.FileSystem;, +    , +    , +    , +        FileSystem mock = LuceneTestCase.getBaseTempDirForTestClass().getFileSystem();, +        field.set(null, mock);, +        assertEquals(mock, PathUtils.getDefaultFileSystem());, +    , +    , +    , +    , +    , +    , +    , +    // check some things (like MockDirectoryWrappers) are closed where we currently, +    // manage them. TODO: can we add these to LuceneTestCase.closeAfterSuite directly?, +    // or something else simpler instead of the fake closeables?, +    , +    // mockdirectorywrappers currently set this boolean if checkindex fails, +    // TODO: can we do this cleaner???, +    , +    , +    ]