[+++ b/pom.xml, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +++ b/pom.xml, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +++ b/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        byte first = (byte) si.read();, +        byte second = (byte) si.read();, +        // CBOR logic similar to CBORFactory#hasCBORFormat, +        if (first == CBORConstants.BYTE_OBJECT_INDEFINITE){, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_TAG, first)) {, +            // Actually, specific "self-describe tag" is a very good indicator, +            int third = si.read();, +            if (third == -1) {, +                return null;, +            }, +            if (first == (byte) 0xD9 && second == (byte) 0xD9 && third == (byte) 0xF7) {, +                return XContentType.CBOR;, +            }, +        }, +        // for small objects, some encoders just encode as major type object, we can safely, +        // say its CBOR since it doesn't contradict SMILE or JSON, and its a last resort, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_OBJECT, first)) {, +            return XContentType.CBOR;, +        }, +, +        // CBOR logic similar to CBORFactory#hasCBORFormat, +        if (first == CBORConstants.BYTE_OBJECT_INDEFINITE && length > 1){, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_TAG, first) && length > 2) {, +            // Actually, specific "self-describe tag" is a very good indicator, +            if (first == (byte) 0xD9 && bytes.get(1) == (byte) 0xD9 && bytes.get(2) == (byte) 0xF7) {, +                return XContentType.CBOR;, +            }, +        }, +        // for small objects, some encoders just encode as major type object, we can safely, +        // say its CBOR since it doesn't contradict SMILE or JSON, and its a last resort, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_OBJECT, first)) {, +            return XContentType.CBOR;, +        }, +, +        // a last chance for JSON, +++ b/pom.xml, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +            <version>2.4.4</version>, +++ b/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        byte first = (byte) si.read();, +        byte second = (byte) si.read();, +        // CBOR logic similar to CBORFactory#hasCBORFormat, +        if (first == CBORConstants.BYTE_OBJECT_INDEFINITE){, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_TAG, first)) {, +            // Actually, specific "self-describe tag" is a very good indicator, +            int third = si.read();, +            if (third == -1) {, +                return null;, +            }, +            if (first == (byte) 0xD9 && second == (byte) 0xD9 && third == (byte) 0xF7) {, +                return XContentType.CBOR;, +            }, +        }, +        // for small objects, some encoders just encode as major type object, we can safely, +        // say its CBOR since it doesn't contradict SMILE or JSON, and its a last resort, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_OBJECT, first)) {, +            return XContentType.CBOR;, +        }, +, +        // CBOR logic similar to CBORFactory#hasCBORFormat, +        if (first == CBORConstants.BYTE_OBJECT_INDEFINITE && length > 1){, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_TAG, first) && length > 2) {, +            // Actually, specific "self-describe tag" is a very good indicator, +            if (first == (byte) 0xD9 && bytes.get(1) == (byte) 0xD9 && bytes.get(2) == (byte) 0xF7) {, +                return XContentType.CBOR;, +            }, +        }, +        // for small objects, some encoders just encode as major type object, we can safely, +        // say its CBOR since it doesn't contradict SMILE or JSON, and its a last resort, +        if (CBORConstants.hasMajorType(CBORConstants.MAJOR_TYPE_OBJECT, first)) {, +            return XContentType.CBOR;, +        }, +, +        // a last chance for JSON, +++ b/src/test/java/org/elasticsearch/common/xcontent/XContentFactoryTests.java, +import com.fasterxml.jackson.dataformat.cbor.CBORConstants;, +import com.fasterxml.jackson.dataformat.smile.SmileConstants;, +import java.io.ByteArrayInputStream;, +, +    public void testCBORBasedOnMajorObjectDetection() {, +        // for this {"f "=> 5} perl encoder for example generates:, +        byte[] bytes = new byte[] {(byte) 0xA1, (byte) 0x43, (byte) 0x66, (byte) 6f, (byte) 6f, (byte) 0x5};, +        assertThat(XContentFactory.xContentType(bytes), equalTo(XContentType.CBOR));, +        //assertThat(((Number) XContentHelper.convertToMap(bytes, true).v2().get("foo")).intValue(), equalTo(5));, +, +        // this if for {"foo" : 5} in python CBOR, +        bytes = new byte[] {(byte) 0xA1, (byte) 0x63, (byte) 0x66, (byte) 0x6f, (byte) 0x6f, (byte) 0x5};]