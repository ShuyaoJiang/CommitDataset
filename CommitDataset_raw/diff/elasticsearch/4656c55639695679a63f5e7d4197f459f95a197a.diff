[+++ b/buildSrc/src/main/groovy/org/elasticsearch/gradle/BuildPlugin.groovy, +import org.eclipse.jgit.lib.Constants, +import org.eclipse.jgit.lib.RepositoryBuilder, +                } else {, +                    /*, +                     * The info-scm plugin assumes that if GIT_COMMIT is set it was set by Jenkins to the commit hash for this build., +                     * However, that assumption is wrong as this build could be a sub-build of another Jenkins build for which GIT_COMMIT, +                     * is the commit hash for that build. Therefore, if GIT_COMMIT is set we calculate the commit hash ourselves., +                     */, +                    if (System.getenv("GIT_COMMIT") != null) {, +                        final String hash = new RepositoryBuilder().findGitDir(project.buildDir).build().resolve(Constants.HEAD).name, +                        final String shortHash = hash?.substring(0, 7), +                        jarTask.manifest.attributes('Change': shortHash), +                    }]