[+++ b/src/main/java/org/elasticsearch/discovery/Discovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +     * Another hack to solve dep injection problem..., note, this will be called before, +     * any start is called., +     */, +    void setAllocationService(AllocationService allocationService);, +, +    /**, +++ b/src/main/java/org/elasticsearch/discovery/Discovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +     * Another hack to solve dep injection problem..., note, this will be called before, +     * any start is called., +     */, +    void setAllocationService(AllocationService allocationService);, +, +    /**, +++ b/src/main/java/org/elasticsearch/discovery/local/LocalDiscovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +    private AllocationService allocationService;, +, +    public void setAllocationService(AllocationService allocationService) {, +        this.allocationService = allocationService;, +    }, +, +    @Override, +                        // reroute here, so we eagerly remove dead nodes from the routing, +                        ClusterState updatedState = newClusterStateBuilder().state(currentState).nodes(newNodes).build();, +                        RoutingAllocation.Result routingResult = allocationService.reroute(newClusterStateBuilder().state(updatedState).build());, +                        return newClusterStateBuilder().state(updatedState).routingResult(routingResult).build();, +++ b/src/main/java/org/elasticsearch/discovery/Discovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +     * Another hack to solve dep injection problem..., note, this will be called before, +     * any start is called., +     */, +    void setAllocationService(AllocationService allocationService);, +, +    /**, +++ b/src/main/java/org/elasticsearch/discovery/local/LocalDiscovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +    private AllocationService allocationService;, +, +    public void setAllocationService(AllocationService allocationService) {, +        this.allocationService = allocationService;, +    }, +, +    @Override, +                        // reroute here, so we eagerly remove dead nodes from the routing, +                        ClusterState updatedState = newClusterStateBuilder().state(currentState).nodes(newNodes).build();, +                        RoutingAllocation.Result routingResult = allocationService.reroute(newClusterStateBuilder().state(updatedState).build());, +                        return newClusterStateBuilder().state(updatedState).routingResult(routingResult).build();, +++ b/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +    private AllocationService allocationService;, +, +    public void setAllocationService(AllocationService allocationService) {, +        this.allocationService = allocationService;, +    }, +, +    @Override, +                    // eagerly run reroute to remove dead nodes from routing table, +                    RoutingAllocation.Result routingResult = allocationService.reroute(newClusterStateBuilder().state(currentState).build());, +                    return newClusterStateBuilder().state(currentState).routingResult(routingResult).build();, +                // eagerly run reroute to remove dead nodes from routing table, +                RoutingAllocation.Result routingResult = allocationService.reroute(newClusterStateBuilder().state(currentState).build());, +                return newClusterStateBuilder().state(currentState).routingResult(routingResult).build();, +++ b/src/main/java/org/elasticsearch/discovery/Discovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +     * Another hack to solve dep injection problem..., note, this will be called before, +     * any start is called., +     */, +    void setAllocationService(AllocationService allocationService);, +, +    /**, +++ b/src/main/java/org/elasticsearch/discovery/local/LocalDiscovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +    private AllocationService allocationService;, +, +    public void setAllocationService(AllocationService allocationService) {, +        this.allocationService = allocationService;, +    }, +, +    @Override, +                        // reroute here, so we eagerly remove dead nodes from the routing, +                        ClusterState updatedState = newClusterStateBuilder().state(currentState).nodes(newNodes).build();, +                        RoutingAllocation.Result routingResult = allocationService.reroute(newClusterStateBuilder().state(updatedState).build());, +                        return newClusterStateBuilder().state(updatedState).routingResult(routingResult).build();, +++ b/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +    private AllocationService allocationService;, +, +    public void setAllocationService(AllocationService allocationService) {, +        this.allocationService = allocationService;, +    }, +, +    @Override]