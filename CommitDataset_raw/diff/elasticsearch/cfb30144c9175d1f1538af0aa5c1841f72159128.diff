[+++ b/modules/analysis-common/src/test/resources/rest-api-spec/test/analysis-common/40_token_filters.yml, +, +---, +"multiplexer":, +    - do:, +        indices.analyze:, +          body:, +            text: "The quick fox", +            tokenizer: "standard", +            filter:, +              - type: multiplexer, +                filters: [ lowercase, uppercase ], +                preserve_original: false, +    - length: { tokens: 6 }, +    - match: { tokens.0.token: the }, +    - match: { tokens.1.token: THE }, +++ b/modules/analysis-common/src/test/resources/rest-api-spec/test/analysis-common/40_token_filters.yml, +, +---, +"multiplexer":, +    - do:, +        indices.analyze:, +          body:, +            text: "The quick fox", +            tokenizer: "standard", +            filter:, +              - type: multiplexer, +                filters: [ lowercase, uppercase ], +                preserve_original: false, +    - length: { tokens: 6 }, +    - match: { tokens.0.token: the }, +    - match: { tokens.1.token: THE }, +++ b/server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java, +import org.elasticsearch.index.analysis.ReferringFilterFactory;, +        List<ReferringFilterFactory> referringFilters = new ArrayList<>();, +                    if (tokenFilterFactory instanceof ReferringFilterFactory) {, +                        referringFilters.add((ReferringFilterFactory)tokenFilterFactory);, +                    }, +        if (referringFilters.isEmpty() == false) {, +            // The request included at least one custom referring tokenfilter that has not already been built by the, +            // analysis registry, so we need to set its references.  Note that this will only apply pre-built, +            // tokenfilters, +            if (indexSettings == null) {, +                Settings settings = Settings.builder(), +                    .put(IndexMetaData.SETTING_VERSION_CREATED, Version.CURRENT), +                    .put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS, 0), +                    .put(IndexMetaData.SETTING_NUMBER_OF_SHARDS, 1), +                    .put(IndexMetaData.SETTING_INDEX_UUID, UUIDs.randomBase64UUID()), +                    .build();, +                IndexMetaData metaData = IndexMetaData.builder(IndexMetaData.INDEX_UUID_NA_VALUE).settings(settings).build();, +                indexSettings = new IndexSettings(metaData, Settings.EMPTY);, +            }, +            Map<String, TokenFilterFactory> prebuiltFilters = analysisRegistry.buildTokenFilterFactories(indexSettings);, +            for (ReferringFilterFactory rff : referringFilters) {, +                rff.setReferences(prebuiltFilters);, +            }, +, +        }]