[+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java, +import org.elasticsearch.action.ActionFuture;, +        // Index some unused state documents (more than 10K to test scrolling works), +        BulkRequestBuilder bulkRequestBuilder = client().prepareBulk();, +        bulkRequestBuilder.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);, +        for (int i = 0; i < 10010; i++) {, +            String docId = "non_existing_job_" + randomFrom("model_state_1234567#" + i, "quantiles", "categorizer_state#" + i);, +            IndexRequest indexRequest = new IndexRequest(AnomalyDetectorsIndex.jobStateIndexWriteAlias(), "doc", docId);, +            indexRequest.source(Collections.emptyMap());, +            bulkRequestBuilder.add(indexRequest);, +        }, +        ActionFuture<BulkResponse> indexUnusedStateDocsResponse = bulkRequestBuilder.execute();, +, +, +        // Start all jobs, +        }, +, +        // Now let's wait for all jobs to be closed, +        for (Job.Builder job : getJobs()) {, +        }, +, +        for (Job.Builder job : getJobs()) {, +, +        // Before we call the delete-expired-data action we need to make sure the unused state docs were indexed, +        assertThat(indexUnusedStateDocsResponse.get().status(), equalTo(RestStatus.OK));]