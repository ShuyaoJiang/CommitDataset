[+++ b/core/src/main/java/org/elasticsearch/common/util/concurrent/ThreadContext.java, +public final class ThreadContext implements Closeable, Writeable<ThreadContext> {, +        threadLocal.set(new ThreadContext.ThreadContextStruct(in));, +    static final class ThreadContextStruct {, +        private void writeTo(StreamOutput out, Map<String, String> defaultHeaders) throws IOException {, +++ b/core/src/main/java/org/elasticsearch/common/util/concurrent/ThreadContext.java, +public final class ThreadContext implements Closeable, Writeable<ThreadContext> {, +        threadLocal.set(new ThreadContext.ThreadContextStruct(in));, +    static final class ThreadContextStruct {, +        private void writeTo(StreamOutput out, Map<String, String> defaultHeaders) throws IOException {, +++ b/core/src/test/java/org/elasticsearch/common/io/stream/BytesStreamsTests.java]