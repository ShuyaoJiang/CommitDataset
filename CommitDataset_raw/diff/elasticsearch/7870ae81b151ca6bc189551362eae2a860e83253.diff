[+++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/datafeed/DatafeedConfig.java, +            this.indices = config.indices == null ? null : new ArrayList<>(config.indices);, +            this.types = config.types == null ? null : new ArrayList<>(config.types);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/datafeed/DatafeedConfig.java, +            this.indices = config.indices == null ? null : new ArrayList<>(config.indices);, +            this.types = config.types == null ? null : new ArrayList<>(config.types);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/config/Job.java, +import java.util.ArrayList;, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/datafeed/DatafeedConfig.java, +            this.indices = config.indices == null ? null : new ArrayList<>(config.indices);, +            this.types = config.types == null ? null : new ArrayList<>(config.types);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/config/Job.java, +import java.util.ArrayList;, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java, +import java.util.HashMap;, +import java.util.LinkedHashMap;, +        this.query = query == null ? null : Collections.unmodifiableMap(query);, +        this.aggregations = aggregations == null ? null : Collections.unmodifiableMap(aggregations);, +            this.indices = new ArrayList<>(config.indices);, +            this.types = new ArrayList<>(config.types);, +            this.query = config.query == null ? null : new LinkedHashMap<>(config.query);, +            this.aggregations = config.aggregations == null ? null : new LinkedHashMap<>(config.aggregations);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +            this.headers = new HashMap<>(config.headers);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/datafeed/DatafeedConfig.java, +            this.indices = config.indices == null ? null : new ArrayList<>(config.indices);, +            this.types = config.types == null ? null : new ArrayList<>(config.types);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/config/Job.java, +import java.util.ArrayList;, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java, +import java.util.HashMap;, +import java.util.LinkedHashMap;, +        this.query = query == null ? null : Collections.unmodifiableMap(query);, +        this.aggregations = aggregations == null ? null : Collections.unmodifiableMap(aggregations);, +            this.indices = new ArrayList<>(config.indices);, +            this.types = new ArrayList<>(config.types);, +            this.query = config.query == null ? null : new LinkedHashMap<>(config.query);, +            this.aggregations = config.aggregations == null ? null : new LinkedHashMap<>(config.aggregations);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +            this.headers = new HashMap<>(config.headers);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/config/Job.java, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/datafeed/DatafeedConfig.java, +            this.indices = config.indices == null ? null : new ArrayList<>(config.indices);, +            this.types = config.types == null ? null : new ArrayList<>(config.types);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/config/Job.java, +import java.util.ArrayList;, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java, +import java.util.HashMap;, +import java.util.LinkedHashMap;, +        this.query = query == null ? null : Collections.unmodifiableMap(query);, +        this.aggregations = aggregations == null ? null : Collections.unmodifiableMap(aggregations);, +            this.indices = new ArrayList<>(config.indices);, +            this.types = new ArrayList<>(config.types);, +            this.query = config.query == null ? null : new LinkedHashMap<>(config.query);, +            this.aggregations = config.aggregations == null ? null : new LinkedHashMap<>(config.aggregations);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +            this.headers = new HashMap<>(config.headers);, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/config/Job.java, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfigTests.java, +    public void testCopyingDatafeedDoesNotCauseStackOverflow() {, +        DatafeedConfig datafeed = createTestInstance();, +        for (int i = 0; i < 100000; i++) {, +            datafeed = new DatafeedConfig.Builder(datafeed).build();, +        }, +    }, +, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/datafeed/DatafeedConfig.java, +            this.indices = config.indices == null ? null : new ArrayList<>(config.indices);, +            this.types = config.types == null ? null : new ArrayList<>(config.types);, +            this.scriptFields = config.scriptFields == null ? null : new ArrayList<>(config.scriptFields);, +++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/config/Job.java, +import java.util.ArrayList;, +import java.util.HashMap;, +            this.groups = new ArrayList<>(job.getGroups());, +            this.customSettings = job.getCustomSettings() == null ? null : new HashMap<>(job.getCustomSettings());, +++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java, +import java.util.HashMap;]