[+++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamInput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamInput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamOutput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamInput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamOutput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/CachedStreamInput.java, +        char[] chars = new char[80];, +, +    public static char[] getCharArray(int size) {, +        Entry entry = instance();, +        if (entry.chars.length < size) {, +            entry.chars = new char[size];, +        }, +        return entry.chars;, +    }, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamInput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamOutput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/CachedStreamInput.java, +        char[] chars = new char[80];, +, +    public static char[] getCharArray(int size) {, +        Entry entry = instance();, +        if (entry.chars.length < size) {, +            entry.chars = new char[size];, +        }, +        return entry.chars;, +    }, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +        int charCount = readVInt();, +        char[] chars = CachedStreamInput.getCharArray(charCount);, +        int c, charIndex = 0;, +        while (charIndex < charCount) {, +            c = readByte() & 0xff;, +                    chars[charIndex++] = (char) c;, +                    chars[charIndex++] = (char) ((c & 0x1F) << 6 | readByte() & 0x3F);, +                    chars[charIndex++] = (char) ((c & 0x0F) << 12 | (readByte() & 0x3F) << 6 | (readByte() & 0x3F) << 0);, +        return new String(chars, 0, charCount);, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamInput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/BytesStreamOutput.java, +++ b/src/main/java/org/elasticsearch/common/io/stream/CachedStreamInput.java, +        char[] chars = new char[80];, +, +    public static char[] getCharArray(int size) {, +        Entry entry = instance();, +        if (entry.chars.length < size) {, +            entry.chars = new char[size];, +        }, +        return entry.chars;, +    }, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java, +        int charCount = readVInt();, +        char[] chars = CachedStreamInput.getCharArray(charCount);, +        int c, charIndex = 0;, +        while (charIndex < charCount) {, +            c = readByte() & 0xff;, +                    chars[charIndex++] = (char) c;, +                    chars[charIndex++] = (char) ((c & 0x1F) << 6 | readByte() & 0x3F);, +                    chars[charIndex++] = (char) ((c & 0x0F) << 12 | (readByte() & 0x3F) << 6 | (readByte() & 0x3F) << 0);, +        return new String(chars, 0, charCount);, +++ b/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java, +        int charCount = str.length();, +        writeVInt(charCount);, +        int c;, +        for (int i = 0; i < charCount; i++) {, +            if (c <= 0x007F) {, +                writeByte((byte) c);, +                writeByte((byte) (0xE0 | c >> 12 & 0x0F));, +                writeByte((byte) (0x80 | c >> 6 & 0x3F));, +                writeByte((byte) (0x80 | c >> 0 & 0x3F));, +                writeByte((byte) (0xC0 | c >> 6 & 0x1F));, +                writeByte((byte) (0x80 | c >> 0 & 0x3F));]