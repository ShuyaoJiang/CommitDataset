[+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/support/CachingUsernamePasswordRealmTests.java, +, +        // we use a bunch of different latches here, the first `latch` is used to ensure all threads have been started, +        // before they start to execute. The `authWaitLatch` is there to ensure we have all threads waiting on the, +        // listener before we auth otherwise we may run into a race condition where we auth and one of the threads is, +        // not waiting on auth yet. Finally, the completedLatch is used to signal that each thread received a response!, +        final CountDownLatch latch = new CountDownLatch(1 + numberOfThreads);, +        final CountDownLatch authWaitLatch = new CountDownLatch(numberOfThreads);, +        final CountDownLatch completedLatch = new CountDownLatch(numberOfThreads);, +                authWaitLatch.countDown();, +                try {, +                    authWaitLatch.await();, +                } catch (InterruptedException e) {, +                    logger.info("authentication was interrupted", e);, +                    Thread.currentThread().interrupt();, +                }, +                            completedLatch.countDown();, +                        completedLatch.countDown();, +                        completedLatch.countDown();, +                    authWaitLatch.countDown();, +        completedLatch.await();]