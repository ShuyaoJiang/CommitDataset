[+++ b/src/test/java/org/elasticsearch/search/aggregations/reducers/DateDerivativeTests.java, +        assertThat(buckets.size(), equalTo(3));, +        assertThat(bucket.getDocCount(), equalTo(1l));, +        assertThat(docCountDeriv, nullValue());, +        assertThat(bucket.getDocCount(), equalTo(2l));, +        docCountDeriv = bucket.getAggregations().get("deriv");, +        assertThat(docCountDeriv, notNullValue());, +        assertThat(docCountDeriv.value(), equalTo(1d));, +, +        key = new DateTime(2012, 3, 1, 0, 0, DateTimeZone.UTC);, +        bucket = buckets.get(2);, +        assertThat(bucket, notNullValue());, +        assertThat((DateTime) bucket.getKey(), equalTo(key));, +        assertThat(bucket.getDocCount(), equalTo(3l));, +        assertThat(buckets.size(), equalTo(4));, +        assertThat(bucket.getDocCount(), equalTo(1l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(true));, +        assertThat(docCountDeriv, nullValue());, +        assertThat(bucket.getDocCount(), equalTo(3l));, +        assertThat(bucket.getDocCount(), equalTo(5l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(false));, +        docCountDeriv = bucket.getAggregations().get("deriv");, +        assertThat(docCountDeriv, notNullValue());, +        assertThat(docCountDeriv.value(), equalTo(2.0));, +, +        key = new DateTime(2012, 4, 1, 0, 0, DateTimeZone.UTC);, +        bucket = buckets.get(3);, +        assertThat(bucket, notNullValue());, +        assertThat((DateTime) bucket.getKey(), equalTo(key));, +        assertThat(bucket.getDocCount(), equalTo(3l));, +        assertThat(buckets.size(), equalTo(3));, +        assertThat(bucket.getDocCount(), equalTo(1l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(true));, +        assertThat(docCountDeriv, nullValue());, +        assertThat(bucket.getDocCount(), equalTo(2l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(false));, +        docCountDeriv = bucket.getAggregations().get("deriv");, +        assertThat(docCountDeriv, notNullValue());, +        assertThat(docCountDeriv.value(), equalTo(1.0));, +, +        key = new DateTime(2012, 3, 1, 0, 0, DateTimeZone.UTC);, +        bucket = buckets.get(2);, +        assertThat(bucket, notNullValue());, +        assertThat((DateTime) bucket.getKey(), equalTo(key));, +        assertThat(bucket.getDocCount(), equalTo(3l));, +++ b/src/test/java/org/elasticsearch/search/aggregations/reducers/DateDerivativeTests.java, +        assertThat(buckets.size(), equalTo(3));, +        assertThat(bucket.getDocCount(), equalTo(1l));, +        assertThat(docCountDeriv, nullValue());, +        assertThat(bucket.getDocCount(), equalTo(2l));, +        docCountDeriv = bucket.getAggregations().get("deriv");, +        assertThat(docCountDeriv, notNullValue());, +        assertThat(docCountDeriv.value(), equalTo(1d));, +, +        key = new DateTime(2012, 3, 1, 0, 0, DateTimeZone.UTC);, +        bucket = buckets.get(2);, +        assertThat(bucket, notNullValue());, +        assertThat((DateTime) bucket.getKey(), equalTo(key));, +        assertThat(bucket.getDocCount(), equalTo(3l));, +        assertThat(buckets.size(), equalTo(4));, +        assertThat(bucket.getDocCount(), equalTo(1l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(true));, +        assertThat(docCountDeriv, nullValue());, +        assertThat(bucket.getDocCount(), equalTo(3l));, +        assertThat(bucket.getDocCount(), equalTo(5l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(false));, +        docCountDeriv = bucket.getAggregations().get("deriv");, +        assertThat(docCountDeriv, notNullValue());, +        assertThat(docCountDeriv.value(), equalTo(2.0));, +, +        key = new DateTime(2012, 4, 1, 0, 0, DateTimeZone.UTC);, +        bucket = buckets.get(3);, +        assertThat(bucket, notNullValue());, +        assertThat((DateTime) bucket.getKey(), equalTo(key));, +        assertThat(bucket.getDocCount(), equalTo(3l));, +        assertThat(buckets.size(), equalTo(3));, +        assertThat(bucket.getDocCount(), equalTo(1l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(true));, +        assertThat(docCountDeriv, nullValue());, +        assertThat(bucket.getDocCount(), equalTo(2l));, +        assertThat(bucket.getAggregations().asList().isEmpty(), is(false));, +        docCountDeriv = bucket.getAggregations().get("deriv");, +        assertThat(docCountDeriv, notNullValue());, +        assertThat(docCountDeriv.value(), equalTo(1.0));, +, +        key = new DateTime(2012, 3, 1, 0, 0, DateTimeZone.UTC);, +        bucket = buckets.get(2);, +        assertThat(bucket, notNullValue());, +        assertThat((DateTime) bucket.getKey(), equalTo(key));, +        assertThat(bucket.getDocCount(), equalTo(3l));, +++ b/src/test/java/org/elasticsearch/search/aggregations/reducers/DerivativeTests.java, +import static org.hamcrest.core.IsNull.nullValue;, +        assertThat(buckets.size(), equalTo(numValueBuckets));, +        for (int i = 0; i < numValueBuckets; ++i) {, +            if (i > 0) {, +                assertThat(docCountDeriv.value(), equalTo((double) firstDerivValueCounts[i - 1]));, +            } else {, +                assertThat(docCountDeriv, nullValue());, +            }, +            SimpleValue sumDeriv = bucket.getAggregations().get("deriv");]