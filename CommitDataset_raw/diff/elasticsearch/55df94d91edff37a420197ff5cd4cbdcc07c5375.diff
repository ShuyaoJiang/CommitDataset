[+++ b/src/main/java/org/elasticsearch/search/internal/InternalSearchHits.java, +import java.util.IdentityHashMap;, +import java.util.Iterator;, +import java.util.Map;, +                int lookupSize = in.readVInt();, +                    context.handleShardLookup().put(in.readVInt(), readSearchShardTarget(in));, +                out.writeVInt(context.shardHandleLookup().size());, +                if (!context.shardHandleLookup().isEmpty()) {, +                    for (Map.Entry<SearchShardTarget, Integer> entry : context.shardHandleLookup().entrySet()) {, +                        out.writeVInt(entry.getValue());, +                        entry.getKey().writeTo(out);, +++ b/src/main/java/org/elasticsearch/search/internal/InternalSearchHits.java, +import java.util.IdentityHashMap;, +import java.util.Iterator;, +import java.util.Map;, +                int lookupSize = in.readVInt();, +                    context.handleShardLookup().put(in.readVInt(), readSearchShardTarget(in));, +                out.writeVInt(context.shardHandleLookup().size());, +                if (!context.shardHandleLookup().isEmpty()) {, +                    for (Map.Entry<SearchShardTarget, Integer> entry : context.shardHandleLookup().entrySet()) {, +                        out.writeVInt(entry.getValue());, +                        entry.getKey().writeTo(out);, +++ b/src/test/java/org/elasticsearch/search/sort/SimpleSortTests.java, +import com.carrotsearch.randomizedtesting.annotations.Repeat;, +import org.apache.lucene.util.LuceneTestCase;, +    @LuceneTestCase.AwaitsFix(bugUrl = "simon is working on this"), +        final int numIndices = randomIntBetween(2, 25); // at most 25 days in the month, +          final int numDocs = randomIntBetween(1, 23);  // hour of the day, +        ensureYellow();, +++ b/src/main/java/org/elasticsearch/search/internal/InternalSearchHits.java, +import java.util.IdentityHashMap;, +import java.util.Iterator;, +import java.util.Map;, +                int lookupSize = in.readVInt();, +                    context.handleShardLookup().put(in.readVInt(), readSearchShardTarget(in));, +                out.writeVInt(context.shardHandleLookup().size());, +                if (!context.shardHandleLookup().isEmpty()) {, +                    for (Map.Entry<SearchShardTarget, Integer> entry : context.shardHandleLookup().entrySet()) {, +                        out.writeVInt(entry.getValue());, +                        entry.getKey().writeTo(out);, +++ b/src/test/java/org/elasticsearch/search/sort/SimpleSortTests.java, +import com.carrotsearch.randomizedtesting.annotations.Repeat;, +import org.apache.lucene.util.LuceneTestCase;, +    @LuceneTestCase.AwaitsFix(bugUrl = "simon is working on this"), +        final int numIndices = randomIntBetween(2, 25); // at most 25 days in the month, +          final int numDocs = randomIntBetween(1, 23);  // hour of the day, +        ensureYellow();, +++ b/src/test/java/org/elasticsearch/test/hamcrest/ElasticsearchAssertions.java, +            assertThat("Stream should be fully read with version [" + version + "] for streamable [" + streamable + "]", input.available(), equalTo(0));, +            assertThat("Serialization failed with version [" + version + "] bytes should be equal for streamable [" + streamable + "]", serialize(version, streamable), equalTo(orig));]