[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +        SearchContext context = SearchContext.current();, +        if (context == null) {, +            throw new ElasticSearchIllegalStateException("No search context on going...");, +        }, +        SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +        SearchContext context = SearchContext.current();, +        if (context == null) {, +            throw new ElasticSearchIllegalStateException("No search context on going...");, +        }, +        SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +            SearchContext context = SearchContext.current();, +            if (context == null) {, +                throw new ElasticSearchIllegalStateException("No search context on going...");, +            }, +            final SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, params, scriptService);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +        SearchContext context = SearchContext.current();, +        if (context == null) {, +            throw new ElasticSearchIllegalStateException("No search context on going...");, +        }, +        SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +            SearchContext context = SearchContext.current();, +            if (context == null) {, +                throw new ElasticSearchIllegalStateException("No search context on going...");, +            }, +            final SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, params, scriptService);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/SearchService.java, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +            cleanContext(context);, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +                contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +            cleanContext(context);, +                contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +                contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +                contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +        SearchContext.setCurrent(context);, +        SearchContext.setCurrent(context);, +    private void contextProcessedSuccessfully(SearchContext context) {, +    private void cleanContext(SearchContext context) {, +        SearchContext.removeCurrent();, +    }, +, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/CustomScoreQueryParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +        SearchContext context = SearchContext.current();, +        if (context == null) {, +            throw new ElasticSearchIllegalStateException("No search context on going...");, +        }, +        SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, vars, parseContext.scriptService());, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ScriptFilterParser.java, +import org.elasticsearch.ElasticSearchIllegalStateException;, +import org.elasticsearch.search.internal.SearchContext;, +            SearchContext context = SearchContext.current();, +            if (context == null) {, +                throw new ElasticSearchIllegalStateException("No search context on going...");, +            }, +            final SearchScript searchScript = new SearchScript(context.scriptSearchLookup(), scriptLang, script, params, scriptService);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/SearchService.java, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);, +            contextProcessedSuccessfully(context);, +        } finally {, +            cleanContext(context);]