[+++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.REPLICA, shardId.getIndexName(), request.type(), request.id(), request.source()), +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.PRIMARY, request.index(), request.type(), request.id(), request.source()), +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.REPLICA, shardId.getIndexName(), request.type(), request.id(), request.source()), +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.PRIMARY, request.index(), request.type(), request.id(), request.source()), +++ b/core/src/main/java/org/elasticsearch/index/mapper/ContentPath.java, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.REPLICA, shardId.getIndexName(), request.type(), request.id(), request.source()), +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.PRIMARY, request.index(), request.type(), request.id(), request.source()), +++ b/core/src/main/java/org/elasticsearch/index/mapper/ContentPath.java, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +        return parse(SourceToParse.source(index, type, id, source));, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.REPLICA, shardId.getIndexName(), request.type(), request.id(), request.source()), +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.PRIMARY, request.index(), request.type(), request.id(), request.source()), +++ b/core/src/main/java/org/elasticsearch/index/mapper/ContentPath.java, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +        return parse(SourceToParse.source(index, type, id, source));, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java, +import java.util.Objects;, +        final ParseContext.InternalParseContext context;, +        try (XContentParser parser = XContentHelper.createParser(source.source())) {, +            context = new ParseContext.InternalParseContext(indexSettings.getSettings(),, +                    docMapperParser, docMapper, source, parser);, +        if (Objects.equals(source.type(), docMapper.type()) == false) {, +            context.sourceToParse().id(),, +            context.sourceToParse().type(),, +            context.sourceToParse().source(),, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.REPLICA, shardId.getIndexName(), request.type(), request.id(), request.source()), +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.PRIMARY, request.index(), request.type(), request.id(), request.source()), +++ b/core/src/main/java/org/elasticsearch/index/mapper/ContentPath.java, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +        return parse(SourceToParse.source(index, type, id, source));, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java, +import java.util.Objects;, +        final ParseContext.InternalParseContext context;, +        try (XContentParser parser = XContentHelper.createParser(source.source())) {, +            context = new ParseContext.InternalParseContext(indexSettings.getSettings(),, +                    docMapperParser, docMapper, source, parser);, +        if (Objects.equals(source.type(), docMapper.type()) == false) {, +            context.sourceToParse().id(),, +            context.sourceToParse().type(),, +            context.sourceToParse().source(),, +++ b/core/src/main/java/org/elasticsearch/index/mapper/ParseContext.java, +        protected void addDoc(Document doc) {, +        private final XContentParser parser;, +        private final List<Document> documents;, +        private final SourceToParse sourceToParse;, +        private Field version;, +        private StringBuilder stringBuilder = new StringBuilder();, +        private final AllEntries allEntries;, +        private final List<Mapper> dynamicMappers;, +        public InternalParseContext(@Nullable Settings indexSettings, DocumentMapperParser docMapperParser, DocumentMapper docMapper,, +                SourceToParse source, XContentParser parser) {, +            this.path = new ContentPath(0);, +            this.document = new Document();, +        protected void addDoc(Document doc) {, +    protected abstract void addDoc(Document doc);, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.REPLICA, shardId.getIndexName(), request.type(), request.id(), request.source()), +        SourceToParse sourceToParse = SourceToParse.source(SourceToParse.Origin.PRIMARY, request.index(), request.type(), request.id(), request.source()), +++ b/core/src/main/java/org/elasticsearch/index/mapper/ContentPath.java, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +        return parse(SourceToParse.source(index, type, id, source));, +++ b/core/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java, +import java.util.Objects;, +        final ParseContext.InternalParseContext context;, +        try (XContentParser parser = XContentHelper.createParser(source.source())) {, +            context = new ParseContext.InternalParseContext(indexSettings.getSettings(),, +                    docMapperParser, docMapper, source, parser);, +        if (Objects.equals(source.type(), docMapper.type()) == false) {, +            context.sourceToParse().id(),, +            context.sourceToParse().type(),, +            context.sourceToParse().source(),, +++ b/core/src/main/java/org/elasticsearch/index/mapper/ParseContext.java, +        protected void addDoc(Document doc) {, +        private final XContentParser parser;, +        private final List<Document> documents;, +        private final SourceToParse sourceToParse;, +        private Field version;, +        private StringBuilder stringBuilder = new StringBuilder();, +        private final AllEntries allEntries;, +        private final List<Mapper> dynamicMappers;, +        public InternalParseContext(@Nullable Settings indexSettings, DocumentMapperParser docMapperParser, DocumentMapper docMapper,, +                SourceToParse source, XContentParser parser) {, +            this.path = new ContentPath(0);, +            this.document = new Document();, +        protected void addDoc(Document doc) {, +    protected abstract void addDoc(Document doc);, +++ b/core/src/main/java/org/elasticsearch/index/mapper/ParsedDocument.java, +    private final Field version;, +    private final String uid, id, type;, +    public ParsedDocument(Field version, String id, String type, String routing, long timestamp, long ttl, List<Document> documents, BytesReference source, Mapping dynamicMappingsUpdate) {, +        this.uid = Uid.createUid(type, id);, +    public String uid() {, +        return uid;, +    }, +]