[+++ b/core/src/main/java/org/elasticsearch/index/IndexServicesProvider.java, +    public IndexServicesProvider(IndexEventListener listener, ThreadPool threadPool, MapperService mapperService, IndexCache indexCache, IndicesQueryCache indicesQueryCache, TermVectorsService termVectorsService, IndexFieldDataService indexFieldDataService, @Nullable IndicesWarmer warmer, SimilarityService similarityService, EngineFactory factory, BigArrays bigArrays, IndexingMemoryController indexingMemoryController, Client client, ScriptService scriptService, IndicesQueriesRegistry indicesQueriesRegistry) {, +++ b/core/src/main/java/org/elasticsearch/index/IndexServicesProvider.java, +    public IndexServicesProvider(IndexEventListener listener, ThreadPool threadPool, MapperService mapperService, IndexCache indexCache, IndicesQueryCache indicesQueryCache, TermVectorsService termVectorsService, IndexFieldDataService indexFieldDataService, @Nullable IndicesWarmer warmer, SimilarityService similarityService, EngineFactory factory, BigArrays bigArrays, IndexingMemoryController indexingMemoryController, Client client, ScriptService scriptService, IndicesQueriesRegistry indicesQueriesRegistry) {, +++ b/core/src/main/java/org/elasticsearch/index/codec/CodecService.java, +import org.elasticsearch.common.Nullable;, +import org.elasticsearch.common.logging.ESLogger;, +public class CodecService {, +    public CodecService(@Nullable MapperService mapperService, ESLogger logger) {, +        final MapBuilder<String, Codec> codecs = MapBuilder.<String, Codec>newMapBuilder();, +++ b/core/src/main/java/org/elasticsearch/index/IndexServicesProvider.java, +    public IndexServicesProvider(IndexEventListener listener, ThreadPool threadPool, MapperService mapperService, IndexCache indexCache, IndicesQueryCache indicesQueryCache, TermVectorsService termVectorsService, IndexFieldDataService indexFieldDataService, @Nullable IndicesWarmer warmer, SimilarityService similarityService, EngineFactory factory, BigArrays bigArrays, IndexingMemoryController indexingMemoryController, Client client, ScriptService scriptService, IndicesQueriesRegistry indicesQueriesRegistry) {, +++ b/core/src/main/java/org/elasticsearch/index/codec/CodecService.java, +import org.elasticsearch.common.Nullable;, +import org.elasticsearch.common.logging.ESLogger;, +public class CodecService {, +    public CodecService(@Nullable MapperService mapperService, ESLogger logger) {, +        final MapBuilder<String, Codec> codecs = MapBuilder.<String, Codec>newMapBuilder();, +++ b/core/src/main/java/org/elasticsearch/index/shard/IndexShard.java, +        this.codecService = new CodecService(provider.getMapperService(), logger);, +++ b/core/src/main/java/org/elasticsearch/index/IndexServicesProvider.java, +    public IndexServicesProvider(IndexEventListener listener, ThreadPool threadPool, MapperService mapperService, IndexCache indexCache, IndicesQueryCache indicesQueryCache, TermVectorsService termVectorsService, IndexFieldDataService indexFieldDataService, @Nullable IndicesWarmer warmer, SimilarityService similarityService, EngineFactory factory, BigArrays bigArrays, IndexingMemoryController indexingMemoryController, Client client, ScriptService scriptService, IndicesQueriesRegistry indicesQueriesRegistry) {, +++ b/core/src/main/java/org/elasticsearch/index/codec/CodecService.java, +import org.elasticsearch.common.Nullable;, +import org.elasticsearch.common.logging.ESLogger;, +public class CodecService {, +    public CodecService(@Nullable MapperService mapperService, ESLogger logger) {, +        final MapBuilder<String, Codec> codecs = MapBuilder.<String, Codec>newMapBuilder();, +++ b/core/src/main/java/org/elasticsearch/index/shard/IndexShard.java, +        this.codecService = new CodecService(provider.getMapperService(), logger);, +++ b/core/src/test/java/org/elasticsearch/index/codec/CodecTests.java, +import org.elasticsearch.Version;, +import org.elasticsearch.cluster.metadata.IndexMetaData;, +import org.elasticsearch.common.logging.ESLoggerFactory;, +import org.elasticsearch.env.Environment;, +import org.elasticsearch.index.Index;, +import org.elasticsearch.index.IndexSettings;, +import org.elasticsearch.index.analysis.AnalysisRegistry;, +import org.elasticsearch.index.analysis.AnalysisService;, +import org.elasticsearch.index.mapper.MapperService;, +import org.elasticsearch.index.similarity.SimilarityService;, +import org.elasticsearch.test.ESTestCase;, +import org.elasticsearch.test.IndexSettingsModule;, +import java.io.IOException;, +import java.util.Collections;, +, +import static org.elasticsearch.common.settings.Settings.settingsBuilder;, +public class CodecTests extends ESTestCase {, +    private static CodecService createCodecService() throws IOException {, +        Settings nodeSettings = settingsBuilder(), +                .put("path.home", createTempDir()), +                .build();, +        IndexSettings settings = IndexSettingsModule.newIndexSettings(new Index("_na"), nodeSettings, Collections.emptyList());, +        SimilarityService similarityService = new SimilarityService(settings, Collections.EMPTY_MAP);, +        AnalysisService analysisService = new AnalysisRegistry(null, new Environment(nodeSettings)).build(settings);, +        MapperService service = new MapperService(settings, analysisService, similarityService);, +        return new CodecService(service, ESLoggerFactory.getLogger("test"));, +++ b/core/src/main/java/org/elasticsearch/index/IndexServicesProvider.java, +    public IndexServicesProvider(IndexEventListener listener, ThreadPool threadPool, MapperService mapperService, IndexCache indexCache, IndicesQueryCache indicesQueryCache, TermVectorsService termVectorsService, IndexFieldDataService indexFieldDataService, @Nullable IndicesWarmer warmer, SimilarityService similarityService, EngineFactory factory, BigArrays bigArrays, IndexingMemoryController indexingMemoryController, Client client, ScriptService scriptService, IndicesQueriesRegistry indicesQueriesRegistry) {, +++ b/core/src/main/java/org/elasticsearch/index/codec/CodecService.java, +import org.elasticsearch.common.Nullable;, +import org.elasticsearch.common.logging.ESLogger;, +public class CodecService {, +    public CodecService(@Nullable MapperService mapperService, ESLogger logger) {, +        final MapBuilder<String, Codec> codecs = MapBuilder.<String, Codec>newMapBuilder();, +++ b/core/src/main/java/org/elasticsearch/index/shard/IndexShard.java, +        this.codecService = new CodecService(provider.getMapperService(), logger);, +++ b/core/src/test/java/org/elasticsearch/index/codec/CodecTests.java, +import org.elasticsearch.Version;, +import org.elasticsearch.cluster.metadata.IndexMetaData;, +import org.elasticsearch.common.logging.ESLoggerFactory;, +import org.elasticsearch.env.Environment;, +import org.elasticsearch.index.Index;, +import org.elasticsearch.index.IndexSettings;, +import org.elasticsearch.index.analysis.AnalysisRegistry;, +import org.elasticsearch.index.analysis.AnalysisService;, +import org.elasticsearch.index.mapper.MapperService;, +import org.elasticsearch.index.similarity.SimilarityService;, +import org.elasticsearch.test.ESTestCase;, +import org.elasticsearch.test.IndexSettingsModule;, +import java.io.IOException;, +import java.util.Collections;, +, +import static org.elasticsearch.common.settings.Settings.settingsBuilder;, +public class CodecTests extends ESTestCase {, +    private static CodecService createCodecService() throws IOException {, +        Settings nodeSettings = settingsBuilder(), +                .put("path.home", createTempDir()), +                .build();, +        IndexSettings settings = IndexSettingsModule.newIndexSettings(new Index("_na"), nodeSettings, Collections.emptyList());, +        SimilarityService similarityService = new SimilarityService(settings, Collections.EMPTY_MAP);, +        AnalysisService analysisService = new AnalysisRegistry(null, new Environment(nodeSettings)).build(settings);, +        MapperService service = new MapperService(settings, analysisService, similarityService);, +        return new CodecService(service, ESLoggerFactory.getLogger("test"));, +++ b/core/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java, +        CodecService codecService = new CodecService(null, logger);, +                iwc.getAnalyzer(), iwc.getSimilarity(), new CodecService(null, logger), new Engine.EventListener() {, +        CodecService codecService = new CodecService(null, logger);, +                config.getAnalyzer(), config.getSimilarity(), new CodecService(null, logger), config.getEventListener(), +++ b/core/src/main/java/org/elasticsearch/index/IndexServicesProvider.java]