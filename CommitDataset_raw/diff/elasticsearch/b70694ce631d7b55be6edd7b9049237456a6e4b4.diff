[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/cluster/metadata/MetaDataUpdateSettingsService.java, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +import org.elasticsearch.cluster.routing.allocation.ShardsAllocation;, +import static org.elasticsearch.cluster.ClusterState.*;, +, +    private final ShardsAllocation shardsAllocation;, +, +    @Inject public MetaDataUpdateSettingsService(Settings settings, ClusterService clusterService, ShardsAllocation shardsAllocation) {, +        this.shardsAllocation = shardsAllocation;, +                    ClusterState updatedState = ClusterState.builder().state(currentState).metaData(metaDataBuilder).routingTable(routingTableBuilder).build();, +, +                    // now, reroute in case things change that require it (like number of replicas), +                    RoutingAllocation.Result routingResult = shardsAllocation.reroute(updatedState);, +                    updatedState = newClusterStateBuilder().state(updatedState).routingResult(routingResult).build();, +, +                    return updatedState;]