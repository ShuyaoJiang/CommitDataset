[+++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/vectorhighlight/CustomFieldQuery.java, +            ConstantScoreQuery constantScoreQuery = (ConstantScoreQuery) sourceQuery;, +            if (constantScoreQuery.getFilter() != null) {, +                flatten(constantScoreQuery.getFilter(), flatQueries);, +            } else {, +                flatten(constantScoreQuery.getQuery(), flatQueries);, +            }, +++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/vectorhighlight/CustomFieldQuery.java, +            ConstantScoreQuery constantScoreQuery = (ConstantScoreQuery) sourceQuery;, +            if (constantScoreQuery.getFilter() != null) {, +                flatten(constantScoreQuery.getFilter(), flatQueries);, +            } else {, +                flatten(constantScoreQuery.getQuery(), flatQueries);, +            }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ConstantScoreQueryParser.java, +import org.apache.lucene.search.ConstantScoreQuery;, +        Query query = null;, +                } else if ("query".equals(currentFieldName)) {, +                    query = parseContext.parseInnerQuery();, +        if (filter == null && query == null) {, +            throw new QueryParsingException(index, "[constant_score] requires either 'filter' or 'query' element");, +        if (filter != null) {, +            Query query1 = new DeletionAwareConstantScoreQuery(filter);, +            query1.setBoost(boost);, +            return query1;, +        }, +        // Query, +        query = new ConstantScoreQuery(query);, +++ b/modules/elasticsearch/src/main/java/org/apache/lucene/search/vectorhighlight/CustomFieldQuery.java, +            ConstantScoreQuery constantScoreQuery = (ConstantScoreQuery) sourceQuery;, +            if (constantScoreQuery.getFilter() != null) {, +                flatten(constantScoreQuery.getFilter(), flatQueries);, +            } else {, +                flatten(constantScoreQuery.getQuery(), flatQueries);, +            }, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/query/xcontent/ConstantScoreQueryParser.java, +import org.apache.lucene.search.ConstantScoreQuery;, +        Query query = null;, +                } else if ("query".equals(currentFieldName)) {, +                    query = parseContext.parseInnerQuery();, +        if (filter == null && query == null) {, +            throw new QueryParsingException(index, "[constant_score] requires either 'filter' or 'query' element");, +        if (filter != null) {, +            Query query1 = new DeletionAwareConstantScoreQuery(filter);, +            query1.setBoost(boost);, +            return query1;, +        }, +        // Query, +        query = new ConstantScoreQuery(query);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/search/facet/query/QueryFacetCollector.java, +            ConstantScoreQuery constantScoreQuery = (ConstantScoreQuery) query;, +            if (constantScoreQuery.getFilter() != null) {, +                return constantScoreQuery.getFilter();, +            }]