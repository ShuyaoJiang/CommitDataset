[+++ b/modules/test/integration/src/test/java/org/elasticsearch/test/stress/rollingrestart/RollingRestartStressTest.java, +import org.elasticsearch.common.UUID;, +import org.elasticsearch.common.util.concurrent.jsr166y.ThreadLocalRandom;, +import org.elasticsearch.common.xcontent.XContentBuilder;, +    private int textTokens = 150;, +    private int numberOfFields = 10;, +, +    public RollingRestartStressTest textTokens(int textTokens) {, +        this.textTokens = textTokens;, +        return this;, +    }, +, +    public RollingRestartStressTest numberOfFields(int numberOfFields) {, +        this.numberOfFields = numberOfFields;, +        return this;, +    }, +, +            indexerThreads[i].close = true;, +        for (int i = 0; i < indexerThreads.length; i++) {, +            if (!indexerThreads[i].closed) {, +                logger.warn("thread not closed!");, +            }, +        }, +, +        volatile boolean close = false;, +, +                if (close) {, +                    closed = true;, +                } catch (Exception e) {, +                    logger.warn("failed to index / sleep", e);, +    private void indexDoc() throws Exception {, +        StringBuffer sb = new StringBuffer();, +        XContentBuilder json = XContentFactory.jsonBuilder().startObject(), +                .field("field", "value" + ThreadLocalRandom.current().nextInt());, +, +        int fields = ThreadLocalRandom.current().nextInt() % numberOfFields;, +        for (int i = 0; i < fields; i++) {, +            json.field("num_" + i, ThreadLocalRandom.current().nextDouble());, +            int tokens = ThreadLocalRandom.current().nextInt() % textTokens;, +            sb.setLength(0);, +            for (int j = 0; j < tokens; j++) {, +                sb.append(UUID.randomBase64UUID()).append(' ');, +            }, +            json.field("text_" + i, sb.toString());, +        }, +, +        json.endObject();, +, +                .setSource(json), +        indexCounter.incrementAndGet();, +                .textTokens(150), +                .numberOfFields(10), +                .indexerThrottle(TimeValue.timeValueMillis(50))]