[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/geo/GeoBoundingBoxFilter.java, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPoint;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldData;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldDataType;, +    private final String fieldName;, +    public GeoBoundingBoxFilter(Point topLeft, Point bottomRight, String fieldName, FieldDataCache fieldDataCache) {, +        this.fieldName = fieldName;, +    public String fieldName() {, +        return fieldName;, +        final GeoPointFieldData fieldData = (GeoPointFieldData) fieldDataCache.cache(GeoPointFieldDataType.TYPE, reader, fieldName);, +                    if (!fieldData.hasValue(doc)) {, +                    if (fieldData.multiValued()) {, +                        GeoPoint[] points = fieldData.values(doc);, +                        for (GeoPoint point : points) {, +                            if (point.lon() < 0) {, +                                if (-180.0 <= point.lon() && bottomRight.lon >= point.lon(), +                                        && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                                if (topLeft.lon <= point.lon() && 180 >= point.lon(), +                                        && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                        GeoPoint point = fieldData.value(doc);, +                        if (point.lon() < 0) {, +                            if (-180.0 <= point.lon() && bottomRight.lon >= point.lon(), +                                    && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                            if (topLeft.lon <= point.lon() && 180 >= point.lon(), +                                    && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                    if (!fieldData.hasValue(doc)) {, +                    if (fieldData.multiValued()) {, +                        GeoPoint[] points = fieldData.values(doc);, +                        for (GeoPoint point : points) {, +                            if (topLeft.lon <= point.lon() && bottomRight.lon >= point.lon(), +                                    && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                        GeoPoint point = fieldData.value(doc);, +                        if (topLeft.lon <= point.lon() && bottomRight.lon >= point.lon(), +                                && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/geo/GeoBoundingBoxFilter.java, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPoint;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldData;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldDataType;, +    private final String fieldName;, +    public GeoBoundingBoxFilter(Point topLeft, Point bottomRight, String fieldName, FieldDataCache fieldDataCache) {, +        this.fieldName = fieldName;, +    public String fieldName() {, +        return fieldName;, +        final GeoPointFieldData fieldData = (GeoPointFieldData) fieldDataCache.cache(GeoPointFieldDataType.TYPE, reader, fieldName);, +                    if (!fieldData.hasValue(doc)) {, +                    if (fieldData.multiValued()) {, +                        GeoPoint[] points = fieldData.values(doc);, +                        for (GeoPoint point : points) {, +                            if (point.lon() < 0) {, +                                if (-180.0 <= point.lon() && bottomRight.lon >= point.lon(), +                                        && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                                if (topLeft.lon <= point.lon() && 180 >= point.lon(), +                                        && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                        GeoPoint point = fieldData.value(doc);, +                        if (point.lon() < 0) {, +                            if (-180.0 <= point.lon() && bottomRight.lon >= point.lon(), +                                    && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                            if (topLeft.lon <= point.lon() && 180 >= point.lon(), +                                    && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                    if (!fieldData.hasValue(doc)) {, +                    if (fieldData.multiValued()) {, +                        GeoPoint[] points = fieldData.values(doc);, +                        for (GeoPoint point : points) {, +                            if (topLeft.lon <= point.lon() && bottomRight.lon >= point.lon(), +                                    && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +                        GeoPoint point = fieldData.value(doc);, +                        if (topLeft.lon <= point.lon() && bottomRight.lon >= point.lon(), +                                && topLeft.lat >= point.lat() && bottomRight.lat <= point.lat()) {, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/geo/GeoDistanceDataComparator.java, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPoint;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldData;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldDataType;, +    protected final String indexFieldName;, +    protected GeoPointFieldData fieldData;, +        FieldMapper mapper = mapperService.smartNameFieldMapper(fieldName);, +        if (mapper.fieldDataType() != GeoPointFieldDataType.TYPE) {, +            throw new ElasticSearchIllegalArgumentException("field [" + fieldName + "] is not a geo_point field");, +        this.indexFieldName = mapper.names().indexName();, +        fieldData = (GeoPointFieldData) fieldDataCache.cache(GeoPointFieldDataType.TYPE, reader, indexFieldName);, +        if (!fieldData.hasValue(doc)) {, +            GeoPoint point = fieldData.value(doc);, +            distance = geoDistance.calculate(lat, lon, point.lat(), point.lon(), unit);, +        if (!fieldData.hasValue(doc)) {, +            GeoPoint point = fieldData.value(doc);, +            distance = geoDistance.calculate(lat, lon, point.lat(), point.lon(), unit);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/common/lucene/geo/GeoBoundingBoxFilter.java, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPoint;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldData;, +import org.elasticsearch.index.mapper.xcontent.geo.GeoPointFieldDataType;, +    private final String fieldName;, +    public GeoBoundingBoxFilter(Point topLeft, Point bottomRight, String fieldName, FieldDataCache fieldDataCache) {, +        this.fieldName = fieldName;, +    public String fieldName() {, +        return fieldName;, +        final GeoPointFieldData fieldData = (GeoPointFieldData) fieldDataCache.cache(GeoPointFieldDataType.TYPE, reader, fieldName);, +                    if (!fieldData.hasValue(doc)) {, +                    if (fieldData.multiValued()) {, +                        GeoPoint[] points = fieldData.values(doc);, +                        for (GeoPoint point : points) {, +                            if (point.lon() < 0) {]