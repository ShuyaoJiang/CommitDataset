[+++ b/core/src/main/java/org/elasticsearch/action/update/UpdateRequest.java, +        try (XContentParser parser = XContentFactory.xContent(source).createParser(source)) {, +                    XContentType xContentType = XContentFactory.xContentType(source);, +                    XContentType xContentType = XContentFactory.xContentType(source);, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateRequest.java, +        try (XContentParser parser = XContentFactory.xContent(source).createParser(source)) {, +                    XContentType xContentType = XContentFactory.xContentType(source);, +                    XContentType xContentType = XContentFactory.xContentType(source);, +++ b/core/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        if (type == null) {, +            throw new IllegalArgumentException("Cannot get xcontent for unknown type");, +        }, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateRequest.java, +        try (XContentParser parser = XContentFactory.xContent(source).createParser(source)) {, +                    XContentType xContentType = XContentFactory.xContentType(source);, +                    XContentType xContentType = XContentFactory.xContentType(source);, +++ b/core/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        if (type == null) {, +            throw new IllegalArgumentException("Cannot get xcontent for unknown type");, +        }, +++ b/core/src/test/java/org/elasticsearch/action/update/UpdateRequestTests.java, +import org.elasticsearch.ElasticsearchParseException;, +, +    // Related to issue #15822, +    public void testInvalidBodyThrowsParseException() throws Exception {, +        UpdateRequest request = new UpdateRequest("test", "type", "1");, +        try {, +            request.source(new byte[] { (byte) '"' });, +            fail("Should have thrown a ElasticsearchParseException");, +        } catch (ElasticsearchParseException e) {, +            assertThat(e.getMessage(), equalTo("Failed to derive xcontent"));, +        }, +    }, +++ b/core/src/main/java/org/elasticsearch/action/update/UpdateRequest.java, +        try (XContentParser parser = XContentFactory.xContent(source).createParser(source)) {, +                    XContentType xContentType = XContentFactory.xContentType(source);, +                    XContentType xContentType = XContentFactory.xContentType(source);, +++ b/core/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java, +        if (type == null) {, +            throw new IllegalArgumentException("Cannot get xcontent for unknown type");, +        }, +++ b/core/src/test/java/org/elasticsearch/action/update/UpdateRequestTests.java, +import org.elasticsearch.ElasticsearchParseException;, +, +    // Related to issue #15822, +    public void testInvalidBodyThrowsParseException() throws Exception {, +        UpdateRequest request = new UpdateRequest("test", "type", "1");, +        try {, +            request.source(new byte[] { (byte) '"' });, +            fail("Should have thrown a ElasticsearchParseException");, +        } catch (ElasticsearchParseException e) {, +            assertThat(e.getMessage(), equalTo("Failed to derive xcontent"));, +        }, +    }, +++ b/core/src/test/java/org/elasticsearch/common/xcontent/XContentFactoryTests.java, +    public void testInvalidStream() throws Exception {, +        byte[] bytes = new byte[] { (byte) '"' };, +        assertNull(XContentFactory.xContentType(bytes));, +, +        bytes = new byte[] { (byte) 'x' };, +        assertNull(XContentFactory.xContentType(bytes));, +    }, +]