[+++ b/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadTests.java, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), numDocs)) {, +++ b/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadTests.java, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), numDocs)) {, +++ b/src/test/java/org/elasticsearch/recovery/RelocationTests.java, +        int numDocs = scaledRandomIntBetween(200, 2500);, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type1", client(), numDocs)) {, +                numDocs = scaledRandomIntBetween(200, 1000);, +                logger.debug("--> Allow indexer to index [{}] documents", numDocs);, +                indexer.continueIndexing(numDocs);, +                indexer.pauseIndexing();, +++ b/src/test/java/org/elasticsearch/recovery/RecoveryWhileUnderLoadTests.java, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +        int extraDocs = waitFor;, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), extraDocs)) {, +            extraDocs = totalNumDocs / 10;, +            waitFor += extraDocs;, +            indexer.continueIndexing(extraDocs);, +            extraDocs = totalNumDocs - waitFor;, +            indexer.continueIndexing(extraDocs);, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type", client(), numDocs)) {, +++ b/src/test/java/org/elasticsearch/recovery/RelocationTests.java, +        int numDocs = scaledRandomIntBetween(200, 2500);, +        try (BackgroundIndexer indexer = new BackgroundIndexer("test", "type1", client(), numDocs)) {, +                numDocs = scaledRandomIntBetween(200, 1000);, +                logger.debug("--> Allow indexer to index [{}] documents", numDocs);, +                indexer.continueIndexing(numDocs);, +                indexer.pauseIndexing();, +++ b/src/test/java/org/elasticsearch/test/BackgroundIndexer.java, +import java.util.concurrent.Semaphore;, +    final AtomicBoolean hasBudget = new AtomicBoolean(false); // when set to true, writers will acquire writes from a semaphore, +    final Semaphore availableBudget = new Semaphore(0);, +    /**, +     * Start indexing in the background using a random number of threads., +     *, +     * @param index  index name to index into, +     * @param type   document type, +     * @param client client to use, +     */]