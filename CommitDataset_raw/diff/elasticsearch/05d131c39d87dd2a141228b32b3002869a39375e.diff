[+++ b/src/main/java/org/elasticsearch/indices/store/IndicesStore.java, +import org.elasticsearch.cluster.node.DiscoveryNode;, +import org.elasticsearch.transport.TransportService;, +    private final TransportService transportService;, +    public IndicesStore(Settings settings, NodeEnvironment nodeEnv, NodeSettingsService nodeSettingsService, IndicesService indicesService,, +                        ClusterService clusterService, TransportService transportService) {, +        this.transportService = transportService;, +, +                        // if the allocated or relocation node id doesn't exists in the cluster state or we're not connected to it, +                        // it may be a stale node, make sure we don't do anything with this until the routing table has properly been, +                        DiscoveryNode node = event.state().nodes().get(shardRouting.currentNodeId());, +                        if (node == null || !transportService.nodeConnected(node)) {, +                            node = event.state().nodes().get(shardRouting.relocatingNodeId());, +                            if (node == null || !transportService.nodeConnected(node)) {]