[+++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        return shards.keySet();, +++ b/src/main/java/org/elasticsearch/index/service/InternalIndexService.java, +        return shards.keySet();, +++ b/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java, +import gnu.trove.set.hash.TIntHashSet;, +        RoutingNode routingNode = event.state().readOnlyRoutingNodes().nodesToShards().get(event.state().nodes().localNodeId());, +        if (routingNode == null) {, +        TIntHashSet newShardIds = new TIntHashSet();, +        for (IndexService indexService : indicesService) {, +            String index = indexService.index().name();, +            if (indexMetaData == null) {, +                continue;, +            }, +            newShardIds.clear();, +            List<MutableShardRouting> shards = routingNode.shards();, +            for (int i = 0; i < shards.size(); i++) {, +                ShardRouting shardRouting = shards.get(i);]