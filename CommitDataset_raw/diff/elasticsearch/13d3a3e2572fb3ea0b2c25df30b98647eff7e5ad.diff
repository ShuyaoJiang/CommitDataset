[+++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +        CREATE_FAILED_ENGINE_EXCEPTION(org.elasticsearch.index.engine.CreateFailedEngineException.class, org.elasticsearch.index.engine.CreateFailedEngineException::new, 22),, +        DOCUMENT_ALREADY_EXISTS_EXCEPTION(org.elasticsearch.index.engine.DocumentAlreadyExistsException.class, org.elasticsearch.index.engine.DocumentAlreadyExistsException::new, 54),, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +        CREATE_FAILED_ENGINE_EXCEPTION(org.elasticsearch.index.engine.CreateFailedEngineException.class, org.elasticsearch.index.engine.CreateFailedEngineException::new, 22),, +        DOCUMENT_ALREADY_EXISTS_EXCEPTION(org.elasticsearch.index.engine.DocumentAlreadyExistsException.class, org.elasticsearch.index.engine.DocumentAlreadyExistsException::new, 54),, +++ b/core/src/main/java/org/elasticsearch/action/UnavailableShardsException.java, +import org.elasticsearch.common.collect.HppcMaps;, +    public UnavailableShardsException(@Nullable ShardId shardId, String message, Object... args) {, +        super(buildMessage(shardId, message), args);, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +        CREATE_FAILED_ENGINE_EXCEPTION(org.elasticsearch.index.engine.CreateFailedEngineException.class, org.elasticsearch.index.engine.CreateFailedEngineException::new, 22),, +        DOCUMENT_ALREADY_EXISTS_EXCEPTION(org.elasticsearch.index.engine.DocumentAlreadyExistsException.class, org.elasticsearch.index.engine.DocumentAlreadyExistsException::new, 54),, +++ b/core/src/main/java/org/elasticsearch/action/UnavailableShardsException.java, +import org.elasticsearch.common.collect.HppcMaps;, +    public UnavailableShardsException(@Nullable ShardId shardId, String message, Object... args) {, +        super(buildMessage(shardId, message), args);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +import org.elasticsearch.index.engine.DocumentAlreadyExistsException;, +                    if (t instanceof VersionConflictEngineException || (t instanceof DocumentAlreadyExistsException && translate.operation() == UpdateHelper.Operation.UPSERT)) {, +                    final Engine.IndexingOperation operation;, +                    if (indexRequest.opType() == IndexRequest.OpType.INDEX) {, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA);, +                    } else {, +                        assert indexRequest.opType() == IndexRequest.OpType.CREATE : indexRequest.opType();, +                        operation = indexShard.prepareCreate(sourceToParse,, +                                indexRequest.version(), indexRequest.versionType(),, +                                Engine.Operation.Origin.REPLICA);, +                    }, +                    operation.execute(indexShard);, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +        CREATE_FAILED_ENGINE_EXCEPTION(org.elasticsearch.index.engine.CreateFailedEngineException.class, org.elasticsearch.index.engine.CreateFailedEngineException::new, 22),, +        DOCUMENT_ALREADY_EXISTS_EXCEPTION(org.elasticsearch.index.engine.DocumentAlreadyExistsException.class, org.elasticsearch.index.engine.DocumentAlreadyExistsException::new, 54),, +++ b/core/src/main/java/org/elasticsearch/action/UnavailableShardsException.java, +import org.elasticsearch.common.collect.HppcMaps;, +    public UnavailableShardsException(@Nullable ShardId shardId, String message, Object... args) {, +        super(buildMessage(shardId, message), args);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +import org.elasticsearch.index.engine.DocumentAlreadyExistsException;, +                    if (t instanceof VersionConflictEngineException || (t instanceof DocumentAlreadyExistsException && translate.operation() == UpdateHelper.Operation.UPSERT)) {, +                    final Engine.IndexingOperation operation;, +                    if (indexRequest.opType() == IndexRequest.OpType.INDEX) {, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA);, +                    } else {, +                        assert indexRequest.opType() == IndexRequest.OpType.CREATE : indexRequest.opType();, +                        operation = indexShard.prepareCreate(sourceToParse,, +                                indexRequest.version(), indexRequest.versionType(),, +                                Engine.Operation.Origin.REPLICA);, +                    }, +                    operation.execute(indexShard);, +++ b/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java, + * <p>, + * <p>, + * <p>, +     * <p>, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +        CREATE_FAILED_ENGINE_EXCEPTION(org.elasticsearch.index.engine.CreateFailedEngineException.class, org.elasticsearch.index.engine.CreateFailedEngineException::new, 22),, +        DOCUMENT_ALREADY_EXISTS_EXCEPTION(org.elasticsearch.index.engine.DocumentAlreadyExistsException.class, org.elasticsearch.index.engine.DocumentAlreadyExistsException::new, 54),, +++ b/core/src/main/java/org/elasticsearch/action/UnavailableShardsException.java, +import org.elasticsearch.common.collect.HppcMaps;, +    public UnavailableShardsException(@Nullable ShardId shardId, String message, Object... args) {, +        super(buildMessage(shardId, message), args);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +import org.elasticsearch.index.engine.DocumentAlreadyExistsException;, +                    if (t instanceof VersionConflictEngineException || (t instanceof DocumentAlreadyExistsException && translate.operation() == UpdateHelper.Operation.UPSERT)) {, +                    final Engine.IndexingOperation operation;, +                    if (indexRequest.opType() == IndexRequest.OpType.INDEX) {, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA);, +                    } else {, +                        assert indexRequest.opType() == IndexRequest.OpType.CREATE : indexRequest.opType();, +                        operation = indexShard.prepareCreate(sourceToParse,, +                                indexRequest.version(), indexRequest.versionType(),, +                                Engine.Operation.Origin.REPLICA);, +                    }, +                    operation.execute(indexShard);, +++ b/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java, + * <p>, + * <p>, + * <p>, +     * <p>, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, + * <p>, +        final Engine.IndexingOperation operation;, +        if (request.opType() == IndexRequest.OpType.INDEX) {, +            operation = indexShard.prepareIndex(sourceToParse, request.version(), request.versionType(), Engine.Operation.Origin.REPLICA);, +        } else {, +            assert request.opType() == IndexRequest.OpType.CREATE : request.opType();, +            operation = indexShard.prepareCreate(sourceToParse, request.version(), request.versionType(), Engine.Operation.Origin.REPLICA);, +        }, +        operation.execute(indexShard);, +++ b/core/src/main/java/org/elasticsearch/ElasticsearchException.java, +        CREATE_FAILED_ENGINE_EXCEPTION(org.elasticsearch.index.engine.CreateFailedEngineException.class, org.elasticsearch.index.engine.CreateFailedEngineException::new, 22),, +        DOCUMENT_ALREADY_EXISTS_EXCEPTION(org.elasticsearch.index.engine.DocumentAlreadyExistsException.class, org.elasticsearch.index.engine.DocumentAlreadyExistsException::new, 54),, +++ b/core/src/main/java/org/elasticsearch/action/UnavailableShardsException.java, +import org.elasticsearch.common.collect.HppcMaps;, +    public UnavailableShardsException(@Nullable ShardId shardId, String message, Object... args) {, +        super(buildMessage(shardId, message), args);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +import org.elasticsearch.index.engine.DocumentAlreadyExistsException;, +                    if (t instanceof VersionConflictEngineException || (t instanceof DocumentAlreadyExistsException && translate.operation() == UpdateHelper.Operation.UPSERT)) {]