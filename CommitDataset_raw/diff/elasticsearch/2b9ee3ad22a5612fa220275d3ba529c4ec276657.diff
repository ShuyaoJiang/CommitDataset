[+++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/test/framework/src/main/java/org/elasticsearch/test/BackgroundIndexer.java, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/test/framework/src/main/java/org/elasticsearch/test/BackgroundIndexer.java, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESSingleNodeTestCase.java, +        return new TestSearchContext(bigArrays, indexService);, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/test/framework/src/main/java/org/elasticsearch/test/BackgroundIndexer.java, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESSingleNodeTestCase.java, +        return new TestSearchContext(bigArrays, indexService);, +++ b/test/framework/src/main/java/org/elasticsearch/test/TestSearchContext.java, +    public TestSearchContext(BigArrays bigArrays, IndexService indexService) {, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/test/framework/src/main/java/org/elasticsearch/test/BackgroundIndexer.java, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESSingleNodeTestCase.java, +        return new TestSearchContext(bigArrays, indexService);, +++ b/test/framework/src/main/java/org/elasticsearch/test/TestSearchContext.java, +    public TestSearchContext(BigArrays bigArrays, IndexService indexService) {, +++ /dev/null, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/test/framework/src/main/java/org/elasticsearch/test/BackgroundIndexer.java, +++ b/test/framework/src/main/java/org/elasticsearch/test/ESSingleNodeTestCase.java, +        return new TestSearchContext(bigArrays, indexService);, +++ b/test/framework/src/main/java/org/elasticsearch/test/TestSearchContext.java, +    public TestSearchContext(BigArrays bigArrays, IndexService indexService) {, +++ /dev/null, +++ b/test/framework/src/main/java/org/elasticsearch/test/disruption/BlockClusterStateProcessing.java, +    private final AtomicReference<CountDownLatch> disruptionLatch = new AtomicReference<>();, +++ b/server/src/test/java/org/elasticsearch/discovery/PeerFinderTests.java, +            = new StubbableConnectionManager(innerConnectionManager, settings, capturingTransport);, +++ b/server/src/test/java/org/elasticsearch/index/SearchSlowLogTests.java, +        return new TestSearchContext(bigArrays, indexService) {, +++ b/server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +                StubbableConnectionManager connectionManager = new StubbableConnectionManager(delegate, Settings.EMPTY, service.transport);, +++ b/test/framework/src/main/java/org/elasticsearch/test/AbstractQueryTestCase.java, +    protected QueryBuilder rewriteAndFetch(QueryBuilder builder, QueryRewriteContext context) {, +++ b/test/framework/src/main/java/org/elasticsearch/test/BackgroundIndexer.java]