[+++ b/core/src/main/java/org/elasticsearch/common/network/NetworkUtils.java, +    static final boolean PREFER_V6 = Boolean.parseBoolean(System.getProperty("java.net.preferIPv6Addresses", "false"));, +    static int sortKey(InetAddress address, boolean prefer_v6) {, +        if (prefer_v6) {, +                int cmp = Integer.compare(sortKey(left, PREFER_V6), sortKey(right, PREFER_V6));, +++ b/core/src/main/java/org/elasticsearch/common/network/NetworkUtils.java, +    static final boolean PREFER_V6 = Boolean.parseBoolean(System.getProperty("java.net.preferIPv6Addresses", "false"));, +    static int sortKey(InetAddress address, boolean prefer_v6) {, +        if (prefer_v6) {, +                int cmp = Integer.compare(sortKey(left, PREFER_V6), sortKey(right, PREFER_V6));, +++ b/core/src/test/java/org/elasticsearch/common/network/NetworkUtilsTests.java, +        assertTrue(NetworkUtils.sortKey(localhostv4, false) < NetworkUtils.sortKey(localhostv6, false));, +        assertTrue(NetworkUtils.sortKey(localhostv6, true) < NetworkUtils.sortKey(localhostv4, true));, +++ b/core/src/main/java/org/elasticsearch/common/network/NetworkUtils.java, +    static final boolean PREFER_V6 = Boolean.parseBoolean(System.getProperty("java.net.preferIPv6Addresses", "false"));, +    static int sortKey(InetAddress address, boolean prefer_v6) {, +        if (prefer_v6) {, +                int cmp = Integer.compare(sortKey(left, PREFER_V6), sortKey(right, PREFER_V6));, +++ b/core/src/test/java/org/elasticsearch/common/network/NetworkUtilsTests.java, +        assertTrue(NetworkUtils.sortKey(localhostv4, false) < NetworkUtils.sortKey(localhostv6, false));, +        assertTrue(NetworkUtils.sortKey(localhostv6, true) < NetworkUtils.sortKey(localhostv4, true));, +++ b/core/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java, +++ b/core/src/main/java/org/elasticsearch/common/network/NetworkUtils.java, +    static final boolean PREFER_V6 = Boolean.parseBoolean(System.getProperty("java.net.preferIPv6Addresses", "false"));, +    static int sortKey(InetAddress address, boolean prefer_v6) {, +        if (prefer_v6) {, +                int cmp = Integer.compare(sortKey(left, PREFER_V6), sortKey(right, PREFER_V6));, +++ b/core/src/test/java/org/elasticsearch/common/network/NetworkUtilsTests.java, +        assertTrue(NetworkUtils.sortKey(localhostv4, false) < NetworkUtils.sortKey(localhostv6, false));, +        assertTrue(NetworkUtils.sortKey(localhostv6, true) < NetworkUtils.sortKey(localhostv4, true));, +++ b/core/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java, +++ b/core/src/test/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java, +import org.elasticsearch.snapshots.mockstore.MockRepositoryModule;, +    @AwaitsFix(bugUrl = "https://github.com/elastic/elasticsearch/issues/12855")]