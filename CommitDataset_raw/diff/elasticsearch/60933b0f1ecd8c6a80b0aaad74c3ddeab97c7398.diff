[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java, +import org.elasticsearch.cluster.routing.allocation.AllocationService;, +import org.elasticsearch.cluster.routing.allocation.RoutingAllocation;, +import static org.elasticsearch.cluster.ClusterState.*;, +, +    private final AllocationService allocationService;, +, +    @Inject public TransportClusterUpdateSettingsAction(Settings settings, TransportService transportService, ClusterService clusterService, ThreadPool threadPool,, +                                                        AllocationService allocationService) {, +        this.allocationService = allocationService;, +                    ClusterState updatedState = ClusterState.builder().state(currentState).metaData(metaData).build();, +, +                    // now, reroute in case things change that require it (like number of replicas), +                    RoutingAllocation.Result routingResult = allocationService.reroute(updatedState);, +                    updatedState = newClusterStateBuilder().state(updatedState).routingResult(routingResult).build();, +, +                    return updatedState;]