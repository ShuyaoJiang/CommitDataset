[+++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java, +                .indexShards(clusterState, request.concreteIndex(), request.id(), request.routing());, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java, +                .indexShards(clusterState, request.concreteIndex(), request.id(), request.routing());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +    public ShardIterator indexShards(ClusterState clusterState, String index, String id, @Nullable String routing) {, +    public ShardIterator getShards(ClusterState clusterState, String index, String id, @Nullable String routing, @Nullable String preference) {, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.id(), item.routing(), null).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/termvectors/TransportTermVectorsAction.java, +        return clusterService.operationRouting().getShards(state, request.concreteIndex(), request.request().id(),, +++ b/core/src/main/java/org/elasticsearch/action/update/TransportUpdateAction.java, +                .indexShards(clusterState, request.concreteIndex(), request.id(), request.routing());, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +    public ShardIterator indexShards(ClusterState clusterState, String index, String id, @Nullable String routing) {, +    public ShardIterator getShards(ClusterState clusterState, String index, String id, @Nullable String routing, @Nullable String preference) {, +++ b/core/src/main/java/org/elasticsearch/common/rounding/TimeZoneRounding.java, +            return timeZone.convertLocalToUTC(rounded, false, utcMillis);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, indexRequest.id(), indexRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, deleteRequest.id(), deleteRequest.routing()).shardId();, +                ShardId shardId = clusterService.operationRouting().indexShards(clusterState, concreteIndex, updateRequest.id(), updateRequest.routing()).shardId();, +++ b/core/src/main/java/org/elasticsearch/action/explain/TransportExplainAction.java, +                clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference(), +++ b/core/src/main/java/org/elasticsearch/action/get/TransportGetAction.java, +                .getShards(clusterService.state(), request.concreteIndex(), request.request().id(), request.request().routing(), request.request().preference());, +++ b/core/src/main/java/org/elasticsearch/action/get/TransportMultiGetAction.java, +                    .getShards(clusterState, concreteSingleIndex, item.id(), item.routing(), null).shardId();]