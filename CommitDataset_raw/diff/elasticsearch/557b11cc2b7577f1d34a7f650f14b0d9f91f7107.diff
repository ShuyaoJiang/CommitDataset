[+++ b/core/src/test/java/org/elasticsearch/cluster/ClusterServiceIT.java, +import java.util.concurrent.BrokenBarrierException;, +import java.util.concurrent.CyclicBarrier;, +    public void testClusterStateUpdateTasksAreExecutedInOrder() throws BrokenBarrierException, InterruptedException {, +        CyclicBarrier barrier = new CyclicBarrier(1 + numberOfThreads);, +                try {, +                    barrier.await();, +                    barrier.await();, +                } catch (InterruptedException | BrokenBarrierException e) {, +                    throw new AssertionError(e);, +        // wait for all threads to be ready, +        barrier.await();, +        // wait for all threads to finish, +        barrier.await();]