[+++ b/core/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java, +import com.google.common.base.Predicate;, +        return allSatisfyingPredicateShardsGrouped(indices, includeEmpty, includeRelocationTargets, ACTIVE_PREDICATE);, +        return allSatisfyingPredicateShardsGrouped(indices, includeEmpty, includeRelocationTargets, ASSIGNED_PREDICATE);, +    }, +, +    private static Predicate<ShardRouting> ACTIVE_PREDICATE = new Predicate<ShardRouting>() {, +        @Override, +        public boolean apply(ShardRouting shardRouting) {, +            return shardRouting.active();, +        }, +    };, +, +    private static Predicate<ShardRouting> ASSIGNED_PREDICATE = new Predicate<ShardRouting>() {, +        @Override, +        public boolean apply(ShardRouting shardRouting) {, +            return shardRouting.assignedToNode();, +        }, +    };, +, +    // TODO: replace with JDK 8 native java.util.function.Predicate, +    private GroupShardsIterator allSatisfyingPredicateShardsGrouped(String[] indices, boolean includeEmpty, boolean includeRelocationTargets, Predicate<ShardRouting> predicate) {, +                    if (predicate.apply(shardRouting)) {]