[+++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/percolator/PercolatorExecutor.java, +import org.elasticsearch.indices.IndicesService;, +    private IndicesService indicesService;, +    public void setIndicesService(IndicesService indicesService) {, +        this.indicesService = indicesService;, +            IndexService percolatorIndex = indicesService.indexService(PercolatorService.INDEX_NAME);, +            if (percolatorIndex == null) {, +            if (percolatorIndex.numberOfShards() == 0) {, +                throw new PercolateIndexUnavailable(new Index(PercolatorService.INDEX_NAME));, +            }, +            IndexShard percolatorShard = percolatorIndex.shard(0);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/percolator/PercolatorExecutor.java, +import org.elasticsearch.indices.IndicesService;, +    private IndicesService indicesService;, +    public void setIndicesService(IndicesService indicesService) {, +        this.indicesService = indicesService;, +            IndexService percolatorIndex = indicesService.indexService(PercolatorService.INDEX_NAME);, +            if (percolatorIndex == null) {, +            if (percolatorIndex.numberOfShards() == 0) {, +                throw new PercolateIndexUnavailable(new Index(PercolatorService.INDEX_NAME));, +            }, +            IndexShard percolatorShard = percolatorIndex.shard(0);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/percolator/PercolatorService.java, +        this.percolator.setIndicesService(indicesService);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/percolator/PercolatorExecutor.java, +import org.elasticsearch.indices.IndicesService;, +    private IndicesService indicesService;, +    public void setIndicesService(IndicesService indicesService) {, +        this.indicesService = indicesService;, +            IndexService percolatorIndex = indicesService.indexService(PercolatorService.INDEX_NAME);, +            if (percolatorIndex == null) {, +            if (percolatorIndex.numberOfShards() == 0) {, +                throw new PercolateIndexUnavailable(new Index(PercolatorService.INDEX_NAME));, +            }, +            IndexShard percolatorShard = percolatorIndex.shard(0);, +++ b/modules/elasticsearch/src/main/java/org/elasticsearch/index/percolator/PercolatorService.java, +        this.percolator.setIndicesService(indicesService);, +++ b/modules/test/integration/src/test/java/org/elasticsearch/test/integration/percolator/SimplePercolatorTests.java, +, +        percolate = client.preparePercolate("test", "type1").setSource(jsonBuilder().startObject(), +                .startObject("doc").field("field1", "value1").endObject(), +                .field("query", matchAllQuery()), +                .endObject()), +                .execute().actionGet();, +        assertThat(percolate.matches().size(), equalTo(1));]