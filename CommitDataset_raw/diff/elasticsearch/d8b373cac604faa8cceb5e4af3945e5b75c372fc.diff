[+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/Analyzer.java, +        metadata.docValueSlot = utility.addVariable(null, "doc", definition.smapType).slot;, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/Analyzer.java, +        metadata.docValueSlot = utility.addVariable(null, "doc", definition.smapType).slot;, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/AnalyzerExternal.java, +, +        if (dotctx != null) {, +            metadata.createExtNodeMetadata(parent, dotctx);, +            analyzer.visit(dotctx);, +        } else if (bracectx != null) {, +            metadata.createExtNodeMetadata(parent, bracectx);, +            analyzer.visit(bracectx);, +        }, +            if (varenmd.last && ("_score".equals(id) || "doc".equals(id))) {, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/Analyzer.java, +        metadata.docValueSlot = utility.addVariable(null, "doc", definition.smapType).slot;, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/AnalyzerExternal.java, +, +        if (dotctx != null) {, +            metadata.createExtNodeMetadata(parent, dotctx);, +            analyzer.visit(dotctx);, +        } else if (bracectx != null) {, +            metadata.createExtNodeMetadata(parent, bracectx);, +            analyzer.visit(bracectx);, +        }, +            if (varenmd.last && ("_score".equals(id) || "doc".equals(id))) {, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/WriterExternal.java, +                if (maplist && constant != null) {, +                if (field || name || (shortcut && !maplist)) {, +                    execute.dupX1();, +                } else if (array || maplist) {, +                    execute.dup2X1();, +                if (maplist && constant != null) {, +                if (field || name || (shortcut && !maplist)) {, +                    execute.dup();, +                } else if (array || maplist) {, +                    execute.dup2();, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/Analyzer.java, +        metadata.docValueSlot = utility.addVariable(null, "doc", definition.smapType).slot;, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/AnalyzerExternal.java, +, +        if (dotctx != null) {, +            metadata.createExtNodeMetadata(parent, dotctx);, +            analyzer.visit(dotctx);, +        } else if (bracectx != null) {, +            metadata.createExtNodeMetadata(parent, bracectx);, +            analyzer.visit(bracectx);, +        }, +            if (varenmd.last && ("_score".equals(id) || "doc".equals(id))) {, +++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/WriterExternal.java, +                if (maplist && constant != null) {, +                if (field || name || (shortcut && !maplist)) {, +                    execute.dupX1();, +                } else if (array || maplist) {, +                    execute.dup2X1();, +                if (maplist && constant != null) {, +                if (field || name || (shortcut && !maplist)) {, +                    execute.dup();, +                } else if (array || maplist) {, +                    execute.dup2();, +++ b/modules/lang-painless/src/test/java/org/elasticsearch/painless/NeedsScoreTests.java]