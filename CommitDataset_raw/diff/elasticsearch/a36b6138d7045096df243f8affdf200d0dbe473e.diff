[+++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.aggregations.metrics.avg.AvgAggregatorBuilder;, +        registerAggregation(AvgAggregatorBuilder::new, new AvgParser(), AvgAggregatorBuilder.AGGREGATION_NAME_FIELD);, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.aggregations.metrics.avg.AvgAggregatorBuilder;, +        registerAggregation(AvgAggregatorBuilder::new, new AvgParser(), AvgAggregatorBuilder.AGGREGATION_NAME_FIELD);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        assert usesNewStyleSerialization() == false: "migrated aggregations should just return their NAME";, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.aggregations.metrics.avg.AvgAggregatorBuilder;, +        registerAggregation(AvgAggregatorBuilder::new, new AvgParser(), AvgAggregatorBuilder.AGGREGATION_NAME_FIELD);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        assert usesNewStyleSerialization() == false: "migrated aggregations should just return their NAME";, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/avg/AvgAggregatorBuilder.java, +import org.elasticsearch.common.ParseField;, +import org.elasticsearch.search.aggregations.AggregatorFactory;, +import org.elasticsearch.search.aggregations.support.ValuesSource.Numeric;, +    public static final String NAME = InternalAvg.TYPE.name();, +    public static final ParseField AGGREGATION_NAME_FIELD = new ParseField(NAME);, +    /**, +     * Read from a stream., +     */, +    public AvgAggregatorBuilder(StreamInput in) throws IOException {, +        super(in, InternalAvg.TYPE, ValuesSourceType.NUMERIC, ValueType.NUMERIC);, +    }, +, +    @Override, +    protected void innerWriteTo(StreamOutput out) {, +        // Do nothing, no extra state to write to stream, +    }, +, +    @Override, +    protected boolean usesNewStyleSerialization() {, +        return true;, +    }, +, +, +    @Override, +    public String getWriteableName() {, +        return NAME;, +    }, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.aggregations.metrics.avg.AvgAggregatorBuilder;, +        registerAggregation(AvgAggregatorBuilder::new, new AvgParser(), AvgAggregatorBuilder.AGGREGATION_NAME_FIELD);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        assert usesNewStyleSerialization() == false: "migrated aggregations should just return their NAME";, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/avg/AvgAggregatorBuilder.java, +import org.elasticsearch.common.ParseField;, +import org.elasticsearch.search.aggregations.AggregatorFactory;, +import org.elasticsearch.search.aggregations.support.ValuesSource.Numeric;, +    public static final String NAME = InternalAvg.TYPE.name();, +    public static final ParseField AGGREGATION_NAME_FIELD = new ParseField(NAME);, +    /**, +     * Read from a stream., +     */, +    public AvgAggregatorBuilder(StreamInput in) throws IOException {, +        super(in, InternalAvg.TYPE, ValuesSourceType.NUMERIC, ValueType.NUMERIC);, +    }, +, +    @Override, +    protected void innerWriteTo(StreamOutput out) {, +        // Do nothing, no extra state to write to stream, +    }, +, +    @Override, +    protected boolean usesNewStyleSerialization() {, +        return true;, +    }, +, +, +    @Override, +    public String getWriteableName() {, +        return NAME;, +    }, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/avg/AvgParser.java, +++ b/core/src/main/java/org/elasticsearch/search/SearchModule.java, +import org.elasticsearch.search.aggregations.metrics.avg.AvgAggregatorBuilder;, +        registerAggregation(AvgAggregatorBuilder::new, new AvgParser(), AvgAggregatorBuilder.AGGREGATION_NAME_FIELD);, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/AggregatorBuilder.java, +        assert usesNewStyleSerialization() == false: "migrated aggregations should just return their NAME";, +++ b/core/src/main/java/org/elasticsearch/search/aggregations/metrics/avg/AvgAggregatorBuilder.java, +import org.elasticsearch.common.ParseField;, +import org.elasticsearch.search.aggregations.AggregatorFactory;, +import org.elasticsearch.search.aggregations.support.ValuesSource.Numeric;, +    public static final String NAME = InternalAvg.TYPE.name();, +    public static final ParseField AGGREGATION_NAME_FIELD = new ParseField(NAME);, +    /**, +     * Read from a stream., +     */, +    public AvgAggregatorBuilder(StreamInput in) throws IOException {, +        super(in, InternalAvg.TYPE, ValuesSourceType.NUMERIC, ValueType.NUMERIC);, +    }, +, +    @Override, +    protected void innerWriteTo(StreamOutput out) {, +        // Do nothing, no extra state to write to stream, +    }, +, +    @Override, +    protected boolean usesNewStyleSerialization() {]