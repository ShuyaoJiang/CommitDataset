[+++ b/src/main/java/org/elasticsearch/action/support/replication/TransportShardReplicationOperationAction.java, +        // that a new change has crept into the replica, and it's fine, +++ b/src/main/java/org/elasticsearch/action/support/replication/TransportShardReplicationOperationAction.java, +        // that a new change has crept into the replica, and it's fine, +++ b/src/main/java/org/elasticsearch/index/engine/internal/InternalEngine.java, +        // if the doc exists, +        boolean doUpdate = false;, +        if ((versionValue != null && versionValue.delete() == false) || (versionValue == null && currentVersion != Versions.NOT_FOUND)) {, +            } else if (create.origin() == Operation.Origin.REPLICA) {, +                // #7142: the primary already determined it's OK to index this document, and we confirmed above that the version doesn't, +                // conflict, so we must also update here on the replica to remain consistent:, +                doUpdate = true;, +                // On primary, we throw DAEE if the _uid is already in the index with an older version:, +                assert create.origin() == Operation.Origin.PRIMARY;, +        if (doUpdate) {, +            if (create.docs().size() > 1) {, +                writer.updateDocuments(create.uid(), create.docs(), create.analyzer());, +            } else {, +                writer.updateDocument(create.uid(), create.docs().get(0), create.analyzer());, +            }, +        } else {, +        }]