[+++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java, +    public static final int DEFAULT_SOCKET_TIMEOUT_MILLIS = 30000;, +        RequestConfig.Builder requestConfigBuilder = RequestConfig.custom(), +                .setConnectTimeout(DEFAULT_CONNECT_TIMEOUT_MILLIS), +++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java, +    public static final int DEFAULT_SOCKET_TIMEOUT_MILLIS = 30000;, +        RequestConfig.Builder requestConfigBuilder = RequestConfig.custom(), +                .setConnectTimeout(DEFAULT_CONNECT_TIMEOUT_MILLIS), +++ b/core/src/main/java/org/elasticsearch/action/ActionListener.java, +import java.io.IOException;, +, +    /** A consumer interface which allows throwing checked exceptions. */, +    @FunctionalInterface, +    interface CheckedConsumer<T> {, +        void accept(T t) throws Exception;, +    }, +, +    static <Response> ActionListener<Response> wrap(CheckedConsumer<Response> onResponse, Consumer<Exception> onFailure) {, +++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java, +    public static final int DEFAULT_SOCKET_TIMEOUT_MILLIS = 30000;, +        RequestConfig.Builder requestConfigBuilder = RequestConfig.custom(), +                .setConnectTimeout(DEFAULT_CONNECT_TIMEOUT_MILLIS), +++ b/core/src/main/java/org/elasticsearch/action/ActionListener.java, +import java.io.IOException;, +, +    /** A consumer interface which allows throwing checked exceptions. */, +    @FunctionalInterface, +    interface CheckedConsumer<T> {, +        void accept(T t) throws Exception;, +    }, +, +    static <Response> ActionListener<Response> wrap(CheckedConsumer<Response> onResponse, Consumer<Exception> onFailure) {, +++ b/core/src/main/java/org/elasticsearch/action/ActionModule.java, +import java.util.function.UnaryOperator;, +import org.apache.logging.log4j.Logger;, +import org.elasticsearch.common.logging.ESLoggerFactory;, +import org.elasticsearch.threadpool.ThreadPool;, +    private static final Logger logger = ESLoggerFactory.getLogger(ActionModule.class);, +, +    public ActionModule(boolean transportClient, Settings settings, IndexNameExpressionResolver resolver,, +                        ClusterSettings clusterSettings, ThreadPool threadPool, List<ActionPlugin> actionPlugins) {, +        actionFilters = setupActionFilters(actionPlugins);, +        UnaryOperator<RestHandler> restWrapper = null;, +        for (ActionPlugin plugin : actionPlugins) {, +            UnaryOperator<RestHandler> newRestWrapper = plugin.getRestHandlerWrapper(threadPool.getThreadContext());, +            if (newRestWrapper != null) {, +                logger.debug("Using REST wrapper from plugin " + plugin.getClass().getName());, +                if (restWrapper != null) {, +                    throw new IllegalArgumentException("Cannot have more than one plugin implementing a REST wrapper");, +                }, +                restWrapper = newRestWrapper;, +            }, +        }, +        restController = new RestController(settings, headers, restWrapper);, +    private List<Class<? extends ActionFilter>> setupActionFilters(List<ActionPlugin> actionPlugins) {, +        return unmodifiableList(actionPlugins.stream().flatMap(p -> p.getActionFilters().stream()).collect(Collectors.toList()));, +++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java, +    public static final int DEFAULT_SOCKET_TIMEOUT_MILLIS = 30000;, +        RequestConfig.Builder requestConfigBuilder = RequestConfig.custom(), +                .setConnectTimeout(DEFAULT_CONNECT_TIMEOUT_MILLIS), +++ b/core/src/main/java/org/elasticsearch/action/ActionListener.java, +import java.io.IOException;, +, +    /** A consumer interface which allows throwing checked exceptions. */, +    @FunctionalInterface, +    interface CheckedConsumer<T> {, +        void accept(T t) throws Exception;, +    }, +, +    static <Response> ActionListener<Response> wrap(CheckedConsumer<Response> onResponse, Consumer<Exception> onFailure) {, +++ b/core/src/main/java/org/elasticsearch/action/ActionModule.java, +import java.util.function.UnaryOperator;, +import org.apache.logging.log4j.Logger;, +import org.elasticsearch.common.logging.ESLoggerFactory;, +import org.elasticsearch.threadpool.ThreadPool;, +    private static final Logger logger = ESLoggerFactory.getLogger(ActionModule.class);, +, +    public ActionModule(boolean transportClient, Settings settings, IndexNameExpressionResolver resolver,, +                        ClusterSettings clusterSettings, ThreadPool threadPool, List<ActionPlugin> actionPlugins) {, +        actionFilters = setupActionFilters(actionPlugins);, +        UnaryOperator<RestHandler> restWrapper = null;, +        for (ActionPlugin plugin : actionPlugins) {, +            UnaryOperator<RestHandler> newRestWrapper = plugin.getRestHandlerWrapper(threadPool.getThreadContext());, +            if (newRestWrapper != null) {, +                logger.debug("Using REST wrapper from plugin " + plugin.getClass().getName());, +                if (restWrapper != null) {, +                    throw new IllegalArgumentException("Cannot have more than one plugin implementing a REST wrapper");, +                }, +                restWrapper = newRestWrapper;, +            }, +        }, +        restController = new RestController(settings, headers, restWrapper);, +    private List<Class<? extends ActionFilter>> setupActionFilters(List<ActionPlugin> actionPlugins) {, +        return unmodifiableList(actionPlugins.stream().flatMap(p -> p.getActionFilters().stream()).collect(Collectors.toList()));, +++ b/core/src/main/java/org/elasticsearch/action/admin/cluster/allocation/NodeExplanation.java, +        nodeDecision.writeTo(out);, +            builder.field("final_explanation", finalExplanation);, +            builder.startArray("decisions");, +            builder.endArray();, +++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java]