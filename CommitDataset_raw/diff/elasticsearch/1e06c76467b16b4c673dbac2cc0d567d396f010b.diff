[+++ b/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java, +            boolean success = false;, +                success = true;, +            } catch (InterruptedException e) {, +                Thread.interrupted();, +                listener.afterBulk(executionId, bulkRequest, e);, +            } finally {, +                 if (!success) {  // if we fail on client.bulk() release the semaphore, +                     semaphore.release();, +                 }, +            }, +]