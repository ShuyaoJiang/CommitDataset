[+++ b/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java, +        final Throwable cause = ExceptionsHelper.unwrapCause(failure);, +        final boolean nodeIsClosing = cause instanceof NodeClosedException, +            || (cause instanceof TransportException && "TransportService is closed stopped can't send request".equals(cause.getMessage()));, +++ b/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java, +        final Throwable cause = ExceptionsHelper.unwrapCause(failure);, +        final boolean nodeIsClosing = cause instanceof NodeClosedException, +            || (cause instanceof TransportException && "TransportService is closed stopped can't send request".equals(cause.getMessage()));, +++ b/server/src/test/java/org/elasticsearch/action/support/replication/ReplicationOperationTests.java, +import org.elasticsearch.transport.SendRequestTransportException;, +            shardActionFailure = new SendRequestTransportException(, +                new DiscoveryNode("foo", buildNewFakeTransportAddress(), Version.CURRENT), "internal:cluster/shard/failure",, +                new TransportException("TransportService is closed stopped can't send request"));, +++ b/server/src/main/java/org/elasticsearch/action/support/replication/ReplicationOperation.java, +        final Throwable cause = ExceptionsHelper.unwrapCause(failure);, +        final boolean nodeIsClosing = cause instanceof NodeClosedException, +            || (cause instanceof TransportException && "TransportService is closed stopped can't send request".equals(cause.getMessage()));, +++ b/server/src/test/java/org/elasticsearch/action/support/replication/ReplicationOperationTests.java, +import org.elasticsearch.transport.SendRequestTransportException;, +            shardActionFailure = new SendRequestTransportException(, +                new DiscoveryNode("foo", buildNewFakeTransportAddress(), Version.CURRENT), "internal:cluster/shard/failure",, +                new TransportException("TransportService is closed stopped can't send request"));, +++ b/server/src/test/java/org/elasticsearch/discovery/ClusterDisruptionIT.java, +import static org.hamcrest.Matchers.everyItem;, +import static org.hamcrest.Matchers.isIn;, +            IndexShard shard = indicesService.getShardOrNull(shardRouting.shardId());, +            Set<String> docs = IndexShardTestCase.getShardDocUIDs(shard);, +            assertThat("shard [" + shard.routingEntry() + "] docIds [" + docs + "] vs " + " acked docIds [" + ackedDocs + "]",, +                ackedDocs, everyItem(isIn(docs)));]