[+++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates());, +                                Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates(), indexRequest.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates());, +                                Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates(), indexRequest.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java, +import java.nio.charset.StandardCharsets;, +    private boolean autoGeneratedId = false;, +        this.autoGeneratedId = indexRequest.autoGeneratedId;, +    /**, +     * Has the id been auto generated?, +     */, +    public boolean autoGeneratedId() {, +        return this.autoGeneratedId;, +    }, +, +                // since we generate the id, change it to CREATE, +                opType(IndexRequest.OpType.CREATE);, +                autoGeneratedId = true;, +        autoGeneratedId = in.readBoolean();, +        out.writeBoolean(autoGeneratedId);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates());, +                                Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates(), indexRequest.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java, +import java.nio.charset.StandardCharsets;, +    private boolean autoGeneratedId = false;, +        this.autoGeneratedId = indexRequest.autoGeneratedId;, +    /**, +     * Has the id been auto generated?, +     */, +    public boolean autoGeneratedId() {, +        return this.autoGeneratedId;, +    }, +, +                // since we generate the id, change it to CREATE, +                opType(IndexRequest.OpType.CREATE);, +                autoGeneratedId = true;, +        autoGeneratedId = in.readBoolean();, +        out.writeBoolean(autoGeneratedId);, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +import org.elasticsearch.index.engine.EngineClosedException;, +            operation = indexShard.prepareIndex(sourceToParse, request.version(), request.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates());, +            operation = indexShard.prepareCreate(sourceToParse, request.version(), request.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates(), request.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates());, +                                Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates(), indexRequest.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java, +import java.nio.charset.StandardCharsets;, +    private boolean autoGeneratedId = false;, +        this.autoGeneratedId = indexRequest.autoGeneratedId;, +    /**, +     * Has the id been auto generated?, +     */, +    public boolean autoGeneratedId() {, +        return this.autoGeneratedId;, +    }, +, +                // since we generate the id, change it to CREATE, +                opType(IndexRequest.OpType.CREATE);, +                autoGeneratedId = true;, +        autoGeneratedId = in.readBoolean();, +        out.writeBoolean(autoGeneratedId);, +++ b/core/src/main/java/org/elasticsearch/action/index/TransportIndexAction.java, +import org.elasticsearch.index.engine.EngineClosedException;, +            operation = indexShard.prepareIndex(sourceToParse, request.version(), request.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates());, +            operation = indexShard.prepareCreate(sourceToParse, request.version(), request.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates(), request.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java, +    private volatile boolean canHaveDuplicates = false;, +    void setCanHaveDuplicates() {, +        this.canHaveDuplicates = true;, +    }, +, +    /**, +     * Is this request can potentially be dup on a single shard., +     */, +    public boolean canHaveDuplicates() {, +        return canHaveDuplicates;, +    }, +, +        canHaveDuplicates = in.readBoolean();, +        // no need to serialize threaded* parameters, since they only matter locally, +        out.writeBoolean(canHaveDuplicates);, +++ b/core/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java, +                        operation = indexShard.prepareIndex(sourceToParse, indexRequest.version(), indexRequest.versionType(), Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates());, +                                Engine.Operation.Origin.REPLICA, request.canHaveDuplicates() || indexRequest.canHaveDuplicates(), indexRequest.autoGeneratedId());, +++ b/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java, +import java.nio.charset.StandardCharsets;, +    private boolean autoGeneratedId = false;, +        this.autoGeneratedId = indexRequest.autoGeneratedId;, +    /**, +     * Has the id been auto generated?, +     */, +    public boolean autoGeneratedId() {, +        return this.autoGeneratedId;, +    }, +, +                // since we generate the id, change it to CREATE, +                opType(IndexRequest.OpType.CREATE);]