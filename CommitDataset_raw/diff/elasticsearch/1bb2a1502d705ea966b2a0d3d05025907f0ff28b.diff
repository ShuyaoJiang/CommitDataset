[+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java, +import org.elasticsearch.action.support.ContextPreservingActionListener;, +                    new IteratingActionListener<>(ContextPreservingActionListener.wrapPreservingContext(ActionListener.wrap(, +                        (e) -> listener.onFailure(request.exceptionProcessingRequest(e, token))), threadContext),, +++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java, +import org.elasticsearch.action.support.ContextPreservingActionListener;, +                    new IteratingActionListener<>(ContextPreservingActionListener.wrapPreservingContext(ActionListener.wrap(, +                        (e) -> listener.onFailure(request.exceptionProcessingRequest(e, token))), threadContext),, +++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/AuthenticationServiceTests.java, +        doThrow(authenticationError("realm doesn't want to lookup")), +        final boolean separateThread = randomBoolean();, +        doAnswer(i -> {, +            Runnable run = () -> {, +            };, +            if (separateThread) {, +                final Thread thread = new Thread(run);, +                thread.start();, +                thread.join();, +            } else {, +                run.run();, +            }]