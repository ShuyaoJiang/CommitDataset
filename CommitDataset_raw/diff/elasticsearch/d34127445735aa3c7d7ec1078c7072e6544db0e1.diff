[+++ b/src/test/java/org/elasticsearch/common/compress/CompressedStreamTests.java, +import org.apache.lucene.util.LineFileDocs;, +import java.nio.charset.StandardCharsets;, +            Random r = getRandom();, +            doTest("lzf", bytes);, +        }, +    }, +    public void testLineDocs() throws IOException {, +        Random r = getRandom();, +        LineFileDocs lineFileDocs = new LineFileDocs(r);, +        for (int i = 0; i < 200; i++) {, +            int numDocs = TestUtil.nextInt(r, 1, 100);, +            ByteArrayOutputStream bos = new ByteArrayOutputStream();, +            for (int j = 0; j < numDocs; j++) {, +                String s = lineFileDocs.nextDoc().get("body");, +                bos.write(s.getBytes(StandardCharsets.UTF_8));, +            }, +            doTest("lzf", bos.toByteArray());, +        }, +        lineFileDocs.close();, +    }, +    , +    private void doTest(String compressor, byte bytes[]) throws IOException {, +        CompressorFactory.configure(ImmutableSettings.settingsBuilder().put("compress.default.type", compressor).build());           , +        int bufferSize = TestUtil.nextInt(getRandom(), 1, 2048);, +        byte buffer[] = new byte[bufferSize];, +        rawIn.close();]