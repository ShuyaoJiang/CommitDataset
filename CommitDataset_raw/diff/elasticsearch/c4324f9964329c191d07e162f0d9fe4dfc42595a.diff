[+++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +import java.util.concurrent.ConcurrentHashMap;, +            indexShardReference = getIndexShardReferenceOnPrimary(shardId, request);, +    protected IndexShardReference getIndexShardReferenceOnPrimary(ShardId shardId, Request request) {, +        IndexShardReference ref = IndexShardReferenceImpl.createOnReplica(indexShard, primaryTerm);, +        return ref;, +                                                    String message = "unknown";, +                                                    try {, +                                                        message = String.format(Locale.ROOT, "primary shard [%s] was demoted while failing replica shard [%s] for [%s]", primaryShard, shard, exp);, +                                                    } catch (Throwable t) {, +                                                        shardFailedError.addSuppressed(t);, +                                                    }, +                                                    // these can occur if the node is shutting down and are okay, +                                                    // any other exception here is not expected and merits investigation, +                                                    assert shardFailedError instanceof TransportException ||, +                                                            shardFailedError instanceof NodeClosedException : shardFailedError;, +, +, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +import java.util.concurrent.ConcurrentHashMap;, +            indexShardReference = getIndexShardReferenceOnPrimary(shardId, request);, +    protected IndexShardReference getIndexShardReferenceOnPrimary(ShardId shardId, Request request) {, +        IndexShardReference ref = IndexShardReferenceImpl.createOnReplica(indexShard, primaryTerm);, +        return ref;, +                                                    String message = "unknown";, +                                                    try {, +                                                        message = String.format(Locale.ROOT, "primary shard [%s] was demoted while failing replica shard [%s] for [%s]", primaryShard, shard, exp);, +                                                    } catch (Throwable t) {, +                                                        shardFailedError.addSuppressed(t);, +                                                    }, +                                                    // these can occur if the node is shutting down and are okay, +                                                    // any other exception here is not expected and merits investigation, +                                                    assert shardFailedError instanceof TransportException ||, +                                                            shardFailedError instanceof NodeClosedException : shardFailedError;, +, +, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +import org.elasticsearch.transport.RemoteTransportException;, +                            listener.onFailure(exp instanceof RemoteTransportException ? exp.getCause() : exp);, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +import java.util.concurrent.ConcurrentHashMap;, +            indexShardReference = getIndexShardReferenceOnPrimary(shardId, request);, +    protected IndexShardReference getIndexShardReferenceOnPrimary(ShardId shardId, Request request) {, +        IndexShardReference ref = IndexShardReferenceImpl.createOnReplica(indexShard, primaryTerm);, +        return ref;, +                                                    String message = "unknown";, +                                                    try {, +                                                        message = String.format(Locale.ROOT, "primary shard [%s] was demoted while failing replica shard [%s] for [%s]", primaryShard, shard, exp);, +                                                    } catch (Throwable t) {, +                                                        shardFailedError.addSuppressed(t);, +                                                    }, +                                                    // these can occur if the node is shutting down and are okay, +                                                    // any other exception here is not expected and merits investigation, +                                                    assert shardFailedError instanceof TransportException ||, +                                                            shardFailedError instanceof NodeClosedException : shardFailedError;, +, +, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +import org.elasticsearch.transport.RemoteTransportException;, +                            listener.onFailure(exp instanceof RemoteTransportException ? exp.getCause() : exp);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/ClusterService.java, +            onGoingTimeout.cancel();, +        postAppliedListeners.stream().filter(listener -> listener instanceof TimeoutClusterStateListener), +                .forEach(listener -> ((TimeoutClusterStateListener) listener).onClose());, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +import java.util.concurrent.ConcurrentHashMap;, +            indexShardReference = getIndexShardReferenceOnPrimary(shardId, request);, +    protected IndexShardReference getIndexShardReferenceOnPrimary(ShardId shardId, Request request) {, +        IndexShardReference ref = IndexShardReferenceImpl.createOnReplica(indexShard, primaryTerm);, +        return ref;, +                                                    String message = "unknown";, +                                                    try {, +                                                        message = String.format(Locale.ROOT, "primary shard [%s] was demoted while failing replica shard [%s] for [%s]", primaryShard, shard, exp);, +                                                    } catch (Throwable t) {, +                                                        shardFailedError.addSuppressed(t);, +                                                    }, +                                                    // these can occur if the node is shutting down and are okay, +                                                    // any other exception here is not expected and merits investigation, +                                                    assert shardFailedError instanceof TransportException ||, +                                                            shardFailedError instanceof NodeClosedException : shardFailedError;, +, +, +++ b/core/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java, +import org.elasticsearch.transport.RemoteTransportException;, +                            listener.onFailure(exp instanceof RemoteTransportException ? exp.getCause() : exp);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/ClusterService.java, +            onGoingTimeout.cancel();, +        postAppliedListeners.stream().filter(listener -> listener instanceof TimeoutClusterStateListener), +                .forEach(listener -> ((TimeoutClusterStateListener) listener).onClose());, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/publish/PublishClusterStateAction.java, +import java.util.Locale;, +        if (lastSeenClusterState != null && lastSeenClusterState.supersedes(incomingState)) {, +            final String message = String.format(, +                    Locale.ROOT,, +                    "received older cluster state version [%s] from current master " +, +                        "with uuid [%s] than last seen cluster state [%s] from current master with uuid [%s]",, +                    incomingState.version(),, +                    incomingState.stateUUID(),, +                    lastSeenClusterState.version(),, +                    lastSeenClusterState.stateUUID()]