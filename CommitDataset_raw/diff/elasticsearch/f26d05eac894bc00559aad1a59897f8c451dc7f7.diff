[+++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +        return preferenceActiveShardIterator(shards(clusterState, index, id, routing), clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +        return preferenceActiveShardIterator(indexShard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +            ShardIterator iterator = preferenceActiveShardIterator(shard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +        return preferenceActiveShardIterator(shards(clusterState, index, id, routing), clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +        return preferenceActiveShardIterator(indexShard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +            ShardIterator iterator = preferenceActiveShardIterator(shard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/ClusterService.java, +        assert clusterState.nodes().getLocalNodeId() == null : "local node is already set";, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +        return preferenceActiveShardIterator(shards(clusterState, index, id, routing), clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +        return preferenceActiveShardIterator(indexShard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +            ShardIterator iterator = preferenceActiveShardIterator(shard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/ClusterService.java, +        assert clusterState.nodes().getLocalNodeId() == null : "local node is already set";, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                transportService.sendRequest(otherMaster, DISCOVERY_REJOIN_ACTION_NAME, new RejoinClusterRequest(localClusterState.nodes().getLocalNodeId()), new EmptyTransportResponseHandler(ThreadPool.Names.SAME) {, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +        return preferenceActiveShardIterator(shards(clusterState, index, id, routing), clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +        return preferenceActiveShardIterator(indexShard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +            ShardIterator iterator = preferenceActiveShardIterator(shard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/ClusterService.java, +        assert clusterState.nodes().getLocalNodeId() == null : "local node is already set";, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                transportService.sendRequest(otherMaster, DISCOVERY_REJOIN_ACTION_NAME, new RejoinClusterRequest(localClusterState.nodes().getLocalNodeId()), new EmptyTransportResponseHandler(ThreadPool.Names.SAME) {, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/fd/MasterFaultDetection.java, +            if (!request.masterNodeId.equals(nodes.getLocalNodeId())) {, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();, +++ b/core/src/main/java/org/elasticsearch/cluster/routing/OperationRouting.java, +        return preferenceActiveShardIterator(shards(clusterState, index, id, routing), clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +        return preferenceActiveShardIterator(indexShard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +            ShardIterator iterator = preferenceActiveShardIterator(shard, clusterState.nodes().getLocalNodeId(), clusterState.nodes(), preference);, +++ b/core/src/main/java/org/elasticsearch/cluster/service/ClusterService.java, +        assert clusterState.nodes().getLocalNodeId() == null : "local node is already set";, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ZenDiscovery.java, +                transportService.sendRequest(otherMaster, DISCOVERY_REJOIN_ACTION_NAME, new RejoinClusterRequest(localClusterState.nodes().getLocalNodeId()), new EmptyTransportResponseHandler(ThreadPool.Names.SAME) {, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/fd/MasterFaultDetection.java, +            if (!request.masterNodeId.equals(nodes.getLocalNodeId())) {, +++ b/core/src/main/java/org/elasticsearch/discovery/zen/ping/unicast/UnicastZenPing.java, +                        if (pingResponse.node().getId().equals(discoveryNodes.getLocalNodeId())) {, +++ b/core/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java, +            if (primary.currentNodeId().equals(state.nodes().getLocalNodeId())) {, +                if (nodes.getLocalNodeId().equals(shard.currentNodeId()) == false) {, +                if (shard.relocating() && nodes.getLocalNodeId().equals(shard.relocatingNodeId()) == false) {, +++ b/core/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodes.java, +        return this.localNodeId;, +                    String localNodeId = getLocalNodeId();, +            this.localNodeId = nodes.getLocalNodeId();]