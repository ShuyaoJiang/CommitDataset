[+++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/tool/UsersTool.java, +import org.elasticsearch.cli.LoggingAwareMultiCommand;, +import org.elasticsearch.cli.ExitCodes;, +import org.elasticsearch.xpack.XPackPlugin;, +    static class AddUserCommand extends XPackConfigurationAwareCommand {, +, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +    static class DeleteUserCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +    static class PasswordCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +    static class RolesCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +    static class ListCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +, +    private abstract static class XPackConfigurationAwareCommand extends EnvironmentAwareCommand {, +, +        XPackConfigurationAwareCommand(final String description) {, +            super(description);, +        }, +, +        @Override, +        protected void execute(Terminal terminal, OptionSet options, Environment env) throws Exception {, +            checkConfigurationDir(env);, +            executeCommand(terminal, options, env);, +        }, +, +        /**, +         * Ensure the X-Pack configuration directory exists as a child of $ES_CONF_DIR or return a helpful error message., +         */, +        private void checkConfigurationDir(Environment env) throws Exception {, +            Path configDir = env.configFile().resolve(XPackPlugin.NAME);, +            if (Files.exists(configDir) == false) {, +                throw new UserException(ExitCodes.CONFIG, String.format(Locale.ROOT,, +                        "Directory %s does not exist. Please ensure " +, +                                "that %s is the configuration directory for Elasticsearch and create directory %s/x-pack manually",, +                        configDir.toString(),, +                        configDir.getParent().toString(),, +                        configDir.toString()));, +            }, +        }, +, +        protected abstract void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception;, +, +    }, +++ b/plugin/src/main/java/org/elasticsearch/xpack/security/authc/file/tool/UsersTool.java, +import org.elasticsearch.cli.LoggingAwareMultiCommand;, +import org.elasticsearch.cli.ExitCodes;, +import org.elasticsearch.xpack.XPackPlugin;, +    static class AddUserCommand extends XPackConfigurationAwareCommand {, +, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +    static class DeleteUserCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +    static class PasswordCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +    static class RolesCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +    static class ListCommand extends XPackConfigurationAwareCommand {, +        protected void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception {, +, +, +    private abstract static class XPackConfigurationAwareCommand extends EnvironmentAwareCommand {, +, +        XPackConfigurationAwareCommand(final String description) {, +            super(description);, +        }, +, +        @Override, +        protected void execute(Terminal terminal, OptionSet options, Environment env) throws Exception {, +            checkConfigurationDir(env);, +            executeCommand(terminal, options, env);, +        }, +, +        /**, +         * Ensure the X-Pack configuration directory exists as a child of $ES_CONF_DIR or return a helpful error message., +         */, +        private void checkConfigurationDir(Environment env) throws Exception {, +            Path configDir = env.configFile().resolve(XPackPlugin.NAME);, +            if (Files.exists(configDir) == false) {, +                throw new UserException(ExitCodes.CONFIG, String.format(Locale.ROOT,, +                        "Directory %s does not exist. Please ensure " +, +                                "that %s is the configuration directory for Elasticsearch and create directory %s/x-pack manually",, +                        configDir.toString(),, +                        configDir.getParent().toString(),, +                        configDir.toString()));, +            }, +        }, +, +        protected abstract void executeCommand(Terminal terminal, OptionSet options, Environment env) throws Exception;, +, +    }]