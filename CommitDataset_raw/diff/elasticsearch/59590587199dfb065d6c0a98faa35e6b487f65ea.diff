[+++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_TYPE, Validator.EMPTY);, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC, Validator.BYTES_SIZE);, +++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_TYPE, Validator.EMPTY);, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC, Validator.BYTES_SIZE);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +        IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC,, +++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_TYPE, Validator.EMPTY);, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC, Validator.BYTES_SIZE);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +        IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC,, +++ b/core/src/main/java/org/elasticsearch/index/IndexModule.java, +import org.elasticsearch.indices.store.IndicesStore;, +    private final IndicesStore indicesStore;, +    private final Map<String, BiFunction<IndexSettings, IndicesStore, IndexStore>> storeTypes = new HashMap<>();, +    public IndexModule(IndexSettings indexSettings, IndicesStore indicesStore) {, +        this.indicesStore = indicesStore;, +    public void addIndexStore(String type, BiFunction<IndexSettings, IndicesStore, IndexStore> provider) {, +            store = new IndexStore(settings, indicesStore);, +            BiFunction<IndexSettings, IndicesStore, IndexStore> factory = storeTypes.get(storeType);, +            store = factory.apply(settings, indicesStore);, +++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_TYPE, Validator.EMPTY);, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC, Validator.BYTES_SIZE);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +        IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC,, +++ b/core/src/main/java/org/elasticsearch/index/IndexModule.java, +import org.elasticsearch.indices.store.IndicesStore;, +    private final IndicesStore indicesStore;, +    private final Map<String, BiFunction<IndexSettings, IndicesStore, IndexStore>> storeTypes = new HashMap<>();, +    public IndexModule(IndexSettings indexSettings, IndicesStore indicesStore) {, +        this.indicesStore = indicesStore;, +    public void addIndexStore(String type, BiFunction<IndexSettings, IndicesStore, IndexStore> provider) {, +            store = new IndexStore(settings, indicesStore);, +            BiFunction<IndexSettings, IndicesStore, IndexStore> factory = storeTypes.get(storeType);, +            store = factory.apply(settings, indicesStore);, +++ b/core/src/main/java/org/elasticsearch/index/store/IndexStore.java, +import org.elasticsearch.indices.store.IndicesStore;, +, +    protected final IndicesStore indicesStore;, +    public IndexStore(IndexSettings indexSettings, IndicesStore indicesStore) {, +        this.indicesStore = indicesStore;, +        return nodeRateLimiting ? indicesStore.rateLimiting() : this.rateLimiting;, +++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_TYPE, Validator.EMPTY);, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC, Validator.BYTES_SIZE);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +        IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC,, +++ b/core/src/main/java/org/elasticsearch/index/IndexModule.java, +import org.elasticsearch.indices.store.IndicesStore;, +    private final IndicesStore indicesStore;, +    private final Map<String, BiFunction<IndexSettings, IndicesStore, IndexStore>> storeTypes = new HashMap<>();, +    public IndexModule(IndexSettings indexSettings, IndicesStore indicesStore) {, +        this.indicesStore = indicesStore;, +    public void addIndexStore(String type, BiFunction<IndexSettings, IndicesStore, IndexStore> provider) {, +            store = new IndexStore(settings, indicesStore);, +            BiFunction<IndexSettings, IndicesStore, IndexStore> factory = storeTypes.get(storeType);, +            store = factory.apply(settings, indicesStore);, +++ b/core/src/main/java/org/elasticsearch/index/store/IndexStore.java, +import org.elasticsearch.indices.store.IndicesStore;, +, +    protected final IndicesStore indicesStore;, +    public IndexStore(IndexSettings indexSettings, IndicesStore indicesStore) {, +        this.indicesStore = indicesStore;, +        return nodeRateLimiting ? indicesStore.rateLimiting() : this.rateLimiting;, +++ /dev/null, +++ b/core/src/main/java/org/apache/lucene/store/StoreRateLimiting.java, +    public static enum Type {, +++ b/core/src/main/java/org/elasticsearch/cluster/ClusterModule.java, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_TYPE, Validator.EMPTY);, +        registerClusterDynamicSetting(IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC, Validator.BYTES_SIZE);, +++ b/core/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java, +        IndicesStore.INDICES_STORE_THROTTLE_MAX_BYTES_PER_SEC,, +++ b/core/src/main/java/org/elasticsearch/index/IndexModule.java, +import org.elasticsearch.indices.store.IndicesStore;, +    private final IndicesStore indicesStore;, +    private final Map<String, BiFunction<IndexSettings, IndicesStore, IndexStore>> storeTypes = new HashMap<>();, +    public IndexModule(IndexSettings indexSettings, IndicesStore indicesStore) {, +        this.indicesStore = indicesStore;, +    public void addIndexStore(String type, BiFunction<IndexSettings, IndicesStore, IndexStore> provider) {, +            store = new IndexStore(settings, indicesStore);, +            BiFunction<IndexSettings, IndicesStore, IndexStore> factory = storeTypes.get(storeType);, +            store = factory.apply(settings, indicesStore);, +++ b/core/src/main/java/org/elasticsearch/index/store/IndexStore.java, +import org.elasticsearch.indices.store.IndicesStore;, +]