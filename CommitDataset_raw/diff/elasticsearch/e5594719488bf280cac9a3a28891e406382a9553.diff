[+++ b/src/test/java/org/elasticsearch/discovery/DiscoveryWithServiceDisruptionsTests.java, +        final CountDownLatch oldMasterNodeSteppedDown = new CountDownLatch(1);, +        internalCluster().getInstance(ClusterService.class, oldMasterNode).add(new ClusterStateListener() {, +            @Override, +            public void clusterChanged(ClusterChangedEvent event) {, +                if (event.state().nodes().masterNodeId() == null) {, +                    oldMasterNodeSteppedDown.countDown();, +                }, +            }, +        });, +, +        oldMasterNodeSteppedDown.await(30, TimeUnit.SECONDS);, +        // The assertDiscoveryCompleted(...) can't know if all nodes have the old master node in all of the local cluster states, +            assertThat("[" + nodeName + "] Second transition's current master should be [" + newMasterNode + "]", recordedMasterTransition.get(1).v2(), equalTo(newMasterNode));]