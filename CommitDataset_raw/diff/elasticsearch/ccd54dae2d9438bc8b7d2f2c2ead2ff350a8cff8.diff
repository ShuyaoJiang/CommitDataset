[+++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * Returns the document mapper created, including if the document mapper ended up, +     * being actually created or not in the second tuple value., +     */, +    public Tuple<DocumentMapper, Boolean> documentMapperWithAutoCreate(String type) {, +            return Tuple.tuple(mapper, Boolean.FALSE);, +                return Tuple.tuple(mapper, Boolean.FALSE);, +            return Tuple.tuple(mappers.get(type), Boolean.TRUE);, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * Returns the document mapper created, including if the document mapper ended up, +     * being actually created or not in the second tuple value., +     */, +    public Tuple<DocumentMapper, Boolean> documentMapperWithAutoCreate(String type) {, +            return Tuple.tuple(mapper, Boolean.FALSE);, +                return Tuple.tuple(mapper, Boolean.FALSE);, +            return Tuple.tuple(mappers.get(type), Boolean.TRUE);, +++ b/src/main/java/org/elasticsearch/index/mapper/ParsedDocument.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * latches the mapping to be marked as modified., +     */, +    public void setMappingsModified() {, +        this.mappingsModified = true;, +    }, +, +    /**, +     * Uses the value of get document or create to automatically set if mapping is, +     * modified or not., +     */, +    public ParsedDocument setMappingsModified(Tuple<DocumentMapper, Boolean> docMapper) {, +        if (docMapper.v2()) {, +            setMappingsModified();, +        }, +        return this;, +    }, +, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * Returns the document mapper created, including if the document mapper ended up, +     * being actually created or not in the second tuple value., +     */, +    public Tuple<DocumentMapper, Boolean> documentMapperWithAutoCreate(String type) {, +            return Tuple.tuple(mapper, Boolean.FALSE);, +                return Tuple.tuple(mapper, Boolean.FALSE);, +            return Tuple.tuple(mappers.get(type), Boolean.TRUE);, +++ b/src/main/java/org/elasticsearch/index/mapper/ParsedDocument.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * latches the mapping to be marked as modified., +     */, +    public void setMappingsModified() {, +        this.mappingsModified = true;, +    }, +, +    /**, +     * Uses the value of get document or create to automatically set if mapping is, +     * modified or not., +     */, +    public ParsedDocument setMappingsModified(Tuple<DocumentMapper, Boolean> docMapper) {, +        if (docMapper.v2()) {, +            setMappingsModified();, +        }, +        return this;, +    }, +, +++ b/src/main/java/org/elasticsearch/index/shard/service/InternalIndexShard.java, +import org.elasticsearch.common.collect.Tuple;, +        Tuple<DocumentMapper, Boolean> docMapper = mapperService.documentMapperWithAutoCreate(source.type());, +        ParsedDocument doc = docMapper.v1().parse(source).setMappingsModified(docMapper);, +        return new Engine.Create(docMapper.v1(), docMapper.v1().uidMapper().term(doc.uid().stringValue()), doc, version, versionType, origin, startTime, state != IndexShardState.STARTED || canHaveDuplicates, autoGeneratedId);, +        Tuple<DocumentMapper, Boolean> docMapper = mapperService.documentMapperWithAutoCreate(source.type());, +        ParsedDocument doc = docMapper.v1().parse(source).setMappingsModified(docMapper);, +        return new Engine.Index(docMapper.v1(), docMapper.v1().uidMapper().term(doc.uid().stringValue()), doc, version, versionType, origin, startTime, state != IndexShardState.STARTED || canHaveDuplicates);, +        DocumentMapper docMapper = mapperService.documentMapperWithAutoCreate(type).v1();, +++ b/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java, +++ b/src/main/java/org/elasticsearch/index/mapper/MapperService.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * Returns the document mapper created, including if the document mapper ended up, +     * being actually created or not in the second tuple value., +     */, +    public Tuple<DocumentMapper, Boolean> documentMapperWithAutoCreate(String type) {, +            return Tuple.tuple(mapper, Boolean.FALSE);, +                return Tuple.tuple(mapper, Boolean.FALSE);, +            return Tuple.tuple(mappers.get(type), Boolean.TRUE);, +++ b/src/main/java/org/elasticsearch/index/mapper/ParsedDocument.java, +import org.elasticsearch.common.collect.Tuple;, +    /**, +     * latches the mapping to be marked as modified., +     */, +    public void setMappingsModified() {]