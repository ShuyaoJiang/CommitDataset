[+++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointAutoConfiguration.java, +		return new HealthEndpoint(this.healthAggregator, this.healthIndicators);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointAutoConfiguration.java, +		return new HealthEndpoint(this.healthAggregator, this.healthIndicators);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointWebMvcAutoConfiguration.java, +import org.springframework.boot.actuate.autoconfigure.ManagementServerProperties.Security;, +		Security security = this.managementServerProperties.getSecurity();, +		boolean secure = (security == null || security.isEnabled());, +		HealthMvcEndpoint healthMvcEndpoint = new HealthMvcEndpoint(delegate, secure);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointAutoConfiguration.java, +		return new HealthEndpoint(this.healthAggregator, this.healthIndicators);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointWebMvcAutoConfiguration.java, +import org.springframework.boot.actuate.autoconfigure.ManagementServerProperties.Security;, +		Security security = this.managementServerProperties.getSecurity();, +		boolean secure = (security == null || security.isEnabled());, +		HealthMvcEndpoint healthMvcEndpoint = new HealthMvcEndpoint(delegate, secure);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/ManagementSecurityAutoConfiguration.java, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointAutoConfiguration.java, +		return new HealthEndpoint(this.healthAggregator, this.healthIndicators);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointWebMvcAutoConfiguration.java, +import org.springframework.boot.actuate.autoconfigure.ManagementServerProperties.Security;, +		Security security = this.managementServerProperties.getSecurity();, +		boolean secure = (security == null || security.isEnabled());, +		HealthMvcEndpoint healthMvcEndpoint = new HealthMvcEndpoint(delegate, secure);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/ManagementSecurityAutoConfiguration.java, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/endpoint/mvc/EndpointHandlerMapping.java, + * MVC on the classpath). Note that any endpoints having method signatures will break in a, + * non-servlet environment., +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointAutoConfiguration.java, +		return new HealthEndpoint(this.healthAggregator, this.healthIndicators);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointWebMvcAutoConfiguration.java, +import org.springframework.boot.actuate.autoconfigure.ManagementServerProperties.Security;, +		Security security = this.managementServerProperties.getSecurity();, +		boolean secure = (security == null || security.isEnabled());, +		HealthMvcEndpoint healthMvcEndpoint = new HealthMvcEndpoint(delegate, secure);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/ManagementSecurityAutoConfiguration.java, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/endpoint/mvc/EndpointHandlerMapping.java, + * MVC on the classpath). Note that any endpoints having method signatures will break in a, + * non-servlet environment., +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/endpoint/mvc/HealthMvcEndpoint.java, +import org.springframework.boot.bind.RelaxedPropertyResolver;, +import org.springframework.context.EnvironmentAware;, +import org.springframework.core.env.Environment;, + * @author Phillip Webb, +public class HealthMvcEndpoint implements MvcEndpoint, EnvironmentAware {, +, +	private final HealthEndpoint delegate;, +, +	private final boolean secure;, +	private RelaxedPropertyResolver propertyResolver;, +		this(delegate, true);, +	}, +, +	public HealthMvcEndpoint(HealthEndpoint delegate, boolean secure) {, +		Assert.notNull(delegate, "Delegate must not be null");, +		this.secure = secure;, +	@Override, +	public void setEnvironment(Environment environment) {, +		this.propertyResolver = new RelaxedPropertyResolver(environment,, +				"endpoints.health.");, +	}, +, +		HttpStatus status = this.statusMapping.get(health.getStatus().getCode());, +		if (status != null) {, +			return new ResponseEntity<Health>(health, status);, +		long accessTime = System.currentTimeMillis();, +		if (isCacheStale(accessTime) || isSecure(principal) || isUnrestricted()) {, +			this.lastAccess = accessTime;, +			this.cached = this.delegate.invoke();, +		if (isSecure(principal) || isUnrestricted()) {, +			return this.cached;, +		}, +		return Health.status(this.cached.getStatus()).build();, +	private boolean isCacheStale(long accessTime) {, +		if (this.cached == null) {, +			return true;, +		}, +		return (accessTime - this.lastAccess) > this.delegate.getTimeToLive();, +	}, +, +	private boolean isUnrestricted() {, +		Boolean sensitive = this.propertyResolver.getProperty("sensitive", Boolean.class);, +		return !this.secure || Boolean.FALSE.equals(sensitive);, +	}, +, +	private boolean isSecure(Principal principal) {, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointAutoConfiguration.java, +		return new HealthEndpoint(this.healthAggregator, this.healthIndicators);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/EndpointWebMvcAutoConfiguration.java, +import org.springframework.boot.actuate.autoconfigure.ManagementServerProperties.Security;, +		Security security = this.managementServerProperties.getSecurity();, +		boolean secure = (security == null || security.isEnabled());, +		HealthMvcEndpoint healthMvcEndpoint = new HealthMvcEndpoint(delegate, secure);, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/autoconfigure/ManagementSecurityAutoConfiguration.java, +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/endpoint/mvc/EndpointHandlerMapping.java, + * MVC on the classpath). Note that any endpoints having method signatures will break in a, + * non-servlet environment., +++ b/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/endpoint/mvc/HealthMvcEndpoint.java, +import org.springframework.boot.bind.RelaxedPropertyResolver;, +import org.springframework.context.EnvironmentAware;]