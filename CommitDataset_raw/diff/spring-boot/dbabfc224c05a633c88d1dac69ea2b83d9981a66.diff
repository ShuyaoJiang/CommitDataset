[+++ b/spring-boot-test-autoconfigure/pom.xml, +			<groupId>io.lettuce</groupId>, +			<artifactId>lettuce-core</artifactId>, +			<scope>test</scope>, +		</dependency>, +		<dependency>, +++ b/spring-boot-test-autoconfigure/pom.xml, +			<groupId>io.lettuce</groupId>, +			<artifactId>lettuce-core</artifactId>, +			<scope>test</scope>, +		</dependency>, +		<dependency>, +++ b/spring-boot-tools/spring-boot-test-support/src/main/java/org/springframework/boot/testsupport/rule/RedisTestServer.java, +import java.time.Duration;, +, +import org.springframework.beans.factory.DisposableBean;, +import org.springframework.data.redis.connection.RedisStandaloneConfiguration;, +import org.springframework.data.redis.connection.lettuce.LettuceClientConfiguration;, +import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;, +import org.springframework.util.ClassUtils;, +	private RedisConnectionFactory connectionFactory;, +	private RedisConnectionFactory createConnectionFactory() {, +		ClassLoader classLoader = RedisTestServer.class.getClassLoader();, +		RedisConnectionFactory cf;, +		if (ClassUtils.isPresent("redis.clients.jedis.Jedis", classLoader)) {, +			cf = new JedisConnectionFactoryConfiguration(), +					.createConnectionFactory();, +		}, +		else {, +			cf = new LettuceConnectionFactoryConfiguration(), +					.createConnectionFactory();, +		testConnection(cf);, +		return cf;, +	}, +, +	private void testConnection(RedisConnectionFactory connectionFactory) {, +		private final RedisConnectionFactory connectionFactory;, +		RedisStatement(Statement base, RedisConnectionFactory connectionFactory) {, +					if (this.connectionFactory instanceof DisposableBean) {, +						((DisposableBean) this.connectionFactory).destroy();, +					}, +	private static class JedisConnectionFactoryConfiguration {, +, +		RedisConnectionFactory createConnectionFactory() {, +			JedisConnectionFactory connectionFactory = new JedisConnectionFactory();, +			connectionFactory.afterPropertiesSet();, +			return connectionFactory;, +		}, +, +	}, +, +	private static class LettuceConnectionFactoryConfiguration {, +, +		RedisConnectionFactory createConnectionFactory() {, +			LettuceClientConfiguration config = LettuceClientConfiguration.builder(), +					.shutdownTimeout(Duration.ofMillis(0)), +					.build();, +			LettuceConnectionFactory connectionFactory = new LettuceConnectionFactory(, +					new RedisStandaloneConfiguration(), config);, +			connectionFactory.afterPropertiesSet();, +			return connectionFactory;, +		}, +, +	}, +]