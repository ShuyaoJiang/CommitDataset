[+++ b/common/src/main/java/io/netty/util/NetworkConstants.java, +import java.io.IOException;, +import java.net.InetSocketAddress;, +import java.net.ServerSocket;, +import java.net.Socket;, +        InetAddress localhost;, +            validateHost(localhost);, +        } catch (IOException e) {, +            // The default local host names did not work.  Try hard-coded IPv4 address., +                validateHost(localhost);, +            } catch (IOException e1) {, +                // The hard-coded IPv4 address did not work.  Try hard coded IPv6 address., +                    localhost = InetAddress.getByAddress(new byte[] { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 });, +                    validateHost(localhost);, +                } catch (IOException e2) {, +                    throw new Error("Failed to resolve localhost - incorrect network configuration?", e2);, +    private static void validateHost(InetAddress host) throws IOException {, +        ServerSocket ss = null;, +        Socket s1 = null;, +        Socket s2 = null;, +        try {, +            ss = new ServerSocket();, +            ss.setReuseAddress(false);, +            ss.bind(new InetSocketAddress(host, 0));, +            s1 = new Socket(host, ss.getLocalPort());, +            s2 = ss.accept();, +        } finally {, +            if (s2 != null) {, +                try {, +                    s2.close();, +                } catch (IOException e) {, +                    // Ignore, +                }, +            }, +            if (s1 != null) {, +                try {, +                    s1.close();, +                } catch (IOException e) {, +                    // Ignore, +                }, +            }, +            if (ss != null) {, +                try {, +                    ss.close();, +                } catch (IOException e) {, +                    // Ignore, +                }, +            }, +        }, +    }, +, +++ b/common/src/main/java/io/netty/util/NetworkConstants.java, +import java.io.IOException;, +import java.net.InetSocketAddress;, +import java.net.ServerSocket;, +import java.net.Socket;, +        InetAddress localhost;, +            validateHost(localhost);, +        } catch (IOException e) {, +            // The default local host names did not work.  Try hard-coded IPv4 address., +                validateHost(localhost);, +            } catch (IOException e1) {, +                // The hard-coded IPv4 address did not work.  Try hard coded IPv6 address., +                    localhost = InetAddress.getByAddress(new byte[] { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 });, +                    validateHost(localhost);, +                } catch (IOException e2) {, +                    throw new Error("Failed to resolve localhost - incorrect network configuration?", e2);, +    private static void validateHost(InetAddress host) throws IOException {, +        ServerSocket ss = null;, +        Socket s1 = null;, +        Socket s2 = null;, +        try {, +            ss = new ServerSocket();, +            ss.setReuseAddress(false);, +            ss.bind(new InetSocketAddress(host, 0));, +            s1 = new Socket(host, ss.getLocalPort());, +            s2 = ss.accept();, +        } finally {, +            if (s2 != null) {, +                try {, +                    s2.close();, +                } catch (IOException e) {, +                    // Ignore, +                }, +            }, +            if (s1 != null) {, +                try {, +                    s1.close();, +                } catch (IOException e) {, +                    // Ignore, +                }, +            }, +            if (ss != null) {, +                try {, +                    ss.close();, +                } catch (IOException e) {, +                    // Ignore, +                }, +            }, +        }]