[+++ b/transport/src/main/java/io/netty/channel/AbstractChannel.java, +                // Only needed if no VoidChannelPromise., +                if (!(promise instanceof VoidChannelPromise)) {, +                }, +                        try {, +                            // Execute the close., +                        } finally {, +                                    // Fail all the queued messages, +                                    buffer.failFlushed(CLOSED_CHANNEL_EXCEPTION);, +                                    buffer.close(CLOSED_CHANNEL_EXCEPTION);, +                                    fireChannelInactiveAndDeregister(wasActive);, +                    }, +                try {, +                    // Close the channel and fail the queued messages in all cases., +                } finally {, +                    // Fail all the queued messages., +                    buffer.failFlushed(CLOSED_CHANNEL_EXCEPTION);, +                    buffer.close(CLOSED_CHANNEL_EXCEPTION);, +                }, +                if (inFlush0) {, +                    invokeLater(new OneTimeTask() {, +                        @Override, +                        public void run() {, +                            fireChannelInactiveAndDeregister(wasActive);, +                        }, +                    });, +                } else {, +                    fireChannelInactiveAndDeregister(wasActive);, +                }, +        private void fireChannelInactiveAndDeregister(final boolean wasActive) {]