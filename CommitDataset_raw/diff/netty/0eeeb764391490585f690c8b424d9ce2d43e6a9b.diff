[+++ b/codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectEncoder.java, +, +                        if (msg instanceof LastHttpContent) {, +                            state = ST_INIT;, +                        }, +, +                        break;, +                    }, +                    // fall-through!, +                case ST_CONTENT_ALWAYS_EMPTY:, +, +                        // We allocated a buffer so add it now., +, +                    break;, +                case ST_CONTENT_CHUNK:, +                    if (buf != null) {, +                        // We allocated a buffer so add it now., +                        out.add(buf);, +                    }, +                    encodeChunkedContent(ctx, msg, contentLength(msg), out);, +, +                    break;, +                default:, +                    throw new Error();, +        } else if (buf != null) {, +        } else if (contentLength == 0) {, +++ b/codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectEncoder.java, +, +                        if (msg instanceof LastHttpContent) {, +                            state = ST_INIT;, +                        }, +, +                        break;, +                    }, +                    // fall-through!, +                case ST_CONTENT_ALWAYS_EMPTY:, +, +                        // We allocated a buffer so add it now., +, +                    break;, +                case ST_CONTENT_CHUNK:, +                    if (buf != null) {, +                        // We allocated a buffer so add it now., +                        out.add(buf);, +                    }, +                    encodeChunkedContent(ctx, msg, contentLength(msg), out);, +, +                    break;, +                default:, +                    throw new Error();, +        } else if (buf != null) {, +        } else if (contentLength == 0) {, +++ b/codec-http/src/test/java/io/netty/handler/codec/http/HttpServerCodecTest.java, +    @Test, +    public void testChunkedHeadFullHttpResponse() {, +        EmbeddedChannel ch = new EmbeddedChannel(new HttpServerCodec());, +, +        // Send the request headers., +        assertTrue(ch.writeInbound(Unpooled.copiedBuffer(, +                "HEAD / HTTP/1.1\r\n\r\n", CharsetUtil.UTF_8)));, +, +        HttpRequest request = ch.readInbound();, +        assertEquals(HttpMethod.HEAD, request.method());, +        LastHttpContent content = ch.readInbound();, +        assertFalse(content.content().isReadable());, +        content.release();, +, +        FullHttpResponse response = new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);, +        HttpUtil.setTransferEncodingChunked(response, true);, +        assertTrue(ch.writeOutbound(response));, +        assertTrue(ch.finish());, +, +        ByteBuf buf = ch.readOutbound();, +        assertEquals("HTTP/1.1 200 OK\r\ntransfer-encoding: chunked\r\n\r\n", buf.toString(CharsetUtil.US_ASCII));, +        buf.release();, +, +        assertFalse(ch.finishAndReleaseAll());, +    }, +]