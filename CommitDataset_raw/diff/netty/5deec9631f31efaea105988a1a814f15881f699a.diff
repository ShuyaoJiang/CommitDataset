[+++ b/handler/src/main/java/io/netty/handler/ssl/OpenSslEngine.java, +                // Nothing to do as the handshake is not done yet., +                break;, +            case FINISHED:, +                if (clientMode) {, +                    // Only supported for server mode at the moment., +                }, +                // For renegotiate on the server side we need to issue the following command sequence with openssl:, +                //, +                // SSL_renegotiate(ssl), +                // SSL_do_handshake(ssl), +                // ssl->state = SSL_ST_ACCEPT, +                // SSL_do_handshake(ssl), +                //, +                // Bcause of this we fall-through to call handshake() after setting the state, as this will also take, +                // care of updating the internal OpenSslSession object., +                //, +                // See also:, +                // https://github.com/apache/httpd/blob/2.4.16/modules/ssl/ssl_engine_kernel.c#L812, +                // http://h71000.www7.hp.com/doc/83final/ba554_90007/ch04s03.html, +                if (SSL.renegotiate(ssl) != 1 || SSL.doHandshake(ssl) != 1) {, +                    shutdownWithError("renegotiation failed");, +                }, +, +                SSL.setState(ssl, SSL.SSL_ST_ACCEPT);, +                // fall-through, +            case NOT_STARTED:, +                handshakeState = HandshakeState.STARTED_EXPLICITLY;, +                handshake();, +                break;, +        if (handshakeState == HandshakeState.FINISHED) {, +            return FINISHED;, +        }, +++ b/handler/src/main/java/io/netty/handler/ssl/OpenSslEngine.java, +                // Nothing to do as the handshake is not done yet., +                break;, +            case FINISHED:, +                if (clientMode) {, +                    // Only supported for server mode at the moment., +                }, +                // For renegotiate on the server side we need to issue the following command sequence with openssl:, +                //, +                // SSL_renegotiate(ssl), +                // SSL_do_handshake(ssl), +                // ssl->state = SSL_ST_ACCEPT, +                // SSL_do_handshake(ssl), +                //, +                // Bcause of this we fall-through to call handshake() after setting the state, as this will also take, +                // care of updating the internal OpenSslSession object., +                //, +                // See also:, +                // https://github.com/apache/httpd/blob/2.4.16/modules/ssl/ssl_engine_kernel.c#L812, +                // http://h71000.www7.hp.com/doc/83final/ba554_90007/ch04s03.html, +                if (SSL.renegotiate(ssl) != 1 || SSL.doHandshake(ssl) != 1) {, +                    shutdownWithError("renegotiation failed");, +                }, +, +                SSL.setState(ssl, SSL.SSL_ST_ACCEPT);, +                // fall-through, +            case NOT_STARTED:, +                handshakeState = HandshakeState.STARTED_EXPLICITLY;, +                handshake();, +                break;, +        if (handshakeState == HandshakeState.FINISHED) {, +            return FINISHED;, +        }, +++ b/handler/src/test/java/io/netty/handler/ssl/JdkSslRenegotiateTest.java, +/*, + * Copyright 2015 The Netty Project, + *, + * The Netty Project licenses this file to you under the Apache License,, + * version 2.0 (the "License"); you may not use this file except in compliance, + * with the License. You may obtain a copy of the License at:, + *, + *   http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT, + * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the, + * License for the specific language governing permissions and limitations, + * under the License., + */, +package io.netty.handler.ssl;, +, +public class JdkSslRenegotiateTest extends RenegotiateTest {, +, +    @Override, +    protected SslProvider serverSslProvider() {, +        return SslProvider.JDK;, +    }, +}, +++ b/handler/src/main/java/io/netty/handler/ssl/OpenSslEngine.java, +                // Nothing to do as the handshake is not done yet., +                break;, +            case FINISHED:, +                if (clientMode) {, +                    // Only supported for server mode at the moment., +                }, +                // For renegotiate on the server side we need to issue the following command sequence with openssl:, +                //]