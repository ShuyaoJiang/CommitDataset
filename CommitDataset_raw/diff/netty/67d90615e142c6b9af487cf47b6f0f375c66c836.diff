[+++ b/src/main/java/org/jboss/netty/util/LinkedTransferQueue.java, +        private static final AtomicReferenceFieldUpdater<QNode, QNode> nextUpdater;, +        static {, +            AtomicReferenceFieldUpdater<QNode, QNode> tmp = null;, +            try {, +                tmp = AtomicReferenceFieldUpdater.newUpdater(, +                        QNode.class, QNode.class, "next");, +, +                // Test if AtomicReferenceFieldUpdater is really working., +                QNode testNode = new QNode(null, false);, +                tmp.set(testNode, testNode);, +                if (testNode.next != testNode) {, +                    // Not set as expected - fall back to the safe mode., +                    throw new Exception();, +                }, +            } catch (Throwable t) {, +                // Running in a restricted environment with a security manager., +                tmp = null;, +            }, +            nextUpdater = tmp;, +        }, +            if (nextUpdater == null) {, +                // Safe mode., +                synchronized (this) {, +                    if (next == cmp) {, +                        next = val;, +                        return true;, +                    } else {, +                        return false;, +                    }, +                }, +            } else {, +    }]