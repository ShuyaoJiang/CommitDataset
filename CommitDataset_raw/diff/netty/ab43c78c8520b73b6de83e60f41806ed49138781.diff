[+++ b/transport/src/main/java/io/netty/channel/embedded/EmbeddedChannel.java, +, +    private Queue<Object> inboundMessages;, +    private Queue<Object> outboundMessages;, +        if (inboundMessages == null) {, +            inboundMessages = new ArrayDeque<Object>();, +        }, +        if (outboundMessages == null) {, +            outboundMessages = new ArrayDeque<Object>();, +        }, +        return (T) poll(inboundMessages);, +        return (T) poll(outboundMessages);, +            return isNotEmpty(inboundMessages);, +        return isNotEmpty(inboundMessages);, +            return isNotEmpty(outboundMessages);, +            return isNotEmpty(outboundMessages);, +        return isNotEmpty(inboundMessages) || isNotEmpty(outboundMessages);, +    }, +, +    private static boolean isNotEmpty(Queue<Object> queue) {, +        return queue != null && !queue.isEmpty();, +    }, +, +    private static Object poll(Queue<Object> queue) {, +        return queue != null ? queue.poll() : null;, +            outboundMessages().add(msg);, +            inboundMessages().add(msg);]