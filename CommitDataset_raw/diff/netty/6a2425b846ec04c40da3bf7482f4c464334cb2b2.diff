[+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2FrameWriter.java, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +                    headerBlock.readSlice(min(headerBlock.readableBytes(), maxFragmentLength));, +            ctx.write(fragment.retain(), promiseAggregator.newPromise());, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +                    headerBlock.readSlice(min(headerBlock.readableBytes(), maxFragmentLength));, +            ctx.write(fragment.retain(), promiseAggregator.newPromise());, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2FrameWriter.java, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +                    headerBlock.readSlice(min(headerBlock.readableBytes(), maxFragmentLength));, +            ctx.write(fragment.retain(), promiseAggregator.newPromise());, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +                    headerBlock.readSlice(min(headerBlock.readableBytes(), maxFragmentLength));, +            ctx.write(fragment.retain(), promiseAggregator.newPromise());, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2CodecUtil.java, +    static final class SimpleChannelPromiseAggregator extends DefaultChannelPromise {, +        private int doneCount;, +        private Throwable lastFailure;, +            assert promise != null && !promise.isDone();, +            assert !doneAllocating : "Done allocating. No more promises can be allocated.";, +                if (doneCount == expectedCount || expectedCount == 0) {, +                    return setPromise();, +                ++doneCount;, +                lastFailure = cause;, +                if (allPromisesDone()) {, +                    return tryPromise();, +                ++doneCount;, +                lastFailure = cause;, +                if (allPromisesDone()) {, +                    return setPromise();, +                ++doneCount;, +                if (allPromisesDone()) {, +                    setPromise();, +                ++doneCount;, +                if (allPromisesDone()) {, +                    return tryPromise();, +, +        private boolean allowFailure() {, +            return awaitingPromises() || expectedCount == 0;, +        }, +, +        private boolean awaitingPromises() {, +            return doneCount < expectedCount;, +        }, +, +        private boolean allPromisesDone() {, +            return doneCount == expectedCount && doneAllocating;, +        }, +, +        private ChannelPromise setPromise() {, +            if (lastFailure == null) {, +                promise.setSuccess();, +                return super.setSuccess(null);, +            } else {, +                promise.setFailure(lastFailure);, +                return super.setFailure(lastFailure);, +            }, +        }, +, +        private boolean tryPromise() {, +            if (lastFailure == null) {, +                promise.trySuccess();, +                return super.trySuccess(null);, +            } else {, +                promise.tryFailure(lastFailure);, +                return super.tryFailure(lastFailure);, +            }, +        }, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2FrameWriter.java, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +                    headerBlock.readSlice(min(headerBlock.readableBytes(), maxFragmentLength));, +            ctx.write(fragment.retain(), promiseAggregator.newPromise());, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);, +        return promiseAggregator.doneAllocatingPromises();, +            promiseAggregator.setFailure(t);]