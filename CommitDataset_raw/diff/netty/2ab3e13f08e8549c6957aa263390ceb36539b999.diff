[+++ b/codec-http/src/main/java/io/netty/handler/codec/http/HttpUtil.java, +import java.net.InetSocketAddress;, +import java.net.URI;, +import java.nio.charset.Charset;, +import java.nio.charset.UnsupportedCharsetException;, +import java.util.ArrayList;, +import java.util.Iterator;, +import java.util.List;, +, +     *, +        if (HttpHeaderValues.CLOSE.contentEqualsIgnoreCase(connection)) {, +     *, +     *, +, +        if (indexOfCharset == AsciiString.INDEX_NOT_FOUND) {, +            return null;, +        }, +, +            CharSequence charsetCandidate = contentTypeValue.subSequence(indexOfEncoding, contentTypeValue.length());, +            int indexOfSemicolon = AsciiString.indexOfIgnoreCaseAscii(charsetCandidate, SEMICOLON, 0);, +            if (indexOfSemicolon == AsciiString.INDEX_NOT_FOUND) {, +                return charsetCandidate;, +, +            return charsetCandidate.subSequence(0, indexOfSemicolon);, +, +     *, +            return '[' + hostString + ']';, +++ b/codec-http/src/main/java/io/netty/handler/codec/http/HttpUtil.java, +import java.net.InetSocketAddress;, +import java.net.URI;, +import java.nio.charset.Charset;, +import java.nio.charset.UnsupportedCharsetException;, +import java.util.ArrayList;, +import java.util.Iterator;, +import java.util.List;, +, +     *, +        if (HttpHeaderValues.CLOSE.contentEqualsIgnoreCase(connection)) {, +     *, +     *, +, +        if (indexOfCharset == AsciiString.INDEX_NOT_FOUND) {, +            return null;, +        }, +, +            CharSequence charsetCandidate = contentTypeValue.subSequence(indexOfEncoding, contentTypeValue.length());, +            int indexOfSemicolon = AsciiString.indexOfIgnoreCaseAscii(charsetCandidate, SEMICOLON, 0);, +            if (indexOfSemicolon == AsciiString.INDEX_NOT_FOUND) {, +                return charsetCandidate;, +, +            return charsetCandidate.subSequence(0, indexOfSemicolon);, +, +     *, +            return '[' + hostString + ']';, +++ b/codec-http/src/test/java/io/netty/handler/codec/http/HttpUtilTest.java, +import io.netty.util.CharsetUtil;, +import io.netty.util.ReferenceCountUtil;, +import org.junit.Test;, +, +    public void testGetCharsetIfNotLastParameter() {, +        String NORMAL_CONTENT_TYPE_WITH_PARAMETERS = "application/soap-xml; charset=utf-8; ", +            + "action=\"http://www.soap-service.by/foo/add\"";, +, +        HttpMessage message = new DefaultHttpRequest(HttpVersion.HTTP_1_1, HttpMethod.POST,, +            "http://localhost:7788/foo");, +        message.headers().set(HttpHeaderNames.CONTENT_TYPE, NORMAL_CONTENT_TYPE_WITH_PARAMETERS);, +, +        assertEquals(CharsetUtil.UTF_8, HttpUtil.getCharset(message));, +        assertEquals(CharsetUtil.UTF_8, HttpUtil.getCharset(NORMAL_CONTENT_TYPE_WITH_PARAMETERS));, +, +        assertEquals("utf-8", HttpUtil.getCharsetAsSequence(message));, +        assertEquals("utf-8", HttpUtil.getCharsetAsSequence(NORMAL_CONTENT_TYPE_WITH_PARAMETERS));, +    }, +, +    @Test, +, +    @Test, +    public void testKeepAliveIfConnectionHeaderAbsent() {, +        HttpMessage http11Message = new DefaultHttpRequest(HttpVersion.HTTP_1_1, HttpMethod.GET,, +            "http:localhost/http_1_1");, +        assertTrue(HttpUtil.isKeepAlive(http11Message));, +, +        HttpMessage http10Message = new DefaultHttpRequest(HttpVersion.HTTP_1_0, HttpMethod.GET,, +            "http:localhost/http_1_0");, +        assertFalse(HttpUtil.isKeepAlive(http10Message));, +    }]