[+++ b/handler/src/main/java/io/netty/handler/ssl/OpenSslEngine.java, +                        throw shutdownWithError("SSL_write");, +    private SSLException shutdownWithError(String operations) {, +        return shutdownWithError(operations, err);, +    private SSLException shutdownWithError(String operation, String err) {, +            return new SSLException(err);, +        return new SSLHandshakeException(err);, +                        return sslReadErrorResult(SSL.getLastErrorNumber(), bytesConsumed, bytesProduced);, +                    return sslReadErrorResult(err, bytesConsumed, bytesProduced);, +    private SSLEngineResult sslReadErrorResult(int err, int bytesConsumed, int bytesProduced) throws SSLException {, +        // Check if we have a pending handshakeException and if so see if we need to consume all pending data from the, +        // BIO first or can just shutdown and throw it now., +        // This is needed so we ensure close_notify etc is correctly send to the remote peer., +        // See https://github.com/netty/netty/issues/3900, +        if (SSL.pendingWrittenBytesInBIO(networkBIO) > 0) {, +            if (handshakeException == null && handshakeState != HandshakeState.FINISHED) {, +                // we seems to have data left that needs to be transfered and so the user needs, +                // call wrap(...). Store the error so we can pick it up later., +                handshakeException = new SSLHandshakeException(SSL.getLastError());, +            }, +            return new SSLEngineResult(OK, NEED_WRAP, bytesConsumed, bytesProduced);, +        }, +        throw shutdownWithError("SSL_read", SSL.getErrorString(err));, +    }, +, +                    throw shutdownWithError("renegotiation failed");, +, +        // Check if we have a pending handshakeException and if so see if we need to consume all pending data from the, +        // BIO first or can just shutdown and throw it now., +        // This is needed so we ensure close_notify etc is correctly send to the remote peer., +        // See https://github.com/netty/netty/issues/3900, +        SSLHandshakeException exception = handshakeException;, +        if (exception != null) {, +            if (SSL.pendingWrittenBytesInBIO(networkBIO) > 0) {, +                // There is something pending, we need to consume it first via a WRAP so we not loose anything., +                return NEED_WRAP;, +            }, +            // No more data left to send to the remote peer, so null out the exception field, shutdown and throw, +            // the exception., +            handshakeException = null;, +            shutdown();, +            throw exception;, +        }, +, +            // Check if we have a pending exception that was created during the handshake and if so throw it after, +            // shutdown the connection., +            if (handshakeException != null) {, +                exception = handshakeException;, +                handshakeException = null;, +                shutdown();, +                throw exception;, +            }, +                throw shutdownWithError("SSL_do_handshake");]