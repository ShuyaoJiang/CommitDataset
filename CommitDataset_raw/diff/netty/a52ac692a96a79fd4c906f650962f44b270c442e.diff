[+++ b/transport/src/main/java/io/netty/channel/socket/nio/NioSocketChannel.java, +import io.netty.util.ReferenceCounted;, +    protected int doWrite(MessageList<Object> msgs, final int index) throws Exception {, +        final int size = msgs.size();, +        final Object[] bufs = msgs.array();, +            ByteBuf buf = (ByteBuf) bufs[i];, +, +                bufs[i] = directBuf;, +        final SocketChannel ch = javaChannel();, +            final long localWrittenBytes = ch.write(nioBuffers, 0, nioBufferCnt);, +                ((ReferenceCounted) bufs[i]).release();, +                final ByteBuf buf = (ByteBuf) bufs[i];, +                final int readerIndex = buf.readerIndex();, +                final int readableBytes = buf.writerIndex() - readerIndex;, +, +                if (readableBytes < writtenBytes) {, +                    writtenBytes -= readableBytes;, +                } else if (readableBytes > writtenBytes) {, +                    buf.readerIndex(readerIndex + (int) writtenBytes);]