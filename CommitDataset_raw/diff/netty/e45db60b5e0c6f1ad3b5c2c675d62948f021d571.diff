[+++ b/codec/src/main/java/io/netty/handler/codec/compression/Snappy.java, +    private static final int NOT_ENOUGH_INPUT = -1;, +    private int written;, +        written = 0;, +                int literalWritten = decodeLiteral(tag, in, out);, +                if (literalWritten != NOT_ENOUGH_INPUT) {, +                    written += literalWritten;, +                int decodeWritten;, +                    decodeWritten = decodeCopyWith1ByteOffset(tag, in, out, written);, +                    if (decodeWritten != NOT_ENOUGH_INPUT) {, +                        written += decodeWritten;, +                    decodeWritten = decodeCopyWith2ByteOffset(tag, in, out, written);, +                    if (decodeWritten != NOT_ENOUGH_INPUT) {, +                        written += decodeWritten;, +                    decodeWritten = decodeCopyWith4ByteOffset(tag, in, out, written);, +                    if (decodeWritten != NOT_ENOUGH_INPUT) {, +                        written += decodeWritten;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeLiteral(byte tag, ByteBuf in, ByteBuf out) {, +                return NOT_ENOUGH_INPUT;, +                return NOT_ENOUGH_INPUT;, +                return NOT_ENOUGH_INPUT;, +                return NOT_ENOUGH_INPUT;, +            return NOT_ENOUGH_INPUT;, +        return length;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeCopyWith1ByteOffset(byte tag, ByteBuf in, ByteBuf out, int writtenSoFar) {, +            return NOT_ENOUGH_INPUT;, +        int initialIndex = out.writerIndex();, +        int offset = (tag & 0x0e0) << 8 >> 5 | in.readUnsignedByte();, +        validateOffset(offset, writtenSoFar);, +        return length;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeCopyWith2ByteOffset(byte tag, ByteBuf in, ByteBuf out, int writtenSoFar) {, +            return NOT_ENOUGH_INPUT;, +        int initialIndex = out.writerIndex();, +        validateOffset(offset, writtenSoFar);, +        return length;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeCopyWith4ByteOffset(byte tag, ByteBuf in, ByteBuf out, int writtenSoFar) {, +            return NOT_ENOUGH_INPUT;, +        int initialIndex = out.writerIndex();, +        validateOffset(offset, writtenSoFar);, +        return length;, +++ b/codec/src/main/java/io/netty/handler/codec/compression/Snappy.java, +    private static final int NOT_ENOUGH_INPUT = -1;, +    private int written;, +        written = 0;, +                int literalWritten = decodeLiteral(tag, in, out);, +                if (literalWritten != NOT_ENOUGH_INPUT) {, +                    written += literalWritten;, +                int decodeWritten;, +                    decodeWritten = decodeCopyWith1ByteOffset(tag, in, out, written);, +                    if (decodeWritten != NOT_ENOUGH_INPUT) {, +                        written += decodeWritten;, +                    decodeWritten = decodeCopyWith2ByteOffset(tag, in, out, written);, +                    if (decodeWritten != NOT_ENOUGH_INPUT) {, +                        written += decodeWritten;, +                    decodeWritten = decodeCopyWith4ByteOffset(tag, in, out, written);, +                    if (decodeWritten != NOT_ENOUGH_INPUT) {, +                        written += decodeWritten;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeLiteral(byte tag, ByteBuf in, ByteBuf out) {, +                return NOT_ENOUGH_INPUT;, +                return NOT_ENOUGH_INPUT;, +                return NOT_ENOUGH_INPUT;, +                return NOT_ENOUGH_INPUT;, +            return NOT_ENOUGH_INPUT;, +        return length;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeCopyWith1ByteOffset(byte tag, ByteBuf in, ByteBuf out, int writtenSoFar) {, +            return NOT_ENOUGH_INPUT;, +        int initialIndex = out.writerIndex();, +        int offset = (tag & 0x0e0) << 8 >> 5 | in.readUnsignedByte();, +        validateOffset(offset, writtenSoFar);, +        return length;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeCopyWith2ByteOffset(byte tag, ByteBuf in, ByteBuf out, int writtenSoFar) {, +            return NOT_ENOUGH_INPUT;, +        int initialIndex = out.writerIndex();, +        validateOffset(offset, writtenSoFar);, +        return length;, +     * @return The number of bytes appended to the output buffer, or -1 to indicate, +     *     "try again later", +    private static int decodeCopyWith4ByteOffset(byte tag, ByteBuf in, ByteBuf out, int writtenSoFar) {, +            return NOT_ENOUGH_INPUT;, +        int initialIndex = out.writerIndex();, +        validateOffset(offset, writtenSoFar);, +        return length;, +++ b/codec/src/test/java/io/netty/handler/codec/compression/SnappyIntegrationTest.java, +    // Tests that copies do not attempt to overrun into a previous frame chunk, +    // Tests that when generating the hash lookup table for finding copies, we, +    // do not exceed the length of the input when there are no copies]