[+++ b/codec/src/main/java/io/netty/handler/codec/ByteToMessageDecoder.java, +        } else {, +            buf.release();, +++ b/codec/src/main/java/io/netty/handler/codec/ByteToMessageDecoder.java, +        } else {, +            buf.release();, +++ b/codec/src/test/java/io/netty/handler/codec/ByteToMessageDecoderTest.java, +import io.netty.util.ReferenceCountUtil;, +, +    /**, +     * Verifies that internal buffer of the ByteToMessageDecoder is released once decoder is removed from pipeline. In, +     * this case input is read fully., +     */, +    @Test, +    public void testInternalBufferClearReadAll() {, +        final ByteBuf buf = ReferenceCountUtil.releaseLater(Unpooled.buffer().writeBytes(new byte[]{'a'}));, +        EmbeddedChannel channel = new EmbeddedChannel(new ByteToMessageDecoder() {, +            @Override, +            protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {, +                ByteBuf byteBuf = internalBuffer();, +                Assert.assertEquals(1, byteBuf.refCnt());, +                in.readByte();, +                // Removal from pipeline should clear internal buffer, +                ctx.pipeline().remove(this);, +                Assert.assertEquals(0, byteBuf.refCnt());, +            }, +        });, +        Assert.assertFalse(channel.writeInbound(buf));, +        Assert.assertFalse(channel.finish());, +    }, +, +    /**, +     * Verifies that internal buffer of the ByteToMessageDecoder is released once decoder is removed from pipeline. In, +     * this case input was not fully read., +     */, +    @Test, +    public void testInternalBufferClearReadPartly() {, +        final ByteBuf buf = ReferenceCountUtil.releaseLater(Unpooled.buffer().writeBytes(new byte[]{'a', 'b'}));, +        EmbeddedChannel channel = new EmbeddedChannel(new ByteToMessageDecoder() {, +            @Override, +            protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {, +                ByteBuf byteBuf = internalBuffer();, +                Assert.assertEquals(1, byteBuf.refCnt());, +                in.readByte();, +                // Removal from pipeline should clear internal buffer, +                ctx.pipeline().remove(this);, +                Assert.assertEquals(0, byteBuf.refCnt());, +            }, +        });, +        Assert.assertTrue(channel.writeInbound(buf));, +        Assert.assertTrue(channel.finish());, +        Assert.assertEquals(channel.readInbound(), Unpooled.wrappedBuffer(new byte[] {'b'}));, +        Assert.assertNull(channel.readInbound());, +    }]