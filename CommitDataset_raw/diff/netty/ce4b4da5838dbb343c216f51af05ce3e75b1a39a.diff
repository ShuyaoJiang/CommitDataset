[+++ b/testsuite/src/main/java/io/netty/testsuite/transport/socket/SocketStringEchoTest.java, +import io.netty.util.concurrent.ImmediateEventExecutor;, +import io.netty.util.concurrent.Promise;, +        Promise<Void> serverDonePromise = ImmediateEventExecutor.INSTANCE.newPromise();, +        Promise<Void> clientDonePromise = ImmediateEventExecutor.INSTANCE.newPromise();, +        final StringEchoHandler sh = new StringEchoHandler(autoRead, serverDonePromise);, +        final StringEchoHandler ch = new StringEchoHandler(autoRead, clientDonePromise);, +        ch.donePromise.sync();, +        sh.donePromise.sync();, +        private final Promise<Void> donePromise;, +        private int dataIndex;, +        StringEchoHandler(boolean autoRead, Promise<Void> donePromise) {, +            this.donePromise = donePromise;, +            if (!data[dataIndex].equals(msg)) {, +                donePromise.tryFailure(new IllegalStateException("index: " + dataIndex + " didn't match!"));, +                ctx.close();, +                return;, +            }, +            if (++dataIndex >= data.length) {, +                donePromise.setSuccess(null);, +            }, +                donePromise.tryFailure(new IllegalStateException("exceptionCaught: " + ctx.channel(), cause));, +, +        @Override, +        public void channelInactive(ChannelHandlerContext ctx) throws Exception {, +            donePromise.tryFailure(new IllegalStateException("channelInactive: " + ctx.channel()));, +        }]