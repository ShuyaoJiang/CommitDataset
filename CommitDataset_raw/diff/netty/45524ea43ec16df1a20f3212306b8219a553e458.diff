[+++ b/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketServerHandshaker.java, +        ChannelPipeline p = channel.pipeline();, +        final String encoderName;, +                return promise;, +            p.addBefore(ctx.name(), "wsencoder", newWebSocketEncoder());, +            encoderName = ctx.name();, +            encoderName = p.context(HttpResponseEncoder.class).name();, +            p.addAfter(encoderName, "wsencoder", newWebSocketEncoder());, +        channel.writeAndFlush(response).addListener(new ChannelFutureListener() {, +            @Override, +            public void operationComplete(ChannelFuture future) throws Exception {, +                if (future.isSuccess()) {, +                    ChannelPipeline p = future.channel().pipeline();, +                    p.remove(encoderName);]