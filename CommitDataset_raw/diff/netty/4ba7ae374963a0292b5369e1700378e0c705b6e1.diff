[+++ b/src/main/java/org/jboss/netty/bootstrap/Bootstrap.java, +import java.util.ArrayList;, +import java.util.Iterator;, +import java.util.List;, +        if (!isOrderedMap(pipelineMap)) {, +, +    /**, +     * Returns {@code true} if and only if the specified {@code map} is an, +     * ordered map, like {@link LinkedHashMap} is., +     */, +    @SuppressWarnings("unchecked"), +    static boolean isOrderedMap(Map<?, ?> map) {, +        Class<?> mapType = map.getClass();, +        if (LinkedHashMap.class.isAssignableFrom(mapType)) {, +            // LinkedHashMap is an ordered map., +            return true;, +        }, +, +        // Not a LinkedHashMap - start autodetection., +, +        // Detect Apache Commons Collections OrderedMap implementations., +        Class<?> type = mapType;, +        while (type != null) {, +            for (Class<?> i: type.getInterfaces()) {, +                if (i.getName().endsWith("OrderedMap")) {, +                    // Seems like it's an ordered map - guessed from that, +                    // it implements OrderedMap interface., +                    return true;, +                }, +            }, +            type = type.getSuperclass();, +        }, +, +        // Does not implement OrderedMap interface.  As a last resort, try to, +        // create a new instance and test if the insertion order is maintained., +        Map newMap;, +        try {, +            newMap = (Map) mapType.newInstance();, +        } catch (Exception e) {, +            // No default constructor - cannot proceed anymore., +            return false;, +        }, +, +        // Run some tests., +        List<String> expectedKeys = new ArrayList<String>();, +        String dummyValue = "dummyValue";, +        for (short element: ORDER_TEST_SAMPLES) {, +            String key = String.valueOf(element);, +            newMap.put(key, dummyValue);, +            expectedKeys.add(key);, +, +            Iterator<String> it = expectedKeys.iterator();, +            for (Object actualKey: newMap.keySet()) {, +                if (!it.next().equals(actualKey)) {, +                    // Did not pass the test., +                    return false;, +                }, +            }, +        }, +, +        // The specified map passed the insertion order test., +        return true;, +    }, +, +    private static final short[] ORDER_TEST_SAMPLES = {, +        682, 807, 637, 358, 570, 828, 407, 319,, +        105,  41, 563, 544, 518, 298, 418,  50,, +        156, 769, 984, 503, 191, 578, 309, 710,, +        327, 720, 591, 939, 374, 707,  43, 463,, +        227, 174,  30, 531, 135, 930, 190, 823,, +        925, 835, 328, 239, 415, 500, 144, 460,, +         83, 774, 921,   4,  95, 468, 687, 493,, +        991, 436, 245, 742, 149, 821, 142, 782,, +        297, 918, 917, 424, 978, 992,  79, 906,, +        535, 515, 850,  80, 125, 378, 307, 883,, +        836, 160,  27, 630, 668, 226, 560, 698,, +        467, 829, 476, 163, 977, 367, 325, 184,, +        204, 312, 486,  53, 179, 592, 252, 750,, +        893, 517, 937, 124, 148, 719, 973, 566,, +        405, 449, 452, 777, 349, 761, 167, 783,, +        220, 802, 117, 604, 216, 363, 120, 621,, +        219, 182, 817, 244, 438, 465, 934, 888,, +        628, 209, 631,  17, 870, 679, 826, 945,, +        680, 848, 974, 573, 626, 865, 109, 317,, +         91, 494, 965, 473, 725, 388, 302, 936,, +        660, 150, 122, 949, 295, 392,  63, 634,, +        772, 143, 990, 895, 538,  59, 541,  32,, +        669, 321, 811, 756,  82, 955, 953, 636,, +        390, 162, 688, 444,  70, 590, 183, 745,, +        543, 666, 951, 642, 747, 765,  98, 469,, +        884, 929, 178, 721, 994, 840, 353, 726,, +        940, 759, 624, 919, 667, 629, 272, 979,, +        326, 608, 453,  11, 322, 347, 647, 354,, +        381, 746, 472, 890, 249, 536, 733, 404,, +        170, 959,  34, 899, 195, 651, 140, 856,, +        201, 237,  51, 933, 268, 849, 294, 115,, +        157,  14, 854, 373, 186, 872,  71, 523,, +        931, 952, 655, 561, 607, 862, 554, 661,, +        313, 909, 511, 752, 986, 311, 287, 775,, +        505, 878, 422, 103, 299, 119, 107, 344,]