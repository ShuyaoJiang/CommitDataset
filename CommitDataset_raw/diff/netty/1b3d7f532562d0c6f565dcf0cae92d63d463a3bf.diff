[+++ b/codec/src/test/java/io/netty/handler/codec/ReplayingDecoderTest.java, +++ b/codec/src/test/java/io/netty/handler/codec/ReplayingDecoderTest.java, +++ b/transport/src/main/java/io/netty/channel/DefaultChannelPipeline.java, +    private void replace0(DefaultChannelHandlerContext oldCtx, String newName,, +        DefaultChannelHandlerContext prev = oldCtx.prev;, +        DefaultChannelHandlerContext next = oldCtx.next;, +, +        // Finish the replacement of oldCtx with newCtx in the linked list., +        // Note that this doesn't mean events will be sent to the new handler immediately, +        // because we are currently at the event handler thread and no more than one handler methods can be invoked, +        // at the same time (we ensured that in replace().), +        if (!oldCtx.name().equals(newName)) {, +            name2ctx.remove(oldCtx.name());, +        // Invoke newHandler.handlerAdded() first (i.e. before oldHandler.handlerRemoved() is invoked), +        // because callHandlerRemoved() will trigger inboundBufferUpdated() or flush() on newHandler and those, +        // event handlers must be called after handlerAdded()., +        callHandlerRemoved(oldCtx, newCtx, newCtx);]