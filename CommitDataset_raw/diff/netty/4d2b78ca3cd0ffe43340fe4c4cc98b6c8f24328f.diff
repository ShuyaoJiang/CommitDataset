[+++ b/codec/src/main/java/io/netty/handler/codec/compression/JdkZlibEncoder.java, +            if (wrapper == ZlibWrapper.GZIP) {, +    protected final ByteBuf allocateBuffer(ChannelHandlerContext ctx, ByteBuf msg,, +                                           boolean preferDirect) throws Exception {, +        int sizeEstimate = (int) Math.ceil(msg.readableBytes() * 1.001) + 12;, +        if (writeHeader) {, +            switch (wrapper) {, +                case GZIP:, +                    sizeEstimate += gzipHeader.length;, +                    break;, +                case ZLIB:, +                    sizeEstimate += 2; // first two magic bytes, +                    break;, +            }, +        }, +        return ctx.alloc().heapBuffer(sizeEstimate);, +    }, +, +    @Override, +        ByteBuf footer = ctx.alloc().heapBuffer();, +, +            if (!footer.isWritable()) {, +                // no more space so write it to the channel and continue, +                ctx.write(footer);, +                footer = ctx.alloc().heapBuffer();, +            }, +            int writerIndex = out.writerIndex();, +            numBytes = deflater.deflate(, +                    out.array(), out.arrayOffset() + writerIndex, out.writableBytes(), Deflater.SYNC_FLUSH);, +            out.writerIndex(writerIndex + numBytes);]