[+++ b/handler/src/main/java/io/netty/handler/stream/ChunkedWriteHandler.java, +        // call flush if the channel is writable or not connected. flush(..) will take care of the rest, +, +        if (channel.isWritable() || !channel.isConnected()) {, +, +            currentEvent = null;, +        if (cause != null) {, +                Channels.fireExceptionCaught(ctx.getChannel(), cause);, +                Channels.fireExceptionCaughtLater(ctx.getChannel(), cause);, +                    return;, +                        return;, +        if (acquired && (!channel.isConnected() || (channel.isWritable() && !queue.isEmpty()))) {, +, +++ b/handler/src/main/java/io/netty/handler/stream/ChunkedWriteHandler.java, +        // call flush if the channel is writable or not connected. flush(..) will take care of the rest, +, +        if (channel.isWritable() || !channel.isConnected()) {, +, +            currentEvent = null;, +        if (cause != null) {, +                Channels.fireExceptionCaught(ctx.getChannel(), cause);, +                Channels.fireExceptionCaughtLater(ctx.getChannel(), cause);, +                    return;, +                        return;, +        if (acquired && (!channel.isConnected() || (channel.isWritable() && !queue.isEmpty()))) {, +, +++ b/handler/src/test/java/io/netty/handler/stream/ChunkedWriteHandlerTest.java, +/*, + * Copyright 2011 The Netty Project, + *, + * The Netty Project licenses this file to you under the Apache License,, + * version 2.0 (the "License"); you may not use this file except in compliance, + * with the License. You may obtain a copy of the License at:, + *, + * http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT, + * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the, + * License for the specific language governing permissions and limitations, + * under the License., + */package io.netty.handler.stream;, +, +import java.io.ByteArrayInputStream;, +import java.io.File;, +import java.io.FileOutputStream;, +import java.io.IOException;, +import java.nio.channels.Channels;, +, +import junit.framework.Assert;, +, +import io.netty.buffer.ChannelBuffer;, +import io.netty.handler.codec.embedder.EncoderEmbedder;, +import io.netty.handler.stream.ChunkedFile;, +import io.netty.handler.stream.ChunkedInput;, +import io.netty.handler.stream.ChunkedNioFile;, +import io.netty.handler.stream.ChunkedNioStream;, +import io.netty.handler.stream.ChunkedStream;, +import io.netty.handler.stream.ChunkedWriteHandler;, +import org.junit.Test;, +, +public class ChunkedWriteHandlerTest {, +    private static final byte[] BYTES = new byte[1024 * 64];, +    private static final File TMP;, +    , +    static {, +        for (int i = 0; i < BYTES.length; i++) {, +            BYTES[i] = (byte) i;, +        }, +        , +        FileOutputStream out = null;, +        try {, +            TMP = File.createTempFile("netty-chunk-", ".tmp");, +            TMP.deleteOnExit();, +            out = new FileOutputStream(TMP);, +            out.write(BYTES);, +            out.flush();, +        } catch (IOException e) {, +            throw new RuntimeException(e);, +        } finally {, +            if (out != null) {, +                try {, +                    out.close();, +                } catch (IOException e) {, +                    // ignore, +                }, +            }, +        }, +    }, +, +    // See #310, +    @Test, +    public void testChunkedStream() {, +        check(new ChunkedStream(new ByteArrayInputStream(BYTES)));, +        , +        check(new ChunkedStream(new ByteArrayInputStream(BYTES)), new ChunkedStream(new ByteArrayInputStream(BYTES)), new ChunkedStream(new ByteArrayInputStream(BYTES)));, +, +    }, +    , +    @Test]