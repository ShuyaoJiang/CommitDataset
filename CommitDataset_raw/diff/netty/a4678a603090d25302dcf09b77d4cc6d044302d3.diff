[+++ b/transport/src/main/java/io/netty/channel/AbstractChannel.java, +++ b/transport/src/main/java/io/netty/channel/AbstractChannel.java, +++ b/transport/src/main/java/io/netty/channel/socket/nio/SelectorEventLoop.java, +import java.util.ArrayList;, +import java.util.Collection;, +                processSelectedKeys();, +                    closeAll();, +    private void processSelectedKeys() throws IOException {, +        for (Iterator<SelectionKey> i = selector.selectedKeys().iterator(); i.hasNext();) {, +    private void closeAll() {, +        Set<SelectionKey> keys = selector.keys();, +        Collection<Channel> channels = new ArrayList<Channel>(keys.size());, +        for (SelectionKey k: keys) {, +            channels.add((Channel) k.attachment());, +        }, +, +        for (Channel ch: channels) {, +            ch.unsafe().close(ch.unsafe().voidFuture());, +        }, +    }, +]