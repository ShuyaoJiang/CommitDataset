[+++ b/transport/src/main/java/io/netty/channel/socket/nio/AbstractNioByteChannel.java, +, +/*, + * Copyright 2012 The Netty Project, + *, + * The Netty Project licenses this file to you under the Apache License,, + * version 2.0 (the "License"); you may not use this file except in compliance, + * with the License. You may obtain a copy of the License at:, + *, + *   http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT, + * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the, + * License for the specific language governing permissions and limitations, + * under the License., + */, +        public void channelUnregistered(SelectableChannel ch, Throwable cause) throws Exception {, +            if (cause != null) {, +                future.setFailure(cause);, +                return;, +            }, +, +++ b/transport/src/main/java/io/netty/channel/socket/nio/AbstractNioByteChannel.java, +, +/*, + * Copyright 2012 The Netty Project, + *, + * The Netty Project licenses this file to you under the Apache License,, + * version 2.0 (the "License"); you may not use this file except in compliance, + * with the License. You may obtain a copy of the License at:, + *, + *   http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT, + * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the, + * License for the specific language governing permissions and limitations, + * under the License., + */, +        public void channelUnregistered(SelectableChannel ch, Throwable cause) throws Exception {, +            if (cause != null) {, +                future.setFailure(cause);, +                return;, +            }, +, +++ b/transport/src/main/java/io/netty/channel/socket/nio/NioEventLoop.java, +, +/*, + * Copyright 2012 The Netty Project, + *, + * The Netty Project licenses this file to you under the Apache License,, + * version 2.0 (the "License"); you may not use this file except in compliance, + * with the License. You may obtain a copy of the License at:, + *, + *   http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT, + * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the, + * License for the specific language governing permissions and limitations, + * under the License., + */, +                invokeChannelUnregistered(task, ch.selectionKey(), null);, +        int state = 0;, +            state = 1;, +            invokeChannelUnregistered(task, k, e);, +            state = 2;, +        } finally {, +            switch (state) {, +            case 0:, +                k.cancel();, +                invokeChannelUnregistered(task, k, null);, +                break;, +            case 1:, +                if (!k.isValid()) { // Cancelled by channelReady(), +                    invokeChannelUnregistered(task, k, null);, +                break;, +                invokeChannelUnregistered(task, k, null);, +    private static void invokeChannelUnregistered(NioTask<SelectableChannel> task, SelectionKey k, Throwable cause) {, +            task.channelUnregistered(k.channel(), cause);, +++ b/transport/src/main/java/io/netty/channel/socket/nio/AbstractNioByteChannel.java, +, +/*, + * Copyright 2012 The Netty Project, + *, + * The Netty Project licenses this file to you under the Apache License,, + * version 2.0 (the "License"); you may not use this file except in compliance, + * with the License. You may obtain a copy of the License at:, + *, + *   http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT, + * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the, + * License for the specific language governing permissions and limitations, + * under the License., + */, +        public void channelUnregistered(SelectableChannel ch, Throwable cause) throws Exception {, +            if (cause != null) {]