[+++ b/handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java, +                    if (bytesProduced > 0 && handshakeException != null) {, +                        return newResult(NEED_WRAP, 0, bytesProduced);, +                        } else if (sslError == SSL.SSL_ERROR_WANT_X509_LOOKUP) {, +                                } else if (sslError == SSL.SSL_ERROR_WANT_X509_LOOKUP) {, +                try {, +    private SSLEngineResult.HandshakeStatus handshake() throws SSLException {, +        if (handshakeState == HandshakeState.FINISHED) {, +            return FINISHED;, +        }, +        checkEngineClosed(HANDSHAKE_ENGINE_CLOSED);, +, +        // Check if we have a pending handshakeException and if so see if we need to consume all pending data from the, +        // BIO first or can just shutdown and throw it now., +        // This is needed so we ensure close_notify etc is correctly send to the remote peer., +        // See https://github.com/netty/netty/issues/3900, +        SSLHandshakeException exception = handshakeException;, +        if (exception != null) {, +            // No more data left to send to the remote peer, so null out the exception field, shutdown and throw, +            // the exception., +            // Check if we have a pending exception that was created during the handshake and if so throw it after, +            // shutdown the connection., +            if (handshakeException != null) {, +                exception = handshakeException;, +                handshakeException = null;, +                shutdown();, +                throw exception;, +            }, +, +            if (sslError == SSL.SSL_ERROR_WANT_X509_LOOKUP) {, +++ b/handler/src/main/java/io/netty/handler/ssl/ReferenceCountedOpenSslEngine.java, +                    if (bytesProduced > 0 && handshakeException != null) {, +                        return newResult(NEED_WRAP, 0, bytesProduced);, +                        } else if (sslError == SSL.SSL_ERROR_WANT_X509_LOOKUP) {, +                                } else if (sslError == SSL.SSL_ERROR_WANT_X509_LOOKUP) {, +                try {, +    private SSLEngineResult.HandshakeStatus handshake() throws SSLException {, +        if (handshakeState == HandshakeState.FINISHED) {, +            return FINISHED;, +        }, +        checkEngineClosed(HANDSHAKE_ENGINE_CLOSED);, +, +        // Check if we have a pending handshakeException and if so see if we need to consume all pending data from the, +        // BIO first or can just shutdown and throw it now., +        // This is needed so we ensure close_notify etc is correctly send to the remote peer., +        // See https://github.com/netty/netty/issues/3900, +        SSLHandshakeException exception = handshakeException;, +        if (exception != null) {, +            // No more data left to send to the remote peer, so null out the exception field, shutdown and throw, +            // the exception., +            // Check if we have a pending exception that was created during the handshake and if so throw it after, +            // shutdown the connection., +            if (handshakeException != null) {, +                exception = handshakeException;, +                handshakeException = null;, +                shutdown();, +                throw exception;, +            }, +, +            if (sslError == SSL.SSL_ERROR_WANT_X509_LOOKUP) {, +++ b/handler/src/main/java/io/netty/handler/ssl/SslHandler.java]