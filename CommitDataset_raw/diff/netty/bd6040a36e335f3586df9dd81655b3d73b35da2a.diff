[+++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java, +                        // When deactivate is called the stream state has already been set to CLOSE however, +                        // it is possible that since this job has been queued other circumstances have caused, +                        // it to be removed from the priority tree and thus have a null parent (i.e. reprioritization)., +                        // If the parent is null this means it has already been removed from active streams and we, +                        // should not process the removal any further as this will lead to a NPE., +                        if (stream.parent() == null) {, +                            return;, +                        }, +            }, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java, +                        // When deactivate is called the stream state has already been set to CLOSE however, +                        // it is possible that since this job has been queued other circumstances have caused, +                        // it to be removed from the priority tree and thus have a null parent (i.e. reprioritization)., +                        // If the parent is null this means it has already been removed from active streams and we, +                        // should not process the removal any further as this will lead to a NPE., +                        if (stream.parent() == null) {, +                            return;, +                        }, +            }, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java, +     * Updates an priority for this stream. Calling this method may affect the structure of the, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2Connection.java, +                        // When deactivate is called the stream state has already been set to CLOSE however, +                        // it is possible that since this job has been queued other circumstances have caused, +                        // it to be removed from the priority tree and thus have a null parent (i.e. reprioritization)., +                        // If the parent is null this means it has already been removed from active streams and we, +                        // should not process the removal any further as this will lead to a NPE., +                        if (stream.parent() == null) {, +                            return;, +                        }, +            }, +++ b/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2Stream.java, +     * Updates an priority for this stream. Calling this method may affect the structure of the, +++ b/codec-http2/src/test/java/io/netty/handler/codec/http2/DefaultHttp2ConnectionTest.java, +    public void closeWhileIteratingDoesNotNPE() throws Http2Exception {, +        final Http2Stream streamA = client.local().createStream(3, false);, +        final Http2Stream streamB = client.local().createStream(5, false);, +        final Http2Stream streamC = client.local().createStream(7, false);, +        streamB.setPriority(streamA.id(), Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT, false);, +        client.forEachActiveStream(new Http2StreamVisitor() {, +            @Override, +            public boolean visit(Http2Stream stream) throws Http2Exception {, +                streamA.close();, +                streamB.setPriority(streamC.id(), Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT, false);, +                return true;, +            }, +        });, +    }, +, +    @Test]