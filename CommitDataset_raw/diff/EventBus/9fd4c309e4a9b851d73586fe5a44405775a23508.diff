[+++ b/EventBus/src/de/greenrobot/event/BackgroundPoster.java, +/*, + * Copyright (C) 2012 Markus Junginger, greenrobot (http://greenrobot.de), + *, + * Licensed under the Apache License, Version 2.0 (the "License");, + * you may not use this file except in compliance with the License., + * You may obtain a copy of the License at, + *, + *      http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS,, + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied., + * See the License for the specific language governing permissions and, + * limitations under the License., + */, +package de.greenrobot.event;, +, +import java.util.concurrent.BlockingQueue;, +import java.util.concurrent.ExecutorService;, +import java.util.concurrent.Executors;, +import java.util.concurrent.LinkedBlockingQueue;, +import java.util.concurrent.TimeUnit;, +, +import android.util.Log;, +, +/**, + * Posts events in background., + *  , + * @author Markus, + */, +class BackgroundPoster implements Runnable {, +, +    private static ExecutorService executorService = Executors.newCachedThreadPool();, +, +    private final BlockingQueue<PendingPost> queue;, +    private volatile boolean executorRunning;, +, +    private final EventBus eventBus;, +, +    BackgroundPoster(EventBus eventBus) {, +        this.eventBus = eventBus;, +        queue = new LinkedBlockingQueue<PendingPost>();, +    }, +, +    public void enqueue(Subscription subscription, Object event)  {, +        PendingPost pendingPost = PendingPost.obtainPendingPost(event, subscription);, +        synchronized (this) {, +            queue.add(pendingPost);, +            if (!executorRunning) {, +                executorRunning = true;, +                executorService.execute(this);, +            }, +        }, +    }, +    , +    @Override, +    public void run() {, +        try {, +            try {, +                while (true) {, +                    PendingPost pendingPost = queue.poll(1, TimeUnit.SECONDS);, +                    if (pendingPost == null) {, +                        synchronized (this) {, +                            // Check again, this time in synchronized, +                            pendingPost = queue.poll();, +                            if (pendingPost == null) {, +                                executorRunning = false;, +                                return;, +                            }, +                        }, +                    }, +                    if (pendingPost != null) {, +                        EventBus.postToSubscribtion(pendingPost.subscription, pendingPost.event);, +                    }, +                }, +            } catch (InterruptedException e) {, +                Log.w("Event", Thread.currentThread().getName() + " was interruppted", e);, +            }, +        } finally {, +            executorRunning = false;, +        }, +    }, +, +, +}, +++ b/EventBus/src/de/greenrobot/event/BackgroundPoster.java, +/*, + * Copyright (C) 2012 Markus Junginger, greenrobot (http://greenrobot.de), + *, + * Licensed under the Apache License, Version 2.0 (the "License");, + * you may not use this file except in compliance with the License., + * You may obtain a copy of the License at, + *, + *      http://www.apache.org/licenses/LICENSE-2.0, + *, + * Unless required by applicable law or agreed to in writing, software, + * distributed under the License is distributed on an "AS IS" BASIS,, + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied., + * See the License for the specific language governing permissions and]