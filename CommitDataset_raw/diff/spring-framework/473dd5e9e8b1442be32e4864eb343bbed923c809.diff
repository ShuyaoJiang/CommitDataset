[+++ b/spring-test/src/test/java/org/springframework/test/web/servlet/samples/standalone/FileUploadControllerTests.java, + * Copyright 2002-2015 the original author or authors., +import java.nio.charset.Charset;, +import java.util.Collections;, +import java.util.Map;, +import javax.servlet.Filter;, +import javax.servlet.FilterChain;, +import javax.servlet.ServletException;, +import javax.servlet.http.HttpServletRequest;, +import javax.servlet.http.HttpServletRequestWrapper;, +import javax.servlet.http.HttpServletResponse;, +import org.springframework.test.web.servlet.MockMvc;, +import org.springframework.web.bind.annotation.RequestPart;, +import org.springframework.web.filter.OncePerRequestFilter;, +import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.fileUpload;, +import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.model;, +import static org.springframework.test.web.servlet.setup.MockMvcBuilders.standaloneSetup;, +	private static final Charset CHARSET = Charset.forName("UTF-8");, +, +, +	public void multipartRequest() throws Exception {, +, +		byte[] fileContent = "bar".getBytes(CHARSET);, +		MockMultipartFile filePart = new MockMultipartFile("file", "orig", null, fileContent);, +, +		byte[] json = "{\"name\":\"yeeeah\"}".getBytes(CHARSET);, +		MockMultipartFile jsonPart = new MockMultipartFile("json", "json", "application/json", json);, +, +		MockMvc mockMvc = standaloneSetup(new MultipartController()).build();, +		mockMvc.perform(fileUpload("/test").file(filePart).file(jsonPart)), +				.andExpect(model().attribute("fileContent", fileContent)), +				.andExpect(model().attribute("jsonContent", Collections.singletonMap("name", "yeeeah")));, +	}, +, +	// SPR-13317, +, +	@Test, +	public void multipartRequestWrapped() throws Exception {, +, +		byte[] json = "{\"name\":\"yeeeah\"}".getBytes(CHARSET);, +		MockMultipartFile jsonPart = new MockMultipartFile("json", "json", "application/json", json);, +, +		Filter filter = new RequestWrappingFilter();, +		MockMvc mockMvc = standaloneSetup(new MultipartController()).addFilter(filter).build();, +, +		Map<String, String> jsonMap = Collections.singletonMap("name", "yeeeah");, +		mockMvc.perform(fileUpload("/testJson").file(jsonPart)).andExpect(model().attribute("json", jsonMap));, +	@SuppressWarnings("unused"), +	private static class MultipartController {, +		@RequestMapping(value = "/test", method = RequestMethod.POST), +		public String processMultipart(@RequestParam MultipartFile file,, +				@RequestPart Map<String, String> json, Model model) throws IOException {, +, +			model.addAttribute("jsonContent", json);, +			model.addAttribute("fileContent", file.getBytes());, +, +		@RequestMapping(value = "/testJson", method = RequestMethod.POST), +		public String processMultipart(@RequestPart Map<String, String> json, Model model) {, +			model.addAttribute("json", json);, +			return "redirect:/index";, +		}, +	}, +, +	private static class RequestWrappingFilter extends OncePerRequestFilter {, +, +		@Override, +		protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,, +				FilterChain filterChain) throws IOException, ServletException {, +, +			request = new HttpServletRequestWrapper(request);, +			filterChain.doFilter(request, response);, +		}, +++ b/spring-test/src/test/java/org/springframework/test/web/servlet/samples/standalone/FileUploadControllerTests.java, + * Copyright 2002-2015 the original author or authors., +import java.nio.charset.Charset;, +import java.util.Collections;, +import java.util.Map;, +import javax.servlet.Filter;, +import javax.servlet.FilterChain;, +import javax.servlet.ServletException;, +import javax.servlet.http.HttpServletRequest;, +import javax.servlet.http.HttpServletRequestWrapper;, +import javax.servlet.http.HttpServletResponse;, +import org.springframework.test.web.servlet.MockMvc;, +import org.springframework.web.bind.annotation.RequestPart;, +import org.springframework.web.filter.OncePerRequestFilter;, +import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.fileUpload;, +import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.model;, +import static org.springframework.test.web.servlet.setup.MockMvcBuilders.standaloneSetup;, +	private static final Charset CHARSET = Charset.forName("UTF-8");, +, +, +	public void multipartRequest() throws Exception {, +, +		byte[] fileContent = "bar".getBytes(CHARSET);, +		MockMultipartFile filePart = new MockMultipartFile("file", "orig", null, fileContent);, +, +		byte[] json = "{\"name\":\"yeeeah\"}".getBytes(CHARSET);, +		MockMultipartFile jsonPart = new MockMultipartFile("json", "json", "application/json", json);, +]