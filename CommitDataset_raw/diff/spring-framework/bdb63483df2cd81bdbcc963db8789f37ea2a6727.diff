[+++ b/spring-webmvc/src/main/java/org/springframework/web/servlet/mvc/method/annotation/ResponseBodyEmitter.java, +import java.util.LinkedHashSet;, +import java.util.Set;, + * @author Juergen Hoeller, +	private final Set<DataWithMediaType> earlySendAttempts = new LinkedHashSet<DataWithMediaType>(8);, +	private Handler handler;, +	private boolean complete;, +	synchronized void initialize(Handler handler) throws IOException {, +, +		for (DataWithMediaType sendAttempt : this.earlySendAttempts) {, +			sendInternal(sendAttempt.getData(), sendAttempt.getMediaType());, +		this.earlySendAttempts.clear();, +, +, +	public synchronized void send(Object object, MediaType mediaType) throws IOException {, +		if (object != null) {, +			if (this.handler != null) {, +			else {, +				this.earlySendAttempts.add(new DataWithMediaType(object, mediaType));, +			}, +		}, +	}, +	public synchronized void complete() {, +	public synchronized void completeWithError(Throwable ex) {, +	public synchronized void onTimeout(Runnable callback) {, +	public synchronized void onCompletion(Runnable callback) {, +, +	/**, +	 * Simple struct for a data entry., +	 */, +	static class DataWithMediaType {, +, +		private final Object data;, +, +		private final MediaType mediaType;, +, +		public DataWithMediaType(Object data, MediaType mediaType) {, +			this.data = data;, +			this.mediaType = mediaType;, +		}, +, +		public Object getData() {, +			return this.data;, +		}, +, +		public MediaType getMediaType() {, +			return this.mediaType;, +		}, +	}, +, +++ b/spring-webmvc/src/main/java/org/springframework/web/servlet/mvc/method/annotation/ResponseBodyEmitter.java, +import java.util.LinkedHashSet;, +import java.util.Set;, + * @author Juergen Hoeller, +	private final Set<DataWithMediaType> earlySendAttempts = new LinkedHashSet<DataWithMediaType>(8);, +	private Handler handler;, +	private boolean complete;, +	synchronized void initialize(Handler handler) throws IOException {, +, +		for (DataWithMediaType sendAttempt : this.earlySendAttempts) {, +			sendInternal(sendAttempt.getData(), sendAttempt.getMediaType());, +		this.earlySendAttempts.clear();, +, +, +	public synchronized void send(Object object, MediaType mediaType) throws IOException {, +		if (object != null) {, +			if (this.handler != null) {, +			else {, +				this.earlySendAttempts.add(new DataWithMediaType(object, mediaType));, +			}, +		}, +	}, +	public synchronized void complete() {, +	public synchronized void completeWithError(Throwable ex) {, +	public synchronized void onTimeout(Runnable callback) {, +	public synchronized void onCompletion(Runnable callback) {, +, +	/**, +	 * Simple struct for a data entry., +	 */, +	static class DataWithMediaType {, +, +		private final Object data;, +, +		private final MediaType mediaType;, +, +		public DataWithMediaType(Object data, MediaType mediaType) {, +			this.data = data;, +			this.mediaType = mediaType;, +		}, +, +		public Object getData() {, +			return this.data;, +		}, +, +		public MediaType getMediaType() {, +			return this.mediaType;, +		}, +	}, +]