[+++ b/spring-core/src/main/java/org/springframework/core/codec/CharSequenceEncoder.java, +import java.util.concurrent.ConcurrentHashMap;, +import java.util.concurrent.ConcurrentMap;, +	private final ConcurrentMap<Charset, Float> charsetToMaxBytesPerChar =, +			new ConcurrentHashMap<>(3);, +, +			int capacity = calculateCapacity(charSequence, charset);, +			DataBuffer dataBuffer = bufferFactory.allocateBuffer(capacity);, +	private int calculateCapacity(CharSequence sequence, Charset charset) {, +		float maxBytesPerChar = this.charsetToMaxBytesPerChar, +				.computeIfAbsent(charset, cs -> cs.newEncoder().maxBytesPerChar());, +		float maxBytesForSequence = sequence.length() * maxBytesPerChar;, +		return (int) Math.ceil(maxBytesForSequence);, +	}, +]