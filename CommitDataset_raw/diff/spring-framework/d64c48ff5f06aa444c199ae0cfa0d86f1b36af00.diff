[+++ b/spring-web/src/main/java/org/springframework/web/util/UriComponentsBuilder.java, +		builder.port(null);, +++ b/spring-web/src/main/java/org/springframework/web/util/UriComponentsBuilder.java, +		builder.port(null);, +++ b/spring-web/src/test/java/org/springframework/web/util/UriComponentsBuilderTests.java, +	// SPR-12771, +, +	@Test, +	public void fromHttpRequestResetsPortBeforeSettingIt() throws Exception {, +		MockHttpServletRequest request = new MockHttpServletRequest();, +		request.addHeader("X-Forwarded-Proto", "https");, +		request.addHeader("X-Forwarded-Host", "84.198.58.199");, +		request.addHeader("X-Forwarded-Port", 443);, +		request.setScheme("http");, +		request.setServerName("example.com");, +		request.setServerPort(80);, +		request.setRequestURI("/rest/mobile/users/1");, +, +		UriComponents result = UriComponentsBuilder.fromHttpRequest(new ServletServerHttpRequest(request)).build();, +		assertEquals("https", result.getScheme());, +		assertEquals("84.198.58.199", result.getHost());, +		assertEquals(-1, result.getPort());, +		assertEquals("/rest/mobile/users/1", result.getPath());, +	}, +, +++ b/spring-web/src/main/java/org/springframework/web/util/UriComponentsBuilder.java, +		builder.port(null);, +++ b/spring-web/src/test/java/org/springframework/web/util/UriComponentsBuilderTests.java, +	// SPR-12771, +, +	@Test, +	public void fromHttpRequestResetsPortBeforeSettingIt() throws Exception {, +		MockHttpServletRequest request = new MockHttpServletRequest();, +		request.addHeader("X-Forwarded-Proto", "https");, +		request.addHeader("X-Forwarded-Host", "84.198.58.199");, +		request.addHeader("X-Forwarded-Port", 443);, +		request.setScheme("http");, +		request.setServerName("example.com");, +		request.setServerPort(80);, +		request.setRequestURI("/rest/mobile/users/1");, +, +		UriComponents result = UriComponentsBuilder.fromHttpRequest(new ServletServerHttpRequest(request)).build();, +		assertEquals("https", result.getScheme());, +		assertEquals("84.198.58.199", result.getHost());, +		assertEquals(-1, result.getPort());, +		assertEquals("/rest/mobile/users/1", result.getPath());, +	}, +, +++ b/spring-webmvc/src/test/java/org/springframework/web/servlet/support/ServletUriComponentsBuilderTests.java, + * Copyright 2002-2015 the original author or authors., +, +		this.request.setRequestURI("/mvc-showcase");, +, +		assertEquals("http://localhost:8080/mvc-showcase", result);, +		assertEquals("https://localhost:9043/mvc-showcase", result);, +	// SPR-12771, +, +	@Test, +	public void fromRequestWithForwardedProtoAndDefaultPort() {, +		this.request.addHeader("X-Forwarded-Proto", "https");, +		this.request.addHeader("X-Forwarded-Host", "84.198.58.199");, +		this.request.addHeader("X-Forwarded-Port", "443");, +		this.request.setServerPort(80);, +		UriComponents result = ServletUriComponentsBuilder.fromRequest(this.request).build();, +, +		assertEquals("https://84.198.58.199/mvc-showcase", result.toString());, +	}, +]