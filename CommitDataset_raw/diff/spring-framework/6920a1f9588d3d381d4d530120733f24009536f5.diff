[+++ b/spring-web/src/main/java/org/springframework/web/filter/ForwardedHeaderFilter.java, + * Copyright 2002-2018 the original author or authors., +			String fragment = null;, +			int fragmentIndex = location.indexOf('#');, +			if (fragmentIndex != -1) {, +				if (location.length() > fragmentIndex) {, +					fragment = location.substring(fragmentIndex + 1);, +				}, +				location = location.substring(0, fragmentIndex);, +			}, +, +			String query = null;, +			int queryIndex = location.indexOf('?');, +			if (queryIndex != -1) {, +				if (location.length() > queryIndex) {, +					query = location.substring(queryIndex + 1);, +				}, +				location = location.substring(0, queryIndex);, +			}, +, +					.replaceQuery(query), +					.fragment(fragment), +++ b/spring-web/src/main/java/org/springframework/web/filter/ForwardedHeaderFilter.java, + * Copyright 2002-2018 the original author or authors., +			String fragment = null;, +			int fragmentIndex = location.indexOf('#');, +			if (fragmentIndex != -1) {, +				if (location.length() > fragmentIndex) {, +					fragment = location.substring(fragmentIndex + 1);, +				}, +				location = location.substring(0, fragmentIndex);, +			}, +, +			String query = null;, +			int queryIndex = location.indexOf('?');, +			if (queryIndex != -1) {, +				if (location.length() > queryIndex) {, +					query = location.substring(queryIndex + 1);, +				}, +				location = location.substring(0, queryIndex);, +			}, +, +					.replaceQuery(query), +					.fragment(fragment), +++ b/spring-web/src/test/java/org/springframework/web/filter/ForwardedHeaderFilterTests.java, + * Copyright 2002-2018 the original author or authors., +	@Test // SPR-16506, +	public void sendRedirectWithAbsolutePathQueryParamAndFragment() throws Exception {, +		this.request.addHeader(X_FORWARDED_PROTO, "https");, +		this.request.addHeader(X_FORWARDED_HOST, "example.com");, +		this.request.addHeader(X_FORWARDED_PORT, "443");, +		this.request.setQueryString("oldqp=1");, +, +		String redirectedUrl = sendRedirect("/foo/bar?newqp=2#fragment");, +		assertEquals("https://example.com/foo/bar?newqp=2#fragment", redirectedUrl);, +	}, +]