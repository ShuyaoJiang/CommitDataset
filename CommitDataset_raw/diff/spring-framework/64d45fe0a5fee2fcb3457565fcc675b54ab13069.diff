[+++ b/spring-websocket/src/main/java/org/springframework/web/socket/server/support/TomcatRequestUpgradeStrategy.java, +import java.util.Arrays;, +import java.util.Map;, +import javax.servlet.http.HttpServletResponse;, +import org.springframework.http.server.ServletServerHttpResponse;, +, +			String acceptedProtocol, Endpoint endpoint) throws HandshakeFailureException {, +		Assert.isTrue(response instanceof ServletServerHttpResponse);, +		HttpServletResponse servletResponse = ((ServletServerHttpResponse) response).getServletResponse();, +		String path = servletRequest.getRequestURI(); // shouldn't matter, +		Map<String, String> pathParams = Collections.<String, String> emptyMap();, +, +		ServerEndpointRegistration endpointConfig = new ServerEndpointRegistration(path, endpoint);, +		endpointConfig.setSubprotocols(Arrays.asList(acceptedProtocol));, +, +			getContainer(servletRequest).doUpgrade(servletRequest, servletResponse, endpointConfig, pathParams);, +	}, +	private WsServerContainer getContainer(HttpServletRequest servletRequest) {, +		return (WsServerContainer) servletContext.getAttribute(attribute);]