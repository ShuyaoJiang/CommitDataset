Refactor duplicated code

See gh-1445
