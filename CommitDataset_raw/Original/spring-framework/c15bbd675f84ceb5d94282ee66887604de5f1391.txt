Refactor duplicate code

See gh-1452
