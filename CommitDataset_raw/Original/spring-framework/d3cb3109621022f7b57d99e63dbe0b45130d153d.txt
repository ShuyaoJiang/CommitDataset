bunch of fixes for 3.0.4
