Merge pull request #2865 from square/jw/ws-improvements

Web socket API and implementation improvements.