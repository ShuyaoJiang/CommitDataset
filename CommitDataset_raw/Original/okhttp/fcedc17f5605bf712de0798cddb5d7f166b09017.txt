Fix some issues according to the comments in the previous pull request,
and add some tests
