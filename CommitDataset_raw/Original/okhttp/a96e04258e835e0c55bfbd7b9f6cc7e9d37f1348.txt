Merge pull request #4565 from square/jwilson.0117.duplex_tests

Add tests that exercise real duplex communication