avoid using invalid sessions (#3721)

* avoid using invalid sessions

* fix tests

* retain socket and check state

* fix tests for session validity check

* fix test

* simplify

* extract isValid method

* reformat
