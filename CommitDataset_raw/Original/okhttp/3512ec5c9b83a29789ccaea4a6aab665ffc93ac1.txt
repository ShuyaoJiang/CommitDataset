Add tests that exercise real duplex communication

We're currently broken because the Pipe doesn't flush. Will fix in Okio.
