Merge pull request #1218 from square/jwilson_1221_move_caching

Move cache writing out of the transport.