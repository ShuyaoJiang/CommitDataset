Do not rebuffer socket streams for web sockets, other fixes.

* Ensure onOpen is called before the reader thread starts.
* Allow close reason without code.
* Use ProtocolException for protocol errors to ensure a close response is written.
