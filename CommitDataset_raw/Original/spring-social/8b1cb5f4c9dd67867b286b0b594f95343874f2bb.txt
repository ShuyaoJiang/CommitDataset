broke out rank subquery into top-level query for mysql compatibility
