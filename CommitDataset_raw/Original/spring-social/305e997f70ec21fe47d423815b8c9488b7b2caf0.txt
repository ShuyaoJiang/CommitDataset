fix unit test and bugs
