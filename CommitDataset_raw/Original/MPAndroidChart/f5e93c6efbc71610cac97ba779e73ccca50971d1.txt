Fixed some issues concerning offset calculation.
