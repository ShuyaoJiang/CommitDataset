Legend code cleanup, fix issue #773
