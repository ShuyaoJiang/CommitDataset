Started working on legend. Did some refactoring.
