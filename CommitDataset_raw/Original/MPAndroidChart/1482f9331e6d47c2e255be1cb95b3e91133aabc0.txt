Major refactorings and implementation if line interface
