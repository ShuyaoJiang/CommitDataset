Refactor downsampler and transformation out of IR
