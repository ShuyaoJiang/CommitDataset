Adds tests for AllocateAction and its steps

Also tweaks some of the code in the steps of the allocate action
