More cleanup

Big change here is that we start to use ES's base test clases for
testing. This should give us access to randomized testing and makes
sure that the reproduction lines are correct.

Original commit: elastic/x-pack-elasticsearch@bcab64a02812251512c62e835a49f6abd24230ee
