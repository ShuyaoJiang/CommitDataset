Refactor TransportShardBulkAction.executeUpdateRequest and add tests

This splits `executeUpdateRequest` into separate parts and adds some unit tests
for the behavior in it. The actual behavior has not been changed.
