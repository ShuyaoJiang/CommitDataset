Followup for elastic/elasticsearch#25658 (elastic/x-pack-elasticsearch#1984)

This is the xpack side fo elastic/elasticsearch#25658 which is mainly refactorings
of a ctor and added tests.

Original commit: elastic/x-pack-elasticsearch@d8e2a2a0577c7eb7171a4fc1ba3eecc3a9a44f33
