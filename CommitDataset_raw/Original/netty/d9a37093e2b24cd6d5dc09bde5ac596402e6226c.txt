More test cases and trivial fixes
