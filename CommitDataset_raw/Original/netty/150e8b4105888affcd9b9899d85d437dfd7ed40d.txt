WebSocket enhancements

- Refactoring and adding suggestions from Norman and Vibul.
