Added ThreadLocalBoolean and replaced unnecessary anonymous classes
