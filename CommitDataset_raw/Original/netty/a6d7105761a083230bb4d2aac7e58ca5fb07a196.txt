fix #360, add check for empty buffer; also add unit test for this scenario
