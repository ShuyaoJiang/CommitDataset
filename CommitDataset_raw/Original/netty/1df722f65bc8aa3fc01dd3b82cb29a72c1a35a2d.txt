kqueue version of 7baef4fbe89559b10fbeed7e17b16f953ff3b7ab
