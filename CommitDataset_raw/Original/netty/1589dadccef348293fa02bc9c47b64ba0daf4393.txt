Better handling of canceling. See #210 and #209