Merge pull request #2806 from square/jakew/refactorings/2018-06-16

Move general checks out of HTTP-specific code