Merge pull request #511 from square/jw/fix-content-type-mess

More robust implementation of 'Content-Type' overriding.