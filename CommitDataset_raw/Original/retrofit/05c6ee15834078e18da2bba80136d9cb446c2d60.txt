Merge pull request #619 from square/jw/whiteboxish

Migrate most behavior tests to be whitebox(ish).