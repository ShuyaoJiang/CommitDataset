Merge pull request #942 from square/jw/non-timing-based-buffer-and-stream

Use non-timing based methods to detect buffer and stream.