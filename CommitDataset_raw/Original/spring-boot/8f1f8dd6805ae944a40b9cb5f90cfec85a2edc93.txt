Use entrySet() rather than using keySet() and then calling get(key)

Closes gh-4813
