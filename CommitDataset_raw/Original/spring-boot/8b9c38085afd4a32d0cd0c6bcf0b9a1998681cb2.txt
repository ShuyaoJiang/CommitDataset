Merge pull request #3117 from izeye/metrics

* metrics2:
  Remove duplicate code in new metrics code
