Use try-with-resources to close resources automatically

See gh-8045
