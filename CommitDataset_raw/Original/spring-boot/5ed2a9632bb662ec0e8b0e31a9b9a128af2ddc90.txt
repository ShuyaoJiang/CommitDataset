Make InMemoryTraceRepository thread-safe

Closes gh-3027
