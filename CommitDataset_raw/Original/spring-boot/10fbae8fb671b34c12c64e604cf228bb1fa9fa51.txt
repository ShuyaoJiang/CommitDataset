Avoid leaking application context shutdown hooks in the tests

Closes gh-4053
