2.x: add safeguards to generate() (#4932)

* 2.x: add safeguards to generate()

* Fix typo in the test name
