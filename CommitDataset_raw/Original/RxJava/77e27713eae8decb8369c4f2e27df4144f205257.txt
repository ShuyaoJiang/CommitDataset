Fix bugs in equals and hashCode
