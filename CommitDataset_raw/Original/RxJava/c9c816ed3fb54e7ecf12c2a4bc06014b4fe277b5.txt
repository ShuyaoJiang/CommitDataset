Refactor test to use CountDownLatch instead of Thread.sleep
