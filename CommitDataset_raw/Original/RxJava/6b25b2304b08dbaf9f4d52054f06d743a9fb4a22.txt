Fixed state capture bug.
Added some additional tests
