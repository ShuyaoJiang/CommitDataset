Pulled in changes from Samuel.
Fixed tests, all working without warnings
