2.x: coverage, fixes, cleanup 10/20-2 (#4738)

* 2.x: coverage, fixes, cleanup 10/20-2

* Fix Generate not saving the state
