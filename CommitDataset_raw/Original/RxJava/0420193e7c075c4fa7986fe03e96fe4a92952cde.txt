Merge fully rewritten and other related optimizations