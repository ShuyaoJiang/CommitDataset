2.x: Fix refCount() connect/subscribe/cancel deadlock (#5975)

* 2.x: Fix refCount() connect/subscribe/cancel deadlock

* Add more coverage.

* Improve logic and coverage.

* Factor out common cleanup code.

* Fix termination cleanup.
