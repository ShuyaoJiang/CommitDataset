Synchronised with changes on 1.0.x branch.