Moved code around and added some documentation.