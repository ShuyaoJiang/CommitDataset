Updated with changes from 1.0.x branch.
