Add some generics and clean up.