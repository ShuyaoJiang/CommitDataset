Fall back to gradient array length when p is missing

Fixes #309
