Reimplemented masks and mattes (#1135)

This should greatly improve the compatibility of multiple add and subtract masks and adds support for inverted masks and intersect masks.