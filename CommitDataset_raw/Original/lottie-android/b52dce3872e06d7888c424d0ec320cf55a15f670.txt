Properly limit LRU cache size and make it configurable (#1100)

I also added an API to set the max cache size and tests.
Fixes #1077