Replace all foreach loops with fori loops for performance

According to systrace, the iterators for the foreach loops added up
since they were getting called so frequently (setProgress for each layer
and observable updates for each layer)
