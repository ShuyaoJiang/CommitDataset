move anonymous class detection after cache check
