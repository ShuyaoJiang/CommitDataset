Merge pull request #194 from wuyongzheng/master

fixed a few bugs resulting program hang