core: fix switch in loop (fix #52)
