Add proper unit tests for double-dispatch pattern
