refactors code to allow better testing
