Several changes that were required after merging master into the ccr branch.
