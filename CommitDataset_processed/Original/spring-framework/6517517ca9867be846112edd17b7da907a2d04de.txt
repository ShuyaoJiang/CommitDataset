Refactor to lazy Environment creation where possible
