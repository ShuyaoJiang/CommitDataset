Split the compile and test-compile macros.  Added a pre-compile macro.
