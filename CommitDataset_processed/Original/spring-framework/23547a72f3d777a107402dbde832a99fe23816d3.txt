Clean up warnings and polish tests
