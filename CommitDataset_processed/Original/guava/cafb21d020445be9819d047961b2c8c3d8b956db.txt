Added TypeVisitor to make it easier to navigate type hierarchy, and used it to replace a few code duplications.
