Move general checks out of HTTP-specific code
