Refactoring, tests and fixes related to min and max calculation
