Extract 'WithUpstream' interfaces. (#4326)
