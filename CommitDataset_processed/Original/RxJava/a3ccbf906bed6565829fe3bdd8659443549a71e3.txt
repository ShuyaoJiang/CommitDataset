Improve compose() generics (#4972)
