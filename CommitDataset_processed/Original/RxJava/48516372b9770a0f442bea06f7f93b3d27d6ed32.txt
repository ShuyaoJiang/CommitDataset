2.x: add safeguards to generate() (#4932)
