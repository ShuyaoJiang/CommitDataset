Fixed UTF-8 detection, again, and added unit test
