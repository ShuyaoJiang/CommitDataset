Many changes to the C++ port.
