Port r1623 changes to C++
