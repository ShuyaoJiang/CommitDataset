Restructure the code to enforce separation of plugin logic and tasks
