Forward-port the pull request #172 to fix #164
