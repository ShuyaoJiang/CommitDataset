Overhaul pipeline implementation for clarity and memory efficiency
