Fix a race where 2 handlers in different threads access the same buffer
