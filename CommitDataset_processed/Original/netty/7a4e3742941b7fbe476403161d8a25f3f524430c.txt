Fix a bug where timeout handlers sometimes generate events too early
