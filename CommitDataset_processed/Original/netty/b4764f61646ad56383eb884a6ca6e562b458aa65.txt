Fix infinity loop and timing issues
