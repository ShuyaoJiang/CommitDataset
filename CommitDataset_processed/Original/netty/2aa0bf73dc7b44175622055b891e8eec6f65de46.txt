Add a unit test that reproduces the dead lock described in #1175
