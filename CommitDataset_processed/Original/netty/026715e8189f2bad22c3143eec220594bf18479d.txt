Refactor the pipeline API to support stacked codecs
