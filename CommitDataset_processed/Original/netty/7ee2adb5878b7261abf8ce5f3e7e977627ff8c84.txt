Move drain logic to OutputMessageBuf and optimize it as far as possible
