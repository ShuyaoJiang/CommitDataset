Start to refactor nio transport to share more code. See #186 